from header_common import *
from header_operations import *
from module_constants import *
from header_parties import *
from header_skills import *
from header_mission_templates import *
from header_items import *
from header_triggers import *
from header_terrain_types import *
from header_music import *
from ID_animations import *
from ID_meshes import *


scripts = [ 
    
    ###############
    ## Hardcoded ##
    ###############

    # script_game_start:
    # This script is called when a new game is started
    # INPUT: none
    ("game_start",
        [
            (set_player_troop, "trp_player"), # Must be set to allow the creation screen to pass
            (assign, "$g_player_troop", "trp_player"),
            (assign, "$g_player_party", "p_main_party"),
            (party_set_slot, "$g_player_party", slot_party_type, spt_war_party),
            (party_set_slot, "$g_player_party", slot_party_autosort_options, autosort_low_level_first|autosort_foreign_first),
            (troop_set_slot, "$g_player_troop", slot_troop_kingdom_occupation, tko_kingdom_hero),
            (troop_set_slot, "$g_player_troop", slot_troop_vassal_of, -1),
            (troop_set_slot, "$g_player_troop", slot_troop_renown, 0),

            (assign, "$g_cur_free_lord", lords_begin),

            (set_show_messages, 0),
            (call_script, "script_init_centers"),
            (call_script, "script_init_factions"),
            (call_script, "script_init_cultures"),
            (call_script, "script_init_bandits"),
            (call_script, "script_init_goods"),
            (call_script, "script_init_good_recipes"),
            
            ## Generate some bandits to begin with
            (try_for_range, ":cur_center", villages_begin, villages_end),
                (store_random_in_range, ":rand", 0, 10),
                (try_begin),
                    (eq, ":rand", 0),
                    (call_script, "script_party_spawn_bandits", ":cur_center"),
                (try_end),
            (try_end),
            
            (call_script, "script_init_building_slots"),
            (call_script, "script_init_siege_scene_slots"),
            
            (call_script, "script_init_troops_types"),
            (call_script, "script_init_troops_factions"),
            (call_script, "script_init_troops_archer_score"),
            (call_script, "script_init_troops_mercenary"),
            
            (call_script, "script_init_arms_colors"),
            
            # ToDo: temporary
            (try_for_range, ":faction", "fac_faction_1", kingdoms_end),
                (faction_set_slot, ":faction", slot_faction_era, 0),
            (try_end),
            
            (try_for_range, ":small_kingdom", kingdoms_begin, kingdoms_end),
                (faction_set_slot, ":small_kingdom", slot_faction_leader, -1),
                (faction_set_slot, ":small_kingdom", slot_faction_marshall, -1),
            (try_end),

            (try_for_range, ":party_no", centers_begin, centers_end),
                (call_script, "script_party_init_center", ":party_no"),
            (try_end),
            (call_script, "script_clean_budgets"),

            (try_for_range, ":lord_no", lords_begin, lords_end),
                (call_script, "script_init_lord", ":lord_no"),
            (try_end),

            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (call_script, "script_find_free_lord"),
                (assign, ":lord_no", reg0),
                (gt, ":lord_no", 0),
                
                (call_script, "script_ready_lord", ":lord_no", ":faction_no", 1),
                (call_script, "script_troop_get_rank", ":lord_no"),
                (assign, ":rank", reg0),
                (troop_set_slot, ":lord_no", slot_troop_rank, ":rank"),
                (call_script, "script_troop_change_level", ":lord_no", ":rank"),
            (try_end),

            (try_for_range, ":party_no", centers_begin, centers_end),
                (party_get_slot, ":party_type", ":party_no", slot_party_type),
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (try_for_range, ":unused", 0, 30),
                        (call_script, "script_party_add_reinforcements", ":party_no"),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (try_for_range, ":unused", 0, 20),
                        (call_script, "script_party_add_reinforcements", ":party_no"),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (call_script, "script_party_add_reinforcements", ":party_no"),
                    (call_script, "script_party_add_reinforcements", ":party_no"),
                (try_end),
            (try_end),

            (call_script, "script_init_quests"),

            (try_for_range, ":merchant", merchants_begin, merchants_end),
                (troop_set_slot, ":merchant", slot_troop_last_met, -24*7*5), # Around 5 weeks' worth of goods
            (try_end),
            
            (party_set_slot, "$g_player_party", slot_party_leader, "$g_player_troop"),
            (troop_add_gold, "$g_player_troop", 10000),
            
            (assign, "$g_global_haze_amount", 0),
            (assign, "$g_global_cloud_amount", 0),

            (assign, "$g_normalize_faction_color", 1),
            (assign, "$g_player_update_name", 1),

            (assign, "$g_player_last_proposed_vassalage", -10000),
            
            (set_show_messages, 1),
        ]),

    #script_game_quick_start
    # This script is called from the game engine for initializing the global variables for tutorial, multiplayer and custom battle modes.
    # INPUT:
    # none
    # OUTPUT:
    # none
    ("game_quick_start",
        [
        ]),

    #script_game_set_multiplayer_mission_end
    # This script is called from the game engine when a multiplayer map is ended in clients (not in server).
    # INPUT:
    # none
    # OUTPUT:
    # none
    ("game_set_multiplayer_mission_end",
        [
            (assign, "$g_multiplayer_mission_end_screen", 1),
        ]),
    
    #script_game_get_use_string
    # This script is called from the game engine for getting using information text
    # INPUT: used_scene_prop_id  
    # OUTPUT: s0
    ("game_get_use_string",
        [
        ]),
    
    #script_game_enable_cheat_menu
    # This script is called from the game engine when user enters "cheatmenu from command console (ctrl+~).
    # INPUT:
    # none
    # OUTPUT:
    # none
    ("game_enable_cheat_menu",
        [
            (try_begin),
                (lt, "$debug", debug_simple),
                (display_message, "@Activating debug mode"),
                (assign, "$debug", debug_simple),
            (else_try),
                (display_message, "@Deactivation debug mode"),
                (assign, "$debug", 0),
            (try_end),
        ]),
    
    # script_game_event_party_encounter:
    # This script is called from the game engine whenever player party encounters another party or a battle on the world map
    # INPUT:
    # param1: encountered_party
    # param2: second encountered_party (if this was a battle
    ("game_event_party_encounter",
        [
            (store_script_param_1, "$g_encountered_party"),
            (store_script_param_2, "$g_encountered_party_2"), # Negative if non-battle.
            
            (party_get_slot, ":party_type", "$g_encountered_party", slot_party_type),
            (try_begin),
                (lt, "$g_encountered_party_2", 0), # Non-battle.
                (try_begin),
                    (eq, "$g_encountered_party", "p_camp_bandits"), # Camp.
                    (jump_to_menu, "mnu_camp"),
                (else_try),
                    (this_or_next|eq, ":party_type", spt_town),
                    (this_or_next|eq, ":party_type", spt_village),
                    (eq, ":party_type", spt_castle),
                    (party_get_slot, ":besieger",  "$g_encountered_party", slot_party_besieged_by),
                    (try_begin),
                        (eq, ":besieger", "$g_player_party"),
                        (jump_to_menu, "mnu_town_siege"),
                    (else_try),
                        (jump_to_menu, "mnu_town"),
                    (try_end),
                # (else_try),
                    # (is_between, "$g_encountered_party", "p_places_stone_obelisk", "p_Bridge_1"),
                    # (jump_to_menu, "mnu_visit_place"),
                (else_try),
                    # Disallow speaking with certain lords/parties
                    (try_begin),
                        (party_get_slot, ":leader", "$g_encountered_party", slot_party_leader),
                        (gt, ":leader", 0),
                        (troop_get_slot, ":last_met", ":leader", slot_troop_last_met),
                        (is_between, ":last_met", 0, 3), 
                        # If we meet shortly after refusing speech then we do not wish to speak again
                    (else_try),
                        (party_set_slot, "$g_encountered_party", slot_party_speak_allowed, 1),
                    (try_end),
                    (jump_to_menu, "mnu_simple_encounter"),
                (try_end),
            (else_try),
                
                (this_or_next|eq, ":party_type", spt_town),
                (eq, ":party_type", spt_castle),
                (jump_to_menu, "mnu_siege_camp"),
            (else_try),
                # Battle between two parties
                (jump_to_menu, "mnu_double_encounter"),
            (try_end),
        ]),

    # script_game_event_simulate_battle:
    # This script is called whenever the game simulates the battle between two parties on the map.
    # INPUT:
    # param1: Defender Party
    # param2: Attacker Party
    ("game_event_simulate_battle",
        [
            (store_script_param, ":defender_party", 1),
            (store_script_param, ":attacker_party", 2),
            
            (assign, ":result", 0),
            
            (party_get_slot, ":party_type", ":defender_party", slot_party_type),
            
            (try_begin),
                (store_faction_of_party, ":defender_faction", ":defender_party"),
                (store_faction_of_party, ":attacker_faction", ":attacker_party"),
                
                (store_relation, ":relation", ":defender_faction", ":attacker_faction"),
                
                (this_or_next|eq, ":defender_faction", ":attacker_faction"),
                (ge, ":relation", 0),
                
                (assign, ":result", 1),
            (else_try),
                (party_collect_attachments_to_party, ":defender_party", "p_collective_defender"),
                (party_collect_attachments_to_party, ":attacker_party", "p_collective_attacker"),
                
                (call_script, "script_party_count_fit_for_battle", "p_collective_defender", 0),
                (assign, ":num_defenders", reg0),
                (call_script, "script_party_count_fit_for_battle", "p_collective_attacker", 0),
                (assign, ":num_attackers", reg0),
                (try_begin),
                    (eq, ":num_defenders", 0),
                    (assign, ":result", 1),
                    (try_begin),
                        (this_or_next|eq, ":party_type", spt_town),
                        (this_or_next|eq, ":party_type", spt_castle),
                        (eq, ":party_type", spt_village),
                        (call_script, "script_party_group_defeat_party_group", ":attacker_party", ":defender_party", -1),
                    (else_try),
                        (call_script, "script_party_group_defeat_party_group", ":attacker_party", ":defender_party", -1),
                    (try_end),
                (else_try),
                    (eq, ":num_attackers", 0),
                    (assign, ":result", 1),
                    (try_begin),
                        # We allow attacking lords to flee after the end of the fight
                        # (store_random_in_range, ":rand", 0, 3),
                        # (this_or_next|neg|is_between, ":party_type", spt_village, spt_fort + 1),
                        # (eq, ":rand", 0),
                        (call_script, "script_party_group_defeat_party_group", ":defender_party", ":attacker_party", -1),
                    # (else_try),
                        # Order lords to turn around ?
                        # Keep the siege a while longer and wait for reinforcements ?
                    (try_end),
                (else_try),
                    (call_script, "script_party_groups_simulate_battle", ":attacker_party", ":defender_party"),
                (try_end),
            (try_end),
            
            (set_trigger_result, ":result"),
        ]),

    # script_cf_debug
    # input:
    #   arg1: required_level
    # output: none
    ("cf_debug", 
        [
            (store_script_param, ":required_level", 1),

            (assign, ":continue", 0),
            (try_begin),
                (store_and, ":continue", ":required_level", "$debug"),
                (gt, ":continue", 0),
            (else_try),
                (gt, "$debug", 0),
                (store_and, ":continue", ":required_level", debug_current),
            (try_end),
            (gt, ":continue", 0),
        ]),
    
    # script_party_groups_simulate_battle
        # input:
        #   arg1: attacker
        #   arg2: defender
        # output: none
    ("party_groups_simulate_battle",
        [
            (store_script_param, ":attacker", 1),
            (store_script_param, ":defender", 2),
            
            # (party_get_slot, ":attacker_type", ":attacker", slot_party_type),
            (party_get_slot, ":defender_type", ":defender", slot_party_type),
            
            (party_get_slot, ":stage", ":attacker", slot_party_battle_stage),
            (try_begin),
                (is_between, ":stage", bs_approach, bs_charge),
                # Approach
                (call_script, "script_party_groups_simulate_battle_approach", ":attacker", ":defender"),
                (assign, ":attacker_strength", reg0),
                (assign, ":defender_strength", reg1),
                
                (val_add, ":stage", 1),
                (party_set_slot, ":attacker", slot_party_battle_stage, ":stage"),
            (else_try),
                (is_between, ":stage", bs_charge, bs_melee),
                # Charge
                (call_script, "script_party_groups_simulate_battle_charge", ":attacker", ":defender"),
                (assign, ":attacker_strength", reg0),
                (assign, ":defender_strength", reg1),
                
                (val_add, ":stage", 1),
                (party_set_slot, ":attacker", slot_party_battle_stage, ":stage"),
            (else_try),
                (eq, ":stage", bs_melee),
                # Melee
                (call_script, "script_party_groups_simulate_battle_melee", ":attacker", ":defender"),
                (assign, ":attacker_strength", reg0),
                (assign, ":defender_strength", reg1),
            (else_try),
                (party_set_slot, ":attacker", slot_party_battle_stage, bs_approach),
                (assign, ":attacker_strength", 0),
                (assign, ":defender_strength", 0),
            (try_end),

            (val_mul, ":attacker_strength", 2),
            (val_mul, ":defender_strength", 2),
            
            # (try_begin),
            #     (call_script, "script_cf_debug", debug_war),
            #     (assign, reg12, ":stage"),
            #     (str_store_party_name, s10, ":attacker"),
            #     (str_store_party_name, s11, ":defender"),
            #     (assign, reg10, ":attacker_strength"),
            #     (assign, reg11, ":defender_strength"),
            #     (display_message, "@Stage {reg12}^{s10}'s strength: {reg10} - {s11}'s strength: {reg11}."),
            # (try_end),
            # Conclusion
            (try_begin),
                (this_or_next|eq, ":defender_type", spt_castle),
                (eq, ":defender_type", spt_town),

                (val_div, ":attacker_strength", 2),

                (val_mul, ":defender_strength", 3),
                (val_div, ":defender_strength", 2),
            (else_try),
                (eq, ":defender_type", spt_village),
                (val_div, ":attacker_strength", 5),
                (val_mul, ":attacker_strength", 4),

                (val_mul, ":defender_strength", 3),
                (val_div, ":defender_strength", 2),
            (try_end),

            (try_begin),
                (is_currently_night),
                (val_div, ":attacker_strength", 2),
                (val_div, ":defender_strength", 2),
            (try_end),

            # (try_begin),
            #     (call_script, "script_cf_debug", debug_war),
            #     (assign, reg12, ":stage"),
            #     (str_store_party_name, s10, ":attacker"),
            #     (str_store_party_name, s11, ":defender"),
            #     (assign, reg10, ":attacker_strength"),
            #     (assign, reg11, ":defender_strength"),
            #     (display_message, "@Stage {reg12} normalized^{s10}'s strength: {reg10} - {s11}'s strength: {reg11}."),
            # (try_end),

            (store_faction_of_party, ":defender_faction", ":defender"),
            (store_faction_of_party, ":attacker_faction", ":attacker"),
            (try_begin),
                (gt, ":attacker_strength", 0),
                (party_clear, "p_temp_casualties"),
                (inflict_casualties_to_party_group, ":defender", ":attacker_strength", "p_temp_casualties"),

                (call_script, "script_party_group_get_looted_gold", "p_temp_casualties"),
                (assign, ":total_gold", reg0),
                (party_get_slot, ":current_casulaties_gold", ":defender", slot_party_recent_casualties_loot),
                (val_add, ":current_casulaties_gold", ":total_gold"),
                (party_set_slot, ":defender", slot_party_recent_casualties_loot, ":current_casulaties_gold"),

                (call_script, "script_party_generate_war_damage_from_casualties", "p_temp_casualties"),
                (assign, ":damage", reg0),
                (try_begin),
                    (gt, ":damage", 0),
                    (call_script, "script_party_group_spread_war_damage", ":defender", ":damage", ":attacker_faction"),
                    # (call_script, "script_faction_damage_faction", ":attacker_faction", ":defender_faction", ":damage", 1),
                (try_end),
            (try_end),

            (party_collect_attachments_to_party, ":defender", "p_collective_defender"),
            
            (call_script, "script_party_count_fit_for_battle", "p_collective_defender", 0),
            (assign, ":num_defenders", reg0),

            (try_begin),
                (gt, ":defender_strength", 0),
                (gt, ":num_defenders", 0),
                (party_clear, "p_temp_casualties"),
                (inflict_casualties_to_party_group, ":attacker", ":defender_strength", "p_temp_casualties"),

                (call_script, "script_party_group_get_looted_gold", "p_temp_casualties"),
                (assign, ":total_gold", reg0),
                (party_get_slot, ":current_casulaties_gold", ":attacker", slot_party_recent_casualties_loot),
                (val_add, ":current_casulaties_gold", ":total_gold"),
                (party_set_slot, ":attacker", slot_party_recent_casualties_loot, ":current_casulaties_gold"),

                (call_script, "script_party_generate_war_damage_from_casualties", "p_temp_casualties"),
                (assign, ":damage", reg0),
                (try_begin),
                    (gt, ":damage", 0),
                    (call_script, "script_party_group_spread_war_damage", ":attacker", ":damage", ":defender_faction"),
                    # (call_script, "script_faction_damage_faction", ":defender_faction", ":attacker_faction", ":damage", 1),
                (try_end),
            (try_end),
        ]),

    # script_party_group_spread_war_damage
        # input:
        #   arg1: party_group_no
        #   arg2: damage_amount
        #   arg3: damage_dealer_faction
        # output: none
    ("party_group_spread_war_damage",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":damage_amount", 2),
            (store_script_param, ":damage_dealer_faction", 3),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),
            (store_add, ":total_parties", ":num_attached_parties", 1),

            (store_div, ":divided_damage", ":damage_amount", ":total_parties"),
            (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                (call_script, "script_party_group_spread_war_damage", ":cur_party", ":divided_damage", ":damage_dealer_faction"),
            (try_end),

            (store_faction_of_party, ":party_faction", ":party_group_no"),

            # We have the main party take more damage to compensate for damage being lost with many attached parties
            (store_mod, ":mod", ":damage_amount", ":total_parties"),
            (val_add, ":divided_damage", ":mod"),

            (call_script, "script_faction_damage_faction", ":damage_dealer_faction", ":party_faction", ":divided_damage", 1),
        ]),

    # script_party_generate_war_damage_from_casualties
        # input:
        #   arg1: casualties_party
        # output:
        #   reg0: war_damage_amount
    ("party_generate_war_damage_from_casualties",
        [
            (store_script_param, ":casualties_party", 1),

            (party_get_num_companions, ":num_casualties", ":casualties_party"),
            (call_script, "script_generate_war_damage_from_casualties", ":num_casualties"),
        ]),

    # script_generate_war_damage_from_casualties
        # input:
        #   arg1: num_casualties
        # output:
        #   reg0: damage
    ("generate_war_damage_from_casualties",
        [
            (store_script_param, ":num_casualties", 1),

            (store_div, ":value", ":num_casualties", war_damage_casualties_divider),
            (store_mod, ":rest", ":num_casualties", war_damage_casualties_divider),
            (try_begin),
                (store_random_in_range, ":rand", 0, war_damage_casualties_divider),
                (gt, ":rest", ":rand"),
                (val_add, ":value", 1),
            (try_end),
            (assign, reg0, ":value"),
        ]),
    
    # script_party_groups_simulate_battle_approach
        # input:
        #   arg1: attacker
        #   arg2: defender
        # output:
        #   reg0: attacker_strength
        #   reg1: defender_strength
    ("party_groups_simulate_battle_approach",
        [
            (store_script_param, ":attacker", 1),
            (store_script_param, ":defender", 2),
            
            (call_script, "script_party_group_calculate_strength_approach", ":attacker"),
            (assign, ":attacker_strength", reg0),
            (assign, ":attacker_number", reg2),
            (call_script, "script_party_group_calculate_strength_approach", ":defender"),
            (assign, ":defender_strength", reg0),
            (assign, ":defender_number", reg2),

            (try_begin),
                (gt, ":attacker_number", 0),
                (val_div, ":attacker_strength", ":attacker_number"),
            (try_end),
            (try_begin),
                (gt, ":defender_number", 0),
                (val_div, ":defender_strength", ":defender_number"),
            (try_end),

            # Defenders have a small bonus during the approach phase
            (val_mul, ":defender_strength", 105),
            (val_div, ":defender_strength", 100),
            
            (assign, reg0, ":attacker_strength"),
            (assign, reg1, ":defender_strength"),
        ]),
    
    # script_party_groups_simulate_battle_charge
        # input:
        #   arg1: attacker
        #   arg2: defender
        # output:
        #   reg0: attacker_strength
        #   reg1: defender_strength
    ("party_groups_simulate_battle_charge",
        [
            (store_script_param, ":attacker", 1),
            (store_script_param, ":defender", 2),
            
            (call_script, "script_party_group_calculate_strength_charge", ":attacker"),
            (assign, ":attacker_strength", reg0),
            (assign, ":attacker_number", reg2),
            # Defender does not benefit from charge bonus
            (call_script, "script_party_group_calculate_strength", ":defender"),
            (assign, ":defender_strength", reg0),
            (assign, ":defender_number", reg2),

            # Attackers have a large bonus during the charge phase
            (val_mul, ":attacker_strength", 110),
            (val_div, ":attacker_strength", 100),

            (try_begin),
                (gt, ":attacker_number", 0),
                (val_div, ":attacker_strength", ":attacker_number"),
            (try_end),
            (try_begin),
                (gt, ":defender_number", 0),
                (val_div, ":defender_strength", ":defender_number"),
            (try_end),

            (assign, reg0, ":attacker_strength"),
            (assign, reg1, ":defender_strength"),
        ]),
    
    # script_party_groups_simulate_battle_melee
        # input:
        #   arg1: attacker
        #   arg2: defender
        # output:
        #   reg0: attacker_strength
        #   reg1: defender_strength
    ("party_groups_simulate_battle_melee",
        [
            (store_script_param, ":attacker", 1),
            (store_script_param, ":defender", 2),
            
            (call_script, "script_party_group_calculate_strength", ":attacker"),
            (assign, ":attacker_strength", reg0),
            (assign, ":attacker_number", reg2),
            (call_script, "script_party_group_calculate_strength", ":defender"),
            (assign, ":defender_strength", reg0),
            (assign, ":defender_number", reg2),

            (try_begin),
                (gt, ":attacker_number", 0),
                (val_div, ":attacker_strength", ":attacker_number"),
            (try_end),
            (try_begin),
                (gt, ":defender_number", 0),
                (val_div, ":defender_strength", ":defender_number"),
            (try_end),
            
            (assign, reg0, ":attacker_strength"),
            (assign, reg1, ":defender_strength"),
        ]),
    
    # script_party_group_calculate_strength
        # input:
        #   arg1: party_group
        # output:
        #   reg0: strength
        #   reg1: defense
    ("party_group_calculate_strength",
        [
            
            (store_script_param, ":party_no", 1),
            
            (assign, ":strength", 0),
            (assign, ":defense", 0),

            (assign, ":total_troops", 0),
            
            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":i_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_no", ":party_no", ":i_stack"),
                
                (party_stack_get_num_wounded, ":num_wounded", ":party_no", ":i_stack"),
                (party_stack_get_size, ":num_troops", ":party_no", ":i_stack"),
                (store_sub, ":num_ready", ":num_troops", ":num_wounded"),
                (gt, ":num_ready", 0),
                (store_random_in_range, ":rand", 0, 3),
                
                (call_script, "script_troop_calculate_strength", ":troop_no"),
                (assign, ":cur_strength", reg0),
                (assign, ":cur_defense", reg1),
                (assign, ":cur_ranged", reg2),
                (try_begin),
                    # We sometimes only use ranged damage for calculations
                    (eq, ":rand", 0),
                    (assign, ":cur_strength", ":cur_ranged"),
                (try_end),
                
                (val_mul, ":cur_strength", ":num_ready"),
                (val_mul, ":cur_defense", ":num_ready"),
                
                (val_add, ":strength", ":cur_strength"),
                (val_add, ":defense", ":cur_defense"),
                (val_add, ":total_troops", ":num_ready"),
            (try_end),
            
            (party_get_num_attached_parties, ":num_attached", ":party_no"),
            (try_for_range, ":i", 0, ":num_attached"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_no", ":i"),
                (call_script, "script_party_group_calculate_strength", ":cur_party"),
                (val_add, ":strength", reg0),
                (val_add, ":defense", reg1),
                (val_add, ":total_troops", reg2),
            (try_end),
            (assign, reg0, ":strength"),
            (assign, reg1, ":defense"),
            (assign, reg2, ":total_troops"),
        ]),
    
    # script_party_group_calculate_strength_approach
        # input:
        #   arg1: party_group
        # output:
        #   reg0: strength
        #   reg1: defense
    ("party_group_calculate_strength_approach",
        [
            (store_script_param, ":party_no", 1),
            
            (assign, ":strength", 0),
            (assign, ":defense", 0),

            (assign, ":total_troops", 0),
            
            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":i_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_no", ":party_no", ":i_stack"),
                
                (party_stack_get_num_wounded, ":num_wounded", ":party_no", ":i_stack"),
                (party_stack_get_size, ":num_troops", ":party_no", ":i_stack"),
                (store_sub, ":num_ready", ":num_troops", ":num_wounded"),
                (gt, ":num_ready", 0),
                
                (call_script, "script_troop_calculate_strength", ":troop_no"),
                (assign, ":cur_strength", reg2), # We add ranged strength
                (assign, ":cur_defense", reg1),
                
                (val_mul, ":cur_strength", ":num_ready"),
                (val_mul, ":cur_defense", ":num_ready"),
                
                (val_add, ":strength", ":cur_strength"),
                (val_add, ":defense", ":cur_defense"),
                (val_add, ":total_troops", ":num_ready"),
            (try_end),

            (call_script, "script_party_get_skill_level", ":party_no", skl_tactics),
            (store_mul, ":tactics_bonus", reg0, 3),
            (store_mul, ":strength_bonus", ":tactics_bonus", ":strength"),
            (val_div, ":strength_bonus", 100),
            (val_add, ":strength", ":strength_bonus"),
            
            (party_get_num_attached_parties, ":num_attached", ":party_no"),
            (try_for_range, ":i", 0, ":num_attached"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_no", ":i"),
                (call_script, "script_party_group_calculate_strength_approach", ":cur_party"),
                (val_add, ":strength", reg0),
                (val_add, ":defense", reg1),
                (val_add, ":total_troops", reg2),
            (try_end),
            (assign, reg0, ":strength"),
            (assign, reg1, ":defense"),
            (assign, reg2, ":total_troops"),
        ]),
    
    # script_party_group_calculate_strength_charge
        # input:
        #   arg1: party_group
        # output:
        #   reg0: strength
        #   reg1: defense
    ("party_group_calculate_strength_charge",
        [
            
            (store_script_param, ":party_no", 1),
            
            (assign, ":strength", 0),
            (assign, ":defense", 0),

            (assign, ":total_troops", 0),
            
            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":i_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_no", ":party_no", ":i_stack"),
                (party_stack_get_num_wounded, ":num_wounded", ":party_no", ":i_stack"),
                (party_stack_get_size, ":num_troops", ":party_no", ":i_stack"),
                (store_sub, ":num_ready", ":num_troops", ":num_wounded"),
                (gt, ":num_ready", 0),
                
                (troop_get_slot, ":type", ":troop_no", slot_troop_type),
                (call_script, "script_troop_calculate_strength", ":troop_no"),
                (assign, ":cur_strength", reg0),
                (assign, ":cur_defense", reg1),
                (assign, ":cur_ranged", reg2),
                
                (val_mul, ":cur_strength", ":num_ready"),
                (val_mul, ":cur_defense", ":num_ready"),
                (val_mul, ":cur_ranged", ":num_ready"),

                (val_add, ":total_troops", ":num_ready"),

                (try_begin),
                    (this_or_next|eq, ":type", tt_shock_infantry),
                    (eq, ":type", tt_spearman),
                    (eq, ":type", tt_pikeman),
                    (val_mul, ":cur_strength", 3),
                    (val_div, ":cur_strength", 2),
                    
                    (val_add, ":strength", ":cur_strength"),
                    (val_add, ":defense", ":cur_defense"),
                (else_try),
                    (this_or_next|eq, ":type", tt_archer),
                    (this_or_next|eq, ":type", tt_crossbow),
                    (this_or_next|eq, ":type", tt_horse_archer),
                    (val_add, ":strength", ":cur_ranged"),
                    (val_add, ":defense", ":cur_defense"),
                (else_try),
                    (eq, ":type", tt_lancer),
                    (val_mul, ":cur_strength", 6),
                    
                    (val_add, ":strength", ":cur_strength"),
                    (val_add, ":defense", ":cur_defense"),
                (else_try),
                    (this_or_next|eq, ":type", tt_cavalry),
                    (eq, ":type", tt_mounted_skirmisher),
                    (val_mul, ":cur_strength", 2),
                    
                    (val_add, ":strength", ":cur_strength"),
                    (val_add, ":defense", ":cur_defense"),
                (else_try),
                    (val_add, ":strength", ":cur_strength"),
                    (val_add, ":defense", ":cur_defense"),
                (try_end),
            (try_end),
            
            (party_get_num_attached_parties, ":num_attached", ":party_no"),
            (try_for_range, ":i", 0, ":num_attached"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_no", ":i"),
                (call_script, "script_party_group_calculate_strength_charge", ":cur_party"),
                (val_add, ":strength", reg0),
                (val_add, ":defense", reg1),
                (val_add, ":total_troops", reg2),
            (try_end),
            (assign, reg0, ":strength"),
            (assign, reg1, ":defense"),
            (assign, reg2, ":total_troops"),
        ]),
    
    # script_troop_calculate_strength
        # input:
        #   arg1: troop
        # output:
        #   reg0: strength
        #   reg1: defense
        #   reg2: ranged_strength
    ("troop_calculate_strength",
        [
            (store_script_param, ":troop_no", 1),
            
            (troop_get_slot, ":type", ":troop_no", slot_troop_type),

            (call_script, "script_troop_get_wages", ":troop_no"),
            (assign, ":score", reg0),

            (val_div, ":score", 2),
            (val_add, ":score", 10),
            
            (troop_get_slot, ":weapon_weight", ":troop_no", slot_troop_ranged_weapon_weight),
            
            (assign, ":defense", ":score"),
            (assign, ":strength", ":score"),
            (assign, ":ranged_strength", 0),

            (try_begin),
                (ge, ":weapon_weight", weight_very_light),
                (try_begin),
                    (this_or_next|eq, ":type", tt_archer),
                    (this_or_next|eq, ":type", tt_crossbow),
                    (eq, ":type", tt_horse_archer),
                    (assign, ":ranged_strength", ":score"),
                    (store_div, ":strength", ":score", 2),
                (else_try),
                    (this_or_next|eq, ":type", tt_mounted_skirmisher),
                    (eq, ":type", tt_skirmisher),
                    (store_mul, ":ranged_strength", ":score", 2),
                    (val_div, ":ranged_strength", 3),
                    (store_mul, ":strength", ":score", 2),
                    (val_div, ":strength", 3),
                (try_end),
            (try_end),
            
            (assign, reg0, ":strength"),
            (assign, reg1, ":defense"),
            (assign, reg2, ":ranged_strength"),
        ]),
    
    
    # script_party_group_defeat_party_group
        # input:
        #   arg1: winner_party
        #   arg2: defeated_party
        #   arg3: allied_party
        # output: none
    ("party_group_defeat_party_group",
        [
            (store_script_param, ":winner_party", 1),
            (store_script_param, ":defeated_party", 2),
            (store_script_param, ":allied_party", 3),
            
            (party_get_slot, ":party_type", ":defeated_party", slot_party_type),
            
            (try_begin),
                (neq, ":allied_party", -1),
                # If we have an allied party it means the player helped another party on the map
                (call_script, "script_party_group_defeated", ":defeated_party", ":allied_party"),
            (else_try),
                (call_script, "script_party_group_defeated", ":defeated_party", ":winner_party"),
            (try_end),
            (call_script, "script_party_group_process_renown", ":winner_party", ":defeated_party", ":allied_party"),
            (call_script, "script_party_group_loot_party_group", ":winner_party", ":defeated_party", ":allied_party"),
            (call_script, "script_party_group_take_party_group_prisoner", ":winner_party", ":defeated_party", ":allied_party"),

            # (try_begin),
            #     # (neq, ":defeated_party", "$g_player_party"),
            #     (call_script, "script_clear_party_group", ":defeated_party"),
            # (try_end),
            # /!\ Defeated_party should be considered no longer referenced! (unless it is a center) /!\
            
            (party_set_slot, ":winner_party", slot_party_battle_stage, bs_approach),
            (try_begin),
                (ge, ":allied_party", 0),
                (party_set_slot, ":allied_party", slot_party_battle_stage, bs_approach),
            (try_end),
            
            (try_begin),
                (is_between, ":party_type", spt_village, spt_fort + 1),
                
                # (party_get_slot, ":leader", ":winner_party", slot_party_leader),
                # (troop_set_slot, ":leader", slot_troop_mission, -1),
                (try_begin),
                    (neq, ":winner_party", "$g_player_party"),
                    (call_script, "script_party_process_mission", ":winner_party", 1),
                    (call_script, "script_party_process_ai", ":winner_party"),
                (try_end),
                
                (party_get_num_attached_parties, ":num_attached_parties", ":winner_party"),
                (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":attached_party", ":winner_party", ":attached_party_rank"),
                    (gt, ":attached_party", 0),
                    (neq, ":attached_party", "$g_player_party"),
                    (call_script, "script_party_process_mission", ":attached_party", 1),
                    (call_script, "script_party_process_ai", ":attached_party"),
                (try_end),
            (try_end),
        ]),

    # script_party_group_loot_party_group
        # input:
        #   arg1: party_group_looting
        #   arg2: party_group_looted
        #   arg3: allied_party
        # output: none
    ("party_group_loot_party_group",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":looted_party_group", 2),
            (store_script_param, ":allied_party", 3),

            (call_script, "script_party_group_get_looted_gold", ":looted_party_group"),
            (assign, ":total_gold", reg0),

            (try_begin),
                (neq, ":allied_party", -1),
                (val_div, ":total_gold", 2),
                (call_script, "script_party_group_share_gold", ":allied_party", ":total_gold"),
            (try_end),
            (call_script, "script_party_group_share_gold", ":party_group_no", ":total_gold"),
        ]),

    # script_party_group_get_looted_gold
        # input:
        #   arg1: party_group_no
        # output:
        #   reg0: total_looted_gold
    ("party_group_get_looted_gold",
        [
            (store_script_param, ":party_group_no", 1),

            (call_script, "script_party_get_looted_gold", ":party_group_no"),
            (assign, ":total_gold", reg0),

            (party_get_slot, ":party_wealth", ":party_group_no", slot_party_wealth),
            (try_begin),
                (gt, ":party_wealth", 0),
                (val_add, ":total_gold", ":party_wealth"),
            (try_end),
            (party_set_slot, ":party_group_no", slot_party_wealth, 0),

            (party_get_slot, ":casualties_gold", ":party_group_no", slot_party_recent_casualties_loot),
            (try_begin),
                (gt, ":casualties_gold", 0),
                (val_add, ":total_gold", ":casualties_gold"),
            (try_end),
            (party_set_slot, ":party_group_no", slot_party_recent_casualties_loot, 0),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),
            (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                (call_script, "script_party_group_get_looted_gold", ":cur_party"),
                (val_add, ":total_gold", reg0),
            (try_end),

            (assign, reg0, ":total_gold"),
        ]),
    
    # script_party_group_defeated
        # input:
        #   arg1: defeated_party
        #   arg2: winner_party
        # output: none
    ("party_group_defeated",
        [
            (store_script_param, ":defeated_party", 1),
            (store_script_param, ":winner_party", 2),

            (store_faction_of_party, ":party_faction", ":winner_party"),
                        
            (party_get_num_attached_parties, ":num_attached_parties", ":defeated_party"),
            (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":defeated_party", ":attached_party_rank"),
                (call_script, "script_party_group_defeated", ":attached_party", ":winner_party"),
            (try_end),

            (party_get_slot, ":party_type", ":defeated_party", slot_party_type),
            (try_begin),
                (eq, ":party_type", spt_war_party),

                (call_script, "script_faction_political_event", ":party_faction", political_event_war_party_defeated, ":defeated_party", ":winner_party", -1),

                (party_get_slot, ":leader", ":defeated_party", slot_party_leader),
                (troop_set_slot, ":leader", slot_troop_leaded_party, -1),
            (else_try),
                (is_between, ":party_type", spt_village, spt_fort + 1),

                (store_faction_of_party, ":old_center_faction", ":defeated_party"),
                (party_get_slot, ":center_faction", ":defeated_party", slot_party_faction),

                (try_begin),
                    (store_relation, ":relation", ":party_faction", ":center_faction"),
                    (ge, ":relation", 0),
                    (call_script, "script_faction_political_event_center_freed", ":party_faction", ":defeated_party", ":winner_party", ":old_center_faction"),
                (else_try),
                    (call_script, "script_faction_political_event_center_captured", ":party_faction", ":defeated_party", ":winner_party"),
                (try_end),

                (call_script, "script_party_defeat_center", ":winner_party", ":defeated_party"),
            (else_try),
                (eq, ":party_type", spt_caravan),
                (call_script, "script_faction_political_event", ":party_faction", political_event_caravan_defeated, ":defeated_party", ":winner_party", -1),
            (try_end),
        ]),
    
    # script_party_group_take_party_group_prisoner
        # input:
        #   arg1: party_group_no
        #   arg2: prisoner_party
        #   arg3: allied_party
        # output: none
    ("party_group_take_party_group_prisoner",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":prisoner_party", 2),
            (store_script_param, ":allied_party", 3),

            (party_clear, "p_prisoners_party"),
            (party_clear, "p_temp_party"),

            (try_begin),
                (eq, ":party_group_no", "$g_player_party"),
                (neq, ":allied_party", -1),
                (assign, ":party_group_no", ":allied_party"),
            (try_end),

            (party_get_num_attached_parties, ":num_attached_prisoner_parties", ":prisoner_party"),
            (try_for_range, ":attached", 0, ":num_attached_prisoner_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":prisoner_party", ":attached"),
                (party_get_num_prisoner_stacks, ":num_stacks", ":attached_party"),
                (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                    (party_prisoner_stack_get_troop_id, ":troop_id", ":attached_party", ":cur_stack"),
                    # We do not care if its a hero or not, it will be processed elsewhere
                    (party_prisoner_stack_get_size, ":stack_size", ":attached_party", ":cur_stack"),
                    (party_add_members, "p_temp_party", ":troop_id", ":stack_size"),
                    (party_remove_prisoners, ":attached_party", ":troop_id", ":stack_size"),
                (try_end),
                (party_get_num_companion_stacks, ":num_stacks", ":attached_party"),
                (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", ":attached_party", ":cur_stack"),
                    (party_stack_get_size, ":stack_size", ":attached_party", ":cur_stack"),
                    (party_force_add_members, "p_prisoners_party", ":troop_id", ":stack_size"),
                    (party_remove_members, ":attached_party", ":troop_id", ":stack_size"),
                (try_end),
            (try_end),
            
            (party_get_num_prisoner_stacks, ":num_stacks", ":prisoner_party"),
            (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                (party_prisoner_stack_get_troop_id, ":troop_id", ":prisoner_party", ":cur_stack"),
                # We do not care if its a hero or not, it will be processed elsewhere
                (party_prisoner_stack_get_size, ":stack_size", ":prisoner_party", ":cur_stack"),
                (party_add_members, "p_temp_party", ":troop_id", ":stack_size"),
                (party_remove_prisoners, ":prisoner_party", ":troop_id", ":stack_size"),
            (try_end),

            (party_get_num_companion_stacks, ":num_stacks", ":prisoner_party"),
            (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_id", ":prisoner_party", ":cur_stack"),
                (party_stack_get_size, ":stack_size", ":prisoner_party", ":cur_stack"),

                (neq, ":troop_id", "$g_player_troop"),

                (party_force_add_members, "p_prisoners_party", ":troop_id", ":stack_size"),
                (party_remove_members, ":prisoner_party", ":troop_id", ":stack_size"),
            (try_end),

            (call_script, "script_party_group_take_party_prisoner", ":party_group_no", "p_prisoners_party"),
            
            (call_script, "script_party_group_free_party", ":party_group_no", "p_temp_party"),
        ]),

    # script_party_group_take_party_prisoner
        # input:
        #   arg1: party_group_no
        #   arg2: party_to_take_prisoner
        # output: none
    ("party_group_take_party_prisoner",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":prisoner_party", 2),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),

            (store_add, ":total_num_parties", ":num_attached_parties", 1),
            (try_begin),
                (eq, ":party_group_no", "$g_player_party"),
                (assign, ":total_num_parties", ":num_attached_parties"),
            (try_end),
            (party_get_num_companions, ":num_prisoners", ":prisoner_party"),
            (assign, ":num_per_party", 0),
            (try_begin),
                (gt, ":total_num_parties", 0),
                (store_div, ":num_per_party", ":num_prisoners", ":total_num_parties"),
                (val_mod, ":num_prisoners", ":total_num_parties"),
            (try_end),

            (try_begin),
                (gt, ":num_per_party", 0),
                # First party gets priority on troops
                (try_begin),
                    (neq, ":party_group_no", "$g_player_party"),
                    (try_for_range, ":unused", 0, ":num_per_party"),
                        (party_get_num_companion_stacks, ":num_stacks", ":prisoner_party"),
                        (store_random_in_range, ":rand", 0, ":num_stacks"),
                        (party_stack_get_troop_id, ":troop_id", ":prisoner_party", ":rand"),

                        (call_script, "script_party_take_troop_prisoner", ":party_group_no", ":troop_id", ":prisoner_party", 1),
                    (try_end),
                (try_end),
                # Then we iterate over attached parties
                (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":attached_party", ":party_group_no", ":attached_party_rank"),
                    (try_for_range, ":unused", 0, ":num_per_party"),

                        (party_get_num_companion_stacks, ":num_stacks", ":prisoner_party"),
                        (store_random_in_range, ":rand", 0, ":num_stacks"),
                        (party_stack_get_troop_id, ":troop_id", ":prisoner_party", ":rand"),

                        (call_script, "script_party_take_troop_prisoner", ":attached_party", ":troop_id", ":prisoner_party", 1),
                    (try_end),
                (try_end),
            (try_end),
            (try_begin),
                (gt, ":num_prisoners", 0),
                (neq, ":party_group_no", "$g_player_party"),
                (party_get_num_companion_stacks, ":num_stacks", ":prisoner_party"),
                (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_size, ":stack_size", ":prisoner_party", ":cur_stack"),
                    (party_stack_get_troop_id, ":troop_id", ":prisoner_party", ":cur_stack"),
                    (call_script, "script_party_take_troop_prisoner", ":party_group_no", ":troop_id", ":prisoner_party", ":stack_size"),
                (try_end),
            (else_try),
                (gt, ":num_prisoners", 0),
                (gt, ":num_attached_parties", 0),
                (party_get_attached_party_with_rank, ":attached_party", ":party_group_no", 0),
                (party_get_num_companion_stacks, ":num_stacks", ":prisoner_party"),
                (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_size, ":stack_size", ":prisoner_party", ":cur_stack"),
                    (party_stack_get_troop_id, ":troop_id", ":prisoner_party", ":cur_stack"),
                    (call_script, "script_party_take_troop_prisoner", ":attached_party", ":troop_id", ":prisoner_party", ":stack_size"),
                (try_end),
            (try_end),
        ]),

    # script_party_group_share_gold
        # input:
        #   arg1: party_group_no
        #   arg2: total_gold
        # output: none
    ("party_group_share_gold",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":total_gold", 2),

            (assign, ":total_gold_shared", 0),

            (party_get_num_companions, ":main_party_num_companions", ":party_group_no"),
            # We also add a flat value to make sure small parties get a little gold
            (val_add, ":main_party_num_companions", 10),
            (assign, ":total_army_size", ":main_party_num_companions"),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),
            (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                (party_get_num_companions, ":num_companions", ":cur_party"),
                (val_add, ":total_army_size", ":num_companions"),
                # We also add a flat value to make sure small parties get a little gold
                (val_add, ":total_army_size", 10),
            (try_end),

            # MAIN PARTY
            (store_mul, ":share", ":main_party_num_companions", 100),
            (val_div, ":share", ":total_army_size"),
            (val_max, ":share", 1),

            (store_mul, ":gold_share", ":share", ":total_gold"),
            (val_div, ":gold_share", 100),

            (val_add, ":total_gold_shared", ":gold_share"),
            (call_script, "script_party_loot_gold", ":party_group_no", ":gold_share"),
            # /MAIN PARTY

            (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                (party_get_num_companions, ":num_companions", ":cur_party"),
                (val_add, ":num_companions", 10),

                (store_mul, ":share", ":num_companions", 100),
                (val_div, ":share", ":total_army_size"),
                (val_max, ":share", 1),

                (store_mul, ":gold_share", ":share", ":total_gold"),
                (val_div, ":gold_share", 100),
                (val_add, ":total_gold_shared", ":gold_share"),
                (call_script, "script_party_loot_gold", ":cur_party", ":gold_share"),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (store_sub, ":surplus", ":total_gold", ":total_gold_shared"),
                (neq, ":surplus", 0),
                (assign, reg10, ":surplus"),
                (display_message, "@Fight generated {reg10} unclaimed surplus gold"),
            (try_end),
        ]),

    # script_party_loot_gold
        # input:
        #   arg1: party_no
        #   arg2: gold_amount
        # output: none
    ("party_loot_gold",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":gold_amount", 2),
            
            (call_script, "script_party_get_skill_level", ":party_no", skl_looting),
            (assign, ":looting_skill", reg0),

            (store_mul, ":looting_mult", ":looting_skill", 10),
            (val_add, ":looting_mult", 100),
            (val_mul, ":gold_amount", ":looting_mult"),
            (val_div, ":gold_amount", 100),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":gold_amount"),
                (assign, reg11, ":looting_mult"),
                (display_message, "@{s10} receives {reg10} denars (looting, {reg11}%)"),
            (try_end),

            (call_script, "script_party_receive_gold", ":party_no", ":gold_amount"),
        ]),

    # script_party_receive_gold
        # input:
        #   arg1: party_no
        #   arg2: gold_amount
        # output: none
    ("party_receive_gold",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":gold_amount", 2),

            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (try_begin),
                (ge, ":leader", 0),
                (troop_is_hero, ":leader"),
                (troop_add_gold, ":leader", ":gold_amount"),
            (else_try),
                (party_get_slot, ":party_wealth", ":party_no", slot_party_wealth),
                (val_add, ":party_wealth", ":gold_amount"),
                (party_set_slot, ":party_no", slot_party_wealth, ":party_wealth"),
            (try_end),
        ]),

    # script_party_group_free_party
        # input:
        #   arg1: party_group_no
        #   arg2: freed_party
        # output: none
    ("party_group_free_party",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":freed_party", 2),

            (party_get_num_companion_stacks, ":num_stacks", ":freed_party"),
            (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_id", ":freed_party", ":cur_stack"),
                (troop_is_hero, ":troop_id"),
                (call_script, "script_party_get_attitude_with_troop", ":party_group_no", ":troop_id"),
                (assign, ":attitude", reg0),
                (try_begin),
                    (this_or_next|eq, ":attitude", attitude_positive),
                    (this_or_next|eq, ":attitude", attitude_neutral),
                    (eq, ":party_group_no", "$g_player_party"),
                    (call_script, "script_troop_freed", ":troop_id", ":party_group_no"),
                (else_try),
                    # Take the troop prisoner
                    (call_script, "script_party_take_troop_prisoner", ":party_group_no", ":troop_id", -1, 1),
                (try_end),
                (party_remove_members, ":freed_party", ":troop_id", 1),
            (try_end),

            (try_begin),
                (neq, ":party_group_no", "$g_player_party"),
                (distribute_party_among_party_group, ":freed_party", ":party_group_no"),
            (try_end),
        ]),

    # script_party_get_attitude_with_party
        # input:
        #   arg1: party_no
        #   arg2: other_party_no
        # output:
        #   reg0: attitude_*
    ("party_get_attitude_with_party",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":other_party", 2),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (store_faction_of_party, ":other_party_faction", ":other_party"),
            (store_relation, ":relation", ":party_faction", ":other_party_faction"),

            (try_begin),
                (gt, ":relation", 0),
                (assign, reg0, attitude_positive),
            (else_try),
                (lt, ":relation", 0),
                (assign, reg0, attitude_negative),
            (else_try),
                (assign, reg0, attitude_neutral),
            (try_end),
        ]),

    # script_party_get_attitude_with_troop
        # input:
        #   arg1: party_no
        #   arg2: other_party_no
        # output:
        #   reg0: attitude
    ("party_get_attitude_with_troop",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":troop_no", 2),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (store_troop_faction, ":troop_faction", ":troop_no"),
            (store_relation, ":relation", ":party_faction", ":troop_faction"),

            (try_begin),
                (gt, ":relation", 0),
                (assign, reg0, attitude_positive),
            (else_try),
                (lt, ":relation", 0),
                (assign, reg0, attitude_negative),
            (else_try),
                (assign, reg0, attitude_neutral),
            (try_end),
        ]),

    # script_clear_faction_casualties
        # input: none
        # output: none
    ("clear_faction_casualties",
        [
            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (faction_set_slot, ":faction_no", slot_faction_battle_casualties, 0),
            (try_end),
        ]),

    # script_apply_faction_casualties
        # input: none
        # output: none
    ("apply_faction_casualties",
        [
            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (faction_get_slot, ":casualties", ":faction_no", slot_faction_battle_casualties),
                (gt, ":casualties", 0),
                (call_script, "script_generate_war_damage_from_casualties", ":casualties"),
                (assign, ":damage", reg0),
                (gt, ":damage", 0),
                (call_script, "script_faction_damage_faction", -1, ":faction_no", ":damage", 1),
            (try_end),
        ]),

    # script_game_event_battle_end:
        # This script is called whenever the game ends the battle between two parties on the map.
        # INPUT:
        # param1: Defender Party
        # param2: Attacker Party
    ("game_event_battle_end",
        [
        ]), 

    #script_game_get_item_buy_price_factor:
        # This script is called from the game engine for calculating the buying price of any item.
        # INPUT:
        # param1: item_kind_id
        # OUTPUT:
        # trigger_result and reg0 = price_factor
    ("game_get_item_buy_price_factor",
        [
            (store_script_param, ":item", 1),
            
            (call_script, "script_item_get_buy_price_factor_from_party", ":item", "$g_player_party", "$g_encountered_party"),
            
            (assign, ":price", reg0),
            (set_trigger_result, ":price"),
        ]),
  
    #script_game_get_item_sell_price_factor:
        # This script is called from the game engine for calculating the selling price of any item.
        # INPUT:
        # param1: item_kind_id
        # OUTPUT:
        # trigger_result and reg0 = price_factor
    ("game_get_item_sell_price_factor",
        [
            (store_script_param, ":item", 1),

            (call_script, "script_item_get_sell_price_factor_from_party", ":item", "$g_player_party", "$g_encountered_party"),
            
            (assign, ":price", reg0),
            (set_trigger_result, ":price"),
        ]),
  
    #script_game_event_buy_item:
        # This script is called from the game engine when player buys an item.
        # INPUT:
        # param1: item_kind_id
    ("game_event_buy_item",
        [
            # This event is called not on the final purchase of an item but when moving the item from one inventory to the other
            # This means that the transaction is not finalized yet !
            # For now player taxes are not taken into account for center prosperity (could be abused anyways)

            # (try_begin),
            #     # Should be set before every call to trade with an npc
            #     # And unset after (unless the trader is not taxed)
            #     (ge, "$g_trading", 1),
            #     (is_between, "$g_encountered_party", centers_begin, centers_end),
            #     (store_script_param, ":item_no", 1),

            #     (store_item_value, ":value", ":item_no"),

            #     (party_get_slot, ":tax_rate", "$g_encountered_party", slot_party_taxes_buy),
            #     (gt, ":tax_rate", 0),
            #     (val_mul, ":value", ":tax_rate"),
            #     (val_div, ":value", 100),

            #     (call_script, "script_party_add_accumulated_taxes", "$g_encountered_party", ":value", tax_type_trade),
            # (try_end),
        ]),
  
    #script_game_event_sell_item:
        # This script is called from the game engine when player sells an item.
        # INPUT:
        # param1: item_kind_id
    ("game_event_sell_item",
        [
            # This event is called not on the final purchase of an item but when moving the item from one inventory to the other
            # This means that the transaction is not finalized yet !
            # For now player taxes are not taken into account for center prosperity (could be abused anyways)

            # (try_begin),
            #     # Should be set before every call to trade with an npc
            #     # And unset after (unless the trader is not taxed)
            #     (ge, "$g_trading", 1),
            #     (is_between, "$g_encountered_party", centers_begin, centers_end),
            #     (store_script_param, ":item_no", 1),

            #     (store_item_value, ":value", ":item_no"),

            #     (party_get_slot, ":tax_rate", "$g_encountered_party", slot_party_taxes_sell),
            #     (gt, ":tax_rate", 0),
            #     (val_mul, ":value", ":tax_rate"),
            #     (val_div, ":value", 100),

            #     (call_script, "script_party_add_accumulated_taxes", "$g_encountered_party", ":value", tax_type_trade),
            # (try_end),
        ]), 
  
    # script_game_get_troop_wage
        # This script is called from the game engine for calculating troop wages.
        # Input:
        # param1: troop_id, param2: party-id
        # Output: reg0: weekly wage
    ("game_get_troop_wage",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":party_no", 2),

            (call_script, "script_troop_get_wages_for_party", ":troop_no", ":party_no"),
            (set_trigger_result, reg0),
        ]),

    # script_game_get_total_wage
        # This script is called from the game engine for calculating total wage of the player party which is shown at the party window.
        # Input: none
        # Output: 
        #   reg0: weekly wage
    ("game_get_total_wage",
        [
            (call_script, "script_party_get_wages", "$g_player_party"),
            (set_trigger_result, reg0),
        ]),
  
    # script_game_get_join_cost
        # This script is called from the game engine for calculating troop join cost.
        # Input:
        # param1: troop_id,
        # Output: reg0: join cost
    ("game_get_join_cost",
        [
            (store_script_param, ":troop_no", 1),
            
            (call_script, "script_troop_get_cost", ":troop_no"),
            (assign, ":join_cost", reg0),
            
            (try_begin),
                (is_between, ":troop_no", mercenaries_begin, mercenaries_end),
                (val_mul, ":join_cost", 3),
                (val_div, ":join_cost", 2),
            (try_end),
            
            (assign, reg0, ":join_cost"),
            (set_trigger_result, reg0),
        ]),
  
    # script_game_get_upgrade_xp
        # This script is called from game engine for calculating needed troop upgrade exp
        # Input:
        # param1: troop_id,
        # Output: reg0 = needed exp for upgrade 
    ("game_get_upgrade_xp",
        [
        ]),
  
    # script_game_get_upgrade_cost
        # This script is called from game engine for calculating needed troop upgrade exp
        # Input:
        # param1: troop_id,
        # Output: reg0 = needed cost for upgrade
    ("game_get_upgrade_cost",
        [
        ]),

    # script_game_get_prisoner_price
        # This script is called from the game engine for calculating prisoner price
        # Input:
        # param1: troop_id,
        # Output: reg0  
    ("game_get_prisoner_price",
        [
        ]),

    # script_game_check_prisoner_can_be_sold
        # This script is called from the game engine for checking if a given troop can be sold.
        # Input: 
        # param1: troop_id,
        # Output: reg0: 1= can be sold; 0= cannot be sold.
    ("game_check_prisoner_can_be_sold",
        [
            (store_script_param, ":troop_no", 1),
            (assign, ":can_sell", 0),

            (try_begin),
                (neg|troop_is_hero, ":troop_no"),
                (assign, ":can_sell", 1),
            (try_end),

            (assign, reg0, ":can_sell"),
        ]),
  
    # script_game_get_morale_of_troops_from_faction
        # This script is called from the game engine 
        # Input: 
        # param1: faction_no,
        # Output: reg0: extra morale x 100
    ("game_get_morale_of_troops_from_faction",
        [
        ]),
  
    #script_game_event_detect_party:
        # This script is called from the game engine when player party inspects another party.
        # INPUT:
        # param1: Party-id
    ("game_event_detect_party",
        [
        ]),

    #script_game_event_undetect_party:
        # This script is called from the game engine when player party inspects another party.
        # INPUT:
        # param1: Party-id
    ("game_event_undetect_party",
        [
        ]),

    #script_game_get_statistics_line:
        # This script is called from the game engine when statistics page is opened.
        # INPUT:
        # param1: line_no
    ("game_get_statistics_line",
        [
            (store_script_param_1, ":line_no"),
            (try_begin),
                (eq, ":line_no", 0),
                (get_player_agent_kill_count, reg1),
                (str_store_string, s1, "str_number_of_troops_killed_reg1"),
                (set_result_string, s1),
            (else_try),
                (eq, ":line_no", 1),
                (get_player_agent_kill_count, reg1, 1),
                (str_store_string, s1, "str_number_of_troops_wounded_reg1"),
                (set_result_string, s1),
            (else_try),
                (eq, ":line_no", 2),
                (get_player_agent_own_troop_kill_count, reg1),
                (str_store_string, s1, "str_number_of_own_troops_killed_reg1"),
                (set_result_string, s1),
            (else_try),
                (eq, ":line_no", 3),
                (get_player_agent_own_troop_kill_count, reg1, 1),
                (str_store_string, s1, "str_number_of_own_troops_wounded_reg1"),
                (set_result_string, s1),
            (try_end),
        ]),

    # script_get_current_day
        # input: none
        # output:
        #   reg0: current_day
    ("get_current_day",
        [
            (store_current_hours, ":hours"),
            (assign, reg0, ":hours"),
        ]),

    #script_game_get_date_text:
        # This script is called from the game engine when the date needs to be displayed.
        # INPUT: arg1 = number of days passed since the beginning of the game
        # OUTPUT: result string = date
    ("game_get_date_text",
        [
            (store_script_param_2, ":num_hours"),
            
            # (store_div, ":num_days", ":num_hours", 24),
            (assign, ":num_days", ":num_hours"),
            (store_add, ":cur_day", ":num_days", 23),
            (assign, ":cur_month", 1),
            (assign, ":cur_year", starting_year),
            (assign, ":try_range", 99999),
            (try_for_range, ":unused", 0, ":try_range"),
                (try_begin),
                    (this_or_next|eq, ":cur_month", 1),
                    (this_or_next|eq, ":cur_month", 3),
                    (this_or_next|eq, ":cur_month", 5),
                    (this_or_next|eq, ":cur_month", 7),
                    (this_or_next|eq, ":cur_month", 8),
                    (this_or_next|eq, ":cur_month", 10),
                    (eq, ":cur_month", 12),
                    (assign, ":month_day_limit", 31),
                (else_try),
                    (this_or_next|eq, ":cur_month", 4),
                    (this_or_next|eq, ":cur_month", 6),
                    (this_or_next|eq, ":cur_month", 9),
                    (eq, ":cur_month", 11),
                    (assign, ":month_day_limit", 30),
                (else_try),
                    (try_begin),
                        (store_div, ":cur_year_div_4", ":cur_year", 4),
                        (val_mul, ":cur_year_div_4", 4),
                        (eq, ":cur_year_div_4", ":cur_year"),
                        (assign, ":month_day_limit", 29),
                    (else_try),
                        (assign, ":month_day_limit", 28),      
                    (try_end),
                (try_end),
                (try_begin),
                    (gt, ":cur_day", ":month_day_limit"),
                    (val_sub, ":cur_day", ":month_day_limit"),
                    (val_add, ":cur_month", 1),
                    (try_begin),
                        (gt, ":cur_month", 12),
                        (val_sub, ":cur_month", 12),
                        (val_add, ":cur_year", 1),
                    (try_end),
                (else_try),
                    (assign, ":try_range", 0),
                (try_end),
            (try_end),
            (assign, reg1, ":cur_day"),
            (assign, reg2, ":cur_year"),
            (try_begin),
                (eq, ":cur_month", 1),
                (str_store_string, s1, "str_january_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 2),
                (str_store_string, s1, "str_february_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 3),
                (str_store_string, s1, "str_march_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 4),
                (str_store_string, s1, "str_april_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 5),
                (str_store_string, s1, "str_may_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 6),
                (str_store_string, s1, "str_june_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 7),
                (str_store_string, s1, "str_july_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 8),
                (str_store_string, s1, "str_august_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 9),
                (str_store_string, s1, "str_september_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 10),
                (str_store_string, s1, "str_october_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 11),
                (str_store_string, s1, "str_november_reg1_reg2"),
            (else_try),
                (eq, ":cur_month", 12),
                (str_store_string, s1, "str_december_reg1_reg2"),
            (try_end),
            (set_result_string, s1),
        ]),
  
    #script_game_get_money_text:
        # This script is called from the game engine when an amount of money needs to be displayed.
        # INPUT: arg1 = amount in units
        # OUTPUT: result string = money in text
    ("game_get_money_text",
        [
            (store_script_param, ":amount", 1),
            (str_clear, s0),
            
            (try_begin),
                (eq, ":amount", 1),
                (str_store_string, s0, "str_1_denar"),
            (else_try),
                (assign, reg1, ":amount"),
                (str_store_string, s0, "str_reg1_denars"),
            (try_end),
            
            (set_result_string, s0),
        ]),

    # script_game_get_party_companion_limit:
        # This script is called from the game engine when the companion limit is needed for a party.
        # INPUT: arg1 = none
        # OUTPUT: reg0 = companion_limit
    ("game_get_party_companion_limit",
        [
            (set_trigger_result, 9999),
        ]),

    #script_game_reset_player_party_name:
        # This script is called from the game engine when the player name is changed.
        # INPUT: none
        # OUTPUT: none
    ("game_reset_player_party_name",
        [
            # (str_store_troop_name, s10, "$g_player_troop"),
            # (troop_set_plural_name, "$g_player_troop", s10),
            
            # (call_script, "script_troop_get_rank", "$g_player_troop"),
            
            # (troop_set_slot, "$g_player_troop", slot_troop_rank, reg0),
            
            # (call_script, "script_troop_update_name", "$g_player_troop"),
        ]),

    #script_game_get_troop_note
        # This script is called from the game engine when the notes of a troop is needed.
        # INPUT: arg1 = troop_no, arg2 = note_index
        # OUTPUT: s0 = note
    ("game_get_troop_note",
        [
            (store_script_param, ":troop_no", 1),
            # (store_script_param, ":index", 2),

            (troop_get_slot, ":troop_notes", ":troop_no", slot_troop_notes),

            (str_clear, s0),

            (str_store_troop_name, s20, ":troop_no"),
            (try_begin),
                (troop_slot_eq, ":troop_no", slot_troop_notes, tn_unknown),
                (str_store_string, s0, "@{s20} is unknown."),
            (else_try),
                (store_and, ":know_faction", ":troop_notes", tn_know_faction),
                (try_begin),
                    (ge, ":know_faction", 1),
                    (store_troop_faction, ":troop_faction", ":troop_no"),
                    (str_store_faction_name_link, s21, ":troop_faction"),

                    (store_and, ":know_faction_rank", ":troop_notes", tn_know_faction_rank),
                    (try_begin),
                        (ge, ":know_faction_rank", 1),
                        (faction_slot_eq, ":troop_faction", slot_faction_leader, ":troop_no"),
                        (str_store_string, s0, "@{s0} is leader of the {s21}.^"),
                    (else_try),
                        (str_store_string, s0, "@{s0} is a vassal of the {s21}.^"),
                    (try_end),
                    (try_begin),
                        (ge, ":know_faction_rank", 1),
                        (faction_slot_eq, ":troop_faction", slot_faction_marshall, ":troop_no"),
                        (str_store_string, s0, "@{s0}He is the current marhsall.^"),
                    (try_end),
                (try_end),
                (store_and, ":know_face", ":troop_notes", tn_know_face),
                (try_begin),
                    (ge, ":know_face", 1),
                    (add_troop_note_tableau_mesh, ":troop_no", "tableau_troop_note_mesh"),
                (try_end),
            (try_end),

            (set_trigger_result, 1),
        ]),
  
    #script_game_get_center_note
        # This script is called from the game engine when the notes of a center is needed.
        # INPUT: arg1 = center_no, arg2 = note_index
        # OUTPUT: s0 = note
    ("game_get_center_note",
        [
        ]),

    #script_game_get_faction_note
        # This script is called from the game engine when the notes of a faction is needed.
        # INPUT: arg1 = faction_no, arg2 = note_index
        # OUTPUT: s0 = note
    ("game_get_faction_note",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":note_index", 2),

            (str_clear, s0),

            (str_store_faction_name, s12, ":faction_no"),

            (try_begin),
                (eq, ":note_index", 0),
                (str_store_string, s0, "@{s12}"),

                (faction_get_slot, ":leader", ":faction_no", slot_faction_leader),
                (try_begin),
                    (ge, ":leader", 0),
                    (str_store_troop_name_link, s10, ":leader"),
                    (str_store_string, s0, "@{s0} is lead by {s10}"),
                (try_end),

                (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),
                (try_begin),
                    (gt, ":vassal_type", 0),
                    (assign, reg10, ":vassal_type"),
                    (str_store_string, s0, "@{s0}^^ Vassal Type: {reg10}"),
                (try_end),

            (else_try),
                (eq, ":note_index", 1),
                # ToDo: faction relations
                # ToDo: faction territories
                (str_store_string, s0, "@Current territories: ^"),
                (str_clear, s10),
                (try_for_range, ":cur_center", centers_begin, centers_end),
                    (party_get_slot, ":center_faction", ":cur_center", slot_party_faction),
                    (eq, ":center_faction", ":faction_no"),
                    (str_store_party_name_link, s11, ":cur_center"),
                    (try_begin),
                        (str_is_empty, s10),
                        (str_store_string, s10, "@{s10}{s11}"),
                    (else_try),
                        (str_store_string, s10, "@{s10}, {s11}"),
                    (try_end),
                (try_end),
                (try_begin),
                    (str_is_empty, s10),
                    (str_store_string, s0, "@{s0}{s12} owns no land."),
                (else_try),
                    (str_store_string, s0, "@{s0}{s10}"),
                (try_end),
            (else_try),
                (eq, ":note_index", 2),
                # ToDo: faction policies
                # (try_for_range, ":cur_faction", kingdoms_begin, kingdoms_end),
                #     (neq, ":cur_faction", ":faction_no"),
                #     (store_relation, ":relation", ":cur_faction", ":faction_no"),
                # (try_end),
            (else_try),
                (eq, ":note_index", 3),

                (str_store_string, s0, "@Current vassals: ^"),
                (str_clear, s10),
                (try_for_range, ":cur_lord", npc_heroes_begin, npc_heroes_end),
                    (troop_slot_eq, ":cur_lord", slot_troop_kingdom_occupation, tko_kingdom_hero),
                    (store_troop_faction, ":troop_faction", ":cur_lord"),
                    (eq, ":troop_faction", ":faction_no"),
                    # (troop_get_slot, ":known", ":cur_lord", slot_troop_notes),
                    # (val_and, ":known", tn_know_faction|tn_know_faction_rank),
                    # (ge, ":known", 1),

                    (str_store_troop_name_link, s11, ":cur_lord"),
                    (try_begin),
                        (str_is_empty, s10),
                        (str_store_string, s10, "@{s10}{s11}"),
                    (else_try),
                        (str_store_string, s10, "@{s10}, {s11}"),
                    (try_end),
                (try_end),
                (try_begin),
                    (str_is_empty, s10),
                    (str_store_string, s0, "@{s0}{s12} has no vassals."),
                (else_try),
                    (str_store_string, s0, "@{s0}{s10}"),
                (try_end),
            (else_try),
                (eq, ":note_index", 4),

                (faction_get_slot, ":wealth", ":faction_no", slot_faction_wealth),
                (call_script, "script_game_get_money_text", ":wealth"),
                (str_store_string_reg, s10, s0),
                (str_store_string, s0, "@Current wealth: {s10}"),
            (try_end),

            (set_trigger_result, 1),
        ]),

    #script_game_get_quest_note
        # This script is called from the game engine when the notes of a quest is needed.
        # INPUT: arg1 = quest_no, arg2 = note_index
        # OUTPUT: s0 = note
    ("game_get_quest_note",
        [
            (set_trigger_result, 0), # set it to 1 if this script is wanted to be used rather than static notes
        ]),

    #script_game_get_info_page_note
        # This script is called from the game engine when the notes of a info_page is needed.
        # INPUT: arg1 = info_page_no, arg2 = note_index
        # OUTPUT: s0 = note
    ("game_get_info_page_note",
        [
        ]),

    #script_game_get_scene_name
        # This script is called from the game engine when a name for the scene is needed.
        # INPUT: arg1 = scene_no
        # OUTPUT: s0 = name
    ("game_get_scene_name",
        [
        ]),
  
    #script_game_get_mission_template_name
        # This script is called from the game engine when a name for the mission template is needed.
        # INPUT: arg1 = mission_template_no
        # OUTPUT: s0 = name
    ("game_get_mission_template_name",
        [
        ]),

    #script_game_receive_url_response
        #response format should be like this:
        #  [a number or a string]|[another number or a string]|[yet another number or a string] ...
        # here is an example response:
        # 12|Player|100|another string|142|323542|34454|yet another string
        # INPUT: arg1 = num_integers, arg2 = num_strings
        # reg0, reg1, reg2, ... up to 128 registers contain the integer values
        # s0, s1, s2, ... up to 128 strings contain the string values
    ("game_receive_url_response",
        [
        ]),
      
    ("game_get_cheat_mode",
        [
        ]),    
  
    #script_game_receive_network_message
        # This script is called from the game engine when a new network message is received.
        # INPUT: arg1 = player_no, arg2 = event_type, arg3 = value, arg4 = value_2, arg5 = value_3, arg6 = value_4
    ("game_receive_network_message",
        [
        ]),

    # script_game_get_multiplayer_server_option_for_mission_template
        # Input: arg1 = mission_template_id, arg2 = option_index
        # Output: trigger_result = 1 for option available, 0 for not available
        # reg0 = option_value
    ("game_get_multiplayer_server_option_for_mission_template",
        [
        ]),

    # script_game_multiplayer_server_option_for_mission_template_to_string
        # Input: arg1 = mission_template_id, arg2 = option_index, arg3 = option_value
        # Output: s0 = option_text
    ("game_multiplayer_server_option_for_mission_template_to_string",
        [
        ]),

    # script_game_multiplayer_event_duel_offered
        # Input: arg1 = agent_no
        # Output: none
    ("game_multiplayer_event_duel_offered",
        [
        ]),
     
    # script_game_get_multiplayer_game_type_enum
        # Input: none
        # Output: reg0:first type, reg1:type count
    ("game_get_multiplayer_game_type_enum",
        [
        ]),

    # script_game_multiplayer_get_game_type_mission_template
        # Input: arg1 = game_type
        # Output: mission_template 
    ("game_multiplayer_get_game_type_mission_template",
        [
        ]),

    #script_game_get_party_prisoner_limit:
        # This script is called from the game engine when the prisoner limit is needed for a party.
        # INPUT: arg1 = party_no
        # OUTPUT: reg0 = prisoner_limit
    ("game_get_party_prisoner_limit",
        [
            (store_script_param, ":party_no", 1),
            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (party_get_num_companions, ":limit", ":party_no"),
            (try_begin),
                (ge, ":leader", 0),
                (troop_is_hero, ":leader"),
                (store_skill_level, ":prisoner_level", skl_prisoner_management, ":leader"),

                (store_mul, ":prisoner_mult", ":prisoner_level", 10),
                (store_mul, ":flat_bonus", ":prisoner_level", 5),

                (val_mul, ":limit", ":prisoner_mult"),
                (val_div, ":limit", 100),
                (val_add, ":limit", ":flat_bonus"),
            (else_try),
                # Parties with no leader or non-hero leaders are considered having 1 in prisoner management
                # Means 10% of party size max can be prisoners
                (val_div, ":limit", 10),
            (try_end),
            (assign, reg0, ":limit"),
            (set_trigger_result, reg0),
        ]),

    #script_game_get_item_extra_text:
        # This script is called from the game engine when an item's properties are displayed.
        # INPUT: arg1 = item_no, arg2 = extra_text_id (this can be between 0-7 (7 included)), arg3 = item_modifier
        # OUTPUT: result_string = item extra text, trigger_result = text color (0 for default)
    ("game_get_item_extra_text",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":extra_text_id", 2),
            # (store_script_param, ":item_modifier", 3),
            
            (try_begin),
                (this_or_next|eq, ":item_no", "itm_javelin"),
                (this_or_next|eq, ":item_no", "itm_jarid"),
                (eq, ":item_no", "itm_throwing_spears"),
                (eq, ":extra_text_id", 0),
                (set_result_string, "@Bonus against armor"),
                (set_trigger_result, 0xFFF022),
            (try_end),
            (try_begin),
                # (is_between, ":item_no", goods_begin, goods_end),
                (ge, "$g_trading", 1),
                (assign, ":tax_rate", 0),
                (assign, ":string", 0),
                (try_begin),
                    (eq, ":extra_text_id", 6),
                    (party_get_slot, ":tax_rate", "$g_encountered_party", slot_party_taxes_buy),
                    (assign, ":string", "str_item_taxes_buy"),
                    (assign, reg10, ":tax_rate"),
                (else_try),
                    (eq, ":extra_text_id", 7),
                    (party_get_slot, ":tax_rate", "$g_encountered_party", slot_party_taxes_sell),
                    (assign, ":string", "str_item_taxes_sell"),
                    (assign, reg10, ":tax_rate"),
                (try_end),
                (gt, ":string", 0),
                (str_store_string, s0, ":string"),
                (set_result_string, s0),
                (set_trigger_result, 0x87CAD1),
            (try_end),
        ]),

    #script_game_on_disembark:
        # This script is called from the game engine when the player reaches the shore with a ship.
        # INPUT: pos0 = disembark position
        # OUTPUT: none
    ("game_on_disembark",
        [
        ]),


    #script_game_context_menu_get_buttons:
        # This script is called from the game engine when the player clicks the right mouse button over a party on the map.
        # INPUT: arg1 = party_no
        # OUTPUT: none, fills the menu buttons
    ("game_context_menu_get_buttons",
        [
        ]),

    #script_game_event_context_menu_button_clicked:
        # This script is called from the game engine when the player clicks on a button at the right mouse menu.
        # INPUT: arg1 = party_no, arg2 = button_value
        # OUTPUT: none
    ("game_event_context_menu_button_clicked",
        [
        ]),

    #script_game_get_skill_modifier_for_troop
        # This script is called from the game engine when a skill's modifiers are needed
        # INPUT: arg1 = troop_no, arg2 = skill_no
        # OUTPUT: trigger_result = modifier_value
    ("game_get_skill_modifier_for_troop",
        [
            # (store_script_param, ":troop_no", 1),
            # (store_script_param, ":skill_no", 2),

            (assign, ":bonus_skill", 0),

            (assign, reg0, ":bonus_skill"),
            (set_trigger_result, ":bonus_skill"),
        ]),
  
    # script_game_check_party_sees_party
        # This script is called from the game engine when a party is inside the range of another party
        # input: arg1 = party_no_seer, arg2 = party_no_seen
        # output: trigger_result = true or false (1 = true, 0 = false)
    ("game_check_party_sees_party",
        [
            (store_script_param, ":party_no_seer", 1),
            (store_script_param, ":party_no_seen", 2),
            
            (try_begin),
                (eq, ":party_no_seer", "$g_player_party"),

                (try_begin),
                    (store_faction_of_party, ":seen_faction", ":party_no_seen"),
                    (is_between, ":seen_faction", kingdoms_begin, kingdoms_end),
                    (faction_set_note_available, ":seen_faction", 1),
                (try_end),

                (party_get_slot, ":party_type", ":party_no_seen", slot_party_type),
                (is_between, ":party_type", spt_village, spt_fort + 1),

                (party_set_flags, ":party_no_seen", pf_always_visible, 1),
                (party_set_note_available, ":party_no_seen", 1),

            (try_end),
            (set_trigger_result, 1),
        ]),

    #script_game_get_party_speed_multiplier
        # This script is called from the game engine when a skill's modifiers are needed
        # INPUT: arg1 = party_no
        # OUTPUT: trigger_result = multiplier (scaled by 100, meaning that giving 100 as the trigger result does not change the party speed)
    ("game_get_party_speed_multiplier",
        [
            # (store_script_param, ":party_no", 1),
            # (assign, ":speed", 100),

            # (call_script, "script_game_get_party_prisoner_limit", ":party_no"),
            # (assign, ":prisoner_limit", reg0),

            # (party_get_num_companions, ":party_size", ":party_no"),
            # (party_get_num_prisoners, ":prisoner_size", ":party_no"),

            # (try_begin),
            #     (gt, ":party_size", ":party_limit"),
            #     (store_mul, ":party_modifier", ":party_size", 100),
            #     (val_div, ":party_modifier", ":party_limit"),

            #     (val_mul, ":speed", 100),
            #     (val_div, ":speed", ":party_modifier"),
            # (try_end),
            # (try_end),
            #     (gt, ":prisoner_size", ":prisoner_limit"),
            #     (store_mul, ":prisoner_modifier", ":prisoner_limit"),
            #     (val_div, ":prisoner_modifier", ":party_limit"),

            #     (val_mul, ":speed", 100),
            #     (val_div, ":speed", ":prisoner_modifier"),
            # (try_end),

            # (val_max, ":speed", 50),

            # (set_trigger_result, ":speed"),

            (set_trigger_result, 100),
        ]),

    #script_game_get_console_command
        # This script is called from the game engine when a console command is entered from the dedicated server.
        # INPUT: anything
        # OUTPUT: s0 = result text
    ("game_get_console_command",
        [
        ]),
    
    # script_clear_party_group:
    # input:
    #   arg1: Party-id of the root of the group.
    # This script will clear the root party and all parties attached to it recursively.
    ("clear_party_group",
        [
            (store_script_param_1, ":root_party"),

            (try_begin),
                (ge, ":root_party", 0),

                (party_get_attached_to, ":attached", ":root_party"),
                (try_begin),
                    (ge, ":attached", 0),
                    (party_detach, ":root_party"),
                (try_end),
                
                (party_get_num_attached_parties, ":num_attached_parties", ":root_party"),
                (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":attached_party", ":root_party", ":attached_party_rank"),
                    (call_script, "script_clear_party_group", ":attached_party"),
                (try_end),

                (neq, ":root_party", "$g_player_party"),

                (party_clear, ":root_party"),
                # (try_begin),
                #     (neg|is_between, ":root_party", centers_begin, centers_end),
                #     (remove_party, ":root_party"),
                # (try_end),
            (try_end),
        ]),
    
    #script_add_troop_to_cur_tableau
    # INPUT: troop_no
    # OUTPUT: none
    ("add_troop_to_cur_tableau",
        [
            (store_script_param, ":troop_no",1),

            (set_fixed_point_multiplier, 100),
            (assign, ":banner_mesh", -1),
            # (troop_get_slot, ":banner_spr", ":troop_no", slot_troop_banner_scene_prop),
            # (store_add, ":banner_scene_props_end", banner_scene_props_end_minus_one, 1),
            # (try_begin),
                # (is_between, ":banner_spr", banner_scene_props_begin, ":banner_scene_props_end"),
                # (val_sub, ":banner_spr", banner_scene_props_begin),
                # (store_add, ":banner_mesh", ":banner_spr", banner_meshes_begin),
            # (try_end),

            (cur_tableau_clear_override_items),
           
            (cur_tableau_set_override_flags, af_override_fullhelm),
            (cur_tableau_set_override_flags, af_override_head|af_override_weapons),
           
            (init_position, pos2),
            (cur_tableau_set_camera_parameters, 1, 6, 6, 10, 10000),

            (init_position, pos5),
            (assign, ":eye_height", 162),
            (store_mul, ":camera_distance", ":troop_no", 87323),
            # (val_mod, ":camera_distance", 5),
            (assign, ":camera_distance", 139),
            (store_mul, ":camera_yaw", ":troop_no", 124337),
            (val_mod, ":camera_yaw", 50),
            (val_add, ":camera_yaw", -25),
            (store_mul, ":camera_pitch", ":troop_no", 98123),
            (val_mod, ":camera_pitch", 20),
            (val_add, ":camera_pitch", -14),
            (assign, ":animation", "anim_stand_man"),
           
    ##       (troop_get_inventory_slot, ":horse_item", ":troop_no", ek_horse),
    ##       (try_begin),
    ##         (gt, ":horse_item", 0),
    ##         (assign, ":eye_height", 210),
    ##         (cur_tableau_add_horse, ":horse_item", pos2, anim_horse_stand, 0),
    ##         (assign, ":animation", anim_ride_0),
    ##         (position_set_z, pos5, 125),
    ##         (try_begin),
    ##           (is_between, ":camera_yaw", -10, 10), #make sure horse head doesn't obstruct face.
    ##           (val_min, ":camera_pitch", -5),
    ##         (try_end),
    ##       (try_end),
            (position_set_z, pos5, ":eye_height"),
    
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
    
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 5, 0),
    
            (try_begin),
                (ge, ":banner_mesh", 0),
    
                (init_position, pos1),
                (position_set_z, pos1, -1500),
                (position_set_x, pos1, 265),
                (position_set_y, pos1, 400),
                (position_transform_position_to_parent, pos3, pos5, pos1),
                (cur_tableau_add_mesh, ":banner_mesh", pos3, 400, 0),
            (try_end),
            (cur_tableau_add_troop, ":troop_no", pos2, ":animation" , 0),
    
            (cur_tableau_set_camera_position, pos5),
    
            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30), 
            (position_rotate_x, pos8, -60), 
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),

    #script_add_troop_to_cur_tableau_for_character
    # INPUT: troop_no
    # OUTPUT: none
    ("add_troop_to_cur_tableau_for_character",
        [
            (store_script_param, ":troop_no",1),
    
            (set_fixed_point_multiplier, 100),
    
            (cur_tableau_clear_override_items),
            (cur_tableau_set_override_flags, af_override_fullhelm),
    ##         (cur_tableau_set_override_flags, af_override_head|af_override_weapons),
            
            (init_position, pos2),
            (cur_tableau_set_camera_parameters, 1, 4, 8, 10, 10000),
    
            (init_position, pos5),
            (assign, ":cam_height", 150),
    #         (val_mod, ":camera_distance", 5),
            (assign, ":camera_distance", 360),
            (assign, ":camera_yaw", -15),
            (assign, ":camera_pitch", -18),
            (assign, ":animation", anim_stand_man),
            
            (position_set_z, pos5, ":cam_height"),
    
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
    
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 5, 0),
    
            (try_begin),
                (troop_is_hero, ":troop_no"),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", -1),
            (else_try),
                (store_mul, ":random_seed", ":troop_no", 126233),
                (val_mod, ":random_seed", 1000),
                (val_add, ":random_seed", 1),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", ":random_seed"),
            (try_end),
            (cur_tableau_set_camera_position, pos5),
    
            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30), 
            (position_rotate_x, pos8, -60), 
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),

    #script_add_troop_to_cur_tableau_for_inventory
    # INPUT: troop_no
    # OUTPUT: none
    ("add_troop_to_cur_tableau_for_inventory",
        [
            (store_script_param, ":troop_no",1),
            (store_mod, ":side", ":troop_no", 4), #side flag is inside troop_no value
            (val_div, ":troop_no", 4), #removing the flag bit
            (val_mul, ":side", 90), #to degrees
    
            (set_fixed_point_multiplier, 100),
    
            (cur_tableau_clear_override_items),
            
            (init_position, pos2),
            (position_rotate_z, pos2, ":side"),
            (cur_tableau_set_camera_parameters, 1, 4, 6, 10, 10000),
    
            (init_position, pos5),
            (assign, ":cam_height", 105),
    #         (val_mod, ":camera_distance", 5),
            (assign, ":camera_distance", 380),
            (assign, ":camera_yaw", -15),
            (assign, ":camera_pitch", -18),
            (assign, ":animation", anim_stand_man),
            
            (position_set_z, pos5, ":cam_height"),
    
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
    
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 5, 0),
    
            (try_begin),
                (troop_is_hero, ":troop_no"),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", -1),
            (else_try),
                (store_mul, ":random_seed", ":troop_no", 126233),
                (val_mod, ":random_seed", 1000),
                (val_add, ":random_seed", 1),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", ":random_seed"),
            (try_end),
            (cur_tableau_set_camera_position, pos5),
    
            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30), 
            (position_rotate_x, pos8, -60), 
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),

    #script_add_troop_to_cur_tableau_for_profile
    # INPUT: troop_no
    # OUTPUT: none
    ("add_troop_to_cur_tableau_for_profile",
        [
            (store_script_param, ":troop_no",1),
    
            (set_fixed_point_multiplier, 100),
    
            (cur_tableau_clear_override_items),
            
            (cur_tableau_set_camera_parameters, 1, 4, 6, 10, 10000),
    
            (init_position, pos5),
            (assign, ":cam_height", 105),
    #         (val_mod, ":camera_distance", 5),
            (assign, ":camera_distance", 380),
            (assign, ":camera_yaw", -15),
            (assign, ":camera_pitch", -18),
            (assign, ":animation", anim_stand_man),
            
            (position_set_z, pos5, ":cam_height"),
    
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
    
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 5, 0),
    
            # (profile_get_banner_id, ":profile_banner"),
            # (try_begin),
                # (ge, ":profile_banner", 0),
                # (init_position, pos2),
                # (val_add, ":profile_banner", banner_meshes_begin),
                # (position_set_x, pos2, -175),
                # (position_set_y, pos2, -300),
                # (position_set_z, pos2, 180),
                # (position_rotate_x, pos2, 90),
                # (position_rotate_y, pos2, -15),
                # (cur_tableau_add_mesh, ":profile_banner", pos2, 0, 0),
            # (try_end),

            (init_position, pos2),
            (try_begin),
                (troop_is_hero, ":troop_no"),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", -1),
            (else_try),
                (store_mul, ":random_seed", ":troop_no", 126233),
                (val_mod, ":random_seed", 1000),
                (val_add, ":random_seed", 1),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", ":random_seed"),
            (try_end),
            (cur_tableau_set_camera_position, pos5),

            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30), 
            (position_rotate_x, pos8, -60), 
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),

    #script_add_troop_to_cur_tableau_for_retirement
    # INPUT: type
    # OUTPUT: none
    ("add_troop_to_cur_tableau_for_retirement", 
        [
            (store_script_param, ":type", 1),
            (cur_tableau_set_override_flags, af_override_everything),

            (try_begin),
                (eq, ":type", 0),
                # (cur_tableau_add_override_item, "itm_pilgrim_hood"),
                # (cur_tableau_add_override_item, "itm_pilgrim_disguise"),
                # (cur_tableau_add_override_item, "itm_wrapping_boots"),
                (assign, ":animation", "anim_pose_1"),
            (else_try),
                (eq, ":type", 1),
                # (cur_tableau_add_override_item, "itm_pilgrim_hood"),
                # (cur_tableau_add_override_item, "itm_red_tunic"),
                # (cur_tableau_add_override_item, "itm_wrapping_boots"),
                # (cur_tableau_add_override_item, "itm_dagger"),
                (assign, ":animation", "anim_pose_1"),
            (else_try),
                (eq, ":type", 2),
                # (cur_tableau_add_override_item, "itm_linen_tunic"),
                # (cur_tableau_add_override_item, "itm_wrapping_boots"),
                (assign, ":animation", "anim_pose_2"),
            (else_try),
                (eq, ":type", 3),
                # (cur_tableau_add_override_item, "itm_nomad_vest"),
                # (cur_tableau_add_override_item, "itm_nomad_boots"),
                (assign, ":animation", "anim_pose_2"),
            (else_try),
                (eq, ":type", 4),
                # (cur_tableau_add_override_item, "itm_leather_apron"),
                # (cur_tableau_add_override_item, "itm_leather_boots"),
                (assign, ":animation", "anim_pose_3"),
            (else_try),
                (eq, ":type", 5),
                # (cur_tableau_add_override_item, "itm_red_shirt"),
                # (cur_tableau_add_override_item, "itm_woolen_hose"),
                # (cur_tableau_add_override_item, "itm_fur_hat"),
                (assign, ":animation", "anim_pose_3"),
            (else_try),
                (eq, ":type", 6),
                # (cur_tableau_add_override_item, "itm_red_gambeson"),
                # (cur_tableau_add_override_item, "itm_leather_boots"),
                # (cur_tableau_add_override_item, "itm_sword_medieval_c"),
                (assign, ":animation", "anim_pose_4"),
            (else_try),
                (eq, ":type", 7),
                # (cur_tableau_add_override_item, "itm_nobleman_outfit"),
                # (cur_tableau_add_override_item, "itm_blue_hose"),
                # (cur_tableau_add_override_item, "itm_sword_medieval_c"),
                (assign, ":animation", "anim_pose_4"),
            (else_try),
                (eq, ":type", 8),
                # (cur_tableau_add_override_item, "itm_courtly_outfit"),
                # (cur_tableau_add_override_item, "itm_woolen_hose"),
                # (cur_tableau_add_override_item, "itm_sword_medieval_c"),
                (assign, ":animation", "anim_pose_4"),
            (else_try),
                # (eq, ":type", 9),
                # (cur_tableau_add_override_item, "itm_heraldic_mail_with_surcoat_for_tableau"),
                # (cur_tableau_add_override_item, "itm_mail_boots_for_tableau"),
                # (cur_tableau_add_override_item, "itm_sword_medieval_c"),
                (assign, ":animation", "anim_pose_5"),
        ##      (else_try), #not used
        ##        (cur_tableau_add_override_item, "itm_heraldic_mail_with_tabard"),
        ##        (cur_tableau_add_override_item, "itm_iron_greaves"),
        ##        (cur_tableau_add_override_item, "itm_sword_medieval_c"),
        ##        (assign, ":animation", "anim_pose_5"),
            (try_end),

        ##    (set_fixed_point_multiplier, 100),
        ##    (cur_tableau_set_background_color, 0x00000000),
        ##    (cur_tableau_set_ambient_light, 10,11,15),

        ##     (init_position, pos8),
        ##     (position_set_x, pos8, -210),
        ##     (position_set_y, pos8, 200),
        ##     (position_set_z, pos8, 300),
        ##     (cur_tableau_add_point_light, pos8, 550,500,450),


            (set_fixed_point_multiplier, 100),
            (cur_tableau_set_camera_parameters, 1, 6, 6, 10, 10000),
            (assign, ":cam_height", 155),
            (assign, ":camera_distance", 575),
            (assign, ":camera_yaw", -5),
            (assign, ":camera_pitch", 10),

            (init_position, pos5),
            (position_set_z, pos5, ":cam_height"),
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 60, 0),

            (init_position, pos2),
            (cur_tableau_add_troop, "$g_player_troop", pos2, ":animation", 0),
            (cur_tableau_set_camera_position, pos5),

            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30),
            (position_rotate_x, pos8, -60),
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),
  
    #script_add_troop_to_cur_tableau_for_party
    # INPUT: troop_no
    # OUTPUT: none
    ("add_troop_to_cur_tableau_for_party",
        [
            (store_script_param, ":troop_no",1),
            (store_mod, ":hide_weapons", ":troop_no", 2), #hide_weapons flag is inside troop_no value
            (val_div, ":troop_no", 2), #removing the flag bit
            
            (set_fixed_point_multiplier, 100),
            
            (cur_tableau_clear_override_items),
            (try_begin),
                (eq, ":hide_weapons", 1),
                (cur_tableau_set_override_flags, af_override_fullhelm|af_override_head|af_override_weapons),
            (try_end),
            
            (init_position, pos2),
            (cur_tableau_set_camera_parameters, 1, 6, 6, 10, 10000),
            
            (init_position, pos5),
            (assign, ":cam_height", 105),
            # (val_mod, ":camera_distance", 5),
            (assign, ":camera_distance", 450),
            (assign, ":camera_yaw", 15),
            (assign, ":camera_pitch", -18),
            (assign, ":animation", anim_stand_man),
            
            (troop_get_inventory_slot, ":horse_item", ":troop_no", ek_horse),
            (try_begin),
                (gt, ":horse_item", 0),
                (eq, ":hide_weapons", 0),
                (cur_tableau_add_horse, ":horse_item", pos2, "anim_horse_stand", 0),
                (assign, ":animation", "anim_ride_0"),
                (assign, ":camera_yaw", 23),
                (assign, ":cam_height", 150),
                (assign, ":camera_distance", 550),
            (try_end),
            (position_set_z, pos5, ":cam_height"),
            
            # camera looks towards -z axis
            (position_rotate_x, pos5, -90),
            (position_rotate_z, pos5, 180),
            
            # now apply yaw and pitch
            (position_rotate_y, pos5, ":camera_yaw"),
            (position_rotate_x, pos5, ":camera_pitch"),
            (position_move_z, pos5, ":camera_distance", 0),
            (position_move_x, pos5, 5, 0),
            
            (try_begin),
                (troop_is_hero, ":troop_no"),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", -1),
            (else_try),
                (store_mul, ":random_seed", ":troop_no", 126233),
                (val_mod, ":random_seed", 1000),
                (val_add, ":random_seed", 1),
                (cur_tableau_add_troop, ":troop_no", pos2, ":animation", ":random_seed"),
            (try_end),
            (cur_tableau_set_camera_position, pos5),
            
            (copy_position, pos8, pos5),
            (position_rotate_x, pos8, -90), #y axis aligned with camera now. z is up
            (position_rotate_z, pos8, 30), 
            (position_rotate_x, pos8, -60), 
            (cur_tableau_add_sun_light, pos8, 175,150,125),
        ]),
     
    ########### 
    ## Other ##
    ###########
    # script_agent_troop_get_banner_mesh
        # input: 
        #   arg1: agent_no
        #   arg2: troop_no
        # output: 
        #   reg0: banner_mesh
    ("agent_troop_get_banner_mesh",
        [
            (store_script_param, ":agent_no", 1),
            (store_script_param, ":troop_no", 2),
            (assign, ":banner_troop", -1),
            (assign, ":banner_mesh", "mesh_banners_default_b"),
            (try_begin),
                (lt, ":agent_no", 0),
                (try_begin),
                    (ge, ":troop_no", 0),
                    (this_or_next|troop_slot_ge, ":troop_no", slot_troop_banner_scene_prop, 1),
                    (eq, ":troop_no", "$g_player_troop"),
                    (assign, ":banner_troop", ":troop_no"),
                (else_try),
                    (is_between, ":troop_no", companions_begin, companions_end),
                    (assign, ":banner_troop", "$g_player_troop"),
                (else_try),
                    (assign, ":banner_mesh", "mesh_banners_default_a"),
                (try_end),
            (else_try),
                (agent_get_troop_id, ":troop_id", ":agent_no"),
                (this_or_next|troop_slot_ge,  ":troop_id", slot_troop_banner_scene_prop, 1),
                (eq, ":troop_no", "$g_player_troop"),
                (assign, ":banner_troop", ":troop_id"),
            (else_try),
                (agent_get_party_id, ":agent_party", ":agent_no"),
                (try_begin),
                    (lt, ":agent_party", 0),
                    (is_between, ":troop_id", companions_begin, companions_end),
                    (main_party_has_troop, ":troop_id"),
                    (assign, ":agent_party", "$g_player_party"),
                (try_end),
                (ge, ":agent_party", 0),
                (try_begin),
                    (is_between, ":agent_party", centers_begin, centers_end),
                    (party_get_slot, ":town_lord", "$g_encountered_party", slot_party_leader),
                    (ge, ":town_lord", 0),
                    (assign, ":banner_troop", ":town_lord"),
                (else_try),
                    (this_or_next|party_slot_eq, ":agent_party", slot_party_type, spt_war_party),
                    (eq, ":agent_party", "$g_player_party"),
                    (party_get_num_companion_stacks, ":num_stacks", ":agent_party"),
                    (gt, ":num_stacks", 0),
                    (party_stack_get_troop_id, ":leader_troop_id", ":agent_party", 0),
                    (this_or_next|troop_slot_ge,  ":leader_troop_id", slot_troop_banner_scene_prop, 1),
                    (eq, ":leader_troop_id", "$g_player_troop"),
                    (assign, ":banner_troop", ":leader_troop_id"),
                (try_end),
            (else_try),
                (is_between, ":troop_id", soldiers_begin, soldiers_end),
                (store_troop_faction, ":troop_faction", ":troop_id"),
                (faction_get_slot, ":culture", ":troop_faction", slot_faction_culture),
                (try_begin),
                    (eq, ":culture", "fac_culture_1"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_f"),
                (else_try),
                    (eq, ":culture", "fac_culture_2"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_b"),
                (else_try),
                    (eq, ":culture", "fac_culture_3"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_c"),
                (else_try),
                    (eq, ":culture", "fac_culture_4"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_a"),
                (else_try),
                    (eq, ":culture", "fac_culture_5"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_d"),
                (else_try),
                    (eq, ":culture", "fac_culture_6"),
                    (assign, ":banner_mesh", "mesh_arms_kingdom_e"),
                (try_end),
            (try_end),
            (try_begin),
                (ge, ":banner_troop", 0),
                (try_begin),
                    (neg|troop_slot_ge, ":banner_troop", slot_troop_banner_scene_prop, 1),
                    (assign, ":banner_mesh", "mesh_banners_default_b"),
                (else_try), 
                    (troop_get_slot, ":banner_spr", ":banner_troop", slot_troop_banner_scene_prop),
                    (store_add, ":banner_scene_props_end", banner_scene_props_end_minus_one, 1),
                    (is_between, ":banner_spr", banner_scene_props_begin, ":banner_scene_props_end"),
                    (val_sub, ":banner_spr", banner_scene_props_begin),
                    (store_add, ":banner_mesh", ":banner_spr", arms_meshes_begin),
                (try_end),
            (try_end),
            (assign, reg0, ":banner_mesh"),
        ]),
    
    #script_shield_item_set_banner
    # INPUT: agent_no
    # OUTPUT: none
    ("shield_item_set_banner",
        [
            (store_script_param, ":tableau_no",1),
            (store_script_param, ":agent_no", 2),
            (store_script_param, ":troop_no", 3),
            (call_script, "script_agent_troop_get_banner_mesh", ":agent_no", ":troop_no"),
            (cur_item_set_tableau_material, ":tableau_no", reg0),
         ]),
      
    #script_troop_agent_set_banner
    # INPUT: agent_no
    # OUTPUT: none
    ("troop_agent_set_banner",
        [
            (store_script_param, ":tableau_no",1),
            (store_script_param, ":agent_no", 2),
            (store_script_param, ":troop_no", 3),
            (call_script, "script_agent_troop_get_banner_mesh", ":agent_no", ":troop_no"),
            (cur_agent_set_banner_tableau_material, ":tableau_no", reg0),
        ]),
    
    # script_init_arms_colors
    # input: none
    # output: none
    ("init_arms_colors",
        [
            # Primary colors
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a01 - arms_meshes_begin, 0xFF8C4531),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a02 - arms_meshes_begin, 0xFFD6D7CE),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a03 - arms_meshes_begin, 0xFF393A39),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a04 - arms_meshes_begin, 0xFFAD9229),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a05 - arms_meshes_begin, 0xFF4C7933),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a06 - arms_meshes_begin, 0xFF86392E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a07 - arms_meshes_begin, 0xFFD3D4CB),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a08 - arms_meshes_begin, 0xFF232523),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a09 - arms_meshes_begin, 0xFFDEDFD6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a10 - arms_meshes_begin, 0xFF52496B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a11 - arms_meshes_begin, 0xFFCECFC6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a12 - arms_meshes_begin, 0xFFB7AC36),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a13 - arms_meshes_begin, 0xFF736D42),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a14 - arms_meshes_begin, 0xFFDEDFD6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a15 - arms_meshes_begin, 0xFFCECFC6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a16 - arms_meshes_begin, 0xFFC3C4BA),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a17 - arms_meshes_begin, 0xFFCED3C6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a18 - arms_meshes_begin, 0xFFD0D1C8),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a19 - arms_meshes_begin, 0xFFDEDFD6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a20 - arms_meshes_begin, 0xFF525918),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a21 - arms_meshes_begin, 0xFF333C65),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b01 - arms_meshes_begin, 0xFF9F9444),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b02 - arms_meshes_begin, 0xFFA2983F),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b03 - arms_meshes_begin, 0xFF5F8047),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b04 - arms_meshes_begin, 0xFFB5B6AD),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b05 - arms_meshes_begin, 0xFF425963),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b06 - arms_meshes_begin, 0xFF8C3021),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b07 - arms_meshes_begin, 0xFF7B2821),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b08 - arms_meshes_begin, 0xFFB2AB31),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b09 - arms_meshes_begin, 0xFF9C382B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b10 - arms_meshes_begin, 0xFF4A618C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b11 - arms_meshes_begin, 0xFFA59229),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b12 - arms_meshes_begin, 0xFFC8C5C0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b13 - arms_meshes_begin, 0xFF866712),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b14 - arms_meshes_begin, 0xFFADA242),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b15 - arms_meshes_begin, 0xFF6B7110),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b16 - arms_meshes_begin, 0xFF313128),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b17 - arms_meshes_begin, 0xFFA23A33),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b18 - arms_meshes_begin, 0xFF526E41),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b19 - arms_meshes_begin, 0xFFA5654A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b20 - arms_meshes_begin, 0xFF526B39),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b21 - arms_meshes_begin, 0xFF863C33),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c01 - arms_meshes_begin, 0xFF737FB7),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c02 - arms_meshes_begin, 0xFFC38547),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c03 - arms_meshes_begin, 0xFFA5594A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c04 - arms_meshes_begin, 0xFF3E6386),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c05 - arms_meshes_begin, 0xFFE4E3D8),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c06 - arms_meshes_begin, 0xFF9C6D39),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c07 - arms_meshes_begin, 0xFFD6D7D0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c08 - arms_meshes_begin, 0xFF754A86),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c09 - arms_meshes_begin, 0xFF997244),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c10 - arms_meshes_begin, 0xFFC5C3BA),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c11 - arms_meshes_begin, 0xFF624B96),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c12 - arms_meshes_begin, 0xFF943421),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c13 - arms_meshes_begin, 0xFFC0BAAA),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c14 - arms_meshes_begin, 0xFF363529),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c15 - arms_meshes_begin, 0xFF8C8423),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c16 - arms_meshes_begin, 0xFF4F6A2E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c17 - arms_meshes_begin, 0xFFC3C1B7),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c18 - arms_meshes_begin, 0xFF393829),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c19 - arms_meshes_begin, 0xFF73618C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c20 - arms_meshes_begin, 0xFF4A658C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c21 - arms_meshes_begin, 0xFF33342B),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d01 - arms_meshes_begin, 0xFF783D2B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d02 - arms_meshes_begin, 0xFF313431),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d03 - arms_meshes_begin, 0xFF424D73),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d04 - arms_meshes_begin, 0xFFE1DFD8),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d05 - arms_meshes_begin, 0xFF836E33),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d06 - arms_meshes_begin, 0xFF917629),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d07 - arms_meshes_begin, 0xFF363531),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d08 - arms_meshes_begin, 0xFF9F4631),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d09 - arms_meshes_begin, 0xFFDEDFD6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d10 - arms_meshes_begin, 0xFF548C39),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d11 - arms_meshes_begin, 0xFF78651B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d12 - arms_meshes_begin, 0xFF9C4531),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d13 - arms_meshes_begin, 0xFFD3D4CB),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d14 - arms_meshes_begin, 0xFF4A6594),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d15 - arms_meshes_begin, 0xFF2B2D2B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d16 - arms_meshes_begin, 0xFF6B7921),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d17 - arms_meshes_begin, 0xFFC0AE33),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d18 - arms_meshes_begin, 0xFF734D29),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d19 - arms_meshes_begin, 0xFFD8D8D0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d20 - arms_meshes_begin, 0xFF897121),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d21 - arms_meshes_begin, 0xFF477473),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e01 - arms_meshes_begin, 0xFF313431),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e02 - arms_meshes_begin, 0xFF9F4A36),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e03 - arms_meshes_begin, 0xFFCECFC5),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e04 - arms_meshes_begin, 0xFFD8D8D3),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e05 - arms_meshes_begin, 0xFF39455A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e06 - arms_meshes_begin, 0xFF9F8631),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e07 - arms_meshes_begin, 0xFF9C4539),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e08 - arms_meshes_begin, 0xFFA19231),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e09 - arms_meshes_begin, 0xFFA14331),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e10 - arms_meshes_begin, 0xFF896E10),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e11 - arms_meshes_begin, 0xFF333233),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e12 - arms_meshes_begin, 0xFF3C4A57),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e13 - arms_meshes_begin, 0xFF4A6594),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e14 - arms_meshes_begin, 0xFF33322E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e15 - arms_meshes_begin, 0xFFA13D2B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e16 - arms_meshes_begin, 0xFFBD9608),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e17 - arms_meshes_begin, 0xFF5A8A4A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e18 - arms_meshes_begin, 0xFFDBD9D3),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e19 - arms_meshes_begin, 0xFFDBDCD3),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e20 - arms_meshes_begin, 0xFF783529),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e21 - arms_meshes_begin, 0xFFD8D9D0),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f01 - arms_meshes_begin, 0xFFCDA436),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f02 - arms_meshes_begin, 0xFFC8B470),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f03 - arms_meshes_begin, 0xFF314110),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f04 - arms_meshes_begin, 0xFF733018),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f05 - arms_meshes_begin, 0xFF946510),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f06 - arms_meshes_begin, 0xFFB77F10),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f07 - arms_meshes_begin, 0xFF817721),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f08 - arms_meshes_begin, 0xFF965700),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f09 - arms_meshes_begin, 0xFF292523),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f10 - arms_meshes_begin, 0xFFB59E31),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f11 - arms_meshes_begin, 0xFF997A29),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f12 - arms_meshes_begin, 0xFF758486),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f13 - arms_meshes_begin, 0xFFA79465),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f14 - arms_meshes_begin, 0xFF653657),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f15 - arms_meshes_begin, 0xFF681E15),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f16 - arms_meshes_begin, 0xFF123144),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f17 - arms_meshes_begin, 0xFF4A4500),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f18 - arms_meshes_begin, 0xFF68350D),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f19 - arms_meshes_begin, 0xFF212839),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f20 - arms_meshes_begin, 0xFF5E6B67),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f21 - arms_meshes_begin, 0xFFA58A08),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_f - arms_meshes_begin, 0xFF54211E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_b - arms_meshes_begin, 0xFFD6CBBD),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_c - arms_meshes_begin, 0xFF633039),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_a - arms_meshes_begin, 0xFF31668E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_d - arms_meshes_begin, 0xFF426D31),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_e - arms_meshes_begin, 0xFFC5A84C),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_a - arms_meshes_begin, 0xFF212221),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_b - arms_meshes_begin, 0xFF212221),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_c - arms_meshes_begin, 0xFF2D3804),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_d - arms_meshes_begin, 0xFFBDBEBD),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_e - arms_meshes_begin, 0xFF394608),
            
            # Secondary colors
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a01 - arms_meshes_begin + arms_meshes_end, 0xFF23110A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a02 - arms_meshes_begin + arms_meshes_end, 0xFF33565D),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a03 - arms_meshes_begin + arms_meshes_end, 0xFFBABAAF),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a04 - arms_meshes_begin + arms_meshes_end, 0xFF2E280A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a05 - arms_meshes_begin + arms_meshes_end, 0xFFBDB618),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a06 - arms_meshes_begin + arms_meshes_end, 0xFF364973),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a07 - arms_meshes_begin + arms_meshes_end, 0xFF7B3429),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a08 - arms_meshes_begin + arms_meshes_end, 0xFFB5A629),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a09 - arms_meshes_begin + arms_meshes_end, 0xFF962221),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a10 - arms_meshes_begin + arms_meshes_end, 0xFFA5A69C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a11 - arms_meshes_begin + arms_meshes_end, 0xFF8C3029),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a12 - arms_meshes_begin + arms_meshes_end, 0xFF181408),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a13 - arms_meshes_begin + arms_meshes_end, 0xFF0A0A05),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a14 - arms_meshes_begin + arms_meshes_end, 0xFF752D29),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a15 - arms_meshes_begin + arms_meshes_end, 0xFF8C2929),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a16 - arms_meshes_begin + arms_meshes_end, 0xFF3C4989),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a17 - arms_meshes_begin + arms_meshes_end, 0xFF3E612B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a18 - arms_meshes_begin + arms_meshes_end, 0xFF212021),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a19 - arms_meshes_begin + arms_meshes_end, 0xFF232523),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a20 - arms_meshes_begin + arms_meshes_end, 0xFFCBCBC0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_a21 - arms_meshes_begin + arms_meshes_end, 0xFF8C8639),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b01 - arms_meshes_begin + arms_meshes_end, 0xFF844D36),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b02 - arms_meshes_begin + arms_meshes_end, 0xFF4A456B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b03 - arms_meshes_begin + arms_meshes_end, 0xFF843421),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b04 - arms_meshes_begin + arms_meshes_end, 0xFF813426),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b05 - arms_meshes_begin + arms_meshes_end, 0xFF788731),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b06 - arms_meshes_begin + arms_meshes_end, 0xFF527939),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b07 - arms_meshes_begin + arms_meshes_end, 0xFFBAB6AA),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b08 - arms_meshes_begin + arms_meshes_end, 0xFF525D10),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b09 - arms_meshes_begin + arms_meshes_end, 0xFFC6B6A5),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b10 - arms_meshes_begin + arms_meshes_end, 0xFF6B1818),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b11 - arms_meshes_begin + arms_meshes_end, 0xFFA53F33),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b12 - arms_meshes_begin + arms_meshes_end, 0xFF9C4139),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b13 - arms_meshes_begin + arms_meshes_end, 0xFF944D39),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b14 - arms_meshes_begin + arms_meshes_end, 0xFF292810),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b15 - arms_meshes_begin + arms_meshes_end, 0xFFAD9618),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b16 - arms_meshes_begin + arms_meshes_end, 0xFFAA503F),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b17 - arms_meshes_begin + arms_meshes_end, 0xFF4C5633),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b18 - arms_meshes_begin + arms_meshes_end, 0xFF2E2A20),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b19 - arms_meshes_begin + arms_meshes_end, 0xFF627184),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b20 - arms_meshes_begin + arms_meshes_end, 0xFF9CA489),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_b21 - arms_meshes_begin + arms_meshes_end, 0xFFBDB6AD),

            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c01 - arms_meshes_begin + arms_meshes_end, 0xFF739B4F),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c02 - arms_meshes_begin + arms_meshes_end, 0xFFBDAD99),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c03 - arms_meshes_begin + arms_meshes_end, 0xFFC6C7BD),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c04 - arms_meshes_begin + arms_meshes_end, 0xFFD3D3CB),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c05 - arms_meshes_begin + arms_meshes_end, 0xFF7B8A42),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c06 - arms_meshes_begin + arms_meshes_end, 0xFF362D1B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c07 - arms_meshes_begin + arms_meshes_end, 0xFF5A4A70),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c08 - arms_meshes_begin + arms_meshes_end, 0xFFD6D3CE),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c09 - arms_meshes_begin + arms_meshes_end, 0xFF393C5A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c10 - arms_meshes_begin + arms_meshes_end, 0xFF6B2C21),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c11 - arms_meshes_begin + arms_meshes_end, 0xFFA59642),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c12 - arms_meshes_begin + arms_meshes_end, 0xFFE1E1DE),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c13 - arms_meshes_begin + arms_meshes_end, 0xFF54365A),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c14 - arms_meshes_begin + arms_meshes_end, 0xFF8C8336),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c15 - arms_meshes_begin + arms_meshes_end, 0xFF425D10),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c16 - arms_meshes_begin + arms_meshes_end, 0xFF683F33),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c17 - arms_meshes_begin + arms_meshes_end, 0xFF753123),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c18 - arms_meshes_begin + arms_meshes_end, 0xFFC6C3BD),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c19 - arms_meshes_begin + arms_meshes_end, 0xFF994D57),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c20 - arms_meshes_begin + arms_meshes_end, 0xFFBABAAF),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_c21 - arms_meshes_begin + arms_meshes_end, 0xFF9C9E94),

            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d01 - arms_meshes_begin + arms_meshes_end, 0xFF150A08),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d02 - arms_meshes_begin + arms_meshes_end, 0xFFC6C7C6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d03 - arms_meshes_begin + arms_meshes_end, 0xFF9F3131),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d04 - arms_meshes_begin + arms_meshes_end, 0xFFA22E2E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d05 - arms_meshes_begin + arms_meshes_end, 0xFF6B3818),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d06 - arms_meshes_begin + arms_meshes_end, 0xFF733021),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d07 - arms_meshes_begin + arms_meshes_end, 0xFFD6D7D6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d08 - arms_meshes_begin + arms_meshes_end, 0xFFBA7D1B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d09 - arms_meshes_begin + arms_meshes_end, 0xFF212021),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d10 - arms_meshes_begin + arms_meshes_end, 0xFF944531),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d11 - arms_meshes_begin + arms_meshes_end, 0xFF211C08),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d12 - arms_meshes_begin + arms_meshes_end, 0xFFE7DFDE),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d13 - arms_meshes_begin + arms_meshes_end, 0xFF833826),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d14 - arms_meshes_begin + arms_meshes_end, 0xFFEFF3EF),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d15 - arms_meshes_begin + arms_meshes_end, 0xFFDEDFDE),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d16 - arms_meshes_begin + arms_meshes_end, 0xFFECEDE4),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d17 - arms_meshes_begin + arms_meshes_end, 0xFF843421),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d18 - arms_meshes_begin + arms_meshes_end, 0xFF181008),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d19 - arms_meshes_begin + arms_meshes_end, 0xFF181918),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d20 - arms_meshes_begin + arms_meshes_end, 0xFF318E7B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_d21 - arms_meshes_begin + arms_meshes_end, 0xFFD6D3D6),

            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e01 - arms_meshes_begin + arms_meshes_end, 0xFF96771D),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e02 - arms_meshes_begin + arms_meshes_end, 0xFF2B2A2B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e03 - arms_meshes_begin + arms_meshes_end, 0xFF4A2863),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e04 - arms_meshes_begin + arms_meshes_end, 0xFF2B2A29),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e05 - arms_meshes_begin + arms_meshes_end, 0xFFBABABA),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e06 - arms_meshes_begin + arms_meshes_end, 0xFF913231),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e07 - arms_meshes_begin + arms_meshes_end, 0xFF4A659C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e08 - arms_meshes_begin + arms_meshes_end, 0xFF5A6D18),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e09 - arms_meshes_begin + arms_meshes_end, 0xFFA58629),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e10 - arms_meshes_begin + arms_meshes_end, 0xFF3C4780),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e11 - arms_meshes_begin + arms_meshes_end, 0xFFC6C7C6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e12 - arms_meshes_begin + arms_meshes_end, 0xFFD0D0D0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e13 - arms_meshes_begin + arms_meshes_end, 0xFF8C4241),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e14 - arms_meshes_begin + arms_meshes_end, 0xFFA55542),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e15 - arms_meshes_begin + arms_meshes_end, 0xFFCECBC6),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e16 - arms_meshes_begin + arms_meshes_end, 0xFF31558C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e17 - arms_meshes_begin + arms_meshes_end, 0xFFC8C918),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e18 - arms_meshes_begin + arms_meshes_end, 0xFF844131),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e19 - arms_meshes_begin + arms_meshes_end, 0xFF732C21),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e20 - arms_meshes_begin + arms_meshes_end, 0xFFB78905),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_e21 - arms_meshes_begin + arms_meshes_end, 0xFF841808),

            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f01 - arms_meshes_begin + arms_meshes_end, 0xFF180D00),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f02 - arms_meshes_begin + arms_meshes_end, 0xFF332E29),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f03 - arms_meshes_begin + arms_meshes_end, 0xFF948C35),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f04 - arms_meshes_begin + arms_meshes_end, 0xFFB1880C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f05 - arms_meshes_begin + arms_meshes_end, 0xFF652A12),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f06 - arms_meshes_begin + arms_meshes_end, 0xFF845500),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f07 - arms_meshes_begin + arms_meshes_end, 0xFFC5C58B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f08 - arms_meshes_begin + arms_meshes_end, 0xFFC0B889),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f09 - arms_meshes_begin + arms_meshes_end, 0xFF946B28),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f10 - arms_meshes_begin + arms_meshes_end, 0xFF213400),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f11 - arms_meshes_begin + arms_meshes_end, 0xFF573500),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f12 - arms_meshes_begin + arms_meshes_end, 0xFFBDC1C0),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f13 - arms_meshes_begin + arms_meshes_end, 0xFF3F0908),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f14 - arms_meshes_begin + arms_meshes_end, 0xFF210829),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f15 - arms_meshes_begin + arms_meshes_end, 0xFFB59452),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f16 - arms_meshes_begin + arms_meshes_end, 0xFF3C7391),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f17 - arms_meshes_begin + arms_meshes_end, 0xFFACA331),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f18 - arms_meshes_begin + arms_meshes_end, 0xFFBBB283),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f19 - arms_meshes_begin + arms_meshes_end, 0xFFA48310),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f20 - arms_meshes_begin + arms_meshes_end, 0xFF26291E),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_f21 - arms_meshes_begin + arms_meshes_end, 0xFF561E08),
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_f - arms_meshes_begin + arms_meshes_end, 0xFF080202),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_b - arms_meshes_begin + arms_meshes_end, 0xFF442A1B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_c - arms_meshes_begin + arms_meshes_end, 0xFFD0A03C),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_a - arms_meshes_begin + arms_meshes_end, 0xFF05090D),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_d - arms_meshes_begin + arms_meshes_end, 0xFF050A05),
            (troop_set_slot, "trp_banner_background_color_array", mesh_arms_kingdom_e - arms_meshes_begin + arms_meshes_end, 0xFF7B2D0D), 
            
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_a - arms_meshes_begin + arms_meshes_end, 0xFF524F14),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_b - arms_meshes_begin + arms_meshes_end, 0xFF60240D),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_c - arms_meshes_begin + arms_meshes_end, 0xFF8C7D18),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_d - arms_meshes_begin + arms_meshes_end, 0xFF415B7B),
            (troop_set_slot, "trp_banner_background_color_array", mesh_banners_default_e - arms_meshes_begin + arms_meshes_end, 0xFF703002),
        ]),
    
    # script_test_spawn_team_members
    # input: 
    #   arg1: team
    #   arg2: spawn_point
    # output: none
    ("test_spawn_team_members",
        [
            (store_script_param, ":team_no", 1),
            (store_script_param, ":spawn_point", 2),
            
            (call_script, "script_test_spawn_team_members_siege", ":team_no", ":spawn_point"),
        ]),
    
    # script_test_spawn_team_members_siege
    # input:
    #   arg1: team
    #   arg2: spawn_point
    # output: none
    ("test_spawn_team_members_siege",
        [
            (store_script_param, ":team_no", 1),
            (store_script_param, ":spawn_point", 2),
            
            (store_current_scene, ":cur_scene"),
            (modify_visitors_at_site, ":cur_scene"),
            
            (team_get_slot, ":faction_strength_bonus", ":team_no", slot_team_test_strength),
            (try_begin),
                (gt, ":faction_strength_bonus", -10),
                (team_get_slot, ":faction", ":team_no", slot_team_test_faction),
                (party_clear, "p_temp_party"),
                (party_set_faction, "p_temp_party", ":faction"),
                # (call_script, "script_party_add_reinforcements", "p_temp_party"),
                (call_script, "script_party_add_reinforcements", "p_temp_party"),
                
                (party_get_num_companion_stacks, ":num_stacks", "p_temp_party"),
                (try_for_range, ":i_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", "p_temp_party", ":i_stack"),
                    (party_stack_get_size, ":num_troops", "p_temp_party", ":i_stack"),
                    (add_visitors_to_current_scene, ":spawn_point", ":troop_id", ":num_troops"),
                (try_end),
                
                (party_set_faction, "p_temp_party", "fac_commoners"),
            (try_end),
        ]),
    
    # script_agent_reassign_division
    # input:
    #   arg1: agent_no
    #   arg2: no_reinforcement_group, don't use reinforcements groups
    # output:
    #   reg0: division
    ("agent_reassign_division",
        [
            (store_script_param, ":agent_no", 1),
            (store_script_param, ":no_reinforcement_group", 2),
            
            (assign, ":new_div", -1),
            
            (agent_get_team, ":team", ":agent_no"),
            (try_begin),
                (agent_slot_eq, ":agent_no", slot_agent_charge, 1),
                (assign, ":new_div", grc_charge_group),
            (else_try),
                (agent_get_horse, ":horse", ":agent_no"),
                (agent_get_ammo, ":ammo", ":agent_no", 0),
                
                (assign, ":has_ranged", 0),
                # 2 Is xbow/bow 1 is throwing
                (assign, ":has_shield", 0),
                (try_for_range, ":i_slot", ek_item_0, ek_head),
                    (agent_get_item_slot, ":item", ":agent_no", ":i_slot"),
                    (gt, ":item", 0),
                    (item_get_type, ":item_type", ":item"),
                    (try_begin),
                        (is_between, ":item", "itm_darts", "itm_hunting_bow"),
                        (lt, ":has_ranged", 1),
                        (assign, ":has_ranged", 1),
                    (else_try),
                        (is_between, ":item", "itm_hunting_bow", "itm_items_end"),
                        (try_begin),
                            # Long bow not usable on horse
                            (this_or_next|is_between, ":item", "itm_long_bow", "itm_war_bow"),
                            # Heavy crossbows not usable on horse
                            (is_between, ":item", "itm_crossbow", "itm_items_end"),
                            (lt, ":has_ranged", 2),
                            (assign, ":has_ranged", 2),
                        (else_try),
                            (lt, ":has_ranged", 3),
                            (assign, ":has_ranged", 3),
                        (try_end),
                    (else_try),
                        (is_between, ":item", shields_begin, shields_end),
                        (val_add, ":has_shield", 4),
                    (else_try),
                        (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
                        (this_or_next|eq, ":item_type", itp_type_polearm), # We consider all polearms to be usable with a shield, even if it's false
                        # Following is because 1h/2h weapons are considered 2h weapons and would not enter the previous check
                        (this_or_next|eq, ":item", "itm_morningstar"),
                        (this_or_next|eq, ":item", "itm_fighting_axe"),
                        (this_or_next|eq, ":item", "itm_club_with_spike_head"),
                        (is_between, ":item", "itm_bastard_sword_a", "itm_sword_of_war"), # Bastard swords
                        (val_add, ":has_shield", 1),
                    (try_end),
                (try_end),
                
                (try_begin),
                    (agent_slot_eq, ":agent_no", slot_agent_is_reinforcement, 1),
                    (eq, ":no_reinforcement_group", 0),
                    (try_begin),
                        (gt, ":horse", 0),
                        (assign, ":new_div", grc_reinforcement_cavalry),
                    (else_try),
                        (gt, ":has_ranged", 1), # Bows/xbows
                        (gt, ":ammo", 0),
                        (assign, ":new_div", grc_reinforcement_archer),
                    (else_try),
                        (try_begin),
                        #     (agent_get_division, ":old_div", ":agent_no"),
                        #     (eq, ":old_div", grc_reinforcement_archer),
                        #     (agent_set_slot, ":agent_no", slot_agent_is_reinforcement, 0),
                        # (else_try),
                            (assign, ":new_div", grc_reinforcement_infantry),
                        (try_end),
                    (try_end),
                    (ge, ":new_div", 0),
                (else_try),
                    (try_begin),
                        (gt, ":horse", 0),
                        (assign, ":break", 0),
                        (try_begin),
                            # Horse archer
                            (this_or_next|eq, ":has_ranged", 1), # Throw
                            (eq, ":has_ranged", 3), # Bows/Light xbows
                            (gt, ":ammo", 0),
                            (assign, ":break", 1),
                            (team_get_slot, ":harcher_division", ":team", slot_team_harcher_division),
                            (ge, ":harcher_division", 0),
                            (assign, ":new_div", ":harcher_division"),
                        (else_try),
                            # Horseman
                            (assign, ":break", 1),
                            (team_get_slot, ":horse_division", ":team", slot_team_horse_division),
                            (ge, ":horse_division", 0),
                            (assign, ":new_div", ":horse_division"),
                        (try_end),
                        (eq, ":break", 1),
                    (else_try),
                        (gt, ":ammo", 0),
                        (assign, ":break", 0),
                        (try_begin),
                            (ge, ":has_ranged", 2),
                            (assign, ":break", 1),
                            (team_get_slot, ":archer_division", ":team", slot_team_archer_division),
                            (ge, ":archer_division", 0),
                            (assign, ":new_div", ":archer_division"),
                        (else_try),
                            (eq, ":has_ranged", 1),
                            (assign, ":break", 1),
                            (team_get_slot, ":throw_division", ":team", slot_team_throw_division),
                            (ge, ":throw_division", 0),
                            (assign, ":new_div", ":throw_division"),
                        (try_end),
                        (eq, ":break", 1),
                        # Division assigned, break
                    (else_try),
                        (ge, ":has_shield", 5), # Needs a shield (4) plus a 1h weapon/polearm (1)
                        (team_get_slot, ":shield_division", ":team", slot_team_shield_division),
                        (ge, ":shield_division", 0),
                        (assign, ":new_div", ":shield_division"),
                    (else_try),
                        (team_get_slot, ":rest_division", ":team", slot_team_rest_division),
                        (assign, ":new_div", ":rest_division"),
                    (try_end),
                (try_end),
            (try_end),
            
            (try_begin),
                (is_between, ":new_div", 0, 9),
                (agent_get_division, ":old_div", ":agent_no"),
                (neq, ":new_div", ":old_div"),
                (agent_set_division, ":agent_no", ":new_div"),
                (agent_set_slot, ":agent_no", slot_agent_new_division, ":new_div"),
            (try_end),
            (assign, reg0, ":new_div"),
        ]),
    
    # script_agent_reassign_division_siege
    # input:
    #   arg1: agent_no
    # output: none
    ("agent_reassign_division_siege",
        [
            (store_script_param, ":agent_no", 1),
            
            (agent_get_team, ":team", ":agent_no"),
            (try_begin),
                (eq, ":team", 0),
                (agent_get_division, ":division", ":agent_no"),
                (agent_get_ammo, ":ammo", ":agent_no", 0),
                
                (try_begin),
                    (eq, ":division", grc_archers),
                    (this_or_next|le, ":ammo", 1),
                    (agent_slot_eq, ":agent_no", slot_agent_forced_defend, 1),
                    (call_script, "script_scene_get_defend_points_range"),
                    (assign, ":begin", reg0),
                    (assign, ":end", reg1),
                    (store_random_in_range, ":rand", ":begin", ":end"),
                    (store_sub, ":division", ":rand", ":begin"),
                    (val_add, ":division", 2),
                    (agent_set_slot, ":agent_no", slot_agent_new_division, ":division"),
                    (agent_set_division, ":agent_no", ":division"),
                (else_try),
                    (neq, ":division", grc_archers),
                    (neg|agent_slot_eq, ":agent_no", slot_agent_forced_defend, 1),
                    (gt, ":ammo", 1),
                    
                    (agent_set_slot, ":agent_no", slot_agent_is_reinforcement, 0),
                    (call_script, "script_agent_reassign_division", ":agent_no", 1),
                    (try_begin),
                        (eq, reg0, grc_infantry),
                        (agent_set_slot, ":agent_no", slot_agent_new_division, ":division"),
                        (agent_set_division, ":agent_no", ":division"),
                        (agent_set_slot, ":agent_no", slot_agent_is_reinforcement, 0),
                    (else_try),
                        (agent_set_slot, ":agent_no", slot_agent_is_reinforcement, 1),
                    (try_end),
                    # (agent_set_slot, ":agent_no", slot_agent_new_division, grc_archers),
                    # (agent_set_division, ":agent_no", grc_archers),

                    (agent_set_slot, ":agent_no", slot_agent_target_entry_point, 0),
                    (agent_set_slot, ":agent_no", slot_agent_is_in_scripted_mode, 0),
                (try_end),
            (else_try),
                (call_script, "script_agent_reassign_division", ":agent_no", 1),
            (try_end),
        ]),
    
    # script_spawn_new_center_around_party
    # input:
    #   arg1: party_no
    #   arg2: spawn_type
    # Last argument is referring to what has caused the center to spawn
    # is it a revolted group of peasant, or is it an overpopulated center that sent them to make a village for raw materials
    # Is currently unused and may never be
    # output: new_party_id
    ("spawn_new_center_around_party",
        [
            (store_script_param, ":party_no", 1),
            # (store_script_param, ":spawn_type", 2),
            
            (store_faction_of_party, ":faction_no", ":party_no"),
            
            (assign, ":template", "pt_village_template"),
            # (faction_get_slot, ":template", ":faction_no", slot_faction_village_template),
            
            (spawn_around_party, ":party_no", ":template"),
            (assign, ":new_party_id", reg0),
            
            (party_set_faction, ":new_party_id", ":faction_no"),
            
            (party_set_slot, ":new_party_id", slot_party_type, spt_village),

            (call_script, "script_party_init_center", ":new_party_id"),
            
            (call_script, "script_party_transfer_to_party", ":party_no", ":new_party_id"),
            
        ]),
    
    # script_party_init_center
    # input:
    #   arg1: party_no
    # output; none
    ("party_init_center",
        [
            (store_script_param, ":party_no", 1),
            
            (party_set_slot, ":party_no", slot_party_ressource_radius, 3),
            
            (try_for_range, ":ressource", slot_party_ressources_begin, slot_party_ressources_end),
                (party_set_slot, ":party_no", ":ressource", 0),
            (try_end),
            
            (call_script, "script_party_update_nearby_resources", ":party_no"),
            
            (party_set_slot, ":party_no", slot_party_wealth, 0),
            (party_set_slot, ":party_no", slot_party_prosperity, 50),
            
            (party_set_slot, ":party_no", slot_party_lord, -1),
            (party_set_slot, ":party_no", slot_party_governor, -1),
            (party_set_slot, ":party_no", slot_party_reserved, -1),
            
            (party_set_slot, ":party_no", slot_party_besieged_by, -1),
            
            (party_set_slot, ":party_no", slot_party_player_wages_limit, -1),

            (party_set_slot, ":party_no", slot_party_autosort_options, autosort_low_level_first|autosort_foreign_first),

            (party_set_slot, ":party_no", slot_party_max_prisoner_ratio, 25),
            (party_set_slot, ":party_no", slot_party_max_prisoner_outcome, mpo_default),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (eq, ":party_type", spt_village),
                (party_set_slot, ":party_no", slot_party_population_noble, population_max_village * population_growth_village_noble / 100),
                (party_set_slot, ":party_no", slot_party_population_artisan, population_max_village * population_growth_village_artisan / 100),
                (party_set_slot, ":party_no", slot_party_population, population_max_village * population_growth_village_serf / 100),
                (party_set_slot, ":party_no", slot_party_population_slave, 0),
            
                (party_set_slot, ":party_no", slot_party_population_max, population_max_village),

                (party_set_slot, ":party_no", slot_party_taxes_fixed, default_fixed_tax_rate_village),
                (party_set_slot, ":party_no", slot_party_taxes_buy, default_buy_tax_rate_village),
                (party_set_slot, ":party_no", slot_party_taxes_sell, default_sell_tax_rate_village),

                (party_set_slot, ":party_no", slot_party_player_garrison_flags, pgf_default_village_mask),
            (else_try),
                (eq, ":party_type", spt_castle),
                (party_set_slot, ":party_no", slot_party_population_noble, population_max_castle * population_growth_castle_noble / 100),
                (party_set_slot, ":party_no", slot_party_population_artisan, population_max_castle * population_growth_castle_artisan / 100),
                (party_set_slot, ":party_no", slot_party_population, population_max_castle * population_growth_castle_serf / 100),
                (party_set_slot, ":party_no", slot_party_population_slave, 0),
            
                (party_set_slot, ":party_no", slot_party_population_max, population_max_castle),

                (party_set_slot, ":party_no", slot_party_taxes_fixed, default_fixed_tax_rate_castle),
                (party_set_slot, ":party_no", slot_party_taxes_buy, default_buy_tax_rate_castle),
                (party_set_slot, ":party_no", slot_party_taxes_sell, default_sell_tax_rate_castle),

                (party_set_slot, ":party_no", slot_party_player_garrison_flags, pgf_default_castle_mask),
            (else_try),
                (party_set_slot, ":party_no", slot_party_population_noble, population_max_town * population_growth_town_noble / 100),
                (party_set_slot, ":party_no", slot_party_population_artisan, population_max_town * population_growth_town_artisan / 100),
                (party_set_slot, ":party_no", slot_party_population, population_max_town * population_growth_town_serf / 100),
                (party_set_slot, ":party_no", slot_party_population_slave, 0),
            
                (party_set_slot, ":party_no", slot_party_population_max, population_max_town),

                (party_set_slot, ":party_no", slot_party_taxes_fixed, default_fixed_tax_rate_town),
                (party_set_slot, ":party_no", slot_party_taxes_buy, default_buy_tax_rate_town),
                (party_set_slot, ":party_no", slot_party_taxes_sell, default_sell_tax_rate_town),

                (party_set_slot, ":party_no", slot_party_player_garrison_flags, pgf_default_town_mask),
            (try_end),

            (party_set_slot, ":party_no", slot_party_taxes_visit, 20),

            (try_for_range, ":unused", 0, 12),
                (call_script, "script_party_process_ressources", ":party_no"),
                (call_script, "script_party_process_production", ":party_no"),
                (call_script, "script_party_process_population", ":party_no"),
                (call_script, "script_party_process_taxes", ":party_no"),
            (try_end),
            (call_script, "script_party_process_ideal_party_wages", ":party_no"),
            
            (call_script, "script_party_get_siege_scene", ":party_no"),
            (assign, ":siege_scene", reg0),
            (party_set_slot, ":party_no", slot_party_siege_scene, ":siege_scene"),
        ]),
    
    # script_party_get_siege_scene
    # input:
    #   arg1: party_no
    # output:
    #   reg0: scene
    ("party_get_siege_scene",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_current_terrain, ":terrain", ":party_no"),
            (assign, ":scene", -1),

            (party_get_slot, ":original_faction", ":party_no", slot_party_original_faction),
            (assign, ":culture", -1),
            (try_begin),
                (is_between, ":original_faction", kingdoms_begin, kingdoms_end),
                (faction_get_slot, ":culture", ":original_faction", slot_faction_culture),
            (try_end),

            (assign, ":start", castle_scene_begin),
            (assign, ":finish", castle_scene_end),
            
            (try_begin),
                (eq, ":terrain", rt_plain),
                (try_begin),
                    (eq, ":culture", "fac_culture_5"),
                    (assign, ":start", castle_scene_plain_wood_begin),
                    (assign, ":finish", castle_scene_plain_dark_end),
                (else_try),
                    (assign, ":start", castle_scene_plain_begin),
                    (assign, ":finish", castle_scene_plain_wood_end),
                (try_end),
            (else_try),
                (eq, ":terrain", rt_forest),
                    (assign, ":start", castle_scene_plain_wood_begin),
                    (assign, ":finish", castle_scene_plain_wood_end),
            (else_try),
                (eq, ":terrain", rt_steppe),
                    (assign, ":start", castle_scene_steppe_begin),
                    (assign, ":finish", castle_scene_steppe_wood_end),
            (else_try),
                (eq, ":terrain", rt_steppe_forest),
                    (assign, ":start", castle_scene_steppe_wood_begin),
                    (assign, ":finish", castle_scene_steppe_wood_end),
            (else_try),
                (this_or_next|eq, ":terrain", rt_desert),
                (eq, ":terrain", rt_desert_forest),
                    (assign, ":start", castle_scene_desert_begin),
                    (assign, ":finish", castle_scene_desert_end),
            (else_try),
                (eq, ":terrain", rt_snow),
                    (assign, ":start", castle_scene_snow_begin),
                    (assign, ":finish", castle_scene_snow_wood_end),
            (else_try),
                (eq, ":terrain", rt_snow_forest),
                    (assign, ":start", castle_scene_snow_wood_begin),
                    (assign, ":finish", castle_scene_snow_wood_end),
            (else_try),
                    (assign, ":start", castle_scene_plain_begin),
                    (assign, ":finish", castle_scene_plain_wood_end),
            (try_end),

            (store_random_in_range, ":scene", ":start", ":finish"),
            (try_begin),
                (scene_slot_eq, ":scene", slot_scene_enabled, 0),
                (assign, ":end", 100),
                (try_for_range, ":unused", 0, ":end"),
                    (val_add, ":scene", 1),
                    (try_begin),
                        (ge, ":scene", ":finish"),
                        (assign, ":scene", ":start"),
                    (try_end),
                    (scene_slot_eq, ":scene", slot_scene_enabled, 1),
                    (assign, ":end", 0),
                (try_end),
            (try_end),

            (assign, reg0, ":scene"),
        ]),
    
    # script_party_update_nearby_resources
    # input:
    #   arg1: party_no
    # output: none
    ("party_update_nearby_resources",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_position, pos10, ":party_no"),
            (copy_position, pos11, pos10),
            
            (position_get_x, ":pos_init_x", pos10),
            (position_get_y, ":pos_init_y", pos10),
            # (position_get_z, ":pos_init_z", pos10),
            
            (call_script, "script_party_get_resources_radius", ":party_no"),
            (assign, ":radius", reg0),
            
            (try_for_range, ":range", 0, ":radius"),
                (store_add, ":effective_range", ":range", 1),
                (try_for_range, ":mult1", -1, 2),
                    (try_for_range, ":mult2", -1, 2),
                        (copy_position, pos11, pos10),
                        
                        (store_mul, ":x_offset", ":mult1", ressource_gathering_pace),
                        (store_mul, ":y_offset", ":mult2", ressource_gathering_pace),
                        (val_mul, ":x_offset", ":effective_range"),
                        (val_mul, ":y_offset", ":effective_range"),
                        (store_add, ":pos_x", ":x_offset", ":pos_init_x"),
                        (store_add, ":pos_y", ":y_offset", ":pos_init_y"),
                        
                        (position_set_x, pos11, ":pos_x"),
                        (position_set_y, pos11, ":pos_y"),
                        
                        (party_set_position, "p_resources_party", pos11),
                        
                        (party_get_current_terrain, ":terrain_type", "p_resources_party"),
                        
                        (party_get_position, pos11, "p_resources_party"),
                        (position_get_z, ":height", pos11),
                        
                        (call_script, "script_party_update_resources_slot_with_terrain_and_height", ":party_no", ":terrain_type", ":height", ":radius"),
                    (try_end),
                (try_end),
            (try_end),
            (call_script, "script_party_update_resources_slot_with_weather", ":party_no"),

            (assign, ":total_res", 0),
            (try_for_range, ":slot", slot_party_ressources_begin, slot_party_ressources_end),
                (party_get_slot, ":num_res", ":party_no", ":slot"),
                (val_add, ":total_res", ":num_res"),
            (try_end),
            (party_set_slot, ":party_no", slot_party_total_resources, ":total_res"),
            
            # (try_for_range, ":ressource", slot_party_ressources_begin, slot_party_ressources_end),
            #     (party_get_slot, reg10, ":party_no", ":ressource"),
            #     (gt, reg10, 0),
            #     (str_store_item_name, s10, ":ressource"),
            #     (str_store_party_name_link, s11, ":party_no"),
            #     (display_log_message, "@Center {s11} has ressource {s10}: {reg10}."),
            # (try_end),
            # (str_store_party_name_link, s11, ":party_no"),
            # (assign, res11, ":total_res"),
            # (display_log_message, "@{s11} has {reg11} resources."),
        ]),
    
    # script_party_get_resources_radius
    # input:
    #   arg1: party_no
    # output:
    #   reg0: resources_radius
    ("party_get_resources_radius",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            
            (assign, ":radius", 1),
            
            (try_begin),
                (eq, ":party_type", spt_town),
                (assign, ":radius", 3),
            (else_try),
                (eq, ":party_type", spt_scout),
                (assign, ":radius", 1),
            (else_try),
                (assign, ":radius", 1),
            (try_end),
            
            (assign, reg0, ":radius"),
        ]),
    
    # script_party_update_resources_slot_with_terrain_and_height
    # input:
    #   arg1: party_no
    #   arg2: terrain_type
    #   arg3: height
    #   arg4: radius
    # output: none
    ("party_update_resources_slot_with_terrain_and_height",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":terrain_type", 2),
            # (store_script_param, ":height", 3),
            (store_script_param, ":radius", 4),

            (val_mul, ":radius", 9),
            
            (try_begin),
                (eq, ":terrain_type", rt_water),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_fish", 10),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_salt", 10),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_oil", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 1000, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, 0, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_mountain),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_iron", 10),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_stone", 10),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_salt", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_clay", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_dyes", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 5),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_sheep", 3),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_apples", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_grapes", 6),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_olives", 1),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, -500, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -1000, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_steppe),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_spice", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_stone", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_clay", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_oil", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_flax", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cattle", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_poultry", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_horse", 4),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cabbages", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_grain", 2),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, -1000, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -200, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_plain),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_flax", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_oil", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_stone", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_honey", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cabbages", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_apples", 5),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_grain", 6),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cattle", 5),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_poultry", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_sheep", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_horse", 2),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                # (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 0, ":radius"),
                # (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, 0, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_snow),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_clay", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 5),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_stone", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cabbages", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_grain", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_sheep", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_horse", 2),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                # (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 0, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -1800, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_desert),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_clay", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_dyes", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_iron", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_date_fruit", 6),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_olives", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cattle", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_poultry", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_horse", 3),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, -2000, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, 2000, ":radius"),
            (else_try),
                (this_or_next|eq, ":terrain_type", rt_bridge),
                (eq, ":terrain_type", rt_river),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_fish", 4),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_cabbages", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_apples", 1),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 2000, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -200, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_mountain_forest),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_iron", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_stone", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_salt", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_dyes", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_silk", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 3),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_grapes", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 5),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 1),

                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 0, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -1200, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_steppe_forest),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_spice", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_oil", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_flax", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_silk", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 4),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_apples", 1),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_horse", 1),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, -500, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -400, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_forest),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_flax", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_oil", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_silk", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 10),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_apples", 2),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 3),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 500, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -200, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_snow_forest),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wool", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_silk", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 3),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_furs", 8),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 12),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_goat", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 6),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, 500, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, -2000, ":radius"),
            (else_try),
                (eq, ":terrain_type", rt_desert_forest),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_dyes", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_silk", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_leather", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_date_fruit", 10),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_wood", 3),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_grapes", 2),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_raw_olives", 2),

                (call_script, "script_party_update_resources_slot", ":party_no", "itm_pig", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_sheep", 1),
                (call_script, "script_party_update_resources_slot", ":party_no", "itm_venison", 2),
                # (call_script, "script_party_update_resources_slot", ":party_no", "itm_", 1),
                
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_wet, -1000, ":radius"),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, 1500, ":radius"),
            (try_end),

            (try_begin),
                (party_get_position, pos1, ":party_no"),
                (position_get_y, ":y", pos1),
                (val_div, ":y", -100),
                (position_get_x, ":x", pos1),
                (val_div, ":x", 1000),
                (val_add, ":x", 300),
                (val_div, ":x", 5),
                (val_max, ":x", 30),
                (store_mul, ":position_heat", ":y", ":x"),
                (val_div, ":position_heat", 100),
                (call_script, "script_party_update_weather_slot", ":party_no", slot_party_weather_heat, ":position_heat", 1),
            (try_end),
        ]),

    # script_party_update_resources_slot_with_weather
    # input:
    #   arg1: party_no
    # output: none
    ("party_update_resources_slot_with_weather",
        [
            # (store_script_param, ":party_no", 1),

            # (party_get_slot, ":weather_heat", ":party_no", slot_party_weather_heat),
            # (party_get_slot, ":weather_wet", ":party_no", slot_party_weather_wet),

            # (store_sub, ":offset", slot_party_ressources_current_amount_begin, slot_party_ressources_begin),
            # (try_begin),
            #     (store_add, ":slot", "itm_apples", ":offset"),
            #     (party_slot_ge, ":party_no", ":slot", 1),
            # (try_end),
        ]),
    
    # script_party_update_resources_slot
    # input:
    #   arg1: party_no
    #   arg2: resource
    #   arg3: value
    # output: none
    ("party_update_resources_slot",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":resource", 2),
            (store_script_param, ":value", 3),
            
            (try_begin),
                (is_between, ":resource", goods_begin, goods_end),
                (assign, ":resource_slot", ":resource"),
                (party_get_slot, ":current_resources", ":party_no", ":resource_slot"),
                (val_add, ":current_resources", ":value"),
                (party_set_slot, ":party_no", ":resource_slot", ":current_resources"),
            (else_try),
                (call_script, "script_cf_debug", debug_simple|debug_current),
                (display_message, "@Attempting incorrect modification of item {s10} resource slot", text_color_impossible),
            (try_end),
        ]),
    
    # script_party_update_weather_slot
        # input:
        #   arg1: party_no
        #   arg2: slot
        #   arg3: value
        # output: none
    ("party_update_weather_slot",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":slot", 2),
            (store_script_param, ":value", 3),
            (store_script_param, ":radius", 4),
            
            (party_get_slot, ":current_weather", ":party_no", ":slot"),
            (store_div, ":modified_value", ":value", ":radius"),
            (val_add, ":current_weather", ":modified_value"),
            (party_set_slot, ":party_no", ":slot", ":current_weather"),
        ]),
    
    # script_party_transfer_to_party
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        # output: none
    ("party_transfer_to_party",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            
            (party_get_slot, ":party_to_transfer_wealth", ":party_to_transfer", slot_party_wealth),
            (party_get_slot, ":receiving_party_wealth", ":receiving_party", slot_party_wealth),
            (val_add, ":receiving_party_wealth", ":party_to_transfer_wealth"),
            
            (party_set_slot, ":receiving_party", slot_party_wealth, ":receiving_party_wealth"),
            
            (try_begin),
                (party_slot_ge, ":receiving_party", slot_party_type, spt_village),
                (party_get_slot, ":population_to_transfer", ":party_to_transfer", slot_party_population),
                (party_get_slot, ":party_population", ":receiving_party", slot_party_population),
                (val_add, ":party_population", ":population_to_transfer"),
                (party_set_slot, ":receiving_party", slot_party_population, ":party_population"),
            (try_end),
            
            (call_script, "script_party_transfer_members_to_party", ":party_to_transfer", ":receiving_party", 1),
        ]),
    
    # script_party_group_transfer_members_to_party
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_group_transfer_members_to_party",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_to_transfer"),
            (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":party_to_transfer", ":attached_party_rank"),
                (call_script, "script_party_transfer_members_to_party", ":attached_party", ":receiving_party", ":move_heroes"),
            (try_end),
            (call_script, "script_party_transfer_members_to_party", ":party_to_transfer", ":receiving_party", ":move_heroes"),
        ]),
    
    # script_party_transfer_members_to_party
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_transfer_members_to_party",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),
            
            (party_get_num_companion_stacks, ":num_stacks", ":party_to_transfer"),
            
            (try_for_range_backwards, ":i_stack", 0, ":num_stacks"),
                (assign, ":continue", 1),
                (party_stack_get_size, ":i_stack_size", ":party_to_transfer", ":i_stack"),
                (party_stack_get_troop_id, ":troop_id", ":party_to_transfer", ":i_stack"),
                (try_begin),
                    (eq, ":move_heroes", 0),
                    (troop_is_hero, ":troop_id"),
                    (assign, ":continue", 0),
                (try_end),
                (eq, ":continue", 1),
                (party_add_members, ":receiving_party", ":troop_id", ":i_stack_size"),
                (assign, ":really_added", reg0),
                (party_remove_members, ":party_to_transfer", ":troop_id", ":really_added"),
            (try_end),
        ]),

    # script_party_group_transfer_members_to_prisoners
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_group_transfer_members_to_prisoners",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_to_transfer"),
            (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":party_to_transfer", ":attached_party_rank"),
                (call_script, "script_party_transfer_members_to_prisoners", ":attached_party", ":receiving_party", ":move_heroes"),
            (try_end),
            (call_script, "script_party_transfer_members_to_prisoners", ":party_to_transfer", ":receiving_party", ":move_heroes"),
        ]),
    
    # script_party_transfer_members_to_prisoners
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_transfer_members_to_prisoners",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),
            
            (party_get_num_companion_stacks, ":num_stacks", ":party_to_transfer"),
            
            (try_for_range_backwards, ":i_stack", 0, ":num_stacks"),
                (assign, ":continue", 1),
                (party_stack_get_size, ":i_stack_size", ":party_to_transfer", ":i_stack"),
                (party_stack_get_troop_id, ":troop_id", ":party_to_transfer", ":i_stack"),
                (try_begin),
                    (eq, ":move_heroes", 0),
                    (troop_is_hero, ":troop_id"),
                    (assign, ":continue", 0),
                (try_end),
                (eq, ":continue", 1),
                (party_add_prisoners, ":receiving_party", ":troop_id", ":i_stack_size"),
                (assign, ":really_added", reg0),
                (party_remove_members, ":party_to_transfer", ":troop_id", ":really_added"),
            (try_end),
        ]),

    # script_party_group_transfer_prisoners_to_party
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_group_transfer_prisoners_to_party",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_to_transfer"),
            (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":party_to_transfer", ":attached_party_rank"),
                (call_script, "script_party_transfer_prisoners_to_party", ":attached_party", ":receiving_party", ":move_heroes"),
            (try_end),
            (call_script, "script_party_transfer_prisoners_to_party", ":party_to_transfer", ":receiving_party", ":move_heroes"),
        ]),
    
    # script_party_transfer_prisoners_to_party
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_transfer_prisoners_to_party",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),
            
            (party_get_num_prisoner_stacks, ":num_stacks", ":party_to_transfer"),
            
            (try_for_range_backwards, ":i_stack", 0, ":num_stacks"),
                (assign, ":continue", 1),
                (party_prisoner_stack_get_size, ":i_stack_size", ":party_to_transfer", ":i_stack"),
                (party_prisoner_stack_get_troop_id, ":troop_id", ":party_to_transfer", ":i_stack"),
                (try_begin),
                    (eq, ":move_heroes", 0),
                    (troop_is_hero, ":troop_id"),
                    (assign, ":continue", 0),
                (try_end),
                (eq, ":continue", 1),
                (party_add_members, ":receiving_party", ":troop_id", ":i_stack_size"),
                (assign, ":really_added", reg0),
                (party_remove_prisoners, ":party_to_transfer", ":troop_id", ":really_added"),
            (try_end),
        ]),

    # script_party_group_transfer_prisoners_to_prisoners
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_group_transfer_prisoners_to_prisoners",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),

            (party_get_num_attached_parties, ":num_attached_parties", ":party_to_transfer"),
            (try_for_range, ":attached_party_rank", 0, ":num_attached_parties"),
                (party_get_attached_party_with_rank, ":attached_party", ":party_to_transfer", ":attached_party_rank"),
                (call_script, "script_party_transfer_prisoners_to_prisoners", ":attached_party", ":receiving_party", ":move_heroes"),
            (try_end),
            (call_script, "script_party_transfer_prisoners_to_prisoners", ":party_to_transfer", ":receiving_party", ":move_heroes")
        ]),
    
    # script_party_transfer_prisoners_to_prisoners
        # input:
        #   arg1: party_to_transfer
        #   arg2: receiving_party
        #   arg3: move heroes (0 no / 1 yes)
        # output: none
    ("party_transfer_prisoners_to_prisoners",
        [
            (store_script_param, ":party_to_transfer", 1),
            (store_script_param, ":receiving_party", 2),
            (store_script_param, ":move_heroes", 3),
            
            (party_get_num_prisoner_stacks, ":num_stacks", ":party_to_transfer"),
            
            (try_for_range_backwards, ":i_stack", 0, ":num_stacks"),
                (assign, ":continue", 1),
                (party_prisoner_stack_get_size, ":i_stack_size", ":party_to_transfer", ":i_stack"),
                (party_prisoner_stack_get_troop_id, ":troop_id", ":party_to_transfer", ":i_stack"),
                (try_begin),
                    (eq, ":move_heroes", 0),
                    (troop_is_hero, ":troop_id"),
                    (assign, ":continue", 0),
                (try_end),
                (eq, ":continue", 1),
                (party_add_prisoners, ":receiving_party", ":troop_id", ":i_stack_size"),
                (assign, ":really_added", reg0),
                (party_remove_prisoners, ":party_to_transfer", ":troop_id", ":really_added"),
            (try_end),
        ]),

    # script_party_group_process_renown
        # input:
        #   arg1: winner_party
        #   arg2: defeated_party
        #   arg3: allied_party
        # output: none
    ("party_group_process_renown",
        [
            (store_script_param, ":winner_party", 1),
            (store_script_param, ":defeated_party", 2),
            (store_script_param, ":allied_party", 3),

            (call_script, "script_party_group_get_renown_value", ":winner_party"),
            (assign, ":winner_value", reg0),
            (call_script, "script_party_group_get_renown_value", ":defeated_party"),
            (assign, ":defeated_value", reg0),
            (call_script, "script_party_group_get_renown_value", ":allied_party"),
            (assign, ":allied_value", reg0),

            (store_add, ":total_value", ":winner_value", ":defeated_value"),
            (val_add, ":total_value", ":allied_value"),

            (set_fixed_point_multiplier, 1),
            (store_sqrt, ":renown_gain", ":total_value"),

            (store_mul, ":winner_ratio", ":winner_value", 100),
            (val_div, ":winner_ratio", ":total_value"),
            (store_mul, ":defeated_ratio", ":defeated_value", 100),
            (val_div, ":defeated_ratio", ":total_value"),
            (store_mul, ":allied_ratio", ":allied_value", 100),
            (val_div, ":allied_ratio", ":total_value"),

            (store_sub, ":winner_gains", 100, ":winner_ratio"),
            (store_sub, ":defeated_gains", 100, ":defeated_ratio"),
            (store_sub, ":allied_gains", 100, ":allied_ratio"),

            (store_mul, ":winner_share", ":winner_gains", ":renown_gain"),
            (val_div, ":winner_share", 100),
            (store_mul, ":defeated_share", ":defeated_gains", ":renown_gain"),
            (val_div, ":defeated_share", 100),
            (store_mul, ":allied_share", ":allied_gains", ":renown_gain"),
            (val_div, ":allied_share", 100),

            # Defeated party receives less renown
            (val_div, ":defeated_share", 4),

            (call_script, "script_party_group_share_renown", ":winner_party", ":winner_share"),
            (call_script, "script_party_group_share_renown", ":defeated_party", ":defeated_share"),
            (call_script, "script_party_group_share_renown", ":allied_party", ":allied_share"),
        ]),

    # script_party_group_get_renown_value
        # input:
        #   arg1: party_group_no
        # output: 
        #   reg0: total_renown_value
    ("party_group_get_renown_value",
        [
            (store_script_param, ":party_group_no", 1),

            (assign, ":total_value", 0),
            (try_begin),
                (ge, ":party_group_no", 0),

                (call_script, "script_party_get_renown_value", ":party_group_no"),
                (val_add, ":total_value", reg0),

                (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),
                (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                    (call_script, "script_party_group_get_renown_value", ":cur_party"),
                    (val_add, ":total_value", reg0),
                (try_end),
            (try_end),
            (assign, reg0, ":total_value"),
        ]),

    # script_party_get_renown_value
        # input:
        #   arg1: party_no
        # output: 
        #   reg0: renown_value
    ("party_get_renown_value",
        [
            (store_script_param, ":party_no", 1),

            (try_begin),
                (ge, ":party_no", 0),
                (assign, ":total_value", 0),

                (party_get_slot, ":party_type", ":party_no", slot_party_type),
                (try_begin),
                    (eq, ":party_type", spt_village),
                    (val_add, ":total_value", renown_value_village),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (val_add, ":total_value", renown_value_castle),
                (else_try),
                    (eq, ":party_type", spt_town),
                    (val_add, ":total_value", renown_value_town),
                (else_try),
                    (eq, ":party_type", spt_caravan),
                    (val_add, ":total_value", renown_value_caravan),
                (else_try),
                    (eq, ":party_type", spt_patrol),
                    (val_add, ":total_value", renown_value_patrol),
                (else_try),
                    (eq, ":party_type", spt_war_party),
                    (party_get_slot, ":leader", ":party_no", slot_party_leader),
                    (try_begin),
                        (ge, ":leader", 0),
                        (troop_get_slot, ":leader_renown", ":leader", slot_troop_renown),
                        (val_div, ":leader_renown", 2),
                        (val_add, ":total_value", ":leader_renown"),
                        (val_add, ":total_value", 50),
                    (try_end),
                (else_try),
                    (val_add, ":total_value", 20),
                (try_end),
                (assign, reg0, ":total_value"),
            (else_try),
                (assign, reg0, 0),
            (try_end),
        ]),

    # script_party_group_share_renown
    ("party_group_share_renown",
        [
            (store_script_param, ":party_group_no", 1),
            (store_script_param, ":renown_amount", 2),

            (try_begin),
                (ge, ":party_group_no", 0),

                (assign, ":total_value", 0),
                (call_script, "script_party_get_renown_value", ":party_group_no"),
                (assign, ":value", reg0),
                (try_begin),
                    (party_slot_eq, ":party_group_no", slot_party_type, spt_war_party),
                    (party_get_slot, ":leader", ":party_group_no", slot_party_leader),
                    (ge, ":leader", 0),
                    (troop_set_slot, ":leader", slot_troop_temp_slot, ":value"),
                    (val_add, ":total_value", ":value"),
                (try_end),

                (party_get_num_attached_parties, ":num_attached_parties", ":party_group_no"),
                (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),

                    (call_script, "script_party_get_renown_value", ":cur_party"),
                    (assign, ":value", reg0),
                    (party_slot_eq, ":cur_party", slot_party_type, spt_war_party),
                    (party_get_slot, ":leader", ":cur_party", slot_party_leader),
                    (ge, ":leader", 0),
                    (troop_set_slot, ":leader", slot_troop_temp_slot, ":value"),
                    (val_add, ":total_value", ":value"),
                (try_end),

                (try_begin),
                    (party_slot_eq, ":party_group_no", slot_party_type, spt_war_party),
                    (party_get_slot, ":leader", ":party_group_no", slot_party_leader),
                    (ge, ":leader", 0),
                    (troop_get_slot, ":value", ":leader", slot_troop_temp_slot),
                    (gt, ":value", 0),
                    (store_mul, ":renown", ":value", ":renown_amount"),
                    (val_div, ":renown", ":total_value"),
                    (call_script, "script_troop_change_renown", ":leader", ":renown"),
                (try_end),

                (try_for_range, ":cur_party_index", 0, ":num_attached_parties"),
                    (party_get_attached_party_with_rank, ":cur_party", ":party_group_no", ":cur_party_index"),
                    (party_slot_eq, ":cur_party", slot_party_type, spt_war_party),
                    (party_get_slot, ":leader", ":cur_party", slot_party_leader),
                    (ge, ":leader", 0),
                    (troop_get_slot, ":value", ":leader", slot_troop_temp_slot),
                    (gt, ":value", 0),
                    (store_mul, ":renown", ":value", ":renown_amount"),
                    (val_div, ":renown", ":total_value"),
                    (call_script, "script_troop_change_renown", ":leader", ":renown"),
                (try_end),
            (try_end),
        ]),

    # script_cf_party_has_prisoners
        # input:
        #   arg1: party_no
        # output: none
        # fails if party has no prisoners
    ("cf_party_has_prisoners",
        [
            (store_script_param, ":party_no", 1),

            (party_get_num_prisoner_stacks, ":num_stacks", ":party_no"),
            (gt, ":num_stacks", 0),
        ]),

    # script_cf_party_has_members
        # input:
        #   arg1: party_no
        # output: none
        # fails if party has no members
    ("cf_party_has_members",
        [
            (store_script_param, ":party_no", 1),

            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (gt, ":num_stacks", 0),
        ]),
    
    # script_init_battle_ais
    # input: none
    # output: none
    ("init_battle_ais",
        [
            (try_for_range, ":cur_team", 0, 4),
                (team_give_order, ":cur_team", grc_infantry, mordr_stand_closer),
                (team_give_order, ":cur_team", grc_infantry, mordr_stand_closer),
                (team_give_order, ":cur_team", grc_archers, mordr_spread_out),
                
                (team_give_order, ":cur_team", grc_cavalry, mordr_mount),

                (team_give_order, ":cur_team", grc_reinforcement_infantry, mordr_stand_closer),
                
                (team_set_slot, ":cur_team", slot_team_battle_phase, stbp_combat),
                
                (call_script, "script_init_team_battle_ai", ":cur_team"),
            (try_end),
        ]),
    
    # script_init_team_battle_ai
    # input:
    #   arg1: team_no
    # output: none
    ("init_team_battle_ai",
        [
            (store_script_param, ":team_no", 1),
            (try_begin),
                # (store_random_in_range, ":random", 0, 10),
                # (team_get_slot, ":team_main_faction", ":team_no", slot_team_test_faction),
                # ToDo: slot_team_tactic
                # (try_begin),
                    # (eq, ":team_main_faction", "fac_kingdom_1"),
                    # (try_begin),
                        # (le, ":random", 0),
                        # (assign, ":formation", stf_shieldwall),
                    # (else_try),
                        # (le, ":random", 1),
                        # (assign, ":formation", stf_shieldwall),
                    # (else_try),
                        # ToDo: slot_team_formation
                    # (try_end),
                # (else_try),
                    # ToDo: faction
                # (try_end),
                
                (store_random_in_range, ":formation", stf_default, stf_siege),
                # (try_begin),
                #     (eq, ":rand", 0),
                #     (assign, ":formation", stf_shieldwall),
                # (else_try),
                #     (assign, ":formation", stf_archers),
                # (try_end),
                (team_set_slot, ":team_no", slot_team_formation, ":formation"),
                
                (assign, ":tactic", stt_default),
                (store_random_in_range, ":rand", 0, 10),
                (try_begin),
                    (eq, ":rand", 0),
                    (assign, ":tactic", stt_defend),
                # (else_try),
                #     (eq, ":rand", 1),
                #     (assign, ":tactic", stt_defend_skirmish),
                (else_try),
                    (eq, ":rand", 2),
                    (assign, ":tactic", stt_short_engage),
                # (else_try),
                #     (eq, ":rand", 3),
                #     (assign, ":tactic", stt_shieldwall),
                (try_end),
                (team_set_slot, ":team_no", slot_team_tactic, ":tactic"),
                
                (call_script, "script_team_set_division_slots_for_formation", ":team_no", ":formation"),
                
                (team_give_order, ":team_no", grc_charge_group, mordr_charge),
                (team_give_order, ":team_no", grc_cavalry, mordr_mount),
                (team_give_order, ":team_no", grc_reinforcement_cavalry, mordr_mount),
                
                (team_set_slot, ":team_no", slot_team_battle_phase, stbp_deploy),
            (try_end),
        ]),
    
    # script_team_set_division_slots_for_formation
    # input:
    #   arg1: team_no
    #   arg2: formation
    # output: none
    ("team_set_division_slots_for_formation",
        [
            (store_script_param, ":team_no", 1),
            (store_script_param, ":formation", 2),
            
            (try_begin),
                (eq, ":formation", stf_default),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, -1),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_shieldwall),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_other),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_other),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_mounted_skirmisher),
                (team_set_slot, ":team_no", slot_team_harcher_division, grc_other),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_skirmisher),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_thrower),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_other),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_lance),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, -1),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, grc_other),
            (else_try),
                (eq, ":formation", stf_pikewall),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, -1),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, grc_other),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_archers),
                (team_set_slot, ":team_no", slot_team_harcher_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_horse_division, grc_cavalry),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_other),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_siege),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, -1),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (else_try),
                (eq, ":formation", stf_siege_no_throw),
                (team_set_slot, ":team_no", slot_team_harcher_division, -1),
                (team_set_slot, ":team_no", slot_team_horse_division, -1),
                (team_set_slot, ":team_no", slot_team_throw_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_archer_division, grc_archers),
                (team_set_slot, ":team_no", slot_team_shield_division, -1),
                (team_set_slot, ":team_no", slot_team_rest_division, grc_infantry),
                (team_set_slot, ":team_no", slot_team_pike_division, -1),
                (team_set_slot, ":team_no", slot_team_lance_division, -1),
            (try_end),
        ]),

    # script_init_agent
    # input:
    #   arg1: agent_no
    # output: none
    ("init_agent",
        [
            (store_script_param, ":agent_no", 1),
            (agent_set_slot, ":agent_no", slot_agent_is_reinforcement, 1),
            (agent_set_slot, ":agent_no", slot_agent_target_entry_point, 0),
            (agent_set_slot, ":agent_no", slot_agent_is_in_scripted_mode, 0),
        ]),

    # script_process_battle_ais
    # input: none
    # output: none
    ("process_battle_ais",
        [
            (try_for_range, ":cur_team", 0, 4),
                (neq, ":cur_team", "$g_player_team"),
                (call_script, "script_process_team_battle_ai", ":cur_team"),
            (try_end),
        ]),
    
    # script_process_team_battle_ai
    # input:
    #   arg1: team_no
    # output: none
    ("process_team_battle_ai",
        [
            (store_script_param, ":team_no", 1),
            
            # (team_get_slot, ":main_faction", ":team_no", slot_team_test_faction),
            
            (team_get_slot, ":formation", ":team_no", slot_team_formation),
            (team_get_slot, ":tactic", ":team_no", slot_team_tactic),
            
            (team_get_slot, ":battle_phase", ":team_no", slot_team_battle_phase),
            
            (set_show_messages, 0),
            (try_begin),
                (eq, ":battle_phase", stbp_deploy),
                (team_get_slot, ":spawn_point", ":team_no", slot_team_test_spawn_point),
                (entry_point_get_position, pos1, ":spawn_point"),
            (else_try),
                (eq, ":battle_phase", stbp_advance),
                (team_give_order, ":team_no", grc_reinforcement_archer, mordr_advance),
                (team_get_order_position, pos1, ":team_no", grc_reinforcement_archer),
            (else_try),
                (eq, ":battle_phase", stbp_engage),
                (neq, ":tactic", stt_defend),
                (team_give_order, ":team_no", grc_reinforcement_archer, mordr_advance),
                (team_get_order_position, pos1, ":team_no", grc_reinforcement_archer),
            (else_try),
                # (eq, ":battle_phase", stbp_combat),
                (team_get_order_position, pos1, ":team_no", grc_reinforcement_archer),
            (try_end),
            (position_set_z_to_ground_level, pos1), 
            
            (try_begin),
                (neq, ":battle_phase", stbp_combat),
                
                (team_give_order, ":team_no", grc_reinforcement_infantry, mordr_hold),
                (team_give_order, ":team_no", grc_reinforcement_archer, mordr_hold),
                (team_give_order, ":team_no", grc_reinforcement_cavalry, mordr_hold),
                (team_set_order_position, ":team_no", grc_reinforcement_infantry, pos1),
                (team_set_order_position, ":team_no", grc_reinforcement_archer, pos1),
                (team_set_order_position, ":team_no", grc_reinforcement_cavalry, pos1),
                
                (call_script, "script_apply_battle_reinforcements_formation_to_team", ":formation", ":team_no"),
            (try_end),
            
            (try_begin),
                (eq, ":battle_phase", stbp_deploy),

                # We make sure that agents are present in main army before going to next phase
                # Prevents divisions retreating when no reinforcements are coming
                (assign, ":end", 0),
                (try_for_agents, ":agent_no"),
                    (neq, ":end", 1),
                    (agent_is_alive, ":agent_no"),
                    (agent_is_human, ":agent_no"),
                    (agent_get_team, ":agent_team", ":agent_no"),
                    (eq, ":agent_team", ":team_no"),
                    (agent_get_division, ":agent_division", ":agent_no"),
                    (is_between, ":agent_division", grc_reinforcement_infantry, grc_reinforcement_cavalry + 1),
                    (assign, ":end", 1),
                (try_end),

                (try_begin),
                    (eq, ":end", 1),
                    (team_give_order, ":team_no", grc_reinforcement_archer, mordr_hold_fire),
                    (team_set_slot, ":team_no", slot_team_battle_phase, stbp_advance),
                (try_end),
            (else_try),
                (eq, ":battle_phase", stbp_advance),
                (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":team_no"),
                (try_begin),
                    (this_or_next|lt, reg0, 10000),
                    (neq, ":tactic", stt_short_engage),
                    (lt, reg0, 12000),
                    (team_give_order, ":team_no", grc_reinforcement_archer, mordr_fire_at_will),
                    (team_set_slot, ":team_no", slot_team_battle_phase, stbp_engage),
                (try_end),
            (else_try),
                (eq, ":battle_phase", stbp_engage),
                (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":team_no"),
                (try_begin),
                    (this_or_next|lt, reg0, 6000),
                    (neq, ":tactic", stt_short_engage),
                    (lt, reg0, 7000),
                    (try_for_range, ":division", grc_infantry, grc_reinforcement_infantry),
                        (team_get_order_position, pos2, ":team_no", grc_reinforcement_archer),
                        (position_set_z_to_ground_level, pos2),
                        (team_give_order, ":team_no", ":division", mordr_hold),
                        (team_set_order_position, ":team_no", ":division", pos2),
                    (try_end),
                    (team_set_slot, ":team_no", slot_team_battle_phase, stbp_prepare),
                (try_end),
            (else_try),
                (eq, ":battle_phase", stbp_combat),
            (try_end),
            (try_begin),
                (team_get_slot, ":current_phase", ":team_no", slot_team_battle_phase),
                (ge, ":current_phase", stbp_prepare),
                (call_script, "script_process_team_battle_assault_ai", ":team_no"),
            (try_end),
                
            (set_show_messages, 1),
        ]),

    # script_process_team_battle_assault_ai
    # input:
    #   arg1: team_no
    # output: none
    ("process_team_battle_assault_ai",
        [
            (store_script_param, ":team_no", 1),

            (team_get_slot, ":formation", ":team_no", slot_team_formation),
            # (team_get_slot, ":tactic", ":team_no", slot_team_tactic),
            
            (team_get_slot, ":battle_phase", ":team_no", slot_team_battle_phase),

            (try_begin),
                (eq, ":battle_phase", stbp_prepare),

                (assign, ":percentage", 4),
                (store_normalized_team_count, ":team_size", ":team_no"),
                (try_begin),
                    (le, ":team_size", 4),
                    (assign, ":percentage", 10),
                (else_try),
                    (le, ":team_size", 8),
                    (assign, ":percentage", 5),
                (try_end),
                (try_begin),
                    (call_script, "script_cf_debug", debug_simple),
                    (assign, reg10, ":team_no"),
                    (assign, reg11, ":team_size"),
                    (display_message, "@Team {reg11} advances with team size : {reg10}"),
                (try_end),

                (store_sub, ":reinforcements_offset", grc_reinforcement_infantry, grc_infantry),
                (try_for_agents, ":cur_agent"),
                    (agent_is_alive, ":cur_agent"),
                    (agent_is_human, ":cur_agent"),
                    (agent_get_team, ":agent_team", ":cur_agent"),
                    (eq, ":agent_team", ":team_no"),
                    (agent_get_division , ":agent_division", ":cur_agent"),
                    (ge, ":agent_division", grc_reinforcement_infantry),
                    (store_random_in_range, ":rand", 0, 10),
                    (try_begin),
                        (lt, ":rand", ":percentage"),
                        (store_sub, ":new_division", ":agent_division", ":reinforcements_offset"),
                        (try_begin),
                            (gt, ":new_division", grc_cavalry),
                            (assign, ":new_division", grc_infantry),
                        (try_end),
                        (agent_set_division, ":cur_agent", ":new_division"),
                        (agent_set_slot, ":cur_agent", slot_agent_new_division, ":new_division"),
                        (agent_set_slot, ":cur_agent", slot_agent_is_reinforcement, 0),
                    (try_end),
                (try_end),

                (call_script, "script_apply_battle_formation_to_team", ":formation", ":team_no"),
                (team_set_slot, ":team_no", slot_team_battle_phase, stbp_assault),
            (else_try),
                (eq, ":battle_phase", stbp_assault),
                (team_get_movement_order, ":current_order", ":team_no", grc_infantry),

                (try_begin),
                    (eq, ":current_order", mordr_charge),
                    (assign, ":num_charging", 0),
                    (assign, ":has_reinforcements", 0),
                    (try_for_agents, ":cur_agent"),
                        (agent_is_alive, ":cur_agent"),
                        (agent_is_human, ":cur_agent"),
                        (agent_get_team, ":agent_team", ":cur_agent"),
                        (eq, ":agent_team", ":team_no"),
                        (agent_get_division , ":agent_division", ":cur_agent"),
                        (try_begin),
                            (lt, ":agent_division", grc_reinforcement_infantry),
                            (neq, ":agent_division", grc_archers),
                            (val_add, ":num_charging", 1),
                        (else_try),
                            (ge, ":agent_division", grc_reinforcement_infantry),
                            (assign, ":has_reinforcements", 1),
                        (try_end),
                    (try_end),
                    (try_begin),
                        (le, ":num_charging", 10),
                        (eq, ":has_reinforcements", 1),
                        (try_for_range, ":division", grc_infantry, grc_charge_group),
                            (team_get_order_position, pos2, ":team_no", grc_reinforcement_archer),
                            (position_set_z_to_ground_level, pos2),
                            (team_give_order, ":team_no", ":division", mordr_hold),
                            (team_set_order_position, ":team_no", ":division", pos2),
                        (try_end),
                        (team_set_slot, ":team_no", slot_team_battle_phase, stbp_prepare),
                    (try_end),
                (else_try),
                    (team_get_order_position, pos1, ":team_no", grc_infantry),
                    (position_set_z_to_ground_level, pos1),
                    (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":team_no"),
                    (try_begin),
                        (lt, reg0, 2800),
                        (team_give_order, ":team_no", grc_infantry, mordr_charge),
                        (team_give_order, ":team_no", grc_cavalry, mordr_charge),
                    (else_try),
                        (team_give_order, ":team_no", grc_archers, mordr_advance),
                        (call_script, "script_apply_battle_formation_to_team", ":formation", ":team_no"),
                    (try_end),
                (try_end),
            (else_try),
                (eq, ":battle_phase", stbp_combat),
            (try_end),
        ]),
    
    # script_apply_battle_formation_to_team
    # input:
    #   arg1: formation
    #   arg2: team_no
    # output: none
    ("apply_battle_formation_to_team",
        [
            (store_script_param, ":formation", 1),
            (store_script_param, ":team_no", 2),
            (try_begin),
                (eq, ":formation", stf_shieldwall),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                
                (team_give_order, ":team_no", grc_infantry, mordr_advance),
                
                (team_give_order, ":team_no", grc_other, mordr_fall_back),

                (team_give_order, ":team_no", grc_flank, mordr_fall_back),
            (else_try),
                (eq, ":formation", stf_archers),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                
                (team_give_order, ":team_no", grc_infantry, mordr_fall_back),
                
                (team_give_order, ":team_no", grc_other, mordr_fall_back),
                (team_give_order, ":team_no", grc_other, mordr_fall_back),

                (team_give_order, ":team_no", grc_flank, mordr_fall_back),
            (else_try),
                (eq, ":formation", stf_lance),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                
                (team_give_order, ":team_no", grc_infantry, mordr_advance),
                
                (team_give_order, ":team_no", grc_other, mordr_fall_back),
                (team_give_order, ":team_no", grc_other, mordr_fall_back),

                (team_give_order, ":team_no", grc_flank, mordr_fall_back),
            (else_try),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                (team_give_order, ":team_no", grc_cavalry, mordr_fall_back),
                
                (team_give_order, ":team_no", grc_infantry, mordr_advance),
                (team_give_order, ":team_no", grc_infantry, mordr_advance),
                
                (team_give_order, ":team_no", grc_other, mordr_advance),

                (team_give_order, ":team_no", grc_flank, mordr_fall_back),
            (try_end),
        ]),
    # script_apply_battle_reinforcements_formation_to_team
    # input:
    #   arg1: formation
    #   arg2: team_no
    # output: none
    ("apply_battle_reinforcements_formation_to_team",
        [
            # (store_script_param, ":formation", 1),
            (store_script_param, ":team_no", 2),
            
            (team_give_order, ":team_no", grc_reinforcement_cavalry, mordr_fall_back),
            (team_give_order, ":team_no", grc_reinforcement_cavalry, mordr_fall_back),
            (team_give_order, ":team_no", grc_reinforcement_cavalry, mordr_fall_back),
            
            (team_give_order, ":team_no", grc_reinforcement_infantry, mordr_advance),
            (team_give_order, ":team_no", grc_reinforcement_infantry, mordr_advance),
        ]),
    
    # script_team_get_average_position_of_enemies
    # input: 
    #   arg1: team_no
    # output: 
    #   pos0: average position
    ("team_get_average_position_of_enemies",
        [
            (store_script_param_1, ":team_no"),
            (init_position, pos0),
            (assign, ":num_enemies", 0),
            (assign, ":accum_x", 0),
            (assign, ":accum_y", 0),
            (assign, ":accum_z", 0),
            (try_for_agents,":enemy_agent"),
                (agent_is_alive, ":enemy_agent"),
                (agent_is_human, ":enemy_agent"),
                (agent_get_team, ":enemy_team", ":enemy_agent"),
                (teams_are_enemies, ":team_no", ":enemy_team"),
                
                (agent_get_position, pos62, ":enemy_agent"),
                
                (position_get_x, ":x", pos62),
                (position_get_y, ":y", pos62),
                (position_get_z, ":z", pos62),
                
                (val_add, ":accum_x", ":x"),
                (val_add, ":accum_y", ":y"),
                (val_add, ":accum_z", ":z"),
                (val_add, ":num_enemies", 1),
            (try_end),
                
            (try_begin), #to avoid division by zeros in below division part.
                (le, ":num_enemies", 0),
                (assign, ":num_enemies", 1),
            (try_end),
            
            (store_div, ":average_x", ":accum_x", ":num_enemies"),
            (store_div, ":average_y", ":accum_y", ":num_enemies"),
            (store_div, ":average_z", ":accum_z", ":num_enemies"),
            
            (position_set_x, pos0, ":average_x"),
            (position_set_y, pos0, ":average_y"),
            (position_set_z, pos0, ":average_z"),
            
            (assign, reg0, ":num_enemies"),
        ]),
    
    # script_get_closest3_distance_of_enemies_at_pos1
    # input: 
    #   arg1: team_no
    #   pos1
    # output: 
    #   reg0: distance in cms
    ("get_closest3_distance_of_enemies_at_pos1",
        [
            (assign, ":min_distance_1", 100000),
            (assign, ":min_distance_2", 100000),
            (assign, ":min_distance_3", 100000),
            
            (store_script_param, ":team_no", 1),
            (try_for_agents,":cur_agent"),
                (agent_is_alive, ":cur_agent"),
                (agent_is_human, ":cur_agent"),
                (agent_get_team, ":agent_team", ":cur_agent"),
                (teams_are_enemies, ":agent_team", ":team_no"),
                
                (agent_get_position, pos2, ":cur_agent"),
                (get_distance_between_positions,":cur_dist",pos2,pos1),
                (try_begin),
                    (lt, ":cur_dist", ":min_distance_1"),
                    (assign, ":min_distance_3", ":min_distance_2"),
                    (assign, ":min_distance_2", ":min_distance_1"),
                    (assign, ":min_distance_1", ":cur_dist"),
                (else_try),
                    (lt, ":cur_dist", ":min_distance_2"),
                    (assign, ":min_distance_3", ":min_distance_2"),
                    (assign, ":min_distance_2", ":cur_dist"),
                (else_try),
                    (lt, ":cur_dist", ":min_distance_3"),
                    (assign, ":min_distance_3", ":cur_dist"),
                (try_end),
            (try_end),
            
            (assign, ":total_distance", 0),
            (assign, ":total_count", 0),
            (try_begin),
                (lt, ":min_distance_1", 100000),
                (val_add, ":total_distance", ":min_distance_1"),
                (val_add, ":total_count", 1),
            (try_end),
            (try_begin),
                (lt, ":min_distance_2", 100000),
                (val_add, ":total_distance", ":min_distance_2"),
                (val_add, ":total_count", 1),
            (try_end),
            (try_begin),
                (lt, ":min_distance_3", 100000),
                (val_add, ":total_distance", ":min_distance_3"),
                (val_add, ":total_count", 1),
            (try_end),
            (assign, ":average_distance", 100000),
            (try_begin),
                (gt, ":total_count", 0),
                (store_div, ":average_distance", ":total_distance", ":total_count"),
            (try_end),
            (assign, reg0, ":average_distance"),
            (assign, reg1, ":min_distance_1"),
            (assign, reg2, ":min_distance_2"),
            (assign, reg3, ":min_distance_3"),
        ]),

    # script_init_goods
        # input: none
        # output: none
    ("init_goods",
        [
            ## Categories
            (item_set_slot, "itm_velvet", slot_item_consumption_category, icc_clothes),
            (item_set_slot, "itm_linen", slot_item_consumption_category, icc_clothes),
            (item_set_slot, "itm_wool_cloth", slot_item_consumption_category, icc_clothes),
            (item_set_slot, "itm_fur_cloth", slot_item_consumption_category, icc_clothes),
            (item_set_slot, "itm_leatherwork", slot_item_consumption_category, icc_clothes),

            (item_set_slot, "itm_wine", slot_item_consumption_category, icc_drink),
            (item_set_slot, "itm_ale", slot_item_consumption_category, icc_drink),
            (item_set_slot, "itm_milk", slot_item_consumption_category, icc_drink),

            (item_set_slot, "itm_smoked_fish", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_cheese", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_honey", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_sausages", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_cabbages", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_dried_meat", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_chicken", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_apples", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_raw_grapes", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_raw_olives", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_grain", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_butter", slot_item_consumption_category, icc_food),
            (item_set_slot, "itm_bread", slot_item_consumption_category, icc_food),

            ## Perishable
            (item_set_slot, "itm_spice", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_salt", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_raw_flax", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_wool", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_raw_silk", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_raw_dyes", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_iron", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_raw_leather", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_furs", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_stone", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_wood", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_clay", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_oil", slot_item_perish_ratio, 2),

            (item_set_slot, "itm_refined_stone", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_refined_wood", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_pottery", slot_item_perish_ratio, 4),
            (item_set_slot, "itm_leatherwork", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_tools", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_velvet", slot_item_perish_ratio, 5),
            (item_set_slot, "itm_linen", slot_item_perish_ratio, 4),
            (item_set_slot, "itm_wool_cloth", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_fur_cloth", slot_item_perish_ratio, 4),

            (item_set_slot, "itm_cattle", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_poultry", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_pig", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_goat", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_sheep", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_horse", slot_item_perish_ratio, 1),
            # Food items
            (item_set_slot, "itm_wine", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_ale", slot_item_perish_ratio, 1),
            (item_set_slot, "itm_milk", slot_item_perish_ratio, 20),

            (item_set_slot, "itm_smoked_fish", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_cheese", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_honey", slot_item_perish_ratio, 3),
            (item_set_slot, "itm_sausages", slot_item_perish_ratio, 10),
            (item_set_slot, "itm_cabbages", slot_item_perish_ratio, 10),
            (item_set_slot, "itm_dried_meat", slot_item_perish_ratio, 2),
            (item_set_slot, "itm_chicken", slot_item_perish_ratio, 10),
            (item_set_slot, "itm_apples", slot_item_perish_ratio, 8),
            (item_set_slot, "itm_raw_grapes", slot_item_perish_ratio, 10),
            (item_set_slot, "itm_raw_olives", slot_item_perish_ratio, 9),
            (item_set_slot, "itm_raw_date_fruit", slot_item_perish_ratio, 9),
            (item_set_slot, "itm_grain", slot_item_perish_ratio, 4),
            (item_set_slot, "itm_butter", slot_item_perish_ratio, 8),
            (item_set_slot, "itm_bread", slot_item_perish_ratio, 8),

            (item_set_slot, "itm_raw_fish", slot_item_perish_ratio, 20),
            (item_set_slot, "itm_cattle_meat", slot_item_perish_ratio, 20),
            (item_set_slot, "itm_venison", slot_item_perish_ratio, 20),
            (item_set_slot, "itm_raw_chicken", slot_item_perish_ratio, 20),
            (item_set_slot, "itm_pork", slot_item_perish_ratio, 20),

            ## Quality
            (item_set_slot, "itm_spice", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_salt", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_raw_flax", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_wool", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_raw_silk", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_raw_dyes", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_iron", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_raw_leather", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_furs", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_stone", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_wood", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_clay", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_oil", slot_item_consumption_quality, 1),

            (item_set_slot, "itm_refined_stone", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_refined_wood", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_pottery", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_leatherwork", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_tools", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_velvet", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_linen", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_wool_cloth", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_fur_cloth", slot_item_consumption_quality, 3),

            (item_set_slot, "itm_cattle", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_poultry", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_pig", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_goat", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_sheep", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_horse", slot_item_consumption_quality, 3),

            # Food items
            (item_set_slot, "itm_wine", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_ale", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_milk", slot_item_consumption_quality, 2),

            (item_set_slot, "itm_smoked_fish", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_cheese", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_honey", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_sausages", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_cabbages", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_dried_meat", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_chicken", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_apples", slot_item_consumption_quality, 2),
            (item_set_slot, "itm_raw_grapes", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_raw_olives", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_grain", slot_item_consumption_quality, 1),
            (item_set_slot, "itm_butter", slot_item_consumption_quality, 3),
            (item_set_slot, "itm_bread", slot_item_consumption_quality, 2),

            (item_set_slot, "itm_raw_fish", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_cattle_meat", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_venison", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_raw_chicken", slot_item_consumption_quality, 0),
            (item_set_slot, "itm_pork", slot_item_consumption_quality, 0),

            (try_for_range, ":item", goods_begin, goods_end),
                (item_set_slot, ":item", slot_item_consumption_weight_serf, 0),
                (item_set_slot, ":item", slot_item_consumption_weight_artisan, 0),
                (item_set_slot, ":item", slot_item_consumption_weight_noble, 0),
                (item_set_slot, ":item", slot_item_consumption_weight_slave, 0),
            (try_end),

            (item_set_slot, "itm_cattle", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_cattle", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_cattle", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_cattle", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_poultry", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_poultry", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_poultry", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_poultry", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_pig", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_pig", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_pig", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_pig", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_goat", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_goat", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_goat", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_goat", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_sheep", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_sheep", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_sheep", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_sheep", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_horse", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_horse", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_horse", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_horse", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_ale", slot_item_consumption_weight_serf, 50),
            (item_set_slot, "itm_ale", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_ale", slot_item_consumption_weight_noble, 100),
            (item_set_slot, "itm_ale", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_wine", slot_item_consumption_weight_serf, 5),
            (item_set_slot, "itm_wine", slot_item_consumption_weight_artisan, 150),
            (item_set_slot, "itm_wine", slot_item_consumption_weight_noble, 500),
            (item_set_slot, "itm_wine", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_milk", slot_item_consumption_weight_serf, 20),
            (item_set_slot, "itm_milk", slot_item_consumption_weight_artisan, 40),
            (item_set_slot, "itm_milk", slot_item_consumption_weight_noble, 80),
            (item_set_slot, "itm_milk", slot_item_consumption_weight_slave, 5),

            (item_set_slot, "itm_smoked_fish", slot_item_consumption_weight_serf, 50),
            (item_set_slot, "itm_smoked_fish", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_smoked_fish", slot_item_consumption_weight_noble, 250),
            (item_set_slot, "itm_smoked_fish", slot_item_consumption_weight_slave, 5),

            (item_set_slot, "itm_cheese", slot_item_consumption_weight_serf, 20),
            (item_set_slot, "itm_cheese", slot_item_consumption_weight_artisan, 150),
            (item_set_slot, "itm_cheese", slot_item_consumption_weight_noble, 500),
            (item_set_slot, "itm_cheese", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_honey", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_honey", slot_item_consumption_weight_artisan, 10),
            (item_set_slot, "itm_honey", slot_item_consumption_weight_noble, 100),
            (item_set_slot, "itm_honey", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_sausages", slot_item_consumption_weight_serf, 10),
            (item_set_slot, "itm_sausages", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_sausages", slot_item_consumption_weight_noble, 500),
            (item_set_slot, "itm_sausages", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_cabbages", slot_item_consumption_weight_serf, 50),
            (item_set_slot, "itm_cabbages", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_cabbages", slot_item_consumption_weight_noble, 200),
            (item_set_slot, "itm_cabbages", slot_item_consumption_weight_slave, 5),

            (item_set_slot, "itm_dried_meat", slot_item_consumption_weight_serf, 50),
            (item_set_slot, "itm_dried_meat", slot_item_consumption_weight_artisan, 50),
            (item_set_slot, "itm_dried_meat", slot_item_consumption_weight_noble, 50),
            (item_set_slot, "itm_dried_meat", slot_item_consumption_weight_slave, 2),

            (item_set_slot, "itm_chicken", slot_item_consumption_weight_serf, 20),
            (item_set_slot, "itm_chicken", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_chicken", slot_item_consumption_weight_noble, 400),
            (item_set_slot, "itm_chicken", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_apples", slot_item_consumption_weight_serf, 40),
            (item_set_slot, "itm_apples", slot_item_consumption_weight_artisan, 80),
            (item_set_slot, "itm_apples", slot_item_consumption_weight_noble, 160),
            (item_set_slot, "itm_apples", slot_item_consumption_weight_slave, 4),

            (item_set_slot, "itm_raw_grapes", slot_item_consumption_weight_serf, 10),
            (item_set_slot, "itm_raw_grapes", slot_item_consumption_weight_artisan, 150),
            (item_set_slot, "itm_raw_grapes", slot_item_consumption_weight_noble, 400),
            (item_set_slot, "itm_raw_grapes", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_raw_olives", slot_item_consumption_weight_serf, 10),
            (item_set_slot, "itm_raw_olives", slot_item_consumption_weight_artisan, 150),
            (item_set_slot, "itm_raw_olives", slot_item_consumption_weight_noble, 400),
            (item_set_slot, "itm_raw_olives", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_weight_artisan, 50),
            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_weight_noble, 500),
            (item_set_slot, "itm_raw_date_fruit", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_grain", slot_item_consumption_weight_serf, 10),
            (item_set_slot, "itm_grain", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_grain", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_grain", slot_item_consumption_weight_slave, 10),

            (item_set_slot, "itm_butter", slot_item_consumption_weight_serf, 5),
            (item_set_slot, "itm_butter", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_butter", slot_item_consumption_weight_noble, 400),
            (item_set_slot, "itm_butter", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_bread", slot_item_consumption_weight_serf, 200),
            (item_set_slot, "itm_bread", slot_item_consumption_weight_artisan, 100),
            (item_set_slot, "itm_bread", slot_item_consumption_weight_noble, 100),
            (item_set_slot, "itm_bread", slot_item_consumption_weight_slave, 1),

            (item_set_slot, "itm_raw_fish", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_raw_fish", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_raw_fish", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_raw_fish", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_cattle_meat", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_cattle_meat", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_cattle_meat", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_cattle_meat", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_venison", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_venison", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_venison", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_venison", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_raw_chicken", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_raw_chicken", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_raw_chicken", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_raw_chicken", slot_item_consumption_weight_slave, 0),

            (item_set_slot, "itm_pork", slot_item_consumption_weight_serf, 0),
            (item_set_slot, "itm_pork", slot_item_consumption_weight_artisan, 0),
            (item_set_slot, "itm_pork", slot_item_consumption_weight_noble, 0),
            (item_set_slot, "itm_pork", slot_item_consumption_weight_slave, 0),
        ]),

    # script_init_good_recipes
        # input: none
        # output: none
    ("init_good_recipes",
        [
            (item_set_slot, "itm_recipe_wool", slot_recipe_required_item, "itm_sheep"),
            (item_set_slot, "itm_recipe_wool", slot_recipe_required_item_quantity, 20),
            (item_set_slot, "itm_recipe_wool", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_wool", slot_recipe_produced_item, "itm_wool"),
            (item_set_slot, "itm_recipe_wool", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_wool", slot_recipe_consume, 0),

            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_required_item, "itm_stone"),
            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_produced_item, "itm_refined_stone"),
            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_refine_stone", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_required_item, "itm_wood"),
            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_produced_item, "itm_refined_wood"),
            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_refine_wood", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_pottery", slot_recipe_required_item, "itm_clay"),
            (item_set_slot, "itm_recipe_pottery", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_pottery", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_pottery", slot_recipe_produced_item, "itm_pottery"),
            (item_set_slot, "itm_recipe_pottery", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_pottery", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_required_item, "itm_raw_leather"),
            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_produced_item, "itm_leatherwork"),
            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_leatherwork", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_tools", slot_recipe_required_item, "itm_iron"),
            (item_set_slot, "itm_recipe_tools", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_tools", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_tools", slot_recipe_produced_item, "itm_tools"),
            (item_set_slot, "itm_recipe_tools", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_tools", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_velvet", slot_recipe_required_item, "itm_raw_silk"),
            (item_set_slot, "itm_recipe_velvet", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_velvet", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_velvet", slot_recipe_produced_item, "itm_velvet"),
            (item_set_slot, "itm_recipe_velvet", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_velvet", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_linen", slot_recipe_required_item, "itm_raw_flax"),
            (item_set_slot, "itm_recipe_linen", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_linen", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_linen", slot_recipe_produced_item, "itm_linen"),
            (item_set_slot, "itm_recipe_linen", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_linen", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_required_item, "itm_wool"),
            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_produced_item, "itm_wool_cloth"),
            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_wool_cloth", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_required_item, "itm_furs"),
            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_produced_item, "itm_fur_cloth"),
            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_fur_cloth", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_required_item, "itm_cattle"),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_produced_item, "itm_cattle_meat"),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_cattle_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_pig_process", slot_recipe_required_item, "itm_pig"),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_produced_item, "itm_pork"),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_pig_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_required_item, "itm_poultry"),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_produced_item, "itm_raw_chicken"),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_poultry_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_goat_process", slot_recipe_required_item, "itm_goat"),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_produced_item, "itm_venison"),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_goat_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_required_item, "itm_sheep"),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_produced_item, "itm_venison"),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_sheep_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_horse_process", slot_recipe_required_item, "itm_horse"),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_produced_item, "itm_cattle_meat"),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_consume, 1),
            (item_set_slot, "itm_recipe_horse_process", slot_recipe_produced_item_max_ratio, 10),

            (item_set_slot, "itm_recipe_wine", slot_recipe_required_item, "itm_raw_grapes"),
            (item_set_slot, "itm_recipe_wine", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_wine", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_wine", slot_recipe_produced_item, "itm_wine"),
            (item_set_slot, "itm_recipe_wine", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_wine", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_ale", slot_recipe_required_item, "itm_grain"),
            (item_set_slot, "itm_recipe_ale", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_ale", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_ale", slot_recipe_produced_item, "itm_ale"),
            (item_set_slot, "itm_recipe_ale", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_ale", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_required_item, "itm_cattle"),
            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_required_item_quantity, 20),
            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_produced_item, "itm_milk"),
            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_milk_cattle", slot_recipe_consume, 0),

            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_required_item, "itm_goat"),
            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_required_item_quantity, 24),
            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_produced_item, "itm_milk"),
            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_milk_goat", slot_recipe_consume, 0),

            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_required_item, "itm_raw_fish"),
            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_required_item_quantity, 2),
            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_produced_item, "itm_smoked_fish"),
            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_smoked_fish", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_cheese", slot_recipe_required_item, "itm_milk"),
            (item_set_slot, "itm_recipe_cheese", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_cheese", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_cheese", slot_recipe_produced_item, "itm_cheese"),
            (item_set_slot, "itm_recipe_cheese", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_cheese", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_sausages", slot_recipe_required_item, "itm_pork"),
            (item_set_slot, "itm_recipe_sausages", slot_recipe_required_item_quantity, 2),
            (item_set_slot, "itm_recipe_sausages", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_sausages", slot_recipe_produced_item, "itm_sausages"),
            (item_set_slot, "itm_recipe_sausages", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_sausages", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_required_item, "itm_cattle_meat"),
            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_required_item_quantity, 2),
            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_produced_item, "itm_dried_meat"),
            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_dried_meat_beef", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_required_item, "itm_venison"),
            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_required_item_quantity, 2),
            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_produced_item, "itm_dried_meat"),
            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_dried_meat_venison", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_chicken", slot_recipe_required_item, "itm_raw_chicken"),
            (item_set_slot, "itm_recipe_chicken", slot_recipe_required_item_quantity, 2),
            (item_set_slot, "itm_recipe_chicken", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_chicken", slot_recipe_produced_item, "itm_chicken"),
            (item_set_slot, "itm_recipe_chicken", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_chicken", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_butter", slot_recipe_required_item, "itm_milk"),
            (item_set_slot, "itm_recipe_butter", slot_recipe_required_item_quantity, 5),
            (item_set_slot, "itm_recipe_butter", slot_recipe_workload, 100),
            (item_set_slot, "itm_recipe_butter", slot_recipe_produced_item, "itm_butter"),
            (item_set_slot, "itm_recipe_butter", slot_recipe_produced_item_quantity, 2),
            (item_set_slot, "itm_recipe_butter", slot_recipe_consume, 1),

            (item_set_slot, "itm_recipe_bread", slot_recipe_required_item, "itm_grain"),
            (item_set_slot, "itm_recipe_bread", slot_recipe_required_item_quantity, 1),
            (item_set_slot, "itm_recipe_bread", slot_recipe_workload, 10),
            (item_set_slot, "itm_recipe_bread", slot_recipe_produced_item, "itm_bread"),
            (item_set_slot, "itm_recipe_bread", slot_recipe_produced_item_quantity, 1),
            (item_set_slot, "itm_recipe_bread", slot_recipe_consume, 1),
        ]),
    
    # script_party_process_ressources
        # input: 
        #   arg1: party_no
        # output: none
    ("party_process_ressources",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":population", ":party_no", slot_party_population),
            (party_get_slot, ":total_resources", ":party_no", slot_party_total_resources),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (party_get_slot, ":population_slave", ":party_no", slot_party_population_slave),
            (val_mul, ":population_slave", 2),

            (val_add, ":population", ":population_slave"),

            (try_begin),
                (eq, ":party_type", spt_village),
                (val_mul, ":population", goods_ratio_production_village),
            (else_try),
                (eq, ":party_type", spt_town),
                (val_mul, ":population", goods_ratio_production_town),
            (else_try),
                (val_mul, ":population", goods_ratio_production_castle),
            (try_end),
            (val_div, ":population", 100),

            (assign, ":total_production", 0),
            (try_for_range, ":good", goods_begin, goods_end),
                (store_sub, ":offset", ":good", goods_begin),
                (store_add, ":production_slot", ":offset", slot_party_ressources_begin),

                (party_get_slot, ":raw_production", ":party_no", ":production_slot"),
                (gt, ":raw_production", 0),
                (val_mul, ":raw_production", ":population"),
                (store_div, ":num_prod", ":raw_production", ":total_resources"),
                (val_div, ":num_prod", 20),

                (try_begin),
                    (store_mod, ":rest", ":raw_production", ":total_resources"),
                    (store_random_in_range, ":rand", 0, ":total_resources"),
                    (gt, ":rest", ":rand"),
                    (val_add, ":num_prod", 1),
                (try_end),

                (call_script, "script_party_produce_item", ":party_no", ":good", ":num_prod"),
                (val_add, ":total_production", reg0),
            (try_end),
            (try_begin),
                (call_script, "script_cf_debug", debug_economy|debug_trade),
                (is_between, ":party_no", towns_begin, towns_end),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":total_production"),
                (display_message, "@{s10} : produced {reg10} resources in total."),
            (try_end),
        ]),

    # script_party_process_production
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_production",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":population", ":party_no", slot_party_population_artisan),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (party_get_slot, ":population_slave", ":party_no", slot_party_population_slave),
            (val_div, ":population_slave", 2),

            (val_add, ":population", ":population_slave"),

            (try_begin),
                (eq, ":party_type", spt_village),
                (val_mul, ":population", goods_ratio_transformation_village),
            (else_try),
                (eq, ":party_type", spt_town),
                (val_mul, ":population", goods_ratio_transformation_town),
            (else_try),
                (val_mul, ":population", goods_ratio_transformation_castle),
            (try_end),
            (store_div, ":max_workload", ":population", 100),

            (call_script, "script_party_prepare_production_target", ":party_no", ":max_workload"),

            (assign, ":used_workload", 0),

            (try_for_range, ":recipe", recipes_begin, recipes_end),
                (store_sub, ":offset", ":recipe", recipes_begin),
                (store_add, ":slot", ":offset", slot_party_production_target_begin),

                (party_get_slot, ":production_target", ":party_no", ":slot"),
                (gt, ":production_target", 0),

                (item_get_slot, ":required_item", ":recipe", slot_recipe_required_item),
                (item_get_slot, ":required_quantity", ":recipe", slot_recipe_required_item_quantity),
                (item_get_slot, ":workload", ":recipe", slot_recipe_workload),
                (item_get_slot, ":produced_item", ":recipe", slot_recipe_produced_item),
                (item_get_slot, ":produced_quantity", ":recipe", slot_recipe_produced_item_quantity),
                (item_get_slot, ":consume", ":recipe", slot_recipe_consume),

                (val_mul, ":required_quantity", ":production_target"),
                (val_mul, ":produced_quantity", ":production_target"),
                (val_mul, ":workload", ":production_target"),

                (val_add, ":used_workload", ":workload"),

                (try_begin),
                    (eq, ":consume", 1),
                    (call_script, "script_party_consume_item", ":party_no", ":required_item", ":required_quantity"),
                    # (assign, ":consumed", reg0),
                (try_end),
                (call_script, "script_party_produce_item", ":party_no", ":produced_item", ":produced_quantity"),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy|debug_current),
                (eq, ":party_no", towns_begin),

                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":used_workload"),
                (assign, reg11, ":max_workload"),
                (display_message, "@{s10} use workload {reg10}/{reg11}"),
            (try_end),
        ]),

    # script_party_prepare_production_target
        # input:
        #   arg1: party_no
        #   arg2: total_workload
        # output: none
    ("party_prepare_production_target",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":total_workload", 2),

            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (try_begin),
                (eq, ":leader", "$g_player_troop"),
                (party_slot_eq, ":party_no", slot_party_override_production_target, 1),
            (else_try),
                (assign, ":sum_workload", 0),
                (try_for_range, ":recipe", recipes_begin, recipes_end),
                    (store_sub, ":recipe_offset", ":recipe", recipes_begin),
                    (store_add, ":slot", ":recipe_offset", slot_party_production_target_begin),

                    (party_set_slot, ":party_no", ":slot", 0),

                    (item_get_slot, ":required_item", ":recipe", slot_recipe_required_item),
                    (is_between, ":required_item", goods_begin, goods_end),
                    (item_get_slot, ":required_quantity", ":recipe", slot_recipe_required_item_quantity),
                    (gt, ":required_quantity", 0),
                    (item_get_slot, ":workload", ":recipe", slot_recipe_workload),
                    (store_sub, ":required_item_offset", ":required_item", goods_begin),

                    (store_add, ":amount_slot", ":required_item_offset", slot_party_ressources_current_amount_begin),
                    (party_get_slot, ":amount", ":party_no", ":amount_slot"),

                    (item_get_slot, ":quantity_ratio", ":recipe", slot_recipe_produced_item_max_ratio),
                    (try_begin),
                        (gt, ":quantity_ratio", 0),
                        (val_mul, ":amount", ":quantity_ratio"),
                        (val_div, ":amount", 100),
                    (try_end),

                    (store_div, ":num_batch", ":amount", ":required_quantity"),
                    (store_mul, ":max_workload", ":workload", ":num_batch"),

                    (val_add, ":sum_workload", ":max_workload"),
                (try_end),

                (store_mul, ":ratio", ":total_workload", 100),
                (gt, ":sum_workload", 0),
                (val_div, ":ratio", ":sum_workload"),

                (try_for_range, ":recipe", recipes_begin, recipes_end),
                    (store_sub, ":recipe_offset", ":recipe", recipes_begin),
                    (store_add, ":slot", ":recipe_offset", slot_party_production_target_begin),

                    (party_set_slot, ":party_no", ":slot", 0),

                    (item_get_slot, ":required_item", ":recipe", slot_recipe_required_item),
                    (is_between, ":required_item", goods_begin, goods_end),
                    (item_get_slot, ":required_quantity", ":recipe", slot_recipe_required_item_quantity),
                    (gt, ":required_quantity", 0),
                    (item_get_slot, ":workload", ":recipe", slot_recipe_workload),
                    (store_sub, ":required_item_offset", ":required_item", goods_begin),

                    (store_add, ":amount_slot", ":required_item_offset", slot_party_ressources_current_amount_begin),
                    (party_get_slot, ":amount", ":party_no", ":amount_slot"),

                    (item_get_slot, ":quantity_ratio", ":recipe", slot_recipe_produced_item_max_ratio),
                    (try_begin),
                        (gt, ":quantity_ratio", 0),
                        (val_mul, ":amount", ":quantity_ratio"),
                        (val_div, ":amount", 100),
                    (try_end),

                    (store_div, ":num_batch", ":amount", ":required_quantity"),

                    (store_mul, ":goal", ":num_batch", ":ratio"),
                    (store_div, ":to_produce", ":goal", 100),
                    (store_mod, ":chance", ":goal", 100),
                    (try_begin),
                        (store_random_in_range, ":rand", 0, 100),
                        (gt, ":chance", ":rand"),
                        (val_add, ":to_produce", 1),
                    (try_end),

                    (party_set_slot, ":party_no", ":slot", ":to_produce"),
                (try_end),
            (try_end),
        ]),

    # script_party_consume_item
        # input:
        #   arg1: party_no
        #   arg2: item_no
        #   arg3: quantity
        # output:
        #   reg0: amount_consumed
    ("party_consume_item",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":item_no", 2),
            (store_script_param, ":quantity", 3),

            (assign, ":consumed", 0),
            (try_begin),
                (is_between, ":item_no", goods_begin, goods_end),
                (store_sub, ":offset", ":item_no", goods_begin),

                (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),

                (store_add, ":consumption_slot", ":offset", slot_party_item_consumed_begin),

                (party_get_slot, ":consumption", ":party_no", ":consumption_slot"),
                (val_add, ":consumption", ":quantity"),
                (party_set_slot, ":party_no", ":consumption_slot", ":consumption"),

                (party_get_slot, ":amount", ":party_no", ":amount_slot"),
                (val_min, ":quantity", ":amount"),
                (try_begin),
                    (gt, ":quantity", 0),

                    (val_sub, ":amount", ":quantity"),
                    (party_set_slot, ":party_no", ":amount_slot", ":amount"),

                    (assign, ":consumed", ":quantity"),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (eq, ":party_no", towns_begin),
                        (str_store_party_name, s10, ":party_no"),
                        (str_store_item_name, s11, ":item_no"),
                        (assign, reg10, ":consumed"),
                        (display_message, "@{s10} consummed {reg10} {s11}"),
                    (try_end),
                (try_end),
            (try_end),
            (assign, reg0, ":consumed"),
        ]),

    # script_party_produce_item
        # input:
        #   arg1: party_no
        #   arg2: item_no
        #   arg3: quantity
        # output:
        #   reg0: amount_produced
    ("party_produce_item",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":item_no", 2),
            (store_script_param, ":quantity", 3),

            (assign, ":produced", 0),
            (try_begin),
                (is_between, ":item_no", goods_begin, goods_end),
                (store_sub, ":offset", ":item_no", goods_begin),

                (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),

                (party_get_slot, ":amount", ":party_no", ":amount_slot"),
                (try_begin),
                    (gt, ":quantity", 0),

                    (val_add, ":amount", ":quantity"),
                    (party_set_slot, ":party_no", ":amount_slot", ":amount"),

                    (assign, ":produced", ":quantity"),

                    (store_add, ":produced_slot", ":offset", slot_party_item_last_produced_begin),

                    (party_get_slot, ":production", ":party_no", ":produced_slot"),
                    (val_add, ":production", ":produced"),
                    (party_set_slot, ":party_no", ":produced_slot", ":production"),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (eq, ":party_no", towns_begin),
                        (str_store_party_name, s10, ":party_no"),
                        (str_store_item_name, s11, ":item_no"),
                        (assign, reg10, ":produced"),
                        (display_message, "@{s10} produced {reg10} {s11}"),
                    (try_end),
                (try_end),
            (try_end),
            (assign, reg0, ":produced"),
        ]),

    # script_party_process_consumption
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_consumption",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":center_population_serf", ":party_no", slot_party_population),
            (party_get_slot, ":center_population_noble", ":party_no", slot_party_population_noble),
            (party_get_slot, ":center_population_artisan", ":party_no", slot_party_population_artisan),
            (party_get_slot, ":center_population_slave", ":party_no", slot_party_population_slave),

            (try_for_range, ":item", goods_begin, goods_end),
                (store_sub, ":offset", ":item", goods_begin),

                (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),

                (item_get_slot, ":consumption_base_serf", ":item", slot_item_consumption_weight_serf),
                (item_get_slot, ":consumption_base_artisan", ":item", slot_item_consumption_weight_artisan),
                (item_get_slot, ":consumption_base_noble", ":item", slot_item_consumption_weight_noble),
                (item_get_slot, ":consumption_base_slave", ":item", slot_item_consumption_weight_slave),

                (try_begin),
                    (gt, ":consumption_base_serf", 0),
                    (store_mul, ":consumption_power", ":center_population_serf", ":consumption_base_serf"),
                    (call_script, "script_party_process_consumption_good", ":party_no", ":item", ":consumption_power"),
                (try_end),
                (try_begin),
                    (gt, ":consumption_base_artisan", 0),
                    (store_mul, ":consumption_power", ":center_population_artisan", ":consumption_base_artisan"),
                    (call_script, "script_party_process_consumption_good", ":party_no", ":item", ":consumption_power"),
                (try_end),
                (try_begin),
                    (gt, ":consumption_base_noble", 0),
                    (store_mul, ":consumption_power", ":center_population_noble", ":consumption_base_noble"),
                    (call_script, "script_party_process_consumption_good", ":party_no", ":item", ":consumption_power"),
                (try_end),
                (try_begin),
                    (gt, ":consumption_base_slave", 0),
                    (store_mul, ":consumption_power", ":center_population_slave", ":consumption_base_slave"),
                    (call_script, "script_party_process_consumption_good", ":party_no", ":item", ":consumption_power"),
                (try_end),
            (try_end),

            # Goods perishing
            (try_for_range, ":item", goods_begin, goods_end),
                (store_sub, ":offset", ":item", goods_begin),

                (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),
                (party_get_slot, ":amount", ":party_no", ":amount_slot"),

                (item_get_slot, ":perish_ratio", ":item", slot_item_perish_ratio),
                (store_mul, ":perished_items", ":perish_ratio", ":amount"),
                (val_div, ":perished_items", 100),
                (gt, ":perished_items", 0),
                (try_begin),
                    (call_script, "script_cf_debug", debug_economy),
                    (eq, ":party_no", towns_begin),
                    (str_store_party_name, s10, ":party_no"),
                    (str_store_item_name, s11, ":item"),
                    (assign, reg10, ":perished_items"),
                    (display_message, "@{s10} has {reg10} {s11} perish"),
                (try_end),
                (val_sub, ":amount", ":perished_items"),
                (party_set_slot, ":party_no", ":amount_slot", ":amount"),
            (try_end),
        ]),

    # script_party_process_consumption_good
        # input:
        #   arg1: party_no
        #   arg2: item_no
        #   arg3: consumption_power
        # output:
        #   reg0: wanted_consumption
        #   reg1: actual_consumption
    ("party_process_consumption_good",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":item_no", 2),
            (store_script_param, ":consumption_power", 3),

            (store_div, ":pop_consumption", ":consumption_power", consumption_ratio_base),
            (store_mod, ":consumption_rest", ":consumption_power", consumption_ratio_base),
            (try_begin),
                (gt, ":consumption_rest", 0),
                (store_random_in_range, ":rand", 0, consumption_ratio_base),
                (lt, ":rand", ":consumption_rest"),
                (val_add, ":pop_consumption", 1),
            (try_end),

            (call_script, "script_party_consume_item", ":party_no", ":item_no", ":pop_consumption"),
            (assign, ":consumed", reg0),
            (try_begin),
                (neq, ":consumed", ":pop_consumption"),
                (try_begin),
                    (call_script, "script_cf_debug", debug_economy),
                    (eq, ":party_no", towns_begin),
                    (str_store_party_name, s10, ":party_no"),
                    (str_store_item_name, s11, ":item_no"),
                    (assign, reg10, ":consumed"),
                    (assign, reg11, ":pop_consumption"),
                    (display_message, "@{s10} cant fulfill {s11} {reg11} consumed {reg10}"),
                (try_end),
            (try_end),
            (assign, reg0, ":pop_consumption"),
            (assign, reg1, ":consumed"),
        ]),
    
    # script_party_process_population
        # input: 
        #   arg1: party_no
        # output: none
    ("party_process_population",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            
            (party_get_slot, ":serf_population", ":party_no", slot_party_population),
            (party_get_slot, ":artisan_population", ":party_no", slot_party_population_artisan),
            (party_get_slot, ":noble_population", ":party_no", slot_party_population_noble),
            (party_get_slot, ":slave_population", ":party_no", slot_party_population_slave),

            (store_add, ":party_population", ":serf_population", ":artisan_population"),
            (val_add, ":party_population", ":noble_population"),
            # Slaves do not count towards max center population

            (call_script, "script_get_max_population", ":party_no"),
            (assign, ":max_population", reg0),
            (store_mul, ":offset", ":party_population", 100),
            (val_div, ":offset", ":max_population"),
            (val_sub, ":offset", 50), # We consider 50% to be the baseline population with highest growth
            (val_abs, ":offset", ":offset"),
            (store_sub, ":offset", 100, ":offset"),
            (val_abs, ":offset", ":offset"),
            
            (try_begin),
                (eq, ":party_type", spt_village),
                (assign, ":noble_growth", population_growth_village_noble),
                (assign, ":artisan_growth", population_growth_village_artisan),
                (assign, ":serf_growth", population_growth_village_serf),
                (assign, ":slave_growth", population_growth_village_slave),
                (assign, ":base_population_growth", 10),
            (else_try),
                (eq, ":party_type", spt_castle),
                (assign, ":noble_growth", population_growth_castle_noble),
                (assign, ":artisan_growth", population_growth_castle_artisan),
                (assign, ":serf_growth", population_growth_castle_serf),
                (assign, ":slave_growth", population_growth_castle_slave),
                (assign, ":base_population_growth", 5),
            (else_try),
                (assign, ":noble_growth", population_growth_town_noble),
                (assign, ":artisan_growth", population_growth_town_artisan),
                (assign, ":serf_growth", population_growth_town_serf),
                (assign, ":slave_growth", population_growth_town_slave),
                (assign, ":base_population_growth", 15),
            (try_end),
            (assign, ":noble_threshold", ":noble_growth"),
            (store_add, ":artisan_threshold", ":noble_threshold", ":artisan_growth"),
            (store_add, ":serf_threshold", ":artisan_threshold", ":serf_growth"),
            (store_add, ":slave_threshold", ":serf_threshold", ":slave_growth"),

            (store_mul, ":population_growth", ":base_population_growth", ":offset"),
            (val_div, ":population_growth", 100),
            (store_random_in_range, ":bonus_population_growth", 0, 5),

            (assign, ":new_noble", 0),
            (assign, ":new_artisan", 0),
            (assign, ":new_serf", 0),
            (assign, ":new_slave", 0),
            (store_add, ":num_tries", ":population_growth", ":bonus_population_growth"),
            (try_for_range, ":unused", 0, ":num_tries"),
                (store_random_in_range, ":value", 0, ":slave_threshold"),
                (try_begin),
                    (lt, ":value", ":noble_threshold"),
                    (val_add, ":new_noble", 1),
                (else_try),
                    (lt, ":value", ":artisan_threshold"),
                    (val_add, ":new_artisan", 1),
                (else_try),
                    (lt, ":value", ":serf_threshold"),
                    (val_add, ":new_serf", 1),
                (try_end),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":noble_population"),
                (assign, reg11, ":artisan_population"),
                (assign, reg12, ":serf_population"),
                (assign, reg13, ":slave_population"),
                (assign, reg14, ":new_noble"),
                (assign, reg15, ":new_artisan"),
                (assign, reg16, ":new_serf"),
                (assign, reg17, ":new_slave"),
                (display_message, "@{s10} pop: nobles {reg10}+{reg14}, artisan {reg11}+{reg15}, serf {reg12}+{reg16}, slave {reg13}+{reg17}"),
            (try_end),

            (val_add, ":noble_population", ":new_noble"),
            (val_add, ":artisan_population", ":new_artisan"),
            (val_add, ":serf_population", ":new_serf"),
            (val_add, ":slave_population", ":new_slave"),

            (party_set_slot, ":party_no", slot_party_population, ":serf_population"),
            (party_set_slot, ":party_no", slot_party_population_noble, ":noble_population"),
            (party_set_slot, ":party_no", slot_party_population_artisan, ":artisan_population"),
            (party_set_slot, ":party_no", slot_party_population_slave, ":slave_population"),
            
        ]),
    
    # script_get_max_population
        # input:
        #   arg1: party_no
        # output:
        #   reg0: max_population
    ("get_max_population",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":max", ":party_no", slot_party_population_max),
            
            (assign, reg0, ":max"),
        ]),

    # script_party_get_expected_taxes_base
        # input:
        #   arg1: party_no
        # output:
        #   reg0: expected_taxes_base
    ("party_get_expected_taxes_base",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":population_serf", ":party_no", slot_party_population),
            (party_get_slot, ":population_noble", ":party_no", slot_party_population_noble),
            (party_get_slot, ":population_artisan", ":party_no", slot_party_population_artisan),
            # (party_get_slot, ":population_slave", ":party_no", slot_party_population_slave),
            
            (store_mul, ":taxes_serf", ":population_serf", taxes_serf_amount),
            (store_mul, ":taxes_artisan", ":population_artisan", taxes_artisan_amount),
            (store_mul, ":taxes_noble", ":population_noble", taxes_noble_amount),

            (store_add, ":taxes", ":taxes_serf", ":taxes_artisan"),
            (val_add, ":taxes", ":taxes_noble"),

            (party_get_slot, ":tax_rate", ":party_no", slot_party_taxes_fixed),
            (val_mul, ":taxes", ":tax_rate"),
            (val_div, ":taxes", 400),

            (assign, reg0, ":taxes"),
        ]),        

    # script_party_get_expected_taxes
        # input:
        #   arg1: party_no
        # output:
        #   reg0: expected_taxes
    ("party_get_expected_taxes",
        [
            (store_script_param, ":party_no", 1),

            (call_script, "script_party_get_expected_taxes_base", ":party_no"),

            (assign, ":base_taxes", reg0),

            (call_script, "script_party_get_tax_penalties", ":party_no"),
            (assign, ":penalty", reg0),
            (store_sub, ":tax_percent", 100, ":penalty"),
            (val_clamp, ":tax_percent", 0, 101),

            (store_mul, ":total", ":base_taxes", ":tax_percent"),
            (store_div, reg0, ":total", 100),
        ]),


    # script_party_get_tax_penalties
        # input:
        #   arg1: party_no
        # output:
        #   reg0: total_penalties_percentage
        #   reg1: detail_war_damage
        #   reg2: detail_crime
        #   reg3: detail_reconstruction
    ("party_get_tax_penalties",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":party_faction", ":party_no", slot_party_faction),
            (try_begin),
                (neg|is_between, ":party_faction", kingdoms_begin, kingdoms_end),
                (store_faction_of_party, ":party_faction", ":party_no"),
            (try_end),

            (assign, ":result", 0),

            (call_script, "script_faction_get_war_damage_penalty_score", ":party_faction"),
            (assign, ":war_damage", reg0),
            (try_begin),
                (gt, ":war_damage", 0),
                (store_div, ":result", ":war_damage", 3),
                # (store_sqrt, ":result", ":war_damage"),
            (try_end),

            (store_faction_of_party, ":current_faction", ":party_no"),

            (try_begin),
                (this_or_next|party_slot_ge, ":party_no", slot_party_besieged_by, 0),
                (neq, ":current_faction", ":party_faction"),

                # Besieged or occupied centers have reduced taxes
                (val_add, ":result", 30),
            (try_end),

            (val_clamp, ":result", 0, 100),
            (assign, reg0, ":result"),
        ]),

    # script_faction_get_war_damage_penalty_score
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: penalty_score
    ("faction_get_war_damage_penalty_score",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":war_damage", ":faction_no", slot_faction_war_damage),
            (faction_get_slot, ":size", ":faction_no", slot_faction_num_walled_fiefs),
            
            (try_begin),
                (gt, ":size", 0),
                (val_div, ":war_damage", ":size"),
            (try_end),

            (val_div, ":war_damage", war_damage_penalties_begin),
            (store_div, ":war_damage_offset", ":war_damage", war_damage_penalties_offset_begin),
            (try_begin),
                (gt, ":war_damage_offset", 0),
                (val_mul, ":war_damage_offset", ":war_damage_offset"),
            (else_try),
                (assign, ":war_damage_offset", 0),
            (try_end),

            (store_add, ":total_damage", ":war_damage", ":war_damage_offset"),

            (assign, reg0, ":total_damage"),
        ]),
    
    # script_party_process_taxes
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_taxes",
        [
            (store_script_param, ":party_no", 1),

            (call_script, "script_party_get_expected_taxes", ":party_no"),
            (assign, ":taxes", reg0),

            (assign, ":member_tax", 0),
            (assign, ":vassal_tax", 0),
            (assign, ":funds_tax", 0),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (try_begin),
                (gt, ":party_faction", 0),
                (faction_get_slot, ":member_tax_rate", ":party_faction", slot_faction_member_tax_rate),
                (faction_get_slot, ":vassal_tax_rate", ":party_faction", slot_faction_vassal_tax_rate),
                (faction_get_slot, ":funds_tax_rate", ":party_faction", slot_faction_funds_tax_rate),

                (try_begin),
                    (gt, ":member_tax_rate", 0),

                    (faction_get_slot, ":faction_leader", ":party_faction", slot_faction_leader),
                    (ge, ":faction_leader", 0),

                    (store_mul, ":member_tax", ":member_tax_rate", ":taxes"),
                    (val_div, ":member_tax", 100),

                    (call_script, "script_troop_add_accumulated_taxes", ":faction_leader", ":member_tax", tax_type_member, 1),

                    (store_mul, ":member_tax_pay", ":member_tax", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":member_tax_pay", tax_type_member_pay),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (str_store_party_name, s10, ":party_no"),
                        (str_store_troop_name, s11, ":faction_leader"),
                        (assign, reg10, ":member_tax"),
                        (display_message, "@{s10} member taxes: {reg10} to {s11}"),
                    (try_end),
                (try_end),
                (try_begin),
                    (gt, ":vassal_tax_rate", 0),

                    (party_get_slot, ":party_leader", ":party_no", slot_party_leader),
                    (ge, ":party_leader", 0),
                    (troop_get_slot, ":party_leader_lord", ":party_leader", slot_troop_vassal_of),
                    (ge, ":party_leader_lord", 0),

                    (store_mul, ":vassal_tax", ":vassal_tax_rate", ":taxes"),
                    (val_div, ":vassal_tax", 100),

                    (call_script, "script_troop_add_accumulated_taxes", ":party_leader_lord", ":vassal_tax", tax_type_vassal, 1),

                    (store_mul, ":vassal_tax_pay", ":member_tax", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":vassal_tax_pay", tax_type_vassal_pay),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (str_store_troop_name, s10, ":party_leader"),
                        (str_store_troop_name, s11, ":party_leader_lord"),
                        (assign, reg10, ":vassal_tax"),
                        (display_message, "@{s10} vassal taxes: {reg10} to {s11}"),
                    (try_end),
                (try_end),
                (try_begin),
                    (gt, ":funds_tax_rate", 0),

                    (store_mul, ":funds_tax", ":funds_tax_rate", ":taxes"),
                    (val_div, ":funds_tax", 100),

                    (call_script, "script_faction_add_accumulated_taxes", ":party_faction", ":funds_tax", tax_type_funds, 1),

                    (store_mul, ":funds_tax_pay", ":funds_tax", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":funds_tax_pay", tax_type_funds_pay),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (str_store_party_name, s10, ":party_no"),
                        (assign, reg10, ":funds_tax"),
                        (display_message, "@{s10} fund taxes: {reg10}"),
                    (try_end),
                (try_end),
            (try_end),


            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (eq, ":party_type", spt_village),
                (party_get_slot, ":linked_party", ":party_no", slot_party_linked_party),
                (is_between, ":linked_party", centers_begin, centers_end),
                (store_mul, ":linked_taxes", ":taxes", 3),
                (val_div, ":linked_taxes", 10),

                # TODO: remove instant teleportation of money
                # (party_get_slot, ":linked_center_wealth", ":linked_party", slot_party_wealth),
                # (val_add, ":linked_center_wealth", ":linked_taxes"),
                # (party_set_slot, ":linked_party", slot_party_wealth, ":linked_center_wealth"),

                (store_mul, ":linked_taxes_payment", ":linked_taxes", -1),
                (call_script, "script_party_add_accumulated_taxes", ":party_no", ":linked_taxes_payment", tax_type_protection_pay),
                (call_script, "script_party_add_accumulated_taxes", ":linked_party", ":linked_taxes", tax_type_protection),

            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":taxes"),
                (display_message, "@{s10} taxes: {reg10}"),
            (try_end),
            
            (val_sub, ":taxes", ":member_tax"),
            (val_sub, ":taxes", ":vassal_tax"),
            (call_script, "script_party_add_accumulated_taxes", ":party_no", ":taxes", tax_type_population),
        ]),

    # script_troop_add_accumulated_taxes
        # input:
        #   arg1: troop_no
        #   arg2: amount
        #   arg3: tax_type
        #   arg4: direct - do we need to add this amount to the troop's wealth
        # output: none
    ("troop_add_accumulated_taxes",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":amount", 2),
            (store_script_param, ":tax_type", 3),
            (store_script_param, ":direct", 4),

            (try_begin),
                (neq, ":amount", 0),

                (try_begin),
                    (call_script, "script_cf_debug", debug_economy|debug_ai),
                    (str_store_troop_name, s10, ":troop_no"),
                    (assign, reg10, ":amount"),
                    (assign, reg11, ":tax_type"),
                    (assign, reg12, ":direct"),
                    (display_message, "@Adding {reg10} denars for {s10} (type {reg11}, direct: {reg12})"),
                (try_end),

                (troop_get_slot, ":accumulated_taxes", ":troop_no", slot_troop_accumulated_taxes),
                (val_add, ":accumulated_taxes", ":amount"),
                (troop_set_slot, ":troop_no", slot_troop_accumulated_taxes, ":accumulated_taxes"),

                (troop_get_slot, ":budget_party", ":troop_no", slot_troop_budget_reserved_party),
                (troop_get_slot, ":budget_other", ":troop_no", slot_troop_budget_reserved_other),

                (call_script, "script_troop_get_allocated_budget", ":troop_no", ":amount"),
                (assign, ":budget_party_ratio", reg0),
                (assign, ":budget_other_ratio", reg1),

                (store_mul, ":budget_party_new", ":amount", ":budget_party_ratio"),
                (val_div, ":budget_party_new", 100),

                (store_mul, ":budget_other_new", ":amount", ":budget_other_ratio"),
                (val_div, ":budget_other_new", 100),

                (val_add, ":budget_party", ":budget_party_new"),
                (val_add, ":budget_other", ":budget_other_new"),

                (troop_set_slot, ":troop_no", slot_troop_budget_reserved_party, ":budget_party"),
                (troop_set_slot, ":troop_no", slot_troop_budget_reserved_other, ":budget_other"),

                (try_begin),
                    (eq, ":tax_type", tax_type_vassal),
                    (troop_get_slot, ":budget", ":troop_no", slot_troop_budget_vassal_taxes),
                    (val_add, ":budget", ":amount"),
                    (troop_set_slot, ":troop_no", slot_troop_budget_vassal_taxes, ":budget"),
                (else_try),
                    (eq, ":tax_type", tax_type_member),
                    (troop_get_slot, ":budget", ":troop_no", slot_troop_budget_faction_member_taxes),
                    (val_add, ":budget", ":amount"),
                    (troop_set_slot, ":troop_no", slot_troop_budget_faction_member_taxes, ":budget"),
                (else_try),
                    (eq, ":tax_type", tax_type_funds),
                    (troop_get_slot, ":budget", ":troop_no", slot_troop_budget_faction_funds),
                    (val_add, ":budget", ":amount"),
                    (troop_set_slot, ":troop_no", slot_troop_budget_faction_funds, ":budget"),
                (try_end),

                (try_begin),
                    (eq, ":direct", 1),
                    (call_script, "script_troop_change_wealth", ":troop_no", ":amount"),
                (try_end),
            (try_end),
        ]),

    # script_party_add_accumulated_taxes
        # input:
        #   arg1: party_no
        #   arg2: amount
        #   arg3: tax_type
        # output: none
    ("party_add_accumulated_taxes",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":amount", 2),
            (store_script_param, ":tax_type", 3),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy|debug_ai),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":amount"),
                (assign, reg11, ":tax_type"),
                (display_message, "@Adding {reg10} denars for {s10} (type {reg11})"),
            (try_end),

            (try_begin),
                (this_or_next|eq, ":tax_type", tax_type_population),
                (this_or_next|eq, ":tax_type", tax_type_protection),
                (this_or_next|eq, ":tax_type", tax_type_protection_pay),
                (this_or_next|eq, ":tax_type", tax_type_vassal),
                (this_or_next|eq, ":tax_type", tax_type_vassal_pay),
                (this_or_next|eq, ":tax_type", tax_type_member),
                (this_or_next|eq, ":tax_type", tax_type_member_pay),
                (this_or_next|eq, ":tax_type", tax_type_trade),
                (this_or_next|eq, ":tax_type", tax_type_visitor),
                (this_or_next|eq, ":tax_type", tax_type_funds),
                (this_or_next|eq, ":tax_type", tax_type_funds_pay),
                (this_or_next|eq, ":tax_type", tax_type_tribute),
                (this_or_next|eq, ":tax_type", tax_type_tribute_pay),
                (this_or_next|eq, ":tax_type", tax_type_occupation),
                (this_or_next|eq, ":tax_type", tax_type_occupation_pay),
                (eq, ":tax_type", tax_type_debts),
                
                (party_get_slot, ":accumulated_taxes", ":party_no", slot_party_accumulated_taxes),
                (val_add, ":accumulated_taxes", ":amount"),
                (party_set_slot, ":party_no", slot_party_accumulated_taxes, ":accumulated_taxes"),

                (party_get_slot, ":budget_party", ":party_no", slot_party_budget_reserved_party),
                (party_get_slot, ":budget_auxiliaries", ":party_no", slot_party_budget_reserved_auxiliaries),
                (party_get_slot, ":budget_expenses", ":party_no", slot_party_budget_reserved_expenses),
                (party_get_slot, ":budget_other", ":party_no", slot_party_budget_reserved_other),

                (call_script, "script_party_get_allocated_budget", ":party_no", ":amount"),
                (assign, ":budget_party_ratio", reg0),
                (assign, ":budget_auxiliaries_ratio", reg1),
                (assign, ":budget_expenses_ratio", reg2),
                (assign, ":budget_other_ratio", reg3),

                (store_mul, ":budget_party_new", ":amount", ":budget_party_ratio"),
                (val_div, ":budget_party_new", 100),

                (store_mul, ":budget_auxiliaries_new", ":amount", ":budget_auxiliaries_ratio"),
                (val_div, ":budget_auxiliaries_new", 100),

                (store_mul, ":budget_expenses_new", ":amount", ":budget_expenses_ratio"),
                (val_div, ":budget_expenses_new", 100),

                (store_mul, ":budget_other_new", ":amount", ":budget_other_ratio"),
                (val_div, ":budget_other_new", 100),

                (val_add, ":budget_party", ":budget_party_new"),
                (val_add, ":budget_auxiliaries", ":budget_auxiliaries_new"),
                (val_add, ":budget_expenses", ":budget_expenses_new"),
                (val_add, ":budget_other", ":budget_other_new"),

                (party_set_slot, ":party_no", slot_party_budget_reserved_party, ":budget_party"),
                (party_set_slot, ":party_no", slot_party_budget_reserved_auxiliaries, ":budget_auxiliaries"),
                (party_set_slot, ":party_no", slot_party_budget_reserved_expenses, ":budget_expenses"),
                (party_set_slot, ":party_no", slot_party_budget_reserved_other, ":budget_other"),

                (store_faction_of_party, ":current_party_faction", ":party_no"),
                (party_get_slot, ":party_faction", ":party_no", slot_party_faction),
                (try_begin),
                    (eq, ":current_party_faction", ":party_faction"),
                    (try_begin),
                        (party_get_slot, ":leader", ":party_no", slot_party_leader),
                        (ge, ":leader", 0),
                        (call_script, "script_troop_add_accumulated_taxes", ":leader", ":budget_other_new", ":tax_type", 0),
                    (try_end),
                (else_try),
                    # Occupied parties give the leader's money to the occupying faction
                    (neq, ":tax_type", tax_type_occupation_pay),
                    (gt, ":budget_other_new", 0),

                    (call_script, "script_faction_add_accumulated_taxes", ":current_party_faction", ":budget_other_new", tax_type_occupation),
                    (store_mul, ":occupation_pay", ":budget_other_new", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":occupation_pay", tax_type_occupation_pay),
                (try_end),
            (try_end),
            
            (party_get_slot, ":wealth", ":party_no", slot_party_wealth),
            (val_add, ":wealth", ":amount"),
            (party_set_slot, ":party_no", slot_party_wealth, ":wealth"),

            (try_begin),
                (store_add, ":budget_slot", ":tax_type", slot_party_buget_taxes_begin),
                (is_between, ":budget_slot", slot_party_buget_taxes_begin, slot_party_buget_taxes_end),

                (party_get_slot, ":budget", ":party_no", ":budget_slot"),
                (val_add, ":budget", ":amount"),
                (party_set_slot, ":party_no", ":budget_slot", ":budget"),
            (try_end),
        ]),

    # script_faction_add_accumulated_taxes
        # input:
        #   arg1: party_no
        #   arg2: amount
        #   arg3: tax_type
        # output: none
    ("faction_add_accumulated_taxes",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":amount", 2),
            (store_script_param, ":tax_type", 3),

            (faction_get_slot, ":accumulated_taxes", ":faction_no", slot_faction_accumulated_taxes),
            (val_add, ":accumulated_taxes", ":amount"),
            (faction_set_slot, ":faction_no", slot_faction_accumulated_taxes, ":accumulated_taxes"),

            (faction_get_slot, ":wealth", ":faction_no", slot_faction_wealth),
            (val_add, ":wealth", ":amount"),
            (faction_set_slot, ":faction_no", slot_faction_wealth, ":wealth"),

            (try_begin),
                (eq, ":tax_type", tax_type_tribute),
                (faction_get_slot, ":budget", ":faction_no", slot_faction_budget_tribute),
                (val_add, ":budget", ":amount"),
                (faction_set_slot, ":faction_no", slot_faction_budget_tribute, ":budget"),
            (else_try),
                (eq, ":tax_type", tax_type_tribute_pay),
                (faction_get_slot, ":budget", ":faction_no", slot_faction_budget_tribute_payment),
                (val_add, ":budget", ":amount"),
                (faction_set_slot, ":faction_no", slot_faction_budget_tribute_payment, ":budget"),
            (else_try),
                (eq, ":tax_type", tax_type_funds),
                (faction_get_slot, ":budget", ":faction_no", slot_faction_budget_funds),
                (val_add, ":budget", ":amount"),
                (faction_set_slot, ":faction_no", slot_faction_budget_funds, ":budget"),
            (else_try),
                (eq, ":tax_type", tax_type_funds_pay),
                (faction_get_slot, ":budget", ":faction_no", slot_faction_budget_funds_payment),
                (val_add, ":budget", ":amount"),
                (faction_set_slot, ":faction_no", slot_faction_budget_funds_payment, ":budget"),
            (try_end),
        ]),

    # script_troop_get_allocated_budget
        # input:
        #   arg1: troop_no
        #   arg2: amount
        # output:
        #   reg0: ratio_troop_party_wage
        #   reg1: ratio_other
    ("troop_get_allocated_budget",
        [
            (assign, ":max_value", 150),

            (assign, ":ratio_party", ":max_value"),

            (assign, ":ratio_other", 100),
            (val_sub, ":ratio_other", ":ratio_party"),
            (val_max, ":ratio_other", 0),

            (assign, reg0, ":ratio_party"),
            (assign, reg1, ":ratio_other"),
        ]),

    # script_party_get_allocated_budget
        # input:
        #   arg1: party_no
        #   arg2: amount
        # output:
        #   reg0: ratio_party_wage
        #   reg1: ratio_auxiliary_parties
        #   reg2: ratio_spendings (buildings, armor upgrades...)
        #   reg3: ratio_other
    ("party_get_allocated_budget",
        [
            (store_script_param, ":party_no", 1),
            # (store_script_param, ":amount", 2),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (assign, ":ratio_party", 40),
            (assign, ":ratio_auxiliaries", 10),
            (assign, ":ratio_spendings", 25),

            (try_begin),
                (eq, ":party_type", spt_town),
                (assign, ":ratio_party", 45),
                (assign, ":ratio_auxiliaries", 15),
                (assign, ":ratio_spendings", 10),
            (else_try),
                (eq, ":party_type", spt_castle),
                (assign, ":ratio_party", 45),
                (assign, ":ratio_auxiliaries", 10),
                (assign, ":ratio_spendings", 8),
            (else_try),
                (eq, ":party_type", spt_village),
                (assign, ":ratio_party", 25),
                (assign, ":ratio_auxiliaries", 0),
                (assign, ":ratio_spendings", 5),
            (try_end),

            (assign, ":ratio_other", 100),
            (val_sub, ":ratio_other", ":ratio_party"),
            (val_sub, ":ratio_other", ":ratio_auxiliaries"),
            (val_sub, ":ratio_other", ":ratio_spendings"),
            (val_max, ":ratio_other", 0),

            (assign, reg0, ":ratio_party"),
            (assign, reg1, ":ratio_auxiliaries"),
            (assign, reg2, ":ratio_spendings"),
            (assign, reg3, ":ratio_other"),
        ]),

    # script_troop_process_ideal_party_wages
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_process_ideal_party_wages",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":wanted_wages", ":troop_no", slot_troop_budget_reserved_party),
            (troop_get_slot, ":old_wanted_wages", ":troop_no", slot_troop_wanted_party_wages),

            (try_begin),
                (le, ":old_wanted_wages", 0),
                (assign, ":new_wanted_wages", ":wanted_wages"),
            (else_try),
                # In case the new wages are higher we take the average of this and last year
                (gt, ":wanted_wages", ":old_wanted_wages"),
                (store_add, ":new_wanted_wages", ":old_wanted_wages", ":wanted_wages"),
                (val_div, ":new_wanted_wages", 2),
            (else_try),
                # We make an average of the last 5 years
                (store_mul, ":new_wanted_wages", ":old_wanted_wages", 4),
                (val_add, ":new_wanted_wages", ":wanted_wages"),
                (val_div, ":new_wanted_wages", 5),
            (try_end),

            (try_begin),
                (gt, ":old_wanted_wages", ":new_wanted_wages"),
                (val_sub, ":new_wanted_wages", 1),
            (else_try),
                (lt, ":old_wanted_wages", ":new_wanted_wages"),
                (val_add, ":new_wanted_wages", 1),
            (try_end),

            # (try_begin),
            #     (call_script, "script_cf_debug", debug_economy),
            #     (str_store_troop_name, s10, ":troop_no"),
            #     (assign, reg10, ":wanted_wages"),
            #     (assign, reg11, ":old_wanted_wages"),
            #     (assign, reg12, ":new_wanted_wages"),
            #     (display_message, "@{s10} wanted wages - current: {reg10}, old: {reg11}, new: {reg12}"),
            # (try_end),

            (troop_set_slot, ":troop_no", slot_troop_wanted_party_wages, ":new_wanted_wages"),
        ]),

    # script_party_process_ideal_party_wages
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_ideal_party_wages",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":wanted_wages", ":party_no", slot_party_budget_reserved_party),

            (party_get_slot, ":old_wanted_wages", ":party_no", slot_party_wanted_party_wages),

            (try_begin),
                (le, ":old_wanted_wages", 0),
                (assign, ":new_wanted_wages", ":wanted_wages"),
            (else_try),
                # We make an average of the last 10 months
                (store_mul, ":new_wanted_wages", ":old_wanted_wages", 4),
                (val_add, ":new_wanted_wages", ":wanted_wages"),
                (val_div, ":new_wanted_wages", 5),
            (try_end),

            (try_begin),
                (gt, ":old_wanted_wages", ":new_wanted_wages"),
                (val_sub, ":new_wanted_wages", 1),
            (else_try),
                (lt, ":old_wanted_wages", ":new_wanted_wages"),
                (val_add, ":new_wanted_wages", 1),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":wanted_wages"),
                (assign, reg11, ":old_wanted_wages"),
                (assign, reg12, ":new_wanted_wages"),
                # (display_message, "@{s10} wanted wages - current: {reg10}, old: {reg11}, new: {reg12}"),
            (try_end),

            (party_set_slot, ":party_no", slot_party_wanted_party_wages, ":new_wanted_wages"),
        ]),
    
    # script_spawn_party_around_party
        # input: 
        #   arg1: party_no
        #   arg2: party_template_to_spawn
        # output:
        #   reg0: spawned_party_id
    ("spawn_party_around_party",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":party_template", 2),
            
            (set_spawn_radius, 2),
            
            (spawn_around_party, ":party_no", ":party_template"),
            (assign, ":spawned_party", reg0),

            (party_set_slot, ":spawned_party", slot_party_origin_center, ":party_no"),
            (party_set_slot, ":spawned_party", slot_party_leader, -1),
            
            (assign, reg0, ":spawned_party"),
        ]),
    
    # script_cf_faction_need_party_nearby_resources
        # input:
        #   arg1: faction_no
        #   arg2: party_no
        # output: none
    ("cf_faction_need_party_nearby_resources",
        [
            
        ]),
    
    # script_spawn_new_center_marker_with_party_resources
        # input:
        #   arg1: party_no
        # output: none
    ("spawn_new_center_marker_with_party_resources",
        [
            
        ]),

    # script_init_centers
        # input: none
        # output: none
    ("init_centers",
        [
            (try_for_range, ":cur_center", towns_begin, towns_end),
                (party_set_slot, ":cur_center", slot_party_type, spt_town),
            (try_end),
            
            (try_for_range, ":cur_center", castles_begin, castles_end),
                (party_set_slot, ":cur_center", slot_party_type, spt_castle),
                (store_faction_of_party, ":center_faction", ":cur_center"),
                (assign, ":best", -1),
                (assign, ":best_dist", 999),
                (try_for_range, ":village", villages_begin, villages_end),
                    (store_distance_to_party_from_party, ":dist", ":cur_center", ":village"),
                    (store_faction_of_party, ":village_faction", ":village"),
                    (eq, ":village_faction", ":center_faction"),
                    (try_begin),
                        (lt, ":dist", ":best_dist"),
                        (assign, ":best_dist", ":dist"),
                        (assign, ":best", ":village"),
                    (try_end),
                (try_end),
                (try_begin),
                    (gt, ":best", 0),
                    (party_set_slot, ":cur_center", slot_party_linked_party, ":best"),
                    (party_set_slot, ":best", slot_party_linked_party, ":cur_center"),
                (try_end),
            (try_end),
            
            (try_for_range, ":cur_center", villages_begin, villages_end),
                (party_set_slot, ":cur_center", slot_party_type, spt_village),
                (neg|party_slot_ge, ":cur_center", slot_party_linked_party, 1),
                (store_faction_of_party, ":center_faction", ":cur_center"),
                (assign, ":best", -1),
                (assign, ":best_dist", 999),
                (try_for_range, ":town", towns_begin, towns_end),
                    (store_distance_to_party_from_party, ":dist", ":cur_center", ":town"),
                    (store_faction_of_party, ":town_faction", ":town"),
                    (eq, ":town_faction", ":center_faction"),
                    (try_begin),
                        (lt, ":dist", ":best_dist"),
                        (assign, ":best_dist", ":dist"),
                        (assign, ":best", ":town"),
                    (try_end),
                (try_end),
                (party_set_slot, ":cur_center", slot_party_linked_party, ":best"),
            (try_end),

            (try_for_range, ":cur_center", centers_begin, centers_end),
                (store_faction_of_party, ":original_faction", ":cur_center"),
                (party_set_slot, ":cur_center", slot_party_original_faction, ":original_faction"),
                (party_set_slot, ":cur_center", slot_party_faction, ":original_faction"),
            (try_end),
        ]),
        
    # script_init_factions
        # input: none
        # output: none
    ("init_factions",
        [
            (faction_set_slot, "fac_player_faction", slot_faction_culture, "fac_culture_7"), # Mercenaries
            (faction_set_slot, "fac_faction_8", slot_faction_culture, "fac_culture_7"), # Mercenaries

            (faction_set_slot, "fac_kingdom_1", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_kingdom_2", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_kingdom_3", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_kingdom_4", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_kingdom_5", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_kingdom_6", slot_faction_culture, "fac_culture_6"),
            
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_culture, "fac_culture_1"),
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_culture, "fac_culture_2"),
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_culture, "fac_culture_3"),
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_culture, "fac_culture_4"),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_culture, "fac_culture_5"),
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_culture, "fac_culture_6"),
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_culture, "fac_culture_6"),
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_culture, "fac_culture_6"),
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_culture, "fac_culture_6"),
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_culture, "fac_culture_6"),
            
            (faction_set_slot, "fac_kingdom_1", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_kingdom_1", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_kingdom_1", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_kingdom_1", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_kingdom_1", slot_faction_noble_num_tries, 60),
            
            (faction_set_slot, "fac_kingdom_2", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_kingdom_2", slot_faction_common_num_tries, 75),
            (faction_set_slot, "fac_kingdom_2", slot_faction_veteran_num_tries, 50),
            (faction_set_slot, "fac_kingdom_2", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_kingdom_2", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_kingdom_3", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_kingdom_3", slot_faction_common_num_tries, 30),
            (faction_set_slot, "fac_kingdom_3", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_kingdom_3", slot_faction_elite_num_tries, 50),
            (faction_set_slot, "fac_kingdom_3", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_kingdom_4", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_kingdom_4", slot_faction_common_num_tries, 20),
            (faction_set_slot, "fac_kingdom_4", slot_faction_veteran_num_tries, 80),
            (faction_set_slot, "fac_kingdom_4", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_kingdom_4", slot_faction_noble_num_tries, 40),
            
            (faction_set_slot, "fac_kingdom_5", slot_faction_peasant_num_tries, 40),
            (faction_set_slot, "fac_kingdom_5", slot_faction_common_num_tries, 50),
            (faction_set_slot, "fac_kingdom_5", slot_faction_veteran_num_tries, 50),
            (faction_set_slot, "fac_kingdom_5", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_kingdom_5", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_kingdom_6", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_kingdom_6", slot_faction_common_num_tries, 50),
            (faction_set_slot, "fac_kingdom_6", slot_faction_veteran_num_tries, 25),
            (faction_set_slot, "fac_kingdom_6", slot_faction_elite_num_tries, 20),
            (faction_set_slot, "fac_kingdom_6", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_elite_num_tries, 100),
            (faction_set_slot, "fac_small_kingdom_11", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_common_num_tries, 75),
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_veteran_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_elite_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_12", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_peasant_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_veteran_num_tries, 10),
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_elite_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_13", slot_faction_noble_num_tries, 80),
            
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_common_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_veteran_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_14", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_common_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_15", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_common_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_elite_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_16", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_veteran_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_17", slot_faction_noble_num_tries, 80),
            
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_peasant_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_veteran_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_elite_num_tries, 150),
            (faction_set_slot, "fac_small_kingdom_21", slot_faction_noble_num_tries, 50),
            
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_peasant_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_common_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_veteran_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_22", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_elite_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_23", slot_faction_noble_num_tries, 60),
            
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_common_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_elite_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_24", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_elite_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_25", slot_faction_noble_num_tries, 40),
            
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_common_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_31", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_common_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_veteran_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_elite_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_32", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_common_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_veteran_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_33", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_elite_num_tries, 100),
            (faction_set_slot, "fac_small_kingdom_34", slot_faction_noble_num_tries, 40),
            
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_peasant_num_tries, 30),
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_common_num_tries, 10),
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_35", slot_faction_noble_num_tries, 40),
            
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_elite_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_36", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_common_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_veteran_num_tries, 70),
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_41", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_common_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_veteran_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_elite_num_tries, 10),
            (faction_set_slot, "fac_small_kingdom_42", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_common_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_43", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_peasant_num_tries, 10),
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_common_num_tries, 30),
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_veteran_num_tries, 30),
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_44", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_45", slot_faction_noble_num_tries, 80),
            
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_peasant_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_veteran_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_noble_num_tries, 60),
            
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_peasant_num_tries, 10),
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_veteran_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_52", slot_faction_noble_num_tries, 40),
            
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_common_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_elite_num_tries, 50),
            (faction_set_slot, "fac_small_kingdom_53", slot_faction_noble_num_tries, 80),
            
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_common_num_tries, 80),
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_elite_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_54", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_veteran_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_elite_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_55", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_common_num_tries, 75),
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_veteran_num_tries, 25),
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_61", slot_faction_noble_num_tries, 25),
            
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_common_num_tries, 30),
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_veteran_num_tries, 30),
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_62", slot_faction_noble_num_tries, 0),
            
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_common_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_elite_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_63", slot_faction_noble_num_tries, 80),
            
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_common_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_veteran_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_elite_num_tries, 40),
            (faction_set_slot, "fac_small_kingdom_64", slot_faction_noble_num_tries, 20),
            
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_common_num_tries, 20),
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_veteran_num_tries, 60),
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_elite_num_tries, 0),
            (faction_set_slot, "fac_small_kingdom_65", slot_faction_noble_num_tries, 20),
            
            (call_script, "script_init_factions_troop_ratio"),

            (faction_set_slot, "fac_small_kingdom_32", slot_faction_has_fixed_name, 1),
            (faction_set_slot, "fac_small_kingdom_51", slot_faction_has_fixed_name, 1),
            
            (call_script, "script_init_factions_politic"),

            (faction_set_slot, "fac_player_faction", slot_faction_status, sfst_disabled),

            (try_for_range, ":fac_1", kingdoms_begin, kingdoms_end),
                (faction_set_slot, ":fac_1", slot_faction_lord_gathering, -1),
                (faction_set_slot, ":fac_1", slot_faction_size, -1),
                (faction_set_slot, ":fac_1", slot_faction_size_category, -1),

                (faction_set_slot, ":fac_1", slot_faction_vassal_tax_rate, faction_tax_rate_vassal_base),
                (faction_set_slot, ":fac_1", slot_faction_member_tax_rate, faction_tax_rate_member_base),
                (faction_set_slot, ":fac_1", slot_faction_funds_tax_rate, faction_tax_rate_funds_base),

                (faction_set_slot, ":fac_1", slot_faction_wealth_shared_ratio, faction_wealth_shared_ratio),
                
                (faction_set_slot, ":fac_1", slot_faction_status, sfst_default),

                (faction_set_slot, ":fac_1", slot_faction_is_at_war, 0),

                (faction_get_color, ":color", ":fac_1"),
                (faction_set_slot, ":fac_1", slot_faction_original_color, ":color"),

                (try_begin),
                    (spawn_around_party, "p_centers_end", "pt_name_holders_template"),
                    (assign, ":new_party", reg0),
                    (disable_party, ":new_party"),
                    (faction_set_slot, ":fac_1", slot_faction_name_holder, ":new_party"),
                    (str_store_faction_name, s10, ":fac_1"),
                    (party_set_name, ":new_party", s10),
                (try_end),

                (call_script, "script_faction_update_size", ":fac_1"),
            (try_end),
        ]),
    
    # script_init_factions_troop_ratio
        # input: none
        # output: none
    ("init_factions_troop_ratio",
        [
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_infantry, 100),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_spearman, 25),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_pikeman, 5),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_skirmisher, 20),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_shock_infantry, 10),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_archer, 30),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_crossbow, 30),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_cavalry, 70),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_lancer, 15),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_horse_archer, 15),
            (faction_set_slot, "fac_kingdom_1", slot_faction_troop_ratio_mounted_skirmisher, 5),
            
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_infantry, 75),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_spearman, 25),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_pikeman, 5),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_skirmisher, 30),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_shock_infantry, 25),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_archer, 90),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_cavalry, 100),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_lancer, 25),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_horse_archer, 25),
            (faction_set_slot, "fac_kingdom_2", slot_faction_troop_ratio_mounted_skirmisher, 30),
            
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_infantry, 25),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_spearman, 65),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_pikeman, 5),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_skirmisher, 25),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_shock_infantry, 10),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_archer, 35),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_cavalry, 80),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_lancer, 100),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_horse_archer, 80),
            (faction_set_slot, "fac_kingdom_3", slot_faction_troop_ratio_mounted_skirmisher, 50),
            
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_infantry, 100),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_spearman, 30),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_skirmisher, 45),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_shock_infantry, 15),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_archer, 45),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_cavalry, 10),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_lancer, 10),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_horse_archer, 5),
            (faction_set_slot, "fac_kingdom_4", slot_faction_troop_ratio_mounted_skirmisher, 15),
            
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_infantry, 80),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_spearman, 100),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_pikeman, 40),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_skirmisher, 25),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_shock_infantry, 15),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_archer, 15),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_crossbow, 75),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_cavalry, 25),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_lancer, 30),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_horse_archer, 15),
            (faction_set_slot, "fac_kingdom_5", slot_faction_troop_ratio_mounted_skirmisher, 10),
            
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_infantry, 80),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_skirmisher, 100),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_shock_infantry, 20),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_archer, 40),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_cavalry, 90),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_lancer, 30),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_horse_archer, 25),
            (faction_set_slot, "fac_kingdom_6", slot_faction_troop_ratio_mounted_skirmisher, 100),

            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_infantry,          90),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_spearman,          30),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_pikeman,           10),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_skirmisher,        15),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_shock_infantry,    5),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_archer,            20),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_crossbow,          20),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_cavalry,           60),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_lancer,            20),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_horse_archer,      10),
            (faction_set_slot, "fac_faction_8", slot_faction_troop_ratio_mounted_skirmisher,10),
            
            (try_for_range, ":faction", "fac_small_kingdom_11", "fac_small_kingdom_21"),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_1"),
            (try_end),
            (try_for_range, ":faction", "fac_small_kingdom_21", "fac_small_kingdom_31"),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_2"),
            (try_end),
            (try_for_range, ":faction", "fac_small_kingdom_31", "fac_small_kingdom_41"),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_3"),
            (try_end),
            (try_for_range, ":faction", "fac_small_kingdom_41", "fac_small_kingdom_51"),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_4"),
            (try_end),
            (try_for_range, ":faction", "fac_small_kingdom_51", "fac_small_kingdom_61"),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_5"),
            (try_end),
            (try_for_range, ":faction", "fac_small_kingdom_61", kingdoms_end),
                (call_script, "script_faction_copy_faction_troop_ratio", ":faction", "fac_kingdom_6"),
            (try_end),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_11", slot_faction_troop_ratio_spearman, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_11", slot_faction_troop_ratio_archer, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_11", slot_faction_troop_ratio_crossbow, 15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_12", slot_faction_troop_ratio_shock_infantry, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_12", slot_faction_troop_ratio_cavalry, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_12", slot_faction_troop_ratio_lancer, -5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_13", slot_faction_troop_ratio_spearman, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_13", slot_faction_troop_ratio_lancer, 30),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_14", slot_faction_troop_ratio_archer, 25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_14", slot_faction_troop_ratio_crossbow, -25),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_15", slot_faction_troop_ratio_cavalry, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_15", slot_faction_troop_ratio_spearman, 10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_16", slot_faction_troop_ratio_skirmisher, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_16", slot_faction_troop_ratio_mounted_skirmisher, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_16", slot_faction_troop_ratio_cavalry, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_16", slot_faction_troop_ratio_infantry, -5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_17", slot_faction_troop_ratio_shock_infantry, 10), # For swadian sergeant
            (call_script, "script_faction_change_slot", "fac_small_kingdom_17", slot_faction_troop_ratio_infantry, 10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_lancer, 35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_cavalry, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_archer, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_infantry, 0),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_spearman, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_21", slot_faction_troop_ratio_shock_infantry, -5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_22", slot_faction_troop_ratio_cavalry, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_22", slot_faction_troop_ratio_infantry, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_22", slot_faction_troop_ratio_spearman, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_22", slot_faction_troop_ratio_shock_infantry, 15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_23", slot_faction_troop_ratio_infantry, 35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_23", slot_faction_troop_ratio_cavalry, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_23", slot_faction_troop_ratio_spearman, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_23", slot_faction_troop_ratio_archer, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_skirmisher, 25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_infantry, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_shock_infantry, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_archer, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_mounted_skirmisher, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_24", slot_faction_troop_ratio_cavalry, -5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_25", slot_faction_troop_ratio_horse_archer, 35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_25", slot_faction_troop_ratio_cavalry, -35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_25", slot_faction_troop_ratio_pikeman, 15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_31", slot_faction_troop_ratio_horse_archer, 35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_31", slot_faction_troop_ratio_infantry, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_31", slot_faction_troop_ratio_lancer, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_31", slot_faction_troop_ratio_spearman, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_31", slot_faction_troop_ratio_cavalry, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_spearman, 25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_shock_infantry, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_archer, 25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_infantry, 50),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_skirmisher, 40),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_cavalry, -30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_lancer, -50),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_horse_archer, -40),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_32", slot_faction_troop_ratio_mounted_skirmisher, -30),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_33", slot_faction_troop_ratio_mounted_skirmisher, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_33", slot_faction_troop_ratio_cavalry, -30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_33", slot_faction_troop_ratio_lancer, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_horse_archer, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_cavalry, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_mounted_skirmisher, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_lancer, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_spearman, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_archer, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_shock_infantry, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_34", slot_faction_troop_ratio_skirmisher, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_35", slot_faction_troop_ratio_cavalry, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_35", slot_faction_troop_ratio_mounted_skirmisher, -20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_35", slot_faction_troop_ratio_horse_archer, -40),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_35", slot_faction_troop_ratio_lancer, -40),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_36", slot_faction_troop_ratio_archer, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_36", slot_faction_troop_ratio_infantry, 25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_36", slot_faction_troop_ratio_shock_infantry, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_36", slot_faction_troop_ratio_spearman, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_36", slot_faction_troop_ratio_lancer, -20),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_41", slot_faction_troop_ratio_cavalry, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_41", slot_faction_troop_ratio_lancer, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_41", slot_faction_troop_ratio_horse_archer, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_41", slot_faction_troop_ratio_archer, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_41", slot_faction_troop_ratio_skirmisher, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_42", slot_faction_troop_ratio_archer, 5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_42", slot_faction_troop_ratio_skirmisher, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_42", slot_faction_troop_ratio_infantry, 15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_43", slot_faction_troop_ratio_skirmisher, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_43", slot_faction_troop_ratio_infantry, -25),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_43", slot_faction_troop_ratio_archer, -10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_44", slot_faction_troop_ratio_spearman, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_44", slot_faction_troop_ratio_infantry, -20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_44", slot_faction_troop_ratio_crossbow, 45),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_44", slot_faction_troop_ratio_archer, -15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_45", slot_faction_troop_ratio_skirmisher, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_45", slot_faction_troop_ratio_cavalry, 30),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_archer, 60),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_crossbow, -60),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_cavalry, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_lancer, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_spearman, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_pikeman, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_51", slot_faction_troop_ratio_infantry, 15),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_52", slot_faction_troop_ratio_spearman, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_52", slot_faction_troop_ratio_cavalry, 25),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_53", slot_faction_troop_ratio_pikeman, -20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_53", slot_faction_troop_ratio_cavalry, 35),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_54", slot_faction_troop_ratio_skirmisher, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_54", slot_faction_troop_ratio_crossbow, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_54", slot_faction_troop_ratio_pikeman, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_54", slot_faction_troop_ratio_horse_archer, 10),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_crossbow, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_cavalry, -5),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_lancer, 55),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_horse_archer, 30),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_pikeman, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_spearman, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_55", slot_faction_troop_ratio_infantry, -5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_61", slot_faction_troop_ratio_horse_archer, 50),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_61", slot_faction_troop_ratio_mounted_skirmisher, -40),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_61", slot_faction_troop_ratio_lancer, 5),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_archer, 40),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_skirmisher, -50),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_mounted_skirmisher, -35),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_cavalry, -20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_infantry, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_62", slot_faction_troop_ratio_spearman, 40),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_cavalry, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_lancer, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_infantry, 15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_archer, 10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_mounted_skirmisher, -60),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_63", slot_faction_troop_ratio_skirmisher, -45),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_64", slot_faction_troop_ratio_crossbow, 65),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_64", slot_faction_troop_ratio_archer, -15),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_64", slot_faction_troop_ratio_skirmisher, -80),
            
            (call_script, "script_faction_change_slot", "fac_small_kingdom_65", slot_faction_troop_ratio_pikeman, 20),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_65", slot_faction_troop_ratio_cavalry, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_65", slot_faction_troop_ratio_lancer, -10),
            (call_script, "script_faction_change_slot", "fac_small_kingdom_65", slot_faction_troop_ratio_horse_archer, -5),
        ]),
    
    # script_faction_copy_troop_ratio
        # input:
        #   arg1: faction_no
        #   arg2: faction to copy slots from
        # output: none
    ("faction_copy_faction_troop_ratio",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            
            (try_for_range, ":slot", slot_faction_troop_ratio_infantry, slot_faction_troop_ratio_mounted_skirmisher + 1),
                (faction_get_slot, ":value", ":faction_2", ":slot"),
                (faction_set_slot, ":faction_1", ":slot", ":value"),
            (try_end),
        ]),
    
    # script_faction_change_slot
        # input:
        #   arg1: faction_no
        #   arg2: slot
        #   arg3: change
        # output: none
    ("faction_change_slot",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":slot", 2),
            (store_script_param, ":change", 3),
            
            (faction_get_slot, ":value", ":faction_no", ":slot"),
            (val_add, ":value", ":change"),
            (faction_set_slot, ":faction_no", ":slot", ":value"),
        ]),
    
    # script_init_factions_politic
        # input: none
        # output: none
    ("init_factions_politic",
        [
            (try_for_range, ":kingdom", kingdoms_begin, kingdoms_end),
                (try_for_range, ":other_kingdom", kingdoms_begin, kingdoms_end),
                    (store_sub, ":offset", ":other_kingdom", kingdoms_begin),
                    (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_treaties_begin),

                    (store_add, ":relation_slot", ":offset", slot_faction_kingdom_relation_begin),

                    (faction_set_slot, ":kingdom", ":treaty_slot", sfkt_none),
                    (faction_set_slot, ":kingdom", ":relation_slot", 0),
                    (faction_set_slot, ":kingdom", slot_faction_vassal_type, 0x00),

                    (store_add, ":treaty_temporary_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),
                    (store_add, ":treaty_temporary_duration_slot", ":offset", slot_faction_kingdom_temporary_treaties_duration_begin),
                    (store_add, ":treaty_temporary_object_slot", ":offset", slot_faction_kingdom_temporary_treaties_object_begin),

                    (faction_set_slot, ":kingdom", ":treaty_temporary_slot", sfkt_none),
                    (faction_set_slot, ":kingdom", ":treaty_temporary_duration_slot", 0),
                    (faction_set_slot, ":kingdom", ":treaty_temporary_object_slot", 0),
                (try_end),
            (try_end),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_1", "fac_kingdom_4", 0),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_1", "fac_kingdom_5", 0),
            
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_2", "fac_kingdom_3", 0),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_2", "fac_kingdom_4", 0),
            
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_3", "fac_kingdom_6", 0),
            
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_kingdom_5", "fac_kingdom_6", 0),
            
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_11", "fac_kingdom_1", 3),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_11", "fac_kingdom_6", 0),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_12", "fac_kingdom_1", 3),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_13", "fac_kingdom_1", 1),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_14", "fac_kingdom_1", 4),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_15", "fac_kingdom_1", 4),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_16", "fac_kingdom_1", 2),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_17", "fac_kingdom_1", 3),
            
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_21", "fac_kingdom_2", 4),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_22", "fac_kingdom_2", 3),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_23", "fac_kingdom_2", 2),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_24", "fac_kingdom_2", 4),
            # (call_script, "script_faction_set_random_relation_with_faction", "fac_small_kingdom_25", "fac_kingdom_2", 1),
        ]),
    
    # script_init_cultures
        # input: none
        # output: none
    ("init_cultures",
        [
            (faction_set_slot, "fac_culture_1", slot_faction_troops_begin, kingdom_1_troops_begin),
            (faction_set_slot, "fac_culture_1", slot_faction_troops_end, kingdom_1_troops_end),
            
            (faction_set_slot, "fac_culture_2", slot_faction_troops_begin, kingdom_2_troops_begin),
            (faction_set_slot, "fac_culture_2", slot_faction_troops_end, kingdom_2_troops_end),
            
            (faction_set_slot, "fac_culture_3", slot_faction_troops_begin, kingdom_3_troops_begin),
            (faction_set_slot, "fac_culture_3", slot_faction_troops_end, kingdom_3_troops_end),
            
            (faction_set_slot, "fac_culture_4", slot_faction_troops_begin, kingdom_4_troops_begin),
            (faction_set_slot, "fac_culture_4", slot_faction_troops_end, kingdom_4_troops_end),
            
            (faction_set_slot, "fac_culture_5", slot_faction_troops_begin, kingdom_5_troops_begin),
            (faction_set_slot, "fac_culture_5", slot_faction_troops_end, kingdom_5_troops_end),
            
            (faction_set_slot, "fac_culture_6", slot_faction_troops_begin, kingdom_6_troops_begin),
            (faction_set_slot, "fac_culture_6", slot_faction_troops_end, kingdom_6_troops_end),
            
            (faction_set_slot, "fac_culture_1", slot_faction_common_begin, "trp_swadian_light_infantry"),
            (faction_set_slot, "fac_culture_1", slot_faction_veteran_begin, "trp_swadian_pikeman"),
            (faction_set_slot, "fac_culture_1", slot_faction_elite_begin, "trp_swadian_sergeant"),
            (faction_set_slot, "fac_culture_1", slot_faction_noble_begin, "trp_swadian_noble"),
            
            (faction_set_slot, "fac_culture_2", slot_faction_common_begin, "trp_vaegir_light_infantry"),
            (faction_set_slot, "fac_culture_2", slot_faction_veteran_begin, "trp_vaegir_heavy_infantry"),
            (faction_set_slot, "fac_culture_2", slot_faction_elite_begin, "trp_vaegir_guard"),
            (faction_set_slot, "fac_culture_2", slot_faction_noble_begin, "trp_vaegir_royal_hussar"),
            
            (faction_set_slot, "fac_culture_3", slot_faction_common_begin, "trp_khergit_light_infantry"),
            (faction_set_slot, "fac_culture_3", slot_faction_veteran_begin, "trp_khergit_archer"),
            (faction_set_slot, "fac_culture_3", slot_faction_elite_begin, "trp_khergit_guard"),
            (faction_set_slot, "fac_culture_3", slot_faction_noble_begin, "trp_khergit_noble"),
            
            (faction_set_slot, "fac_culture_4", slot_faction_common_begin, "trp_nord_light_infantry"),
            (faction_set_slot, "fac_culture_4", slot_faction_veteran_begin, "trp_nord_medium_infantry"),
            (faction_set_slot, "fac_culture_4", slot_faction_elite_begin, "trp_nord_heavy_cavalry"),
            (faction_set_slot, "fac_culture_4", slot_faction_noble_begin, "trp_nord_noble_infantry"),
            
            (faction_set_slot, "fac_culture_5", slot_faction_common_begin, "trp_rhodok_light_infantry"),
            (faction_set_slot, "fac_culture_5", slot_faction_veteran_begin, "trp_rhodok_heavy_infantry"),
            (faction_set_slot, "fac_culture_5", slot_faction_elite_begin, "trp_rhodok_heavy_pikeman"),
            (faction_set_slot, "fac_culture_5", slot_faction_noble_begin, "trp_rhodok_noble"),
            
            (faction_set_slot, "fac_culture_6", slot_faction_common_begin, "trp_sarranid_medium_infantry"),
            (faction_set_slot, "fac_culture_6", slot_faction_veteran_begin, "trp_sarranid_guard"),
            (faction_set_slot, "fac_culture_6", slot_faction_elite_begin, "trp_sarranid_heavy_infantry"),
            (faction_set_slot, "fac_culture_6", slot_faction_noble_begin, "trp_sarranid_noble_horse_archer"),

            (faction_set_slot, "fac_culture_1", slot_faction_caravan_master, "trp_swadian_caravan_master"),
            (faction_set_slot, "fac_culture_2", slot_faction_caravan_master, "trp_vaegir_caravan_master"),
            (faction_set_slot, "fac_culture_3", slot_faction_caravan_master, "trp_khergit_caravan_master"),
            (faction_set_slot, "fac_culture_4", slot_faction_caravan_master, "trp_nord_caravan_master"),
            (faction_set_slot, "fac_culture_5", slot_faction_caravan_master, "trp_rhodok_caravan_master"),
            (faction_set_slot, "fac_culture_6", slot_faction_caravan_master, "trp_sarranid_caravan_master"),

            (faction_set_slot, "fac_culture_1", slot_faction_caravan_guard, "trp_swadian_caravan_guard"),
            (faction_set_slot, "fac_culture_2", slot_faction_caravan_guard, "trp_vaegir_caravan_guard"),
            (faction_set_slot, "fac_culture_3", slot_faction_caravan_guard, "trp_khergit_caravan_guard"),
            (faction_set_slot, "fac_culture_4", slot_faction_caravan_guard, "trp_nord_caravan_guard"),
            (faction_set_slot, "fac_culture_5", slot_faction_caravan_guard, "trp_rhodok_caravan_guard"),
            (faction_set_slot, "fac_culture_6", slot_faction_caravan_guard, "trp_sarranid_caravan_guard"),
            
            (faction_set_slot, "fac_culture_1", slot_faction_lord_name_begin, "str_kingdom_rank_0"),
            (faction_set_slot, "fac_culture_2", slot_faction_lord_name_begin, "str_kingdom_rank_0"),
            (faction_set_slot, "fac_culture_3", slot_faction_lord_name_begin, "str_khergit_rank_0"),
            (faction_set_slot, "fac_culture_4", slot_faction_lord_name_begin, "str_nord_rank_0"),
            (faction_set_slot, "fac_culture_5", slot_faction_lord_name_begin, "str_rhodok_rank_0"),
            (faction_set_slot, "fac_culture_6", slot_faction_lord_name_begin, "str_sarranid_rank_0"),

            (faction_set_slot, "fac_culture_1", slot_faction_lady_name_begin, "str_kingdom_rank_0_f"),
            (faction_set_slot, "fac_culture_2", slot_faction_lady_name_begin, "str_kingdom_rank_0_f"),
            (faction_set_slot, "fac_culture_3", slot_faction_lady_name_begin, "str_khergit_rank_0_f"),
            (faction_set_slot, "fac_culture_4", slot_faction_lady_name_begin, "str_nord_rank_0_f"),
            (faction_set_slot, "fac_culture_5", slot_faction_lady_name_begin, "str_rhodok_rank_0_f"),
            (faction_set_slot, "fac_culture_6", slot_faction_lady_name_begin, "str_sarranid_rank_0_f"),
            
            (faction_set_slot, "fac_culture_1", slot_faction_template_troops_begin, "trp_swadian_lord_template_0"),
            (faction_set_slot, "fac_culture_2", slot_faction_template_troops_begin, "trp_vaegir_lord_template_0"),
            (faction_set_slot, "fac_culture_3", slot_faction_template_troops_begin, "trp_khergit_lord_template_0"),
            (faction_set_slot, "fac_culture_4", slot_faction_template_troops_begin, "trp_nord_lord_template_0"),
            (faction_set_slot, "fac_culture_5", slot_faction_template_troops_begin, "trp_rhodok_lord_template_0"),
            (faction_set_slot, "fac_culture_6", slot_faction_template_troops_begin, "trp_sarranid_lord_template_0"),

            (faction_set_slot, "fac_culture_1", slot_faction_peasant_troop, "trp_swadian_peasant"),
            (faction_set_slot, "fac_culture_2", slot_faction_peasant_troop, "trp_vaegir_peasant"),
            (faction_set_slot, "fac_culture_3", slot_faction_peasant_troop, "trp_khergit_peasant"),
            (faction_set_slot, "fac_culture_4", slot_faction_peasant_troop, "trp_nord_peasant"),
            (faction_set_slot, "fac_culture_5", slot_faction_peasant_troop, "trp_rhodok_peasant"),
            (faction_set_slot, "fac_culture_6", slot_faction_peasant_troop, "trp_sarranid_peasant"),
            (faction_set_slot, "fac_culture_7", slot_faction_peasant_troop, "trp_common_peasant"),
            
            (faction_set_slot, "fac_culture_1", slot_faction_names_begin, swadian_names_begin),
            (faction_set_slot, "fac_culture_1", slot_faction_names_end, swadian_names_end),
            (faction_set_slot, "fac_culture_2", slot_faction_names_begin, vaegir_names_begin),
            (faction_set_slot, "fac_culture_2", slot_faction_names_end, vaegir_names_end),
            (faction_set_slot, "fac_culture_3", slot_faction_names_begin, khergit_names_begin),
            (faction_set_slot, "fac_culture_3", slot_faction_names_end, khergit_names_end),
            (faction_set_slot, "fac_culture_4", slot_faction_names_begin, nordic_names_begin),
            (faction_set_slot, "fac_culture_4", slot_faction_names_end, nordic_names_end),
            (faction_set_slot, "fac_culture_5", slot_faction_names_begin, rhodok_names_begin),
            (faction_set_slot, "fac_culture_5", slot_faction_names_end, rhodok_names_end),
            (faction_set_slot, "fac_culture_6", slot_faction_names_begin, sarranid_names_begin),
            (faction_set_slot, "fac_culture_6", slot_faction_names_end, sarranid_names_end),

            (faction_set_slot, "fac_culture_7", slot_faction_troops_begin, mercenaries_begin),
            (faction_set_slot, "fac_culture_7", slot_faction_troops_end, factional_mercenaries_begin),

            # For now, mercenaries do not share the same recruitment system as factional troops
            # (faction_set_slot, "fac_culture_7", slot_faction_common_begin, "trp_mercenary_light_infantry"),
            # (faction_set_slot, "fac_culture_7", slot_faction_veteran_begin, "trp_mercenary_infantry"),
            # (faction_set_slot, "fac_culture_7", slot_faction_elite_begin, "trp_mercenary_heavy_infantry"),
            # (faction_set_slot, "fac_culture_7", slot_faction_noble_begin, "trp_mercenary_knight"),

            # Rank names should not be relevant ?
            (faction_set_slot, "fac_culture_7", slot_faction_lord_name_begin, "str_kingdom_rank_0"),
            (faction_set_slot, "fac_culture_7", slot_faction_lady_name_begin, "str_kingdom_rank_0_f"),

            (faction_set_slot, "fac_culture_7", slot_faction_template_troops_begin, "trp_mercenary_lord_template_0"),

            # Names should not be relevant ?
            # (faction_set_slot, "fac_culture_7", slot_faction_names_begin, swadian_names_begin),
            # (faction_set_slot, "fac_culture_7", slot_faction_names_end, swadian_names_end),
        ]),
    
    # script_init_bandits
        # input: none
        # output: none
    ("init_bandits",
        [
            (faction_set_slot, "fac_faction_1", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_1", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_1", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_1", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_1", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_2", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_2", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_2", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_2", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_2", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_3", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_3", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_3", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_3", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_3", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_4", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_4", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_4", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_4", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_4", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_5", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_5", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_5", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_5", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_5", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_6", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_6", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_6", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_6", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_6", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_7", slot_faction_peasant_num_tries, 0),
            (faction_set_slot, "fac_faction_7", slot_faction_common_num_tries, -100),
            (faction_set_slot, "fac_faction_7", slot_faction_veteran_num_tries, 0),
            (faction_set_slot, "fac_faction_7", slot_faction_elite_num_tries, -100),
            (faction_set_slot, "fac_faction_7", slot_faction_noble_num_tries, -100),
            
            (faction_set_slot, "fac_faction_1", slot_faction_culture, "fac_faction_1"),
            (faction_set_slot, "fac_faction_2", slot_faction_culture, "fac_faction_2"),
            (faction_set_slot, "fac_faction_3", slot_faction_culture, "fac_faction_3"),
            (faction_set_slot, "fac_faction_4", slot_faction_culture, "fac_faction_4"),
            (faction_set_slot, "fac_faction_5", slot_faction_culture, "fac_faction_5"),
            (faction_set_slot, "fac_faction_6", slot_faction_culture, "fac_faction_6"),
            (faction_set_slot, "fac_faction_7", slot_faction_culture, "fac_faction_7"),
            
            (faction_set_slot, "fac_faction_1", slot_faction_troops_begin, "trp_bandit_forest_bandit"),
            (faction_set_slot, "fac_faction_1", slot_faction_common_begin, "trp_bandit_forest_warrior"),
            (faction_set_slot, "fac_faction_1", slot_faction_veteran_begin, "trp_bandit_forest_warrior"),
            (faction_set_slot, "fac_faction_1", slot_faction_elite_begin, "trp_bandit_forest_leader"),
            (faction_set_slot, "fac_faction_1", slot_faction_noble_begin, "trp_bandit_forest_leader"),
            (faction_set_slot, "fac_faction_1", slot_faction_troops_end, "trp_bandit_looter"),
            
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_infantry, 85),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_skirmisher, 30),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_shock_infantry, 60),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_archer, 85),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_crossbow, 70),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_cavalry, 20),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_lancer, 5),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_horse_archer, 25),
            (faction_set_slot, "fac_faction_1", slot_faction_troop_ratio_mounted_skirmisher, 10),
            
            (faction_set_slot, "fac_faction_2", slot_faction_troops_begin, "trp_bandit_looter"),
            (faction_set_slot, "fac_faction_2", slot_faction_common_begin, "trp_bandit_marauder"),
            (faction_set_slot, "fac_faction_2", slot_faction_veteran_begin, "trp_bandit_marauder"),
            (faction_set_slot, "fac_faction_2", slot_faction_elite_begin, "trp_bandit_leader"),
            (faction_set_slot, "fac_faction_2", slot_faction_noble_begin, "trp_bandit_leader"),
            (faction_set_slot, "fac_faction_2", slot_faction_troops_end, "trp_bandit_mountain_rider"),
            
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_infantry, 100),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_skirmisher, 10),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_shock_infantry, 55),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_archer, 20),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_crossbow, 40),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_cavalry, 25),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_lancer, 5),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_horse_archer, 15),
            (faction_set_slot, "fac_faction_2", slot_faction_troop_ratio_mounted_skirmisher, 5),
            
            (faction_set_slot, "fac_faction_3", slot_faction_troops_begin, "trp_bandit_mountain_rider"),
            (faction_set_slot, "fac_faction_3", slot_faction_common_begin, "trp_bandit_mountain_warrior"),
            (faction_set_slot, "fac_faction_3", slot_faction_veteran_begin, "trp_bandit_mountain_warrior"),
            (faction_set_slot, "fac_faction_3", slot_faction_elite_begin, "trp_bandit_mountain_chieftain"),
            (faction_set_slot, "fac_faction_3", slot_faction_noble_begin, "trp_bandit_mountain_chieftain"),
            (faction_set_slot, "fac_faction_3", slot_faction_troops_end, "trp_bandit_sea_raider"),
            
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_infantry, 80),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_skirmisher, 80),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_shock_infantry, 50),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_archer, 40),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_crossbow, 10),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_cavalry, 35),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_lancer, 10),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_horse_archer, 15),
            (faction_set_slot, "fac_faction_3", slot_faction_troop_ratio_mounted_skirmisher, 60),
            
            (faction_set_slot, "fac_faction_4", slot_faction_troops_begin, "trp_bandit_sea_raider"),
            (faction_set_slot, "fac_faction_4", slot_faction_common_begin, "trp_bandit_skull_crusher"),
            (faction_set_slot, "fac_faction_4", slot_faction_veteran_begin, "trp_bandit_skull_crusher"),
            (faction_set_slot, "fac_faction_4", slot_faction_elite_begin, "trp_bandit_sea_captain"),
            (faction_set_slot, "fac_faction_4", slot_faction_noble_begin, "trp_bandit_sea_captain"),
            (faction_set_slot, "fac_faction_4", slot_faction_troops_end, "trp_bandit_steppe_bandit"),
            
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_infantry, 100),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_skirmisher, 60),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_shock_infantry, 50),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_archer, 35),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_crossbow, 10),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_cavalry, 15),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_lancer, 5),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_horse_archer, 10),
            (faction_set_slot, "fac_faction_4", slot_faction_troop_ratio_mounted_skirmisher, 20),
            
            (faction_set_slot, "fac_faction_5", slot_faction_troops_begin, "trp_bandit_steppe_bandit"),
            (faction_set_slot, "fac_faction_5", slot_faction_common_begin, "trp_bandit_steppe_rider"),
            (faction_set_slot, "fac_faction_5", slot_faction_veteran_begin, "trp_bandit_steppe_rider"),
            (faction_set_slot, "fac_faction_5", slot_faction_elite_begin, "trp_bandit_steppe_chief"),
            (faction_set_slot, "fac_faction_5", slot_faction_noble_begin, "trp_bandit_steppe_chief"),
            (faction_set_slot, "fac_faction_5", slot_faction_troops_end, "trp_bandit_tundra_bandit"),
            
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_infantry, 45),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_spearman, 5),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_pikeman, 5),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_skirmisher, 50),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_shock_infantry, 20),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_archer, 35),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_cavalry, 100),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_lancer, 100),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_horse_archer, 100),
            (faction_set_slot, "fac_faction_5", slot_faction_troop_ratio_mounted_skirmisher, 80),
            
            (faction_set_slot, "fac_faction_6", slot_faction_troops_begin, "trp_bandit_tundra_bandit"),
            (faction_set_slot, "fac_faction_6", slot_faction_common_begin, "trp_bandit_taiga_bandit"),
            (faction_set_slot, "fac_faction_6", slot_faction_veteran_begin, "trp_bandit_taiga_bandit"),
            (faction_set_slot, "fac_faction_6", slot_faction_elite_begin, "trp_bandit_taiga_chieftain"),
            (faction_set_slot, "fac_faction_6", slot_faction_noble_begin, "trp_bandit_taiga_chieftain"),
            (faction_set_slot, "fac_faction_6", slot_faction_troops_end, "trp_bandit_desert_bandit"),
            
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_infantry, 70),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_skirmisher, 100),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_shock_infantry, 50),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_archer, 70),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_cavalry, 15),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_lancer, 5),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_horse_archer, 20),
            (faction_set_slot, "fac_faction_6", slot_faction_troop_ratio_mounted_skirmisher, 20),
            
            (faction_set_slot, "fac_faction_7", slot_faction_troops_begin, "trp_bandit_desert_bandit"),
            (faction_set_slot, "fac_faction_7", slot_faction_common_begin, "trp_bandit_desert_nomad"),
            (faction_set_slot, "fac_faction_7", slot_faction_veteran_begin, "trp_bandit_desert_nomad"),
            (faction_set_slot, "fac_faction_7", slot_faction_elite_begin, "trp_bandit_desert_chief"),
            (faction_set_slot, "fac_faction_7", slot_faction_noble_begin, "trp_bandit_desert_chief"),
            (faction_set_slot, "fac_faction_7", slot_faction_troops_end, bandits_end),
            
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_infantry, 75),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_spearman, 10),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_pikeman, 10),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_skirmisher, 80),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_shock_infantry, 50),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_archer, 40),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_crossbow, 5),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_cavalry, 80),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_lancer, 75),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_horse_archer, 50),
            (faction_set_slot, "fac_faction_7", slot_faction_troop_ratio_mounted_skirmisher, 90),

            # Make bandits enemies of every faction
            (try_for_range, ":bandit_faction", bandit_factions_begin, bandit_factions_end),
                (try_for_range, ":kingdom", kingdoms_begin, kingdoms_end),
                    (set_relation, ":kingdom", ":bandit_faction", -20),
                (try_end),
            (try_end),
            # Add some inter-bandit relations ?
            # Sea raiders enemy of tundra bandits
            (set_relation, "fac_faction_4", "fac_faction_6", -10),
            # Steppe bandits enemy of desert bandits
            (set_relation, "fac_faction_5", "fac_faction_7", -10),
            # Mountains bandits enemy of forest bandits
            (set_relation, "fac_faction_3", "fac_faction_1", -10),
            # Forest bandits enemy of steppe bandits
            (set_relation, "fac_faction_1", "fac_faction_3", -10),
            # Regular bandits enemy of desert bandits
            (set_relation, "fac_faction_2", "fac_faction_7", -10),
            # Mountain bandits enemy of tundra bandits
            (set_relation, "fac_faction_3", "fac_faction_6", -10),

            # Steppe bandits allies of tundra bandits
            (set_relation, "fac_faction_5", "fac_faction_6", 10),
            # Forest bandits allies of regular bandits
            (set_relation, "fac_faction_1", "fac_faction_2", 10),
            
            # (try_for_range, ":culture", "fac_faction_1", "fac_kingdom_1"),
                # (try_for_range, ":offset", 0, 5),
                    # (store_add, ":slot_beg", slot_faction_peasant_template_begin, ":offset"),
                    # (store_add, ":slot_end", slot_faction_peasant_template_end, ":offset"),
                    # (faction_slot_eq, ":culture", ":slot_end", 0),
                    # (val_add, ":slot_beg", 1),
                    # (faction_get_slot, ":value", ":culture", ":slot_beg"),
                    # (faction_set_slot, ":culture", ":slot_end", ":value"),
                # (try_end),
            # (try_end),
        ]),

    # script_cf_faction_can_declare_war
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        # output: none
        # fails if faction_1 cannot declare war to faction_2
    ("cf_faction_can_declare_war",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),

            (neq, ":faction_1", ":faction_2"),
            (faction_get_slot, ":faction_status", ":faction_1", slot_faction_status),
            (neq, ":faction_status", sfst_disabled),
            (faction_get_slot, ":faction_status", ":faction_2", slot_faction_status),
            (neq, ":faction_status", sfst_disabled),

            (call_script, "script_faction_get_treaties", ":faction_1", ":faction_2"),
            (assign, ":treaties", reg0),

            (store_and, ":alliance", ":treaties", sfkt_alliance),
            (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
            (store_and, ":vassal", ":treaties", sfkt_vassal),
            (store_and, ":overlord", ":treaties", sfkt_overlord),
            (store_and, ":truce", ":treaties", sfkt_truce),
            (store_and, ":non_aggression", ":treaties", sfkt_non_agression),

            (neq, ":alliance", sfkt_alliance),
            (neq, ":defensive", sfkt_defensive_alliance),
            (neq, ":vassal", sfkt_vassal),
            (neq, ":overlord", sfkt_overlord),
            (neq, ":truce", sfkt_truce),
            (neq, ":non_aggression", sfkt_non_agression),
        ]),

    # script_cf_faction_want_war
        # input:
        #   arg1: faction_no
        # output: none
        # fails if faction_no does not want to declare a war
    ("cf_faction_want_war",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),
            (store_and, ":is_vassal", ":vassal_type", sfvt_vassal),
            (neq, ":is_vassal", sfvt_vassal),

            (faction_get_slot, ":num_fiefs", ":faction_no", slot_faction_num_fiefs),
            (faction_get_slot, ":num_vassals_active", ":faction_no", slot_faction_num_vassals_active),
            (faction_get_slot, ":safety", ":faction_no", slot_faction_safety),

            (store_mul, ":threshold", ":num_fiefs", 75),
            (val_div, ":threshold", 100),

            (call_script, "script_faction_get_war_damage_penalty_score", ":faction_no"),
            (assign, ":war_damage", reg0),

            (store_sub, ":safety_difference", 100, ":safety"),
            (val_div, ":safety_difference", 5),
            (val_max, ":safety_difference", 0),
            (store_sub, ":min_war_damage", 20, ":safety_difference"),

            (faction_get_slot, ":safety", ":faction_no", slot_faction_safety),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_faction_name, s10, ":faction_no"),
                (assign, reg10, ":threshold"),
                (assign, reg11, ":num_vassals_active"),
                (assign, reg12, ":war_damage"),
                (assign, reg13, ":min_war_damage"),
                (assign, reg14, ":safety"),
                (display_message, "@{s10} checks for want_war {reg11}>{reg10} - {reg12}<{reg13} - {reg14}>25"),
            (try_end),

            (lt, ":war_damage", ":min_war_damage"),
            (gt, ":num_vassals_active", ":threshold"),
            (gt, ":safety", 25),


        ]),
    
    # script_faction_declare_war_to_faction
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: war_storage
        # output: none
    ("faction_declare_war_to_faction",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":war_storage", 3),
            
            # (set_relation, ":faction_1", ":faction_2", relation_state_war),
            
            (str_store_faction_name_link, s10, ":faction_1"),
            (str_store_faction_name_link, s11, ":faction_2"),
            (display_log_message, "@{s10} declaring war to {s11}", text_color_war),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),

            (assign, ":main_participant", 0),
            (try_begin),
                (eq, ":war_storage", -1),
                (call_script, "script_war_get_empty"),
                (assign, ":war_storage", reg0),
                (faction_set_slot, ":war_storage", slot_war_active, 1),

                (faction_set_slot, ":war_storage", slot_war_start_date, ":current_day"),
                (assign, ":main_participant", 1),
            (try_end),

            (call_script, "script_war_add_participant", ":war_storage", ":faction_1", swkp_aggressor, ":main_participant"),
            (call_script, "script_war_add_participant", ":war_storage", ":faction_2", swkp_defender, ":main_participant"),

            (call_script, "script_faction_political_event_war_declared", ":faction_1", ":faction_2", ":war_storage"),

            (call_script, "script_faction_clear_treaty", ":faction_1", ":faction_2", sfkt_all_treaty_clear),
            
            (try_begin),
                (eq, ":main_participant", 1),
                (call_script, "script_update_faction_war_count"),

                (try_for_range, ":faction_1", kingdoms_begin, kingdoms_end),
                    (call_script, "script_faction_is_war_participant", ":faction_1", ":war_storage"),
                    (assign, ":relation", reg0),
                    (neq, ":relation", swkp_bystander),
                    (store_add, ":begin", ":faction_1", 1),
                    (try_for_range, ":faction_2", ":begin", kingdoms_end),
                        (call_script, "script_faction_is_war_participant", ":faction_2", ":war_storage"),
                        (neq, reg0, swkp_bystander),
                        (neq, reg0, ":relation"),
                        (call_script, "script_faction_reset_relations", ":faction_1", ":faction_2"),
                    (try_end),
                (try_end),
            (try_end),

            # Update last peace time
            (faction_get_slot, ":num_wars_1", ":faction_1", slot_faction_is_at_war),
            (try_begin),
                (le, ":num_wars_1", 0),
                (faction_set_slot, ":faction_1", slot_faction_last_peace, ":current_day"),
            (try_end),
            (faction_get_slot, ":num_wars_2", ":faction_2", slot_faction_is_at_war),
            (try_begin),
                (le, ":num_wars_2", 0),
                (faction_set_slot, ":faction_2", slot_faction_last_peace, ":current_day"),
            (try_end),
        ]),

    # script_faction_join_war
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        #   arg3: participant_side
        # output: none
    ("faction_join_war",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),
            (store_script_param, ":participant_side", 3),

            (call_script, "script_war_add_participant",  ":war_storage", ":faction_no", ":participant_side", -1),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            # Update last peace time
            (faction_get_slot, ":num_wars", ":faction_no", slot_faction_is_at_war),
            (try_begin),
                (le, ":num_wars", 0),
                (faction_set_slot, ":faction_no", slot_faction_last_peace, ":current_day"),
            (try_end),
        ]),

    # script_update_faction_war_count
        # input: none
        # output: none
    ("update_faction_war_count",
        [
            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (faction_set_slot, ":faction_no", slot_faction_is_at_war, 0),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction),
                (display_message, "@Recalculating factions war count"),
            (try_end),

            (try_for_range, ":war_storage", war_storages_begin, war_storages_end),
                (faction_slot_eq, ":war_storage", slot_war_active, 1),
                (faction_slot_eq, ":war_storage", slot_war_ended, 0),
                (try_for_range, ":slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),
                    (store_sub, ":offset", ":slot", slot_war_kingdom_participant_begin),
                    (store_add, ":faction_no", ":offset", kingdoms_begin),
                    (neg|faction_slot_eq, ":war_storage", ":slot", swkp_bystander),

                    (faction_get_slot, ":num_wars", ":faction_no", slot_faction_is_at_war),
                    (val_add, ":num_wars", 1),
                    (faction_set_slot, ":faction_no", slot_faction_is_at_war, ":num_wars"),
                (try_end),
            (try_end),
        ]),
    
    # script_faction_make_peace_to_faction
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        # output: none
    ("faction_make_peace_to_faction",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),

            (store_script_param, ":storage", 3),

            (try_begin),
                (le, ":storage", 0),
                (call_script, "script_war_find_from_participants", ":faction_1", ":faction_2"),
                (assign, ":storage", reg0),
            (try_end),

            (call_script, "script_get_current_day"),
            (assign, ":days", reg0),
            (store_add, ":truce_duration", ":days", 365 * 10),

            (try_begin),
                (is_between, ":storage", war_storages_begin, war_storages_end),

                (faction_set_slot, ":storage", slot_war_ended, 1),

                (try_for_range, ":participant_slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),
                    (faction_get_slot, ":participant", ":storage", ":participant_slot"),
                    (neq, ":participant", swkp_bystander),

                    (store_sub, ":offset", ":participant_slot", slot_war_kingdom_participant_begin),
                    (store_add, ":faction_participant", ":offset", kingdoms_begin),

                    (try_for_range, ":other_participant_slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),
                        (neq, ":participant_slot", ":other_participant_slot"),
                        (faction_get_slot, ":other_participant", ":storage", ":other_participant_slot"),
                        (neq, ":other_participant", swkp_bystander),

                        (store_sub, ":other_offset", ":other_participant_slot", slot_war_kingdom_participant_begin),
                        (store_add, ":other_faction_participant", ":other_offset", kingdoms_begin),

                        (try_begin),
                            (lt, ":other_participant", swkp_bystander),
                            (gt, ":participant", swkp_bystander),
                            (call_script, "script_faction_reset_relations", ":faction_participant", ":other_faction_participant"),

                            (call_script, "script_faction_create_temporary_treaty", ":faction_participant", ":other_faction_participant", sfkt_truce, ":truce_duration", 0),

                            (try_begin),
                                (call_script, "script_cf_debug", debug_war),
                                (str_store_faction_name, s10, ":faction_participant"),
                                (str_store_faction_name, s11, ":other_faction_participant"),
                                (display_message, "@Set relations between {s10} and {s11} as neutral"),
                            (try_end),
                        (else_try),
                            (gt, ":other_participant", swkp_bystander),
                            (lt, ":participant", swkp_bystander),
                            (call_script, "script_faction_reset_relations", ":faction_participant", ":other_faction_participant"),
                            
                            (call_script, "script_faction_create_temporary_treaty", ":faction_participant", ":other_faction_participant", sfkt_truce, ":truce_duration", 0),

                            (try_begin),
                                (call_script, "script_cf_debug", debug_war),
                                (str_store_faction_name, s10, ":faction_participant"),
                                (str_store_faction_name, s11, ":other_faction_participant"),
                                (display_message, "@Set relations between {s10} and {s11} as neutral"),
                            (try_end),
                        (try_end),
                    (try_end),

                    (try_begin),
                        (neq, ":participant", swkp_bystander),

                        (faction_get_slot, ":num_wars_1", ":faction_participant", slot_faction_is_at_war),
                        (val_add, ":num_wars_1", -1),
                        (faction_set_slot, ":faction_participant", slot_faction_is_at_war, ":num_wars_1"),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # script_war_clear_center_occupation
        # input:
        #   arg1: war_storage
        # output: none
    ("war_clear_center_occupation",
        [
            (store_script_param, ":war_storage", 1),

            (try_for_range, ":center_no", centers_begin, centers_end),
                (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                (store_faction_of_party, ":current_faction", ":center_no"),
                (neq, ":center_faction", ":current_faction"),
                (assign, ":has_aggressor", 0),
                (assign, ":has_defender", 0),
                (try_for_range, ":slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),
                    (store_sub, ":offset", ":slot", slot_war_kingdom_participant_begin),
                    (store_add, ":slot_faction", ":offset", kingdoms_begin),
                    (faction_get_slot, ":participant", ":war_storage", ":slot"),
                    (neq, ":participant", swkp_bystander),
                    (try_begin),
                        (eq, ":current_faction", ":slot_faction"),
                        (assign, ":has_aggressor", ":slot_faction"),
                    (else_try),
                        (eq, ":center_faction", ":slot_faction"),
                        (assign, ":has_defender", ":slot_faction"),
                    (try_end),
                (try_end),
                (neq, ":has_aggressor", 0),
                (neq, ":has_defender", 0),

                (call_script, "script_center_evacuate", ":center_no"),

                (call_script, "script_center_change_current_faction", ":center_no", ":has_defender", ":has_aggressor"),
            (try_end),
        ]),

    # script_center_evacuate
        # input:
        #   arg1: center_no
        # output: none
    ("center_evacuate",
        [
            (store_script_param, ":party_no", 1),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (faction_get_slot, ":leader", ":party_faction", slot_faction_leader),
            (assign, ":capital", -1),
            (try_begin),
                (ge, ":leader", 0),
                (call_script, "script_troop_get_current_home", ":leader", 1),
                (assign, ":leader_home", reg0),
                (is_between, ":leader_home", walled_centers_begin, walled_centers_end),
                (store_faction_of_party, ":leader_home_faction", ":leader_home"),
                (eq, ":leader_home_faction", ":party_faction"),
                (assign, ":capital", ":leader_home"),
            (try_end),

            (assign, ":num_shares", 0),

            (try_for_range, ":center", walled_centers_begin, walled_centers_end),
                (party_get_slot, ":center_faction", ":center", slot_party_faction),
                (store_faction_of_party, ":center_current_faction", ":center"),
                (eq, ":center_faction", ":center_current_faction"),
                (eq, ":party_faction", ":center_faction"),

                (party_get_slot, ":center_type", ":center", slot_party_type),
                (assign, ":center_shares", -1),
                (try_begin),
                    (eq, ":center_type", spt_town),
                    (val_add, ":center_shares", 3),
                (else_try),
                    (eq, ":center_type", spt_castle),
                    (val_add, ":center_shares", 1),
                (try_end),

                (store_distance_to_party_from_party, ":distance", ":party_no", ":center"),
                (try_begin),
                    (lt, ":distance", 30),
                    (val_add, ":center_shares", 2),
                (else_try),
                    (lt, ":distance", 60),
                    (val_add, ":center_shares", 1),
                (try_end),

                (try_begin),
                    (eq, ":center", ":capital"),
                    (val_add, ":center_shares", 1),
                (try_end),

                (gt, ":center_shares", 0),
                (val_add, ":num_shares", ":center_shares"),
            (try_end),

            (try_begin),
                (gt, ":num_shares", 0),
                (party_get_num_companions, ":total_number", ":party_no"),
                (store_div, ":share_part", ":total_number", ":num_shares"),
                (val_add, ":share_part", 1), # We add 1 to make sure there are no remaining troops in the center

                (try_for_range, ":center", walled_centers_begin, walled_centers_end),
                    (party_get_slot, ":center_faction", ":center", slot_party_faction),
                    (store_faction_of_party, ":center_current_faction", ":center"),
                    (eq, ":center_faction", ":center_current_faction"),
                    (eq, ":party_faction", ":center_faction"),

                    (party_get_slot, ":center_type", ":center", slot_party_type),
                    (assign, ":center_shares", -1),
                    (try_begin),
                        (eq, ":center_type", spt_town),
                        (val_add, ":center_shares", 3),
                    (else_try),
                        (eq, ":center_type", spt_castle),
                        (val_add, ":center_shares", 1),
                    (try_end),

                    (store_distance_to_party_from_party, ":distance", ":party_no", ":center"),
                    (try_begin),
                        (lt, ":distance", 30),
                        (val_add, ":center_shares", 2),
                    (else_try),
                        (lt, ":distance", 60),
                        (val_add, ":center_shares", 1),
                    (try_end),

                    (try_begin),
                        (eq, ":center", ":capital"),
                        (val_add, ":center_shares", 1),
                    (try_end),

                    (gt, ":center_shares", 0),
                    (store_mul, ":num_troops", ":center_shares", ":share_part"),
                    (call_script, "script_party_send_troops", ":party_no", ":center", ":num_troops"),
                (try_end),
            (try_end),
        ]),

    # script_war_get_empty
        # input: none
        # output:
        #   reg0: war_storage
    ("war_get_empty",
        [
            (assign, ":selected", 0),
            (assign, ":end", war_storages_end),
            (try_for_range, ":war", war_storages_begin, ":end"),
                (faction_slot_eq, ":war", slot_war_active, 0),
                (assign, ":selected", ":war"),
                (assign, ":end", war_storages_begin),
            (try_end),
            (assign, reg0, ":selected"),
        ]),

    # script_war_add_participant
        # input:
        #   arg1: war_storage
        #   arg2: faction_no
        #   arg3: participant_side (attacker/defender)
        #   arg4: is_main_participant
        # output: none
    ("war_add_participant",
        [
            (store_script_param, ":war_storage", 1),
            (store_script_param, ":faction_no", 2),
            (store_script_param, ":participant_side", 3),
            (store_script_param, ":main_participant", 4),

            (assign, ":added", 0),

            (store_sub, ":offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),
            (try_begin),
                (is_between, ":slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),

                (try_begin),
                    (eq, ":main_participant", 1),
                    (eq, ":participant_side", swkp_defender),
                    (assign, ":participant_side", swkp_main_defender),
                (else_try),
                    (eq, ":main_participant", 1),
                    (eq, ":participant_side", swkp_aggressor),
                    (assign, ":participant_side", swkp_main_aggressor),
                (try_end),

                (faction_get_slot, ":current_side", ":war_storage", ":slot"),
                (try_begin),
                    (eq, ":current_side", swkp_bystander),
                    (faction_set_slot, ":war_storage", ":slot", ":participant_side"),
                    (assign, ":added", 1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war),
                        (str_store_faction_name, s10, ":faction_no"),
                        (assign, reg10, ":war_storage"),
                        (assign, reg11, ":participant_side"),
                        (display_message, "@Adding war participant {s10} to storage {reg10} (as {reg11})"),
                    (try_end),
                (try_end),
            (else_try),
                (display_message, "@ERROR -- incorrect war participant", text_color_impossible),
            (try_end),
            (assign, reg0, ":added"),
        ]),

    # script_cf_war_remove_participant
        # input:
        #   arg1: war_storage
        #   arg2: faction_no
        # output: fails if not a participant
    ("cf_war_remove_participant",
        [
            (store_script_param, ":war_storage", 1),
            (store_script_param, ":faction_no", 2),

            (store_sub, ":offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),

            (faction_get_slot, ":current_side", ":war_storage", ":slot"),
            (neq, ":current_side", swkp_bystander),
            (faction_set_slot, ":war_storage", ":slot", swkp_bystander),

            (assign, ":has_defender", 0),
            (assign, ":has_attacker", 0),
            (assign, ":has_main_attacker", 0),
            (assign, ":has_main_defender", 0),
            (try_for_range, ":kingdom", kingdoms_begin, kingdoms_end),
                (store_sub, ":offset", ":kingdom", kingdoms_begin),
                (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),

                (faction_get_slot, ":participant", ":war_storage", ":slot"),

                (try_begin),
                    (gt, ":current_side", swkp_bystander),
                    (lt, ":participant", swkp_bystander),

                    (call_script, "script_faction_reset_relations", ":faction_no", ":kingdom"),
                (else_try),
                    (lt, ":current_side", swkp_bystander),
                    (gt, ":participant", swkp_bystander),

                    (call_script, "script_faction_reset_relations", ":faction_no", ":kingdom"),
                (try_end),

                (try_begin),
                    (gt, ":participant", swkp_bystander),
                    (assign, ":has_attacker", 1),
                (else_try),
                    (lt, ":participant", swkp_bystander),
                    (assign, ":has_defender", 1),
                (try_end),
                (try_begin),
                    (eq, ":participant", swkp_main_aggressor),
                    (assign, ":has_main_attacker", 1),
                (else_try),
                    (eq, ":participant", swkp_main_defender),
                    (assign, ":has_main_defender", 1),
                (try_end),
            (try_end),
            (try_begin),
                (this_or_next|eq, ":has_attacker", 0),
                (eq, ":has_defender", 0),

                (call_script, "script_war_clean", ":war_storage"),
                (call_script, "script_update_faction_war_count"),
            (else_try),
                (try_begin),
                    (eq, ":has_main_attacker", 0),
                    (call_script, "script_war_assign_main_participant", ":war_storage", swkp_aggressor),
                (try_end),
                (try_begin),
                    (eq, ":has_main_defender", 0),
                    (call_script, "script_war_assign_main_participant", ":war_storage", swkp_defender),
                (try_end),
            (try_end),
        ]),

    # script_war_assign_main_participant
        # input:
        #   arg1: war_storage
        #   arg2: participant
        # output: none
    ("war_assign_main_participant",
        [
            (store_script_param, ":war_storage", 1),
            (store_script_param, ":participant", 2),

            (assign, ":new_participant", swkp_bystander),
            (try_begin),
                (eq, ":participant", swkp_defender),
                (assign, ":new_participant", swkp_main_defender),
            (else_try),
                (eq, ":participant", swkp_aggressor),
                (assign, ":new_participant", swkp_main_aggressor),
            (try_end),

            (assign, ":end", kingdoms_end),

            (try_for_range, ":kingdom", kingdoms_begin, ":end"),
                (store_sub, ":offset", ":kingdom", kingdoms_begin),
                (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),

                (faction_get_slot, ":current_participant", ":war_storage", ":slot"),
                (eq, ":current_participant", ":participant"),
                (assign, ":end", kingdoms_begin),
                (faction_set_slot, ":war_storage", ":slot", ":new_participant"),
            (try_end),
        ]),

    # script_war_clean
        # input:
        #   arg1: war_storage
        # output: none
    ("war_clean",
        [
            (store_script_param, ":war_storage", 1),

            (call_script, "script_war_clear_center_occupation", ":war_storage"),

            (try_for_range, ":slot", slot_war_clear_slots_begin, slot_war_clear_slots_end),
                (faction_set_slot, ":war_storage", ":slot", 0),
            (try_end),

            (try_for_range, ":slot", slot_war_kingdom_participant_begin, slot_war_kingdom_participant_end),
                (faction_set_slot, ":war_storage", ":slot", swkp_bystander),
            (try_end),
        ]),

    # script_war_find_from_participants
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        # output:
        #   reg0: war_storage
    ("war_find_from_participants",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),

            (store_sub, ":offset_1", ":faction_1", kingdoms_begin),
            (store_sub, ":offset_2", ":faction_2", kingdoms_begin),
            (store_add, ":slot_1", ":offset_1", slot_war_kingdom_participant_begin),
            (store_add, ":slot_2", ":offset_2", slot_war_kingdom_participant_begin),

            (assign, ":result", -1),
            (assign, ":end", war_storages_end),
            (try_for_range, ":war_storage", war_storages_begin, ":end"),
                (faction_get_slot, ":storage_1", ":war_storage", ":slot_1"),
                (faction_get_slot, ":storage_2", ":war_storage", ":slot_2"),

                (try_begin),
                    (eq, ":storage_1", swkp_main_aggressor),
                    (eq, ":storage_2", swkp_main_defender),

                    (assign, ":result", ":war_storage"),
                (else_try),
                    (eq, ":storage_1", swkp_main_defender),
                    (eq, ":storage_2", swkp_main_aggressor),

                    (assign, ":result", ":war_storage"),
                (try_end),
            (try_end),
            (assign, reg0, ":result"),
        ]),
    
    # script_faction_set_random_relation_with_faction
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: relation
    ("faction_set_random_relation_with_faction",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":relation", 3),

            (store_sub, ":lower_limit", ":relation", 25),
            (store_add, ":upper_limit", ":relation", 25 + 1),

            (store_random_in_range, ":new_relation_1", ":lower_limit", ":upper_limit"),
            (store_random_in_range, ":new_relation_2", ":lower_limit", ":upper_limit"),

            (call_script, "script_faction_set_relation_with_faction", ":faction_1", ":faction_2", ":new_relation_1"),
            (call_script, "script_faction_set_relation_with_faction", ":faction_2", ":faction_1", ":new_relation_2"),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction|debug_simple),
                (str_store_faction_name, s10, ":faction_1"),
                (str_store_faction_name, s11, ":faction_2"),
                (assign, reg10, ":new_relation_1"),
                (assign, reg10, ":new_relation_2"),
                (display_message, "@{s10}/{s11} now has a relation of {reg10}/{reg11}"),
            (try_end),
        ]),
    
    # script_troop_change_level
        # input:
        #   arg1: troop_no
        #   arg2: new_rank
        # output: none
    ("troop_change_level",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":new_rank", 2),
            
            (troop_get_slot, ":culture", ":troop_no", slot_troop_culture),
            
            (faction_get_slot, ":template_troop", ":culture", slot_faction_template_troops_begin),
            
            (val_clamp, ":new_rank", 0, 8),
            
            (troop_set_slot, ":troop_no", slot_troop_level, ":new_rank"),
            
            (store_add, ":stats_troop", ":template_troop", ":new_rank"),
            
            # New stats
            (call_script, "script_troop_change_stat_with_template", ":troop_no", ":stats_troop"),
            
            # ToDo: pay for equipement upgrade
            # Removing old equipment
            (try_for_range, ":equip_slot", ek_item_0, ek_food),
                (troop_get_inventory_slot, ":item", ":troop_no", ":equip_slot"),
                (gt, ":item", 0),
                (troop_remove_item, ":troop_no", ":item"),
            (try_end),
            # Following does not remove equipped items
            (troop_clear_inventory, ":troop_no"),
            
            (call_script, "script_troop_get_equipement_level", ":troop_no"),
            (assign, ":equipement_level", reg0),
            
            (troop_set_slot, ":troop_no", slot_troop_equipement_level, ":equipement_level"),
            
            (store_add, ":equipement_template", ":template_troop", ":equipement_level"),
            # New equipments
            (call_script, "script_troop_change_equipement_with_template", ":troop_no", ":equipement_template"),
            (troop_equip_items, ":troop_no"),
        ]),
    
    # script_troop_get_equipement_level
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: level
    ("troop_get_equipement_level",
        [
            (store_script_param, ":troop_no", 1),
            
            (store_troop_faction, ":faction", ":troop_no"),
            (faction_get_slot, ":era", ":faction", slot_faction_era),
            
            (troop_get_slot, ":level", ":troop_no", slot_troop_level),
            
            (try_begin),
                (le, ":era", 1),
                (val_sub, ":level", 2),
                (val_min, ":level", 4),
            (else_try),
                (le, ":era", 4),
                # Everyone has -1 except king and marshall who get -2
                (val_mul, ":level", 12),
                (val_div, ":level", 15),
            (else_try),
                (le, ":era", 5),
                (val_sub, ":level", 1),
            (try_end),
            (val_max, ":level", 0),
            
            (assign, reg0, ":level"),
        ]),
    
    # script_troop_update_name
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_update_name",
        [
            (store_script_param, ":troop_no", 1),

            (try_begin),
                (eq, ":troop_no", "$g_player_troop"),
                (eq, "$g_player_update_name", 0),
            (else_try),
            
                (store_troop_faction, ":faction", ":troop_no"),
                (faction_get_slot, ":culture", ":faction", slot_faction_culture),
                (troop_get_slot, ":new_rank", ":troop_no", slot_troop_rank),
                
                (faction_get_slot, ":faction_name_begin", ":culture", slot_faction_lord_name_begin),
                (store_add, ":lord_name", ":faction_name_begin", ":new_rank"),
                (str_store_troop_name_plural, s0, ":troop_no"),
                
                (troop_get_slot, ":party", ":troop_no", slot_troop_leaded_party),
                (try_begin),
                    (gt, ":party", 0),
                    (party_slot_eq, ":party", slot_party_type, spt_war_party),
                    (str_store_string, s10, ":lord_name"),
                    (party_set_name, ":party", "@{s10}'s Party"),
                (try_end),
                
                (troop_set_name, ":troop_no", ":lord_name"),
            (try_end),
        ]),
    
    # script_troop_change_stat_with_template
        # input:
        #   arg1: troop_no
        #   arg2: template
        # output: none
    ("troop_change_stat_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            (try_for_range, ":stat", ca_strength, ca_charisma + 1),
                (store_attribute_level, ":template_stat", ":template", ":stat"),
                (store_attribute_level, ":troop_stat", ":troop_no", ":stat"),
                
                (store_sub, ":difference", ":template_stat", ":troop_stat"),
                (troop_raise_attribute, ":troop_no", ":stat", ":difference"),
            (try_end),
            
            (try_for_range, ":skill", skl_trade, skl_reserved_15), # Do we need to go through all skills?
                (store_skill_level, ":template_skill", ":skill", ":template"),
                (store_skill_level, ":troop_skill", ":skill", ":troop_no"),
                
                (store_sub, ":difference", ":template_skill", ":troop_skill"),
                (troop_raise_skill, ":troop_no", ":skill", ":difference"),
            (try_end),
            
            (try_for_range, ":wp", wpt_one_handed_weapon, wpt_firearm),
                (store_proficiency_level, ":template_wp", ":template", ":wp"),
                (store_proficiency_level, ":troop_wp", ":troop_no", ":wp"),
                
                (store_sub, ":difference", ":template_wp", ":troop_wp"),
                (troop_raise_proficiency_linear, ":troop_no", ":wp", ":difference"),
            (try_end),
        ]),
    
    # script_troop_change_equipement_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output: none
    ("troop_change_equipement_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            # (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            # (assign, ":horse", reg0),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_primary_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_secondary_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_head_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_feet_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_body_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_hands_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_horse_with_template", ":troop_no", ":template"),
            
            (troop_clear_inventory, "trp_temp_equipement_troop"),
            (call_script, "script_troop_change_equipement_shield_with_template", ":troop_no", ":template"),
        ]),
        
    # script_troop_change_equipement_primary_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_primary_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
                    (eq, ":item_type", itp_type_two_handed_wpn),
                    (assign, ":continue", 1),
                (else_try),
                    (eq, ":item_type", itp_type_polearm),
                    (try_begin),
                        (ge, ":horse", 1),
                        (neg|is_between, ":cur_item", "itm_long_bardiche", "itm_torch"),
                        (neg|is_between, ":cur_item", "itm_bamboo_spear", "itm_hafted_blade_a"),
                        (assign, ":continue", 1),
                    (else_try),
                        (eq, ":horse", 0),
                        (is_between, ":cur_item", "itm_long_bardiche", "itm_torch"),
                        (assign, ":continue", 1),
                    (try_end),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_secondary_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    #   reg1: item_added_2
    ("troop_change_equipement_secondary_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                
                (try_begin),
                    # (eq, ":item_type", itp_type_polearm),
                    (eq, ":equip_type", tle_polearm),
                    (ge, ":horse", 1),
                    (is_between, ":cur_item", "itm_bamboo_spear", "itm_hafted_blade_a"),
                    (assign, ":continue", 1),
                (else_try),
                    (eq, ":item_type", itp_type_bow),
                    (try_begin),
                        (eq, ":equip_type", tle_light_bow),
                        (assign, ":continue", 1),
                    (else_try),
                        (eq, ":equip_type", tle_heavy_bow),
                        (assign, ":continue", 1),
                    (try_end),
                    (eq, ":continue", 1),
                    (call_script, "script_troop_take_first_troop_equipement_of_type", ":troop_no", ":template", itp_type_arrows),
                    (assign, reg1, reg0),
                (else_try),
                    (eq, ":item_type", itp_type_crossbow),
                    (try_begin),
                        (eq, ":equip_type", tle_light_crossbow),
                        (this_or_next|eq, ":cur_item", "itm_hunting_crossbow"),
                        (eq, ":cur_item", "itm_light_crossbow"),
                        (assign, ":continue", 1),
                    (else_try),
                        (eq, ":equip_type", tle_heavy_crossbow),
                        (is_between, ":cur_item", "itm_crossbow", "itm_items_end"),
                        (assign, ":continue", 1),
                    (try_end),
                    (eq, ":continue", 1),
                    (call_script, "script_troop_take_first_troop_equipement_of_type", ":troop_no", ":template", itp_type_bolts),
                    (assign, reg1, reg0),
                (else_try),
                    (eq, ":item_type", itp_type_thrown),
                    (eq, ":equip_type", tle_throwing),
                    (assign, ":continue", 1),
                (try_end),
                
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_head_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_head_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            # (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            # (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_head_armor),
                    (assign, ":continue", 1),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_feet_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_feet_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            # (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            # (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_foot_armor),
                    (assign, ":continue", 1),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_body_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_body_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            # (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            # (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_body_armor),
                    (assign, ":continue", 1),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_hands_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_hands_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            # (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            # (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_hand_armor),
                    (assign, ":continue", 1),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_horse_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_horse_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_horse),
                    (ge, ":horse", 1),
                    (assign, ":continue", 1),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
        ]),
    
    # script_troop_change_equipement_shield_with_template
    # input:
    #   arg1: troop_no
    #   arg2: template
    # output:
    #   reg0: item_added
    ("troop_change_equipement_shield_with_template",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            # (troop_get_slot, ":equip_type", ":troop_no", slot_troop_lord_equipement),
            (call_script, "script_troop_get_lord_horse_slot", ":troop_no"),
            (assign, ":horse", reg0),
            
            (troop_get_inventory_capacity, ":num_slots", ":template"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":item_type", itp_type_shield),
                    (try_begin),
                        (is_between, ":cur_item", "itm_tab_shield_kite_a", "itm_tab_shield_pavise_a"),
                        (gt, ":horse", 0),
                    (else_try),
                        (is_between, ":cur_item", "itm_tab_shield_heater_cav_a", "itm_stones"),
                        (lt, ":horse", 1),
                    (else_try),
                        (assign, ":continue", 1),
                    (try_end),
                (try_end),
                (eq, ":continue", 1),
                (troop_add_item, "trp_temp_equipement_troop", ":cur_item", 0),
            (try_end),
            (call_script, "script_troop_take_random_troop_equipement", ":troop_no", "trp_temp_equipement_troop"),
            # Shields are not added if they are not of the right kind
            # As a side note, rhodok pavise shield is considered an infantry and cavalry shield
            # this is made so that rhodok lords will use them most of the time even if mounted
        ]),
    
    # script_troop_take_random_troop_equipement
        # input:
        #   arg1: troop_no
        #   arg2: template_troop
        # output:
        #   reg0: item_added
    ("troop_take_random_troop_equipement",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":temp_troop", 2),
            
            (assign, ":item", -1),
            
            (assign, ":num_items", 0),
            (troop_get_inventory_capacity, ":num_slots", ":temp_troop"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":temp_troop", ":i_slot"),
                (gt, ":cur_item", 0),
                (val_add, ":num_items", 1),
            (try_end),
            
            (store_random_in_range, ":random", 0, ":num_items"),
            
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":temp_troop", ":i_slot"),
                (gt, ":cur_item", 0),
                (try_begin),
                    (eq, ":random", 0),
                    (assign, ":item", ":cur_item"),
                    (troop_add_item, ":troop_no", ":cur_item", 0),
                    (assign, ":num_slots", 0),
                (try_end),
                (val_add, ":random", -1),
            (try_end),
            
            (assign, reg0, ":item"),
        ]),
    
    # script_troop_take_first_troop_equipement_of_type
        # input:
        #   arg1: troop_no
        #   arg2: template_troop
        #   arg3: item_type
        # output:
        #   reg0: item_added
    ("troop_take_first_troop_equipement_of_type",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":temp_troop", 2),
            (store_script_param, ":item_type", 3),
            
            (assign, ":found", 0),
            (troop_get_inventory_capacity, ":num_slots", ":temp_troop"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":temp_troop", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":cur_item_type", ":cur_item"),
                (eq, ":cur_item_type", ":item_type"),
                (troop_add_item, ":troop_no", ":cur_item", 0),
                (assign, ":num_slots", 0),
                (assign, ":found", ":cur_item"),
            (try_end),
            
            (assign, reg0, ":found"),
        ]),
    
    # script_troop_take_random_troop_equipement_of_type
        # input:
        #   arg1: troop_no
        #   arg2: template_troop
        #   arg3: item_type
        # output:
        #   reg0: item_added
    ("troop_take_random_troop_equipement_of_type",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":temp_troop", 2),
            (store_script_param, ":item_type", 3),
            
            (assign, ":found", 0),
            (troop_get_inventory_capacity, ":num_slots", ":temp_troop"),
            (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                (troop_get_inventory_slot, ":cur_item", ":temp_troop", ":i_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":cur_item_type", ":cur_item"),
                (eq, ":cur_item_type", ":item_type"),
                (val_add, ":found", 1),
            (try_end),
            
            (try_begin),
                (gt, ":found", 0),
                (store_random_in_range, ":random_equipement", 0, ":found"),
                
                (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                    (troop_get_inventory_slot, ":cur_item", ":temp_troop", ":i_slot"),
                    (gt, ":cur_item", 0),
                    (item_get_type, ":cur_item_type", ":cur_item"),
                    (eq, ":cur_item_type", ":item_type"),
                    
                    (try_begin),
                        (eq, ":random_equipement", 0),
                        (assign, ":found", ":cur_item"),
                        (troop_add_item, ":troop_no", ":cur_item", 0),
                        (assign, ":num_slots", 0),
                    (else_try),
                        (val_add, ":random_equipement", -1),
                    (try_end),
                (try_end),
            (try_end),
            
            (assign, reg0, ":found"),
        ]),

    # script_party_get_prefered_wages_limit
        # input:
        #   arg1: party_no
        # output:
        #   reg0: wanted_wages
        #   reg1: min_prefered_wages
        #   reg2: max_prefered_wages
    ("party_get_prefered_wages_limit",
        [
            (store_script_param, ":party_no", 1),

            (assign, ":wanted_wages", 0),
            (assign, ":tolerance_min", 80),
            (assign, ":tolerance_max", 125),

            (try_begin),
                (is_between, ":party_no", centers_begin, centers_end),
                (party_get_slot, ":lord", ":party_no", slot_party_lord),
                (eq, ":lord", "$g_player_troop"),
                (party_get_slot, ":wanted_wages", ":party_no", slot_party_player_wages_limit),
                (ge, ":wanted_wages", 0),
            (else_try),
                (assign, ":at_war", 0),
                (assign, ":preparing_for_war", 0),
                (try_begin),
                    (store_faction_of_party, ":party_faction", ":party_no"),
                    (gt, ":party_faction", 0),
                    (faction_get_slot, ":at_war", ":party_faction", slot_faction_is_at_war),
                    (faction_get_slot, ":preparing_for_war", ":party_faction", slot_faction_preparing_war),
                (try_end),

                (party_get_slot, ":party_type", ":party_no", slot_party_type),
                (try_begin),
                    (eq, ":party_type", spt_war_party),
                    (party_get_slot, ":leader", ":party_no", slot_party_leader),
                    (ge, ":leader", 0),
                    (troop_get_slot, ":wanted_wages", ":leader", slot_troop_wanted_party_wages),
                (else_try),
                    (party_get_slot, ":wanted_wages", ":party_no", slot_party_wanted_party_wages),
                    (try_begin),
                        (eq, ":wanted_wages", 0),
                        # Troop has either not been processed or has no fixed income
                        # We can assume the latter are mercenaries with no contracts
                    (try_end),

                    (try_begin),
                        (eq, ":party_type", spt_village),
                        (assign, ":tolerance_min", 80),
                        (assign, ":tolerance_max", 150),
                    (try_end),
                (try_end),

                (try_begin),
                    (eq, ":party_type", spt_war_party),
                    (party_get_slot, ":debts", ":party_no", slot_party_unpaid_wages),
                    # (gt, ":debts", 0),
                    (store_mul, ":threshold", ":wanted_wages", 10),
                    (val_max, ":threshold", 1),
                    (gt, ":debts", ":threshold"),
                    (store_sub, ":penalty_target", ":debts", ":threshold"),
                    (val_max, ":penalty_target", 0),
                    (store_mul, ":penalty_value", ":penalty_target", 100),
                    (val_div, ":penalty_value", ":threshold"),
                    (set_fixed_point_multiplier, 1),
                    (store_sqrt, ":penalty", ":penalty_value"),
                    (val_clamp, ":penalty", 0, 100),
                    (gt, ":penalty", 0),

                    (store_sub, ":mult", 100, ":penalty"),
                    (val_mul, ":wanted_wages", ":mult"),
                    (val_div, ":wanted_wages", 100),

                    # (try_begin),
                    #     (call_script, "script_cf_debug", debug_economy|debug_current),
                    #     (str_store_party_name, s10, ":party_no"),
                    #     (assign, reg10, ":penalty"),
                    #     (display_message, "@{s10} in debt, increasing party size penalty -{reg10}%"),
                    # (try_end),
                (try_end),

                (assign, ":war_mult", 100),
                (try_begin),
                    (this_or_next|gt, ":at_war", 0),
                    (gt, ":preparing_for_war", 0),
                (else_try),
                    (assign, ":war_mult", 40),
                    (try_begin),
                        (eq, ":party_type", spt_war_party),
                    (else_try),
                        (is_between, ":party_type", spt_village, spt_fort + 1),
                        (assign, ":war_mult", 80),
                    (try_end),
                (try_end),
                (val_mul, ":wanted_wages", ":war_mult"),
                (val_div, ":wanted_wages", 100),
            (try_end),

            (store_mul, ":min_wages", ":wanted_wages", ":tolerance_min"),
            (val_div, ":min_wages", 100),
            (store_mul, ":max_wages", ":wanted_wages", ":tolerance_max"),
            (val_div, ":max_wages", 100),

            # (try_begin),
            #     (call_script, "script_cf_debug", debug_current),
            #     (str_store_party_name, s10, ":party_no"),
            #     (assign, reg10, ":wanted_wages"),
            #     (display_message, "@{s10} wanted wages - {reg10}"),
            # (try_end),

            (assign, reg0, ":wanted_wages"),
            (assign, reg1, ":min_wages"),
            (assign, reg2, ":max_wages"),
        ]),
    
    # script_troop_get_lord_horse_slot
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: horse
    ("troop_get_lord_horse_slot",
        [
            (store_script_param, ":troop_no", 1),
            
            (troop_get_slot, ":horse", ":troop_no", slot_troop_lord_horse),
            
            (troop_get_slot, ":rank", ":troop_no", slot_troop_level),
            (try_begin),
                # (eq, ":rank", 5),
                # (store_random_in_range, ":rand", 0, 2),
                # (val_add, ":horse", ":rand"),
            # (else_try),
                (ge, ":rank", 6),
                (assign, ":horse", 1),
            (else_try),
                (eq, ":rank", 0),
                (val_div, ":horse", 3),
            (else_try),
                (le, ":rank", 2),
                (val_div, ":horse", 2),
            (try_end),
            
            (assign, reg0, ":horse"),
        ]),
    
    # script_troop_set_equip_type
    # input:
    #   arg1: troop_no
    # output: none
    ("troop_set_equip_type",
        [
            (store_script_param, ":troop_no", 1),
            
            (troop_get_slot, ":original_faction", ":troop_no", slot_troop_original_faction),
            (troop_get_slot, ":culture", ":troop_no", slot_troop_culture),
            
            (store_random_in_range, ":horse", 0, 10),
            (store_random_in_range, ":weapon", 0, 20),
            
            (try_begin),
                (eq, ":culture", "fac_culture_1"),
                (try_begin),
                    (eq, ":horse", 0),
                    (assign, ":horse", 2),
                (else_try),
                    (assign, ":horse", 3),
                (try_end),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (eq, ":original_faction", "fac_small_kingdom_11"), # Does not have bows
                    (eq, ":weapon", 6),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_crossbow),
                (else_try),
                    (eq, ":original_faction", "fac_small_kingdom_14"), # Does not have crossbows
                    (eq, ":weapon", 7),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (eq, ":original_faction", "fac_small_kingdom_16"), # Has throw
                    (is_between, ":weapon", 8, 10),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (le, ":weapon", 5),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 6),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 7),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_crossbow),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (else_try),
                (eq, ":culture", "fac_culture_2"),
                (try_begin),
                    (eq, ":horse", 0),
                    # (assign, ":horse", 0),
                (else_try),
                    (eq, ":horse", 1),
                    (assign, ":horse", 2),
                (else_try),
                    (assign, ":horse", 3),
                (try_end),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (le, ":weapon", 2),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 5),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 10),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_heavy_bow),
                (else_try),
                    (le, ":weapon", 12),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (eq, ":original_faction", "fac_small_kingdom_24"), # Has more throw
                    (le, ":weapon", 15),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (else_try),
                (eq, ":culture", "fac_culture_3"),
                (try_begin),
                    (eq, ":horse", 0),
                    (assign, ":horse", 2),
                (else_try),
                    (assign, ":horse", 3),
                (try_end),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (le, ":weapon", 5),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 8),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 13),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_heavy_bow),
                (else_try),
                    (le, ":weapon", 14),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (else_try),
                (eq, ":culture", "fac_culture_4"),
                (val_div, ":horse", 4),
                (val_min, ":horse", 3),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (le, ":weapon", 5),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 6),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 7),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_heavy_bow),
                (else_try),
                    (le, ":weapon", 13),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (le, ":weapon", 14),
                    (eq, ":original_faction", "fac_small_kingdom_44"),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_crossbow),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (else_try),
                (eq, ":culture", "fac_culture_5"),
                (val_div, ":horse", 3),
                (val_min, ":horse", 3),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (le, ":weapon", 8),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 12),
                    (eq, ":original_faction", "fac_small_kingdom_51"),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 10),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_crossbow),
                (else_try),
                    (le, ":weapon", 12),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_heavy_crossbow),
                (else_try),
                    (le, ":weapon", 13),
                    (eq, ":original_faction", "fac_small_kingdom_54"),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (else_try),
                (eq, ":culture", "fac_culture_6"),
                (try_begin),
                    (eq, ":horse", 0),
                    (assign, ":horse", 2),
                (else_try),
                    (assign, ":horse", 3),
                (try_end),
                (troop_set_slot, ":troop_no", slot_troop_lord_horse, ":horse"),
                
                (try_begin),
                    (le, ":weapon", 3),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_polearm),
                (else_try),
                    (le, ":weapon", 4),
                    (eq, ":original_faction", "fac_small_kingdom_61"),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_heavy_crossbow),
                (else_try),
                    (le, ":weapon", 7),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_light_bow),
                (else_try),
                    (le, ":weapon", 13),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_throwing),
                (else_try),
                    (troop_set_slot, ":troop_no", slot_troop_lord_equipement, tle_none),
                (try_end),
            (try_end),
        ]),
        
    # script_scene_get_spawn_range
    # input:
    #   arg1: team_no
    # output:
    #   reg0: range_begin
    #   reg1: range_end
    ("scene_get_spawn_range",
        [
            (store_script_param, ":team_no", 1),
            
            (store_current_scene, ":cur_scene"),
            
            # (team_get_slot, ":battle_phase", ":team_no", slot_team_battle_phase),
            
            (try_begin),
                (eq, ":team_no", 0),
                (assign, reg0, 1), # One spawn for defenders
                (assign, reg1, 2),
            (else_try),
                (scene_get_slot, ":end", ":cur_scene", slot_scene_num_attack_spawn),
                (assign, reg0, siege_attack_spawn_begin),
                (store_add, reg1, reg0, ":end"),
            (try_end),
        ]),
    
    # script_scene_get_archer_points_range
    # input: none
    # output:
    #   reg0: range_begin
    #   reg1: range_end
    ("scene_get_archer_points_range",
        [
            (store_current_scene, ":cur_scene"),
            (assign, ":begin", siege_archer_points_begin),
            (assign, ":end", ":begin"),
            
            (scene_get_slot, ":num_points", ":cur_scene", slot_scene_num_archer_points),
            (val_add, ":end", ":num_points"),
            (assign, reg0, ":begin"),
            (assign, reg1, ":end"),
        ]),
    
    # script_scene_get_defend_points_range
    # input: none
    # output:
    #   reg0: range_begin
    #   reg1: range_end
    ("scene_get_defend_points_range",
        [
            (store_current_scene, ":cur_scene"),
            (assign, ":begin", siege_defend_points_begin),
            (assign, ":end", ":begin"),
            
            (scene_get_slot, ":num_points", ":cur_scene", slot_scene_num_defend_points),
            (val_add, ":end", ":num_points"),
            (assign, reg0, ":begin"),
            (assign, reg1, ":end"),
        ]),
    
    # script_init_siege_scene_slots
    # input: none
    # output: none
    ("init_siege_scene_slots",
        [
            (scene_set_slot, "scn_castle_plain_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_plain_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_plain_01_outside", slot_scene_num_archer_points, 8),
            (scene_set_slot, "scn_castle_plain_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_plain_02_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_plain_02_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_plain_02_outside", slot_scene_num_archer_points, 9),
            (scene_set_slot, "scn_castle_plain_02_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_plain_03_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_plain_03_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_plain_03_outside", slot_scene_num_archer_points, 10),
            (scene_set_slot, "scn_castle_plain_03_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_plain_wood_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_plain_wood_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_plain_wood_01_outside", slot_scene_num_archer_points, 12),
            (scene_set_slot, "scn_castle_plain_wood_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_plain_dark_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_plain_dark_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_plain_dark_01_outside", slot_scene_num_archer_points, 8),
            (scene_set_slot, "scn_castle_plain_dark_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_sea_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_sea_01_outside", slot_scene_num_attack_spawn, 1),
            (scene_set_slot, "scn_castle_sea_01_outside", slot_scene_num_archer_points, 9),
            (scene_set_slot, "scn_castle_sea_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_steppe_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_steppe_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_steppe_01_outside", slot_scene_num_archer_points, 9),
            (scene_set_slot, "scn_castle_steppe_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_snow_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_snow_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_snow_01_outside", slot_scene_num_archer_points, 7),
            (scene_set_slot, "scn_castle_snow_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_snow_wood_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_snow_wood_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_snow_wood_01_outside", slot_scene_num_archer_points, 9),
            (scene_set_slot, "scn_castle_snow_wood_01_outside", slot_scene_enabled, 1),
            
            (scene_set_slot, "scn_castle_desert_01_outside", slot_scene_num_defend_points, 2),
            (scene_set_slot, "scn_castle_desert_01_outside", slot_scene_num_attack_spawn, 2),
            (scene_set_slot, "scn_castle_desert_01_outside", slot_scene_num_archer_points, 9),
            (scene_set_slot, "scn_castle_desert_01_outside", slot_scene_enabled, 1),
        ]),
    
    # script_set_team_defend_points
    # input: none
    # output: none
    ("set_team_defend_points",
        [
            (call_script, "script_scene_get_defend_points_range"),
            (assign, ":defend_begin", reg0),
            (assign, ":defend_end", reg1),
            
            # (store_sub, ":num_defend", ":defend_end", ":defend_begin"),
            (assign, ":cur_division", 2),
            (try_for_range, ":cur_defend", ":defend_begin", ":defend_end"),
                (team_give_order, 0, ":cur_division", mordr_hold),
                (entry_point_get_position, pos0, ":cur_defend"),
                (team_set_order_position, 0, ":cur_division", pos0),
                (val_add, ":cur_division", 1),
            (try_end),
        ]),
    
    # script_spawn_lord
        # input:
        #   arg1: troop_no
        # output: none
    ("spawn_lord",
        [
            (store_script_param, ":troop_no", 1),
            
            (call_script, "script_troop_get_current_home", ":troop_no", 1),
            (assign, ":home", reg0),
            
            # (store_troop_faction, ":troop_faction", ":troop_no"),
            # (store_faction_of_party, ":party_faction", ":home"),
            
            # (try_begin),
                # (this_or_next|le, ":home", 0),
                # (neq, ":troop_faction", ":party_faction"),
                
                # (call_script, "script_troop_update_home", ":troop_no"),
            # (try_end),

            (try_begin),
                (is_between, ":home", centers_begin, centers_end),
                (store_faction_of_party, ":center_faction", ":home"),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (try_begin),
                    (neq, ":center_faction", ":troop_faction"),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_simple),
                        (str_store_troop_name, s10, ":troop_no"),
                        (str_store_party_name, s11, ":home"),
                        (str_store_faction_name, s12, ":center_faction"),
                        (display_message, "@Trying to spawn {s10} in {s11} with faction {s12}", text_color_debug),
                    (try_end),
                (else_try),
                    (party_force_add_members, ":home", ":troop_no", 1),
                    (troop_set_slot, ":troop_no", slot_troop_garrisoned, ":home"),
                (try_end),
            (try_end),
        ]),

    # script_create_lord_party
        # input:
        #   arg1: troop_no
        #   arg2: center_no
        # output:
        #   reg0: created_party
    ("create_lord_party",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":center_no", 2),

            (call_script, "script_spawn_party_around_party", ":center_no", "pt_war_party"),
            (assign, ":party", reg0),
            
            (store_troop_faction, ":faction", ":troop_no"),
            (party_set_faction, ":party", ":faction"),
            
            (party_set_flags, ":party", pf_show_faction, 1),
            
            (party_remove_members, ":center_no", ":troop_no", 1),
            (party_add_leader, ":party", ":troop_no"),
            
            (party_set_slot, ":party", slot_party_leader, ":troop_no"),
            (party_set_slot, ":party", slot_party_readiness, sfsr_unavailable),
            (troop_set_slot, ":troop_no", slot_troop_leaded_party, ":party"),
            (troop_set_slot, ":troop_no", slot_troop_garrisoned, -1),
            
            (party_set_slot, ":party", slot_party_type, spt_war_party),
            (party_set_slot, ":party", slot_party_wages_cache, 0),

            (party_set_slot, ":party", slot_party_autosort_options, autosort_low_level_first|autosort_foreign_first),
            
            (call_script, "script_party_set_behavior", ":party", tai_traveling_to_party, ":center_no"),
            (call_script, "script_party_process_mission", ":party", 1),

            (party_attach_to_party, ":party", ":center_no"),
            
            # ToDo: special name for parties
            (str_store_troop_name, s10, ":troop_no"),
            (party_set_name, ":party", "@{s10}'s Party"),

            (assign, reg0, ":party"),
        ]),

    # script_cf_lord_can_create_party
        # input:
        #   arg1: troop_no
        # output: none
    ("cf_lord_can_create_party",
        [
            (store_script_param, ":troop_no", 1),
            (store_troop_health, ":troop_health", ":troop_no", 0),

            (gt, ":troop_health", 66),
            (troop_slot_ge, ":troop_no", slot_troop_wanted_party_wages, 500),
        ]),
    
    # script_cf_lord_can_spawn
        # input:
        #   arg1: troop_no
        # output: none
    ("cf_lord_can_spawn",
        [
            (store_script_param, ":troop_no", 1),

            (store_troop_faction, ":troop_faction", ":troop_no"),
            (neg|faction_slot_eq, ":troop_faction", slot_faction_status, sfst_disabled),
            
            (neg|troop_slot_ge, ":troop_no", slot_troop_prisoner_of, 0),
            (neg|troop_slot_ge, ":troop_no", slot_troop_garrisoned, centers_begin),
            
            (call_script, "script_troop_get_current_home", ":troop_no", 1),
            (assign, ":home", reg0),
            
            (ge, ":home", centers_begin),
            (party_get_slot, ":besieged", ":home", slot_party_besieged_by),
            (lt, ":besieged", 0),
        ]),
    
    # script_troop_update_home
    # input:
    #   arg1: troop_no
    # output:
    #   reg0: new_home
    ("troop_update_home",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":old_home", ":troop_no", slot_troop_home),

            (assign, ":home", -1),
            
            (store_troop_faction, ":troop_faction", ":troop_no"),

            (assign, ":old_home_type", -1),
            (try_begin),
                (is_between, ":old_home", centers_begin, centers_end),
                (party_get_slot, ":old_home_faction", ":old_home", slot_party_faction),
                (eq, ":old_home_faction", ":troop_faction"),
                (party_slot_eq, ":old_home", slot_party_lord, ":troop_no"),
                (party_get_slot, ":old_home_type", ":old_home", slot_party_type),
            (try_end),
            
            (assign, ":first_center", -1),
            
            (assign, ":end", walled_centers_end),
            # Take first owned center (towns first)
            (try_for_range, ":cur_center", walled_centers_begin, ":end"),
                (party_get_slot, ":center_faction", ":cur_center", slot_party_faction),

                (party_get_slot, ":center_type", ":cur_center", slot_party_type),

                (try_begin),
                    (party_slot_eq, ":cur_center", slot_party_lord, ":troop_no"),
                    (eq, ":center_faction", ":troop_faction"),
                    
                    (this_or_next|eq, ":cur_center", ":old_home"),
                    (gt, ":center_type", ":old_home_type"),
                    
                    (assign, ":home", ":cur_center"),
                    (assign, ":end", 0),
                (else_try),
                    (eq, ":first_center", -1),
                    # We take the first center of this faction in case the capital does not exist
                    (eq, ":center_faction", ":troop_faction"),

                    (assign, ":first_center", ":cur_center"),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":home", -1),
                (neq, ":old_home_type", -1),
                (assign, ":home", ":old_home"),
            (else_try),
                (eq, ":home", -1),
                # Then check villages
                (assign, ":end", villages_end),
                (try_for_range, ":cur_center", villages_begin, ":end"),
                    (party_slot_eq, ":cur_center", slot_party_lord, ":troop_no"),

                    (party_get_slot, ":center_faction", ":cur_center", slot_party_faction),
                    (eq, ":center_faction", ":troop_faction"),
                    
                    (assign, ":home", ":cur_center"),
                    # (party_get_slot, ":home", ":cur_center", slot_party_linked_party),
                    (assign, ":end", 0),
                (try_end),
                (try_begin),
                    (eq, ":home", -1),
                    # If lord has no home, we take his leader's home
                    (troop_get_slot, ":leader", ":troop_no", slot_troop_vassal_of),
                    (try_begin),
                        (ge, ":leader", 0),
                        (troop_get_slot, ":home", ":leader", slot_troop_home),
                        # (call_script, "script_troop_get_current_home", ":leader", 1),
                        # (assign, ":home", reg0),
                        (gt, ":home", 0),
                    (else_try),
                        (faction_get_slot, ":faction_leader", ":troop_faction", slot_faction_leader),
                        (try_begin),
                            (ge, ":faction_leader", 0),
                            (neq, ":faction_leader", ":troop_no"),
                            
                            (troop_get_slot, ":home", ":faction_leader", slot_troop_home),
                            # (call_script, "script_troop_get_current_home", ":faction_leader", 1),
                            # (assign, ":home", reg0),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),
                        
            (try_begin),
                (le, ":home", 0),
                (assign, ":home", ":first_center"),
            (try_end),
            
            (troop_set_slot, ":troop_no", slot_troop_home, ":home"),
            (assign, reg0, ":home"),
        ]),

    # script_troop_get_home
    # input:
    #   arg1: troop_no
    # output:
    #   reg0: home
    ("troop_get_home",
        [
            (store_script_param, ":troop_no", 1),
            
            (store_troop_faction, ":troop_faction", ":troop_no"),
            
            (troop_get_slot, ":home", ":troop_no", slot_troop_home),
            (try_begin),
                (is_between, ":home", centers_begin, centers_end),
                (party_slot_eq, ":home", slot_party_faction, ":troop_faction"),
                (party_slot_eq, ":home", slot_party_lord, ":troop_no"),
            (else_try),
                (call_script, "script_troop_update_home", ":troop_no"),
                (assign, ":home", reg0),
            (try_end),

            (assign, reg0, ":home"),
        ]),

    # script_cf_troop_check_home
    # input:
    #   arg1: troop_no
    #   arg2: home
    #   arg3: walled (if home needs to be a walled center)
    # output: fails if home is unsuited
    ("cf_troop_check_home",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":home", 2),
            (store_script_param, ":walled", 3),

            (is_between, ":home", centers_begin, centers_end),
            (party_get_slot, ":party_type", ":home", slot_party_type),
            (try_begin),
                (eq, ":walled", 1),
                (eq, ":party_type", spt_village),
                (party_get_slot, ":linked_party", ":home", slot_party_linked_party),
                (is_between, ":linked_party", centers_begin, centers_end),
                (assign, ":home", ":linked_party"),
            (try_end),
            (store_troop_faction, ":troop_faction", ":troop_no"),
            (store_faction_of_party, ":home_faction", ":home"),

            (eq, ":home_faction", ":troop_faction"),
        ]),

    # script_troop_get_current_home
    # input:
    #   arg1: troop_no
    #   arg2: walled (if home needs to be a walled center)
    # output:
    #   reg0: home
    ("troop_get_current_home",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":walled", 2),
            
            (store_troop_faction, ":troop_faction", ":troop_no"),
            
            (call_script, "script_troop_get_home", ":troop_no"),
            (assign, ":home", reg0),
            (try_begin),
                (call_script, "script_cf_troop_check_home", ":troop_no", ":home", ":walled"),
            (else_try),
                (troop_get_slot, ":home", ":troop_no", slot_troop_current_home),
                (call_script, "script_cf_troop_check_home", ":troop_no", ":home", ":walled"),
            (else_try),
                (troop_get_slot, ":lord", ":troop_no", slot_troop_vassal_of),
                (is_between, ":lord", npc_heroes_begin, npc_heroes_end),
                (troop_slot_eq, ":lord", slot_troop_kingdom_occupation, tko_kingdom_hero),

                (call_script, "script_troop_get_home", ":lord"),
                (assign, ":home", reg0),
                (call_script, "script_cf_troop_check_home", ":troop_no", ":home", ":walled"),
            (else_try),
                (troop_get_slot, ":lord", ":troop_no", slot_troop_vassal_of),
                (is_between, ":lord", npc_heroes_begin, npc_heroes_end),
                (troop_slot_eq, ":lord", slot_troop_kingdom_occupation, tko_kingdom_hero),

                (troop_get_slot, ":home", ":lord", slot_troop_current_home),
                (call_script, "script_cf_troop_check_home", ":troop_no", ":home", ":walled"),
            (else_try),
                (faction_get_slot, ":leader", ":troop_faction", slot_faction_leader),
                (is_between, ":leader", npc_heroes_begin, npc_heroes_end),
                (troop_slot_eq, ":leader", slot_troop_kingdom_occupation, tko_kingdom_hero),

                (call_script, "script_troop_get_home", ":leader"),
                (assign, ":home", reg0),
                (call_script, "script_cf_troop_check_home", ":troop_no", ":home", ":walled"),
            (else_try),
                (faction_get_slot, ":leader", ":troop_faction", slot_faction_leader),
                (is_between, ":leader", npc_heroes_begin, npc_heroes_end),
                (troop_slot_eq, ":leader", slot_troop_kingdom_occupation, tko_kingdom_hero),

                (troop_get_slot, ":home", ":leader", slot_troop_current_home),
                (call_script, "script_cf_troop_check_home", ":leader", ":home", ":walled"),
            (else_try),
                (assign, ":end", walled_centers_end),
                (try_begin),
                    (eq, ":walled", 0),
                    (assign, ":end", centers_end),
                (try_end),
                (try_for_range, ":center_no", centers_begin, ":end"),
                    (call_script, "script_cf_troop_check_home", ":troop_no", ":center_no", ":walled"),
                    (assign, ":home", ":center_no"),
                    (assign, ":end", centers_begin),
                (try_end),
            (else_try),
                (assign, ":home", -1),
            (try_end),

            (troop_set_slot, ":troop_no", slot_troop_current_home, ":home"),

            (party_get_slot, ":party_type", ":home", slot_party_type),
            (try_begin),
                (eq, ":walled", 1),
                (eq, ":party_type", spt_village),
                (party_get_slot, ":linked_party", ":home", slot_party_linked_party),
                (is_between, ":linked_party", centers_begin, centers_end),
                (assign, ":home", ":linked_party"),
            (try_end),

            (assign, reg0, ":home"),
        ]),
    
    # script_party_process_ai
    # input:
    #   arg1: party_no
    # output: none
    ("party_process_ai",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            
            (troop_get_slot, ":mission", ":leader", slot_troop_mission),
            (troop_get_slot, ":mission_object", ":leader", slot_troop_mission_object),
            
            (troop_get_slot, ":current_behavior", ":leader", slot_troop_behavior),
            (troop_get_slot, ":current_object", ":leader", slot_troop_behavior_object),
            
            (party_get_attached_to, ":attached_to", ":party_no"),
            (store_faction_of_party, ":party_faction", ":party_no"),
            
            (call_script, "script_troop_get_current_home", ":leader", 0),
            (assign, ":home", reg0),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            
            (try_begin),
                (party_get_battle_opponent, ":opponent", ":party_no"),
                (ge, ":opponent", 0),
                (store_faction_of_party, ":opponent_faction", ":opponent"),
                (store_relation, ":rel", ":opponent_faction", ":party_faction"),
                (neq, ":opponent_faction", ":party_faction"),
                (lt, ":rel", 0),
            (else_try),
                (eq, "$g_disable_ai", 1),
                (try_begin),
                    (eq, ":attached_to", ":home"),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":home"),
                (try_end),
            (else_try),
                (eq, ":mission", tm_none),
                
                (try_begin),
                    (call_script, "script_cf_party_need_troops", ":party_no"),
                    (assign, ":need_type", reg0),
                    
                    (assign, ":stop", 0),

                    (this_or_next|ge, ":need_type", type_moderate),
                    (party_slot_ge, ":party_no", slot_party_preparing_for_war, 1),
                    (try_begin),
                        (eq, ":current_object", ":home"),
                        (this_or_next|eq, ":current_behavior", tai_traveling_to_party),
                        (eq, ":attached_to", ":home"),
                        (assign, ":stop", 1),
                    (else_try),
                        (try_begin),
                            (is_between, ":attached_to", walled_centers_begin, walled_centers_end),
                            (eq, ":need_type", type_critical),
                            # We don't move from current center if we have too few men
                        (else_try),
                            (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":home"),
                        (try_end),
                        (assign, ":stop", 1),
                    (try_end),
                    (eq, ":stop", 1),
                (else_try),
                    (troop_get_slot, ":last_rest", ":leader", slot_troop_last_rest),
                    (assign, ":stop", 0),
                    (store_sub, ":rest_time", ":current_day", ":last_rest"),
                    (this_or_next|ge, ":rest_time", 7*24),
                    (eq, ":attached_to", ":home"),

                    (try_begin),
                        (eq, ":attached_to", ":home"),
                        (try_begin),
                            (ge, ":rest_time", 7*24),
                            (troop_set_slot, ":leader", slot_troop_last_rest, ":current_day"),
                        (else_try),
                            (ge, ":rest_time", 28),
                            (troop_set_slot, ":leader", slot_troop_last_rest, ":current_day"),
                            (call_script, "script_party_set_behavior", ":party_no", tai_patroling_center, ":home"),
                        (try_end),
                        (assign, ":stop", 1),
                    (else_try),
                        (store_distance_to_party_from_party, ":distance", ":home", ":party_no"),
                        (le, ":distance", 20),
                        (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":home"),
                        (assign, ":stop", 1),
                    (try_end),
                    (eq, ":stop", 1),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_patroling_center, ":home"),
                (try_end),
            (else_try),
                (eq, ":mission", tm_defending),
                
                (is_between, ":mission_object", centers_begin, centers_end),
                (party_get_battle_opponent, ":opponent", ":mission_object"),
                (try_begin),
                    (ge, ":opponent", 0),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":mission_object"),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_point, ":mission_object"),
                (try_end),
            (else_try),
                (eq, ":mission", tm_attacking),
                
                (assign, ":stop", 1),
                (try_begin),
                    (is_between, ":mission_object", centers_begin, centers_end),
                    (store_faction_of_party, ":object_faction", ":mission_object"),
                    (store_relation, ":faction_relation", ":object_faction", ":party_faction"),
                    (this_or_next|eq, ":object_faction", ":party_faction"),
                    (ge, ":faction_relation", relation_neutral),
                    (call_script, "script_party_process_mission", ":party_no", 1),
                    (call_script, "script_party_set_behavior", ":party_no", tai_patroling_center, ":mission_object"),
                (else_try),
                    (neg|is_between, ":mission_object", centers_begin, centers_end),
                    (call_script, "script_party_process_mission", ":party_no", 1),
                (else_try),
                    (is_between, ":mission_object", centers_begin, centers_end),
                    (store_distance_to_party_from_party, ":distance", ":mission_object", ":party_no"),
                    (try_begin),
                        (ge, ":distance", 4),
                        
                        (try_begin),
                            (this_or_next|neq, ":current_behavior", tai_attacking_center),
                            (neq, ":current_object", ":mission_object"),
                            
                            (call_script, "script_party_set_behavior", ":party_no", tai_attacking_center, ":mission_object"),
                        (try_end),
                    (else_try),
                        (party_get_slot, ":besieger", ":mission_object", slot_party_besieged_by),
                        
                        (assign, ":continue", 1),
                        (try_begin),
                            (lt, ":besieger", 0),
                            (call_script, "script_party_besiege_party", ":party_no", ":mission_object"),
                        (else_try),
                            (neq, ":besieger", ":party_no"),
                            (assign, ":continue", 0),
                            (party_get_slot, ":besieger_leader", ":besieger", slot_party_leader),
                            (ge, ":besieger_leader", 0),
                            (troop_set_slot, ":leader", slot_troop_mission, tm_escorting),
                            (troop_set_slot, ":leader", slot_troop_mission_object, ":besieger_leader"),
                        (try_end),
                        
                        (try_begin),
                            (eq, ":continue", 1),
                            (party_get_battle_opponent, ":own_opponent", ":party_no"),
                            (eq, ":own_opponent", -1),

                            (store_random_in_range, ":random", 0, 10),
                            (eq, ":random", 0),
                            
                            (troop_set_slot, ":leader", slot_troop_last_attack, ":current_day"),
                            (party_set_ai_behavior, ":party_no", ai_bhvr_attack_party),
                            (party_set_ai_object, ":party_no", ":current_object"),
                        (try_end),
                    (try_end),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_patroling_center, ":home"),
                (try_end),
            (else_try),
                (eq, ":mission", tm_escorting),
                (try_begin),
                    (eq, ":current_behavior", tai_accompanying_party),
                    (try_begin),
                        (eq, ":current_object", ":mission_object"),
                        
                        (party_get_battle_opponent, ":opponent", ":mission_object"),
                        (try_begin),
                            (ge, ":opponent", 0),
                            (party_set_ai_behavior, ":party_no", ai_bhvr_attack_party),
                            (party_set_ai_object, ":party_no", ":opponent"),
                            (troop_set_slot, ":leader", slot_troop_behavior, -1),
                        (try_end),
                    (else_try),
                        (call_script, "script_party_set_behavior", ":party_no", tai_accompanying_party, ":mission_object"),
                    (try_end),
                (else_try),
                    (eq, ":current_behavior", tai_accompanying_troop),
                    (troop_get_slot, ":object_leaded_party", ":mission_object", slot_troop_leaded_party),
                    
                    (try_begin),
                        (this_or_next|eq, ":object_leaded_party", -1),
                        (troop_slot_ge, ":mission_object", slot_troop_prisoner_of, 0), # Do not follow lord taken prisoner
                        (call_script, "script_party_process_mission", ":party_no", 1),
                        # Select an action based on the old mission
                        # Weak lords should abandon their mission and go back home (unless they are defending)
                        # Stronger lords could raid villages or continue the old mission
                    (else_try),
                        (try_begin),
                            # (eq, ":current_object", ":object_leaded_party"),
                            (party_get_battle_opponent, ":opponent", ":object_leaded_party"),
                            (try_begin),
                                (ge, ":opponent", 0),
                                (party_set_ai_object, ":party_no", ":opponent"),
                                (party_set_ai_behavior, ":party_no", ai_bhvr_attack_party),
                                (troop_set_slot, ":leader", slot_troop_behavior, -1),
                            (try_end),
                        (else_try),
                            (call_script, "script_party_set_behavior", ":party_no", tai_accompanying_troop, ":mission_object"),
                        (try_end),
                    (try_end),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_accompanying_troop, ":mission_object"),
                (try_end),
            (try_end),
            
        ]),
    
    # script_party_process_ai
    # input: 
    #   arg1: party_no
    # output: none
    # ("party_process_ai",
    #     [
    #         (store_script_param, ":party_no", 1),

    #         (party_get_slot, ":leader", ":party_no", slot_party_leader),

    #         (troop_get_slot, ":mission", ":leader", slot_troop_mission),
    #         (troop_get_slot, ":mission_object", ":leader", slot_troop_mission_object),
            
    #         (troop_get_slot, ":behavior", ":leader", slot_troop_behavior),
    #         (troop_get_slot, ":behavior_object", ":leader", slot_troop_behavior_object),
            
    #         (try_begin),
    #             (eq, "$g_disable_ai", 1),
    #             # Ai disabled, do nothing
    #         (else_try),
    #             (eq, ":mission", tm_none),
    #             # No mission, do civic duties
    #             # Head home, visit family / friends
    #             # Go to tournaments
    #             # Patrol his territory
    #         (try_end),
    #     ]),
    
    # script_party_process_mission
    # input:
    #   arg1: party_no
    # output: none
    # ("party_process_mission",
    #     [
    #         (store_script_param, ":party_no", 1),

    #         (try_begin),
    #             (eq, "$g_disable_ai", 1),
    #             # Ai disabled, we do nothing
    #         (else_try),
    #             (party_get_slot, ":leader", ":party_no", slot_party_leader),

    #             (store_faction_of_party, ":party_faction", ":party_no"),
    #             (faction_get_slot, ":num_wars", ":party_faction", slot_faction_is_at_war),
    #             (faction_get_slot, ":preparing_war", ":party_faction", slot_faction_preparing_war),

    #             (troop_get_slot, ":old_mission", ":leader", slot_troop_mission),
    #             (troop_get_slot, ":old_mission_object", ":leader", slot_troop_mission_object),
    #             (assign, ":mission", ":old_mission"),
    #             (assign, ":mission_object", ":old_mission_object"),

    #             (party_get_num_companions, ":party_size", ":party_no"),

    #             (call_script, "script_party_get_ideal_party_size", ":party_no"),
    #             (assign, ":ideal_party_size", reg0),
    #             (assign, ":max_party_size", reg1),
    #             (call_script, "script_troop_get_mission_party_size_multiplier", ":leader"),
    #             (assign, ":party_size_multiplier", reg0),

    #             (store_mul, ":minimum_mission_party_size", ":ideal_party_size", 100),
    #             (val_div, ":minimum_mission_party_size", ":party_size_multiplier"),

    #             (try_begin),
    #                 (call_script, "script_cf_party_can_recruit", ":party_no"),
    #                 (lt, ":party_size", ":ideal_party_size"),
    #                 (assign, ":mission", tm_recruit),
    #             (else_try),
    #                 (eq, ":mission", tm_none),
    #                 (this_or_next|ge, ":num_wars", 1),
    #                 (eq, ":preparing_war", 1),
    #                 (try_begin),
    #                     (gt, ":num_vassals", 0),
    #                     # ToDo: get num following vassals
    #                     (assign, ":following_vassals", ":num_vassals"),
    #                     (try_begin),
    #                         (lt, ":following_vassals", ":num_vassals"),
    #                         (assign, ":mission", tm_gather),
    #                     (else_try),
    #                         (assign, ":mission", tm_prepare),
    #                 (else_try),
    #                     (assign, ":mission", tm_none),
    #                 (try_end),
    #             (else_try),
    #                 (eq, ":mission", tm_gather),
    #                 (try_begin),
    #                     # ToDo: get num following vassals
    #                     (assign, ":mission", tm_prepare),
    #                 (try_end),
    #             (else_try),
    #                 (eq, ":mission", tm_prepare),
    #                 # ToDo: prepare
    #             (else_try),
    #                 (eq, ":mission", tm_follow),
    #                 # ToDo: follow
    #             (else_try),
    #                 (eq, ":mission", tm_attack),
    #                 # ToDo: attack
    #             (else_try),
    #                 (eq, ":mission", tm_defend),
    #                 # ToDo: defend
    #             (try_end),


    #         (try_end),

    #     ]),

    # script_troop_get_mission_party_size_multiplier
    # input:
    #   arg1: troop_no
    # output:
    #   reg0: party_size_multiplier
    # ("troop_get_mission_party_size_multiplier",
    #     [
    #         (store_script_param, ":troop_no", 1),
    #         (troop_get_slot, ":mission", ":troop_no", slot_troop_mission),

    #         (assign, ":mult", 100),

    #         (try_begin),
    #             (eq, ":mission", tm_none),
    #         (else_try),
    #             (eq, ":mission", tm_gather),
    #             (assign, ":mult", 90),
    #         (else_try),
    #             (eq, ":mission", tm_recruit),
    #         (else_try),
    #             (eq, ":mission", tm_prepare),
    #             (assign, ":mult", 80),
    #         (else_try),
    #             (eq, ":mission", tm_attack),
    #             (assign, ":mult", 60),
    #         (else_try),
    #             (eq, ":mission", tm_defend),
    #             (assign, ":mult", 70),
    #         # (else_try),
    #             # (eq, ":mission", tm_none),
    #         # (else_try),
    #         (try_end),

    #         (assign, reg0, ":mult"),
    #     ]),
    
    # script_party_process_mission
    # input:
    #   arg1: party_no
    #   arg2: force_process
    # output: none
    ("party_process_mission",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":force_process", 2),

            (party_get_slot, ":current_iteration", ":party_no", slot_party_process_mission_iteration),
            (val_add, ":current_iteration", 1),
            (try_begin),
                (this_or_next|eq, ":force_process", 1),
                (ge, ":current_iteration", process_mission_iteration_count),
                
                (party_get_slot, ":leader", ":party_no", slot_party_leader),
                
                (call_script, "script_troop_get_current_home", ":leader", 0),
                (assign, ":home", reg0),
                (call_script, "script_troop_get_current_home", ":leader", 1),
                (assign, ":walled_home", reg0),
                
                (troop_get_slot, ":old_mission", ":leader", slot_troop_mission),
                (troop_get_slot, ":old_mission_object", ":leader", slot_troop_mission_object),
                
                (assign, ":new_mission", tm_none),
                (assign, ":new_mission_object", -1),
                
                (store_faction_of_party, ":party_faction", ":party_no"),
                (faction_get_slot, ":at_war", ":party_faction", slot_faction_is_at_war),
                
                (troop_get_slot, ":rank", ":leader", slot_troop_rank),

                (party_get_slot, ":preparing_for_war", ":party_no", slot_party_preparing_for_war),
                (party_get_slot, ":prepared_for_war", ":party_no", slot_party_prepared_for_war),
                
                (try_begin),
                    (eq, "$g_disable_ai", 1),
                (else_try),
                    (eq, ":at_war", 0),

                    (try_begin),
                        (faction_slot_eq, ":party_faction", slot_faction_preparing_war, 0),
                        (party_set_slot, ":party_no", slot_party_prepared_for_war, 0),
                        (party_set_slot, ":party_no", slot_party_preparing_for_war, 0),
                        (assign, ":preparing_for_war", 0),
                        (assign, ":prepared_for_war", 0),
                    (else_try),
                        (eq, ":prepared_for_war", 0),
                        (party_set_slot, ":party_no", slot_party_preparing_for_war, 1),
                        (assign, ":preparing_for_war", 1),
                    (try_end),
                (else_try),
                    (eq, ":prepared_for_war", 0),
                    (eq, ":preparing_for_war", 0),
                    (party_set_slot, ":party_no", slot_party_preparing_for_war, 1),
                    (assign, ":preparing_for_war", 1),

                (else_try),
                    # Defend home
                    (ge, ":home", centers_begin),
                    (party_get_battle_opponent, ":attacker", ":home"),
                    (assign, ":stop", 0),
                    (try_begin),
                        (this_or_next|ge, ":attacker", 0),
                        (party_slot_ge, ":home", slot_party_besieged_by, 0),
                        
                        (try_begin),
                            (eq, ":old_mission", tm_defending),
                            (neq, ":old_mission_object", ":home"),
                            
                            (store_distance_to_party_from_party, ":home_distance", ":party_no", ":home"),
                            (store_distance_to_party_from_party, ":mission_object_distance", ":party_no", ":old_mission_object"),
                            
                            (try_begin), # Prefer to defend own territory
                                (neg|party_slot_eq, ":old_mission_object", slot_party_lord, ":leader"),
                                (val_mul, ":mission_object_distance", 2),
                                (val_div, ":mission_object_distance", 3),
                            (try_end),
                            
                            (le, ":mission_object_distance", ":home_distance"),
                            
                            (assign, ":new_mission", tm_defending),
                            (assign, ":new_mission_object", ":old_mission_object"),
                            (assign, ":stop", 1),
                        (else_try),
                            # (eq, ":home", ":walled_home"),
                            (assign, ":new_mission", tm_defending),
                            (assign, ":new_mission_object", ":home"),
                            (assign, ":stop", 1),
                        (try_end),
                    (else_try),
                        # Defend walled home
                        (neq, ":home", ":walled_home"),
                        
                        (party_get_battle_opponent, ":attacker", ":walled_home"),
                        (this_or_next|ge, ":attacker", 0),
                        (party_slot_ge, ":walled_home", slot_party_besieged_by, 0),
                        
                        (assign, ":new_mission", tm_defending),
                        (assign, ":new_mission_object", ":walled_home"),
                        (assign, ":stop", 1),
                    (try_end),
                    (eq, ":stop", 1),
                (else_try),
                    # Siege fiefs
                    (ge, ":rank", rank_castle),
                    (troop_get_slot, ":last_attack", ":leader", slot_troop_last_attack),
                    (call_script, "script_get_current_day"),
                    (assign, ":current_day", reg0),
                    (store_sub, ":diff", ":current_day", ":last_attack"),
                    (ge, ":diff", 7*24),
                    (call_script, "script_faction_find_nearest_enemy_center", ":party_faction", ":party_no", spt_castle),
                    (assign, ":center", reg0),
                    (is_between, ":center", walled_centers_begin, walled_centers_end),
                    
                    (try_begin),
                        (party_get_slot, ":besieger", ":center", slot_party_besieged_by),
                        (ge, ":besieger", 0),
                        (neq, ":besieger", ":party_no"),
                        (party_get_slot, ":besieger_leader", ":besieger", slot_party_leader),
                        (assign, ":new_mission", tm_escorting),
                        (assign, ":new_mission_object", ":besieger_leader"),
                    (else_try),
                        (assign, ":new_mission", tm_attacking),
                        (assign, ":new_mission_object", ":center"),
                    (try_end),
                (try_end),
                
                (try_begin),
                    # Follow liege
                    (troop_get_slot, ":liege", ":leader", slot_troop_vassal_of),
                    (ge, ":liege", 0),
                    (troop_slot_eq, ":liege", slot_troop_gathering, 1),
                    (troop_get_slot, ":liege_party", ":liege", slot_troop_leaded_party),
                    
                    (ge, ":liege_party", 0),
                    # We don't follow liege if we are defending territory
                    (neq, ":new_mission", tm_defending),
                    # Or if we were following someone else already
                    (this_or_next|neq, ":old_mission", tm_escorting),
                    (eq, ":old_mission_object", ":liege"),

                    (troop_get_slot, ":liege_mission", ":liege", slot_troop_mission),
                    (troop_get_slot, ":liege_mission_object", ":liege", slot_troop_mission_object),

                    (this_or_next|neq, ":liege_mission", tm_escorting),
                    (neq, ":liege_mission_object", ":leader"),

                    (try_begin),
                        # (neq, ":new_mission_object", ":home"),
                        # (troop_get_slot, ":liege_party", ":liege", slot_troop_leaded_party),

                        (assign, ":new_mission", tm_escorting),
                        (assign, ":new_mission_object", ":liege"),
                    (try_end),
                (try_end),

                (try_begin),
                    (call_script, "script_cf_party_need_troops", ":party_no"),
                    (assign, ":type", reg0),
                    (try_begin),
                        (this_or_next|ge, ":type", type_moderate),
                        (party_slot_eq, ":party_no", slot_party_preparing_for_war, 1),
                        (assign, ":new_mission", tm_none),
                    (try_end),
                (else_try),
                    (ge, ":at_war", 1),
                    (eq, ":preparing_for_war", 1),
                    (eq, ":prepared_for_war", 0),
                    (party_set_slot, ":party_no", slot_party_prepared_for_war, 1),
                    (assign, ":prepared_for_war", 1),
                    (party_set_slot, ":party_no", slot_party_preparing_for_war, 0),
                    (assign, ":preparing_for_war", 0),
                (try_end),
                
                (troop_get_slot, ":gathering", ":leader", slot_troop_gathering),
                (try_begin),
                    (ge, ":new_mission", tm_defending),
                    (try_begin),
                        (lt, ":gathering", 1),
                        (troop_set_slot, ":leader", slot_troop_gathering, 1),
                        (call_script, "script_party_gather_vassals", ":party_no"),
                    (try_end),
                (else_try),
                    (troop_set_slot, ":leader", slot_troop_gathering, -1),
                (try_end),
                
                (troop_set_slot, ":leader", slot_troop_mission, ":new_mission"),
                (troop_set_slot, ":leader", slot_troop_mission_object, ":new_mission_object"),
                (assign, ":current_iteration", 0),
            (try_end),

            (party_set_slot, ":party_no", slot_party_process_mission_iteration, ":current_iteration"),
        ]),

    # script_party_gather_vassals
    # input:
    #   arg1: party_gathering
    # output:
    #   reg0: num_gathered
    ("party_gather_vassals",
        [
            (store_script_param, ":party_no", 1),
            (store_faction_of_party, ":party_faction", ":party_no"),
            (party_get_slot, ":party_leader", ":party_no", slot_party_leader),
            (troop_get_slot, ":leader_rank", ":party_leader", slot_troop_rank),
            
            (assign, ":num_gathered", 0),
            
            (try_for_range, ":lord_no", lords_begin, lords_end),
                (troop_get_slot, ":lord_occupation", ":lord_no", slot_troop_kingdom_occupation),
                (is_between, ":lord_occupation", tko_kingdom_hero, tko_bandit),
                (store_troop_faction, ":lord_faction", ":lord_no"),
                (troop_get_slot, ":liege", ":lord_no", slot_troop_vassal_of),
                (troop_get_slot, ":lord_party", ":lord_no", slot_troop_leaded_party),
                
                (assign, ":follow_score", 0),
                (try_begin),
                    (eq, ":liege", ":party_leader"),
                    (val_add, ":follow_score", 100),
                (else_try),
                    (eq, ":lord_faction", ":party_faction"),
                    (val_add, ":follow_score", 50),
                (else_try),
                    (store_relation, ":faction_relation", ":lord_faction", ":party_faction"),
                    (try_begin),
                        (ge, ":faction_relation", relation_state_friendly),
                        (val_add, ":follow_score", 20),
                    (else_try),
                        (le, ":faction_relation", relation_state_conflict),
                        (val_add, ":follow_score", -100),
                    (else_try),
                        (le, ":faction_relation", relation_state_war),
                        (val_add, ":follow_score", -200),
                    (try_end),
                (try_end),
                
                (troop_get_slot, ":mission", ":lord_no", slot_troop_mission),
                (try_begin),
                    (eq, ":mission", tm_defending),
                    (val_add, ":follow_score", -25),
                (else_try),
                    (eq, ":mission", tm_attacking),
                    (val_add, ":follow_score", -10),
                (else_try),
                    (eq, ":mission", tm_escorting),
                    (val_add, ":follow_score", -50),
                (try_end),
                (try_begin),
                    (troop_slot_eq, ":lord_no", slot_troop_gathering, 1),
                    (val_add, ":follow_score", -50),
                (try_end),
                
                (ge, ":follow_score", 0),
                (try_begin),
                    (ge, ":lord_party", 0),
                    (store_distance_to_party_from_party, ":dist", ":party_no", ":lord_party"),
                    (store_sub, ":dist_score", 25, ":dist"),
                    (val_mul, ":dist_score", 2),
                (try_end),
                
                (troop_get_slot, ":lord_rank", ":lord_no", slot_troop_rank),
                (store_sub, ":rank_score", ":leader_rank", ":lord_rank"),
                (val_sub, ":rank_score", 1),
                (val_mul, ":rank_score", 5),
                
                (val_add, ":follow_score", ":dist_score"),
                (val_add, ":follow_score", ":rank_score"),
                
                (try_begin),
                    (ge, ":follow_score", 100),
                    (troop_set_slot, ":lord_no", slot_troop_mission, tm_escorting),
                    (troop_set_slot, ":lord_no", slot_troop_mission_object, ":party_leader"),
                (try_end),
            (try_end),
            
            (assign, reg0, ":num_gathered"),
        ]),
        
    # script_faction_find_nearest_enemy_center
    # input:
    #   arg1: faction_no
    #   arg2: party
    #   arg2: party_type
    # output:
    #   reg0: enemy_center
    ("faction_find_nearest_enemy_center",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":party", 2),
            (store_script_param, ":party_type", 3),
            
            (assign, ":best_center", -1),
            (assign, ":best_distance", 9999),
            
            (try_begin),
                (eq, ":party_type", spt_village),
                (try_for_range, ":center_no", villages_begin, villages_end),
                    (store_faction_of_party, ":center_faction", ":center_no"),
                    (store_relation, ":relation", ":center_faction", ":faction_no"),
                    (le, ":relation", relation_state_war),
                    (store_distance_to_party_from_party, ":distance", ":party", ":center_no"),
                    (lt, ":distance", ":best_distance"),
                    (assign, ":best_distance", ":distance"),
                    (assign, ":best_center", ":center_no"),
                (try_end),
            (else_try),
                # (ge, ":party_type", spt_castle),
                (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
                    (store_faction_of_party, ":center_faction", ":center_no"),
                    (store_relation, ":relation", ":center_faction", ":faction_no"),
                    (le, ":relation", relation_state_war),
                    (store_distance_to_party_from_party, ":distance", ":party", ":center_no"),
                    (lt, ":distance", ":best_distance"),
                    (assign, ":best_distance", ":distance"),
                    (assign, ":best_center", ":center_no"),
                (try_end),
            (try_end),
            
            (assign, reg0, ":best_center"),
        ]),
    
    # script_decide_follow_or_not
    # input:
    #   arg1: troop_no
    #   arg2: troop_to_follow
    # output:
    #   reg0: follow (1: yes, 0: no)
    ("decide_follow_or_not",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":troop_to_follow", 2),
            
            (assign, ":follow", 0),
            
            (troop_get_slot, ":party_to_follow", ":troop_to_follow", slot_troop_leaded_party),
            
            (try_begin),
                (ge, ":party_to_follow", 0),
                
                (try_begin),
                    (troop_slot_eq, ":troop_no", slot_troop_behavior, tai_accompanying_troop),
                    (troop_slot_eq, ":troop_no", slot_troop_behavior_object, ":troop_to_follow"),
                    
                    (assign, ":follow", 1),
                (else_try),
                    (troop_slot_ge, ":troop_to_follow", slot_troop_mission, 1), # Has a mission
                    (assign, ":follow", 0),
                (else_try),
                    (troop_slot_eq, ":troop_to_follow", slot_troop_behavior, tai_accompanying_troop),
                    (neg|troop_slot_eq, ":troop_to_follow", slot_troop_behavior_object, ":troop_no"),
                    (assign, ":follow", 0),
                (try_end),
            (try_end),
            
            (assign, reg0, ":follow"),
        ]),
    
    # script_party_does_center_business
    # input:
    #   arg1: party_no
    #   arg2: cur_town
    # output: none
    ("party_does_center_business",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":cur_town", 2),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (store_faction_of_party, ":center_faction", ":cur_town"),
            (party_get_slot, ":leader", ":party_no", slot_party_leader),

            (try_begin),
                # We clean empty parties
                (gt, ":leader", 0),
                (party_slot_eq, ":party_no", slot_party_type, spt_war_party),
                (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
                (assign, ":clean", 1),
                (try_for_range, ":stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", ":party_no", ":stack"),
                    (troop_is_hero, ":troop_id"),
                    (eq, ":troop_id", ":leader"),
                    (assign, ":clean", 0),
                    (assign, ":num_stacks", 0),
                (try_end),
                (eq, ":clean", 1),
                (party_detach, ":party_no"),
                (party_clear, ":party_no"),
            (else_try),
                (try_begin),
                    (eq, ":party_faction", ":center_faction"),
                    (party_slot_eq, ":cur_town", slot_party_leader, ":leader"),

                    # Moves prisoners to center (only if the same lord)
                    (call_script, "script_party_give_prisoners_to_party", ":party_no", ":cur_town"),
                    # Pay debts
                    (call_script, "script_party_pay_debts", ":party_no"),
                (try_end),
                
                (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
                (assign, ":limit", reg0),
                (assign, ":limit_max", reg2),
                (call_script, "script_party_get_wages", ":party_no"),
                (assign, ":wages", reg0),

                (try_begin),
                    (gt, ":wages", ":limit_max"),
                    # TODO: refine number of troops to give
                    (call_script, "script_party_give_troops_to_party", ":party_no", ":cur_town", 6),
                (else_try),
                    (lt, ":wages", ":limit"),
                    
                    (assign, ":num_reinforcements", 6),
                    (party_get_num_companions, ":num_companions", ":party_no"),
                    (try_begin),
                        (gt, ":num_companions", 0),
                        (store_div, ":average_cost", ":wages", ":num_companions"),

                        (gt, ":average_cost", 0),
                        (store_sub, ":diff", ":limit", ":wages"),
                        (store_div, ":target", ":diff", ":average_cost"),
                        (store_add, ":num_reinforcements", ":target", 3),
                    (try_end),

                    (val_max, ":num_reinforcements", 6),
                    (val_min, ":num_reinforcements", 15),

                    (call_script, "script_cf_center_can_give_troops", ":cur_town", ":party_no"),
                    
                    (try_begin),
                        (neg|party_slot_eq, ":cur_town", slot_party_lord, ":leader"),
                        (val_div, ":num_reinforcements", 2),
                    (else_try),
                        (party_slot_eq, ":party_no", slot_party_preparing_for_war, 1),
                        (val_mul, ":num_reinforcements", 2),
                    (try_end),
                    (val_add, ":num_reinforcements", 2),
                    
                    (val_min, ":num_reinforcements", 18),
                    (gt, ":num_reinforcements", 0),
                    (call_script, "script_party_give_troops_to_party", ":cur_town", ":party_no", ":num_reinforcements"),
                    (assign, ":total_cost", reg1),
                    (try_begin),
                        (neg|party_slot_eq, ":cur_town", slot_party_lord, ":leader"),
                        (call_script, "script_party_transfer_wealth", ":party_no", ":cur_town", ":total_cost", tax_type_troops_selling, tax_type_troops_buying),
                    (try_end),
                (try_end),

                (try_begin),
                    (eq, ":party_faction", ":center_faction"),
                    (party_slot_eq, ":cur_town", slot_party_leader, ":leader"),

                    # Transfer gold to/from the center
                    (call_script, "script_party_get_total_wealth", ":cur_town", 1),
                    (assign, ":center_wealth", reg0),

                    (call_script, "script_party_get_total_wealth", ":party_no", 1),
                    (assign, ":total_party_wealth", reg0),

                    (call_script, "script_party_get_wages", ":party_no"),
                    (assign, ":party_wage", reg0),

                    (store_div, ":min_wealth", ":party_wage", 2),
                    (assign, ":max_wealth", ":party_wage"),

                    (try_begin),
                        (lt, ":total_party_wealth", ":min_wealth"),
                        (store_div, ":amount", ":min_wealth", 2),
                        (try_begin),
                            (lt, ":total_party_wealth", 0),
                            (val_sub, ":amount", ":total_party_wealth"),
                        (try_end),
                        (store_div, ":max_transfer", ":center_wealth", 3), # We try to keep some gold inside center
                        (val_min, ":amount", ":max_transfer"),

                        (call_script, "script_move_gold_from_party_to_party", ":cur_town", ":party_no", ":amount"),
                    (else_try),
                        (gt, ":total_party_wealth", ":max_wealth"),
                        (store_sub, ":amount", ":total_party_wealth", ":max_wealth"),
                        (store_div, ":transfer", ":party_wage", 4),
                        (val_add, ":amount", ":transfer"),

                        (call_script, "script_move_gold_from_party_to_party", ":party_no", ":cur_town", ":amount"),
                    (try_end),
                (try_end),
            (try_end),

            
        ]),

    # script_move_gold_from_party_to_party
    # input:
    #   arg1: party_from
    #   arg2: party_to
    #   arg3: amount
    # output:
    #   reg0: gold_moved
    ("move_gold_from_party_to_party",
        [
            (store_script_param, ":party_from", 1),
            (store_script_param, ":party_to", 2),
            (store_script_param, ":amount", 3),

            (call_script, "script_party_remove_gold", ":party_from", ":amount"),
            (assign, ":removed", reg0),
            (call_script, "script_party_receive_gold", ":party_to", ":removed"),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_from"),
                (str_store_party_name, s11, ":party_to"),
                (assign, reg10, ":amount"),
                (assign, reg11, ":removed"),
                (display_message, "@{s10} move gold to {s11} (wanted: {reg10} - real {reg11})"),
            (try_end),

            (assign, reg0, 0),
        ]),
    
    # script_party_set_behavior
    # input:
    #   arg1: party_no
    #   arg2: behavior
    #   arg3: object
    # output: none
    ("party_set_behavior",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":behavior", 2),
            (store_script_param, ":object", 3),
            
            (party_get_attached_to, ":attached", ":party_no"),
            (try_begin),
                (ge, ":attached", 0),
                (party_detach, ":party_no"),
            (try_end),

            (assign, ":ai_behavior", ai_bhvr_patrol_location),
            
            (try_begin),
                (party_get_slot, ":leader", ":party_no",  slot_party_leader),
                (ge, ":leader", 0),
                (troop_set_slot, ":leader", slot_troop_behavior, ":behavior"),
                (troop_set_slot, ":leader", slot_troop_behavior_object, ":object"),
            (try_end),
            
            (try_begin),
                (eq, ":behavior", tai_patroling_center),
                (assign, ":ai_behavior", ai_bhvr_patrol_party),
                (party_set_ai_patrol_radius, ":party_no", 2),
                (assign, ":courage", 10),
                (assign, ":aggressiveness", 8),
                (assign, ":help", 200),
            (else_try),
                (eq, ":behavior", tai_patroling_party),
                (assign, ":ai_behavior", ai_bhvr_patrol_location),
                (party_set_ai_patrol_radius, ":party_no", 1),
                (assign, ":courage", 10),
                (assign, ":aggressiveness", 5),
                (assign, ":help", 100),
            (else_try),
                # Should only be used on hero parties
                (eq, ":behavior", tai_accompanying_troop),
                (troop_get_slot, ":to_follow", ":object", slot_troop_leaded_party),
                (ge, ":to_follow", 0),
                (assign, ":object", ":to_follow"),
                (assign, ":ai_behavior", ai_bhvr_escort_party),
                (assign, ":courage", 14),
                (assign, ":aggressiveness", 1),
                (assign, ":help", 500),
            (else_try),
                (eq, ":behavior", tai_accompanying_party),
                (assign, ":ai_behavior", ai_bhvr_escort_party),
                (assign, ":courage", 14),
                (assign, ":aggressiveness", 1),
                (assign, ":help", 500),
            (else_try),
                (eq, ":behavior", tai_traveling_to_party),
                (assign, ":ai_behavior", ai_bhvr_travel_to_party),
                (assign, ":courage", 10),
                (assign, ":aggressiveness", 1),
                (assign, ":help", 50),
            (else_try),
                (eq, ":behavior", tai_attacking_center),
                (party_get_position, pos1, ":object"),
                (map_get_land_position_around_position, pos2, pos1, 2),
                (assign, ":ai_behavior", ai_bhvr_travel_to_point),
                (party_set_ai_target_position, ":party_no", pos2),
                (assign, ":courage", 14),
                (assign, ":aggressiveness", 1),
                (assign, ":help", 150),
            (else_try),
                (eq, ":behavior", tai_traveling_to_point),
                (party_get_position, pos1, ":object"),
                (map_get_land_position_around_position, pos2, pos1, 2),
                (assign, ":ai_behavior", ai_bhvr_travel_to_point),
                (party_set_ai_target_position, ":party_no", pos2),
                (assign, ":courage", 10),
                (assign, ":aggressiveness", 1),
                (assign, ":help", 50),
            (else_try),
                (assign, ":ai_behavior", ai_bhvr_patrol_location),
                (party_set_ai_patrol_radius, ":party_no", 1),
                (assign, ":object", -1),
                (assign, ":courage", 10),
                (assign, ":aggressiveness", 5),
                (assign, ":help", 100),
                (str_store_party_name, s10, ":party_no"),
                (display_debug_message, "@ERROR: Invalid party_set_behavior for party {s10}", text_color_impossible),
            (try_end),

            
            (party_set_aggressiveness, ":party_no", ":aggressiveness"),
            (party_set_courage, ":party_no", ":courage"),
            (party_set_helpfulness, ":party_no", ":help"),
            
            (party_set_ai_object, ":party_no", ":object"),
            (party_set_ai_behavior, ":party_no", ":ai_behavior"),
        ]),
    
    # script_party_recruit_troops
    # input:
    #   arg1: party_no
    # output:
    #   reg0: num_recruited
    ("party_recruit_troops",
        [
            (store_script_param, ":party_no", 1),
            
            (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
            (assign, ":limit", reg0),
            (assign, ":lower_limit", reg1),

            (call_script, "script_party_get_wages", ":party_no"),
            (assign, ":wages", reg0),
            
            (party_get_num_companions, ":num_troops", ":party_no"),
            (try_begin),
                (lt, ":wages", ":limit"),
                (neg|party_slot_ge, ":party_no", slot_party_besieged_by, 0),
                
                (call_script, "script_party_add_reinforcements", ":party_no"),

                (store_mul, ":gold_cost", reg1, -1),

                (call_script, "script_party_add_accumulated_taxes", ":party_no", ":gold_cost", tax_type_troops_hiring),

                (try_begin),
                    # We do not want to buy expensive troops from other centers when we don't need it
                    (neg|party_slot_eq, ":party_no", slot_party_type, spt_village),
                    (lt, ":wages", ":lower_limit"),
                    (call_script, "script_party_ask_reinforcements", ":party_no"),
                (try_end),
                # (call_script, "script_party_add_troops_with_buildings", ":party_no"),
            (try_end),
            (party_get_num_companions, ":new_num_troops", ":party_no"),
            
            (store_sub, ":num_recruited", ":new_num_troops", ":num_troops"),
            
            (assign, reg0, ":num_recruited"),
        ]),

    # script_party_ask_reinforcements
    # input:
    #   arg1: party_no
    # output:
    #   reg0: total_troops_coming
    #   reg1: total_cost
    ("party_ask_reinforcements",
        [
            (store_script_param, ":party_no", 1),
            (store_faction_of_party, ":party_faction", ":party_no"),

            (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
            (assign, ":limit", reg0),
            (call_script, "script_party_get_wages", ":party_no"),
            (assign, ":wages", reg0),

            (store_mul, ":percentage", ":wages", 100),
            (val_div, ":percentage", ":limit"),
            (store_sub, ":base_score", 100, ":percentage"),

            # Wealthy centers can ask for more reinforcements
            (party_get_slot, ":wealth_score", ":party_no", slot_party_wealth),
            (val_div, ":wealth_score", 200),
            (val_min, ":wealth_score", 50),

            (assign, ":num_troops_coming", 0),
            (assign, ":troops_cost", 0),

            # ToDo: refine average score
            (assign, ":average_score", 100),
            (assign, ":best_center", -1),
            (assign, ":best_score", -1),
            (assign, ":best_modifier", -1),
            (assign, ":asked", 0),
            (try_for_range, ":center_no", centers_begin, centers_end),
                (neq, ":center_no", ":party_no"),
                (store_faction_of_party, ":center_faction", ":center_no"),
                # ToDo: Allow allies with reduced likelyness
                (eq, ":center_faction", ":party_faction"),

                (party_get_slot, ":garrison_flags", ":center_no", slot_party_player_garrison_flags),
                (store_and, ":send_flags", ":garrison_flags", pgf_send_mask),
                (gt, ":send_flags", 0),

                (assign, ":continue", 0),
                (party_get_slot, ":center_type", ":center_no", slot_party_type),
                (try_begin),
                    (eq, ":center_type", spt_village),

                    (party_get_slot, ":linked_center", ":center_no", slot_party_linked_party),
                    (try_begin),
                        (eq, ":linked_center", ":party_no"),
                        (assign, ":continue", 1),
                    (else_try),
                        (store_faction_of_party, ":linked_center_faction", ":linked_center"),
                        (neq, ":linked_center_faction", ":center_faction"),
                        (assign, ":continue", 1),
                    (try_end),
                (else_try),
                    (assign, ":continue", 1),
                (try_end),

                (eq, ":continue", 1),

                # Nearby centers are more likely to send troops at a lower price
                (store_distance_to_party_from_party, ":dist", ":party_no", ":center_no"),
                (val_div, ":dist", 10),
                (store_sub, ":dist_score", 30, ":dist"),
                (val_min, ":dist_score", 30),

                (call_script, "script_cf_party_get_reinforcement_price_modifier", ":center_no"),
                (assign, ":price_modifier", reg0),
                # High prices reduce chance to buy
                (store_div, ":price_score", ":price_modifier", 10),
                (store_sub, ":price_score", 100, ":price_score"),

                (store_add, ":total_score", ":base_score", ":wealth_score"),
                (val_add, ":total_score", ":dist_score"),
                (val_add, ":total_score", ":price_score"),

                # We add some noise
                (store_random_in_range, ":rand", -10, 11),

                (val_add, ":total_score", ":rand"),

                (assign, ":buy", 0),
                (try_begin),
                    (ge, ":total_score", ":average_score"),
                    (assign, ":buy", 1),
                (else_try),
                    (le, ":dist_score", 10),
                    # Very close centers are given an advantage
                    (store_mul, ":score", ":average_score", 90),
                    (val_div, ":score", 100),
                    (ge, ":total_score", ":score"),
                    (assign, ":buy", 1),
                (try_end),

                (try_begin),
                    (eq, ":buy", 1),
                    # Ask for troops

                    (store_div, ":num_men", ":total_score", 20),
                    (ge, ":num_men", 5),

                    (call_script, "script_party_send_reinforcements", ":center_no", ":party_no", ":num_men"),
                    (assign, ":num_sent", reg0),
                    (assign, ":cost", reg1),

                    (val_mul, ":cost", ":price_modifier"),
                    (val_div, ":cost", 100),

                    (val_add, ":num_troops_coming", ":num_sent"),
                    (val_add, ":troops_cost", ":cost"),

                    (val_mul, ":num_sent", 3),
                    (val_sub, ":base_score", ":num_sent"),

                    (val_add, ":asked", 1),
                (try_end),

                (try_begin),
                    (gt, ":best_score", ":total_score"),
                    (assign, ":best_score", ":total_score"),
                    (assign, ":best_center", ":center_no"),
                    (assign, ":best_modifier", ":price_modifier"),
                (try_end),
            (try_end),
            (try_begin),
                (ge, ":best_score", 0),
                (try_begin),
                    (call_script, "script_cf_debug", debug_simple|debug_war),
                    (str_store_party_name, s10, ":best_center"),
                    (str_store_party_name, s11, ":party_no"),
                    (assign, reg10, ":best_score"),
                    (display_message, "@{s10} is the best center for {s11} : {reg10}."),
                (try_end),
                # Best center has a greater number of troops sent
                (store_div, ":num_men", ":total_score", 10),
                (ge, ":num_men", 5),

                (call_script, "script_party_send_reinforcements", ":party_no", ":center_no", ":num_men"),
                (val_add, ":num_troops_coming", reg0),
                (assign, ":cost", reg1),

                (val_mul, ":cost", ":best_modifier"),
                (val_div, ":cost", 100),

                (val_add, ":troops_cost", ":cost"),
            (try_end),
            (assign, reg0, ":num_troops_coming"),
            (assign, reg1, ":troops_cost"),
        ]),

    # script_cf_party_get_reinforcement_price_modifier
        # input:
        #   arg1: party_no
        # output:
        #   reg0: price_modifier
        # fails if center cannot send troops
    ("cf_party_get_reinforcement_price_modifier",
        [
            (store_script_param, ":party_no", 1),

            (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
            (assign, ":limit", reg0),
            (call_script, "script_party_get_wages", ":party_no"),
            (assign, ":wages", reg0),

            (gt, ":wages", ":limit"),
            (gt, ":wages", 0),
            (store_mul, ":modifier", ":limit", 200),
            (val_div, ":modifier", ":wages"),

            (val_mul, ":modifier", ":modifier"),
            (val_div, ":modifier", 100),

            (assign, reg0, ":modifier"),
        ]),
    
    # script_era_get_troops_multiplier
        # input:
        #   arg1: era_no
        # output:
        #   reg0: peasant_mult
        #   reg1: common_mult
        #   reg2: veteran_mult
        #   reg3: elite_mult
        #   reg4: noble_mult
    ("era_get_troops_multiplier",
        [
            (store_script_param, ":era", 1),
            (try_begin),
                (eq, ":era", 0),
                (assign, reg0, 400),
                (assign, reg1, 40),
                (assign, reg2, 5),
                (assign, reg3, 0),
                (assign, reg4, 0),
            (else_try),
                (eq, ":era", 1),
                (assign, reg0, 320),
                (assign, reg1, 80),
                (assign, reg2, 10),
                (assign, reg3, 0),
                (assign, reg4, 1),
            (else_try),
                (eq, ":era", 2),
                (assign, reg0, 240),
                (assign, reg1, 100),
                (assign, reg2, 15),
                (assign, reg3, 0),
                (assign, reg4, 2),
            (else_try),
                (eq, ":era", 3),
                (assign, reg0, 180),
                (assign, reg1, 95),
                (assign, reg2, 20),
                (assign, reg3, 3),
                (assign, reg4, 4),
            (else_try),
                (eq, ":era", 4),
                (assign, reg0, 120),
                (assign, reg1, 90),
                (assign, reg2, 24),
                (assign, reg3, 6),
                (assign, reg4, 5),
            (else_try),
                (eq, ":era", 5),
                (assign, reg0, 70),
                (assign, reg1, 80),
                (assign, reg2, 28),
                (assign, reg3, 8),
                (assign, reg4, 6),
            (else_try),
                (eq, ":era", 6),
                (assign, reg0, 40),
                (assign, reg1, 65),
                (assign, reg2, 30),
                (assign, reg3, 10),
                (assign, reg4, 7),
            (else_try),
                (eq, ":era", 7),
                (assign, reg0, 20),
                (assign, reg1, 50),
                (assign, reg2, 32),
                (assign, reg3, 12),
                (assign, reg4, 8),
            (else_try),
                (eq, ":era", 8),
                (assign, reg0, 10),
                (assign, reg1, 35),
                (assign, reg2, 34),
                (assign, reg3, 14),
                (assign, reg4, 9),
            (else_try),
                (eq, ":era", 9),
                (assign, reg0, 5),
                (assign, reg1, 25),
                (assign, reg2, 35),
                (assign, reg3, 15),
                (assign, reg4, 10),
            (else_try),
                (eq, ":era", 10),
                (assign, reg0, 2),
                (assign, reg1, 15),
                (assign, reg2, 35),
                (assign, reg3, 18),
                (assign, reg4, 12),
            (else_try),
                (assign, reg10, ":era"),
                (display_debug_message, "@Error, incorrect era {reg10}!", text_color_impossible),
                (assign, reg0, 8),
                (assign, reg1, 10),
                (assign, reg2, 5),
                (assign, reg3, 2),
                (assign, reg4, 1),
            (try_end),
        ]),
        
    # script_faction_get_troops_modifier
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: peasant_mult
        #   reg1: common_mult
        #   reg2: veteran_mult
        #   reg3: elite_mult
        #   reg4: noble_mult
    ("faction_get_troops_modifier",
        [
            (store_script_param, ":faction_no", 1),
            
            (faction_get_slot, ":era", ":faction_no", slot_faction_era),
            (faction_get_slot, ":era_time", ":faction_no", slot_faction_era_time),
            
            (assign, ":peasant_mult", 0),
            (assign, ":common_mult", 0),
            (assign, ":veteran_mult", 0),
            (assign, ":elite_mult", 0),
            (assign, ":noble_mult", 0),
            
            (try_begin),
                (eq, ":era", 0),
                (call_script, "script_era_get_troops_multiplier", 0),
                (assign, ":peasant_mult", reg0),
                (assign, ":common_mult", reg1),
                (assign, ":veteran_mult", reg2),
                (assign, ":elite_mult", reg3),
                (assign, ":noble_mult", reg4),
            (else_try),
                (call_script, "script_era_get_troops_multiplier", ":era"),
                (assign, ":peasant_mult", reg0),
                (assign, ":common_mult", reg1),
                (assign, ":veteran_mult", reg2),
                (assign, ":elite_mult", reg3),
                (assign, ":noble_mult", reg4),
                (call_script, "script_get_current_day"),
                (assign, ":current_day", reg0),
                (store_sub, ":time_passed", ":current_day", ":era_time"),
                (try_begin),
                    (lt, ":time_passed", era_minimum_duration),
                    (store_sub, ":old_era", ":era", 1),

                    (store_mul, ":ratio", ":time_passed", 100),
                    (val_div, ":ratio", era_minimum_duration),
                    (store_sub, ":inverse", 100, ":ratio"),

                    (call_script, "script_era_get_troops_multiplier", ":old_era"),
                    (assign, ":peasant_old_mult", reg0),
                    (assign, ":common_old_mult", reg1),
                    (assign, ":veteran_old_mult", reg2),
                    (assign, ":elite_old_mult", reg3),
                    (assign, ":noble_old_mult", reg4),
                    
                    (val_mul, ":peasant_old_mult", ":ratio"),
                    (val_mul, ":common_old_mult", ":ratio"),
                    (val_mul, ":veteran_old_mult", ":ratio"),
                    (val_mul, ":elite_old_mult", ":ratio"),
                    (val_mul, ":noble_old_mult", ":ratio"),
                    
                    (val_mul, ":peasant_mult", ":inverse"),
                    (val_mul, ":common_mult", ":inverse"),
                    (val_mul, ":veteran_mult", ":inverse"),
                    (val_mul, ":elite_mult", ":inverse"),
                    (val_mul, ":noble_mult", ":inverse"),
                    
                    (val_add, ":peasant_mult", ":peasant_old_mult"),
                    (val_add, ":common_mult", ":common_old_mult"),
                    (val_add, ":veteran_mult", ":veteran_old_mult"),
                    (val_add, ":elite_mult", ":elite_old_mult"),
                    (val_add, ":noble_mult", ":noble_old_mult"),
                    
                    (val_div, ":peasant_mult", 2),
                    (val_div, ":common_mult", 2),
                    (val_div, ":veteran_mult", 2),
                    (val_div, ":elite_mult", 2),
                    (val_div, ":noble_mult", 2),
                (try_end),
            (try_end),

            (assign, reg0, ":peasant_mult"),
            (assign, reg1, ":common_mult"),
            (assign, reg2, ":veteran_mult"),
            (assign, reg3, ":elite_mult"),
            (assign, reg4, ":noble_mult"),
        ]),

    # script_faction_apply_assimilation
        # input:
        #   arg1: faction_no
        #   arg2: original_faction
        # output:
        #   reg0: output_faction
    ("faction_apply_assimilation",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":original_faction", 2),

            (assign, ":continue", 0),

            (faction_get_slot, ":assimilation_type", ":faction_no", slot_faction_policy_assimilation),
            (try_begin),
                (eq, ":assimilation_type", sfpa_total),
                (assign, ":continue", 0),
            (else_try),
                (eq, ":assimilation_type", sfpa_partial),

                (faction_get_slot, ":faction_culture", ":faction_no", slot_faction_culture),
                (faction_get_slot, ":original_faction_culture", ":original_faction", slot_faction_culture),

                (eq, ":faction_culture", ":original_faction_culture"),
                (assign, ":continue", 1),
            (else_try),
                (eq, ":assimilation_type", sfpa_none),
                (assign, ":continue", 1),
            (try_end),

            (try_begin),
                (eq, ":continue", 1),
                (assign, reg0, ":original_faction"),
            (else_try),
                (assign, reg0, ":faction_no"),
            (try_end),
        ]),
    
    # script_party_add_reinforcements
        # input:
        #   arg1: party_no
        # output:
        #   reg0: num_added
        #   reg1: total_cost
    ("party_add_reinforcements",
        [
            (store_script_param, ":party_no", 1),
            (store_faction_of_party, ":faction", ":party_no"),
            (party_get_slot, ":original_faction", ":party_no", slot_party_original_faction),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (call_script, "script_faction_apply_assimilation", ":faction", ":original_faction"),
            (assign, ":faction", reg0),

            (faction_get_slot, ":culture", ":faction", slot_faction_culture),
            
            (call_script, "script_faction_get_troops_modifier", ":faction"),
            (assign, ":num_peasant", reg0),
            (assign, ":num_common", reg1),
            (assign, ":num_veteran", reg2),
            (assign, ":num_elite", reg3),
            (assign, ":num_noble", reg4),
            
            (try_begin),
                (eq, ":party_type", spt_village),
                (val_mul, ":num_peasant", 4),   # 400%
                (val_div, ":num_common", 2),    # 50%
                (val_div, ":num_veteran", 10),  # 10%
                (val_mul, ":num_elite", 0),     # 0%
                (val_mul, ":num_noble", 0),     # 0%
            (else_try),
                (eq, ":party_type", spt_town),
                # (val_mul, ":num_peasant", 3),   # 100%
                # (val_div, ":num_peasant", 2),
                (val_mul, ":num_common", 3),    # 150%
                (val_div, ":num_common", 2),
                (val_mul, ":num_veteran", 3),   # 75%
                (val_div, ":num_veteran", 4),
                (val_mul, ":num_elite", 11),    # 110%
                (val_div, ":num_elite", 10),
                (val_mul, ":num_noble", 3),     # 150%
                (val_div, ":num_noble", 2),
            (else_try),
                (eq, ":party_type", spt_castle),
                (val_mul, ":num_peasant", 3),   # 75%
                (val_div, ":num_peasant", 4),
                (val_mul, ":num_common", 9),    # 90%
                (val_div, ":num_common", 10),
                # (val_mul, ":num_veteran", 1),   # 100%
                # (val_mul, ":num_elite", 1),     # 100%
                (val_mul, ":num_noble", 9),     # 90%
                (val_div, ":num_noble", 10),
            (try_end),
            
            (faction_get_slot, ":peasant_mod", ":faction", slot_faction_peasant_num_tries),
            (faction_get_slot, ":common_mod", ":faction", slot_faction_common_num_tries),
            (faction_get_slot, ":veteran_mod", ":faction", slot_faction_veteran_num_tries),
            (faction_get_slot, ":elite_mod", ":faction", slot_faction_elite_num_tries),
            (faction_get_slot, ":noble_mod", ":faction", slot_faction_noble_num_tries),
            
            (store_mul, ":faction_peasant", ":num_peasant", ":peasant_mod"),
            (store_mul, ":faction_common", ":num_common", ":common_mod"),
            (store_mul, ":faction_veteran", ":num_veteran", ":veteran_mod"),
            (store_mul, ":faction_elite", ":num_elite", ":elite_mod"),
            (store_mul, ":faction_noble", ":num_noble", ":noble_mod"),
            (val_div, ":faction_peasant", 100),
            (val_div, ":faction_common", 100),
            (val_div, ":faction_veteran", 100),
            (val_div, ":faction_elite", 100),
            (val_div, ":faction_noble", 100),
            
            (val_add, ":num_peasant", ":faction_peasant"),
            (val_add, ":num_common", ":faction_common"),
            (val_add, ":num_veteran", ":faction_veteran"),
            (val_add, ":num_elite", ":faction_elite"),
            (val_add, ":num_noble", ":faction_noble"),
            
            (assign, ":peasant_max", ":num_peasant"),
            (store_add, ":common_max", ":peasant_max", ":num_common"),
            (store_add, ":veteran_max", ":common_max", ":num_veteran"),
            (store_add, ":elite_max", ":veteran_max", ":num_elite"),
            (store_add, ":noble_max", ":elite_max", ":num_noble"),
            
            (faction_get_slot, ":peasant_begin", ":culture", slot_faction_peasant_begin),
            (faction_get_slot, ":common_begin", ":culture", slot_faction_common_begin),
            (faction_get_slot, ":veteran_begin", ":culture", slot_faction_veteran_begin),
            (faction_get_slot, ":elite_begin", ":culture", slot_faction_elite_begin),
            (faction_get_slot, ":noble_begin", ":culture", slot_faction_noble_begin),
            (faction_get_slot, ":troops_end", ":culture", slot_faction_troops_end),
            
            (assign, ":num_added", 0),
            (assign, ":total_cost", 0),
            
            # (assign, ":reinforcements", 0),
            (store_random_in_range, ":random", 0, ":noble_max"),
            (store_random_in_range, ":random_number", 50, 100),
            (try_begin),
                (lt, ":random", ":peasant_max"),
                (store_mul, ":num_to_add", 17, ":random_number"),
                (val_div, ":num_to_add", 100),
                (call_script, "script_party_add_troops", ":party_no", ":peasant_begin", ":common_begin", ":num_to_add"),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (else_try),
                (lt, ":random", ":common_max"),
                (store_mul, ":num_to_add", 13, ":random_number"),
                (val_div, ":num_to_add", 100),
                (call_script, "script_party_add_troops", ":party_no", ":common_begin", ":veteran_begin", ":num_to_add"),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (else_try),
                (lt, ":random", ":veteran_max"),
                (store_mul, ":num_to_add", 9, ":random_number"),
                (val_div, ":num_to_add", 100),
                (call_script, "script_party_add_troops", ":party_no", ":veteran_begin", ":elite_begin", ":num_to_add"),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (else_try),
                (lt, ":random", ":elite_max"),
                (store_mul, ":num_to_add", 5, ":random_number"),
                (val_div, ":num_to_add", 100),
                (call_script, "script_party_add_troops", ":party_no", ":elite_begin", ":noble_begin", ":num_to_add"),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (else_try),
                (lt, ":random", ":noble_max"),
                (store_mul, ":num_to_add", 3, ":random_number"),
                (val_div, ":num_to_add", 100),
                (call_script, "script_party_add_troops", ":party_no", ":elite_begin", ":noble_begin", ":num_to_add"),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
                (call_script, "script_party_add_troops", ":party_no", ":noble_begin", ":troops_end", 1),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (try_end),
            # (try_begin),
                # (gt, ":reinforcements", 0),
                
                # (party_add_template, ":party_no", ":reinforcements"),
            # (try_end),
            # (assign, reg0, ":reinforcements"),
            (assign, reg0, ":num_added"),
            (assign, reg1, ":total_cost"),
        ]),
    
    # script_party_add_troops
        # input:
        #   arg1: party_no
        #   arg2: begin of troops to add
        #   arg3: end of troops to add
        #   arg4: number of troops to add
        # output:
        #   reg0: num_added
        #   reg1: total_cost
    ("party_add_troops",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":begin", 2),
            (store_script_param, ":end", 3),
            (store_script_param, ":num_tries", 4),
            
            (store_faction_of_party, ":faction", ":party_no"),
            (party_get_slot, ":original_faction", ":party_no", slot_party_original_faction),

            (call_script, "script_faction_apply_assimilation", ":faction", ":original_faction"),
            (assign, ":faction", reg0),
            
            (assign, ":total_weight", 0),
            
            (assign, ":num_added", 0),
            (assign, ":total_cost", 0),
            
            (try_for_range, ":cur_troop", ":begin", ":end"),
                (call_script, "script_troop_get_recruitment_weight", ":cur_troop", ":faction", ":party_no"),
                (assign, ":original_weight", reg0),

                (store_add, ":weight", ":original_weight", ":total_weight"),
                (troop_set_slot, ":cur_troop", slot_troop_temp_slot, ":weight"),
                
                (val_add, ":total_weight", ":original_weight"),
            (try_end),
            
            (try_for_range, ":unused", 0, ":num_tries"),
                (store_random_in_range, ":random", 0, ":total_weight"),
                (assign, ":stop", ":end"),
                (try_for_range, ":cur_troop", ":begin", ":stop"),
                    (troop_slot_ge, ":cur_troop", slot_troop_temp_slot, ":random"),
                    (party_add_members, ":party_no", ":cur_troop", 1),
                    (try_begin),
                        (lt, reg0, 1),
                        (try_begin),
                            (call_script, "script_cf_debug", debug_simple),
                            (display_message, "@Unable to add troop"),
                        (try_end),
                    (else_try),
                        (call_script, "script_troop_get_cost", ":cur_troop"),
                        (assign, ":troop_cost", reg0),
                        (val_add, ":num_added", 1),
                        (val_add, ":total_cost", ":troop_cost"),
                    (try_end),
                    (assign, ":stop", 0),
                (try_end),
            (try_end),
            (assign, reg0, ":num_added"),
            (assign, reg1, ":total_cost"),
        ]),

    # script_troop_get_recruitment_weight
        # input:
        #   arg1: troop_no
        #   arg2: faction_no
        #   arg3: party_recruiting
        # output:
        #   reg0: troop_weight
    ("troop_get_recruitment_weight",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":faction_no", 2),
            (store_script_param, ":party_no", 3),

            (troop_get_slot, ":only_faction_1", ":troop_no", slot_troop_faction_reserved_1),
            (troop_get_slot, ":only_faction_2", ":troop_no", slot_troop_faction_reserved_2),
            (troop_get_slot, ":no_faction_1", ":troop_no", slot_troop_faction_not_1),
            (troop_get_slot, ":no_faction_2", ":troop_no", slot_troop_faction_not_2),
            (troop_get_slot, ":no_faction_3", ":troop_no", slot_troop_faction_not_3),

            (troop_get_slot, ":multiplier_weight", ":troop_no", slot_troop_ratio_special_multiplier),
                
            (troop_get_slot, ":troop_type", ":troop_no", slot_troop_type),
            
            (store_add, ":faction_slot", ":troop_type", slot_faction_troop_ratio_infantry),
            (val_add, ":faction_slot", -1),

            (assign, ":weight", 0),

            (try_begin),
                (this_or_next|eq, ":only_faction_1", -1),
                (this_or_next|eq, ":only_faction_1", ":faction_no"),
                (eq, ":only_faction_2", ":faction_no"),
                (neq, ":no_faction_1", ":faction_no"),
                (neq, ":no_faction_2", ":faction_no"),
                (neq, ":no_faction_3", ":faction_no"),
                
                (faction_get_slot, ":original_weight", ":faction_no", ":faction_slot"),
                (assign, ":weight", ":original_weight"),
            (else_try),
                (ge, ":only_faction_1", 0), # Nearby parties can recruit faction troops at a reduced rate
                
                (faction_get_slot, ":leader", ":only_faction_1", slot_faction_leader),
                (assign, ":weight", 0),
                (try_begin),
                    (ge, ":leader", 0),
                    (call_script, "script_troop_get_current_home", ":leader", 1),
                    (assign, ":home", reg0),
                    (ge, ":home", centers_begin),
                    (store_distance_to_party_from_party, ":distance", ":party_no", ":home"),
                    (lt, ":distance", 50),
                    
                    (store_sub, ":mul", 60, ":distance"),
                    
                    (faction_get_slot, ":original_weight", ":faction_no", ":faction_slot"),
                    (val_mul, ":original_weight", ":mul"),
                    (val_div, ":original_weight", 180),

                    (assign, ":weight", ":original_weight"),
                (try_end),

                (try_begin),
                    (ge, ":only_faction_2", 0),
                    (faction_get_slot, ":leader", ":only_faction_2", slot_faction_leader),
                    (ge, ":leader", 0),
                    (call_script, "script_troop_get_current_home", ":leader", 1),
                    (assign, ":home", reg0),
                    (ge, ":home", centers_begin),
                    (store_distance_to_party_from_party, ":distance", ":party_no", ":home"),
                    (lt, ":distance", 50),

                    (store_sub, ":mul", 60, ":distance"),
                    
                    (faction_get_slot, ":original_weight_2", ":faction_no", ":faction_slot"),
                    (val_mul, ":original_weight_2", ":mul"),
                    (val_div, ":original_weight_2", 180),

                    (val_add, ":weight", ":original_weight_2"),
                (try_end),
            (try_end),

            (try_begin),
                (ge, ":multiplier_weight", 0),
                (val_mul, ":weight", ":multiplier_weight"),
                (val_div, ":weight", 100),
            (try_end),

            (assign, reg0, ":weight"),
        ]),

    # script_party_send_reinforcements
        # input:
        #   arg1: party_no
        #   arg2: party_to_send_to
        #   arg3: optimal_number_to_send
        # output:
        #   reg0: num_sent
        #   reg1: base_troop_cost
    ("party_send_reinforcements",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":linked_center", 2),
            (store_script_param, ":num_troops", 3),
            
            (assign, ":num_sent", 0),
            (assign, ":total_cost", 0),
            
            (try_begin),
                (store_faction_of_party, ":faction", ":party_no"),
                (store_faction_of_party, ":linked_faction", ":linked_center"),
                (eq, ":faction", ":linked_faction"),

                (call_script, "script_party_send_troops", ":party_no", ":linked_center", ":num_troops"),
                (assign, ":num_sent", reg0),
                (assign, ":total_cost", reg1),
                
                (call_script, "script_party_create_debt", ":linked_center", ":party_no", ":total_cost"),
            (try_end),
            
            (assign, reg0, ":num_sent"),
            (assign, reg1, ":total_cost"),
        ]),

    # script_party_send_troops
    # input:
    #   arg1: party_no
    #   arg2: party_to_send_to
    #   arg3: optimal_number_to_send
    # output:
    #   reg0: num_sent
    #   reg1: base_troop_cost
    ("party_send_troops",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":linked_center", 2),
            (store_script_param, ":num_troops", 3),
            
            (assign, ":num_sent", 0),
            (assign, ":total_cost", 0),
            
            (store_faction_of_party, ":linked_faction", ":linked_center"),
            
            (call_script, "script_spawn_party_around_party", ":party_no", "pt_reinforcements"),
            (assign, ":spawned_party", reg0),
            
            (party_set_faction, ":spawned_party", ":linked_faction"),
        
            (call_script, "script_party_give_troops_to_party", ":party_no", ":spawned_party", ":num_troops"),
            
            (val_add, ":num_sent", reg0),
            (val_add, ":total_cost", reg1),

            (party_set_slot, ":spawned_party", slot_party_type, spt_convoy),
            (party_set_slot, ":spawned_party", slot_party_mission, spm_reinforce),
            (party_set_slot, ":spawned_party", slot_party_mission_object, ":linked_center"),
            
            (party_set_ai_behavior, ":spawned_party", ai_bhvr_travel_to_party),
            (party_set_ai_object, ":spawned_party", ":linked_center"),
            
            (try_begin),
                (eq, ":num_sent", 0),
                (remove_party, ":spawned_party"),
            # (else_try),
            #     (call_script, "script_cf_debug", debug_faction),
            #     (str_store_party_name, s10, ":party_no"),
            #     (str_store_party_name, s11, ":linked_center"),
            #     (assign, reg10, ":num_sent"),
            #     (assign, reg11, ":total_cost"),
            #     (call_script, "script_game_get_money_text", reg11),
            #     (display_message, "@{s10} sends {reg10} men to {s11} ({s0})."),
            (try_end),
            
            (assign, reg0, ":num_sent"),
            (assign, reg1, ":total_cost"),
        ]),
    
    # script_party_give_troops_to_party
    # input:
    #   arg1: giver_party
    #   arg2: receiver_party
    #   arg3: num_troops
    # output:
    #   reg0: num_added
    #   reg1: base_troop_cost
    ("party_give_troops_to_party",
        [
            (store_script_param, ":giver_party", 1),
            (store_script_param, ":receiver_party", 2),
            (store_script_param, ":num_troops", 3),
            
            (assign, ":num_added", 0),
            (assign, ":total_cost", 0),

            # (try_begin),
            #     (call_script, "script_cf_debug", debug_current),
            #     (str_store_party_name, s10, ":receiver_party"),
            #     (str_store_party_name, s11, ":giver_party"),
            #     (assign, reg10, ":num_troops"),
            #     (display_message, "@{s10} taking {reg10} troops from {s11}"),
            # (try_end),
            
            (party_get_slot, ":receiver_party_type", ":receiver_party", slot_party_type),
            (party_get_slot, ":giver_party_type", ":giver_party", slot_party_type),
            (try_begin),
                (eq, ":receiver_party_type", spt_war_party),
                (party_get_slot, ":leader", ":receiver_party", slot_party_leader),
                (party_get_slot, ":giver_leader", ":giver_party", slot_party_lord),
                (assign, ":priority", -1),
                (try_begin),
                    (eq, ":leader", ":giver_leader"),
                    (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", -1, 0),
                    (val_add, ":num_added", reg0),
                    (val_add, ":total_cost", reg1),
                (else_try),
                    (troop_get_slot, ":leader_rank", ":leader", slot_troop_rank),
                    (try_begin),
                        (le, ":leader_rank", rank_affiliated),
                        (assign, ":priority", tq_peasant),
                    (else_try),
                        (le, ":leader_rank", rank_two_village),
                        (assign, ":priority", tq_veteran),
                    (else_try),
                        (assign, ":priority", tq_elite),
                    (try_end),
                    (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", ":priority", 0),
                    (val_add, ":num_added", reg0),
                    (val_add, ":total_cost", reg1),
                (try_end),
            (else_try),
                (eq, ":giver_party_type", spt_war_party),
                (is_between, ":receiver_party_type", spt_village, spt_fort+1),
                (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", tq_veteran, 0),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            (else_try),
                # (eq, ":receiver_party_type", spt_convoy),
                (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", tq_veteran, 0),
                (val_add, ":num_added", reg0),
                (val_add, ":total_cost", reg1),
            # (else_try),
                # (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", 10, 0),
            (try_end),
            
            (assign, reg0, ":num_added"),
            (assign, reg1, ":total_cost"),
        ]),
    
    # script_party_give_troops_to_party_priority
    # input:
    #   arg1: giver_party
    #   arg2: receiver_party
    #   arg3: num_to_transfer
    #   arg4: priority
    #   arg5: move_heroes
    # output:
    #   reg0: num_transfered
    #   reg1: base_troop_cost
    ("party_give_troops_to_party_priority",
        [
            (store_script_param, ":giver_party", 1),
            (store_script_param, ":receiver_party", 2),
            (store_script_param, ":num_troops", 3),
            (store_script_param, ":priority", 4),
            (store_script_param, ":move_heroes", 5),

            (assign, ":num_added", 0),
            (assign, ":total_cost", 0),

            (call_script, "script_party_get_masked_garrison_flags", ":giver_party", ":receiver_party"),
            (assign, ":garrison_flags", reg0),

            (party_get_num_companion_stacks, ":num_stacks", ":giver_party"),
            (assign, ":cur_value", 0),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":cur_troop", ":giver_party", ":cur_stack"),
                (try_begin),
                    (this_or_next|neg|troop_is_hero, ":cur_troop"),
                    (eq, ":move_heroes", 1),
                    (troop_get_slot, ":troop_quality", ":cur_troop", slot_troop_quality),
                    (assign, ":value", 2),
                    (try_begin),
                        (gt, ":troop_quality", ":priority"),
                        (troop_set_slot, ":cur_troop", slot_troop_temp_slot, ":cur_value"),
                    (else_try),
                        (party_stack_get_size, ":stack_size", ":giver_party", ":cur_stack"),
                        (val_mul, ":value", ":stack_size"),
                        (try_begin),
                            (eq, ":troop_quality", ":priority"),
                            (val_div, ":value", 2),
                        (else_try),
                            (eq, ":priority", -1),
                            (try_begin),
                                (eq, ":troop_quality", tq_peasant),
                                (val_div, ":value", 6),
                            (else_try),
                                (eq, ":troop_quality", tq_common),
                                (val_div, ":value", 3),
                            (try_end),
                        (try_end),
                        (assign, ":flags", 0),
                        (try_begin),
                            (eq, ":troop_quality", tq_peasant),
                            (store_and, ":flags", ":garrison_flags", pgf_levy_mask),
                        (else_try),
                            (eq, ":troop_quality", tq_common),
                            (store_and, ":flags", ":garrison_flags", pgf_common_mask),
                        (else_try),
                            (eq, ":troop_quality", tq_veteran),
                            (store_and, ":flags", ":garrison_flags", pgf_veteran_mask),
                        (else_try),
                            (eq, ":troop_quality", tq_elite),
                            (store_and, ":flags", ":garrison_flags", pgf_elite_mask),
                        (else_try),
                            (eq, ":troop_quality", tq_noble),
                            (store_and, ":flags", ":garrison_flags", pgf_noble_mask),
                        (try_end),
                        (gt, ":flags", 0),
                        (val_add, ":cur_value", ":value"),
                        (troop_set_slot, ":cur_troop", slot_troop_temp_slot, ":cur_value"),
                    (else_try),
                        (troop_set_slot, ":cur_troop", slot_troop_temp_slot, ":cur_value"),    
                    (try_end),
                (else_try),
                    (troop_set_slot, ":cur_troop", slot_troop_temp_slot, ":cur_value"),
                (try_end),
            (try_end),
            
            (try_for_range, ":unused", 0, ":num_troops"),
                (party_get_num_companion_stacks, ":num_stacks", ":giver_party"),
                (store_sub, ":last_stack", ":num_stacks", 1),
                (ge, ":last_stack", 0),
                (party_stack_get_troop_id, ":last_troop", ":giver_party", ":last_stack"),
                # (this_or_next|neg|troop_is_hero, ":last_troop"),
                # (eq, ":move_heroes", 1),
                (troop_get_slot, ":max_rand", ":last_troop", slot_troop_temp_slot),
                (store_random_in_range, ":rand", 0, ":max_rand"),
                (try_for_range, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":cur_troop", ":giver_party", ":cur_stack"),
                    (this_or_next|neg|troop_is_hero, ":cur_troop"),
                    (eq, ":move_heroes", 1),
                    (troop_get_slot, ":value", ":cur_troop", slot_troop_temp_slot),
                    (try_begin),
                        # (neq, ":value", -1),
                        (lt, ":rand", ":value"),
                        
                        (party_add_members, ":receiver_party", ":cur_troop", 1),
                        (val_add, ":num_added", reg0),
                        (party_remove_members, ":giver_party", ":cur_troop", reg0),
                        (assign, ":num_stacks", 0),
                        (call_script, "script_troop_get_cost", ":cur_troop"),
                        (val_add, ":total_cost", reg0),
                    (try_end),
                (try_end),
            (try_end),
            
            (try_begin),
                (lt, ":num_added", ":num_troops"),
                (val_sub, ":num_troops", ":num_added"),
                (call_script, "script_party_give_troops_to_party_priority", ":giver_party", ":receiver_party", ":num_troops", 10, 0),
                (val_add, ":num_added", reg0),
            (try_end),
            
            (assign, reg0, ":num_added"),
            (assign, reg1, ":total_cost"),
        ]),
    
    # script_party_modify_population
    # input:
    #   arg1: party_no
    #   arg2: value
    # output: none
    ("party_modify_population",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":value", 2),
            
            (party_get_slot, ":population", ":party_no", slot_party_population),
            (val_add, ":population", ":value"),
            (party_set_slot, ":party_no", slot_party_population, ":population"),
        ]),
    
    # script_party_modify_wealth
    # input:
    #   arg1: party_no
    #   arg2: value
    # output: none
    ("party_modify_wealth",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":value", 2),

            (try_begin),
                (eq, ":party_no", "$g_player_party"),
                (try_begin),
                    (gt, ":value", 0),
                    (troop_add_gold, "$g_player_troop", ":value"),
                (else_try),
                    (lt, ":value", 0),
                    (val_mul, ":value", -1),
                    (troop_remove_gold, "$g_player_troop", ":value"),
                (try_end),
            (else_try),
                (party_get_slot, ":wealth", ":party_no", slot_party_wealth),
                (val_add, ":wealth", ":value"),
                (party_set_slot, ":party_no", slot_party_wealth, ":wealth"),
            (try_end),
        ]),
    
    # script_init_building_slots
    # input: none
    # output: none
    ("init_building_slots",
        [
            (item_set_slot, "itm_building_hunter_camp", slot_building_cost_wood, 420),
            (item_set_slot, "itm_building_hunter_camp", slot_building_cost_stone, 0),
            (item_set_slot, "itm_building_hunter_camp", slot_building_cost_gold, 2000),
            (item_set_slot, "itm_building_hunter_camp", slot_building_build_time, 240),
            
            (item_set_slot, "itm_building_woodcutter_camp", slot_building_cost_wood, 260),
            (item_set_slot, "itm_building_woodcutter_camp", slot_building_cost_stone, 0),
            (item_set_slot, "itm_building_woodcutter_camp", slot_building_cost_gold, 3600),
            (item_set_slot, "itm_building_woodcutter_camp", slot_building_build_time, 300),
            
            (item_set_slot, "itm_building_mill", slot_building_cost_wood, 280),
            (item_set_slot, "itm_building_mill", slot_building_cost_stone, 220),
            (item_set_slot, "itm_building_mill", slot_building_cost_gold, 2500),
            (item_set_slot, "itm_building_mill", slot_building_build_time, 360),
            
            (item_set_slot, "itm_building_fish_pond", slot_building_cost_wood, 380),
            (item_set_slot, "itm_building_fish_pond", slot_building_cost_stone, 0),
            (item_set_slot, "itm_building_fish_pond", slot_building_cost_gold, 3000),
            (item_set_slot, "itm_building_fish_pond", slot_building_build_time, 280),
            
            (item_set_slot, "itm_building_mine", slot_building_cost_wood, 140),
            (item_set_slot, "itm_building_mine", slot_building_cost_stone, 0),
            (item_set_slot, "itm_building_mine", slot_building_cost_gold, 8000),
            (item_set_slot, "itm_building_mine", slot_building_build_time, 600),
            
            (item_set_slot, "itm_building_stone_pit", slot_building_cost_wood, 100),
            (item_set_slot, "itm_building_stone_pit", slot_building_cost_stone, 0),
            (item_set_slot, "itm_building_stone_pit", slot_building_cost_gold, 4000),
            (item_set_slot, "itm_building_stone_pit", slot_building_build_time, 480),
            
            (item_set_slot, "itm_building_cattle_ranch", slot_building_cost_wood, 220),
            (item_set_slot, "itm_building_cattle_ranch", slot_building_cost_stone, 160),
            (item_set_slot, "itm_building_cattle_ranch", slot_building_cost_gold, 2200),
            (item_set_slot, "itm_building_cattle_ranch", slot_building_build_time, 220),
            
            (item_set_slot, "itm_building_farm", slot_building_cost_wood, 140),
            (item_set_slot, "itm_building_farm", slot_building_cost_stone, 40),
            (item_set_slot, "itm_building_farm", slot_building_cost_gold, 2000),
            (item_set_slot, "itm_building_farm", slot_building_build_time, 320),
            
            (item_set_slot, "itm_building_slaver", slot_building_cost_wood, 120),
            (item_set_slot, "itm_building_slaver", slot_building_cost_stone, 50),
            (item_set_slot, "itm_building_slaver", slot_building_cost_gold, 3000),
            (item_set_slot, "itm_building_slaver", slot_building_build_time, 260),
            
            (item_set_slot, "itm_building_market", slot_building_cost_wood, 320),
            (item_set_slot, "itm_building_market", slot_building_cost_stone, 80),
            (item_set_slot, "itm_building_market", slot_building_cost_gold, 3400),
            (item_set_slot, "itm_building_market", slot_building_build_time, 360),
            
            (item_set_slot, "itm_building_market_2", slot_building_cost_wood, 480),
            (item_set_slot, "itm_building_market_2", slot_building_cost_stone, 120),
            (item_set_slot, "itm_building_market_2", slot_building_cost_gold, 5100),
            (item_set_slot, "itm_building_market_2", slot_building_build_time, 540),
            
            (item_set_slot, "itm_building_fields", slot_building_cost_wood, 120),
            (item_set_slot, "itm_building_fields", slot_building_cost_stone, 20),
            (item_set_slot, "itm_building_fields", slot_building_cost_gold, 4000),
            (item_set_slot, "itm_building_fields", slot_building_build_time, 480),
            
            (item_set_slot, "itm_building_tannery", slot_building_cost_wood, 200),
            (item_set_slot, "itm_building_tannery", slot_building_cost_stone, 200),
            (item_set_slot, "itm_building_tannery", slot_building_cost_gold, 5000),
            (item_set_slot, "itm_building_tannery", slot_building_build_time, 280),
            
            (item_set_slot, "itm_building_tavern", slot_building_cost_wood, 280),
            (item_set_slot, "itm_building_tavern", slot_building_cost_stone, 180),
            (item_set_slot, "itm_building_tavern", slot_building_cost_gold, 2800),
            (item_set_slot, "itm_building_tavern", slot_building_build_time, 240),
            
            (item_set_slot, "itm_building_militia_camp", slot_building_cost_wood, 240),
            (item_set_slot, "itm_building_militia_camp", slot_building_cost_stone, 100),
            (item_set_slot, "itm_building_militia_camp", slot_building_cost_gold, 4000),
            (item_set_slot, "itm_building_militia_camp", slot_building_build_time, 300),
            
            (item_set_slot, "itm_building_smithy", slot_building_cost_wood, 140),
            (item_set_slot, "itm_building_smithy", slot_building_cost_stone, 120),
            (item_set_slot, "itm_building_smithy", slot_building_cost_gold, 5000),
            (item_set_slot, "itm_building_smithy", slot_building_build_time, 420),
            
            (item_set_slot, "itm_building_stables", slot_building_cost_wood, 300),
            (item_set_slot, "itm_building_stables", slot_building_cost_stone, 60),
            (item_set_slot, "itm_building_stables", slot_building_cost_gold, 4500),
            (item_set_slot, "itm_building_stables", slot_building_build_time, 380),
            
            (item_set_slot, "itm_building_archery_range", slot_building_cost_wood, 100),
            (item_set_slot, "itm_building_archery_range", slot_building_cost_stone, 20),
            (item_set_slot, "itm_building_archery_range", slot_building_cost_gold, 2000),
            (item_set_slot, "itm_building_archery_range", slot_building_build_time, 200),
            
            (item_set_slot, "itm_building_barrack", slot_building_cost_wood, 200),
            (item_set_slot, "itm_building_barrack", slot_building_cost_stone, 340),
            (item_set_slot, "itm_building_barrack", slot_building_cost_gold, 3000),
            (item_set_slot, "itm_building_barrack", slot_building_build_time, 300),
            
            (item_set_slot, "itm_building_food_store", slot_building_cost_wood, 280),
            (item_set_slot, "itm_building_food_store", slot_building_cost_stone, 220),
            (item_set_slot, "itm_building_food_store", slot_building_cost_gold, 2000),
            (item_set_slot, "itm_building_food_store", slot_building_build_time, 260),

            (item_set_slot, "itm_building_recruitement_camp", slot_building_cost_wood, 120),
            (item_set_slot, "itm_building_recruitement_camp", slot_building_cost_stone, 80),
            (item_set_slot, "itm_building_recruitement_camp", slot_building_cost_gold, 4800),
            (item_set_slot, "itm_building_recruitement_camp", slot_building_build_time, 300),

            (item_set_slot, "itm_building_barrack_2", slot_building_cost_wood, 300),
            (item_set_slot, "itm_building_barrack_2", slot_building_cost_stone, 510),
            (item_set_slot, "itm_building_barrack_2", slot_building_cost_gold, 4500),
            (item_set_slot, "itm_building_barrack_2", slot_building_build_time, 450),

            (item_set_slot, "itm_building_smithy_2", slot_building_cost_wood, 210),
            (item_set_slot, "itm_building_smithy_2", slot_building_cost_stone, 180),
            (item_set_slot, "itm_building_smithy_2", slot_building_cost_gold, 7500),
            (item_set_slot, "itm_building_smithy_2", slot_building_build_time, 630),

            (item_set_slot, "itm_building_training_camp", slot_building_cost_wood, 150),
            (item_set_slot, "itm_building_training_camp", slot_building_cost_stone, 110),
            (item_set_slot, "itm_building_training_camp", slot_building_cost_gold, 5400),
            (item_set_slot, "itm_building_training_camp", slot_building_build_time, 360),

            (item_set_slot, "itm_building_training_camp_2", slot_building_cost_wood, 225),
            (item_set_slot, "itm_building_training_camp_2", slot_building_cost_stone, 165),
            (item_set_slot, "itm_building_training_camp_2", slot_building_cost_gold, 8100),
            (item_set_slot, "itm_building_training_camp_2", slot_building_build_time, 540),
            
            (item_set_slot, "itm_building_workshop", slot_building_cost_wood, 250),
            (item_set_slot, "itm_building_workshop", slot_building_cost_stone, 250),
            (item_set_slot, "itm_building_workshop", slot_building_cost_gold, 6700),
            (item_set_slot, "itm_building_workshop", slot_building_build_time, 480),
            
            (item_set_slot, "itm_building_fletcher", slot_building_cost_wood, 220),
            (item_set_slot, "itm_building_fletcher", slot_building_cost_stone, 20),
            (item_set_slot, "itm_building_fletcher", slot_building_cost_gold, 400),
            (item_set_slot, "itm_building_fletcher", slot_building_build_time, 320),

            (item_set_slot, "itm_building_archery_range_2", slot_building_cost_wood, 150),
            (item_set_slot, "itm_building_archery_range_2", slot_building_cost_stone, 30),
            (item_set_slot, "itm_building_archery_range_2", slot_building_cost_gold, 3000),
            (item_set_slot, "itm_building_archery_range_2", slot_building_build_time, 300),

            (item_set_slot, "itm_building_trading_post", slot_building_cost_wood, 280),
            (item_set_slot, "itm_building_trading_post", slot_building_cost_stone, 50),
            (item_set_slot, "itm_building_trading_post", slot_building_cost_gold, 6200),
            (item_set_slot, "itm_building_trading_post", slot_building_build_time, 320),

            (item_set_slot, "itm_building_food_store_2", slot_building_cost_wood, 420),
            (item_set_slot, "itm_building_food_store_2", slot_building_cost_stone, 330),
            (item_set_slot, "itm_building_food_store_2", slot_building_cost_gold, 3000),
            (item_set_slot, "itm_building_food_store_2", slot_building_build_time, 390),

            (item_set_slot, "itm_building_recruitement_camp_2", slot_building_cost_wood, 180),
            (item_set_slot, "itm_building_recruitement_camp_2", slot_building_cost_stone, 120),
            (item_set_slot, "itm_building_recruitement_camp_2", slot_building_cost_gold, 7200),
            (item_set_slot, "itm_building_recruitement_camp_2", slot_building_build_time, 450),
            
            (item_set_slot, "itm_building_university", slot_building_cost_wood, 390),
            (item_set_slot, "itm_building_university", slot_building_cost_stone, 600),
            (item_set_slot, "itm_building_university", slot_building_cost_gold, 8000),
            (item_set_slot, "itm_building_university", slot_building_build_time, 680),

            (item_set_slot, "itm_building_slaver_2", slot_building_cost_wood, 180),
            (item_set_slot, "itm_building_slaver_2", slot_building_cost_stone, 75),
            (item_set_slot, "itm_building_slaver_2", slot_building_cost_gold, 4500),
            (item_set_slot, "itm_building_slaver_2", slot_building_build_time, 390),

            (item_set_slot, "itm_building_market_3", slot_building_cost_wood, 720),
            (item_set_slot, "itm_building_market_3", slot_building_cost_stone, 180),
            (item_set_slot, "itm_building_market_3", slot_building_cost_gold, 7650),
            (item_set_slot, "itm_building_market_3", slot_building_build_time, 810),
            
            (item_set_slot, "itm_building_temple", slot_building_cost_wood, 220),
            (item_set_slot, "itm_building_temple", slot_building_cost_stone, 800),
            (item_set_slot, "itm_building_temple", slot_building_cost_gold, 10000),
            (item_set_slot, "itm_building_temple", slot_building_build_time, 920),

            (item_set_slot, "itm_building_library", slot_building_cost_wood, 560),
            (item_set_slot, "itm_building_library", slot_building_cost_stone, 240),
            (item_set_slot, "itm_building_library", slot_building_cost_gold, 7600),
            (item_set_slot, "itm_building_library", slot_building_build_time, 600),

            (item_set_slot, "itm_building_order", slot_building_cost_wood, 250),
            (item_set_slot, "itm_building_order", slot_building_cost_stone, 750),
            (item_set_slot, "itm_building_order", slot_building_cost_gold, 15000),
            (item_set_slot, "itm_building_order", slot_building_build_time, 1200),

            (item_set_slot, "itm_building_tavern_2", slot_building_cost_wood, 420),
            (item_set_slot, "itm_building_tavern_2", slot_building_cost_stone, 270),
            (item_set_slot, "itm_building_tavern_2", slot_building_cost_gold, 5600),
            (item_set_slot, "itm_building_tavern_2", slot_building_build_time, 360),

            (item_set_slot, "itm_building_trading_post_2", slot_building_cost_wood, 520),
            (item_set_slot, "itm_building_trading_post_2", slot_building_cost_stone, 75),
            (item_set_slot, "itm_building_trading_post_2", slot_building_cost_gold, 9300),
            (item_set_slot, "itm_building_trading_post_2", slot_building_build_time, 480),
        ]),
    
    # script_party_has_building
    # input:
    #   arg1: party_no
    #   arg2: building
    # output:
    #   reg0: building_state
    ("party_has_building",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":building", 2),
            
            (assign, ":has_building", -1),
            
            (assign, ":end", slot_party_building_slot_end),
            (try_for_range, ":building_slot", slot_party_building_slot_1, ":end"),
                (party_get_slot, ":cur_building", ":party_no", ":building_slot"),
                (try_begin),
                    (eq, ":cur_building", ":building"),
                    (val_add, ":building_slot", num_building_slots),
                    (party_get_slot, ":has_building", ":party_no", ":building_slot"), # gets building state
                    (assign, ":end", 0),
                (try_end),
            (try_end),
            
            (assign, reg0, ":has_building"),
        ]),
    
    # script_cf_party_need_troops
    # input:
    #   arg1: party_no
    # output:
    #   reg0: need_type
    ("cf_party_need_troops",
        [
            # ToDo: improve
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (assign, ":need", 0),
            (assign, ":type", type_none),

            (try_begin),
                (is_between, ":party_no", spt_village, spt_fort + 1),
                (call_script, "script_center_need_troops", ":party_no"),
                (assign, ":type", type_moderate),
                (assign, ":need", reg0),
            (else_try),
                (eq, ":party_type", spt_war_party),
                (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
                (assign, ":party_limit", reg0),
                (assign, ":party_limit_min", reg1),
                (call_script, "script_party_get_wages", ":party_no"),
                (assign, ":wages", reg0),

                (try_begin),
                    (lt, ":wages", ":party_limit"),
                    (assign, ":need", 1),
                    (assign, ":type", type_slight),
                    (lt, ":wages", ":party_limit_min"),
                    (assign, ":type", type_moderate),

                    (store_div, ":party_combat_limit", ":party_limit", 4),
                    (lt, ":wages", ":party_combat_limit"),
                    (assign, ":type", type_critical),
                (try_end),
            (try_end),

            (assign, reg0, ":type"),
            (eq, ":need", 1),
        ]),
    
    # script_center_need_troops
    # input:
    #   arg1: center_no
    # output:
    #   reg0: need_troops
    ("center_need_troops",
        [
            # ToDo: improve
            (store_script_param, ":party_no", 1),
            
            # (neg|troop_slot_ge, ":party_no", slot_party_besieged_by, 0),

            (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
            # We use minimum party size
            (assign, ":limit", reg1),
            (call_script, "script_party_get_wages", ":party_no"),
            (assign, ":wages", reg0),
            
            (try_begin),
                (lt, ":wages", ":limit"),
                (assign, reg0, 1),
            (else_try),
                (assign, reg0, 0),
            (try_end),
        ]),
    
    # script_troop_get_rank
    # input:
    #   arg1: troop_no
    # output:
    #   reg0: rank
    ("troop_get_rank",
        [
            (store_script_param, ":troop_no", 1),
            
            (assign, ":end", centers_end),
            (assign, ":rank", 0),
            
            (store_troop_faction, ":faction", ":troop_no"),
            (try_for_range, ":cur_center", centers_begin, ":end"),
                # (store_faction_of_party, ":center_faction", ":cur_center"),
                # (eq, ":faction", ":center_faction"),
                (party_get_slot, ":party_type", ":cur_center", slot_party_type),
                (try_begin),
                    (eq, ":party_type", spt_village),
                    (lt, ":rank", rank_two_village),
                    
                    (party_get_slot, ":lord", ":cur_center", slot_party_lord),
                    (try_begin),
                        (eq, ":lord", ":troop_no"),
                        (val_add, ":rank", 1),
                        (val_max, ":rank", rank_village),
                        (val_min, ":rank", rank_two_village),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (lt, ":rank", rank_castle),
                    (party_get_slot, ":lord", ":cur_center", slot_party_lord),
                    (try_begin),
                        (eq, ":lord", ":troop_no"),
                        (assign, ":rank", rank_castle),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_town),
                    (party_get_slot, ":lord", ":cur_center", slot_party_lord),
                    (try_begin),
                        (eq, ":lord", ":troop_no"),
                        (assign, ":rank", rank_city),
                    (try_end),
                (try_end),
            (try_end),
            (faction_get_slot, ":faction_size", ":faction", slot_faction_size_category),
            (try_begin),
                (eq, ":faction_size", sfs_large), # King and marshall ranks are only applied if kingdom is big enough
                (try_begin),
                    (faction_slot_eq, ":faction", slot_faction_leader, ":troop_no"),
                    (assign, ":rank", rank_king),
                # (else_try),
                #     (faction_slot_eq, ":faction", slot_faction_marshall, ":troop_no"),
                #     (assign, ":rank", rank_marshall),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":rank", 0),
                (troop_get_slot, ":master", ":troop_no", slot_troop_vassal_of),
                (try_begin),
                    (ge, ":master", 0),
                    (assign, ":rank", rank_affiliated),
                (try_end),
            (try_end),
            
            (assign, reg0, ":rank"),
        ]),
    
    # script_troop_update_level
        # input:
        #   arg1: troop_no
        #   arg2: cur_rank
        #   arg3: new_rank
        # output:
        #   reg0: rank_changed (1 yes, 0 no)
    ("troop_update_level",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":cur_rank", 2),
            (store_script_param, ":new_rank", 3),
            
            (assign, ":changed", 0),
            
            (store_sub, ":diff", ":new_rank", ":cur_rank"),
            (store_mul, ":chance", ":diff", ":diff"),
            (try_begin),
                (gt, ":diff", 0),
                (val_mul, ":chance", 4),
            (else_try),
                # (lt, ":diff", 0),
                (val_mul, ":chance", 2),
            (try_end),
            
            (store_random_in_range, ":rand", 0, 100),
            (try_begin),
                (lt, ":rand", ":chance"),
                
                (assign, reg11, ":cur_rank"),
                (try_begin),
                    (gt, ":diff", 0),
                    (val_add, ":cur_rank", 1),
                (else_try),
                    (val_sub, ":cur_rank", 1),
                (try_end),
                (call_script, "script_troop_change_level", ":troop_no", ":cur_rank"),
                (try_begin),
                    (call_script, "script_cf_debug", debug_simple|debug_faction),
                    (str_store_troop_name, s10, ":troop_no"),
                    (assign, reg10, ":cur_rank"),
                    (display_message, "@{s10} changed level: from {reg11} to {reg10}."),
                (try_end),
                (assign, ":changed", 1),
            (try_end),
            
            (assign, reg0, ":changed"),
        ]),
    
    # script_init_lord
        # input:
        #   arg1: lord_no
        # output: none
    ("init_lord",
        [
            (store_script_param, ":lord_no", 1),
            
            (troop_set_slot, ":lord_no", slot_troop_kingdom_occupation, tko_none),
            (troop_set_slot, ":lord_no", slot_troop_vassal_of, -1),
            (troop_set_slot, ":lord_no", slot_troop_original_faction, "fac_faction_8"),
            (troop_set_slot, ":lord_no", slot_troop_culture, "fac_culture_7"),
            (troop_set_slot, ":lord_no", slot_troop_leaded_party, -1),
            (troop_set_slot, ":lord_no", slot_troop_died, -1),
            (troop_set_slot, ":lord_no", slot_troop_prisoner_of, -1),
            # (troop_set_slot, ":lord_no", slot_troop_prisoner_in, -1),
            (troop_set_slot, ":lord_no", slot_troop_last_met, -1),
            (troop_set_slot, ":lord_no", slot_troop_gathering, -1),
            # We need a minimum amount of wanted wages to cover for a few troops
            # (troop_set_slot, ":lord_no", slot_troop_wanted_party_wages, 800),

            # Reset family
            (try_for_range, ":slot", slot_troop_married_to, slot_troop_child_10+1),
                (try_begin),
                    (troop_get_slot, ":relative", ":lord_no", ":slot"),
                    (ge, ":relative", 0),
                    (try_for_range, ":other_slot", slot_troop_married_to, slot_troop_child_10+1),
                        (troop_slot_eq, ":relative", ":other_slot", ":lord_no"),
                        (troop_set_slot, ":relative", ":other_slot", -1),
                    (try_end),
                (try_end),
                (troop_set_slot, ":lord_no", ":slot", -1),
            (try_end),
            # Reset relations
            (store_sub, ":own_offset", ":lord_no", npc_heroes_begin),
            (store_add, ":own_relation_slot", ":own_offset", slot_troop_relations_begin),
            (try_for_range, ":other_troop", npc_heroes_begin, npc_heroes_end),
                (store_sub, ":offset", ":other_troop", npc_heroes_begin),
                (store_add, ":relation_slot", slot_troop_relations_begin, ":offset"),
                (troop_set_slot, ":lord_no", ":relation_slot", 0),
                (troop_set_slot, ":other_troop", ":own_relation_slot", 0),
            (try_end),
        ]),
    
    # script_ready_lord
        # input:
        #   arg1: lord_no
        #   arg2: faction_no
        #   arg3: activate
        # output: none
    ("ready_lord",
        [
            (store_script_param, ":lord_no", 1),
            (store_script_param, ":faction_no", 2),
            (store_script_param, ":activate", 3),
            
            (troop_set_faction, ":lord_no", ":faction_no"),

            (faction_get_slot, ":culture", ":faction_no", slot_faction_culture),
            (try_begin),
                (neg|is_between, ":culture", cultures_begin, cultures_end),
                (assign, ":culture", "fac_culture_7"),
            (try_end),
            
            (troop_set_slot, ":lord_no", slot_troop_original_faction, ":faction_no"),
            (troop_set_slot, ":lord_no", slot_troop_culture, ":culture"),
            (troop_set_slot, ":lord_no", slot_troop_renown, 0),
            (troop_set_slot, ":lord_no", slot_troop_num_vassal, 0),
            
            (try_begin),
                (eq, ":activate", 1),
                (troop_set_slot, ":lord_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
            (else_try),
                (troop_set_slot, ":lord_no", slot_troop_kingdom_occupation, tko_reserved),
            (try_end),
            
            (call_script, "script_troop_set_equip_type", ":lord_no"),
            (call_script, "script_troop_change_level", ":lord_no", 0),
            (troop_set_slot, ":lord_no", slot_troop_rank, rank_none),
            (call_script, "script_troop_set_name", ":lord_no"),
            (call_script, "script_troop_update_name", ":lord_no"),

            (try_begin),
                (eq, ":activate", 1),
                (call_script, "script_troop_update_home", ":lord_no"),
            (try_end),
            
            # ToDo: refine banner selection
            (store_random_in_range, ":banner", banner_scene_props_begin, banner_scene_props_end),
            (troop_set_slot, ":lord_no", slot_troop_banner_scene_prop, ":banner"),
            
            (call_script, "script_troop_get_face_code", ":lord_no"),
            (troop_set_face_keys, ":lord_no", s0),
            
            # Reset state
            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            (troop_set_slot, ":lord_no", slot_troop_last_attack, ":current_day"),
            (troop_set_slot, ":lord_no", slot_troop_last_rest, ":current_day"),
            
            (try_begin),
                (eq, ":activate", 1),
                (faction_get_slot, ":num_vassals", ":faction_no", slot_faction_num_vassals),
                (val_add, ":num_vassals", 1),
                (faction_set_slot, ":faction_no", slot_faction_num_vassals, ":num_vassals"),
            (try_end),
        ]),

    # script_activate_lord
        # input:
        #   arg1: troop_no
        # output: none
    ("activate_lord",
        [
            (store_script_param, ":lord_no", 1),

            (troop_set_slot, ":lord_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
            (call_script, "script_troop_update_home", ":lord_no"),

            (store_troop_faction, ":faction_no", ":lord_no"),
            (faction_get_slot, ":num_vassals", ":faction_no", slot_faction_num_vassals),
            (val_add, ":num_vassals", 1),
            (faction_set_slot, ":faction_no", slot_faction_num_vassals, ":num_vassals"),
        ]),

    # script_faction_get_notables
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: num_notables
        #   result in temp_troop slots slot_troop_temp_array_begin
    ("faction_get_notables",
        [
            (store_script_param, ":faction_no", 1),
            (assign, ":begin", slot_troop_temp_array_begin),

            (assign, ":num_notables", 0),
            (try_for_range, ":lord_no", lords_begin, lords_end),
                (troop_get_slot, ":occupation", ":lord_no", slot_troop_kingdom_occupation),
                (eq, ":occupation", tko_reserved),
                (store_troop_faction, ":lord_faction", ":lord_no"),
                (eq, ":lord_faction", ":faction_no"),
                (store_add, ":slot", ":begin", ":num_notables"),
                (troop_set_slot, "trp_temp_troop", ":slot", ":lord_no"),
                (val_add, ":num_notables", 1),
            (try_end),
            (try_begin),
                (lt, ":num_notables", 6),
                (store_sub, ":missing", 6,  ":num_notables"),
                (try_for_range, ":unused", 0, ":missing"),
                    (call_script, "script_find_free_lord"),
                    (assign, ":lord_no", reg0),
                    (call_script, "script_ready_lord", ":lord_no", ":faction_no", 0),
                    (store_add, ":slot", ":num_notables", slot_troop_temp_array_begin),
                    (troop_set_slot, "trp_temp_troop", ":slot", ":lord_no"),
                    (val_add, ":num_notables", 1),
                (try_end),
            (try_end),
            (assign, reg0, ":num_notables"),
        ]),

    # script_troop_death
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_death",
        [
            (store_script_param, ":troop_no", 1),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_current),
                (str_store_troop_name_link, s10, ":troop_no"),
                (display_log_message, "@{s10} has died", text_color_impossible),
            (try_end),

            (troop_set_slot, ":troop_no", slot_troop_kingdom_occupation, tko_dead),
            (troop_set_slot, ":troop_no", slot_troop_died, ":current_day"),

            (assign, ":living_relative", 0),
            # Reset troop if every relative are dead
            (try_for_range, ":slot", slot_troop_married_to, slot_troop_child_10+1),
                (troop_get_slot, ":relative", ":troop_no", ":slot"),
                (try_begin),
                    (ge, ":relative", 0),
                    (troop_get_slot, ":relative_dead", ":relative", slot_troop_kingdom_occupation),
                    (try_begin),
                        (eq, ":relative_dead", tko_dead),
                        (assign, ":other_living_relative", 0),
                        # Reset relative if it has no living relative
                        (try_for_range, ":other_slot", slot_troop_married_to, slot_troop_child_10+1),
                            (troop_get_slot, ":other_relative", ":relative", ":other_slot"),
                            (troop_get_slot, ":occupation", ":other_relative", slot_troop_kingdom_occupation),
                            (gt, ":occupation", tko_dead),
                            (assign, ":other_living_relative", 1),
                        (try_end),
                        (try_begin),
                            (eq, ":other_living_relative", 0),

                            (try_begin),
                                (call_script, "script_cf_debug", debug_current),
                                (str_store_troop_name_link, s10, ":relative"),
                                (display_log_message, "@{s10} has no remaining relatives being reset", text_color_debug),
                            (try_end),

                            (call_script, "script_init_lord", ":relative"),
                        (try_end),
                    (else_try),
                        (assign, ":living_relative", 1),
                    (try_end),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":living_relative", 0),

                (try_begin),
                    (call_script, "script_cf_debug", debug_current),
                    (str_store_troop_name_link, s10, ":troop_no"),
                    (display_log_message, "@{s10} has no remaining relatives being reset", text_color_debug),
                (try_end),

                (call_script, "script_init_lord", ":troop_no"),
            (try_end),
        ]),
    
    # script_troop_set_name
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_set_name",
        [
            (store_script_param, ":troop_no", 1),
            (troop_get_slot, ":culture", ":troop_no", slot_troop_culture),
            
            (faction_get_slot, ":names_begin", ":culture", slot_faction_names_begin),
            (faction_get_slot, ":names_end", ":culture", slot_faction_names_end),
            
            (store_random_in_range, ":name", ":names_begin", ":names_end"),
            (troop_set_plural_name, ":troop_no", ":name"),
        ]),

    # script_troop_give_center_to_troop_pl
        # input:
        #   arg1: giver_troop_no
        #   arg2: center
        #   arg3: receiver_troop
        # output: none
    ("troop_give_center_to_troop_pl",
        [
            (store_script_param, ":giver_troop_no", 1),
            (store_script_param, ":center", 2),
            (store_script_param, ":receiver_troop", 3),

            (try_begin),
                (eq, ":receiver_troop", "$g_player_troop"),

                (assign, reg20, ":giver_troop_no"),
                (assign, reg21, ":center"),
                (jump_to_menu, "mnu_player_receive_center"),
            (else_try),
                (call_script, "script_troop_give_center_to_troop", ":giver_troop_no", ":center", ":receiver_troop"),
            (try_end),
        ]),

    
    # script_troop_give_center_to_troop
        # input:
        #   arg1: giver_troop_no
        #   arg2: center
        #   arg3: receiver_troop
        # output: none
    ("troop_give_center_to_troop",
        [
            (store_script_param, ":giver_troop_no", 1),
            (store_script_param, ":center", 2),
            (store_script_param, ":receiver_troop", 3),
            
            (try_begin),
                (store_troop_faction, ":player_faction", "$g_player_troop"),
                (store_troop_faction, ":giver_faction", ":giver_troop_no"),
                (store_troop_faction, ":receiver_faction", ":receiver_troop"),
                (store_relation, ":giver_faction_player_faction_relation", ":player_faction", ":giver_faction"),
                (store_relation, ":receiver_faction_player_faction_relation", ":player_faction", ":receiver_faction"),
                (this_or_next|eq, ":player_faction", ":giver_faction"),
                (this_or_next|eq, ":player_faction", ":receiver_faction"),

                (this_or_next|ge, ":giver_faction_player_faction_relation", relation_state_friendly),
                (ge, ":receiver_faction_player_faction_relation", relation_state_friendly),

                (str_store_troop_name_link, s10, ":giver_troop_no"),
                (str_store_troop_name_link, s11, ":receiver_troop"),
                (str_store_party_name_link, s12, ":center"),
                (display_log_message, "@{s10} grants {s12} to {s11}", text_color_freed),
            (else_try),
                (call_script, "script_cf_debug", debug_faction|debug_simple),
                (str_store_troop_name_link, s10, ":giver_troop_no"),
                (str_store_troop_name_link, s11, ":receiver_troop"),
                (str_store_party_name_link, s12, ":center"),
                (display_log_message, "@{s10} grants {s12} to {s11}", text_color_freed),
            (try_end),

            (troop_get_slot, ":rank", ":receiver_troop", slot_troop_rank),
            (call_script, "script_party_get_renown_value", ":center"),
            (store_div, ":renown_bonus", reg0, 4),
            (try_begin),
                (ge, ":rank", rank_city),
                (val_sub, ":renown_bonus", 350),
            (else_try),
                (ge, ":rank", rank_castle),
                (val_sub, ":renown_bonus", 150),
            (else_try),
                (ge, ":rank", rank_two_village),
                (val_sub, ":renown_bonus", 70),
            (else_try),
                (ge, ":rank", rank_village),
                (val_sub, ":renown_bonus", 25),
            (try_end),

            (try_begin),
                (gt, ":renown_bonus", 0),
                (call_script, "script_troop_change_renown", ":receiver_troop", ":renown_bonus"),
            (try_end),

            (call_script, "script_troop_become_vassal", ":receiver_troop", ":giver_troop_no"),
            
            (call_script, "script_give_center_to_troop", ":center", ":receiver_troop"),
            (call_script, "script_troop_get_surplus_center", ":giver_troop_no"),
            (assign, ":surplus_center", reg0),
            (troop_set_slot, ":giver_troop_no", slot_troop_surplus_center, ":surplus_center"),
            
            (call_script, "script_troop_get_surplus_center", ":receiver_troop"),
            (assign, ":surplus_center", reg0),
            (troop_set_slot, ":receiver_troop", slot_troop_surplus_center, ":surplus_center"),
        ]),

    # script_troop_become_vassal
        # input:
        #   arg1: overlord
        #   arg2: vassal
        # output: none
    ("troop_become_vassal",
        [
            (store_script_param, ":vassal", 1),
            (store_script_param, ":overlord", 2),

            (try_begin),
                (neg|troop_slot_eq, ":vassal", slot_troop_vassal_of, ":overlord"),
                (troop_get_slot, ":num_vassal", ":overlord", slot_troop_num_vassal),
                (val_add, ":num_vassal", 1),
                (troop_set_slot, ":overlord", slot_troop_num_vassal, ":num_vassal"),
            (try_end),
            (troop_set_slot, ":vassal", slot_troop_vassal_of, ":overlord"),

            (store_troop_faction, ":vassal_faction", ":vassal"),
            (store_troop_faction, ":overlord_faction", ":overlord"),
            (try_begin),
                (neq, ":vassal_faction", ":overlord_faction"),

                (troop_set_faction, ":vassal", ":overlord_faction"),

                (troop_get_slot, ":vassal_party", ":vassal", slot_troop_leaded_party),
                (ge, ":vassal_party", 0),
                (party_set_faction, ":vassal_party", ":overlord_faction"),
            (try_end),
        ]),
    
    # script_give_center_to_troop
        # input:
        #   arg1: center_no
        #   arg2: troop_no
        # output: none
    ("give_center_to_troop",
        [
            (store_script_param, ":center_no", 1),
            (store_script_param, ":troop_no", 2),
            
            (troop_get_slot, ":old_rank", ":troop_no", slot_troop_rank),
            
            (party_set_slot, ":center_no", slot_party_lord, ":troop_no"),
            (party_set_slot, ":center_no", slot_party_reserved, -1),
            
            (call_script, "script_troop_get_rank", ":troop_no"),
            (assign, ":rank", reg0),
            (troop_set_slot, ":troop_no", slot_troop_rank, ":rank"),
            
            (call_script, "script_troop_update_name", ":troop_no"),
            (call_script, "script_troop_update_home", ":troop_no"),
            
            (try_begin),
                (ge, ":old_rank", rank_village),
                (call_script, "script_troop_get_current_home", ":troop_no", 0),
                (assign, ":home", reg0),
                (is_between, ":home", walled_centers_begin, walled_centers_end),
                (assign, ":end", centers_end),
                (try_for_range, ":center_no", centers_begin, ":end"),
                    (party_slot_eq, ":center_no", slot_party_lord, ":troop_no"),
                    (neq, ":center_no", ":home"),
                    (troop_set_slot, ":troop_no", slot_troop_surplus_center, ":center_no"),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_current),
                        (str_store_troop_name, s10, ":troop_no"),
                        (str_store_party_name, s11, ":center_no"),
                        (display_message, "@{s10} has surplus center {s11}"),
                    (try_end),
                    (assign, ":end", 0),
                (try_end),
            (try_end),
        ]),
    
    # script_init_troops_factions
    # input: none
    # output: none
    ("init_troops_factions",
        [
            (try_for_range, ":cur_troop", soldiers_begin, soldiers_end),
                (store_troop_faction, ":troop_faction", ":cur_troop"),
                (try_begin),
                    (neg|is_between, ":troop_faction", kingdoms_begin, small_kingdoms_begin),
                    (troop_set_slot, ":cur_troop", slot_troop_faction_reserved_1, ":troop_faction"),
                (else_try),
                    (troop_set_slot, ":cur_troop", slot_troop_faction_reserved_1, -1),
                (try_end),
                (troop_set_slot, ":cur_troop", slot_troop_faction_reserved_2, -1),
                (troop_set_slot, ":cur_troop", slot_troop_faction_not_1, -1),
                (troop_set_slot, ":cur_troop", slot_troop_faction_not_2, -1),
                (troop_set_slot, ":cur_troop", slot_troop_faction_not_3, -1),

                (troop_set_slot, ":cur_troop", slot_troop_ratio_special_multiplier, -1),
            (try_end),
            
            # Troops not added to factions
            (troop_set_slot, "trp_swadian_champion", slot_troop_faction_not_1, "fac_small_kingdom_12"), # Has Heavy Infantry instead
            (troop_set_slot, "trp_swadian_light_lancer", slot_troop_faction_not_1, "fac_small_kingdom_13"), # Has Lancer instead
            (troop_set_slot, "trp_swadian_light_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_13"), # Has Horseman instead
            (troop_set_slot, "trp_swadian_militia", slot_troop_faction_not_1, "fac_small_kingdom_14"), # Has Hunter instead
            (troop_set_slot, "trp_swadian_light_bowman", slot_troop_faction_not_1, "fac_small_kingdom_14"), # Has Light Longbowman instead
            (troop_set_slot, "trp_swadian_bowman", slot_troop_faction_not_1, "fac_small_kingdom_14"), # Has Heavy Longbowman instead
            (troop_set_slot, "trp_swadian_pikeman", slot_troop_faction_not_1, "fac_small_kingdom_15"), # Has Spearman instead
            (troop_set_slot, "trp_swadian_champion", slot_troop_faction_not_2, "fac_small_kingdom_17"), # 
            (troop_set_slot, "trp_swadian_heavy_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_17"), # Has Squire instead

            (troop_set_slot, "trp_swadian_levy_spearman", slot_troop_faction_reserved_2, "fac_small_kingdom_15"),
            (troop_set_slot, "trp_swadian_foot_knight", slot_troop_faction_reserved_2, "fac_small_kingdom_15"),

            (troop_set_slot, "trp_vaegir_hunter", slot_troop_faction_not_1, "fac_small_kingdom_23"), # Has Militia instead
            (troop_set_slot, "trp_vaegir_hunter", slot_troop_faction_not_2, "fac_small_kingdom_22"), # Has Militia instead
            (troop_set_slot, "trp_vaegir_heavy_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_22"), # Has Horseman instead
            (troop_set_slot, "trp_vaegir_light_infantry", slot_troop_faction_not_2, "fac_small_kingdom_22"), # Has Light Club Infantry instead
            (troop_set_slot, "trp_vaegir_heavy_infantry", slot_troop_faction_not_2, "fac_small_kingdom_22"), # Has Club Infantry instead
            (troop_set_slot, "trp_vaegir_light_infantry", slot_troop_faction_not_1, "fac_small_kingdom_23"), # Has Footman instead
            (troop_set_slot, "trp_vaegir_heavy_infantry", slot_troop_faction_not_1, "fac_small_kingdom_23"), # Has Heavy Footman instead
            (troop_set_slot, "trp_vaegir_guard", slot_troop_faction_not_1, "fac_small_kingdom_25"), # Has Heavy Pikeman instead
            (troop_set_slot, "trp_vaegir_medium_bowman", slot_troop_faction_not_1, "fac_small_kingdom_25"), # Has Longbowman instead
            (troop_set_slot, "trp_vaegir_mounted_bowman", slot_troop_faction_not_1, "fac_small_kingdom_21"), # Has Hussar instead
            (troop_set_slot, "trp_vaegir_mounted_bowman", slot_troop_faction_not_2, "fac_small_kingdom_25"), # Has Mounted Longbowman instead
            (troop_set_slot, "trp_vaegir_royal_hussar", slot_troop_faction_not_1, "fac_small_kingdom_25"), # Has Royal Mounted Longbowman instead
            
            (troop_set_slot, "trp_vaegir_militia", slot_troop_faction_reserved_2, "fac_small_kingdom_22"),

            (troop_set_slot, "trp_khergit_noble", slot_troop_faction_not_1, "fac_small_kingdom_31"), # Has Noble Mounted Skirmisher
            (troop_set_slot, "trp_khergit_light_lancer", slot_troop_faction_not_1, "fac_small_kingdom_31"), # Has Light Mounted Skirmisher instead
            (troop_set_slot, "trp_khergit_lancer", slot_troop_faction_not_1, "fac_small_kingdom_31"), # Has Mounted Skirmisher instead
            (troop_set_slot, "trp_khergit_horse_archer", slot_troop_faction_not_1, "fac_small_kingdom_31"), # Has Mounted Skirmisher instead
            (troop_set_slot, "trp_khergit_heavy_horse_archer", slot_troop_faction_not_1, "fac_small_kingdom_31"), # Has Heavy Mounted Skirmisher instead
            (troop_set_slot, "trp_khergit_light_infantry", slot_troop_faction_not_1, "fac_small_kingdom_32"), # Has Light Skirmisher instead
            (troop_set_slot, "trp_khergit_skirmisher", slot_troop_faction_not_1, "fac_small_kingdom_32"), # Has Light Skirmisher instead
            (troop_set_slot, "trp_khergit_guard", slot_troop_faction_not_1, "fac_small_kingdom_32"), # Has Heavy Skirmisher instead
            (troop_set_slot, "trp_khergit_light_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_33"), # Has Light Steppe Cavalry instead
            (troop_set_slot, "trp_khergit_heavy_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_33"), # Has Heavy Steppe Cavalry instead
            (troop_set_slot, "trp_khergit_light_mounted_skirmisher", slot_troop_faction_not_1, "fac_small_kingdom_33"), # Has Light Horse Archer instead
            (troop_set_slot, "trp_khergit_noble", slot_troop_faction_not_2, "fac_small_kingdom_34"), # Has Noble Cavalry and Noble Lancer instead
            (troop_set_slot, "trp_khergit_light_mounted_skirmisher", slot_troop_faction_not_2, "fac_small_kingdom_35"), # Has Light Horseman instead
            (troop_set_slot, "trp_khergit_light_lancer", slot_troop_faction_not_2, "fac_small_kingdom_35"), # Has Light Horseman instead
            (troop_set_slot, "trp_khergit_lancer", slot_troop_faction_not_2, "fac_small_kingdom_35"), # Has Heavy Horseman instead
            (troop_set_slot, "trp_khergit_guard", slot_troop_faction_not_2, "fac_small_kingdom_36"), # Has Blade-Master instead
            
            (troop_set_slot, "trp_khergit_noble_cavalry", slot_troop_faction_reserved_2, "fac_small_kingdom_31"), # Has Noble Mounted Skirmisher
            
            (troop_set_slot, "trp_nord_horseman", slot_troop_faction_not_3, "fac_small_kingdom_41"), # Has Cavalry instead
            (troop_set_slot, "trp_nord_militia", slot_troop_faction_not_1, "fac_small_kingdom_44"), # Has Levy Crossbowman instead
            (troop_set_slot, "trp_nord_light_bowman", slot_troop_faction_not_1, "fac_small_kingdom_42"), # Has Light Longbowman instead
            (troop_set_slot, "trp_nord_heavy_bowman", slot_troop_faction_not_1, "fac_small_kingdom_42"), # Has Heavy Longbowman instead
            (troop_set_slot, "trp_nord_light_infantry", slot_troop_faction_not_1, "fac_small_kingdom_42"), # Has Footman instead
            (troop_set_slot, "trp_nord_light_infantry", slot_troop_faction_not_2, "fac_small_kingdom_43"), # Has Skirmisher instead
            (troop_set_slot, "trp_nord_light_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_43"), # Has Light Mounted Skirmisher instead
            (troop_set_slot, "trp_nord_horseman", slot_troop_faction_not_1, "fac_small_kingdom_44"), # Has Spear Cavalry instead
            (troop_set_slot, "trp_nord_heavy_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_44"), # Has Heavy Spear Cavalry instead
            (troop_set_slot, "trp_nord_medium_longbowman", slot_troop_faction_not_2, "fac_small_kingdom_44"), # Has Crossbowman instead
            (troop_set_slot, "trp_nord_medium_longbowman", slot_troop_faction_not_1, "fac_small_kingdom_45"), # Has Bowman instead
            (troop_set_slot, "trp_nord_light_cavalry", slot_troop_faction_not_2, "fac_small_kingdom_45"), # Has Light Spear Cavalry instead
            (troop_set_slot, "trp_nord_horseman", slot_troop_faction_not_2, "fac_small_kingdom_45"), # Has Spear Cavalry instead
            (troop_set_slot, "trp_nord_heavy_cavalry", slot_troop_faction_not_2, "fac_small_kingdom_45"), # Has Heavy Spear Cavalry instead
            
            (troop_set_slot, "trp_nord_medium_spear_cavalry", slot_troop_faction_reserved_2, "fac_small_kingdom_44"), # 
            (troop_set_slot, "trp_nord_heavy_spear_cavalry", slot_troop_faction_reserved_2, "fac_small_kingdom_44"), # 
            (troop_set_slot, "trp_nord_infantry", slot_troop_faction_reserved_2, "fac_small_kingdom_43"),
            
            (troop_set_slot, "trp_rhodok_militia", slot_troop_faction_not_3, "fac_small_kingdom_51"), # Has Hunter instead
            (troop_set_slot, "trp_rhodok_militia", slot_troop_faction_not_1, "fac_small_kingdom_54"), # Has Levy Crossbowman instead
            (troop_set_slot, "trp_rhodok_militia", slot_troop_faction_not_2, "fac_small_kingdom_55"), # Has Levy Crossbowman instead
            (troop_set_slot, "trp_rhodok_light_crossbowman", slot_troop_faction_not_1, "fac_small_kingdom_51"), # 
            (troop_set_slot, "trp_rhodok_light_horse_archer", slot_troop_faction_not_1, "fac_small_kingdom_51"), # Has Mounted Archer instead
            (troop_set_slot, "trp_rhodok_medium_crossbowman", slot_troop_faction_not_1, "fac_small_kingdom_51"), # Has Bowman instead
            (troop_set_slot, "trp_rhodok_heavy_crossbowman", slot_troop_faction_not_1, "fac_small_kingdom_51"), # Has Heavy Bowman instead
            (troop_set_slot, "trp_rhodok_noble", slot_troop_faction_not_1, "fac_small_kingdom_51"), # Has Highlander instead
            (troop_set_slot, "trp_rhodok_medium_cavalry", slot_troop_faction_not_2, "fac_small_kingdom_52"), # 
            (troop_set_slot, "trp_rhodok_noble", slot_troop_faction_not_2, "fac_small_kingdom_52"), # Has Heroic Pikeman instead
            (troop_set_slot, "trp_rhodok_medium_cavalry", slot_troop_faction_not_1, "fac_small_kingdom_54"), # Has Mounted Crossbowman instead
            
            (troop_set_slot, "trp_rhodok_mounted_crossbow", slot_troop_faction_reserved_2, "fac_small_kingdom_55"), # 
            (troop_set_slot, "trp_rhodok_levy_crossbowman", slot_troop_faction_reserved_2, "fac_small_kingdom_55"), # 
            
            (troop_set_slot, "trp_sarranid_light_bowman", slot_troop_faction_not_1, "fac_small_kingdom_64"), # Has Light Crossbowman instead
            (troop_set_slot, "trp_sarranid_bowman", slot_troop_faction_not_1, "fac_small_kingdom_64"), # Has Crossbowman instead
            (troop_set_slot, "trp_sarranid_noble_horse_archer", slot_troop_faction_not_2, "fac_small_kingdom_62"), # Has Noble Spearman and Noble Infantry
            (troop_set_slot, "trp_sarranid_light_infantry", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Levy Infantry instead
            (troop_set_slot, "trp_sarranid_medium_infantry", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Footman instead
            (troop_set_slot, "trp_sarranid_light_skirmisher", slot_troop_faction_not_1, "fac_small_kingdom_63"), # 
            # (troop_set_slot, "trp_sarranid_guard", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Warrior instead
            (troop_set_slot, "trp_sarranid_heavy_skirmisher", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Skirmisher instead
            (troop_set_slot, "trp_sarranid_heavy_infantry", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Sergeant instead
            (troop_set_slot, "trp_sarranid_noble_horse_archer", slot_troop_faction_not_1, "fac_small_kingdom_63"), # Has Cataphract instead

            (troop_set_slot, "trp_sarranid_heavy_lancer", slot_troop_faction_reserved_2, "fac_small_kingdom_61"), # 

            (troop_set_slot, "trp_sarranid_levy_horse", slot_troop_ratio_special_multiplier, 50),
            (troop_set_slot, "trp_rhodok_militia", slot_troop_ratio_special_multiplier, 300),
            (troop_set_slot, "trp_khergit_clansman", slot_troop_ratio_special_multiplier, 20),
            (troop_set_slot, "trp_khergit_levy_horseman", slot_troop_ratio_special_multiplier, 25),
            (troop_set_slot, "trp_vaegir_militia", slot_troop_ratio_special_multiplier, 40),
            (troop_set_slot, "trp_vaegir_levy_infantry", slot_troop_ratio_special_multiplier, 80),
            (troop_set_slot, "trp_vaegir_levy_axeman", slot_troop_ratio_special_multiplier, 40),
        ]),
    
    # script_init_troops_types
    # input: none
    # output: none
    ("init_troops_types",
        [
            (try_for_range, ":cur_troop", soldiers_begin, soldiers_end),
                (assign, ":has_shield", 0),
                (assign, ":has_bow", 0),
                (assign, ":has_xbow", 0),
                # (assign, ":has_throw", 0),
                (assign, ":has_pole", 0), # Handles spear-like weapons
                (assign, ":has_pike", 0), # Handles pikes and lances
                (assign, ":has_sidearm", 0), # Every other melee weapon
                (troop_get_inventory_capacity, ":capacity", ":cur_troop"),
                (try_for_range, ":item_slot", ek_item_0, ":capacity"),
                    (troop_get_inventory_slot, ":cur_item", ":cur_troop", ":item_slot"),
                    (gt, ":cur_item", 0),
                    (item_get_type, ":item_type", ":cur_item"),
                    (try_begin),
                        (eq, ":item_type", itp_type_shield),
                        (assign, ":has_shield", 1),
                    (else_try),
                        (eq, ":item_type", itp_type_polearm),
                        (try_begin),
                            (is_between, ":cur_item", "itm_pitch_fork", "itm_ashwood_pike"),
                            (assign, ":has_pole", 1),
                        (else_try),
                            (is_between, ":cur_item", "itm_light_lance", "itm_hafted_blade_a"),
                            (assign, ":has_pike", 1),
                        (else_try),
                            (is_between, ":cur_item", "itm_ashwood_pike", "itm_glaive"),
                            (assign, ":has_pike", 1),
                        (else_try),
                            (eq, ":cur_item", "itm_bamboo_spear"),
                            (assign, ":has_pike", 1),
                            (assign, ":has_pole", 1),
                        (else_try),
                            (assign, ":has_sidearm", 1),
                        (try_end),
                    (else_try),
                        (eq, ":item_type", itp_type_bow),
                        (assign, ":has_bow", 1),
                    (else_try),
                        (eq, ":item_type", itp_type_crossbow),
                        (assign, ":has_xbow", 1),
                    # (else_try),
                        # (eq, ":item_type", itp_type_thrown),
                        # (assign, ":has_throw", 1),
                    (else_try),
                        (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
                        (eq, ":item_type", itp_type_two_handed_wpn),
                        (assign, ":has_sidearm", 1),
                    (try_end),
                (try_end),
                
                (try_begin),
                    (troop_is_guarantee_horse, ":cur_troop"),
                    (try_begin),
                        (eq, ":has_pike", 1),
                        (eq, ":has_sidearm", 0),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_lancer),
                    (else_try),
                        (troop_is_guarantee_ranged, ":cur_troop"),
                        (try_begin),
                            (this_or_next|eq, ":has_bow", 1),
                            (eq, ":has_xbow", 1),
                            (troop_set_slot, ":cur_troop", slot_troop_type, tt_horse_archer),
                        (else_try),
                            (troop_set_slot, ":cur_troop", slot_troop_type, tt_mounted_skirmisher),
                        (try_end),
                    (else_try),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_cavalry),
                    (try_end),
                (else_try),
                    (troop_is_guarantee_ranged, ":cur_troop"),
                    (try_begin),
                        (eq, ":has_xbow", 1),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_crossbow),
                    (else_try),
                        (eq, ":has_bow", 1),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_archer),
                    (else_try),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_skirmisher),
                    (try_end),
                (else_try),
                    (eq, ":has_sidearm", 0),
                    (try_begin),
                        (eq, ":has_shield", 1),
                        (eq, ":has_pole", 1),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_spearman),
                    (else_try),
                        (eq, ":has_pike", 1),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_pikeman),
                    (else_try),
                        (troop_set_slot, ":cur_troop", slot_troop_type, tt_shock_infantry),
                    (try_end),
                (else_try),
                    (eq, ":has_shield", 1),
                    (troop_set_slot, ":cur_troop", slot_troop_type, tt_infantry),
                (else_try),
                    (troop_set_slot, ":cur_troop", slot_troop_type, tt_shock_infantry),
                (try_end),
                
                (store_troop_faction, ":faction", ":cur_troop"),
                (faction_get_slot, ":culture", ":faction", slot_faction_culture),
                (faction_get_slot, ":peasant", ":culture", slot_faction_peasant_begin),
                (faction_get_slot, ":common", ":culture", slot_faction_common_begin),
                (faction_get_slot, ":veteran", ":culture", slot_faction_veteran_begin),
                (faction_get_slot, ":elite", ":culture", slot_faction_elite_begin),
                (faction_get_slot, ":noble", ":culture", slot_faction_noble_begin),
                (faction_get_slot, ":end", ":culture", slot_faction_troops_end),
                (try_begin),
                    (is_between, ":cur_troop", ":peasant", ":common"),
                    (troop_set_slot, ":cur_troop", slot_troop_quality, tq_peasant),
                (else_try),
                    (is_between, ":cur_troop", ":common", ":veteran"),
                    (troop_set_slot, ":cur_troop", slot_troop_quality, tq_common),
                (else_try),
                    (is_between, ":cur_troop", ":veteran", ":elite"),
                    (troop_set_slot, ":cur_troop", slot_troop_quality, tq_veteran),
                (else_try),
                    (is_between, ":cur_troop", ":elite", ":noble"),
                    (troop_set_slot, ":cur_troop", slot_troop_quality, tq_elite),
                (else_try),
                    (is_between, ":cur_troop", ":noble", ":end"),
                    (troop_set_slot, ":cur_troop", slot_troop_quality, tq_noble),
                (try_end),
                
                (assign, ":armor", -1),
                (assign, ":horse", -1),
                (assign, ":weapon", -1),
                (troop_get_inventory_capacity, ":capacity", ":cur_troop"),
                (try_for_range, ":item_slot", ek_item_0, ":capacity"),
                    (troop_get_inventory_slot, ":cur_item", ":cur_troop", ":item_slot"),
                    (gt, ":cur_item", 0),
                    (item_get_type, ":item_type", ":cur_item"),
                    (try_begin),
                        (eq, ":item_type", itp_type_horse),
                        (try_begin),
                            (is_between, ":cur_item", light_horses_begin, light_horses_end),
                            (try_begin),
                                (neq, ":horse", -1),
                                (val_min, ":horse", weight_light),
                            (else_try),
                                (val_max, ":horse", weight_light),
                            (try_end),
                        (else_try),
                            (is_between, ":cur_item", medium_horses_begin, medium_horses_end),
                            (try_begin),
                                (neq, ":horse", -1),
                                (val_min, ":horse", weight_medium),
                            (else_try),
                                (val_max, ":horse", weight_medium),
                            (try_end),
                        (else_try),
                            (is_between, ":cur_item", heavy_horses_begin, heavy_horses_end),
                            (try_begin),
                                (neq, ":horse", -1),
                                (val_min, ":horse", weight_heavy),
                            (else_try),
                                (val_max, ":horse", weight_heavy),
                            (try_end),
                        (else_try),
                            # (is_between, ":cur_item", armoured_horses_begin, armoured_horses_end),
                            (try_begin),
                                (neq, ":horse", -1),
                                (val_min, ":horse", weight_very_heavy),
                            (else_try),
                                (val_max, ":horse", weight_very_heavy),
                            (try_end),
                        (try_end),
                    (else_try),
                        (eq, ":item_type", itp_type_bow),
                        (try_begin),
                            (is_between, ":cur_item", "itm_hunting_bow", "itm_nomad_bow"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_light),
                            (else_try),
                                (val_max, ":weapon", weight_light),
                            (try_end),
                        (else_try),
                            (is_between, ":cur_item", "itm_nomad_bow", "itm_long_bow"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_medium),
                            (else_try),
                                (val_max, ":weapon", weight_medium),
                            (try_end),
                        (else_try),
                            # (is_between, ":cur_item", "itm_long_bow", "itm_hunting_crossbow"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_heavy),
                            (else_try),
                                (val_max, ":weapon", weight_heavy),
                            (try_end),
                        (try_end),
                    (else_try),
                        (eq, ":item_type", itp_type_crossbow),
                        (try_begin),
                            (is_between, ":cur_item", "itm_hunting_crossbow", "itm_crossbow"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_light),
                            (else_try),
                                (val_max, ":weapon", weight_light),
                            (try_end),
                        (else_try),
                            (is_between, ":cur_item", "itm_crossbow", "itm_heavy_crossbow"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_medium),
                            (else_try),
                                (val_max, ":weapon", weight_medium),
                            (try_end),
                        (else_try),
                            # (is_between, ":cur_item", "itm_heavy_crossbow", ranged_weapons_end),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_heavy),
                            (else_try),
                                (val_max, ":weapon", weight_heavy),
                            (try_end),
                        (try_end),
                    (else_try),
                        (eq, ":item_type", itp_type_thrown),
                        (try_begin),
                            (is_between, ":cur_item", ranged_weapons_begin, "itm_darts"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_very_light),
                            (else_try),
                                (val_max, ":weapon", weight_very_light),
                            (try_end),
                        (else_try),
                            (is_between, ":cur_item", "itm_darts", "itm_javelin"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_light),
                            (else_try),
                                (val_max, ":weapon", weight_light),
                            (try_end),
                            (val_max, ":weapon", weight_light),
                        (else_try),
                            (this_or_next|is_between, ":cur_item", "itm_javelin", "itm_jarid"),
                            (eq, ":cur_item", "itm_light_throwing_axes"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_medium),
                            (else_try),
                                (val_max, ":weapon", weight_medium),
                            (try_end),
                        (else_try),
                            # (this_or_next|is_between, ":cur_item", "itm_throwing_axes", "itm_hunting_bow"),
                            # (eq, ":cur_item", "itm_jarid"),
                            (try_begin),
                                (neq, ":weapon", -1),
                                (val_min, ":weapon", weight_heavy),
                            (else_try),
                                (val_max, ":weapon", weight_heavy),
                            (try_end),
                        (try_end),
                    (else_try),
                        (eq, ":item_type", itp_type_body_armor),
                        (try_begin),
                            (is_between, ":cur_item", very_light_armors_begin, light_armors_begin),
                            (val_max, ":armor", weight_very_light),
                        (else_try),
                            (is_between, ":cur_item", light_armors_begin, medium_armors_begin),
                            (val_max, ":armor", weight_light),
                        (else_try),
                            (is_between, ":cur_item", medium_armors_begin, heavy_armors_begin),
                            (val_max, ":armor", weight_medium),
                        (else_try),
                            # (is_between, ":cur_item", heavy_armors_end, armors_end),
                            (val_max, ":armor", weight_heavy),
                        (try_end),
                    (try_end),
                (try_end),
                
                (troop_set_slot, ":cur_troop", slot_troop_armor_weight, ":armor"),
                (troop_set_slot, ":cur_troop", slot_troop_horse_weight, ":horse"),
                (troop_set_slot, ":cur_troop", slot_troop_ranged_weapon_weight, ":weapon"),
            (try_end),
            
            # Secial treatments
            (troop_set_slot, "trp_swadian_militia", slot_troop_type, tt_crossbow),
            (troop_set_slot, "trp_swadian_sergeant", slot_troop_type, tt_shock_infantry), # Because swadians have too many of them
            (troop_set_slot, "trp_khergit_militia", slot_troop_type, tt_archer),
        ]),
    
    # script_init_troops_archer_score
    # input: none
    # output: none
    ("init_troops_archer_score",
        [
            (try_for_range, ":troop_no", soldiers_begin, soldiers_end),
                
                (call_script, "script_troop_get_archer_score", ":troop_no"),
                (assign, ":score", reg0),
                
                (troop_set_slot, ":troop_no", slot_troop_archer_score, ":score"),
            (try_end),
        ]),

    # script_troop_get_archer_score
    # input:
    #   arg1: troop_no
    # output:
    #   reg0: score
    ("troop_get_archer_score",
        [
            (store_script_param, ":troop_no", 1),

            (assign, ":score", 0),
            (store_skill_level, ":power_draw", skl_power_draw, ":troop_no"),
            (store_skill_level, ":power_strike", skl_power_strike, ":troop_no"),
            (store_skill_level, ":power_throw", skl_power_throw, ":troop_no"),
            (store_skill_level, ":ironflesh", skl_ironflesh, ":troop_no"),
            (store_proficiency_level, ":1h", ":troop_no", wpt_one_handed_weapon),
            (store_proficiency_level, ":2h", ":troop_no", wpt_two_handed_weapon),
            (store_proficiency_level, ":pole", ":troop_no", wpt_polearm),
            (store_proficiency_level, ":bow", ":troop_no", wpt_archery),
            (store_proficiency_level, ":xbow", ":troop_no", wpt_crossbow),
            (store_proficiency_level, ":throw", ":troop_no", wpt_throwing),
            (store_attribute_level, ":str", ":troop_no", ca_strength),
            
            (val_mul, ":power_draw", 25),
            (val_mul, ":power_strike", 10),
            (val_mul, ":power_throw", 15),
            (val_mul, ":ironflesh", 5),
            
            # (val_mul, ":bow", 1),
            (val_mul, ":xbow", 2),
            # (val_mul, ":throw", 1),
            
            (val_div, ":1h", 2),
            (val_div, ":2h", 2),
            (val_div, ":pole", 2),
            (val_max, ":1h", ":2h"),
            (val_max, ":1h", ":pole"),
            
            (val_add, ":bow", ":power_draw"),
            (val_add, ":throw", ":power_throw"),
            # (val_add, ":xbow", ":power_draw"),
            
            (val_max, ":bow", ":xbow"),
            (val_max, ":bow", ":throw"),
            
            (val_add, ":score", ":bow"),
            (val_sub, ":score", ":1h"),
            (val_sub, ":score", ":ironflesh"),
            (val_sub, ":score", ":power_strike"),
            (val_sub, ":score", ":str"),
            
            (val_max, ":score", 0),

            (assign, reg0, ":score"),
        ]),

    # script_init_troops_mercenary
    # input: none
    # output: none
    ("init_troops_mercenary",
        [
            (troop_set_slot, "trp_swadian_light_cavalry", slot_troop_mercenary_captain_1, "trp_swadian_heavy_cavalry"),
            (troop_set_slot, "trp_swadian_light_bowman", slot_troop_mercenary_captain_1, "trp_swadian_bowman"),
            (troop_set_slot, "trp_swadian_light_crossbowman", slot_troop_mercenary_captain_1, "trp_swadian_crossbowman"),
            (troop_set_slot, "trp_swadian_heavy_infantry", slot_troop_mercenary_captain_1, "trp_swadian_sergeant"),
            (troop_set_slot, "trp_swadian_heavy_cavalry", slot_troop_mercenary_captain_1, "trp_swadian_noble"),
            (troop_set_slot, "trp_swadian_sergeant", slot_troop_mercenary_captain_1, "trp_swadian_foot_knight"),
            (troop_set_slot, "trp_swadian_light_lancer", slot_troop_mercenary_captain_1, "trp_swadian_heavy_lancer"),
            (troop_set_slot, "trp_swadian_heavy_lancer", slot_troop_mercenary_captain_1, "trp_swadian_noble"),
            (troop_set_slot, "trp_swadian_light_longbowman", slot_troop_mercenary_captain_1, "trp_swadian_longbowman"),

            (troop_set_slot, "trp_vaegir_light_cavalry", slot_troop_mercenary_captain_1, "trp_vaegir_heavy_cavalry"),
            (troop_set_slot, "trp_vaegir_light_infantry", slot_troop_mercenary_captain_1, "trp_vaegir_heavy_infantry"),
            (troop_set_slot, "trp_vaegir_light_bowman", slot_troop_mercenary_captain_1, "trp_vaegir_medium_bowman"),
            (troop_set_slot, "trp_vaegir_heavy_cavalry", slot_troop_mercenary_captain_1, "trp_vaegir_royal_hussar"),
            (troop_set_slot, "trp_vaegir_light_lancer", slot_troop_mercenary_captain_1, "trp_vaegir_heavy_lancer"),
            (troop_set_slot, "trp_vaegir_medium_bowman", slot_troop_mercenary_captain_1, "trp_vaegir_heavy_longbowman"),
            
            (troop_set_slot, "trp_khergit_light_lancer", slot_troop_mercenary_captain_1, "trp_khergit_lancer"),
            (troop_set_slot, "trp_khergit_light_cavalry", slot_troop_mercenary_captain_1, "trp_khergit_heavy_cavalry"),
            (troop_set_slot, "trp_khergit_heavy_horse_archer", slot_troop_mercenary_captain_1, "trp_khergit_noble"),

            (troop_set_slot, "trp_nord_light_infantry", slot_troop_mercenary_captain_1, "trp_nord_medium_infantry"),
            (troop_set_slot, "trp_nord_medium_infantry", slot_troop_mercenary_captain_1, "trp_nord_noble_infantry"),
            (troop_set_slot, "trp_nord_medium_longbowman", slot_troop_mercenary_captain_1, "trp_nord_heavy_bowman"),

            (troop_set_slot, "trp_rhodok_light_infantry", slot_troop_mercenary_captain_1, "trp_rhodok_heavy_infantry"),
            (troop_set_slot, "trp_rhodok_medium_crossbowman", slot_troop_mercenary_captain_1, "trp_rhodok_heavy_crossbowman"),
            (troop_set_slot, "trp_rhodok_heavy_infantry", slot_troop_mercenary_captain_1, "trp_rhodok_noble"),

            (troop_set_slot, "trp_sarranid_light_skirmisher", slot_troop_mercenary_captain_1, "trp_sarranid_heavy_skirmisher"),
            (troop_set_slot, "trp_sarranid_medium_infantry", slot_troop_mercenary_captain_1, "trp_sarranid_guard"),
            (troop_set_slot, "trp_sarranid_guard", slot_troop_mercenary_captain_1, "trp_sarranid_heavy_infantry"),
            (troop_set_slot, "trp_sarranid_medium_cavalry", slot_troop_mercenary_captain_1, "trp_sarranid_heavy_cavalry"),
            (troop_set_slot, "trp_sarranid_heavy_cavalry", slot_troop_mercenary_captain_1, "trp_sarranid_noble_horse_archer"),
        ]),
    

    
    # script_faction_get_best_candidate_for_center
        # input:
        #   arg1: faction_no
        #   arg2: center_no
        #   arg3: troop_giver
        # output:
        #   reg0: best_candidate
    ("faction_get_best_candidate_for_center",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":center_no", 2),
            (store_script_param, ":giver", 3),
            
            (assign, ":best_candidate", -1),
            (assign, ":best_score", -1),

            (party_get_slot, ":party_type", ":center_no", slot_party_type),

            (try_begin),
                (lt, ":giver", 0),
                
                (try_begin),
                    (eq, ":party_type", spt_village),
                    (party_get_slot, ":linked_center", ":center_no", slot_party_linked_party),
                    (party_get_slot, ":candidate", ":linked_center", slot_party_lord), # We take the lord of the linked center as choosen one
                    (ge, ":candidate", 0),
                    (store_troop_faction, ":troop_faction", ":candidate"),
                    (eq, ":troop_faction", ":faction_no"),
                    (assign, ":best_candidate", ":candidate"),
                (else_try),
                    (call_script, "script_troop_get_center_candidate_score", "$g_player_troop", ":center_no", ":faction_no"),
                    (assign, ":score", reg0),
                    (try_begin),
                        (gt, ":score", ":best_score"),
                        (call_script, "script_get_current_day"),
                        (assign, ":current_day", reg0),

                        # If the player previously refused an offer we don't ask for a while
                        (store_add, ":threshold", "$g_player_last_proposed_vassalage", 365*2),
                        (gt, ":current_day", ":threshold"),

                        (assign, ":best_score", ":score"),
                        (assign, ":best_candidate", "$g_player_troop"),
                    (try_end),
                    (try_for_range, ":troop_no", lords_begin, lords_end),
                        (call_script, "script_troop_get_center_candidate_score", ":troop_no", ":center_no", ":faction_no"),

                        (assign, ":score", reg0),
                        (gt, ":score", ":best_score"),
                        (assign, ":best_candidate", ":troop_no"),
                        (assign, ":best_score", ":score"),
                    (try_end),
                (try_end),
                
                (try_begin),
                    (ge, ":best_candidate", 0),
                    (call_script, "script_cf_debug", debug_faction|debug_simple),
                    (str_store_troop_name, s10, ":best_candidate"),
                    (str_store_party_name, s11, ":center_no"),
                    (display_message, "@{s10} is the best candidate for {s11}", text_color_freed),
                (else_try),
                    (eq, ":best_candidate", -1),
                    (call_script, "script_cf_debug", debug_faction|debug_simple),
                    (str_store_party_name, s11, ":center_no"),
                    (display_message, "@Unable to find best candidate for {s11}", text_color_impossible),
                (try_end),
            (else_try),
                (call_script, "script_troop_get_center_keeper_score", "$g_player_troop", ":center_no", ":giver", ":faction_no"),
                (assign, ":score", reg0),
                (try_begin),
                    (gt, ":score", ":best_score"),
                    
                    (call_script, "script_get_current_day"),
                    (assign, ":current_day", reg0),

                    # If the player previously refused an offer we don't ask for a while
                    (store_add, ":threshold", "$g_player_last_proposed_vassalage", 365*2),
                    (gt, ":current_day", ":threshold"),

                    (assign, ":best_score", ":score"),
                    (assign, ":best_candidate", "$g_player_troop"),
                (try_end),

                # (try_begin),
                #     (call_script, "script_cf_debug", debug_simple),
                #     (str_store_troop_name, s10, ":giver"),
                #     (str_store_party_name, s11, ":center_no"),
                #     (assign, reg10, ":score"),
                #     (display_message, "@{s10} gives score {reg10} for {s11} to player", text_color_freed),
                # (try_end),

                (try_for_range, ":lord_no", lords_begin, lords_end),
                    (call_script, "script_troop_get_center_keeper_score", ":lord_no", ":center_no", ":giver", ":faction_no"),
                    (assign, ":score", reg0),
                    (gt, ":score", ":best_score"),
                    (assign, ":best_score", ":score"),
                    (assign, ":best_candidate", ":lord_no"),
                (try_end),
            (try_end),
            
            (assign, reg0, ":best_candidate"),
        ]),

    # script_troop_get_center_candidate_score
        # input:
        #   arg1: troop_no
        #   arg2: center_candidate
        #   arg3: faction_owner
        # output:
        #   reg0: score
    ("troop_get_center_candidate_score",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":center_candidate", 2),
            (store_script_param, ":faction_owner", 3),

            (party_get_slot, ":party_type", ":center_candidate", slot_party_type),

            (assign, ":score", -1),
            (try_begin),
                (troop_slot_eq, ":troop_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (eq, ":troop_faction", ":faction_owner"),
                
                (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),

                (faction_get_slot, ":faction_leader", ":faction_owner", slot_faction_leader),
                
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (try_begin),
                        (eq, ":faction_leader", ":troop_no"),
                        (assign, ":score", 100),
                    (else_try),
                        (eq, ":rank", rank_castle),
                        (assign, ":score", 50),
                    (else_try),
                        (ge, ":rank", rank_city),
                        (assign, ":score", 25),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (try_begin),
                        (ge, ":rank", rank_city),
                        (troop_get_slot, ":home", ":troop_no", slot_troop_home),
                        (is_between, ":home", centers_begin, centers_end),
                        (store_distance_to_party_from_party, ":distance", ":center_candidate", ":home"),
                        (try_begin),
                            (eq, ":faction_leader", ":troop_no"),
                            (val_mul, ":distance", 4),
                            (val_div, ":distance", 5),
                        (try_end),
                        (store_sub, ":score", 500, ":distance"),
                        (val_max, ":score", 1),
                    (else_try),
                        (eq, ":faction_leader", ":troop_no"),
                        (assign, ":score", 100),
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (party_get_slot, ":linked_center", ":center_candidate", slot_party_linked_party),
                    (party_get_slot, ":candidate", ":linked_center", slot_party_lord), # We take the lord of the linked center as choosen one
                    (store_troop_faction, ":troop_faction", ":candidate"),
                    (ge, ":candidate", 0),
                    (eq, ":troop_faction", ":faction_owner"),
                    (assign, ":score", 500),
                (try_end),
            (try_end),

            (try_begin),
                (eq, ":troop_no", "$g_player_troop"),
                (check_quest_active, "qst_swear_vassalage_fief"),
                (assign, ":score", -1),
            (try_end),

            (assign, reg0, ":score"),
        ]),

    # script_troop_get_center_keeper_score
        # input:
        #   arg1: troop_no
        #   arg2: center_candidate
        #   arg3: troop_giver
        #   arg4: faction_owner
        # output:
        #   reg0: score
    ("troop_get_center_keeper_score",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":center_candidate", 2),
            (store_script_param, ":troop_giver", 3),
            (store_script_param, ":faction_owner", 4),

            (party_get_slot, ":party_type", ":center_candidate", slot_party_type),

            (assign, ":score", -1),
            (try_begin),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (eq, ":troop_faction", ":faction_owner"),
                (troop_slot_eq, ":troop_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
                (assign, ":score", 0),
                (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),

                (call_script, "script_troop_get_relation_with_troop", ":troop_giver", ":troop_no"),
                (assign, ":relation", reg0),
                # (ge, ":relation", 0),
                (try_begin),
                    (le, ":rank", rank_affiliated),
                    (val_mul, ":relation", 1),
                (else_try),
                    (le, ":rank", rank_two_village),
                    (val_mul, ":relation", 4),
                (else_try),
                    (le, ":rank", rank_castle),
                    (val_mul, ":relation", 10),
                (else_try),
                    # (le, ":rank", rank_city),
                    (val_mul, ":relation", 20),
                (try_end),
                (val_add, ":score", ":relation"),

                (troop_get_slot, ":renown", ":troop_no", slot_troop_renown),
                (val_add, ":score", ":renown"),

                (try_begin),
                    (troop_slot_eq, ":troop_no", slot_troop_vassal_of, ":troop_giver"),
                    (val_add, ":score", 100),

                    (troop_get_slot, ":num_vassals", ":troop_no", slot_troop_num_vassal),
                    (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),

                    (assign, ":rank_penalty", 0),
                    (try_for_range, ":center_no", centers_begin, centers_end),
                        (party_slot_eq, ":center_no", slot_party_lord, ":troop_no"),
                        (party_get_slot, ":party_type", ":center_no", slot_party_type),
                        (try_begin),
                            (eq, ":party_type", spt_village),
                            (val_add, ":rank_penalty", 350),
                        (else_try),
                            (eq, ":party_type", spt_castle),
                            (val_add, ":rank_penalty", 1000),
                        (else_try),
                            (ge, ":party_type", spt_town),
                            (val_add, ":rank_penalty", 2000),
                        (try_end),
                    (try_end),
                    (store_mul, ":vassals_penalty", ":num_vassals", 250),

                    (val_sub, ":score", ":rank_penalty"),
                    (val_sub, ":score", ":vassals_penalty"),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (troop_slot_eq, ":troop_no", slot_troop_vassal_of, -1),
                    (eq, ":rank", rank_none),
                (else_try),
                    (assign, ":score", -1),
                (try_end),
            (try_end),

            (try_begin),
                (eq, ":troop_no", "$g_player_troop"),
                (check_quest_active, "qst_swear_vassalage_fief"),
                (assign, ":score", -1),
            (try_end),


                # (assign, ":end", lords_end),
                # (try_for_range, ":other_lord", lords_begin, ":end"),
                #     (store_troop_faction, ":other_faction", ":other_lord"),
                #     (eq, ":other_faction", ":faction_no"),
                #     (try_begin),
                #         (troop_slot_eq, ":other_lord", slot_troop_vassal_of, ":giver"),
                #         (troop_get_slot, ":rank", ":other_lord", slot_troop_rank),
                #         (try_begin),
                #             (lt, ":rank", rank_castle),
                #             (this_or_next|gt, ":party_type", spt_village),
                #             (lt, ":rank", rank_village),
                #             (assign, ":best_candidate", ":other_lord"),
                #         (else_try),
                #             (lt, ":rank", rank_village),
                #             (assign, ":best_candidate", ":other_lord"),
                #             (assign, ":end", 0),
                #         (try_end),
                #     (else_try),
                #         (troop_slot_eq, ":other_lord", slot_troop_vassal_of, -1),
                #         (troop_get_slot, ":rank", ":other_lord", slot_troop_rank),
                #         (lt, ":rank", rank_castle),
                #         (this_or_next|gt, ":party_type", spt_village),
                #         (neq, ":rank", rank_two_village),
                #         (eq, ":best_candidate", -1),
                #         (assign, ":best_candidate", ":other_lord"),
                #     (try_end),
                # (try_end),

            (assign, reg0, ":score"),
        ]),
    
    # script_party_count_fit_for_battle
        # Returns the number of unwounded companions in a party
        # input:
        #   arg1: party_id
        # output: 
        #   reg0: result
    ("party_count_fit_for_battle",
        [
            (store_script_param_1, ":party"),
            (party_get_num_companion_stacks, ":num_stacks",":party"),
            (assign, reg0, 0),
            (try_for_range, ":i_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":stack_troop",":party",":i_stack"),
                (assign, ":num_fit",0),
                (try_begin),
                    (troop_is_hero, ":stack_troop"),
                    (try_begin),
                        (neg|troop_is_wounded, ":stack_troop"),
                        (assign, ":num_fit", 1),
                    (try_end),
                (else_try),
                    (party_stack_get_size, ":num_fit", ":party", ":i_stack"),
                    (party_stack_get_num_wounded, ":num_wounded", ":party", ":i_stack"),
                    (val_sub, ":num_fit", ":num_wounded"),
                (try_end),
                (val_add, reg0, ":num_fit"),
            (try_end),
        ]),

    # script_troop_clear_inventory
    # input:
    #   arg1: troop_no
    # output: none
    ("troop_clear_inventory",
        [
            (store_script_param, ":troop_no", 1),

            # Removing old equipment
            (try_for_range, ":equip_slot", ek_item_0, ek_food),
                (troop_get_inventory_slot, ":item", ":troop_no", ":equip_slot"),
                (gt, ":item", 0),
                (troop_remove_item, ":troop_no", ":item"),
            (try_end),
            (troop_clear_inventory, ":troop_no"),
        ]),
    
    # script_troop_use_template_troop
    # input:
    #   arg1: troop_no
    #   arg2: template_troop
    # output: none
    ("troop_use_template_troop",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":template", 2),
            
            (set_show_messages, 0),
            
            (call_script, "script_troop_change_stat_with_template", ":troop_no", ":template"),
            
            (call_script, "script_troop_clear_inventory", ":troop_no"),        
            
            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_head_armor),
            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_foot_armor),
            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_body_armor),
            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_hand_armor),
            
            (assign, ":num_item_added", 0),
            
            (try_begin),
                (troop_get_inventory_capacity, ":num_slots", ":template"),
                (assign, ":num_item", 0),
                (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                    (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                    (gt, ":cur_item", 0),
                    (item_get_type, ":item_type", ":cur_item"),
                    (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
                    (eq, ":item_type", itp_type_two_handed_wpn),
                    (val_add, ":num_item", 1),
                (try_end),
                (try_begin),
                    (gt, ":num_item", 0),
                    (store_random_in_range, ":random_item", 0, ":num_item"),
                    (try_for_range, ":i_slot", ek_item_0, ":num_slots"),
                        (troop_get_inventory_slot, ":cur_item", ":template", ":i_slot"),
                        (gt, ":cur_item", 0),
                        (item_get_type, ":item_type", ":cur_item"),
                        (this_or_next|eq, ":item_type", itp_type_one_handed_wpn),
                        (eq, ":item_type", itp_type_two_handed_wpn),
                        (try_begin),
                            (eq, ":random_item", 0),
                            (troop_add_item, ":troop_no", ":cur_item"),
                            (val_add, ":num_item_added", 1),
                            (assign, ":num_slots", 0),
                        (else_try),
                            (val_add, ":random_item", -1),
                        (try_end),
                    (try_end),
                (try_end),
                (store_random_in_range, ":random", 0, 2),
                (try_begin),
                    (this_or_next|eq, ":num_item", 0),
                    (eq, ":random", 0),
                    (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_polearm),
                    (gt, reg0, 0),
                    (val_add, ":num_item_added", 1),
                (try_end),
            (try_end),
            (store_random_in_range, ":random", 0, 2),
            (try_begin),
                (this_or_next|troop_is_guarantee_ranged, ":template"),
                (eq, ":random", 0),
                (call_script, "script_troop_take_random_troop_equipement_of_type", "trp_temp_troop", ":template", itp_type_bow),
                (assign, ":has_bow", reg0),
                (call_script, "script_troop_take_random_troop_equipement_of_type", "trp_temp_troop", ":template", itp_type_crossbow),
                (assign, ":has_xbow", reg0),
                (call_script, "script_troop_take_random_troop_equipement_of_type", "trp_temp_troop", ":template", itp_type_thrown),
                (assign, ":has_throw", reg0),
                (try_begin),
                    (gt, ":has_bow", 0),
                    (le, ":has_xbow", 0),
                    (le, ":has_throw", 0),
                    (troop_add_item, ":troop_no", ":has_bow"),
                    (val_add, ":num_item_added", 1),
                    (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_arrows),
                    (val_add, ":num_item_added", 1),
                (else_try),
                    (le, ":has_bow", 0),
                    (gt, ":has_xbow", 0),
                    (le, ":has_throw", 0),
                    (troop_add_item, ":troop_no", ":has_xbow"),
                    (val_add, ":num_item_added", 1),
                    (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_bolts),
                    (val_add, ":num_item_added", 1),
                (else_try),
                    (le, ":has_bow", 0),
                    (le, ":has_xbow", 0),
                    (gt, ":has_throw", 0),
                    (troop_add_item, ":troop_no", ":has_throw"),
                    (val_add, ":num_item_added", 1),
                (else_try),
                    (store_random_in_range, ":random_type", 0, 2),
                    (try_begin),
                        (eq, ":random_type", 0),
                        (try_begin),
                            (gt, ":has_bow", 0),
                            (troop_add_item, ":troop_no", ":has_bow"),
                            (val_add, ":num_item_added", 1),
                            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_arrows),
                            (val_add, ":num_item_added", 1),
                        (else_try),
                            (gt, ":has_xbow", 0),
                            (troop_add_item, ":troop_no", ":has_xbow"),
                            (val_add, ":num_item_added", 1),
                            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_bolts),
                            (val_add, ":num_item_added", 1),
                        (try_end),
                    (else_try),
                        (try_begin),
                            (gt, ":has_xbow", 0),
                            (troop_add_item, ":troop_no", ":has_xbow"),
                            (val_add, ":num_item_added", 1),
                            (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_bolts),
                            (val_add, ":num_item_added", 1),
                        (else_try),
                            (gt, ":has_throw", 0),
                            (troop_add_item, ":troop_no", ":has_throw"),
                            (val_add, ":num_item_added", 1),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),
            
            (try_begin),
                (lt, ":num_item_added", 4),
                (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_shield),
            (try_end),
            
            (store_random_in_range, ":random", 0, 2),
            (try_begin),
                (this_or_next|troop_is_guarantee_horse, ":template"),
                (eq, ":random", 0),
                
                (call_script, "script_troop_take_random_troop_equipement_of_type", ":troop_no", ":template", itp_type_horse),
            (try_end),
            
            (troop_equip_items, ":troop_no"),
            
            (set_show_messages, 1),
        ]),
    
    # script_calculate_hire_troop_cost
    # input:
    #   arg1: center_to_recruit
    #   arg2: troop_recruiter
    # output:
    #   reg0: total cost
    #   reg1: num troops
    ("calculate_hire_troop_cost",
        [
            (store_script_param, ":current_city", 1),
            (store_script_param, ":recruiter", 2),
            
            (assign, ":total_cost", 0),
            (assign, ":total_num_troops", 0),
            (party_get_num_companion_stacks, ":num_stacks", ":current_city"),
            (try_for_range, ":stack_no", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_no", ":current_city", ":stack_no"),
                # (party_stack_get_size, ":stack_size", ":current_city", ":stack_no"),
                
                (store_mul, ":numbox_offset", ":stack_no", 2),
                (val_add, ":numbox_offset", 1),
                
                # (store_add, ":numbox_object", ":numbox_offset", "$g_hire_soldiers_center_troops_begin"),
                (troop_get_slot, ":num_troops", ":troop_no", slot_troop_temp_hire_number),
                
                (call_script, "script_troop_get_cost", ":troop_no"),
                (assign, ":troop_cost", reg0),
                (val_mul, ":troop_cost", ":num_troops"),
                
                (val_add, ":total_num_troops", ":num_troops"),
                
                (call_script, "script_troop_get_cost_modifier", ":troop_no", ":current_city", ":recruiter"),
                (assign, ":cost_modifier", reg0),
                (val_mul, ":troop_cost", ":cost_modifier"),
                (val_div, ":troop_cost", 100),
                
                (val_add, ":total_cost", ":troop_cost"),
            (try_end),
            (assign, reg0, ":total_cost"),
            (assign, reg1, ":total_num_troops"),
        ]),
    
    # script_troop_get_cost
    # input: 
    #   arg1: troop_id
    # output:
    #   reg0: troop cost
    ("troop_get_cost",
        [
            (store_script_param_1, ":troop_id"),
            
            (store_character_level, ":level", ":troop_id"),
            
            (store_add, ":join_cost", ":level", 8),
            (val_mul, ":join_cost", ":join_cost"),
            (val_div, ":join_cost", 5),
            
            (try_begin),
                (troop_is_mounted, ":troop_id"), # 50% increase for mounted troops
                (val_mul, ":join_cost", 3),
                (val_div, ":join_cost", 2),
            (try_end),

            (val_mul, ":join_cost", 10),
            
            (assign, reg0, ":join_cost"), 
        ]),
    
    # script_troop_get_cost_modifier
    # input:
    #   arg1: troop_no
    #   arg2: current_party
    #   arg3: recruiter
    # output:
    #   reg0: cost_modifier
    ("troop_get_cost_modifier",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":current_party", 2),
            (store_script_param, ":recruiter", 3),
            
            (assign, ":modifier", 100),

            (party_get_slot, ":center_owner", ":current_party", slot_party_lord),
            (store_troop_faction, ":recruiter_faction", ":recruiter"),
            (store_faction_of_party, ":party_faction", ":current_party"),

            (try_begin),
                (eq, ":recruiter", ":center_owner"),
                (eq, ":recruiter_faction", ":party_faction"),
                (assign, ":modifier", 0),
            (else_try),
            
                (party_get_slot, ":party_type", ":current_party", slot_party_type),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (faction_get_slot, ":culture", ":troop_faction", slot_faction_culture),
                (faction_get_slot, ":peasant_begin", ":culture", slot_faction_troops_begin),
                (faction_get_slot, ":common_begin", ":culture", slot_faction_common_begin),
                (faction_get_slot, ":veteran_begin", ":culture", slot_faction_veteran_begin),
                (faction_get_slot, ":elite_begin", ":culture", slot_faction_elite_begin),
                # (faction_get_slot, ":noble_begin", ":culture", slot_faction_noble_begin),
                (faction_get_slot, ":troops_end", ":culture", slot_faction_troops_end),
                
                
                (try_begin),
                    (eq, ":party_type", spt_village),
                    # (assign, ":relation_divider", 4),
                    (try_begin),
                        (is_between, ":troop_no", ":peasant_begin", ":common_begin"),
                        (val_add, ":modifier", -10), # 10% reduction on peasant troops in villages
                    (else_try),
                        (is_between, ":troop_no", ":common_begin", ":veteran_begin"),
                        (val_add, ":modifier", -5), # 5% reduction on common troops in villages
                    (else_try),
                        (is_between, ":troop_no", ":elite_begin", ":troops_end"),
                        (val_add, ":modifier", 10), # 10% increase on elite/noble troops in villages
                    (try_end),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    # (assign, ":relation_divider", 10),
                    (try_begin),
                        (is_between, ":troop_no", ":peasant_begin", ":common_begin"),
                        (val_add, ":modifier", 5), # 5% increase on peasant troops in castles
                    (else_try),
                        (is_between, ":troop_no", ":veteran_begin", ":troops_end"),
                        (val_add, ":modifier", -5), # 5% reduction on veteran, elite and noble troops in castles
                    (try_end),
                (try_end),
                
                # (assign, ":relation_divider", 8),
                    
                (try_begin),
                    (neq, ":party_faction", ":recruiter_faction"),
                    (val_add, ":modifier", 15),
                (try_end),
                
                # ToDo:
                # (try_begin),
                    # (ge, ":center_owner", 0),
                    # (call_script, "script_troop_get_relation_with_troop", ":recruiter", ":center_owner"),
                    # (assign, ":relation", reg0),
                    # (try_begin), # Player has relation with owner and center
                        # (eq, ":recruiter", "$g_player_troop"),
                        # (val_add, ":relation", 1),
                        # (val_div, ":relation", 2),
                        # (troop_get_slot, ":city_relation", ":current_party", slot_party_relation_with_player),
                        # (val_div, ":city_relation", 2),
                        # (val_add, ":relation", ":city_relation"),
                    # (try_end),
                    # (val_div, ":relation", ":relation_divider"),
                    # (val_sub, ":modifier", ":relation"),
                # (try_end),
                
                (faction_get_slot, ":party_culture", ":party_faction", slot_faction_culture),
                (try_begin), # If troop is from another faction we increase its price
                    (neq, ":culture", ":party_culture"),
                    (val_add, ":modifier", 25),
                (try_end),
                
                (store_skill_level, ":trade_skill", skl_trade, ":recruiter"),
                (store_skill_level, ":persuasion_skill", skl_persuasion, ":recruiter"),
                (val_div, ":persuasion_skill", 2),
                
                (val_sub, ":modifier", ":trade_skill"),
                (val_sub, ":modifier", ":persuasion_skill"),
                
                (val_max, ":modifier", 20),
            (try_end),
            
            (assign, reg0, ":modifier"),
        ]),
    
    # script_troop_get_info
    # input:
    #   arg1: troop_no
    # output:
    #   s0: troop info
    #   reg0: num_lines
    ("troop_get_info",
        [
            (store_script_param, ":troop_no", 1),
            
            (str_clear, s0),
            
            (assign, ":num_lines", 0),
            
            (store_attribute_level, reg11, ":troop_no", ca_strength),
            (store_attribute_level, reg12, ":troop_no", ca_agility),
            (store_attribute_level, reg13, ":troop_no", ca_intelligence),
            (store_attribute_level, reg14, ":troop_no", ca_charisma),
            # (store_character_level, reg10, ":troop_no"),
            (store_skill_level, ":ironflesh", skl_ironflesh, ":troop_no"),
            (store_mul, reg10, ":ironflesh", 2),
            (val_add, reg10, reg11),
            (val_add, reg10, 35),
            
            # (str_store_string, s0, "@Level: {reg10}^Strength: {reg11}^Agility: {reg12}^Intelligence: {reg13}^Charisma: {reg14}^"),
            (str_store_string, s0, "@Strength: {reg11}^Agility: {reg12}^Intelligence: {reg13}^Charisma: {reg14}^Health: {reg10}^"),
            (val_add, ":num_lines", 6),
            
            (assign, ":has_1h", 0),
            (assign, ":has_2h", 0),
            (assign, ":has_pole", 0),
            (assign, ":has_bow", 0),
            (assign, ":has_xbow", 0),
            (assign, ":has_throw", 0),
            (assign, ":has_horse", 0),
            (troop_get_inventory_capacity, ":capacity", ":troop_no"),
            (try_for_range, ":item_slot", ek_item_0, ":capacity"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":item_slot"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (try_begin),
                    (this_or_next|is_between, ":cur_item", "itm_bastard_sword_a", "itm_sword_of_war"),
                    (this_or_next|eq, ":cur_item", "itm_morningstar"),
                    (eq, ":cur_item", "itm_club_with_spike_head"), # Special onehanded/twohanded
                    (assign, ":has_1h", 1),
                    (assign, ":has_2h", 1),
                (else_try),
                    (eq, ":item_type", itp_type_two_handed_wpn),
                    (assign, ":has_2h", 1),
                (else_try),
                    (eq, ":item_type", itp_type_polearm),
                    (assign, ":has_pole", 1),
                (else_try),
                    (eq, ":item_type", itp_type_bow),
                    (assign, ":has_bow", 1),
                (else_try),
                    (eq, ":item_type", itp_type_crossbow),
                    (assign, ":has_xbow", 1),
                (else_try),
                    (eq, ":item_type", itp_type_thrown),
                    (assign, ":has_throw", 1),
                (else_try),
                    (eq, ":item_type", itp_type_horse),
                    (assign, ":has_horse", 1),
                (else_try),
                    (eq, ":item_type", itp_type_one_handed_wpn),
                    (assign, ":has_1h", 1),
                (try_end),
            (try_end),
            
            (assign, reg5, 0),
            (try_begin),
                (troop_is_guarantee_ranged, ":troop_no"),
                (assign, reg5, 1),
            (try_end),
            
            (try_begin),
                (eq, ":has_1h", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_one_handed_weapon),
                (str_store_string, s0, "@{s0}^One-handed: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_2h", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_two_handed_weapon),
                (str_store_string, s0, "@{s0}^Two-handed: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_pole", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_polearm),
                (str_store_string, s0, "@{s0}^Polearm: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_bow", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_archery),
                (str_store_string, s0, "@{s0}^Archery: {reg10} {reg5?(*):}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_xbow", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_crossbow),
                (str_store_string, s0, "@{s0}^Crossbow: {reg10} {reg5?(*):}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_throw", 1),
                (store_proficiency_level, reg10, ":troop_no", wpt_throwing),
                (str_store_string, s0, "@{s0}^Throwing: {reg10} {reg5?(*):}"),
                (val_add, ":num_lines", 1),
            (try_end),
            
            # (store_skill_level, reg10, skl_ironflesh, ":troop_no"),
            (assign, reg10, ":ironflesh"),
            (store_skill_level, reg11, skl_power_strike, ":troop_no"),
            (str_store_string, s0, "@{s0}^^Ironflesh: {reg10}^Power Strike: {reg11}"),
            (val_add, ":num_lines", 3),
            
            (try_begin),
                (eq, ":has_bow", 1),
                (store_skill_level, reg10, skl_power_draw, ":troop_no"),
                (str_store_string, s0, "@{s0}^Power Draw: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            (try_begin),
                (eq, ":has_throw", 1),
                (store_skill_level, reg10, skl_power_throw, ":troop_no"),
                (str_store_string, s0, "@{s0}^Power Throw: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            
            (try_begin),
                (store_skill_level, reg10, skl_shield, ":troop_no"),
                (gt, reg10, 0),
                (str_store_string, s0, "@{s0}^Shield: {reg10}"),
                (val_add, ":num_lines", 1),
            (try_end),
            
            (store_skill_level, reg10, skl_athletics, ":troop_no"),
            (str_store_string, s0, "@{s0}^Athletics: {reg10}"),
            (val_add, ":num_lines", 1),
            
            (try_begin),
                (eq, ":has_horse", 1),
                (store_skill_level, reg10, skl_riding, ":troop_no"),
                (str_store_string, s0, "@{s0}^Riding: {reg10}"),
                (val_add, ":num_lines", 1),
                (try_begin),
                    (this_or_next|eq, ":has_bow", 1),
                    (this_or_next|eq, ":has_xbow", 1),
                    (eq, ":has_throw", 1),
                    (store_skill_level, reg10, skl_horse_archery, ":troop_no"),
                    (str_store_string, s0, "@{s0}^Horse Archery: {reg10}"),
                    (val_add, ":num_lines", 1),
                (try_end),
            (try_end),
            
            (assign, reg0, ":num_lines"),
        ]),
    
    # script_troop_get_description
    # input:
    #   arg1: troop_id
    # output:
    #   s0: troop_description
    #   reg0: num_lines
    ("troop_get_description",
        [
            (store_script_param, ":troop_no", 1),
                
            (assign, ":num_lines", 1),

            (try_begin),
                (troop_is_hero, ":troop_no"),

                (str_store_troop_name, s10, ":troop_no"),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (str_store_faction_name, s11, ":troop_faction"),
                (str_store_string, s12, "@Vassal of {s11}"),
                (str_store_string, s0, "@{s10}^{s12}"),
                (assign, ":num_lines", 2),
            (else_try),
            
                (troop_get_slot, ":troop_type", ":troop_no", slot_troop_type),
                (store_add, ":str", "str_names_end", ":troop_type"),
                
                (troop_get_slot, ":armor", ":troop_no", slot_troop_armor_weight),
                (troop_get_slot, ":horse", ":troop_no", slot_troop_horse_weight),
                (troop_get_slot, ":weapon", ":troop_no", slot_troop_ranged_weapon_weight),
                
                (troop_get_slot, ":quality", ":troop_no", slot_troop_quality),
                (store_add, ":quality_str", ":quality", "str_troop_quality_peasant"),
                (str_store_string, s13, ":quality_str"),
                
                # (str_clear, s0),
                
                (str_store_string, s14, ":str"),
                (str_store_string, s0, "@{s13} {s14}"),
                
                (try_begin),
                    (ge, ":armor", 0),
                    (store_add, ":armor_string", ":armor", "str_weight_very_light"),
                    (str_store_string, s10, ":armor_string"),
                    (str_store_string, s0, "@{s0}^{s10} armor"),
                    (val_add, ":num_lines", 1),
                (try_end),
                (try_begin),
                    (ge, ":horse", 0),
                    (store_add, ":horse_string", ":horse", "str_weight_very_light"),
                    (str_store_string, s11, ":horse_string"),
                    (str_store_string, s0, "@{s0}^{s11} horse"),
                    (val_add, ":num_lines", 1),
                (try_end),
                (try_begin),
                    (ge, ":weapon", 0),
                    (store_add, ":weapon_string", ":weapon", "str_weight_very_light"),
                    (str_store_string, s12, ":weapon_string"),
                    (str_store_string, s0, "@{s0}^{s12} ranged weapons"),
                    (val_add, ":num_lines", 1),
                (try_end),
            (try_end),
            
            (assign, reg0, ":num_lines"),
        ]),
    
    # script_setup_troop_meeting
    # input:
    #   arg1: troop_id
    #   arg2: troop_dna
    # output: none
    ("setup_troop_meeting",
        [
            (store_script_param_1, ":meeting_troop"),
            (store_script_param_2, ":troop_dna"),
            (call_script, "script_get_meeting_scene"),
            (assign, ":meeting_scene", reg0),
            (modify_visitors_at_site,":meeting_scene"),
            (reset_visitors),
            (set_visitor,0,"$g_player_troop"),
            (try_begin),
                (gt, ":troop_dna", -1),
                (set_visitor,17,":meeting_troop",":troop_dna"),
            (else_try),
                (set_visitor,17,":meeting_troop"),
            (try_end),
            (set_jump_mission,"mt_conversation_encounter"),
            (jump_to_scene,":meeting_scene"),
            (change_screen_map_conversation, ":meeting_troop"),
        ]),
    
    # script_setup_party_meeting
    # input:
    #   arg1: party_id
    # output: none
    ("setup_party_meeting",
        [
            (store_script_param_1, ":meeting_party"),
            
            (party_stack_get_troop_id, ":meeting_troop", ":meeting_party",0),
            (assign, ":stack", 0),
            (try_begin),
                (neg|troop_is_hero, ":meeting_troop"),
                # If troop is not hero, we chose the highest level in the party
                (store_character_level, ":max_level", ":meeting_troop"),
                (party_get_num_companion_stacks, ":num_stacks", ":meeting_party"),
                (try_for_range, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", ":meeting_party", ":cur_stack"),
                    (store_character_level, ":troop_level", ":troop_id"),
                    (try_begin),
                        (gt, ":troop_level", ":max_level"),
                        (assign, ":max_level", ":troop_level"),
                        (assign, ":meeting_troop", ":troop_id"),
                        (assign, ":stack", ":cur_stack"),
                    (else_try),
                        (party_slot_eq, ":meeting_party", slot_party_type, spt_caravan),
                        (store_faction_of_party, ":faction_party", ":meeting_party"),
                        (faction_get_slot, ":culture", ":faction_party", slot_faction_culture),
                        (is_between, ":culture", cultures_begin, cultures_end),
                        (faction_get_slot, ":caravan_master", ":culture", slot_faction_caravan_master),
                        (eq, ":caravan_master", ":troop_id"),
                        (assign, ":max_level", 1000),
                        (assign, ":meeting_troop", ":caravan_master"),
                        (assign, ":stack", ":cur_stack"),
                    (try_end),
                (try_end),
            (try_end),
            (party_stack_get_troop_dna, ":troop_dna", ":meeting_party", ":stack"),
            
            (call_script, "script_setup_troop_meeting", ":meeting_troop", ":troop_dna"),
        ]),
    
    # script_get_meeting_scene
    # input: none
    # output:
    #   reg0: contain suitable scene_no
    ("get_meeting_scene",
        [
            (party_get_current_terrain, ":terrain_type", "$g_player_party"),
            # (assign, ":scene_to_use", "scn_random_scene"),
            (try_begin),
                (eq, ":terrain_type", rt_steppe),
                (assign, ":scene_to_use", "scn_meeting_scene_steppe"),
            (else_try),
                (eq, ":terrain_type", rt_plain),
                (assign, ":scene_to_use", "scn_meeting_scene_plain"),
            (else_try),
                (eq, ":terrain_type", rt_snow),
                (assign, ":scene_to_use", "scn_meeting_scene_snow"),
            (else_try),
                (eq, ":terrain_type", rt_desert),
                (assign, ":scene_to_use", "scn_meeting_scene_desert"),
            (else_try),
                (eq, ":terrain_type", rt_steppe_forest),
                (assign, ":scene_to_use", "scn_meeting_scene_steppe"),
            (else_try),
                (eq, ":terrain_type", rt_forest),
                (assign, ":scene_to_use", "scn_meeting_scene_plain"),
            (else_try),
                (eq, ":terrain_type", rt_snow_forest),
                (assign, ":scene_to_use", "scn_meeting_scene_snow"),
            (else_try),
                (eq, ":terrain_type", rt_desert_forest),
                (assign, ":scene_to_use", "scn_meeting_scene_desert"),
            (else_try),
                (assign, ":scene_to_use", "scn_meeting_scene_plain"),
            (try_end),
            (assign, reg0, ":scene_to_use"),
        ]),
    
    # script_get_battle_scene
    ## Select the scene for the next battle
    ## Scene is chosen based on current terrain
    # input: none
    # output:
    #   reg0: contain suitable scene_no
    ("get_battle_scene",
        [
            (party_get_current_terrain, ":terrain_type", "$g_player_party"),
            # (assign, ":scene_to_use", "scn_random_scene"),
            (try_begin),
                (eq, ":terrain_type", rt_steppe),
                (assign, ":scene_to_use", "scn_random_scene_steppe"),
            (else_try),
                (eq, ":terrain_type", rt_plain),
                (assign, ":scene_to_use", "scn_random_scene_plain"),
            (else_try),
                (eq, ":terrain_type", rt_snow),
                (assign, ":scene_to_use", "scn_random_scene_snow"),
            (else_try),
                (eq, ":terrain_type", rt_desert),
                (assign, ":scene_to_use", "scn_random_scene_desert"),
            (else_try),
                (eq, ":terrain_type", rt_steppe_forest),
                (assign, ":scene_to_use", "scn_random_scene_steppe_forest"),
            (else_try),
                (eq, ":terrain_type", rt_forest),
                (assign, ":scene_to_use", "scn_random_scene_plain_forest"),
            (else_try),
                (eq, ":terrain_type", rt_snow_forest),
                (assign, ":scene_to_use", "scn_random_scene_snow_forest"),
            (else_try),
                (eq, ":terrain_type", rt_desert_forest),
                (assign, ":scene_to_use", "scn_random_scene_desert_forest"),
            (else_try),
                (assign, ":scene_to_use", "scn_meeting_scene_plain"),
            (try_end),
            (assign, reg0, ":scene_to_use"),
        ]),
    
    # script_troop_copy_items_from_troop
    # input:
    #   arg1: recipient
    #   arg2: troop_to_copy
    # output: none
    ("troop_copy_items_from_troop",
        [
            (store_script_param, ":recipient", 1),
            (store_script_param, ":troop_no", 2),
            
            (troop_get_inventory_capacity, ":num_stacks", ":troop_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":cur_stack"),
                (gt, ":cur_item", 0),
                (troop_add_item, ":recipient", ":cur_item"),
            (try_end),
        ]),
    
    # script_troop_copy_items_of_type_from_troop
    # input:
    #   arg1: recipient
    #   arg2: troop_to_copy
    #   arg3: item_type
    # output: none
    ("troop_copy_items_of_type_from_troop",
        [
            (store_script_param, ":recipient", 1),
            (store_script_param, ":troop_no", 2),
            (store_script_param, ":type", 3),
            
            (troop_get_inventory_capacity, ":num_stacks", ":troop_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":cur_stack"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (eq, ":item_type", ":type"),
                (troop_add_item, ":recipient", ":cur_item"),
            (try_end),
        ]),
    
    # script_troop_remove_armor
    # input:
    #   arg1: troop_no
    # output: none
    ("troop_remove_armor",
        [
            (store_script_param, ":troop_no", 1),
            (troop_get_inventory_capacity, ":num_stacks", ":troop_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":cur_stack"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (is_between, ":item_type", itp_type_head_armor, itp_type_pistol),
                (troop_remove_item, ":troop_no", ":cur_item"),
            (try_end),
        ]),
    
    # script_troop_remove_weapons
    # input:
    #   arg1: troop_no
    # output: none
    ("troop_remove_weapons",
        [
            (store_script_param, ":troop_no", 1),
            (troop_get_inventory_capacity, ":num_stacks", ":troop_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":cur_stack"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (is_between, ":item_type", itp_type_one_handed_wpn, itp_type_goods),
                (troop_remove_item, ":troop_no", ":cur_item"),
            (try_end),
        ]),
    
    # script_troop_items_of_type
    # input:
    #   arg1: troop_no
    #   arg2: item_type
    # output: none
    ("troop_remove_items_of_type",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":type", 2),
            (troop_get_inventory_capacity, ":num_stacks", ":troop_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (troop_get_inventory_slot, ":cur_item", ":troop_no", ":cur_stack"),
                (gt, ":cur_item", 0),
                (item_get_type, ":item_type", ":cur_item"),
                (eq, ":item_type", ":type"),
                (troop_remove_item, ":troop_no", ":cur_item"),
            (try_end),
        ]),
    
    # script_party_select_battle_side
    # input:
    #   arg1: party_to_join
    #   arg2: battle_party_1
    #   arg3; battle_party_2
    # output:
    #   reg0: party_to_join (0: none, 1: party_1, 2: party_2)
    ("party_select_battle_side",
        [
            (store_script_param, ":party_to_join", 1),
            (store_script_param, ":battle_party_1", 2),
            (store_script_param, ":battle_party_2", 3),
            
            (store_faction_of_party, ":party_faction", ":party_to_join"),
            (store_faction_of_party, ":party_1_faction", ":battle_party_1"),
            (store_faction_of_party, ":party_2_faction", ":battle_party_2"),
            
            (store_relation, ":rel", ":party_faction", ":party_1_faction"),
            (store_relation, ":rel2", ":party_faction", ":party_2_faction"),
            
            (assign, ":continue", 0),
            (try_begin),
                (eq, ":party_faction", ":party_1_faction"),
                (assign, ":continue", 1),
            (else_try),
                (eq, ":party_faction", ":party_2_faction"),
                (assign, ":continue", 2),
            (else_try),
                (try_begin),
                    (le, ":rel2", relation_state_conflict),
                    (ge, ":rel", relation_state_friendly),
                    (assign, ":continue", 1),
                (else_try),
                    (le, ":rel2", relation_state_war),
                    (ge, ":rel", relation_state_neutral),
                    (assign, ":continue", 1),
                (else_try),
                    (le, ":rel", relation_state_conflict),
                    (ge, ":rel2", relation_state_friendly),
                    (assign, ":continue", 2),
                (else_try),
                    (le, ":rel", relation_state_war),
                    (ge, ":rel2", relation_state_neutral),
                    (assign, ":continue", 2),
                (try_end),
            (try_end),
            (assign, reg0, ":continue"),
        ]),
    
    # script_party_get_looted_gold
        # input:
        #   arg1: looted_party
        # output:
        #   reg0: gold_amount
    ("party_get_looted_gold",
        [
            (store_script_param, ":looted_party", 1),
            
            # (party_get_num_companions, ":num_enemy", ":looted_party"),
            (party_get_num_companion_stacks, ":num_stack", ":looted_party"),
            (assign, ":total_gold", 0),
            (try_for_range, ":stack_no", 0, ":num_stack"),
                (party_stack_get_troop_id, ":cur_troop", ":looted_party", ":stack_no"),

                (try_begin),
                    (troop_is_hero, ":cur_troop"),
                    (store_troop_gold, ":current_gold", ":cur_troop"),
                    # ToDo: percent gold removed global difficulty parameter
                    (store_div, ":removed_gold", ":current_gold", 20),
                    (troop_remove_gold, ":cur_troop", ":removed_gold"),
                    (val_add, ":total_gold", ":removed_gold"),
                (else_try),
                    # ToDo: refine regular troop gold cost
                    (store_character_level, ":troop_level", ":cur_troop"),
                    (party_stack_get_size, ":stack_size", ":looted_party", ":stack_no"),
                    (val_mul, ":troop_level", 10),
                    (val_mul, ":troop_level", ":stack_size"),
                    (val_add, ":total_gold", ":troop_level"),
                (try_end),
            (try_end),

            (assign, reg0, ":total_gold"),
        ]),

    # script_party_get_loot
        # input:
        #   arg1: party_no
        #   arg2: clear_storage
        #   arg3: [optional] loot_storage, defaults(trp_temp_troop)
        # output: 
        #   reg0: loot_storage
    ("party_get_loot",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":clear_storage", 2),
            (store_script_param, ":loot_storage", 3),

            (try_begin),
                (eq, ":loot_storage", -1),
                (assign, ":loot_storage", "trp_temp_troop"),
            (try_end),
            (try_begin),
                (eq, ":clear_storage", 1),
                (troop_clear_inventory, ":loot_storage"),
            (try_end),

            (party_get_num_companions, ":party_size", ":party_no"),
            (set_fixed_point_multiplier, 1),
            (store_sqrt, ":divider", ":party_size"),
            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (try_begin),
                    (store_free_inventory_capacity, ":free_inventory", ":loot_storage"),
                    (lt, ":free_inventory", 5),
                    # Not enough free space, remove low price items
                    (troop_sort_inventory, ":loot_storage"),
                    (troop_ensure_inventory_space, ":loot_storage", 10),
                (try_end),

                (party_stack_get_troop_id, ":troop_no", ":party_no", ":cur_stack"),
                (party_stack_get_size, ":size", ":party_no", ":cur_stack"),

                (store_mul, ":probability", ":size", 200),
                (val_div, ":probability", ":divider"),
                # Min amount of loot from troop
                # Improves variety of loot
                # (val_max, ":probability", 5),
                (troop_loot_troop, ":loot_storage", ":troop_no", ":probability"),
            (try_end),
            (troop_sort_inventory, ":loot_storage"),
            (assign, reg0, ":loot_storage"),
        ]),

    # script_party_update_merchants
        ## Updates merchants inventory from party_no with new items
        # input:
        #   arg1: party_no
        # output: none
    ("party_update_merchants",
        [
            (store_script_param, ":party_no", 1),
            
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (this_or_next|eq, ":party_type", spt_town),
                (eq, ":party_type", spt_castle),
                (store_sub, ":offset", ":party_no", towns_begin),
                (store_add, ":merchant", merchants_general_begin, ":offset"),
                (try_begin),
                    (call_script, "script_cf_merchant_can_update", ":merchant"),
                    (assign, ":num_times", reg0),
                    (try_for_range, ":unused", 0, ":num_times"),
                        (call_script, "script_troop_add_merchant_items_from_party", ":merchant", ":party_no", items_weapon|items_armor|items_good|items_horse),
                    (try_end),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":party_type", spt_town),
                (store_sub, ":offset", ":party_no", towns_begin),
                (store_add, ":merchant", merchants_weapons_begin, ":offset"),
                
                (call_script, "script_cf_merchant_can_update", ":merchant"),
                (assign, ":num_times", reg0),
                (store_faction_of_party, ":party_faction", ":party_no"),
                (party_set_faction, "p_temp_party", ":party_faction"),
                (party_clear, "p_temp_party"),
            
                (troop_clear_inventory, "trp_temp_troop"),
                (store_mul, ":num_tries", ":num_times", 2),
                (try_for_range, ":unused", 0, ":num_tries"),
                    #(call_script, "script_troop_add_merchant_items_from_party", ":merchant", ":party_no", items_weapon),
                    (call_script, "script_party_add_reinforcements", "p_temp_party"),
                (try_end),
                (party_get_num_companion_stacks, ":num_stacks", "p_temp_party"),
                (try_for_range, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":cur_troop", "p_temp_party", ":cur_stack"),
                    (party_stack_get_size, ":size", "p_temp_party", ":cur_stack"),
                    (val_div, ":size", 3), # We reduce the number of troops in each stack to prevent peasant items from bloating the inventory
                    (val_add, ":size", 1), # 
                    (try_for_range, ":unused", 0, ":size"),
                        (troop_loot_troop, "trp_temp_troop", ":cur_troop", 100),
                    (try_end),
                (try_end),
                (troop_get_inventory_capacity, ":num_items", "trp_temp_troop"),

                (store_sub, ":offset", ":party_no", towns_begin),
                (store_add, ":merchant", merchants_weapons_begin, ":offset"),
                # Adding weapons

                (troop_get_inventory_capacity, ":capacity", ":merchant"),
                (val_div, ":capacity", 2),
                (troop_sort_inventory, ":merchant"),
                (troop_ensure_inventory_space, ":merchant", ":capacity"),

                (try_for_range, ":i", 0, ":num_items"),
                    (troop_get_inventory_slot, ":item", "trp_temp_troop", ":i"),
                    (gt, ":item", 0),
                    (troop_get_inventory_slot_modifier, ":modifier", "trp_temp_troop", ":i"),
                    (item_get_type, ":item_type", ":item"),
                    (is_between, ":item_type", itp_type_one_handed_wpn, itp_type_goods),
                    (troop_add_item, ":merchant", ":item", ":modifier"),
                (try_end),
                (troop_sort_inventory, ":merchant"),
                
                (store_sub, ":offset", ":party_no", towns_begin),
                (store_add, ":merchant", merchants_armors_begin, ":offset"),
                # Adding armors
                
                (troop_get_inventory_capacity, ":capacity", ":merchant"),
                (val_div, ":capacity", 2),
                (troop_sort_inventory, ":merchant"),
                (troop_ensure_inventory_space, ":merchant", ":capacity"),

                (try_for_range, ":i", 0, ":num_items"),
                    (troop_get_inventory_slot, ":item", "trp_temp_troop", ":i"),
                    (gt, ":item", 0),
                    (troop_get_inventory_slot_modifier, ":modifier", "trp_temp_troop", ":i"),
                    (item_get_type, ":item_type", ":item"),
                    (is_between, ":item_type", itp_type_head_armor, itp_type_pistol),
                    (troop_add_item, ":merchant", ":item", ":modifier"),
                (try_end),
                (troop_sort_inventory, ":merchant"),

                # (call_script, "script_cf_merchant_can_update", ":merchant"),
                # (assign, ":num_times", reg0),

                # (try_for_range, ":unused", 0, ":num_times"),
                #     (call_script, "script_troop_add_merchant_items_from_party", ":merchant", ":party_no", items_armor),
                # (try_end),
            (try_end),
            (try_begin),
                (eq, ":party_type", spt_castle),
                (store_sub, ":offset", ":party_no", castles_begin),
                (store_add, ":merchant", merchants_smiths_begin, ":offset"),
                
                (call_script, "script_cf_merchant_can_update", ":merchant"),
                (assign, ":num_times", reg0),
                (try_for_range, ":unused", 0, ":num_times"),
                    (call_script, "script_troop_add_merchant_items_from_party", ":merchant", ":party_no", items_weapon|items_armor),
                (try_end),
            (try_end),
        ]),
    
    # script_party_update_merchants_gold
    ## Gives merchants from party_no some gold
    # input:
    #   arg1: party_no
    # output: none
    ("party_update_merchants_gold",
        [
            (store_script_param, ":party_no", 1),
            
            # (party_get_slot, ":party_type", ":party_no", slot_party_type),
            
            (store_sub, ":offset", ":party_no", towns_begin),
            (try_begin),
                (is_between, ":party_no", towns_begin, towns_end),
                (store_add, ":weapon_merchant", merchants_weapons_begin, ":offset"),
                (call_script, "script_troop_update_merchant_gold", ":weapon_merchant"),
            (try_end),
            
            (store_add, ":general_merchant", merchants_general_begin, ":offset"),
            
            (call_script, "script_troop_update_merchant_gold", ":general_merchant"),
        ]),
    
    # script_troop_update_merchant_gold
    ## Select the amount of gold that has to be given to troop_no depending on the merchant type he his
    # input:
    #   arg1: troop_no
    # output: none
    ("troop_update_merchant_gold",
        [
            (store_script_param, ":merchant", 1),
            
            (assign, ":base_gold", 100),
            
            (try_begin),
                (is_between, ":merchant", merchants_general_begin, merchants_general_end),
                (assign, ":base_gold", merchant_base_gold_earn_general),
            (else_try),
                # (is_between, ":merchant", merchants_weapons_begin, merchants_weapons_end),
                (assign, ":base_gold", merchant_base_gold_earn_weaponsmith),
            # (else_try),
                # (is_between, ":merchant", merchants_armors_begin, merchants_armors_end),
                # (assign, ":base_gold", merchant_base_gold_earn_armorsmith),
            # (else_try),
                # (is_between, ":merchant", merchants_goods_begin, merchants_goods_end),
                # (assign, ":base_gold", merchant_base_gold_earn_goods),
            # (else_try),
                # (is_between, ":merchant", merchants_horses_begin, merchants_horses_end),
                # (assign, ":base_gold", merchant_base_gold_earn_horses),
            (try_end),
            
            (call_script, "script_troop_add_merchant_gold", ":merchant", ":base_gold"),
        ]),
    
    # script_troop_add_merchant_gold
    ## Modify the amount of gold of a certain merchant
    ## ToDo: will need to be used for taxes
    # input:
    #   arg1: troop_no
    #   arg2: base_gold
    # output:
    #   reg0: gold_added
    ("troop_add_merchant_gold",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":base_gold", 2),
            
            (store_troop_gold, ":cur_gold", ":merchant"),
            (store_div, ":sub", ":cur_gold", 5),
            (store_sub, ":gold_added", ":base_gold", ":sub"),
            (store_random_in_range, ":bonus_gold", 0, 10),
            (val_add, ":gold_added", ":bonus_gold"),
            (troop_add_gold, ":merchant", ":gold_added"),
            
            (assign, reg0, ":gold_added"),
        ]),
    
    
    # script_troop_add_merchant_items_from_party
    # input:
    #   arg1: merchant
    #   arg2: party_no
    #   arg3: items
    # output: none
    ("troop_add_merchant_items_from_party",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":party_no", 2),
            (store_script_param, ":items", 3),
            
            (store_faction_of_party, ":party_faction", ":party_no"),
            (faction_get_slot, ":culture", ":party_faction", slot_faction_culture),
            
            (store_and, ":goods", ":items", items_good),
            (store_and, ":weapons", ":items", items_weapon),
            (store_and, ":armor", ":items", items_armor),
            (store_and, ":horse", ":items", items_horse),
            
            (troop_get_inventory_capacity, ":capacity", ":merchant"),
            (val_div, ":capacity", 2),
            (troop_sort_inventory, ":merchant"),
            (troop_ensure_inventory_space, ":merchant", ":capacity"),
            
            (assign, ":num_items", 0),
            (try_begin),
                (gt, ":weapons", 0),
                (val_add, ":num_items", 1),
            (try_end),
            (try_begin),
                (gt, ":armor", 0),
                (val_add, ":num_items", 1),
            (try_end),
            (try_begin),
                (gt, ":horse", 0),
                (val_add, ":num_items", 1),
            (try_end),
            (try_begin),
                (gt, ":goods", 0),
                (val_add, ":num_items", 1),
            (try_end),
            
            (try_begin),
                (gt, ":weapons", 0),
                (store_div, ":items", 15, ":num_items"),
                (try_begin),
                    (gt, ":goods", 0),
                    (val_div, ":items", 2),
                (try_end),
                (call_script, "script_troop_add_merchant_items_weapons", ":merchant", ":culture", ":items"),
            (try_end),
            (try_begin),
                (gt, ":armor", 0),
                
                (store_div, ":items", 15, ":num_items"),
                (try_begin),
                    (gt, ":goods", 0),
                    (val_div, ":items", 2),
                (try_end),
                (call_script, "script_troop_add_merchant_items_armors", ":merchant", ":culture", ":items"),
            (try_end),
            (try_begin),
                (gt, ":horse", 0),
                
                (store_div, ":items", 6, ":num_items"),
                (try_begin),
                    (gt, ":goods", 0),
                    (val_div, ":items", 2),
                (try_end),
                (call_script, "script_troop_add_merchant_items_horses", ":merchant", ":culture", ":items"),
            (try_end),
            (try_begin),
                (gt, ":goods", 0),
                
                (store_div, ":items", 15, ":num_items"),
                (val_mul, ":items", 3),
                (val_div, ":items", 2),
                (call_script, "script_troop_add_merchant_items_goods", ":merchant", ":culture", ":items"),
            (try_end),
            (troop_sort_inventory, ":merchant"),
        ]),
    
    # script_troop_add_merchant_items_weapons
    # input:
    #   arg1: merchant
    #   arg2: culture
    #   zrg3: num_items
    # output: none
    ("troop_add_merchant_items_weapons",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":culture", 2),
            (store_script_param, ":num_items", 3),
            
            (try_for_range, ":unused", 0, ":num_items"),
                (try_begin),
                    (eq, ":culture" ,fac_culture_1),
                    (store_random_in_range, ":rand", 0, 31),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 12),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 18),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 20),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_bow, 1),
                    (else_try),
                        (lt, ":rand", 22),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_crossbow, 1),
                    (else_try),
                        (lt, ":rand", 23),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_arrows, 1),
                    (else_try),
                        (lt, ":rand", 24),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_bolts, 1),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_thrown, 1),
                    (else_try),
                        # (le, ":rand", 31),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_1", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (eq, ":culture", fac_culture_2),
                    (store_random_in_range, ":rand", 0, 35),
                    (try_begin),
                        (lt, ":rand", 7),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 13),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 19),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_bow, 1),
                    # (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_crossbow, 0),
                    (else_try),
                        (lt, ":rand", 27),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_arrows, 1),
                    # (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_bolts, 0),
                    (else_try),
                        (lt, ":rand", 30),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 35),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_2", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (eq, ":culture", fac_culture_3),
                    (store_random_in_range, ":rand", 0, 34),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 11),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 18),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 23),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_bow, 1),
                    # (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_crossbow, 0),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_arrows, 1),
                    # (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_bolts, 0),
                    (else_try),
                        (lt, ":rand", 28),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 34),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_3", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (eq, ":culture", fac_culture_4),
                    (store_random_in_range, ":rand", 0, 38),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 13),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 18),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 22),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_bow, 1),
                    (else_try),
                        (lt, ":rand", 24),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_crossbow, 1),
                    (else_try),
                        (lt, ":rand", 26),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_arrows, 1),
                    (else_try),
                        (lt, ":rand", 27),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_bolts, 1),
                    (else_try),
                        (lt, ":rand", 32),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 38),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_4", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (eq, ":culture", fac_culture_5),
                    (store_random_in_range, ":rand", 0, 36),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 11),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 19),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 20),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_bow, 1),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_crossbow, 1),
                    (else_try),
                        (lt, ":rand", 26),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_arrows, 1),
                    (else_try),
                        (lt, ":rand", 28),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_bolts, 1),
                    (else_try),
                        (lt, ":rand", 30),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 36),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_5", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (eq, ":culture", fac_culture_6),
                    (store_random_in_range, ":rand", 0, 38),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 12),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 17),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 21),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_bow, 1),
                    (else_try),
                        (lt, ":rand", 22),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_crossbow, 1),
                    (else_try),
                        (lt, ":rand", 24),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_arrows, 1),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_bolts, 1),
                    (else_try),
                        (lt, ":rand", 32),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 38),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_kingdom_6", itp_type_shield, 1),
                    (try_end),
                (else_try),
                    (store_random_in_range, ":rand", 0, 35),
                    (try_begin),
                        (lt, ":rand", 8),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_one_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 12),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_two_handed_wpn, 1),
                    (else_try),
                        (lt, ":rand", 19),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_polearm, 1),
                    (else_try),
                        (lt, ":rand", 22),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_bow, 1),
                    (else_try),
                        (lt, ":rand", 25),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_crossbow, 1),
                    (else_try),
                        (lt, ":rand", 26),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_arrows, 1),
                    (else_try),
                        (lt, ":rand", 27),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_bolts, 1),
                    (else_try),
                        (lt, ":rand", 29),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_thrown, 1),
                    (else_try),
                        # (lt, ":rand", 35),
                        (troop_add_merchandise_with_faction, ":merchant", "fac_commoners", itp_type_shield, 1),
                    (try_end),
                (try_end),
            (try_end),
        ]),
    
    # script_troop_add_merchant_items_armors
        # input:
        #   arg1: troop_no
        #   arg2: culture
        #   arg3: num_items
        # output: none
    ("troop_add_merchant_items_armors",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":culture", 2),
            (store_script_param, ":num_items", 3),
            
            (try_begin),
                (eq, ":culture", "fac_culture_1"),
                (assign, ":culture", "fac_kingdom_1"),
            (else_try),
                (eq, ":culture", "fac_culture_2"),
                (assign, ":culture", "fac_kingdom_2"),
            (else_try),
                (eq, ":culture", "fac_culture_3"),
                (assign, ":culture", "fac_kingdom_3"),
            (else_try),
                (eq, ":culture", "fac_culture_4"),
                (assign, ":culture", "fac_kingdom_4"),
            (else_try),
                (eq, ":culture", "fac_culture_5"),
                (assign, ":culture", "fac_kingdom_5"),
            (else_try),
                (eq, ":culture", "fac_culture_6"),
                (assign, ":culture", "fac_kingdom_6"),
            (else_try),
                (assign, ":culture", "fac_commoners"),
            (try_end),
            
            (try_for_range, ":unused", 0, ":num_items"),
                (store_random_in_range, ":rand", 0, 17),
                (try_begin),
                    (lt, ":rand", 2),
                    (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_hand_armor, 1),
                (else_try),
                    (lt, ":rand", 5),
                    (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_foot_armor, 1),
                (else_try),
                    (lt, ":rand", 12),
                    (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_body_armor, 1),
                (else_try),
                    # (lt, ":rand", 17),
                    (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_head_armor, 1),
                (try_end),
            (try_end),
        ]),
    
    # script_troop_add_merchant_items_horses
        # input: 
        #   arg1: troop_no
        #   arg2: culture
        #   arg3: num_items
        # output: none
    ("troop_add_merchant_items_horses",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":culture", 2),
            (store_script_param, ":num_items", 3),
            
            (try_begin),
                (eq, ":culture", "fac_culture_1"),
                (assign, ":culture", "fac_kingdom_1"),
            (else_try),
                (eq, ":culture", "fac_culture_2"),
                (assign, ":culture", "fac_kingdom_2"),
            (else_try),
                (eq, ":culture", "fac_culture_3"),
                (assign, ":culture", "fac_kingdom_3"),
            (else_try),
                (eq, ":culture", "fac_culture_4"),
                (assign, ":culture", "fac_kingdom_4"),
            (else_try),
                (eq, ":culture", "fac_culture_5"),
                (assign, ":culture", "fac_kingdom_5"),
            (else_try),
                (eq, ":culture", "fac_culture_6"),
                (assign, ":culture", "fac_kingdom_6"),
            (else_try),
                (assign, ":culture", "fac_commoners"),
            (try_end),
            
            (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_horse, ":num_items"),
        ]),
    
    # script_troop_add_merchant_items_goods
    # input: 
    #   arg1: troop_no
    #   arg2: culture
    #   arg3: num_items
    # output: none
    ("troop_add_merchant_items_goods",
        [
            (store_script_param, ":merchant", 1),
            (store_script_param, ":culture", 2),
            (store_script_param, ":num_items", 3),
            
            (try_begin),
                (eq, ":culture", "fac_culture_1"),
                (assign, ":culture", "fac_kingdom_1"),
            (else_try),
                (eq, ":culture", "fac_culture_2"),
                (assign, ":culture", "fac_kingdom_2"),
            (else_try),
                (eq, ":culture", "fac_culture_3"),
                (assign, ":culture", "fac_kingdom_3"),
            (else_try),
                (eq, ":culture", "fac_culture_4"),
                (assign, ":culture", "fac_kingdom_4"),
            (else_try),
                (eq, ":culture", "fac_culture_5"),
                (assign, ":culture", "fac_kingdom_5"),
            (else_try),
                (eq, ":culture", "fac_culture_6"),
                (assign, ":culture", "fac_kingdom_6"),
            (else_try),
                (assign, ":culture", "fac_commoners"),
            (try_end),
            
            (troop_add_merchandise_with_faction, ":merchant", ":culture", itp_type_goods, ":num_items"),
        ]),
    
    # script_faction_process_politics
    # input:
    #   arg1: faction_no
    # output: none
    ("faction_process_politics",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":num_fiefs", ":faction_no", slot_faction_num_fiefs),
            (faction_get_slot, ":num_walled_fiefs", ":faction_no", slot_faction_num_walled_fiefs),
            (faction_get_slot, ":num_vassals", ":faction_no", slot_faction_num_vassals),

            # Handle faction defeat
            # ToDo: for now only deactivate factions with no parties (center/lord)
            (try_begin),
                (eq, ":num_fiefs", 0),
                (call_script, "script_faction_disable", ":faction_no"),
            (else_try),
                (call_script, "script_faction_enable", ":faction_no"),
            (try_end),

            (try_begin),
                (neg|faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                # Handle faction wealth
                (call_script, "script_faction_process_wealth", ":faction_no"),
                
                # Distribute captured territory
                (faction_get_slot, ":center_no", ":faction_no", slot_faction_current_free_center),
                (try_begin),
                    (is_between, ":center_no", centers_begin, centers_end),
                    
                    (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                    (eq, ":center_faction", ":faction_no"),
                    
                    (call_script, "script_faction_get_best_candidate_for_center", ":faction_no", ":center_no", -1),
                    (assign, ":troop_no", reg0),
                    
                    (gt, ":troop_no", -1),
                    (call_script, "script_give_center_to_troop", ":center_no", ":troop_no"),
                    
                    (faction_set_slot, ":faction_no", slot_faction_current_free_center, -1),
                (try_end),
                
                # Get new vassals
                (store_sub, ":diff", ":num_walled_fiefs", ":num_vassals"),
                (try_for_range, ":unused", 0, 5),
                    (gt, ":diff", 0),
                    (store_random_in_range, ":add_vassal", ":diff", 6),
                    (ge, ":add_vassal", 5),
                    (call_script, "script_find_free_lord"),
                    (assign, ":new_lord", reg0),
                    (gt, ":new_lord", 0),
                    (call_script, "script_ready_lord", ":new_lord", ":faction_no", 1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_faction|debug_simple),
                        (str_store_troop_name, s10, ":new_lord"),
                        (str_store_faction_name, s11, ":faction_no"),
                        (display_message, "@{s10} joins {s11}"),
                    (try_end),
                    (val_sub, ":diff", 6),
                (try_end),

                # Elect leader
                (call_script, "script_faction_process_leader_selection", ":faction_no"),

                # Elect marshall
                (call_script, "script_faction_process_marshall_selection", ":faction_no"),
                
                # Recruit mercenary bands
                
                (try_begin),
                    (neq, "$g_disable_faction_ai", 1),
                    # Handle foreign diplomacy
                    (call_script, "script_faction_process_foreign_politics", ":faction_no"),
                (try_end),
            (try_end),
            
            # Organize feasts if needed
            
            # Reduce war damage
            (faction_get_slot, ":at_war", ":faction_no", slot_faction_is_at_war),
            (faction_get_slot, ":war_damage", ":faction_no", slot_faction_war_damage),
            # (assign, ":vassals_score", ":num_vassals"),
            # (store_mul, ":fiefs_score", ":num_fiefs", 5),
            (try_begin),
                (gt, ":war_damage", 0),
                (store_sub, ":new_damage", ":war_damage", war_damage_natural_decline_base),
                (try_begin),
                    (le, ":at_war", 0),
                    # War damage decreases faster during peace
                    (store_div, ":damage_reduce", ":war_damage", war_damage_natural_decline_divider),
                    (val_sub, ":new_damage", ":damage_reduce"),
                (try_end),
                (faction_set_slot, ":faction_no", slot_faction_war_damage, ":new_damage"),

                (try_begin),
                    (call_script, "script_cf_debug", debug_war),
                    (str_store_faction_name, s10, ":faction_no"),
                    (assign, reg10, ":war_damage"),
                    (assign, reg11, ":new_damage"),
                    (display_message, "@{s10} war damage change {reg10} -> {reg11}"),
                (try_end),
            (try_end),
        ]),

    # script_reset_faction_politics
        # input:
        #   arg1: faction_no
        # output: none
    ("reset_faction_politics",
        [
            (store_script_param, ":faction_no", 1),

            (try_begin),
                (faction_slot_eq, ":faction_no", slot_faction_status, sfst_default),
                (faction_get_slot, ":budget_tribute", ":faction_no", slot_faction_budget_tribute),
                (faction_get_slot, ":budget_tribute_payment", ":faction_no", slot_faction_budget_tribute_payment),
                (faction_get_slot, ":budget_funds", ":faction_no", slot_faction_budget_funds),
                # (faction_get_slot, ":budget_funds_payment", ":faction_no", slot_faction_budget_funds_payment),

                (faction_get_slot, ":wealth", ":faction_no", slot_faction_wealth),

                (store_add, ":balance", ":budget_tribute", ":budget_tribute_payment"),
                (val_add, ":balance", ":budget_funds"),
                # (val_add, ":balance", ":budget_funds_payment"),

                (faction_get_slot, ":funds_tax", ":faction_no", slot_faction_funds_tax_rate),

                (faction_get_slot, ":at_war", ":faction_no", slot_faction_is_at_war),
                (faction_get_slot, ":preparing_war", ":faction_no", slot_faction_preparing_war),

                (val_max, ":at_war", ":preparing_war"),

                (assign, ":average_additional_funds", 0),
                (try_begin),
                    (gt, ":funds_tax", 0),
                    (store_div, ":average_additional_funds", ":budget_funds", ":funds_tax"),
                (try_end),

                (assign, ":new_target_tax", ":funds_tax"),

                (try_begin),
                    (eq, ":budget_tribute_payment", 0),
                    # (neq, ":funds_tax", faction_tax_rate_funds_base),
                    (try_begin),
                        (gt, ":wealth", 0),
                        (assign, ":new_target_tax", faction_tax_rate_funds_base),
                    (else_try),
                        (gt, ":at_war", 0),
                        (assign, ":new_target_tax", faction_tax_rate_funds_base),
                    (else_try),
                        # Slowly reduce taxes
                        (val_min, ":new_target_tax", 10),
                        (val_sub, ":new_target_tax", 1),
                        (val_max, ":new_target_tax", faction_tax_rate_funds_base),
                    (try_end),
                (else_try),
                    (lt, ":balance", 0),
                    (val_add, ":new_target_tax", 1),
                (else_try),
                    (ge, ":balance", 0),
                    (store_sub, ":remaining_balance", ":balance", ":average_additional_funds"),
                    (try_begin),
                        (gt, ":remaining_balance", 0),
                        (val_sub, ":new_target_tax", 1),
                    (try_end),
                (try_end),

                (try_begin),
                    (neq, ":new_target_tax", ":funds_tax"),
                    (assign, ":new_tax", ":funds_tax"),
                    (try_begin),
                        (gt, ":new_target_tax", ":funds_tax"),
                        (val_add, ":new_tax", 1),
                    (else_try),
                        (val_add, ":new_tax", -1),
                    (try_end),

                    (val_max, ":new_tax", faction_tax_rate_funds_min),
                    (try_begin),
                        (gt, ":at_war", 0),
                        (val_min, ":new_tax", faction_tax_rate_funds_max_war),
                    (else_try),
                        (val_min, ":new_tax", faction_tax_rate_funds_max_peace),
                    (try_end),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (str_store_faction_name, s10, ":faction_no"),
                        (assign, reg10, ":funds_tax"),
                        (assign, reg11, ":new_tax"),
                        (assign, reg12, ":new_target_tax"),
                        (display_message, "@{s10} set funds tax from {reg10} to {reg11} (target: {reg12})"),
                    (try_end),
                    (faction_set_slot, ":faction_no", slot_faction_funds_tax_rate, ":new_tax"),
                (try_end),
            (else_try),
                (faction_set_slot, ":faction_no", slot_faction_funds_tax_rate, 0),
            (try_end),
            (faction_set_slot, ":faction_no", slot_faction_budget_tribute, 0),
            (faction_set_slot, ":faction_no", slot_faction_budget_tribute_payment, 0),
            (faction_set_slot, ":faction_no", slot_faction_budget_funds, 0),
            (faction_set_slot, ":faction_no", slot_faction_budget_funds_payment, 0),
        ]),

    # script_faction_process_leader_selection
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_process_leader_selection",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":leader", ":faction_no", slot_faction_leader),
            (try_begin),
                # No leader
                # Or leader mandate is ended
                (lt, ":leader", 0),
                # ToDo: ended mandate

                (assign, ":best_candidate", -1),
                (assign, ":best_candidate_score", -1),
                (try_for_range, ":cur_lord", lords_begin, lords_end),
                    (store_troop_faction, ":lord_faction", ":cur_lord"),
                    (eq, ":lord_faction", ":faction_no"),
                    (troop_slot_eq, ":cur_lord", slot_troop_kingdom_occupation, tko_kingdom_hero),

                    (neg|troop_slot_ge, ":cur_lord", slot_troop_prisoner_of, 0),
                    (troop_get_slot, ":rank", ":cur_lord", slot_troop_rank),
                    # (ge, ":rank", rank_castle),

                    (assign, ":score", 0),
                    # (troop_get_slot, ":renown", ":cur_lord", slot_troop_renown),
                    # (val_add, ":score", ":renown"),

                    (val_mul, ":rank", ":rank"),
                    (val_mul, ":rank", 90),
                    (val_add, ":score", ":rank"),

                    (troop_get_slot, ":num_vassals", ":cur_lord", slot_troop_num_vassal),
                    (val_mul, ":num_vassals", 150),
                    (val_add, ":score", ":num_vassals"),

                    (gt, ":score", ":best_candidate_score"),
                    (assign, ":best_candidate", ":cur_lord"),
                    (assign, ":best_candidate_score", ":score"),
                (try_end),

                (ge, ":best_candidate", 0),
                (faction_set_slot, ":faction_no", slot_faction_leader, ":best_candidate"),

                (call_script, "script_troop_get_rank", ":best_candidate"),
                (assign, ":rank", reg0),
                (troop_set_slot, ":best_candidate", slot_troop_rank, ":rank"),

                (call_script, "script_troop_update_name", ":best_candidate"),

                (faction_get_slot, ":size", ":faction_no", slot_faction_size_category),
                (assign, ":renown_gain", renown_value_castle/3),
                (try_begin),
                    (eq, ":size", sfs_large),
                    (assign, ":renown_gain", renown_value_town/3),
                (else_try),
                    (eq, ":size", sfs_medium),
                    (assign, ":renown_gain", renown_value_town/2),
                (try_end),
                (call_script, "script_troop_change_renown", ":best_candidate", ":renown_gain"),

                (try_begin),
                    (call_script, "script_cf_debug", debug_simple|debug_faction),
                    (str_store_troop_name, s10, ":best_candidate"),
                    (str_store_faction_name, s11, ":faction_no"),
                    (display_message, "@{s10} is the best candidate to lead {s11}."),
                (try_end),
            (try_end),
        ]),
    
    # script_faction_process_marshall_selection
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_process_marshall_selection",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":leader", ":faction_no", slot_faction_leader),
            (faction_get_slot, ":marshall", ":faction_no", slot_faction_marshall),
            (try_begin),
                # No marshall
                # At war or preparing war
                (lt, ":marshall", 0),
                (faction_get_slot, ":at_war", ":faction_no", slot_faction_is_at_war),
                (faction_get_slot, ":preparing_for_war", ":faction_no", slot_faction_preparing_war),

                (try_begin),
                    (this_or_next|gt, ":at_war", 0),
                    (is_between, ":preparing_for_war", kingdoms_begin, kingdoms_end),

                    (assign, ":best_candidate", -1),
                    (assign, ":best_candidate_score", 0),
                    (try_for_range, ":cur_lord", lords_begin, lords_end),
                        (store_troop_faction, ":lord_faction", ":cur_lord"),
                        (eq, ":lord_faction", ":faction_no"),
                        (troop_slot_eq, ":cur_lord", slot_troop_kingdom_occupation, tko_kingdom_hero),

                        (neg|troop_slot_ge, ":cur_lord", slot_troop_prisoner_of, 0),
                        (troop_get_slot, ":rank", ":cur_lord", slot_troop_rank),
                        (ge, ":rank", rank_castle),

                        (assign, ":score", 0),
                        # (troop_get_slot, ":renown", ":cur_lord", slot_troop_renown),
                        # (val_add, ":score", ":renown"),

                        (val_mul, ":rank", ":rank"),
                        (val_mul, ":rank", 90),
                        (val_add, ":score", ":rank"),

                        (troop_get_slot, ":num_vassals", ":cur_lord", slot_troop_num_vassal),
                        (val_mul, ":num_vassals", 30),
                        (val_add, ":score", ":num_vassals"),

                        (try_begin),
                            (eq, ":cur_lord", ":leader"),
                            (val_sub, ":score", 100),
                        (try_end),

                        (gt, ":score", ":best_candidate_score"),
                        (assign, ":best_candidate", ":cur_lord"),
                        (assign, ":best_candidate_score", ":score"),
                    (try_end),

                    (ge, ":best_candidate", 0),
                    (faction_set_slot, ":faction_no", slot_faction_marshall, ":best_candidate"),
                    (call_script, "script_troop_update_name", ":best_candidate"),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_simple|debug_faction),
                        (str_store_troop_name, s10, ":best_candidate"),
                        (str_store_faction_name, s11, ":faction_no"),
                        (display_message, "@{s10} is the best candidate for marshall of {s11}."),
                    (try_end),
                (try_end),
            (else_try),
                (faction_get_slot, ":at_war", ":faction_no", slot_faction_is_at_war),
                (faction_get_slot, ":preparing_for_war", ":faction_no", slot_faction_preparing_war),
                (try_begin),
                    (le, ":at_war", 0),
                    (le, ":preparing_for_war", 0),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_simple|debug_faction),
                        (str_store_troop_name, s10, ":marshall"),
                        (str_store_faction_name, s11, ":faction_no"),
                        (display_message, "@{s10} removed of marshallship from {s11} for peace time."),
                    (try_end),
                    (faction_set_slot, ":faction_no", slot_faction_marshall, -1),
                    (call_script, "script_troop_update_name", ":marshall"),
                (else_try),
                    (troop_slot_ge, ":marshall", slot_troop_prisoner_of, 0),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_simple|debug_faction),
                        (str_store_troop_name, s10, ":marshall"),
                        (str_store_faction_name, s11, ":faction_no"),
                        (display_message, "@{s10} removed of marshallship from {s11} for being prisoner."),
                    (faction_set_slot, ":faction_no", slot_faction_marshall, -1),
                    (call_script, "script_troop_update_name", ":marshall"),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # script_faction_process_foreign_politics
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_process_foreign_politics",
        [
            (store_script_param, ":faction_no", 1),
            (faction_get_slot, ":own_wars", ":faction_no", slot_faction_is_at_war),
            (assign, ":want_war", 0),
            (assign, ":war_score", 0),
            (assign, ":seek_allies", 0),

            (faction_get_slot, ":num_vassals", ":faction_no", slot_faction_num_vassals),
            (faction_get_slot, ":num_fiefs", ":faction_no", slot_faction_num_fiefs),

            (faction_get_slot, ":own_wars", ":faction_no", slot_faction_is_at_war),

            (call_script, "script_faction_get_war_strengths", ":faction_no"),
            (assign, ":combined_defensive_strength", reg0),
            (assign, ":combined_offensive_strength", reg1),
            (assign, ":combined_offensive_ready_strength", reg2),
            (assign, ":combined_threats_strength", reg3),
            # (assign, ":num_alliances", reg4),

            (faction_set_slot, ":faction_no", slot_faction_strength_defensive_allies, ":combined_defensive_strength"),
            (faction_set_slot, ":faction_no", slot_faction_strength_offensive_allies, ":combined_offensive_strength"),

            (assign, ":safety", 0),
            (try_begin),
                (gt, ":combined_threats_strength", 0),
                (store_mul, ":safety", ":combined_defensive_strength", 100),
                (val_div, ":safety", ":combined_threats_strength"),
                (val_clamp, ":safety", 0, 100),
            (else_try),
                (assign, ":safety", 100),
            (try_end),
            (faction_set_slot, ":faction_no", slot_faction_safety, ":safety"),

            (assign, ":ally_score", 0),
            (assign, ":ally_faction", -1),

            (try_begin),
                (lt, ":safety", 5),
                (assign, ":seek_allies", 5),
            (else_try),
                (lt, ":safety", 25),
                (assign, ":seek_allies", 4),
            (else_try),
                (lt, ":safety", 50),
                (assign, ":seek_allies", 3),
            (else_try),
                (lt, ":safety", 75),
                (assign, ":seek_allies", 2),
            (else_try),
                (lt, ":safety", 95),
                (assign, ":seek_allies", 1),
            (try_end),

            (try_begin),
                (gt, ":seek_allies", 0),

                (assign, ":ally_score", 0),
                (assign, ":best_ally", -1),

                (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                    (neq, ":other_faction", ":faction_no"),
                    (call_script, "script_faction_get_ally_score", ":faction_no", ":other_faction"),
                    (assign, ":score", reg0),
                    (call_script, "script_faction_get_ally_score", ":other_faction", ":faction_no"),
                    (assign, ":other_score", reg0),
                    (store_add, ":total_score", ":score", ":other_score"),
                    (try_begin),
                        (gt, ":total_score", ":ally_score"),
                        (assign, ":ally_score", ":total_score"),
                        (assign, ":best_ally", ":other_faction"),
                    (try_end),

                    (call_script, "script_cf_faction_generate_faction_event", ":faction_no", ":other_faction"),
                (try_end),

                (try_begin),
                    (gt, ":best_ally", 0),

                    (call_script, "script_faction_try_improve_relations", ":faction_no", ":best_ally"),
                (try_end),
            (try_end),

            (assign, ":enemy_score", 0),
            (assign, ":enemy_faction", -1),

            (try_begin),
                (eq, ":own_wars", 0),

                (call_script, "script_cf_faction_want_war", ":faction_no"),
                (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                    (call_script, "script_cf_faction_can_declare_war", ":faction_no", ":other_faction"),

                    (call_script, "script_faction_get_declare_war_score", ":faction_no", ":other_faction"),
                    (assign, ":score", reg0),

                    (try_begin),
                        (gt, ":score", ":war_score"),
                        (assign, ":want_war", ":other_faction"),
                        (assign, ":war_score", ":score"),
                    (try_end),
                (try_end),

                (try_begin),
                    (gt, ":war_score", 0),
                    (is_between, ":want_war", kingdoms_begin, kingdoms_end),

                    (faction_get_slot, ":preparing_war", ":faction_no", slot_faction_preparing_war),
                    (try_begin),
                        (eq, ":preparing_war", ":want_war"),
                        (try_begin),
                            (call_script, "script_cf_faction_want_vassal", ":faction_no", ":want_war"),

                            (call_script, "script_faction_get_treaty_score", ":want_war", sfkt_overlord, ":faction_no"),
                            (gt, reg0, 0),
                            (call_script, "script_faction_create_vassal", ":faction_no", ":want_war", sfvt_default_vassal_type, -1),

                            (call_script, "script_faction_relation_change_event", ":want_war", ":faction_no", relation_change_submit),

                            (try_begin),
                                (call_script, "script_cf_debug", debug_simple),
                                (str_store_faction_name, s10, ":faction_no"),
                                (str_store_faction_name, s11, ":want_war"),
                                (display_message, "@{s10} vassalize {s11} under threat of war", text_color_war),
                            (try_end),
                        (else_try),
                            (call_script, "script_faction_declare_war_to_faction", ":faction_no", ":want_war", -1),
                        (try_end),
                    (else_try),
                        (neq, ":preparing_war", ":want_war"),
                        (is_between, ":preparing_war", kingdoms_begin, kingdoms_end),
                        (faction_set_slot, ":faction_no", slot_faction_preparing_war, ":want_war"),
                        (try_begin),
                            (call_script, "script_cf_debug", debug_war),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":want_war"),
                            (str_store_faction_name, s12, ":preparing_war"),
                            (assign, reg10, ":war_score"),
                            (display_message, "@{s10} preparing for war against {s11} with score {reg10} (changed from {s12})"),
                        (try_end),
                    (else_try),
                        (faction_set_slot, ":faction_no", slot_faction_preparing_war, ":want_war"),
                        (try_begin),
                            (call_script, "script_cf_debug", debug_war),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":want_war"),
                            (assign, reg10, ":war_score"),
                            (display_message, "@{s10} preparing for war against {s11} with score {reg10}"),
                        (try_end),
                    (try_end),
                (else_try),
                    (faction_set_slot, ":faction_no", slot_faction_preparing_war, -1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war),
                        (str_store_faction_name, s10, ":faction_no"),
                        (display_message, "@{s10} is not seeking war"),
                    (try_end),
                (try_end),
            (else_try),
                (gt, ":own_wars", 0),
                # Process current wars
                (store_sub, ":offset", ":faction_no", kingdoms_begin),
                (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),
                (try_for_range, ":war_storage", war_storages_begin, war_storages_end),
                    (faction_get_slot, ":participant", ":war_storage", ":slot"),
                    (neq, ":participant", swkp_bystander),
                    (call_script, "script_faction_get_war_declaration_score", ":faction_no", ":war_storage"),
                    (assign, ":score", reg0),
                    (call_script, "script_faction_set_war_willingness", ":faction_no", ":war_storage", ":score"),

                    (try_begin),
                        (this_or_next|eq, ":participant", swkp_main_defender),
                        (eq, ":participant", swkp_main_aggressor),
                        # Here we process peace declaration as we are the main participant
                        (call_script, "script_faction_process_main_participant_war", ":faction_no", ":war_storage"),
                        (assign, ":global_willingness", reg0),

                        (try_begin),
                            (call_script, "script_cf_debug", debug_war),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":war_storage"),
                            (assign, reg10, ":global_willingness"),
                            (display_message, "@Willingness of {s10} for war {s11}: {reg10}"),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),

            (try_begin),
                (gt, ":ally_faction", kingdoms_begin),
                (try_begin),
                    (call_script, "script_cf_debug", debug_faction),
                    (assign, reg10, ":ally_score"),
                    (str_store_faction_name, s10, ":faction_no"),
                    (str_store_faction_name, s11, ":ally_faction"),
                    (display_message, "@{s10} seeks to improve relations with {s11} ({reg10})"),
                (try_end),
            (try_end),
            (try_begin),
                (gt, ":enemy_faction", kingdoms_begin),
                (try_begin),
                    (call_script, "script_cf_debug", debug_faction),
                    (assign, reg10, ":enemy_score"),
                    (str_store_faction_name, s10, ":faction_no"),
                    (str_store_faction_name, s11, ":enemy_faction"),
                    (display_message, "@{s10} seeks to degrade relations with {s11} ({reg10})"),
                (try_end),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction),
                (str_store_faction_name, s10, ":faction_no"),
                (assign, reg10, ":num_fiefs"),
                (assign, reg11, ":num_vassals"),
                (faction_get_slot, reg12, ":faction_no", slot_faction_war_damage),
                (display_message, "@{s10} size: - fiefs {reg10} - vassals {reg11} - war_damage {reg12}"),

                (assign, reg10, ":combined_defensive_strength"),
                (assign, reg11, ":combined_offensive_strength"),
                (assign, reg12, ":combined_offensive_ready_strength"),
                (assign, reg13, ":combined_threats_strength"),
                (display_message, "@{s10} strengths: - def {reg10} - off {reg11} - off ready {reg12} - threats {reg13}"),

                (assign, reg10, ":safety"),
                (display_message, "@{s10} safety: {reg10}"),

            (try_end),
        ]),

    # script_faction_get_declare_war_score
        # input:
        #   arg1: faction_no
        #   arg2: other_faction
        # output:
        #   reg0: score
    ("faction_get_declare_war_score",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_target", 2),

            (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":war_target"),
            (assign, ":relation", reg0),

            (store_sub, ":offset", ":war_target", kingdoms_begin),
            (store_add, ":distance_slot", ":offset", slot_faction_kingdom_distance_begin),
            (faction_get_slot, ":distance", ":faction_no", ":distance_slot"),

            (assign, ":score_ratio", 100),

            (assign, ":penalty_score", 0),

            (assign, ":relation_score", ":relation"),
            (try_begin),
                (ge, ":relation", relation_excellent),
                (assign, ":relation_score", 100),
            (else_try),
                (ge, ":relation", relation_friendly),
                (store_sub, ":relation_score", ":relation", relation_friendly),
                (val_div, ":relation_score", 2),
                (val_add, ":relation_score", 80),
            (else_try),
                (ge, ":relation", relation_positive),
                (store_sub, ":relation_score", ":relation", relation_positive),
                (val_mul, ":relation_score", 2),
                (val_add, ":relation_score", 40),
            (else_try),
                (ge, ":relation", relation_neutral),
                (store_mul, ":score_ratio", ":relation", 2),
            (try_end),

            (store_sub, ":score_ratio", ":relation_score", 100),
            (val_mul, ":score_ratio", -1),
            (val_clamp, ":score_ratio", 0, 201),

            (store_sub, ":distance_score", 150, ":distance"),
            (try_begin),
                (lt, ":distance_score", 0),
                # (assign, ":distance_score", ":distance_score"),
            (else_try),
                (lt, ":distance_score", 100),
                (val_mul, ":distance_score", ":distance_score"),
                (val_div, ":distance_score", 100),
            (try_end),

            (faction_get_slot, ":combined_offensive_strength", ":faction_no", slot_faction_strength_offensive_allies),

            (set_fixed_point_multiplier, 1),
            (faction_get_slot, ":war_target_strength", ":war_target", slot_faction_strength_defensive_allies),
            (faction_get_slot, ":war_target_war", ":war_target", slot_faction_is_at_war),
            (try_begin),
                (gt, ":war_target_war", 0),
                (lt, ":war_target_strength", ":combined_offensive_strength"),
                (store_sub, ":penalty_difference", ":combined_offensive_strength", ":war_target_strength"),
                (store_sqrt, ":penalty_score", ":penalty_difference"),
            (else_try),
                # Each war increases divider by 0.5
                (val_add, ":war_target_war", 2),
                (val_max, ":war_target_war", 1),
                (val_mul, ":war_target_strength", 2),
                (val_div, ":war_target_strength", ":war_target_war"),
            (try_end),

            (store_sub, ":strength_difference", ":combined_offensive_strength", ":war_target_strength"),
            (assign, ":strength_score", 0),

            (try_begin),
                (gt, ":strength_difference", 0),
                (store_sqrt, ":strength_score", ":strength_difference"),
                (store_sqrt, ":strength_score", ":strength_score"),
            (else_try),
                (store_mul, ":strength_score", ":strength_difference", -1),
                (store_sqrt, ":strength_score", ":strength_score"),
                (val_mul, ":strength_score", -1),
            (try_end),

            (store_add, ":score", ":strength_score", ":distance_score"),
            (val_sub, ":score", ":penalty_score"),

            (val_add, ":score", 500),
            (val_mul, ":score", ":score_ratio"),
            (val_div, ":score", 100),
            (val_add, ":score", -500),

            (call_script, "script_faction_get_war_damage_penalty_score", ":faction_no"),
            (assign, ":war_damage", reg0),

            (val_sub, ":score", ":war_damage"),

            (faction_get_slot, ":safety", ":faction_no", slot_faction_safety),
            (store_sub, ":inverse_safety", 100, ":safety"),
            (val_sub, ":score", ":inverse_safety"),

            (assign, ":other_relations_score", 0),
            (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":other_faction"),
                (assign, ":relation", reg0),
                (call_script, "script_faction_get_relation_with_faction", ":other_faction", ":war_target"),
                (assign, ":war_target_relation", reg0),

                (val_div, ":relation", 10),
                (val_div, ":war_target_relation", 10),
                (try_begin),
                    (neq, ":relation", 0),
                    (val_mul, ":war_target_relation", ":relation"),
                    (val_sub, ":other_relations_score", ":war_target_relation"),
                (try_end),

                (call_script, "script_faction_get_treaties", ":war_target", ":other_faction"),
                (assign, ":war_target_treaties", reg0),
                (call_script, "script_faction_get_treaties", ":faction_no", ":other_faction"),
                (assign, ":treaties", reg0),

                (val_and, ":treaties", sfkt_defensive_mask),
                (val_and, ":war_target_treaties", sfkt_defensive_mask),

                (try_begin),
                    (gt, ":treaties", 0),
                    (gt, ":war_target_treaties", 0),
                    (val_add, ":other_relations_score", -10000),
                (try_end),

                (try_begin),
                    (call_script, "script_cf_factions_are_at_war", ":other_faction", ":war_target"),
                    (gt, ":treaties", 0),
                    (val_add, ":other_relations_score", ":penalty_score"),
                (try_end),
            (try_end),

            (val_add, ":score", ":other_relations_score"),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction),
                (str_store_faction_name, s10, ":faction_no"),
                (str_store_faction_name, s11, ":war_target"),
                (assign, reg10, ":score"),
                (assign, reg11, ":score_ratio"),
                (assign, reg12, ":strength_score"),
                (assign, reg13, ":distance_score"),
                (assign, reg16, ":penalty_score"),
                (assign, reg14, ":war_damage"),
                (assign, reg15, ":inverse_safety"),
                (assign, reg17, ":other_relations_score"),
                (display_message, "@{s10} war score {s11}: {reg10} ({reg12} + {reg13} - {reg16} / {reg11}% - {reg14} - {reg15} + {reg17})"),
            (try_end),

            (assign, reg0, ":score"),
        ]),

    # script_faction_get_ally_score
        # input:
        #   arg1: faction_no
        #   arg2: other_faction
        # output:
        #   reg0: score
    ("faction_get_ally_score",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":other_faction", 2),

            (assign, ":score", 0),
            (try_begin),

                (neq, ":faction_no", ":other_faction"),
                (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":other_faction"),
                (assign, ":relation", reg0),

                (store_sub, ":offset", ":other_faction", kingdoms_begin),
                (store_add, ":distance_slot", ":offset", slot_faction_kingdom_distance_begin),
                (faction_get_slot, ":distance", ":faction_no", ":distance_slot"),

                (store_add, ":score_relation", 10, ":relation"),
                (val_div, ":score_relation", 2),

                (store_sub, ":distance_score", 150, ":distance"),
                (val_div, ":distance_score", 2),

                (faction_get_slot, ":combined_offensive_strength", ":faction_no", slot_faction_strength_offensive_allies),
                (faction_get_slot, ":other_faction_strength", ":other_faction", slot_faction_strength_offensive_allies),

                (faction_get_slot, ":faction_culture", ":faction_no", slot_faction_culture),
                (faction_get_slot, ":other_faction_culture", ":other_faction", slot_faction_culture),

                (assign, ":culture_bonus", 0),
                (try_begin),
                    (eq, ":faction_culture", ":other_faction_culture"),
                    (assign, ":culture_bonus", 10),
                (try_end),

                (call_script, "script_faction_get_treaties", ":faction_no", ":other_faction"),
                (assign, ":treaties", reg0),

                (store_and, ":truce", ":treaties", sfkt_truce),
                (store_and, ":non_aggression", ":treaties", sfkt_non_agression),
                (store_and, ":alliance", ":treaties", sfkt_alliance),
                (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
                (store_and, ":vassal", ":treaties", sfkt_vassal),
                (store_and, ":overlord", ":treaties", sfkt_overlord),

                (assign, ":treaties_score", 0),
                (try_begin),
                    (gt, ":truce", 0),
                    (val_add, ":treaties_score", -10),
                (else_try),
                    (gt, ":non_aggression", 0),
                    (val_add, ":treaties_score", 25),
                (else_try),
                    (gt, ":alliance", 0),
                    (val_add, ":treaties_score", -100),
                (else_try),
                    (gt, ":defensive", 0),
                    (val_add, ":treaties_score", -5),
                (else_try),
                    (gt, ":vassal", 0),
                    (val_add, ":treaties_score", -50),
                (else_try),
                    (gt, ":overlord", 0),
                    (val_add, ":treaties_score", -50),
                (try_end),

                # Factions prefer allies close to their own strength
                (assign, ":multiplier", 100),
                (try_begin),
                    (ge, ":combined_offensive_strength", ":other_faction_strength"),
                    (gt, ":combined_offensive_strength", 0),

                    (store_mul, ":multiplier", ":other_faction_strength", 200),
                    (val_div, ":multiplier", ":combined_offensive_strength"),
                (else_try),
                    (le, ":other_faction_strength", ":combined_offensive_strength"),
                    (gt, ":other_faction_strength", 0),

                    (store_mul, ":multiplier", ":combined_offensive_strength", 200),
                    (val_div, ":multiplier", ":other_faction_strength"),
                (try_end),
                (val_min, ":multiplier", 100),
                (val_max, ":multiplier", 0),

                (assign, ":strength_score", ":multiplier"),

                (store_add, ":score", ":distance_score", ":score_relation"),
                (val_add, ":score", ":culture_bonus"),
                (val_add, ":score", ":treaties_score"),
                (val_mul, ":score", ":strength_score"),
                (val_div, ":score", 100),

                (try_begin),
                    (call_script, "script_cf_debug", debug_faction),
                    (str_store_faction_name, s10, ":faction_no"),
                    (str_store_faction_name, s11, ":other_faction"),
                    (assign, reg10, ":score"),
                    (assign, reg11, ":distance_score"),
                    (assign, reg12, ":score_relation"),
                    (assign, reg13, ":strength_score"),
                    (display_message, "@{s10} ally score {s11}: {reg10} ({reg11} + {reg12}) x {reg13}%"),
                (try_end),

            (try_end),

            (assign, reg0, ":score"),
        ]),

    # script_faction_try_improve_relations
        # input:
        #   arg1: faction_no
        #   arg2: target_faction
        # output:
        #   reg0: relation_progress
    ("faction_try_improve_relations",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":target_faction", 2),

            # (faction_get_slot, ":safety", ":faction_no", slot_faction_safety),

            (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":target_faction"),
            (assign, ":relation", reg0),

            (call_script, "script_faction_get_treaties", ":faction_no", ":target_faction"),
            (assign, ":treaties", reg0),

            (store_and, ":truce", ":treaties", sfkt_truce),
            (store_and, ":non_aggression", ":treaties", sfkt_non_agression),
            (store_and, ":alliance", ":treaties", sfkt_alliance),
            (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
            (store_and, ":vassal", ":treaties", sfkt_vassal),
            (store_and, ":overlord", ":treaties", sfkt_overlord),

            (faction_get_slot, ":faction_leader", ":faction_no", slot_faction_leader),
            (faction_get_slot, ":target_leader", ":target_faction", slot_faction_leader),

            (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),

            (assign, ":proposed_treaty", sfkt_none),
            (try_begin),
                (this_or_next|gt, ":alliance", 0),
                (this_or_next|gt, ":truce", 0),
                (this_or_next|gt, ":vassal", 0),
                (gt, ":overlord", 0),
            (else_try),
                (eq, ":defensive", sfkt_defensive_alliance),
                (neq, ":alliance", sfkt_alliance),
                (gt, ":relation", 50),
                (assign, ":proposed_treaty", sfkt_alliance),
            (else_try),
                (eq, ":non_aggression", sfkt_non_agression),
                (neq, ":defensive", sfkt_defensive_alliance),
                (neq, ":alliance", sfkt_alliance),
                (gt, ":relation", 25),
                (assign, ":proposed_treaty", sfkt_defensive_alliance),
            (else_try),
                (neq, ":non_aggression", sfkt_non_agression),
                (neq, ":defensive", sfkt_defensive_alliance),
                (neq, ":alliance", sfkt_alliance),
                (gt, ":relation", 10),
                (assign, ":proposed_treaty", sfkt_non_agression),
            (try_end),

            (assign, ":relation_change", 0),

            (try_begin),
                (neq, ":proposed_treaty", sfkt_none),
                (eq, ":vassal_type", 0),

                (call_script, "script_faction_get_treaty_score", ":target_faction", ":proposed_treaty", ":faction_no"),
                (assign, ":result", reg0),
                (try_begin),
                    (gt, ":result", 0),
                    (call_script, "script_faction_create_treaty", ":faction_no", ":target_faction", ":proposed_treaty"),
                (else_try),
                    (call_script, "script_faction_relation_change_event", ":faction_no", ":target_faction", -relation_change_factor * 3),
                    (assign, ":relation_change", reg0),

                    (try_begin),
                        (ge, ":faction_leader", 0),
                        (ge, ":target_leader", 0),
                        (call_script, "script_troop_change_relation_with_troop", ":faction_leader", ":target_leader", -10),
                        (val_add, ":relation_change", -10),
                    (try_end),
                (try_end),
            (try_end),

            (store_random_in_range, ":outcome", 0, 10),
            (try_begin),
                (eq, ":outcome", 0),
                (call_script, "script_faction_relation_change_event", ":target_faction", ":faction_no", -relation_change_factor * 3),
                (val_add, ":relation_change", reg0),

                (try_begin),
                    (ge, ":faction_leader", 0),
                    (ge, ":target_leader", 0),
                    (call_script, "script_troop_change_relation_with_troop", ":faction_leader", ":target_leader", -6),
                    (val_add, ":relation_change", -6),
                (try_end),

                # Fail
            (else_try),
                (le, ":outcome", 5),
                # Success
                (call_script, "script_faction_relation_change_event", ":target_faction", ":faction_no", relation_change_factor * 2),
                (val_add, ":relation_change", reg0),

                (try_begin),
                    (ge, ":faction_leader", 0),
                    (ge, ":target_leader", 0),
                    (call_script, "script_troop_change_relation_with_troop", ":faction_leader", ":target_leader", 6),
                    (val_add, ":relation_change", 6),
                (try_end),
            # (else_try),
                # Neutral
            (try_end),

            (assign, ":total_cost", -5000),
            (call_script, "script_faction_add_accumulated_taxes", ":faction_no", ":total_cost", tax_type_expenses),

            (try_begin),
                (call_script, "script_cf_debug", debug_ai),
                (str_store_faction_name, s10, ":faction_no"),
                (str_store_faction_name, s11, ":target_faction"),
                (assign, reg10, ":relation_change"),
                (assign, reg11, ":relation"),
                (assign, reg12, ":proposed_treaty"),
                (display_message, "@{s10} improves relations with {s11} ({reg11} -> {reg10} : {reg12})"),
            (try_end),

            (assign, reg0, ":relation_change"),
        ]),

    # script_cf_faction_generate_faction_event
        # input:
        #   arg1: faction_no
        #   arg2: other_faction
        # output:
        #   fails if no event is generated
    ("cf_faction_generate_faction_event",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":other_faction", 2),

            (store_random_in_range, ":rand", 0, 100),

            (assign, ":event_generated", 0),

            # We want to be able to generate events for the faction leaders to react to
            # The player should be able to react to these events too

            (try_begin),
                (le, ":rand", 1),

                (call_script, "script_faction_relation_change_event", ":faction_no", ":other_faction", relation_change_factor),
                (assign, ":event_generated", 1),
            (else_try),
                (le, ":rand", 5), # We usually want negative events between factions to reduce overall relations

                (call_script, "script_faction_relation_change_event", ":faction_no", ":other_faction", -relation_change_factor),
                (assign, ":event_generated", 1),
            (try_end),

            (ge, ":event_generated", 1),
        ]),

    # script_faction_get_war_strengths
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: combined_defensive_strength
        #   reg1: combined_offensive_strength
        #   reg2: combined_offensive_ready_strength
        #   reg3: combined_threats_strength
        #   reg4: num_alliances
    ("faction_get_war_strengths",
        [
            (store_script_param, ":faction_no", 1),
            
            (faction_get_slot, ":strength_active", ":faction_no", slot_faction_strength_active),
            (faction_get_slot, ":strength_ready", ":faction_no", slot_faction_strength_ready),

            (assign, ":combined_defensive_strength", ":strength_active"),
            (assign, ":combined_offensive_strength", ":strength_active"),
            (assign, ":combined_offensive_ready_strength", ":strength_ready"),
            (assign, ":combined_threats_strength", 0),
            (assign, ":num_alliances", 0),

            (store_sub, ":distance_divider", faction_distance_far, faction_distance_close),

            (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                (neq, ":other_faction", ":faction_no"),
                (faction_get_slot, ":faction_status", ":other_faction", slot_faction_status),
                (neq, ":faction_status", sfst_disabled),

                (call_script, "script_faction_get_treaties", ":faction_no", ":other_faction"),
                (assign, ":treaties", reg0),

                (store_and, ":alliance", ":treaties", sfkt_alliance),
                (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
                (store_and, ":vassal", ":treaties", sfkt_vassal),
                (store_and, ":overlord", ":treaties", sfkt_overlord),
                (store_and, ":truce", ":treaties", sfkt_truce),
                (store_and, ":non_aggression", ":treaties", sfkt_non_agression),

                (faction_get_slot, ":other_strength_active", ":other_faction", slot_faction_strength_active),
                (faction_get_slot, ":other_strength_ready", ":other_faction", slot_faction_strength_ready),

                # We want to reduce strength of allies / enemies if they are far away
                (store_sub, ":offset", ":other_faction", kingdoms_begin),
                (store_add, ":distance_slot", ":offset", slot_faction_kingdom_distance_begin),
                (faction_get_slot, ":distance", ":faction_no", ":distance_slot"),
                (store_sub, ":distance_base", ":distance", faction_distance_close),

                (store_mul, ":distance_substracter", ":distance_base", 100),
                (val_div, ":distance_substracter", ":distance_divider"),

                (store_sub, ":distance_ratio", 100, ":distance_substracter"),

                (try_begin),
                    (val_mul, ":other_strength_active", ":distance_ratio"),
                    (val_mul, ":other_strength_ready", ":distance_ratio"),

                    (val_div, ":other_strength_active", 100),
                    (val_div, ":other_strength_ready", 100),

                    (val_max, ":other_strength_active", 0),
                    (val_max, ":other_strength_ready", 0),
                (try_end),

                (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":other_faction"),
                (assign, ":relation", reg0),

                (try_begin),
                    (gt, ":alliance", 0),
                    (val_add, ":combined_defensive_strength", ":other_strength_active"),
                    (val_add, ":combined_offensive_strength", ":other_strength_active"),
                    (val_add, ":combined_offensive_ready_strength", ":other_strength_ready"),
                    (val_add, ":num_alliances", 1),
                (else_try),
                    (gt, ":defensive", 0),
                    (val_add, ":combined_defensive_strength", ":other_strength_active"),
                    (val_add, ":num_alliances", 1),
                (else_try),
                    (gt, ":vassal", 0),
                    (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),

                    (store_and, ":is_sattrapy", ":vassal_type", sfvt_sattrapy),
                    (store_and, ":is_bulwark", ":vassal_type", sfvt_bulwark),

                    (try_begin),
                        (gt, ":is_sattrapy", 0),
                        (val_add, ":combined_offensive_strength", ":other_strength_active"),
                        (val_add, ":combined_offensive_ready_strength", ":other_strength_ready"),
                    (try_end),
                    (try_begin),
                        (gt, ":is_bulwark", 0),
                        (val_add, ":combined_defensive_strength", ":other_strength_active"),
                    (try_end),
                (else_try),
                    (gt, ":overlord", 0),
                    (faction_get_slot, ":vassal_type", ":other_faction", slot_faction_vassal_type),
                    (store_and, ":is_protectorate", ":vassal_type", sfvt_protectorate),

                    (try_begin),
                        (gt, ":is_protectorate", 0),
                        (val_add, ":combined_defensive_strength", ":other_strength_active"),
                    (try_end),
                (else_try),
                    (gt, ":truce", 0),
                    (val_add, ":combined_threats_strength", ":other_strength_active"),
                (else_try),
                    (gt, ":non_aggression", 0),
                (else_try),
                    (lt, ":relation", relation_friendly),
                    (store_mul, ":mult", ":relation", -1),
                    (val_add, ":mult", 50),
                    (val_max, ":mult", 10),
                    (val_min, ":mult", 150),
                    (val_mul, ":mult", 2),
                    (val_div, ":mult", 3),

                    (store_mul, ":added_strength", ":other_strength_active", ":mult"),
                    (val_div, ":added_strength", 100),
                    (val_add, ":combined_threats_strength", ":added_strength"),
                (try_end),
            (try_end),

            (assign, reg0, ":combined_defensive_strength"),
            (assign, reg1, ":combined_offensive_strength"),
            (assign, reg2, ":combined_offensive_ready_strength"),
            (assign, reg3, ":combined_threats_strength"),
            (assign, reg4, ":num_alliances"),
        ]),

    # script_faction_process_main_participant_war
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: willingness_score
    ("faction_process_main_participant_war",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (store_sub, ":own_offset", ":faction_no", kingdoms_begin),
            (store_add, ":participant_slot", ":own_offset", slot_war_kingdom_participant_begin),
            (faction_get_slot, ":faction_side", ":war_storage", ":participant_slot"),
            (val_min, ":faction_side", 1),
            (val_max, ":faction_side", -1),

            (assign, ":num_participants", 0),
            (assign, ":total_willingness", 0),
            (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                (store_sub, ":offset", ":other_faction", kingdoms_begin),
                (store_add, ":participant_slot", ":offset", slot_war_kingdom_participant_begin),
                (faction_get_slot, ":other_faction_side", ":war_storage", ":participant_slot"),
                (val_min, ":other_faction_side", 1),
                (val_max, ":other_faction_side", -1),

                (eq, ":other_faction_side", ":faction_side"),

                (faction_get_slot, ":faction_size", ":other_faction", slot_faction_size),

                (call_script, "script_faction_get_war_willingness", ":other_faction", ":war_storage"),
                (store_mul, ":score", reg0, ":faction_size"),

                (val_add, ":total_willingness", ":score"),
                (val_add, ":num_participants", ":faction_size"),
            (try_end),

            (assign, ":willingness", ":total_willingness"),
            (try_begin),
                (gt, ":num_participants", 1),
                (val_div, ":willingness", ":num_participants"),
            (try_end),

            (try_begin),
                (eq, ":faction_side", swkp_defender),
                (faction_set_slot, ":war_storage", slot_war_defender_willingness_score, ":willingness"),
            (else_try),
                (eq, ":faction_side", swkp_aggressor),
                (faction_set_slot, ":war_storage", slot_war_attacker_willingness_score, ":willingness"),
            (try_end),

            (try_begin),
                (le, ":willingness", -100),
                (call_script, "script_faction_propose_peace", ":faction_no", ":war_storage"),
            (try_end),

            (assign, reg0, ":willingness"),
        ]),

    # script_faction_propose_peace
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: peace_accepted
    ("faction_propose_peace",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (store_sub, ":offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),
            (faction_get_slot, ":faction_no_side", ":war_storage", ":slot"),
            (store_mul, ":other_faction_side", ":faction_no_side", -1),

            (assign, ":other_faction", -1),

            (assign, ":end", slot_war_kingdom_participant_end),
            (try_for_range, ":participant", slot_war_kingdom_participant_begin, ":end"),
                (faction_slot_eq, ":war_storage", ":participant", ":other_faction_side"),

                (store_sub, ":offset", ":participant", slot_war_kingdom_participant_begin),
                (store_add, ":other_faction", ":offset", kingdoms_begin),
                (assign, ":end", slot_war_kingdom_participant_begin),
            (try_end),

            (try_begin),
                (is_between, ":other_faction", kingdoms_begin, kingdoms_end),

                (try_begin),
                    (call_script, "script_cf_debug", debug_faction|debug_simple),
                    (str_store_faction_name, s10, ":faction_no"),
                    (str_store_faction_name, s11, ":other_faction"),
                    (display_message, "@{s10} propose peace with {s11}"),
                (try_end),

                (call_script, "script_faction_prepare_peace_proposal", ":faction_no", ":war_storage", ":other_faction"),
                (call_script, "script_faction_process_peace_proposal", ":other_faction", ":war_storage", ":faction_no"),
                (assign, ":result", reg0),
                (try_begin),
                    (eq, ":result", 1),
                    (call_script, "script_faction_make_peace_to_faction", ":faction_no", ":other_faction", ":war_storage"),
                    (call_script, "script_faction_apply_peace_proposal", ":other_faction", ":war_storage", ":faction_no"),
                    (call_script, "script_war_clean", ":war_storage"),
                    (call_script, "script_update_faction_war_count"),
                (else_try),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_faction|debug_simple),
                        (str_store_faction_name, s10, ":other_faction"),
                        (str_store_faction_name, s11, ":faction_no"),
                        (display_message, "@{s10} refuses peace with {s11}"),
                    (try_end),
                (try_end),
            (else_try),
                (assign, reg10, ":other_faction"),
                (display_message, "@Incorrect main faction {reg10}", text_color_debug),
            (try_end),
        ]),

    # script_faction_prepare_peace_proposal
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        #   arg3: faction_proposed_to
        # output: none
    ("faction_prepare_peace_proposal",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),
            (store_script_param, ":faction_proposed_to", 3),

            (call_script, "script_faction_get_war_score", ":faction_no", ":war_storage"),
            (assign, ":score", reg0),
            (val_abs, ":score"),

            (assign, ":offset_begin", 0),

            (try_begin),
                (call_script, "script_cf_faction_want_vassal", ":faction_proposed_to", ":faction_no"),

                (faction_get_slot, ":num_fiefs", ":faction_no", slot_faction_num_walled_fiefs),
                (faction_get_slot, ":vassal_score", ":faction_no", slot_faction_size),
                (try_begin),
                    (gt, ":num_fiefs", 0),
                    (val_mul, ":vassal_score", ":num_fiefs"),
                (try_end),
                (val_mul, ":vassal_score", 10),
                (try_begin),
                    (call_script, "script_cf_debug", debug_war),
                    (str_store_faction_name, s10, ":faction_no"),

                    (assign, reg10, ":vassal_score"),
                    (assign, reg11, ":num_fiefs"),
                    (display_message, "@{s10} vassal score : {reg10} - num fiefs {reg11}"),
                (try_end),
                (ge, ":score", ":vassal_score"),

                (val_sub, ":score", ":vassal_score"),

                (store_add, ":slot_object", slot_war_peace_proposal_object_begin, ":offset_begin"),
                (store_add, ":slot_type", slot_war_peace_proposal_type_begin, ":offset_begin"),
                (store_add, ":slot_target", slot_war_peace_proposal_target_begin, ":offset_begin"),

                (faction_set_slot, ":war_storage", ":slot_object", ":faction_no"),
                (faction_set_slot, ":war_storage", ":slot_type", wppt_vassalize),
                (faction_set_slot, ":war_storage", ":slot_target", ":faction_proposed_to"),

                (val_add, ":offset_begin", 1),
            (try_end),

            (assign, ":end", num_peace_proposal),
            (assign, ":total_centers", 1),
            (assign, ":capture_score", 0),
            (assign, ":begin", ":offset_begin"),
            (try_for_range, ":offset", ":begin", ":end"),
                (assign, ":best_score", 9999),
                (assign, ":best_center", -1),
                (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
                    (party_get_slot, ":temp_score", ":center_no", slot_party_temp),
                    (lt, ":temp_score", ":best_score"),
                    (assign, ":best_score", ":temp_score"),
                    (assign, ":best_center", ":center_no"),
                (try_end),
                (try_begin),
                    (gt, ":best_center", 0),

                    (assign, ":base_score", 0),
                    (party_get_slot, ":party_type", ":best_center", slot_party_type),
                    (try_begin),
                        (eq, ":party_type", spt_village),
                        (assign, ":base_score", proposal_peace_score_village_captured),
                    (else_try),
                        (eq, ":party_type", spt_castle),
                        (assign, ":base_score", proposal_peace_score_castle_captured),
                    (else_try),
                        (eq, ":party_type", spt_town),
                        (assign, ":base_score", proposal_peace_score_town_captured),
                    (try_end),

                    (store_add, ":total_score", ":capture_score", ":base_score"),

                    (val_mul, ":total_score", ":total_centers"),
                    (try_begin),
                        (le, ":total_score", ":score"),

                        (val_add, ":capture_score", ":base_score"),
                        (val_add, ":total_centers", 1),

                        (store_add, ":slot_object", slot_war_peace_proposal_object_begin, ":offset"),
                        (store_add, ":slot_type", slot_war_peace_proposal_type_begin, ":offset"),
                        (store_add, ":slot_target", slot_war_peace_proposal_target_begin, ":offset"),

                        (store_faction_of_party, ":center_current_faction", ":best_center"),

                        (faction_set_slot, ":war_storage", ":slot_object", ":best_center"),
                        (faction_set_slot, ":war_storage", ":slot_type", wppt_transfer_center),
                        (faction_set_slot, ":war_storage", ":slot_target", ":center_current_faction"),

                        (party_set_slot, ":best_center", slot_party_temp, 9999),

                        (val_add, ":offset", 1),
                    (else_try),
                        (assign, ":end", 0),
                    (try_end),
                (try_end),
            (try_end),
            (val_sub, ":total_centers", 1),
            (store_mul, ":remove_score", ":capture_score", ":total_centers"),
            (val_sub, ":score", ":remove_score"),

            (try_begin),
                (gt, ":score", 0),
                # (val_add, ":offset", 1),

                (store_add, ":slot_object", slot_war_peace_proposal_object_begin, ":offset"),
                (store_add, ":slot_type", slot_war_peace_proposal_type_begin, ":offset"),
                (store_add, ":slot_target", slot_war_peace_proposal_target_begin, ":offset"),
                (store_add, ":slot_value", slot_war_peace_proposal_value_begin, ":offset"),

                (faction_set_slot, ":war_storage", ":slot_object", ":faction_no"),
                (faction_set_slot, ":war_storage", ":slot_type", wppt_tribute),
                (faction_set_slot, ":war_storage", ":slot_target", ":faction_proposed_to"),
                (faction_set_slot, ":war_storage", ":slot_value", ":score"),
            (try_end),
        ]),

    # script_faction_get_war_score
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: score
    ("faction_get_war_score",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (assign, ":score", proposal_peace_base_score),

            # We check captured centers
            (try_for_range, ":center_no", centers_begin, centers_end),
                (party_set_slot, ":center_no", slot_party_temp, 9999),

                (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                (store_faction_of_party, ":current_faction", ":center_no"),
                (neq, ":center_faction", ":current_faction"),

                (call_script, "script_faction_is_war_participant", ":current_faction", ":war_storage"),
                (assign, ":current_faction_side", reg0),
                (call_script, "script_faction_is_war_participant", ":center_faction", ":war_storage"),
                (assign, ":center_faction_side", reg0),

                (assign, ":continue", 0),
                (assign, ":score_multiplier", 0),
                (try_begin),
                    (gt, ":current_faction_side", swkp_bystander),
                    (lt, ":center_faction_side", swkp_bystander),
                    (assign, ":continue", 1),
                    (assign, ":score_multiplier", 1),
                (else_try),
                    (lt, ":current_faction_side", swkp_bystander),
                    (gt, ":center_faction_side", swkp_bystander),
                    (assign, ":continue", 1),
                    (assign, ":score_multiplier", -1),
                (try_end),

                (assign, ":base_score", 0),
                (party_get_slot, ":party_type", ":center_no", slot_party_type),
                (try_begin),
                    (eq, ":party_type", spt_village),
                    (assign, ":base_score", proposal_peace_score_village_captured),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (assign, ":base_score", proposal_peace_score_castle_captured),
                (else_try),
                    (eq, ":party_type", spt_town),
                    (assign, ":base_score", proposal_peace_score_town_captured),
                (try_end),

                (store_mul, ":center_score", ":base_score", ":score_multiplier"),

                (eq, ":continue", 1),

                (val_add, ":score", ":center_score"),

                (call_script, "script_faction_get_center_interest", ":current_faction", ":center_no"),
                (party_set_slot, ":center_no", slot_party_temp, reg0),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_faction_name, s10, ":faction_no"),
                (assign, reg10, ":score"),
                (display_message, "@{s10} generates peace proposal for {reg10} score"),
            (try_end),
            (assign, reg0, ":score"),
        ]),

    # script_faction_is_war_participant
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: war_participant
    ("faction_is_war_participant",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (store_sub, ":faction_offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":faction_offset", slot_war_kingdom_participant_begin),

            (faction_get_slot, ":participant", ":war_storage", ":slot"),
            (assign, reg0, ":participant"),
        ]),

    # script_cf_factions_are_at_war
        # input:
        #   arg1: faction_no
        #   arg2: target_faction
        # output:
        #   reg0: war_storage
        #   fails if no war found
    ("cf_factions_are_at_war",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":target_faction", 2),

            (assign, ":current_war", -1),
            (assign, ":end", war_storages_end),
            (try_for_range, ":war_storage", war_storages_begin, ":end"),
                (faction_slot_eq, ":war_storage", slot_war_active, 1),
                (faction_slot_eq, ":war_storage", slot_war_ended, 0),
                (call_script, "script_faction_is_war_participant", ":faction_no", ":war_storage"),
                (assign, ":faction_participant", reg0),
                (call_script, "script_faction_is_war_participant", ":target_faction", ":war_storage"),
                (assign, ":target_participant", reg0),

                (try_begin),
                    (gt, ":faction_participant", swkp_bystander),
                    (lt, ":target_participant", swkp_bystander),

                    (assign, ":current_war", ":war_storage"),
                    (assign, ":end", war_storages_begin),
                (else_try),
                    (lt, ":faction_participant", swkp_bystander),
                    (gt, ":target_participant", swkp_bystander),

                    (assign, ":current_war", ":war_storage"),
                    (assign, ":end", war_storages_begin),
                (try_end),
            (try_end),

            (assign, reg0, ":current_war"),
            (is_between, ":current_war", war_storages_begin, war_storages_end),
        ]),

    # script_cf_faction_is_at_war
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: war_storage
        #   fails if no war found
    ("cf_faction_is_at_war",
        [
            (store_script_param, ":faction_no", 1),

            (assign, ":current_war", -1),
            (assign, ":end", war_storages_end),
            (try_for_range, ":war_storage", war_storages_begin, ":end"),
                (faction_slot_eq, ":war_storage", slot_war_active, 1),
                (faction_slot_eq, ":war_storage", slot_war_ended, 0),
                (call_script, "script_faction_is_war_participant", ":faction_no", ":war_storage"),
                (assign, ":faction_participant", reg0),

                (try_begin),
                    (neq, ":faction_participant", swkp_bystander),

                    (assign, ":current_war", ":war_storage"),
                    (assign, ":end", war_storages_begin),
                (try_end),
            (try_end),

            (assign, reg0, ":current_war"),
            (is_between, ":current_war", war_storages_begin, war_storages_end),
        ]),

    # script_faction_process_peace_proposal
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        #   arg3: faction_proposer
        # output:
        #   reg0: result
    ("faction_process_peace_proposal",
        [
            # (store_script_param, ":faction_no", 1),
            # (store_script_param, ":war_storage", 2),
            # (store_script_param, ":faction_proposer", 3),

            # TODO: add peace proposal processing
            # For now we always accept
            (assign, reg0, 1),
        ]),

    # script_faction_apply_peace_proposal
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        #   arg3: faction_proposer
        # output: none
    ("faction_apply_peace_proposal",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),
            # (store_script_param, ":faction_proposer", 3),

            (assign, ":end", num_peace_proposal),
            (try_for_range, ":offset", 0, ":end"),
                (store_add, ":slot_object", slot_war_peace_proposal_object_begin, ":offset"),
                (store_add, ":slot_type", slot_war_peace_proposal_type_begin, ":offset"),
                (store_add, ":slot_target", slot_war_peace_proposal_target_begin, ":offset"),
                (store_add, ":slot_value", slot_war_peace_proposal_value_begin, ":offset"),
                        
                (faction_get_slot, ":object", ":war_storage", ":slot_object"),
                (faction_get_slot, ":type", ":war_storage", ":slot_type"),
                (faction_get_slot, ":target", ":war_storage", ":slot_target"),
                (faction_get_slot, ":value", ":war_storage", ":slot_value"),

                (try_begin),
                    (le, ":type", 0),
                    (assign, ":end", 0),
                (else_try),
                    (try_begin),
                        (eq, ":type", wppt_transfer_center),

                        (call_script, "script_center_change_faction", ":object", ":target", 1),

                        (try_begin),
                            (call_script, "script_cf_debug", debug_war),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_party_name, s11, ":object"),
                            (assign, reg10, ":type"),
                            (str_store_faction_name, s12, ":target"),
                            (display_message, "@{s10} process proposal transfer center for {s11} {reg10} {s12}"),
                        (try_end),
                    (else_try),
                        (eq, ":type", wppt_liberate_center),

                        (str_store_faction_name, s10, ":faction_no"),
                        (str_store_party_name, s11, ":object"),
                        (assign, reg10, ":type"),
                        (str_store_faction_name, s12, ":target"),
                        (display_message, "@{s10} process proposal liberate center for {s11} {reg10} {s12}"),
                    (else_try),
                        (eq, ":type", wppt_vassalize),

                        (call_script, "script_faction_create_vassal", ":target", ":object", sfvt_default_vassal_type, ":war_storage"),

                        (try_begin),
                            (call_script, "script_cf_debug", debug_war),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":object"),
                            (assign, reg10, ":type"),
                            (str_store_faction_name, s12, ":target"),
                            (display_message, "@{s10} process proposal vassalize for {s11} {reg10} {s12}"),
                        (try_end),
                    (else_try),
                        (eq, ":type", wppt_tribute),

                        (call_script, "script_faction_create_tribute", ":object", ":target", ":value", ":war_storage"),

                        (try_begin),
                            (call_script, "script_cf_debug", debug_war|debug_economy),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":object"),
                            (assign, reg11, ":value"),
                            (assign, reg10, ":type"),
                            (str_store_faction_name, s12, ":target"),
                            (display_message, "@{s10} process proposal tribute for {s11} {reg10} {s12} : {reg11} value"),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # script_cf_faction_want_vassal
        # input:
        #   arg1: faction_no
        #   arg2: vassalized_faction
        # output: none
        # fails if faction does not want vassal
    ("cf_faction_want_vassal",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":vassalized_faction", 2),

            (faction_get_slot, ":is_vassal", ":vassalized_faction", slot_faction_vassal_type),
            (eq, ":is_vassal", 0),

            (faction_get_slot, ":faction_size", ":faction_no", slot_faction_size),
            (faction_get_slot, ":vassal_size", ":vassalized_faction", slot_faction_size),

            (val_div, ":faction_size", 2),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_faction_name, s10, ":faction_no"),
                (str_store_faction_name, s11, ":vassalized_faction"),

                (assign, reg10, ":faction_size"),
                (assign, reg11, ":vassal_size"),
                (display_message, "@{s10} wants {s11} as vassal : {reg10} {reg11}"),
            (try_end),

            (gt, ":faction_size", ":vassal_size"),
        ]),

    # script_faction_get_treaty_score
        # input:
        #   arg1: faction_no
        #   arg2: treaty_type
        #   arg3: treaty_target
        # output:
        #   reg0: acceptance_score
        #   reg1: proposition_score
    ("faction_get_treaty_score",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":treaty_type", 2),
            (store_script_param, ":treaty_target", 3),

            (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),

            (try_begin),
                (neq, ":vassal_type", 0),

                # Vassals can engage in treaties except trading
                (neq, ":treaty_type", sfkt_open_trade),

                (assign, reg0, 0),
                (assign, reg1, 0),
            (else_try),
                (call_script, "script_cf_factions_are_at_war", ":faction_no", ":treaty_target"),

                (neq, ":treaty_type", sfkt_truce),

                (assign, reg0, 0),
                (assign, reg1, 0),
            (else_try),
                (eq, ":treaty_type", sfkt_overlord),
                # Become vassal of the target
                (faction_get_slot, ":own_strength", ":faction_no", slot_faction_strength_defensive_allies),
                (faction_get_slot, ":target_strength", ":treaty_target", slot_faction_strength_offensive_allies),

                (store_div, ":min_strength", ":target_strength", 5),

                (call_script, "script_faction_get_relation_with_faction", ":faction_no", ":treaty_target"),
                (store_mul, ":relation_bonus", reg0, 100),
                (store_sub, ":total_strength", ":own_strength", ":relation_bonus"),

                (store_sub, ":offset", ":treaty_target", kingdoms_begin),
                (store_add, ":distance_slot", ":offset", slot_faction_kingdom_distance_begin),
                (faction_get_slot, ":distance", ":faction_no", ":distance_slot"),
                (val_mul, ":distance", 250),
                (val_add, ":total_strength", ":distance"),

                (try_begin),
                    (call_script, "script_cf_debug", debug_faction),
                    (str_store_faction_name, s10, ":treaty_target"),
                    (str_store_faction_name, s11, ":faction_no"),
                    (assign, reg10, ":min_strength"),
                    (assign, reg11, ":total_strength"),
                    (assign, reg12, ":own_strength"),
                    (assign, reg13, ":relation_bonus"),
                    (assign, reg14, ":distance"),
                    (display_message, "@{s10} asks for vassal {s11}: {reg10}>{reg11}={reg12}-{reg13}+{reg14}"),
                (try_end),

                (try_begin),
                    (gt, ":min_strength", ":total_strength"),

                    (faction_get_slot, ":own_wars", ":faction_no", slot_faction_is_at_war),
                    (eq, ":own_wars", 0),

                    (assign, reg0, 1),
                    (assign, reg1, 0),
                (else_try),
                    (assign, reg0, 0),
                    (assign, reg1, 0),
                (try_end),

            (else_try),
                (assign, reg0, 1),
                (assign, reg1, 1),
            (try_end),

        ]),

    # script_faction_get_war_declaration_score
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: score
    ("faction_get_war_declaration_score",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (assign, ":total_centers", 0),
            (assign, ":occupied_centers", 0),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            (faction_get_slot, ":war_start", ":war_storage", slot_war_start_date),

            (store_sub, ":time_at_war", ":current_day", ":war_start"),
            (val_div, ":time_at_war", 200),

            (try_for_range, ":center_no", walled_centers_begin, walled_centers_end),
                (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                (eq, ":center_faction", ":faction_no"),
                (store_faction_of_party, ":current_faction", ":center_no"),

                (val_add, ":total_centers", 1),
                (try_begin),
                    (neq, ":center_faction", ":current_faction"),
                    (val_add, ":occupied_centers", 1),
                (try_end),
            (try_end),

            (store_sub, ":unoccupied_centers", ":total_centers", ":occupied_centers"),
            (store_mul, ":ratio", ":unoccupied_centers", 100),

            (faction_get_slot, ":strength", ":faction_no", slot_faction_strength_active),
            (faction_get_slot, ":strength_ready", ":faction_no", slot_faction_strength_ready),
            (val_add, ":strength", ":strength_ready"),
            (val_div, ":strength", 1500),

            (faction_get_slot, ":war_damage", ":faction_no", slot_faction_war_damage),

            (try_begin),
                (gt, ":total_centers", 0),
                (val_div, ":ratio", ":total_centers"),
                (val_div, ":strength", ":total_centers"),
            (try_end),

            (val_min, ":strength", 100),

            # score goes from -100 to 0
            (val_sub, ":ratio", 100),

            (call_script, "script_faction_get_war_damage_penalty_score", ":faction_no"),
            (assign, ":war_damage", reg0),

            (store_add, ":final_ratio", ":ratio"),
            (val_add, ":final_ratio", ":strength"),
            (val_sub, ":final_ratio", ":war_damage"),
            (val_sub, ":final_ratio", ":time_at_war"),

            (val_max, ":final_ratio", -100),
            (val_min, ":final_ratio", 100),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_faction_name, s10, ":faction_no"),
                (str_store_faction_name, s11, ":war_storage"),

                (assign, reg10, ":final_ratio"),
                (assign, reg11, ":ratio"),
                (assign, reg12, ":strength"),
                (assign, reg13, ":war_damage"),
                (assign, reg14, ":time_at_war"),

                (display_message, "@{s10} war score: {s11} / {reg10} = {reg11} + {reg12} - {reg13} - {reg14}"),
            (try_end),

            (assign, reg0, ":final_ratio"),
        ]),

    # script_faction_get_relation_with_faction
        # input:
        #   arg1: faction_no
        #   arg2: target_faction
        # output:
        #   reg0: relation
    ("faction_get_relation_with_faction",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":target_faction", 2),

            (store_sub, ":target_faction_offset", ":target_faction", kingdoms_begin),
            (store_add, ":target_faction_relation_slot", ":target_faction_offset", slot_faction_kingdom_relation_begin),
            (faction_get_slot, ":base_relation", ":faction_no", ":target_faction_relation_slot"),

            # (store_sub, ":faction_offset", ":faction_no", kingdoms_begin),
            # (store_add, ":faction_relation_slot", ":faction_offset", slot_faction_kingdom_relation_begin),
            # (faction_get_slot, ":target_base_relation", ":target_faction", ":faction_relation_slot"),

            # (val_add, ":base_relation", ":target_base_relation"),
            # (val_div, ":base_relation", 2),
            (val_mul, ":base_relation", relation_weight_faction),

            (assign, ":base_relation_weight", relation_weight_faction),

            (faction_get_slot, ":faction_leader", ":faction_no", slot_faction_leader),
            (faction_get_slot, ":target_faction_leader", ":target_faction", slot_faction_leader),

            (assign, ":relation", ":base_relation"),

            (assign, ":relation_weight", ":base_relation_weight"),
            (try_begin),
                (ge, ":faction_leader", 0),
                (ge, ":target_faction_leader", 0),

                (troop_slot_eq, ":faction_leader", slot_troop_kingdom_occupation, tko_kingdom_hero),
                (troop_slot_eq, ":target_faction_leader", slot_troop_kingdom_occupation, tko_kingdom_hero),

                (call_script, "script_troop_get_relation_with_troop", ":faction_leader", ":target_faction_leader"),
                (assign, ":leader_relation", reg0),
                (val_mul, ":leader_relation", relation_weight_leader),

                (val_add, ":relation", ":leader_relation"),
                (val_add, ":relation_weight", relation_weight_leader),
            (try_end),
            (val_div, ":relation", ":relation_weight"),
            (assign, reg0, ":relation"),
        ]),

    # script_faction_set_relation_with_faction
        # input:
        #   arg1: faction_no
        #   arg2: target_faction
        #   arg3: relation
        # output: none
    ("faction_set_relation_with_faction",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":target_faction", 2),
            (store_script_param, ":relation", 3),

            (store_sub, ":target_faction_offset", ":target_faction", kingdoms_begin),
            (store_add, ":faction_relation_slot", ":target_faction_offset", slot_faction_kingdom_relation_begin),
            (faction_set_slot, ":faction_no", ":faction_relation_slot", ":relation"),
        ]),

    # script_party_get_size
        # input:
        #   arg1: party_no
        # output:
        #   reg0: size
    ("party_get_size",
        [
            (store_script_param, ":party_no", 1),

            (assign, ":size", 0),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (try_begin),
                (eq, ":party_type", spt_village),
                (assign, ":size", center_size_village),
            (else_try),
                (eq, ":party_type", spt_castle),
                (assign, ":size", center_size_castle),
            (else_try),
                (eq, ":party_type", spt_town),
                (assign, ":size", center_size_town),
            (try_end),

            (assign, reg0, ":size"),
        ]),

    # script_faction_get_current_war
        # input:
        #   arg1: faction_no
        #   arg2: other_faction
        # output:
        #   reg0: war_storage
    ("faction_get_current_war",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":other_faction", 2),

            (assign, ":war_storage", -1),

            (assign, ":end", war_storages_end),
            (try_for_range, ":storage_no", war_storages_begin, ":end"),
                (store_sub, ":offset", ":faction_no", kingdoms_begin),
                (store_sub, ":other_offset", ":other_faction", kingdoms_begin),

                (store_add, ":slot", ":offset", slot_war_kingdom_participant_begin),
                (store_add, ":other_slot", ":other_offset", slot_war_kingdom_participant_begin),

                (faction_get_slot, ":participant", ":storage_no", ":slot"),
                (faction_get_slot, ":other_participant", ":storage_no", ":other_slot"),

                (try_begin),
                    (eq, ":participant", swkp_main_defender),
                    (eq, ":other_participant", swkp_main_aggressor),

                    (assign, ":war_storage", ":storage_no"),
                    (assign, ":end", 0), # Here we end the search because we prioritise taking the main war
                (else_try),
                    (eq, ":participant", swkp_main_aggressor),
                    (eq, ":other_participant", swkp_main_defender),

                    (assign, ":war_storage", ":storage_no"),
                    (assign, ":end", 0), # Here we end the search because we prioritise taking the main war
                (else_try),
                    (le, ":participant", swkp_defender),
                    (ge, ":other_participant", swkp_aggressor),

                    (assign, ":war_storage", ":storage_no"),
                (else_try),
                    (le, ":other_participant", swkp_defender),
                    (ge, ":participant", swkp_aggressor),

                    (assign, ":war_storage", ":storage_no"),
                (try_end),
            (try_end),

            (assign, reg0, ":war_storage"),
        ]),

    # script_faction_set_war_willingness
        # input:
        #   arg1: faction_no
        #   arg3: war_storage
        #   arg3: score (-100 -> 100)
        # output: none
    ("faction_set_war_willingness",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),
            (store_script_param, ":score", 3),

            (store_sub, ":offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":offset", slot_war_kingdom_willingness_begin),
            (faction_set_slot, ":war_storage", ":slot", ":score"),
        ]),

    # script_faction_get_war_willingness_category
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: willingness
    ("faction_get_war_willingness_category",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (call_script, "script_faction_get_war_willingness", ":faction_no", ":war_storage"),
            (assign, ":score", reg0),

            (assign, ":willingness", 0),
            (try_begin),
                (lt, ":score", -50),
                (assign, ":willingness", kw_desperate),
            (else_try),
                (lt, ":score", 0),
                (assign, ":willingness", kw_failling),
            (else_try),
                (gt, ":score", 50),
                (assign, ":willingness", kw_eager),
            (else_try),
                # (ge, ":score", 0),
                (assign, ":willingness", kw_neutral),
            (try_end),
            (assign, reg0, ":willingness"),
        ]),

    # script_faction_get_war_willingness
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        # output:
        #   reg0: willingness
    ("faction_get_war_willingness",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),

            (store_sub, ":offset", ":faction_no", kingdoms_begin),
            (store_add, ":slot", ":offset", slot_war_kingdom_willingness_begin),
            (faction_get_slot, reg0, ":war_storage", ":slot"),
        ]),

    # script_faction_get_strength
        # input: 
        #   arg1: faction_no
        # output:
        #   reg0: faction_strength
    ("faction_get_strength",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":strength", ":faction_no", slot_faction_strength_ready),
            (assign, reg0, ":strength"),
        ]),
    
    # script_troop_get_title_string
        # input: 
        #   arg1: troop_no
        # output:
        #   str0: title
    ("troop_get_title_string",
        [
            (store_script_param, ":troop_no", 1),
            (assign, reg10, 0), # Num titles
            
            (str_clear, s10),
            
            (store_troop_faction, ":troop_faction", ":troop_no"),
            (try_begin),
                (faction_slot_eq, ":troop_faction", slot_faction_leader, ":troop_no"),
                (str_store_faction_name, s11, ":troop_faction"),
                (str_store_string, s10, "@Ruler of the {s11}"),
                (val_add, reg10, 2),
            (try_end),
            
            (call_script, "script_troop_get_current_home", ":troop_no", 0),
            (assign, ":home", reg0),
            (try_begin),
                (is_between, ":home", centers_begin, centers_end),
                (party_slot_eq, ":home", slot_party_lord, ":troop_no"),
                (troop_get_type, reg11, ":troop_no"),
                (str_store_party_name, s11, ":home"),
                (str_store_string, s10, "@{s10}{reg10?, l:L}{reg11?ady:ord} of {s11}"),
                (try_begin),
                    (is_between, ":home", walled_centers_begin, walled_centers_end),
                    (val_add, reg10, 2),
                (else_try),
                    (val_add, reg10, 1),
                (try_end),
            (try_end),
            
            (try_begin),
                (le, reg10, 1),
                (troop_get_slot, ":lord", ":troop_no", slot_troop_vassal_of),
                (ge, ":lord", 0),
                (str_store_troop_name, s11, ":lord"),
                (str_store_string, s10, "@{s10}{reg10?, v:V}assal of {s11}"),
                (val_add, reg10, 2),
            (try_end),
            
            (try_begin),
                (le, reg10, 1),
                (str_store_faction_name, s11, ":troop_faction"),
                (str_store_string, s10, "@{s10}{reg10?, v:V}assal for the {s11}"),
                (val_add, reg10, 2),
            (try_end),
            
            # Family strings (son/daughter of, wife/husband of, father/mother of) -- only important persons!
            
            # Some important traits (self imposed?)
            
            (str_store_string_reg, s0, s10),
        ]),
    
    # script_party_besiege_party
        # input:
        #   arg1: attacker
        #   arg2: besieged
        # output: none
    ("party_besiege_party",
        [
            (store_script_param, ":attacker", 1),
            (store_script_param, ":besieged", 2),
            
            (party_set_slot, ":besieged", slot_party_besieged_by, ":attacker"),
            
            (call_script, "script_party_update_extra_text", ":besieged"),
            
            (str_store_party_name_link, s10, ":besieged"),
            (try_begin),
                (party_get_slot, ":leader", ":attacker", slot_party_leader),
                (ge, ":leader", 0),
                (str_store_troop_name_link, s11, ":leader"),
                (display_log_message, "@{s10} is been besieged by {s11}"),
            (else_try),
                (display_log_message, "@{s10} is been besieged"),
            (try_end),
            
            (party_get_slot, ":besieged_lord", ":besieged", slot_party_lord),
            (try_begin),
                (gt, ":besieged_lord", 0),
                (troop_get_slot, ":besieged_lord_party", ":besieged_lord", slot_troop_leaded_party),
                (gt, ":besieged_lord_party", 0),
                (call_script, "script_party_process_mission", ":besieged_lord_party", 1),
            (try_end),
        ]),
    
    # script_party_lift_siege
        # input:
        #   arg1: besieged_party
        # output: none
    ("party_lift_siege",
        [
            (store_script_param, ":party_no", 1),
            
            (party_set_slot, ":party_no", slot_party_besieged_by, -1),
            
            (call_script, "script_party_update_extra_text", ":party_no"),
            
            (str_store_party_name_link, s10, ":party_no"),
            (display_log_message, "@{s10} is no longer under siege"),
        ]),

    # script_party_update_extra_text
        # input:
        #   arg1: party_no
        # output: none
    ("party_update_extra_text",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (is_between, ":party_type", spt_village, spt_fort),
                (try_begin),
                    (party_get_slot, ":besieger", ":party_no", slot_party_besieged_by),
                    (ge, ":besieger", 0),

                    (party_set_extra_text, ":party_no", "@Under siege"),
                (else_try),
                    (party_get_slot, ":party_faction", ":party_no", slot_party_faction),
                    (store_faction_of_party, ":current_faction", ":party_no"),
                    (neq, ":party_faction", ":current_faction"),

                    (str_store_faction_name, s11, ":party_faction"),
                    (str_store_string, s10, "@Occupied from {s11}"),
                    (party_set_extra_text, ":party_no", s10),
                (else_try),
                    (party_set_extra_text, ":party_no", "str_empty_string"),
                (try_end),
            (try_end),
        ]),
    
    # script_party_defeat_center
        # input:
        #   arg1: party_no
        #   arg2: center_captured
        # output: none
    ("party_defeat_center",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":center_no", 2),
            
            (store_faction_of_party, ":party_faction", ":party_no"),
            # (store_faction_of_party, ":old_center_faction", ":center_no"),
            (party_get_slot, ":center_owner_faction", ":center_no", slot_party_faction),
            
            # Does not capture attached parties
            # (party_get_num_attached_parties, ":num_attached", ":center_no"),
            # (try_for_range, ":rank_no", 0, ":num_attached"),
            #     (party_get_attached_party_with_rank, ":attached_party", ":center_no", ":rank_no"),
            #     (party_detach, ":attached_party"),
            # (try_end),
            
            (try_begin),
                (party_slot_ge, ":center_no", slot_party_besieged_by, 0),
                (call_script, "script_party_lift_siege", ":center_no"),
            (try_end),

            (try_begin),
                (store_relation, ":relation", ":party_faction", ":center_owner_faction"),
                (ge, ":relation", 0),
                (call_script, "script_party_free_center", ":party_no", ":center_no"),
            (else_try),
                (call_script, "script_party_capture_center", ":party_no", ":center_no"),
            (try_end),
        ]),
    
    # script_party_free_center
        # input:
        #   arg1: party_no
        #   arg2: center_freed
        # output: none
    ("party_free_center",
        [
            # (store_script_param, ":party_no", 1),
            (store_script_param, ":center_no", 2),

            (party_get_slot, ":center_owner_faction", ":center_no", slot_party_faction),
            (store_faction_of_party, ":old_center_faction", ":center_no"),
            
            (call_script, "script_center_change_current_faction", ":center_no", ":center_owner_faction", ":old_center_faction"),
        ]),
    
    # script_party_capture_center
    # inout:
    #   arg1: party_no
    #   arg2: center_captured
    # output: none
    ("party_capture_center",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":center_no", 2),
            
            (store_faction_of_party, ":party_faction", ":party_no"),
            (store_faction_of_party, ":old_center_faction", ":center_no"),
            

            (call_script, "script_center_change_current_faction", ":center_no", ":party_faction", ":old_center_faction"),
        ]),

    # script_get_faction_size_from_weight
        # input:
        #   arg1: weight (center_size_*)
        # output:
        #   reg0: faction_size (sfs_)
    ("get_faction_size_from_weight",
        [
            (store_script_param, ":weight", 1),

            (assign, ":size", sfs_small),
            (try_begin),
                (ge, ":weight", 20),
                (assign, ":size", sfs_large),
            (else_try),
                (ge, ":weight", 10),
                (assign, ":size", sfs_medium),
            (try_end),

            (assign, reg0, ":size"),
        ]),

    # script_center_change_current_faction
        # input:
        #   arg1: center_no
        #   arg2: new_faction
        #   arg3: old_faction
        # output: none
    ("center_change_current_faction",
        [
            (store_script_param, ":center_no", 1),
            (store_script_param, ":new_faction", 2),
            # (store_script_param, ":old_faction", 3),

            (party_set_faction, ":center_no", ":new_faction"),
            
            (call_script, "script_party_update_extra_text", ":center_no"),
        ]),

    # script_center_change_faction
        # input:
        #   arg1: center_no
        #   arg2: new_faction
        #   arg3: update_factions
        # output: none
    ("center_change_faction",
        [
            (store_script_param, ":center_no", 1),
            (store_script_param, ":new_faction", 2),
            (store_script_param, ":update_factions", 3),

            (party_get_slot, ":old_faction", ":center_no", slot_party_faction),
            (party_set_slot, ":center_no", slot_party_faction, ":new_faction"),
            (party_set_faction, ":center_no", ":new_faction"),
            
            (call_script, "script_party_update_extra_text", ":center_no"),

            (party_get_slot, ":leader", ":center_no", slot_party_leader),
            (try_begin),
                (ge, ":leader", 0),
                (store_troop_faction, ":leader_faction", ":leader"),
                (neq, ":leader_faction", ":new_faction"),
                (party_set_slot, ":center_no", slot_party_leader, -1),
                
                (call_script, "script_troop_get_rank", ":leader"),
                (assign, ":rank", reg0),
                (troop_set_slot, ":leader", slot_troop_rank, ":rank"),
                
                (call_script, "script_troop_update_name", ":leader"),
                (call_script, "script_troop_update_home", ":leader"),
            (try_end),

            (party_get_slot, ":party_type", ":center_no", slot_party_type),
            (try_begin),
                (this_or_next|eq, ":party_type", spt_town),
                (eq, ":party_type", spt_castle),

                (try_for_range, ":village", villages_begin, villages_end),
                    (party_get_slot, ":linked_party", ":village", slot_party_linked_party),
                    (eq, ":linked_party", ":center_no"),
                    (call_script, "script_center_change_faction", ":village", ":new_faction", 0),
                (try_end),
            (try_end),

            (try_for_range, ":aux_party_slot", slot_party_attached_party_1, slot_party_attached_party_3 + 1),
                (party_get_slot, ":aux_party", ":center_no", ":aux_party_slot"),
                (gt, ":aux_party", 0),
                (party_is_active, ":aux_party"),
                (party_set_faction, ":aux_party", ":new_faction"),
            (try_end),

            (try_begin),
                (eq, ":update_factions", 1),
                (call_script, "script_faction_update_size", ":new_faction"),
                (call_script, "script_faction_update_size", ":old_faction"),
            (try_end),
        ]),

    # script_faction_update_size
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_update_size",
        [
            (store_script_param, ":new_faction", 1),

            (assign, ":new_faction_weight", 0),
            (assign, ":new_faction_num_fiefs", 0),
            (assign, ":new_faction_num_walled_fiefs", 0),
            (try_for_range, ":cur_center", centers_begin, centers_end),
                (party_get_slot, ":center_faction", ":cur_center", slot_party_faction),
                (try_begin),
                    (eq, ":center_faction", ":new_faction"),
                    (party_get_slot, ":party_type", ":cur_center", slot_party_type),
                    (assign, ":center_weight", 0),
                    (try_begin),
                        (eq, ":party_type", spt_village),
                        # (assign, ":center_weight", center_size_village),
                    (else_try),
                        (eq, ":party_type", spt_castle),
                        (assign, ":center_weight", center_size_castle),
                    (else_try),
                        (eq, ":party_type", spt_town),
                        (assign, ":center_weight", center_size_town),
                    (try_end),

                    (try_begin),
                        (this_or_next|eq, ":party_type", spt_castle),
                        (eq, ":party_type", spt_town),
                        (val_add, ":new_faction_num_walled_fiefs", 1),
                    (try_end),

                    (val_add, ":new_faction_weight", ":center_weight"),
                    (val_add, ":new_faction_num_fiefs", 1),
                (try_end),
            (try_end),

            (faction_get_slot, ":new_faction_old_size", ":new_faction", slot_faction_size_category),

            (call_script, "script_get_faction_size_from_weight", ":new_faction_weight"),
            (assign, ":new_faction_new_size", reg0),

            (faction_set_slot, ":new_faction", slot_faction_num_fiefs, ":new_faction_num_fiefs"),
            (faction_set_slot, ":new_faction", slot_faction_num_walled_fiefs, ":new_faction_num_walled_fiefs"),
            (faction_set_slot, ":new_faction", slot_faction_size, ":new_faction_weight"),
            (try_begin),
                (neq, ":new_faction_old_size", ":new_faction_new_size"),
                (faction_set_slot, ":new_faction", slot_faction_size_category, ":new_faction_new_size"),
                (call_script, "script_faction_update_name", ":new_faction"),
            (try_end),
        ]),

    # script_faction_update_color
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_update_color",
        [
            (store_script_param, ":faction_no", 1),

            (call_script, "script_faction_get_color", ":faction_no", 10),
            (faction_set_color, ":faction_no", reg0),
        ]),

    # script_faction_get_color
        # input:
        #   arg1: faction_no
        #   arg2: max_depth
        # output:
        #   reg0: color
    ("faction_get_color",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":max_depth", 2),

            (assign, ":color", -1),
            (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),
            (try_begin),
                (eq, "$g_normalize_faction_color", 1),
                (gt, ":max_depth", 0),
                (gt, ":vassal_type", 0),
                (assign, ":overlord", -1),
                (assign, ":end", kingdoms_end),
                (try_for_range, ":other_kingdom", kingdoms_begin, ":end"),
                    (store_sub, ":offset", ":other_kingdom", kingdoms_begin),
                    (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_treaties_begin),

                    (faction_get_slot, ":treaty", ":faction_no", ":treaty_slot"),
                    (store_and, ":is_vassal", ":treaty", sfkt_vassal),
                    (gt, ":is_vassal", 0),
                    (assign, ":overlord", ":other_kingdom"),
                    (assign, ":end", kingdoms_begin),
                (try_end),
                (gt, ":overlord", 0),
                (val_sub, ":max_depth", 1),
                (call_script, "script_faction_get_color", ":overlord", ":max_depth"),
                (assign, ":color", reg0),
            (else_try),
                (faction_get_slot, ":faction_color", ":faction_no", slot_faction_original_color),
                (assign, ":color", ":faction_color"),
            (try_end),
            (assign, reg0, ":color"),
        ]),

    # script_faction_update_name
        # input: 
        #   arg1: faction_no
        # output: none
    ("faction_update_name",
        [
            (store_script_param, ":faction_no", 1),
            (try_begin),
                (faction_slot_eq, ":faction_no", slot_faction_has_fixed_name, 0),
                (faction_get_slot, ":culture", ":faction_no", slot_faction_culture),
                (store_sub, ":offset", ":culture", cultures_begin),
                (faction_get_slot, ":size", ":faction_no", slot_faction_size_category),
                (faction_get_slot, ":name_holder", ":faction_no", slot_faction_name_holder),

                (val_mul, ":offset", faction_size_names_count),
                (val_add, ":offset", ":size"),

                (store_add, ":size_name", faction_size_names_begin, ":offset"),

                (str_store_party_name, s0, ":name_holder"),
                (str_store_string, s10, ":size_name"),
                (faction_set_name, ":faction_no", s10),

                (try_begin),
                    (call_script, "script_cf_debug", debug_simple|debug_faction),
                    (str_store_party_name, s11, ":name_holder"),
                    (str_store_faction_name, s12, ":faction_no"),
                    (assign, reg11, ":offset"),
                    (assign, reg12, ":size"),
                    (display_message, "@{s11} is now named {s12}. offset: {reg11}, size: {reg12}."),
                (try_end),
            (try_end),
        ]),
    
    # script_cf_merchant_can_update
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: num_times
        #   fails if merchant can't update goods (last met within less than merchants_update_rate)
    ("cf_merchant_can_update",
        [
            (store_script_param, ":merchant", 1),
            
            (troop_get_slot, ":last_met", ":merchant", slot_troop_last_met),
            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            (troop_set_slot, ":merchant", slot_troop_last_met, ":current_day"),
            (store_div, ":last_met_mod", ":last_met", merchants_update_rate),
            (val_div, ":current_day", merchants_update_rate),
            
            (store_sub, ":time_passed", ":current_day", ":last_met_mod"),
            (gt, ":time_passed", 0),
            (val_min, ":time_passed", 10),
            (try_begin),
                (call_script, "script_cf_debug", debug_economy|debug_simple),
                (assign, reg0, ":time_passed"),
                (display_message, "@Updating merchant goods ({reg0} times)."),
            (try_end),
            (assign, reg0, ":time_passed"),
        ]),
    
    # script_troop_get_face_code
        # input: 
        #   arg1: troop_no
        # output:
        #   s0: facecode
    ("troop_get_face_code",
        [
            (store_script_param, ":troop_no", 1),
            (str_store_troop_face_keys, s0, ":troop_no"),
            
            (store_troop_faction, ":faction_no", ":troop_no"),
            (faction_get_slot, ":culture", ":faction_no", slot_faction_culture),
            (troop_get_type, ":type", ":troop_no"),
            
            (try_begin),
                (eq, ":type", tf_male),
                (call_script, "script_set_random_faction_hair", ":culture"),
                (call_script, "script_set_random_faction_beard", ":culture"),
                (call_script, "script_set_random_faction_face_texture", ":culture"),
                # (call_script, "script_set_random_faction_hair_texture", ":culture"),
                (call_script, "script_set_random_faction_hair_color", ":culture"),
                # (call_script, "script_set_random_faction_skin_color", ":culture"),
                (call_script, "script_set_random_faction_morph_key", ":culture"),
            (else_try),
                # Need to add scripts for female randomization
            (try_end),
        ]),

    # script_troop_copy_face_code_from_troop
        # input: 
        #   arg1: troop_no
        #   arg2: troop_no_to_copy
        # output: none
    ("troop_copy_face_code_from_troop",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":troop_no_2", 2),

            (str_store_troop_face_keys, s0, ":troop_no_2", 1),
            (troop_set_face_keys, ":troop_no", s0, 1),

            (str_store_troop_face_keys, s1, ":troop_no_2", 2),
            (troop_set_face_keys, ":troop_no", s1, 2),
        ]),

    # script_troop_copy_face_code
        # input: 
        #   arg1: troop_no
        #   arg2: face_code
        # output: none
    # ("troop_copy_face_code", 
    #     [
    #         (store_script_param, ":troop_no", 1),
    #         (store_script_param, ":face_key", 2),
    #     ]),
    
    # script_set_random_faction_hair
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    ("set_random_faction_hair",
        [
            (store_script_param, ":faction_no", 1),
            (assign, ":value", 0),
            (try_begin),
                (eq, ":faction_no", fac_culture_1),
                (store_random_in_range, ":value", 0, 16),
                (try_begin),
                    (ge, ":value", 9),
                    (val_add, ":value", 5),
                (try_end),
            (else_try),
                (eq, ":faction_no", fac_culture_2),
                (store_random_in_range, ":value", 0, 13),
                (try_begin),
                    (eq, ":value", 2),
                    (assign, ":value", 13),
                (try_end),
            (else_try),
                (eq, ":faction_no", fac_culture_3),
                (store_random_in_range, ":value", 7, 14),
            (else_try),
                (eq, ":faction_no", fac_culture_4),
                (store_random_in_range, ":value", 3, 12),
            (else_try),
                (eq, ":faction_no", fac_culture_5),
                (store_random_in_range, ":value", 0, 13),
                (try_begin),
                    (is_between, ":value", 1, 4),
                    (val_add, ":value", 3),
                (else_try),
                    (ge, ":value", 5),
                    (val_add, ":value", 8),
                (try_end),
            (else_try),
                (eq, ":faction_no", fac_culture_6),
                (store_random_in_range, ":value", 0, 8),
                (try_begin),
                    (is_between, ":value", 1, 8),
                    (val_add, ":value", 3),
                (try_end),
            (try_end),
            (face_keys_set_hair, s0, ":value"),
        ]),
        
    # script_set_random_faction_beard
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    ("set_random_faction_beard",
        [
            # (store_script_param, ":faction_no", 1),
        ]),
        
    # script_set_random_faction_face_texture
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    ("set_random_faction_face_texture",
        [
            (store_script_param, ":faction_no", 1),
            (assign, ":value", 0),
            (try_begin),
                (eq, ":faction_no", fac_culture_1),
                (store_random_in_range, ":value", 1, 4),
            (else_try),
                (eq, ":faction_no", fac_culture_2),
                (store_random_in_range, ":value", 0, 3),
            (else_try),
                (eq, ":faction_no", fac_culture_3),
                (store_random_in_range, ":value", 3, 5),
            (else_try),
                (eq, ":faction_no", fac_culture_4),
                (store_random_in_range, ":value", 0, 2),
            (else_try),
                (eq, ":faction_no", fac_culture_5),
                (store_random_in_range, ":value", 3, 6),
                (try_begin),
                    (eq, ":value", 4),
                    (assign, ":value", 6),
                (try_end),
            (else_try),
                (eq, ":faction_no", fac_culture_6),
                (store_random_in_range, ":value", 6, 8),
            (try_end),
            (face_keys_set_face_texture, s0, ":value"),
        ]),
        
    # script_set_random_faction_hair_texture
    # input: 
    #   arg1: faction_no
    #   s0: face_key
    # output:
    #   s0: new_face_key
    # ("set_random_faction_hair_texture",
        # [
            # (store_script_param, ":faction_no", 1),
        # ]),
        
    # script_set_random_faction_hair_color
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    ("set_random_faction_hair_color",
        [
            (store_script_param, ":faction_no", 1),
            (assign, ":value", 0),
            (try_begin),
                (eq, ":faction_no", fac_culture_1),
                (store_random_in_range, ":value", 20, 64),
            (else_try),
                (eq, ":faction_no", fac_culture_2),
                (store_random_in_range, ":value", 10, 50),
            (else_try),
                (eq, ":faction_no", fac_culture_3),
                (store_random_in_range, ":value", 30, 64),
            (else_try),
                (eq, ":faction_no", fac_culture_4),
                (store_random_in_range, ":value", 0, 30),
            (else_try),
                (eq, ":faction_no", fac_culture_5),
                (store_random_in_range, ":value", 30, 64),
            (else_try),
                (eq, ":faction_no", fac_culture_6),
                (store_random_in_range, ":value", 30, 64),
            (try_end),
            (face_keys_set_hair_color, s0, ":value"),
        ]),
        
    # script_set_random_faction_skin_color
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    # ("set_random_faction_skin_color",
        # [
            # (store_script_param, ":faction_no", 1),
        # ]),
        
    # script_set_random_faction_morph_key
        # input: 
        #   arg1: faction_no
        #   s0: face_key
        # output:
        #   s0: new_face_key
    ("set_random_faction_morph_key",
        [
            # (store_script_param, ":faction_no", 1),
        ]),
    
    # script_find_free_lord
        # input: none
        # output:
        #   reg0: troop_no
    ("find_free_lord",
        [
            (assign, ":end", 1000),
            (try_for_range, ":unused", 0, ":end"),
                (try_begin),
                    (is_between, "$g_cur_free_lord", lords_begin, lords_end),
                    (troop_get_slot, ":occupation", "$g_cur_free_lord", slot_troop_kingdom_occupation),
                    (try_begin),
                        (eq, ":occupation", tko_none),
                        (store_troop_faction, ":lord_faction", "$g_cur_free_lord"),
                        (eq, ":lord_faction", fac_commoners),
                        (assign, ":end", 0),
                    (try_end),
                    (val_add, "$g_cur_free_lord", 1),
                (else_try),
                    (assign, "$g_cur_free_lord", lords_begin),
                (try_end),
            (try_end),
            
            (try_begin),
                # We don't have enough lords in the lord pool, we can create more
                # Should it be an error ? So that the limit can be further increased next time
                # Or to report potential lord leaks (lords not active but not removed)
                (eq, ":end", 1000),
                (try_begin),
                    (call_script, "script_cf_debug", debug_all),
                    (display_message, "@ERROR: Lord pool empty!", text_color_impossible),
                (else_try),
                    (display_debug_message, "@ERROR: Lord pool empty!", text_color_impossible),
                (try_end),
                (assign, reg0, -1),
            (else_try),
                (store_sub, reg0, "$g_cur_free_lord", 1),
            (try_end),
        ]),
    
    # script_cf_party_join_battle
        # input:
        #   arg1: party_no
        #   arg2: battling_party_1
        #   arg3: battling_party_2
        # output:
        #   reg0: battle_side
    ("cf_party_join_battle",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":battling_party_1", 2),
            (store_script_param, ":battling_party_2", 3),
            
            (party_is_active, ":party_no"),
            (neq, ":party_no", "$g_encountered_party"),
            (neq, ":party_no", "$g_encountered_party_2"),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (eq, ":party_type", spt_war_party),
            (party_get_attached_to, ":attached_party", ":party_no"),
            (lt, ":attached_party", 0),
            (store_distance_to_party_from_party, ":distance", ":party_no", "$g_encountered_party"),
            (lt, ":distance", reinforcement_range),

            (party_get_battle_opponent, ":opponent", ":party_no"),
            (eq, ":opponent", -1),

            (call_script, "script_party_select_battle_side", ":party_no", ":battling_party_1", ":battling_party_2"),
        ]),
    
    # script_agent_get_archer_score
        # input:
        #   arg1: agent_no
        # output:
        #   reg0: archer_score
    ("agent_get_archer_score",
        [
            (store_script_param, ":agent_no", 1),
            (agent_get_troop_id, ":troop_no", ":agent_no"),
            (assign, ":score", 0),
            
            (try_begin),
                (neg|troop_is_hero, ":troop_no"),
                (troop_get_slot, ":score", ":troop_no", slot_troop_archer_score),
                (assign, ":has_shield", 0),
                (store_add, ":end", ek_item_3, 1),
                (try_for_range, ":i_slot", ek_item_0, ":end"),
                    (agent_get_item_slot, ":item", ":agent_no", ":i_slot"),
                    (is_between, ":item", shields_begin, shields_end),
                    (assign, ":has_shield", 1),
                    (assign, ":end", 0),
                (try_end),
                (try_begin),
                    (eq, ":has_shield", 1),
                    (val_sub, ":score", archer_score_shield_malus),
                (try_end),
            # (else_try),
            #     # Need troops personalities to handle score
            #     (assign, ":has_shield", 0),
            #     (assign, ":has_ranged", 0),
            #     (store_add, ":end", ek_item_3, 1),
            #     (try_for_range, ":i_slot", ek_item_0, ":end"),
            #         (agent_get_item_slot, ":item", ":agent_no", ":i_slot"),
            #         (item_get_type, ":item_type", ":item"),
            #         (try_begin),
            #             (eq, ":item_type", itp_type_shield),
            #             (assign, ":has_shield", 1),
            #         (else_try),
            #             (this_or_next|eq, ":item_type", itp_type_thrown),
            #             (this_or_next|eq, ":item_type", itp_type_crossbow),
            #             (eq, ":item_type", itp_type_bow),
            #             (this_or_next|eq, ":has_ranged", 0),
            #             (eq, ":has_ranged", itp_type_thrown), # Override thrown weapon if better ranged is available
            #             (assign, ":has_ranged", ":item_type"),
            #         (try_end),
            #     (try_end),

            (try_end),
            
            (assign, reg0, ":score"),
        ]),
    
    # script_faction_damage_faction
        # input:
        #   arg1: dealing_faction
        #   arg2: receiving_faction
        #   arg3: damage_amount
        #   arg4: forced -- if forced then we do not decrease the dealing faction's war_damage
        # output:
        #   reg0: total_war_damage
    ("faction_damage_faction",
        [
            (store_script_param, ":dealing_faction", 1),
            (store_script_param, ":receiving_faction", 2),
            (store_script_param, ":damage_amount", 3),
            (store_script_param, ":forced", 4),

            (try_begin),
                (is_between, ":receiving_faction", kingdoms_begin, kingdoms_end),
                (gt, ":damage_amount", 0),
            
                (faction_get_slot, ":current_damage", ":receiving_faction", slot_faction_war_damage),
                (store_add, ":total_damage", ":current_damage", ":damage_amount"),
                (faction_set_slot, ":receiving_faction", slot_faction_war_damage, ":total_damage"),
                
                (try_begin),
                    (eq, ":forced", 0),
                    (is_between, ":dealing_faction", kingdoms_begin, kingdoms_end),
                    # Decrease dealing faction's war damage
                    (faction_get_slot, ":current_damage", ":dealing_faction", slot_faction_war_damage),
                    (store_div, ":damage_reduced", ":damage_amount", war_damage_inflicted_bonus_divider),
                    (val_sub, ":current_damage", ":damage_reduced"),
                    (faction_set_slot, ":dealing_faction", slot_faction_war_damage, ":current_damage"),
                (try_end),

                # (try_begin),
                #     (call_script, "script_cf_debug", debug_current),
                #     (str_store_faction_name, s10, ":dealing_faction"),
                #     (str_store_faction_name, s11, ":receiving_faction"),
                #     (assign, reg10, ":damage_amount"),
                #     (assign, reg11, ":total_damage"),
                #     (display_message, "@{s10} deals {reg10} damage to {s11} (total {reg11})"),
                # (try_end),
            (else_try),
                (assign, ":total_damage", 0),
            (try_end),
            
            (assign, reg0, ":total_damage"),
        ]),
    
    # script_transform_war_damage_to_relation_change
        # input:
        #   arg1: war_damage
        # output:
        #   reg0: relation_change
    ("transform_war_damage_to_relation_change",
        [
            (store_script_param, ":war_damage", 1),
            
            (store_div, ":relation_change", ":war_damage", 10),
            (store_mod, ":relation_change_rand", ":war_damage", 10),
            (store_random_in_range, ":rand", 0, 10),
            (try_begin),
                (gt, ":relation_change_rand", ":rand"),
                (val_add, ":relation_change", 1),
            (try_end),
            (val_mul, ":relation_change", -1),
            
            (assign, reg0, ":relation_change"),
        ]),

    # script_faction_relation_change_event
        # input:
        #   arg1: faction_changed
        #   arg2: faction_target
        #   arg3: relation_weight
        # output:
        #   reg0: relation_change
    ("faction_relation_change_event",
        [
            (store_script_param, ":faction_changed", 1),
            (store_script_param, ":faction_target", 2),
            (store_script_param, ":relation_weight", 3),

            (assign, ":relation_change", 0),
            (try_begin),
                (neq, ":relation_weight", 0),
                (neq, ":faction_changed", ":faction_target"),
                (store_div, ":relation_change", ":relation_weight", relation_change_factor),

                (assign, ":relation_change_abs", ":relation_change"),
                (val_abs, ":relation_change_abs"),
                (store_mod, ":relation_rest", ":relation_change_abs", relation_change_factor),
                (try_begin),
                    (gt, ":relation_rest", 0),
                    (store_random_in_range, ":rand", 0, relation_change_factor),
                    (gt, ":relation_rest", ":rand"),
                    (try_begin),
                        (gt, ":relation_weight", 0),
                        (val_add, ":relation_change", 1),
                    (else_try),
                        (val_sub, ":relation_change", 1),
                    (try_end),
                (try_end),

                (try_begin),
                    (neq, ":relation_change", 0),
                    (call_script, "script_faction_change_relation_with_faction", ":faction_changed", ":faction_target", ":relation_change", 1),
                (try_end),
            (try_end),
            (assign, reg0, ":relation_change"),
        ]),
    
    # script_faction_change_relation_with_faction
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: relation_change
        #   arg4: send_event
        # output:
        #   reg0: new_relation
    ("faction_change_relation_with_faction",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":relation_change", 3),
            (store_script_param, ":send_event", 4),

            (assign, ":new_relation", 0),
            (try_begin),
                (ge, ":faction_1", 0),
                (ge, ":faction_2", 0),

                (store_sub, ":offset", ":faction_2", kingdoms_begin),
                (store_add, ":relation_slot", slot_faction_kingdom_relation_begin, ":offset"),
                (faction_get_slot, ":current_relation", ":faction_1", ":relation_slot"),
                (assign, ":new_relation", ":current_relation"),

                (try_begin),
                    (neq, ":relation_change", 0),
                    (store_add, ":new_relation", ":current_relation", ":relation_change"),
                    (val_clamp, ":new_relation", -100, 101),

                    (try_begin),
                        (eq, ":send_event", 1),
                        (call_script, "script_faction_political_event", ":faction_1", political_event_relation_change, ":faction_2", ":new_relation", ":relation_change"),
                    (try_end),
                    
                    (try_begin),
                        (neq, ":new_relation", ":current_relation"),
                        (faction_set_slot, ":faction_1", ":relation_slot", ":new_relation"),
                        
                        (call_script, "script_cf_debug", debug_faction),
                        (str_store_faction_name, s10, ":faction_1"),
                        (str_store_faction_name, s11, ":faction_2"),
                        (assign, reg10, ":current_relation"),
                        (assign, reg11, ":new_relation"),
                        (display_message, "@{s10} and {s11} relation was {reg10}, now {reg11}"),
                    (try_end),
                (try_end),
            (try_end),
            
            (assign, reg0, ":new_relation"),
        ]),
    
    # script_faction_political_event
        # input:
        #   arg1: faction_no
        #   arg2: event_type
        #   arg3: parameter_1
        #   arg4: parameter_2
        #   arg5: parameter_3
        # output: 
        #   reg0: event_output (0: event ignored, 1: event processed)
    ("faction_political_event",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":event_type", 2),
            (store_script_param, ":parameter_1", 3),
            (store_script_param, ":parameter_2", 4),
            (store_script_param, ":parameter_3", 5),

            (assign, ":output", 0),

            (try_begin),
                (eq, ":event_type", political_event_relation_change),
            (else_try),
                (eq, ":event_type", political_event_war_declared),
                (call_script, "script_faction_political_event_war_declared", ":faction_no", ":parameter_1", ":parameter_2"),
            (else_try),
                (eq, ":event_type", political_event_center_freed),
                (call_script, "script_faction_political_event_center_freed", ":faction_no", ":parameter_1", ":parameter_2", ":parameter_3"),
            (else_try),
                (eq, ":event_type", political_event_center_captured),
                (call_script, "script_faction_political_event_center_captured", ":faction_no", ":parameter_1", ":parameter_2"),
            (else_try),
                (eq, ":event_type", political_event_vassal_captured),
                (call_script, "script_faction_political_event_vassal_captured", ":faction_no", ":parameter_1", ":parameter_2"),
            (else_try),
                (eq, ":event_type", political_event_vassal_freed),
                (call_script, "script_faction_political_event_vassal_freed", ":faction_no", ":parameter_1", ":parameter_2"),
            (else_try),
                (call_script, "script_cf_debug", debug_simple),
                (try_begin),
                    (ge, ":faction_no", 0),
                    (str_store_faction_name, s10, ":faction_no"),
                (else_try),
                    (str_store_string, s10, "@Unknown faction"),
                (try_end),

                (assign, reg10, ":event_type"),

                (assign, reg11, ":parameter_1"),
                (assign, reg12, ":parameter_2"),
                (assign, reg13, ":parameter_3"),
                (display_message, "@{s10} unhandled event: {reg10} - parameters ({reg11} {reg12} {reg13})", text_color_debug),
            (try_end),
            
            (try_begin),
                (call_script, "script_cf_debug", debug_faction),
                (try_begin),
                    (ge, ":faction_no", 0),
                    (str_store_faction_name, s10, ":faction_no"),
                (else_try),
                    (str_store_string, s10, "@Unknown faction"),
                (try_end),
                (assign, reg10, ":event_type"),
                (assign, reg11, ":output"),
                (display_message, "@{s10} event: {reg10} {reg11?processed:ignored}"),
            (try_end),
            (assign, reg0, ":output"),
        ]),

    # script_war_apply_treaties
        # input:
        #   arg1: war_storage
        # output: none
        # this script needs to be called after script_war_invite_treaties
    ("war_apply_treaties",
        [
            (store_script_param, ":war_storage", 1),
            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (neg|faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                (faction_get_slot, ":side", ":faction_no", slot_faction_tmp),
                (neq, ":side", swkp_bystander),

                (try_begin),
                    (ge, ":side", swkp_aggressor),
                    (str_store_faction_name, s10, ":faction_no"),
                    (display_log_message, "@{s10} joins war on side of attacker", text_color_war),
                (else_try),
                    (le, ":side", swkp_defender),
                    (str_store_faction_name, s10, ":faction_no"),
                    (display_log_message, "@{s10} joins war on side of defender", text_color_war),
                (try_end),
                (call_script, "script_faction_join_war", ":faction_no", ":war_storage", ":side"),
                (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_bystander),
            (try_end),
        ]),

    # script_war_invite_treaties
        # input:
        #   arg1: war_storage
        # output: none
    ("war_invite_treaties",
        [
            (store_script_param, ":war_storage", 1),
            (store_script_param, ":ignore_treaties", 2),

            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (try_begin),
                    (neg|faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                    (call_script, "script_faction_is_war_participant", ":faction_no", ":war_storage"),
                    (eq, reg0, swkp_bystander),

                    (call_script, "script_faction_get_war_side", ":faction_no", ":war_storage", ":ignore_treaties"),
                    (assign, ":must_declare_attacker", reg0),
                    (assign, ":must_declare_defender", reg1),

                    (try_begin),
                        (eq, ":must_declare_defender", 1),
                        (eq, ":must_declare_attacker", 0),

                        (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_aggressor),
                    (else_try),
                        (eq, ":must_declare_defender", 0),
                        (eq, ":must_declare_attacker", 1),

                        (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_defender),
                    (else_try),
                        (eq, ":must_declare_defender", 1),
                        (eq, ":must_declare_attacker", 1),

                        (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_bystander),
                    (else_try),
                        (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_bystander),
                    (try_end),
                (else_try),
                    (faction_set_slot, ":faction_no", slot_faction_tmp, swkp_bystander),
                (try_end),
            (try_end),
        ]),

    # script_faction_get_war_side
        # input:
        #   arg1: faction_no
        #   arg2: war_storage
        #   arg3: ignore_treaties
        # output:
        #   reg0: must_declare_attacker
        #   reg1: must_declare_defender
    ("faction_get_war_side",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":war_storage", 2),
            (store_script_param, ":ignore_treaties", 3),

            (assign, ":must_declare_attacker", 0),
            (assign, ":must_declare_defender", 0),

            (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                (call_script, "script_faction_is_war_participant", ":other_faction", ":war_storage"),
                (assign, ":side", reg0),
                (neq, ":side", swkp_bystander),

                (call_script, "script_faction_get_treaties", ":faction_no", ":other_faction"),
                (assign, ":treaties", reg0),

                (faction_get_slot, ":vassal_type", ":faction_no", slot_faction_vassal_type),
                (faction_get_slot, ":vassal_type_other", ":other_faction", slot_faction_vassal_type),

                (store_and, ":alliance", ":treaties", sfkt_alliance),
                (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
                (store_and, ":vassal", ":treaties", sfkt_vassal),
                (store_and, ":overlord", ":treaties", sfkt_overlord),

                (assign, ":must_help", 0),

                (try_begin),
                    (gt, ":alliance", 0),
                    (eq, ":ignore_treaties", 0),
                    (assign, ":must_help", 1),
                (else_try),
                    (gt, ":defensive", 0),
                    (eq, ":ignore_treaties", 0),
                    (le, ":side", swkp_defender),
                    (assign, ":must_help", 1),
                (else_try),
                    (gt, ":vassal"),
                    
                    (store_and, ":is_sattrapy", ":vassal_type", sfvt_sattrapy),
                    (gt, ":is_sattrapy", 0),
                    (assign, ":must_help", 1),
                (else_try),
                    (gt, ":vassal"),

                    (le, ":side", swkp_defender),
                    (store_and, ":is_bulwark", ":vassal_type", sfvt_bulwark),
                    (gt, ":is_bulwark", 0),

                    (assign, ":must_help", 1),
                (else_try),
                    (gt, ":overlord", 0),

                    (le, ":side", swkp_defender),
                    (store_and, ":is_protectorate", ":vassal_type_other", sfvt_protectorate),
                    (gt, ":is_protectorate", 0),
                    (assign, ":must_help", 1),
                (try_end),

                (try_begin),
                    (gt, ":must_help", 0),
                    (try_begin),
                        (lt, ":side", swkp_bystander),
                        (assign, ":must_declare_attacker", 1),
                    (else_try),
                        (gt, ":side", swkp_bystander),
                        (assign, ":must_declare_defender", 1),
                    (try_end),
                (try_end),
            (try_end),

            (assign, reg0, ":must_declare_attacker"),
            (assign, reg1, ":must_declare_defender"),
        ]),

    # script_faction_political_event_war_declared
        # input:
        #   arg1: faction_attacker
        #   arg2: faction_defender
        #   arg3: war_storage
    ("faction_political_event_war_declared",
        [
            (store_script_param, ":faction_attacker", 1),
            (store_script_param, ":faction_defender", 2),
            (store_script_param, ":war_storage", 3),

            (call_script, "script_faction_relation_change_event", ":faction_defender", ":faction_attacker", relation_change_war_declared),

            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (neg|faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                (neq, ":faction_no", ":faction_attacker"),
                (neq, ":faction_no", ":faction_defender"),

                (store_sub, ":defender_offset", ":faction_defender", kingdoms_begin),
                (store_add, ":defender_relation_slot", slot_faction_kingdom_relation_begin, ":defender_offset"),
                (faction_get_slot, ":relation", ":faction_no", ":defender_relation_slot"),

                # (store_relation, ":relation_attacker", ":faction_no", ":faction_attacker"),
                (store_relation, ":relation_defender", ":faction_no", ":faction_defender"),

                (store_mul, ":relation_hit", ":relation", -1),
                (try_begin),
                    (le, ":relation_defender", relation_state_war),
                    (val_add, ":relation_hit", relation_change_joined_war),
                (try_end),
                (call_script, "script_faction_relation_change_event", ":faction_no", ":faction_attacker", ":relation_hit"),
            (try_end),

            # We first invite direct vassals/overlords of participants
            (call_script, "script_war_invite_treaties", ":war_storage", 1),
            (call_script, "script_war_apply_treaties", ":war_storage"),

            # We then invite treaty-bounds
            (call_script, "script_war_invite_treaties", ":war_storage", 0),
            (call_script, "script_war_apply_treaties", ":war_storage"),

            # We finally invite direct vassals/overlords of treaty-bounds
            (call_script, "script_war_invite_treaties", ":war_storage", 1),
            (call_script, "script_war_apply_treaties", ":war_storage"),

        ]),

    # script_faction_political_event_center_freed
        # input:
        #   arg1: freeing_faction
        #   arg2: center_freed
        #   arg3: freeing_party
        #   arg4: freed_from_faction
    ("faction_political_event_center_freed",
        [
            (store_script_param, ":freeing_faction", 1),
            (store_script_param, ":center_freed", 2),
            (store_script_param, ":freeing_party", 3),
            (store_script_param, ":freed_from_faction", 4),

            (party_get_slot, ":center_type", ":center_freed", slot_party_type),
            (party_get_slot, ":center_owner_faction", ":center_freed", slot_party_faction),
            (assign, ":damage", 0),
            # War damage is reduced when freeing a center
            (try_begin),
                (eq, ":center_type", spt_town),
                (store_div, ":damage", war_damage_base_town_taken, 2),
            (else_try),
                (eq,":center_type", spt_castle),
                (store_div, ":damage", war_damage_base_castle_taken, 2),
            (else_try),
                (eq, ":center_type", spt_village),
                (store_div, ":damage", war_damage_base_village_taken, 2),
            (try_end),
            
            # Political consequences
            (call_script, "script_faction_damage_faction", ":center_owner_faction", ":freed_from_faction", ":damage", 0),

            (call_script, "script_faction_relation_change_event", ":center_owner_faction", ":freeing_faction", relation_change_center_freed),
            
            (try_begin),
                (ge, ":freeing_party", 0),
                (party_get_slot, ":leader", ":freeing_party", slot_party_leader),
                (str_store_troop_name_link, s10, ":leader"),
                (str_store_party_name_link, s11, ":center_freed"),
                
                (display_log_message, "@{s11} has been freed by {s10}", text_color_freed),
            (try_end),
        ]),

    # script_faction_political_event_center_captured
        # input:
        #   arg1: capturing_faction
        #   arg2: center_captured
        #   arg3: capturing_party
    ("faction_political_event_center_captured",
        [
            (store_script_param, ":capturing_faction", 1),
            (store_script_param, ":center_captured", 2),
            (store_script_param, ":capturing_party", 3),

            (party_get_slot, ":center_type", ":center_captured", slot_party_type),
            (party_get_slot, ":center_owner_faction", ":center_captured", slot_party_faction),
            (assign, ":damage", 0),
            (try_begin),
                (eq, ":center_type", spt_town),
                (assign, ":damage", war_damage_base_town_taken),
            (else_try),
                (eq,":center_type", spt_castle),
                (assign, ":damage", war_damage_base_castle_taken),
            (else_try),
                (eq, ":center_type", spt_village),
                (assign, ":damage", war_damage_base_village_taken),
            (try_end),
            
            # Political consequences
            (call_script, "script_faction_damage_faction", ":capturing_faction", ":center_owner_faction", ":damage", 0),
            
            (try_begin),
                (ge, ":capturing_party", 0),
                (party_get_slot, ":leader", ":capturing_party", slot_party_leader),
                (try_begin),
                    (ge, ":leader", 0),
                    (str_store_troop_name_link, s10, ":leader"),
                (else_try),
                    (str_store_party_name, s10, ":capturing_party"),
                (try_end),
                (str_store_party_name_link, s11, ":center_captured"),
                
                (display_log_message, "@{s11} has been captured by {s10}", text_color_capture),
            (try_end),
        ]),

    # script_faction_political_event_vassal_captured
        # input:
        #   arg1: capturing_faction
        #   arg2: troop_captured
        #   arg3: capturing_party
    ("faction_political_event_vassal_captured",
        [
            (store_script_param, ":capturing_faction", 1),
            (store_script_param, ":troop_captured", 2),
            (store_script_param, ":capturing_party", 3),

            (store_troop_faction, ":captured_faction", ":troop_captured"),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_war),
                (str_store_troop_name_link, s10, ":troop_captured"),
                (try_begin),
                    (ge, ":capturing_party", 0),
                    (str_store_party_name_link, s11, ":capturing_party"),
                (else_try),
                    (str_store_faction_name, s11, ":capturing_faction"),
                (try_end),
                (display_log_message, "@{s10} has been captured by {s11}."),
            (try_end),

            (call_script, "script_faction_damage_faction", ":capturing_faction", ":captured_faction", war_damage_base_lord_defeated, 0),

            (call_script, "script_transform_war_damage_to_relation_change", war_damage_base_lord_defeated),
            (assign, ":relation_damage", reg0),
            (call_script, "script_faction_relation_change_event", ":captured_faction", ":capturing_faction", ":relation_damage"),
        ]),

    # script_faction_political_event_vassal_freed
        # input:
        #   arg1: freeing_faction
        #   arg2: troop_freed
        #   arg3: freeing_party
    ("faction_political_event_vassal_freed",
        [
            (store_script_param, ":freeing_faction", 1),
            (store_script_param, ":troop_freed", 2),
            (store_script_param, ":freeing_party", 3),

            (store_troop_faction, ":freed_faction", ":troop_freed"),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_war),
                (str_store_troop_name_link, s10, ":troop_freed"),
                (try_begin),
                    (ge, ":freeing_party", 0),
                    (str_store_party_name_link, s11, ":freeing_party"),
                    (assign, reg10, 1),
                (else_try),
                    (assign, reg10, 0),
                (try_end),
                (display_log_message, "@{s10} has been freed {reg10?by {s11}:from captivity}."),
            (try_end),

            (call_script, "script_faction_relation_change_event", ":freed_faction", ":freeing_faction", relation_change_vassal_freed),
        ]),

    # script_faction_create_treaty
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: treaty_type
    ("faction_create_treaty",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":treaty_type", 3),

            (call_script, "script_faction_set_treaty", ":faction_1", ":faction_2", ":treaty_type"),

            (call_script, "script_faction_reset_relations", ":faction_1", ":faction_2"),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction|debug_simple),
                (str_store_faction_name, s10, ":faction_1"),
                (str_store_faction_name, s11, ":faction_2"),
                (assign, reg10, ":treaty_type"),
                (display_message, "@{s10}: treaty {reg10} with {s11}", text_color_info),
            (try_end),
        ]),


    # script_faction_create_temporary_treaty
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: treaty_type
        #   arg4: expire_time
        #   arg5: value
    ("faction_create_temporary_treaty",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":treaty_type", 3),
            (store_script_param, ":expire_time", 4),
            (store_script_param, ":value", 5),

            (store_sub, ":offset", ":faction_2", kingdoms_begin),
            (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),
            (store_add, ":treaty_duration_slot", ":offset", slot_faction_kingdom_temporary_treaties_duration_begin),
            (store_add, ":treaty_object_slot", ":offset", slot_faction_kingdom_temporary_treaties_object_begin),
            (faction_set_slot, ":faction_1", ":treaty_slot", ":treaty_type"),
            (faction_set_slot, ":faction_1", ":treaty_duration_slot", ":expire_time"),
            (faction_set_slot, ":faction_1", ":treaty_object_slot", ":value"),

            (try_begin),
                (neq, ":treaty_type", sfkt_tribute),
                # If we have a tribute we don't want a reciprocal treaty
                (store_sub, ":offset", ":faction_1", kingdoms_begin),
                (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),
                (store_add, ":treaty_duration_slot", ":offset", slot_faction_kingdom_temporary_treaties_duration_begin),
                (store_add, ":treaty_object_slot", ":offset", slot_faction_kingdom_temporary_treaties_object_begin),
                (faction_set_slot, ":faction_2", ":treaty_slot", ":treaty_type"),
                (faction_set_slot, ":faction_2", ":treaty_duration_slot", ":expire_time"),
                (faction_set_slot, ":faction_2", ":treaty_object_slot", ":value"),
            (try_end),

            (call_script, "script_faction_reset_relations", ":faction_1", ":faction_2"),

            (try_begin),
                (call_script, "script_cf_debug", debug_faction|debug_simple),
                (str_store_faction_name, s10, ":faction_1"),
                (str_store_faction_name, s11, ":faction_2"),
                (assign, reg10, ":treaty_type"),
                (str_store_date, s12, ":expire_time"),
                (assign, reg12, ":value"),
                (display_message, "@{s10}: treaty {reg10} with {s11} until {s12} ({reg12})", text_color_info),
            (try_end),
        ]),

    # script_faction_create_vassal
        # input:
        #   arg1: overlord
        #   arg2: vassal
        #   arg3: vassal_type
        #   arg4: war_storage
    ("faction_create_vassal",
        [
            (store_script_param, ":overlord", 1),
            (store_script_param, ":vassal", 2),
            (store_script_param, ":vassal_type", 3),
            (store_script_param, ":war_storage", 4),

            (faction_set_slot, ":vassal", slot_faction_vassal_type, ":vassal_type"),
            (call_script, "script_faction_create_treaty", ":vassal", ":overlord", sfkt_vassal),
            
            (call_script, "script_faction_remove_wars", ":vassal", ":war_storage"),

            (call_script, "script_faction_remove_vassal_treaties", ":vassal"),

            (call_script, "script_faction_update_color", ":vassal"),

            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (neq, ":faction_no", ":overlord"),
                (neq, ":faction_no", ":vassal"),

                (call_script, "script_cf_faction_is_vassal", ":faction_no", ":vassal"),
                (assign, ":old_vassal_type", reg0),
                (call_script, "script_faction_remove_vassal", ":vassal", ":faction_no"),
                (call_script, "script_faction_create_vassal", ":overlord", ":faction_no", ":old_vassal_type", ":war_storage"),
            (try_end),
        ]),

    # script_cf_faction_is_vassal
        # input:
        #   arg1: faction_no
        #   arg2: potential_overlord
        # output:
        #   reg0: vassal_type
        #   fails if faction_no is not vassal of potential_overlord
    ("cf_faction_is_vassal",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":potential_overlord", 2),

            (call_script, "script_faction_get_treaties", ":faction_no", ":potential_overlord"),
            (assign, ":treaties", reg0),

            (store_and, ":vassal", ":treaties", sfkt_vassal),
            (gt, ":vassal", 0),

            (faction_get_slot, reg0, ":faction_no", slot_faction_vassal_type),
        ]),

    # script_faction_remove_vassal
        # input:
        #   arg1: overlord
        #   arg2: vassal
        # output: none
    ("faction_remove_vassal",
        [
            (store_script_param, ":overlord", 1),
            (store_script_param, ":vassal", 2),

            (call_script, "script_faction_revoke_treaty", ":overlord", ":vassal", sfkt_overlord),

            (faction_set_slot, ":vassal", slot_faction_vassal_type, sfvt_none),
        ]),

    # script_faction_remove_vassal_treaties
        # input:
        #   arg1: vassal
        # output: none
    ("faction_remove_vassal_treaties",
        [
            (store_script_param, ":vassal", 1),

            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (neq, ":faction_no", ":vassal"),

                (call_script, "script_faction_get_treaties", ":vassal", ":faction_no"),
                (assign, ":treaties", reg0),

                (val_and, ":treaties", sfkt_military_treaty_mask),
                (gt, ":treaties", 0),

                (call_script, "script_faction_clear_treaty", ":vassal", ":faction_no", sfkt_military_treaty_clear),
                (call_script, "script_faction_clear_treaty", ":faction_no", ":vassal", sfkt_military_treaty_clear),
            (try_end),
        ]),

    # script_faction_create_tribute
        # input:
        #   arg1: tributary
        #   arg2: target
        #   arg3: value
        #   arg4: war_storage
        # output: none
    ("faction_create_tribute",
        [
            (store_script_param, ":tributary", 1),
            (store_script_param, ":target", 2),
            (store_script_param, ":value", 3),
            (store_script_param, ":war_storage", 4),

            (call_script, "script_get_current_day"),
            (assign, ":days", reg0),
            (store_add, ":tribute_duration", ":days", 365 * 20),

            (assign, ":tribute_amount_baseline_value", 50),

            (store_sub, ":offset", ":tributary", kingdoms_begin),
            (store_add, ":tributary_slot", ":offset", slot_war_kingdom_participant_begin),
            (faction_get_slot, ":tributary_participant", ":war_storage", ":tributary_slot"),
            (val_clamp, ":tributary_participant", swkp_defender, swkp_aggressor + 1),
            
            (store_sub, ":offset", ":target", kingdoms_begin),
            (store_add, ":target_slot", ":offset", slot_war_kingdom_participant_begin),
            (faction_get_slot, ":target_participant", ":war_storage", ":target_slot"),
            (val_clamp, ":target_participant", swkp_defender, swkp_aggressor + 1),

            (assign, ":shares", 0),
            (try_for_range, ":kingdom", kingdoms_begin, kingdoms_end),
                (store_sub, ":offset", ":kingdom", kingdoms_begin),
                (store_add, ":participant_slot", ":offset", slot_war_kingdom_participant_begin),
                (faction_get_slot, ":participant", ":war_storage", ":participant_slot"),
                (val_clamp, ":participant", swkp_defender, swkp_aggressor + 1),
                (eq, ":participant", ":target_participant"),

                (faction_get_slot, ":size", ":kingdom", slot_faction_num_fiefs),
                (val_add, ":shares", ":size"),
            (try_end),

            (try_for_range, ":kingdom", kingdoms_begin, kingdoms_end),
                (store_sub, ":offset", ":kingdom", kingdoms_begin),
                (store_add, ":participant_slot", ":offset", slot_war_kingdom_participant_begin),
                (faction_get_slot, ":participant", ":war_storage", ":participant_slot"),
                (val_clamp, ":participant", swkp_defender, swkp_aggressor + 1),
                (eq, ":participant", ":tributary_participant"),

                (try_for_range, ":other_kingdom", kingdoms_begin, kingdoms_end),

                    (store_sub, ":other_offset", ":other_kingdom", kingdoms_begin),
                    (store_add, ":other_participant_slot", ":other_offset", slot_war_kingdom_participant_begin),
                    (faction_get_slot, ":other_participant", ":war_storage", ":other_participant_slot"),
                    (val_clamp, ":other_participant", swkp_defender, swkp_aggressor + 1),
                    (eq, ":other_participant", ":target_participant"),

                    (assign, ":tribute_amount", 0),

                    (try_for_range, ":center_no", centers_begin, centers_end),
                        (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                        (eq, ":center_faction", ":tributary"),
                        (call_script, "script_party_get_expected_taxes", ":center_no"),
                        (val_add, ":tribute_amount", reg0),
                    (try_end),

                    (val_mul, ":tribute_amount", ":tribute_amount_baseline_value"),
                    (val_mul, ":tribute_amount", ":value"),
                    (val_div, ":tribute_amount", 100),
                    (try_begin),
                        (gt, ":shares", 0),

                        (faction_get_slot, ":size", ":other_kingdom", slot_faction_num_fiefs),
                        (val_mul, ":tribute_amount", ":size"),
                        (val_div, ":tribute_amount", ":shares"),
                    (try_end),

                    (call_script, "script_faction_create_temporary_treaty", ":kingdom", ":other_kingdom", sfkt_tribute, ":tribute_duration", ":tribute_amount"),
                (try_end),
            (try_end),
        ]),

    # script_faction_revoke_treaty
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: treaty_type
    ("faction_revoke_treaty",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":treaty_type", 3),

            (store_sub, ":offset", ":faction_2", kingdoms_begin),
            (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_treaties_begin),

            (assign, ":clearer_type", sfkt_none_treaty_clear),
            (assign, ":clear_other", 0),
            (try_begin),
                (this_or_next|eq, ":treaty_type", sfkt_truce),
                (this_or_next|eq, ":treaty_type", sfkt_non_agression),
                (this_or_next|eq, ":treaty_type", sfkt_defensive_alliance),
                (eq, ":treaty_type", sfkt_alliance),

                (assign, ":clearer_type", sfkt_military_treaty_clear),
                (assign, ":clear_other", 1),
            (else_try),
                (this_or_next|eq, ":treaty_type", sfkt_open_trade),
                (this_or_next|eq, ":treaty_type", sfkt_trade_preference),
                (eq, ":treaty_type", sfkt_trade_exclusivity),

                (assign, ":clearer_type", sfkt_economic_treaty_clear),
                (assign, ":clear_other", 1),
            (else_try),
                (this_or_next|eq, ":treaty_type", sfkt_vassal),
                (eq, ":treaty_type", sfkt_overlord),

                (assign, ":clearer_type", sfkt_vassal_treaty_clear),
                (try_begin),
                    (eq, ":treaty_type", sfkt_vassal),
                    (assign, ":clear_other", 1),
                (else_try),
                    (eq, ":treaty_type", sfkt_overlord),
                    (assign, ":clear_other", 1),
                (try_end),
            (try_end),

            (faction_get_slot, ":treaty", ":faction_1", ":treaty_slot"),
            (val_and, ":treaty", ":clearer_type"),
            (faction_set_slot, ":faction_1", ":treaty_slot", ":treaty"),

            (try_begin),
                (eq, ":clear_other", 1),

                (store_sub, ":other_offset", ":faction_1", kingdoms_begin),
                (store_add, ":other_treaty_slot", ":other_offset", slot_faction_kingdom_treaties_begin),

                (faction_get_slot, ":treaty", ":faction_2", ":other_treaty_slot"),
                (val_and, ":treaty", ":clearer_type"),
                (faction_set_slot, ":faction_2", ":other_treaty_slot", ":treaty"),
            (try_end),
        ]),

    # script_faction_set_treaty
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: treaty_type
    ("faction_set_treaty",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":treaty_type", 3),

            (store_sub, ":offset", ":faction_2", kingdoms_begin),
            (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_treaties_begin),

            (assign, ":clearer_type", sfkt_none_treaty_clear),
            (assign, ":other_treaty_type", sfkt_none),
            (try_begin),
                (this_or_next|eq, ":treaty_type", sfkt_truce),
                (this_or_next|eq, ":treaty_type", sfkt_non_agression),
                (this_or_next|eq, ":treaty_type", sfkt_defensive_alliance),
                (eq, ":treaty_type", sfkt_alliance),

                (assign, ":clearer_type", sfkt_military_treaty_clear),
                (assign, ":other_treaty_type", ":treaty_type"),
            (else_try),
                (this_or_next|eq, ":treaty_type", sfkt_open_trade),
                (this_or_next|eq, ":treaty_type", sfkt_trade_preference),
                (eq, ":treaty_type", sfkt_trade_exclusivity),

                (assign, ":clearer_type", sfkt_economic_treaty_clear),
                (assign, ":other_treaty_type", ":treaty_type"),
            (else_try),
                (this_or_next|eq, ":treaty_type", sfkt_vassal),
                (eq, ":treaty_type", sfkt_overlord),

                (assign, ":clearer_type", sfkt_vassal_treaty_clear),
                (try_begin),
                    (eq, ":treaty_type", sfkt_vassal),
                    (assign, ":other_treaty_type", sfkt_overlord),
                (else_try),
                    (eq, ":treaty_type", sfkt_overlord),
                    (assign, ":other_treaty_type", sfkt_vassal),
                (try_end),
            (try_end),

            (faction_get_slot, ":treaty", ":faction_1", ":treaty_slot"),
            (val_and, ":treaty", ":clearer_type"),
            (val_or, ":treaty", ":treaty_type"),
            (faction_set_slot, ":faction_1", ":treaty_slot", ":treaty"),

            (try_begin),
                (neq, ":other_treaty_type", sfkt_none),

                (store_sub, ":other_offset", ":faction_1", kingdoms_begin),
                (store_add, ":other_treaty_slot", ":other_offset", slot_faction_kingdom_treaties_begin),

                (faction_get_slot, ":treaty", ":faction_2", ":other_treaty_slot"),
                (val_and, ":treaty", ":clearer_type"),
                (val_or, ":treaty", ":other_treaty_type"),
                (faction_set_slot, ":faction_2", ":other_treaty_slot", ":other_treaty_type"),
            (try_end),
        ]),

    # script_faction_clear_treaty
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        #   arg3: clearer_type
        # output: none
    ("faction_clear_treaty",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),
            (store_script_param, ":clearer_type", 3),

            (store_sub, ":offset", ":faction_2", kingdoms_begin),
            (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_treaties_begin),

            (faction_get_slot, ":treaty", ":faction_1", ":treaty_slot"),
            (val_and, ":treaty", ":clearer_type"),
            (faction_set_slot, ":faction_1", ":treaty_slot", ":treaty"),

            (store_add, ":treaty_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),

            (faction_get_slot, ":treaty", ":faction_1", ":treaty_slot"),
            (val_and, ":treaty", ":clearer_type"),
            (faction_set_slot, ":faction_1", ":treaty_slot", ":treaty"),
        ]),

    # script_faction_get_treaties
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        # output:
        #   reg0: treaties
    ("faction_get_treaties",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),

            (store_sub, ":offset", ":faction_2", kingdoms_begin),
            (store_add, ":treaties_slot", ":offset", slot_faction_kingdom_treaties_begin),
            (store_add, ":treaties_temporary_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),
            (store_add, ":treaties_temporary_duration_slot", ":offset", slot_faction_kingdom_temporary_treaties_duration_begin),

            (faction_get_slot, ":treaties", ":faction_1", ":treaties_slot"),
            (faction_get_slot, ":treaties_temporary", ":faction_1", ":treaties_temporary_slot"),
            (faction_get_slot, ":treaties_temporary_duration", ":faction_1", ":treaties_temporary_duration_slot"),

            (try_begin),
                (gt, ":treaties_temporary_duration", 0),
                (call_script, "script_get_current_day"),
                (lt, reg0, ":treaties_temporary_duration"),

                (store_or, ":treaties", ":treaties", ":treaties_temporary"),
            (try_end),

            (assign, reg0, ":treaties"),
        ]),

    # script_party_spawn_bandits
        # input:
        #   arg1: center_no
        # output:
        #   reg0: bandit_party
        #   reg1: bandit_faction
    ("party_spawn_bandits",
        [
            (store_script_param, ":center_no", 1),

            (party_get_slot, ":center_original_faction", ":center_no", slot_party_original_faction),
            (faction_get_slot, ":center_culture", ":center_original_faction", slot_faction_culture),
            (party_get_current_terrain, ":terrain", ":center_no"),
            (party_get_slot, ":center_prosperity", ":center_no", slot_party_prosperity),
            
            (assign, ":bandit_party", -1),
            (assign, ":bandit_faction", -1),
            (assign, ":bandit_leader", -1),

            # Roll bandit strength
            (assign, ":bandit_chance", 2),
            (assign, ":max_strength", 4),
            (try_begin),
                # High prosperity will increase the max strength of bandits -- up to 3
                (store_div, ":strength_change", ":center_prosperity", 30),
                (val_add, ":max_strength", ":strength_change"),
            (try_end),
            (store_random_in_range, ":bandit_strength", -5, ":max_strength"),

            # Low prosperity will increase the chance of having bandits
            (store_sub, ":chance_modifier", 100, ":center_prosperity"),
            (val_div, ":chance_modifier", 10),
            (val_add, ":bandit_chance", ":chance_modifier"),

            (party_get_slot, ":population", ":center_no", slot_party_population),
            (party_get_slot, ":artisan", ":center_no", slot_party_population_artisan),
            (party_get_slot, ":nobles", ":center_no", slot_party_population_noble),
            (val_add, ":population", ":artisan"),
            (val_add, ":population", ":nobles"),
            (party_get_slot, ":slave_population", ":center_no", slot_party_population_slave),
            (assign, ":slave_ratio", 0),
            (try_begin),
                (gt, ":population", 0),
                (store_mul, ":slave_ratio", ":slave_population", 100),
                (val_div, ":slave_ratio", ":population"),
            (try_end),
            (try_begin),
                # Slaves increase banditry in the region
                (gt, ":slave_ratio", 0),
                (store_mul, ":slave_chance_ratio", ":bandit_chance", ":slave_ratio"),
                (store_div, ":slave_chance_modifier", ":slave_chance_ratio", 100),
                (store_mod, ":slave_chance_offset", ":slave_chance_modifier", 100),
                (store_random_in_range, ":rand", 0, 100),
                (try_begin),
                    (le, ":rand", ":slave_chance_offset"),
                    (val_add, ":slave_chance_modifier", 1),
                (try_end),
                (val_add, ":bandit_chance", ":slave_chance_modifier"),

                (store_mul, ":slave_strength_ratio", ":bandit_strength", ":slave_ratio"),
                (store_div, ":slave_strength_modifier", ":slave_strength_ratio", 100),
                (store_mod, ":slave_strength_offset", ":slave_strength_modifier", 100),
                (store_random_in_range, ":rand", 0, 100),
                (try_begin),
                    (lt, ":rand", ":slave_strength_offset"),
                    (val_add, ":slave_strength_modifier", 1),
                (try_end),
                (val_add, ":bandit_strength", ":slave_strength_modifier"),
            (try_end),

            (store_random_in_range, ":rand", 0, 1000),
            (try_begin),
                (le, ":bandit_chance", ":rand"),
                # (assign, ":bandit_strength", 0),
                (assign, ":desert_bandit", 0),
                (assign, ":plain_bandit", 0),
                (assign, ":forest_bandit", 0),
                (assign, ":mountain_bandit", 0),
                (assign, ":steppe_bandit", 0),
                (assign, ":tundra_bandit", 0),
                (assign, ":sea_raiders", 0),

                (try_begin),
                    (eq, ":terrain", rt_plain),
                    # More likely to spawn normal bandits
                    (val_add, ":plain_bandit", 20),
                (else_try),
                    (eq, ":terrain", rt_steppe),
                    (val_add, ":steppe_bandit", 20),
                (else_try),
                    (eq, ":terrain", rt_snow),
                    (val_add, ":tundra_bandit", 20),
                (else_try),
                    (eq, ":terrain", rt_desert),
                    (val_add, ":desert_bandit", 20),
                (try_end),
                # Also use nearby tiles ?
                # Or village production ?

                (try_begin),
                    (eq, ":center_culture", fac_culture_1),
                    (val_add, ":plain_bandit", 10),
                    (val_add, ":forest_bandit", 10),
                (else_try),
                    (eq, ":center_culture", fac_culture_2),
                    (val_add, ":tundra_bandit", 10),
                    (val_add, ":mountain_bandit", 5),
                (else_try),
                    (eq, ":center_culture", fac_culture_3),
                    (val_add, ":steppe_bandit", 10),
                (else_try),
                    (eq, ":center_culture", fac_culture_4),
                    (val_add, ":sea_raiders", 20),
                    (val_add, ":forest_bandit", 5),
                (else_try),
                    (eq, ":center_culture", fac_culture_5),
                    (val_add, ":mountain_bandit", 40),
                    (val_add, ":forest_bandit", 5),
                (else_try),
                    (eq, ":center_culture", fac_culture_6),
                    (val_add, ":desert_bandit", 10),
                (try_end),

                (store_add, ":grand_total", ":plain_bandit", ":forest_bandit"),
                (val_add, ":grand_total", ":mountain_bandit"),
                (val_add, ":grand_total", ":tundra_bandit"),
                (val_add, ":grand_total", ":steppe_bandit"),
                (val_add, ":grand_total", ":desert_bandit"),
                (val_add, ":grand_total", ":sea_raiders"),
                
                (store_random_in_range, ":rest", 0, ":grand_total"),
                (val_sub, ":rest", ":forest_bandit"),
                (try_begin),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_1"),
                    (assign, ":bandit_leader", "trp_bandit_forest_leader"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":plain_bandit"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_2"),
                    (assign, ":bandit_leader", "trp_bandit_leader"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":mountain_bandit"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_3"),
                    (assign, ":bandit_leader", "trp_bandit_mountain_chieftain"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":sea_raiders"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_4"),
                    (assign, ":bandit_leader", "trp_bandit_sea_captain"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":steppe_bandit"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_5"),
                    (assign, ":bandit_leader", "trp_bandit_steppe_chief"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":tundra_bandit"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_6"),
                    (assign, ":bandit_leader", "trp_bandit_taiga_chieftain"),
                (else_try),
                    (store_sub, ":rest", ":rest", ":desert_bandit"),
                    (lt, ":rest", 0),
                    (assign, ":bandit_faction", "fac_faction_7"),
                    (assign, ":bandit_leader", "trp_bandit_desert_chief"),
                (try_end),

                (try_begin),
                    (neq, ":bandit_faction", -1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_ai),
                        (str_store_party_name, s10, ":center_no"),
                        (display_message, "@Spawning bandit party at {s10}."),
                    (try_end),
                    (call_script, "script_spawn_party_around_party", ":center_no", "pt_outlaws"),
                    (assign, ":bandit_party", reg0),
                    (party_set_faction, ":bandit_party", ":bandit_faction"),

                    (party_set_slot, ":bandit_party", slot_party_type, spt_bandit),
                    (party_set_ai_behavior, ":bandit_party", ai_bhvr_patrol_location),

                    (val_max, ":bandit_strength", 1),
                    
                    (store_random_in_range, ":chance_leader", 0, 100),
                    (try_begin),
                        # Chance for a bandit leader
                        (le, ":chance_leader", 10),
                        (neq, ":bandit_leader", -1),
                        (party_add_members, ":bandit_party", ":bandit_leader", 1),
                        (val_add, ":bandit_strength", 3),
                    # (else_try),
                        # Need to count so that not too many heroes are present before adding a new one
                        # Possibly needs to increase odds if there are few heroes
                        # Chance for a bandit hero if no leader
                        #(eq, ":chance_leader", 99),
                    (try_end),

                    (try_for_range, ":unused", 0, ":bandit_strength"),
                        (call_script, "script_party_add_reinforcements", ":bandit_party"),
                        # (assign, ":num_added", reg0),
                        # (try_begin),
                        #     (eq, ":num_added", 0),
                        #     (val_add, ":bandit_strength", 1),
                        # (try_end),
                    (try_end),
                (try_end),
            (try_end),

            (assign, reg0, ":bandit_party"),
            (assign, reg1, ":bandit_faction"),
        ]),

    # script_party_take_troop_prisoner
        # input:
        #   arg1: party_id
        #   arg2: troop_id
        #   arg3: from_party
        # output: none
    ("party_take_troop_prisoner",
        [
            (store_script_param, ":party_id", 1),
            (store_script_param, ":troop_id", 2),
            (store_script_param, ":from_party", 3),
            (store_script_param, ":amount", 4),

            (try_begin),
                (troop_is_hero, ":troop_id"),
                (call_script, "script_troop_taken_prisoner", ":troop_id", ":party_id"),
                (assign, ":amount", 1),
                (party_force_add_prisoners, ":party_id", ":troop_id", ":amount"),

                (store_faction_of_party, ":party_faction", ":party_id"),
                (call_script, "script_faction_political_event_vassal_captured", ":party_faction", ":troop_id", ":party_id"),
            (else_try),
                (party_add_prisoners, ":party_id", ":troop_id", ":amount"),
            (try_end),
            (try_begin),
                (ge, ":from_party", 0),
                (party_remove_members, ":from_party", ":troop_id", ":amount"),
            (try_end),
        ]),

    # script_troop_taken_prisoner
        # input:
        #   arg1: troop_id
        #   arg2: prisoner_of_party
        # output: none
    ("troop_taken_prisoner",
        [
            (store_script_param, ":troop_id", 1),
            (store_script_param, ":party_no", 2),

            (troop_set_slot, ":troop_id", slot_troop_prisoner_of, ":party_no"),
            (troop_set_slot, ":troop_id", slot_troop_gathering, -1), # Stop gathering when defeated
        ]),

    # script_troop_freed
        # input: 
        #   arg1: troop_id
        #   arg2: freeing_party
        # output: none
    ("troop_freed",
        [
            (store_script_param, ":troop_id", 1),
            (store_script_param, ":party_no", 2),

            (try_begin),
                # Remove troop for party id if not already done
                (troop_get_slot, ":prisoner_of", ":troop_id", slot_troop_prisoner_of),
                (ge, ":prisoner_of", 0),
                (party_is_active, ":prisoner_of"),
                (party_remove_prisoners, ":prisoner_of", ":troop_id", 1),
            (try_end),

            (troop_set_slot, ":troop_id", slot_troop_prisoner_of, -1),
            # (troop_set_slot, ":troop_id", slot_troop_prisoner_in, -1),

            (assign, ":party_faction", -1),
            (try_begin),
                (ge, ":party_no", 0),
                (store_faction_of_party, ":party_faction", ":party_no"),
            (try_end),
            (call_script, "script_faction_political_event_vassal_freed", ":party_faction", ":troop_id", ":party_no"),
        ]),

    # script_troop_released
        # input:
        #   arg1: troop_id
        # output: none
    ("troop_released", 
        [
            (store_script_param, ":troop_id", 1),

            (call_script, "script_troop_freed", ":troop_id", -1),
        ]),

    # script_troop_proficiency_decay
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_proficiency_decay",
        [
            (store_script_param, ":troop_no", 1),

            (store_skill_level, ":weap_master", skl_weapon_master, ":troop_no"),
            (store_mul, ":wp_limit", ":weap_master", 10),
            (store_add, ":wp_div", 15, ":weap_master"), # Weapon master increases the threshold
            (val_add, ":wp_limit", 20), # Min 20, max 120
            # ToDo: Increase the wp loss when older ?
            (try_for_range, ":att", wpt_one_handed_weapon, wpt_firearm+1),
                (store_proficiency_level, ":wp", ":troop_no", ":att"),
                (store_sub, ":diff", ":wp", ":wp_limit"),
                (store_div, ":wp_loss", ":diff", ":wp_div"), # Loses from 6.666% to 4% every month
                (store_mod, ":top", ":diff", ":wp_div"),
                (store_random_in_range, ":rand", 0, ":wp_div"),
                (try_begin),
                    (gt, ":top", ":rand"),
                    (val_add, ":wp_loss", 1),
                (try_end),
                (gt, ":wp_loss", 0),
                (try_begin),
                    (call_script, "script_cf_debug", debug_all),
                    (str_store_troop_name, s10, ":troop_no"),
                    (try_begin),
                        (eq, ":att", wpt_one_handed_weapon),
                        (str_store_string, s11, "@One Handed Weapons"),
                    (else_try),
                        (eq, ":att", wpt_two_handed_weapon),
                        (str_store_string, s11, "@Two Handed Weapons"),
                    (else_try),
                        (eq, ":att", wpt_polearm),
                        (str_store_string, s11, "@Pole Weapons"),
                    (else_try),
                        (eq, ":att", wpt_archery),
                        (str_store_string, s11, "@Archery"),
                    (else_try),
                        (eq, ":att", wpt_crossbow),
                        (str_store_string, s11, "@Crossbows"),
                    (else_try),
                        (eq, ":att", wpt_throwing),
                        (str_store_string, s11, "@Throwing Weapons"),
                    (else_try),
                        (str_store_string, s11, "@Firearms"),
                    (try_end),
                    (assign, reg10, ":wp_loss"),
                    (display_message, "@{s10} lost {reg10} proficiency points in {s11}"),
                (try_end),
                (val_mul, ":wp_loss", -1),
                (troop_raise_proficiency_linear, ":troop_no", ":att", ":wp_loss"),
            (try_end),
        ]),

    # script_troop_is_in_family_of
        # input: 
        #   arg1: troop_1
        #   arg2: troop_2
        #   arg3: num_moves
        # output:
        #   reg0: found_depth : the depths at which the family member has been found -1 if not found
        # The script is used to find family members that are not in the same house
        # The script might be ressource intensive, and should be used if possible only during menus and with a low number of moves
    ("troop_is_in_family_of",
        [
            (store_script_param, ":troop_1", 1),
            (store_script_param, ":troop_2", 2),
            (store_script_param, ":num_moves", 3),

            (assign, ":found", -1),
            (try_begin),
                (gt, ":num_moves", 0),
                (assign, ":found", -1),
                (store_add, ":end", slot_troop_child_10, 1),
                (try_for_range, ":family_slot", slot_troop_married_to, ":end"),
                    (troop_get_slot, ":family_member", ":troop_1", ":family_slot"),
                    (try_begin),
                        (eq, ":family_member", ":troop_2"),
                        (assign, ":found", 1),
                        (assign, ":end", 0),
                    (try_end),
                (try_end),
                (try_begin),
                    (eq, ":found", -1),
                    (store_add, ":end", slot_troop_child_10, 1),
                    (store_sub, ":decreased_moves", ":num_moves", 1),
                    (try_for_range, ":family_slot", slot_troop_married_to, ":end"),
                        (troop_get_slot, ":family_member", ":troop_1", ":family_slot"),
                        (ge, ":family_member", 0),
                        (call_script, "script_troop_is_in_family_of", ":family_member", ":troop_2", ":decreased_moves"),
                        (assign, ":ret", reg0),
                        (try_begin),
                            (ge, ":ret", 0),
                            (assign, ":end", 0),
                            (store_add, ":found", ":ret", 1),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),
            (assign, reg0, ":found"),
        ]),

    # script_party_process_buildings
        # input:
        #   arg1: party_no
        #   arg2: time_interval
        # output: none
    ("party_process_buildings",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":interval", 2),

            (party_get_slot, ":leader", ":party_no", slot_party_leader),

            # (party_get_slot, ":cur_gold", ":party_no", slot_party_wealth),
            # (party_get_slot, ":cur_stone", ":party_no", "itm_stone"),
            # (party_get_slot, ":cur_wood", ":party_no", "itm_wood"),

            # Process buildings construction time
            (try_for_range, ":building_slot", slot_party_building_slot_1, slot_party_building_slot_end),
                (party_get_slot, ":building", ":party_no", ":building_slot"),
                (is_between, ":building", center_buildings_begin, center_buildings_end),

                (store_add, ":slot", ":building_slot", num_building_slots),
                (party_get_slot, ":state", ":party_no", ":slot"),

                # (item_get_slot, ":wood_cost", ":building", slot_building_cost_wood),
                # # (item_get_slot, ":stone_cost", ":building", slot_building_cost_stone),
                # (item_get_slot, ":gold_cost", ":building", slot_building_cost_gold),
                (item_get_slot, ":time", ":building", slot_building_build_time),

                # (store_mul, ":wood_added", ":wood_cost", 100),
                # (val_div, ":wood_added", ":interval"),

                # (store_mul, ":stone_added", ":stone_cost", 100),
                # (val_div, ":stone_added", ":interval"),

                # (store_mul, ":gold_added", ":gold_cost", 100),
                # (val_div, ":gold_added", ":interval"),

                (try_begin),

                    (store_mul, ":time_added", ":time", 100),
                    (val_div, ":time_added", ":interval"),

                    (try_begin),
                        # Building not constructed
                        # Drains ressources
                        (lt, ":state", 0),

                        (try_begin),
                            (val_add, ":state", ":time_added"),
                            (try_begin),
                                (ge, ":state", 0),
                                (assign, ":state", 50),
                                (try_begin),
                                    (this_or_next|call_script, "script_cf_debug", debug_economy|debug_simple),
                                    (eq, ":leader", "$g_player_troop"),
                                    (str_store_party_name_link, s10, ":party_no"),
                                    (str_store_item_name, s11, ":building"),
                                    (display_log_message, "@{s10} has finished construction of {s11}."),
                                (try_end),
                            (try_end),
                            (party_set_slot, ":party_no", ":slot", ":state"),
                        (try_end),
                    (else_try),
                        # Building damaged
                        # Drains some ressources and barely works
                        (is_between, ":state", 0, 50),

                        (try_begin),
                            (val_div, ":time_added", 2),
                            (val_add, ":state", ":time_added"),

                            (try_begin),
                                (ge, ":state", 50),

                                (try_begin),
                                    (this_or_next|call_script, "script_cf_debug", debug_economy|debug_simple),
                                    (eq, ":leader", "$g_player_troop"),
                                    (str_store_party_name_link, s10, ":party_no"),
                                    (str_store_item_name, s11, ":building"),
                                    (display_log_message, "@{s10} has finished repairs of {s11}."),
                                (try_end),
                            (try_end),
                            (party_set_slot, ":party_no", ":slot", ":state"),
                        (try_end),
                    (else_try),
                        # Building just built or slightly damaged
                        # Drains no ressources and functions at reduced efficiency
                        (is_between, ":state", 50, 100),

                        (try_begin),
                            (val_div, ":time_added", 2),
                            (val_add, ":state", ":time_added"),

                            (val_min, ":state", 100),

                            (party_set_slot, ":party_no", ":slot", ":state"),
                        (try_end),
                    (try_end),
                (try_end),
            (try_end),

            # Process special building effects
        ]),

    # script_party_process_prisoners
        # input: 
        #   arg1: party_no
        # output: none
    ("party_process_prisoners",
        [
            (store_script_param, ":party_no", 1),

            (try_begin),
                (party_slot_eq, ":party_no", slot_party_besieged_by, -1),

                (party_get_num_prisoners, ":total_prisoners", ":party_no"),
                (party_get_num_companions, ":total_party_size", ":party_no"),

                (assign, ":remove_prisoners", 0),
                (try_begin),
                    (gt, ":total_party_size", 0),

                    (store_mul, ":ratio", ":total_prisoners", 100),
                    (val_div, ":ratio", ":total_party_size"),

                    (party_get_slot, ":max_prisoner_ratio", ":party_no", slot_party_max_prisoner_ratio),
                    (try_begin),
                        (gt, ":ratio", ":max_prisoner_ratio"),
                        (assign, ":remove_prisoners", 1),
                    (try_end),
                (else_try),
                    (assign, ":remove_prisoners", 1),
                (try_end),

                (try_begin),
                    (gt, ":remove_prisoners", 0),

                    (party_get_slot, ":party_type", ":party_no", slot_party_type),
                    (try_begin),
                        (eq, ":party_type", spt_village),
                        (assign, ":remove_prisoners", 3),
                    (else_try),
                        (eq, ":party_type", spt_castle),
                        (assign, ":remove_prisoners", 5),
                    (else_try),
                        (eq, ":party_type", spt_town),
                        (assign, ":remove_prisoners", 6),
                    (try_end),

                    (call_script, "script_party_get_max_prisoner_outcome", ":party_no"),
                    (assign, ":max_prisoner_outcome", reg0),

                    (store_and, ":ransom", ":max_prisoner_outcome", mpo_ransom),
                    (store_and, ":slave", ":max_prisoner_outcome", mpo_slave),
                    (store_and, ":exchange", ":max_prisoner_outcome", mpo_exchange),
                    (store_and, ":release", ":max_prisoner_outcome", mpo_release),
                    (store_and, ":recruit", ":max_prisoner_outcome", mpo_recruit),

                    (assign, ":max_rand", 0),
                    (assign, ":ransom_value", -1),
                    (assign, ":slave_value", -1),
                    (assign, ":exchange_value", -1),
                    (assign, ":release_value", -1),
                    (assign, ":recruit_value", -1),

                    (try_begin),
                        (gt, ":ransom", 0),
                        (assign, ":ransom_value", ":max_rand"),
                        (val_add, ":max_rand", 1),
                    (try_end),
                    (try_begin),
                        (gt, ":slave", 0),
                        (assign, ":slave_value", ":max_rand"),
                        (val_add, ":max_rand", 1),
                    (try_end),
                    (try_begin),
                        (gt, ":exchange", 0),
                        (assign, ":exchange_value", ":max_rand"),
                        (val_add, ":max_rand", 1),
                    (try_end),
                    (try_begin),
                        (gt, ":release", 0),
                        (assign, ":release_value", ":max_rand"),
                        (val_add, ":max_rand", 1),
                    (try_end),
                    (try_begin),
                        (gt, ":recruit", 0),
                        (assign, ":recruit_value", ":max_rand"),
                        (val_add, ":max_rand", 1),
                    (try_end),

                    # If all options are disabled we do not process prisoners
                    (gt, ":max_rand", 0),

                    (store_random_in_range, ":rand", 0, ":max_rand"),
                    (try_begin),
                        (eq, ":rand", ":ransom_value"),
                        (call_script, "script_party_process_prisoners_loop", ":party_no", ":remove_prisoners", "script_party_process_prisoners_ransom"),
                    (else_try),
                        (eq, ":rand", ":slave_value"),
                        (call_script, "script_party_process_prisoners_loop", ":party_no", ":remove_prisoners", "script_party_process_prisoners_slave"),
                    (else_try),
                        (eq, ":rand", ":exchange_value"),
                        (call_script, "script_party_process_prisoners_loop", ":party_no", ":remove_prisoners", "script_party_process_prisoners_exchange"),
                    (else_try),
                        (eq, ":rand", ":release_value"),
                        (call_script, "script_party_process_prisoners_loop", ":party_no", ":remove_prisoners", "script_party_process_prisoners_release"),
                    (else_try),
                        (eq, ":rand", ":recruit_value"),
                        (call_script, "script_party_process_prisoners_loop", ":party_no", ":remove_prisoners", "script_party_process_prisoners_recruit"),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # scruot_party_get_max_prisoner_outcome
        # input:
        #   arg1: party_no
        # output:
        #   reg0: outcome
    ("party_get_max_prisoner_outcome",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (try_begin),
                (eq, ":leader", "$g_player_troop"),
                (party_get_slot, reg0, ":party_no", slot_party_max_prisoner_outcome),
            (else_try),
                (assign, reg0, mpo_default),
            (try_end),
        ]),

    # script_party_process_prisoners_ransom
        # input: 
        #   arg1: party_no
        #   arg2: stack_no
        #   arg3: amount
        # output: none
    ("party_process_prisoners_ransom",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":stack_no", 2),
            (store_script_param, ":amount", 3),

            (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),
            (party_remove_prisoners, ":party_no", ":troop_no", ":amount"),

            (call_script, "script_troop_get_cost", ":troop_no"),
            (assign, ":cost", reg0),
            (val_mul, ":cost", 3),
            (val_div, ":cost", 2),

            (val_mul, ":cost", ":amount"),
            (call_script, "script_party_add_accumulated_taxes", ":party_no", ":cost", tax_type_prisoner_ransom),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":party_no"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":amount"),

                (display_message, "@{s10} ransoming {reg10} {s11}"),
            (try_end),
        ]),

    # script_party_process_prisoners_slave
        # input: 
        #   arg1: party_no
        #   arg2: stack_no
        #   arg3: amount
        # output: none
    ("party_process_prisoners_slave",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":stack_no", 2),
            (store_script_param, ":amount", 3),

            (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),

            (party_get_slot, ":num_slaves", ":party_no", slot_party_population_slave),
            (val_add, ":num_slaves", ":amount"),
            (party_set_slot, ":party_no", slot_party_population_slave, ":num_slaves"),
            (party_remove_prisoners, ":party_no", ":troop_no", ":amount"),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":party_no"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":amount"),

                (display_message, "@{s10} enslaving {reg10} {s11}"),
            (try_end),
        ]),

    # script_party_process_prisoners_exchange
        # input: 
        #   arg1: party_no
        #   arg2: stack_no
        #   arg3: amount
        # output: none
    ("party_process_prisoners_exchange",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":stack_no", 2),
            (store_script_param, ":amount", 3),

            (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":party_no"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":amount"),

                (display_message, "@{s10} exchanging {reg10} {s11}"),
            (try_end),
        ]),

    # script_party_process_prisoners_release
        # input: 
        #   arg1: party_no
        #   arg2: stack_no
        #   arg3: amount
        # output: none
    ("party_process_prisoners_release",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":stack_no", 2),
            (store_script_param, ":amount", 3),

            (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),
            (party_remove_prisoners, ":party_no", ":troop_no", ":amount"),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":party_no"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":amount"),

                (display_message, "@{s10} releasing {reg10} {s11}"),
            (try_end),
        ]),

    # script_party_process_prisoners_recruit
        # input: 
        #   arg1: party_no
        #   arg2: stack_no
        #   arg3: amount
        # output: none
    ("party_process_prisoners_recruit",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":stack_no", 2),
            (store_script_param, ":amount", 3),

            (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),

            (party_force_add_members, ":party_no", ":troop_no", ":amount"),
            (party_remove_prisoners, ":party_no", ":troop_no", ":amount"),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":party_no"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":amount"),

                (display_message, "@{s10} recruiting {reg10} {s11}"),
            (try_end),
        ]),

    # script_party_process_prisoners_loop
        # input: 
        #   arg1: party_no
        #   arg2: amount
        # output: none
    ("party_process_prisoners_loop",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":amount", 2),
            (store_script_param, ":process_script", 3),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (faction_get_slot, ":party_culture", ":party_faction", slot_faction_culture),

            (party_get_num_prisoner_stacks, ":max_stack", ":party_no"),

            (assign, ":current_score", 0),

            (try_for_range, ":stack_no", 0, ":max_stack"),
                (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),
                (party_prisoner_stack_get_size, ":size", ":party_no", ":stack_no"),

                (try_begin),
                    (troop_is_hero, ":troop_no"),
                    (troop_set_slot, ":troop_no", slot_troop_temp_slot, 0),
                (else_try),

                    (store_character_level, ":troop_level", ":troop_no"),
                    (store_sub, ":score", 50, ":troop_level"),

                    (store_sub, ":size_sub", 50, ":size"),
                    (val_sub, ":score", ":size_sub"),

                    (store_troop_faction, ":troop_faction", ":troop_no"),
                    (faction_get_slot, ":troop_culture", ":troop_faction", slot_faction_culture),

                    (try_begin),
                        (neq, ":troop_culture", ":party_culture"),
                        (val_add, ":score", 25),
                    (try_end),

                    (val_max, ":score", 1),
                    (troop_set_slot, ":troop_no", slot_troop_temp_slot, ":current_score"),
                    (val_add, ":current_score", ":score"),
                (try_end),
            (try_end),

            (try_for_range, ":unused", 0, ":amount"),
                (store_random_in_range, ":rand", 0, ":current_score"),
                (party_get_num_prisoner_stacks, ":end", ":party_no"),
                (assign, ":begin", 0),
                (try_for_range_backwards, ":cur_stack", ":begin", ":end"),
                    (party_prisoner_stack_get_troop_id, ":troop_no", ":party_no", ":cur_stack"),
                    (neg|troop_is_hero, ":troop_no"),
                    (troop_get_slot, ":score", ":troop_no", slot_troop_temp_slot),
                    (gt, ":rand", ":score"),
                    (assign, ":begin", ":end"),
                    (call_script, ":process_script", ":party_no", ":cur_stack", 1),
                (try_end),
            (try_end),
        ]),

    # script_troop_change_renown
        # input: 
        #   arg1: troop_id
        #   arg2: amount
        # output: 
        #   reg0: new_renown
    ("troop_change_renown",
        [
            (store_script_param, ":troop_id", 1),
            (store_script_param, ":amount", 2),

            (troop_get_slot, ":current", ":troop_id", slot_troop_renown),

            (assign, ":subsctractor", 0),
            (try_begin),
                (gt, ":current", 50),
                (set_fixed_point_multiplier, 1),
                (store_sqrt, ":subsctractor", ":current"),
                (store_sqrt, ":subsctractor", ":subsctractor"),
                (val_sub, ":subsctractor", 2),
            (try_end),

            (store_sub, ":real_change", ":amount", ":subsctractor"),
            (try_begin),
                (le, ":real_change", 0),
                (store_random_in_range, ":rand", ":real_change", ":amount"),
                (gt, ":rand", 0),
                (assign, ":real_change", 1),
            (try_end),

            (assign, ":new", ":current"),
            (try_begin),
                (gt, ":real_change", 0),
                (store_add, ":new", ":current", ":real_change"),
                (val_max, ":new", 0),
                (troop_set_slot, ":troop_id", slot_troop_renown, ":new"),

                (try_begin),
                    (this_or_next|eq, ":troop_id", "$g_player_troop"),
                    (call_script, "script_cf_debug", debug_faction),
                    (assign, reg10, ":current"),
                    (assign, reg11, ":new"),
                    (assign, reg12, ":amount"),
                    (str_store_troop_name, s10, ":troop_id"),
                    (display_message, "@{s10} renown changed from {reg10} to {reg11} ({reg12})."),
                (try_end),
            (try_end),

            (assign, reg0, ":new"),
        ]),

    # script_troop_change_honor
        # input: 
        #   arg1: troop_id
        #   arg2: amount
        # output: 
        #   reg0: new_honor
    ("troop_change_honor", 
        [
            (store_script_param, ":troop_id", 1),
            (store_script_param, ":amount", 2),

            (troop_get_slot, ":current", ":troop_id", slot_troop_honor),
            (store_add, ":new", ":current", ":amount"),
            (val_clamp, ":new", 0, 101),

            (troop_set_slot, ":troop_id", slot_troop_honor, ":new"),

            (try_begin),
                (this_or_next|eq, ":troop_id", "$g_player_troop"),
                (call_script, "script_cf_debug", debug_all),
                (call_script, "script_cf_debug", debug_simple),
                (assign, reg10, ":current"),
                (assign, reg11, ":new"),
                (display_message, "@Honor changed from {reg10} to {reg11}."),
            (try_end),

            (assign, reg0, ":new"),
        ]),

    # script_troop_change_wealth
        # input:
        #   arg1: troop_no
        #   arg2: amount
        # output:
        #   reg0: new_wealth
    ("troop_change_wealth",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":amount", 2),

            (troop_add_gold, ":troop_no", ":amount"),
            (store_troop_gold, reg0, ":troop_no"),
        ]),

    # script_party_change_morale
        # input: 
        #   arg1: party_id
        #   arg2: amount
        # output: 
        #   reg0: new_morale
    ("party_change_morale", 
        [
            (store_script_param, ":party_id", 1),
            (store_script_param, ":amount", 2),

            (party_get_slot, ":current", ":party_id", slot_party_morale),
            (store_add, ":new", ":current", ":amount"),
            (val_clamp, ":new", 0, 101),

            (party_set_slot, ":party_id", slot_party_morale, ":new"),

            # (try_begin),
            #     (this_or_next|eq, ":party_id", "$g_player_party"),
            #     (call_script, "script_cf_debug", debug_war),
            #     (call_script, "script_cf_debug", debug_simple|debug_war),
            #     (assign, reg10, ":current"),
            #     (assign, reg11, ":new"),
            #     (str_store_party_name, s10, ":party_id"),
            #     (display_message, "@{s10} morale changed from {reg10} to {reg11}."),
            # (try_end),

            (assign, reg0, ":new"),
        ]),

    # script_agent_init_morale_values
        # input:
        #   arg1: agent_no
        # output: none
    ("agent_init_morale_values",
        [
            (store_script_param, ":agent_no", 1),

            (agent_get_party_id, ":party", ":agent_no"),
            (try_begin),
                (ge, ":party", 0),
                (party_get_slot, ":party_morale", ":party", slot_party_morale),
                (agent_set_slot, ":agent_no", slot_agent_morale, ":party_morale"),

                (call_script, "script_agent_get_morale_modifiers", ":agent_no"),
                (assign, ":morale_modifier", reg0),
                (agent_set_slot, ":agent_no", slot_agent_morale_modifier, ":morale_modifier"),

                # Add leader bonuses + troop bonuses
            (try_end),
        ]),

    # script_agent_update_morale_values
        # input:
        #   arg1: agent_no
        # output: none
    ("agent_update_morale_values",
        []),

    # script_agent_get_morale_modifiers
        # input:
        #   arg1: agent_no
        # output: 
        #   reg0: morale_value
    ("agent_get_morale_modifiers",
        [
            (assign, reg0, 0),
        ]),

    # script_party_pay_wages
        # input:
        #   arg1: party_no
        #   arg2: amount_paid
        # output:
        #   reg0: paid_wages
    ("party_pay_wages",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":amount_paid", 2),

            (assign, ":paid_wages", 0),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (try_begin),
                (is_between, ":party_type", spt_bandit, spt_fort + 1),

                (call_script, "script_party_get_wages", ":party_no"),
                (assign, ":party_wages", reg0),
                (try_begin),
                    (eq, ":amount_paid", -1),
                    (assign, ":amount_paid", ":party_wages"),
                (try_end),

                (try_begin),
                    (eq, ":party_no", "$g_player_party"),
                    (troop_remove_gold, ":party_no", ":amount_paid"),
                    (assign, ":paid_wages", ":amount_paid"),
                (else_try),
                    (is_between, ":party_type", spt_village, spt_fort + 1),
                    # Only centers pay wages directly
                    # The rest is accumulated in debts

                    (store_mul, ":party_wages_payment", ":amount_paid", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":party_wages_payment", tax_type_wages),
                    # (call_script, "script_party_remove_gold", ":party_no", ":party_wages"),
                    (assign, ":paid_wages", ":amount_paid"),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (eq, ":party_type", spt_war_party),
                        (str_store_party_name, s10, ":party_no"),
                        (assign, reg10, ":party_wages"),
                        (assign, reg11, ":paid_wages"),
                        (display_message, "@{s10} paying wages: {reg10} - total paid: {reg11}"),
                    (try_end),
                (try_end),

                (try_begin),
                    (neq, ":amount_paid", ":party_wages"),
                    (store_sub, ":unpaid_wages", ":party_wages", ":paid_wages"),
                    (call_script, "script_party_unpaid_wages_penalties", ":party_no", ":unpaid_wages", ":party_wages"),
                (try_end),
            (try_end),

            (assign, reg0, ":paid_wages"),
        ]),

    # script_party_pay_debts
        # input:
        #   arg1: party_no
        # output:
        #   reg0: paid_debts
    ("party_pay_debts",
        [
            (store_script_param, ":party_no", 1),

            (assign, ":paid_debts", 0),

            (party_get_slot, ":unpaid_wages", ":party_no", slot_party_unpaid_wages),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (gt, ":unpaid_wages", 0),
                (call_script, "script_party_get_total_wealth", ":party_no", 1),
                (assign, ":wealth", reg0),
                (try_begin),
                    (gt, ":wealth", 0),
                    (store_div, ":max_payment", ":wealth", 2),

                    (try_begin),
                        (is_between, ":party_type", spt_village, spt_fort + 1),
                        (store_div, ":max_payment", ":wealth", 5),
                    (try_end),

                    (val_min, ":max_payment", ":unpaid_wages"),

                    (store_mul, ":payment", ":max_payment", -1),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":payment", tax_type_debts),
                    (val_sub, ":unpaid_wages", ":max_payment"),
                    (val_add, ":paid_debts", ":max_payment"),
                (try_end),
                (try_begin),
                    (gt, ":unpaid_wages", 0),
                    (is_between, ":party_type", spt_civilian, spt_village), # Only mobile parties
                    (party_get_slot, ":linked_party", ":party_no", slot_party_linked_party),
                    (gt, ":linked_party", 0),
                    (party_get_attached_to, ":attached", ":party_no"),
                    (eq, ":attached", ":linked_party"),
                    (call_script, "script_party_transfer_wealth", ":attached", ":party_no", ":unpaid_wages", tax_type_late_wages, tax_type_late_wages),
                    (assign, ":unpaid_wages", 0),
                (try_end),
                (party_set_slot, ":party_no", slot_party_unpaid_wages, ":unpaid_wages"),
            (try_end),

            (assign, reg0, ":paid_debts"),
        ]),

    # script_party_process_debts
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_debts",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (try_begin),
                (is_between, ":party_type", spt_village, spt_fort + 1),

                (party_get_slot, ":wealth", ":party_no", slot_party_wealth),
                (party_get_slot, ":unpaid_wages", ":party_no", slot_party_unpaid_wages),

                (store_sub, ":total_debts", 0, ":unpaid_wages"),
                (try_begin),
                    (lt, ":wealth", 0),
                    (val_add, ":total_debts", ":wealth"),
                (try_end),
                (try_begin),
                    (lt, ":total_debts", 0),
                    # Debts accumulate at a rate of 1%
                    (store_div, ":debt_interests", ":total_debts", 100),
                    (lt, ":debt_interests", 0),
                    (call_script, "script_party_add_accumulated_taxes", ":party_no", ":debt_interests", tax_type_debts),
                (try_end),
            (try_end),
        ]),

    # script_party_get_total_wealth
        # input: 
        #   arg1: party_no
        #   arg2: ignore_debts
        # output:
        #   reg0: total_wealth
    ("party_get_total_wealth", 
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":ignore_debts", 2),

            (assign, ":total_wealth", 0),
            
            (party_get_slot, ":party_wealth", ":party_no", slot_party_wealth),
            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),

            (try_begin),
                (this_or_next|ge, ":party_wealth", 0),
                (eq, ":ignore_debts", 0),

                (val_add, ":total_wealth", ":party_wealth"),
            (try_end),

            (try_begin),
                (gt, ":leader", 0),

                (troop_get_slot, ":leader_party", ":leader", slot_troop_leaded_party),
                (ge, ":leader_party", 0),
                (party_get_attached_to, ":attached_to", ":leader_party"),

                # Leader is either leading the party or is waiting inside
                (this_or_next|eq, ":leader_party", ":party_no"),
                (eq, ":attached_to", ":party_no"),

                (store_troop_gold, ":leader_wealth", ":leader"),

                (this_or_next|ge, ":leader_wealth", 0),
                (eq, ":ignore_debts", 0),

                (val_add, ":total_wealth", ":leader_wealth"),
            (try_end),

            (try_begin),
                (is_between, ":party_type", spt_caravan, spt_convoy + 1),
                (party_get_attached_to, ":attached_party", ":party_no"),
                (party_get_slot, ":linked_center", ":party_no", slot_party_linked_party),
                (ge, ":linked_center", centers_begin),
                (eq, ":linked_center", ":attached_party"),
                (party_get_slot, ":center_wealth", ":linked_center", slot_party_wealth),

                (this_or_next|ge, ":center_wealth", 0),
                (eq, ":ignore_debts", 0),

                (val_add, ":total_wealth", ":center_wealth"),
            (try_end),

            (try_begin),
                (eq, ":ignore_debts", 0),
                (party_get_slot, ":debts", ":party_no", slot_party_unpaid_wages),
                (val_sub, ":total_wealth", ":debts"),
            (try_end),

            (assign, reg0, ":total_wealth"),
        ]),

    # script_party_remove_gold
        # input:
        #   arg1: party_no
        #   arg2: gold_amount
        # output: 
        #   reg0: gold_removed
    ("party_remove_gold", 
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":amount", 2),

            (assign, ":gold_removed", 0),
            (try_begin),
                (party_get_slot, ":party_wealth", ":party_no", slot_party_wealth),
                (party_get_slot, ":leader", ":party_no", slot_party_leader),
                (party_get_slot, ":party_type", ":party_no", slot_party_type),
                
                (gt, ":amount", 0),
                (try_begin),
                    (gt, ":party_wealth", 0),
                    (assign, ":gold_removed", ":amount"),
                    (val_min, ":gold_removed", ":party_wealth"),
                    (val_sub, ":party_wealth", ":gold_removed"),
                    (party_set_slot, ":party_no", slot_party_wealth, ":party_wealth"),
                    (val_sub, ":amount", ":gold_removed"),
                (try_end),

                (gt, ":amount", 0),
                (try_begin),
                    (ge, ":leader", 0),

                    (troop_get_slot, ":leader_party", ":leader", slot_troop_leaded_party),
                    (ge, ":leader_party", 0),
                    (party_get_attached_to, ":attached_to", ":leader_party"),

                    # Leader is either leading the party or is waiting inside
                    (this_or_next|eq, ":leader_party", ":party_no"),
                    (eq, ":attached_to", ":party_no"),

                    (store_troop_gold, ":leader_wealth", ":leader"),
                    (gt, ":leader_wealth", 0),
                    (assign, ":gold_removed_leader", ":amount"),
                    (val_min, ":gold_removed_leader", ":leader_wealth"),
                    (troop_remove_gold, ":leader", ":gold_removed_leader"),
                    (val_sub, ":amount", ":gold_removed_leader"),
                    (val_add, ":gold_removed", ":gold_removed_leader"),
                (try_end),

                (gt, ":amount", 0),
                (try_begin),
                    (is_between, ":party_type", spt_caravan, spt_convoy + 1),
                    (party_get_attached_to, ":attached_party", ":party_no"),
                    (party_get_slot, ":linked_center", ":party_no", slot_party_linked_party),
                    (ge, ":linked_center", centers_begin),
                    (eq, ":linked_center", ":attached_party"),
                    (party_get_slot, ":center_wealth", ":linked_center", slot_party_wealth),
                    (gt, ":center_wealth", 0),
                    (assign, ":gold_removed_center", ":amount"),
                    (val_min, ":gold_removed_center", ":center_wealth"),
                    (val_sub, ":center_wealth", ":gold_removed_center"),
                    (party_set_slot, ":linked_center", slot_party_wealth, ":center_wealth"),
                    (val_sub, ":amount", ":gold_removed_center"),
                    (val_add, ":gold_removed", ":gold_removed_center"),
                (try_end),                
            (try_end),

            (assign, reg0, ":gold_removed"),
        ]),

    # script_party_unpaid_wages_penalties
        # input:
        #   arg1: party_no
        #   arg2: unpaid_wages
        #   arg3: total_wages
        # output: none
    ("party_unpaid_wages_penalties",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":unpaid_wages", 2),
            (store_script_param, ":total_wages", 3),

            (party_get_slot, ":old_debts", ":party_no", slot_party_unpaid_wages),
            
            # Lose morale equals to 1/10th of the percentage of unpaid wages
            (store_mul, ":morale_penalties", ":unpaid_wages", 10),
            (val_div, ":morale_penalties", ":total_wages"),
            (val_mul, ":morale_penalties", -1),
            (try_begin),
                (call_script, "script_cf_debug", debug_economy),
                (str_store_party_name, s10, ":party_no"),
                (assign, reg10, ":unpaid_wages"),
                (assign, reg11, ":old_debts"),
                (display_message, "@{s10} has unpaid wages: {reg10} (old debts: {reg11})"),
            (try_end),
            (call_script, "script_party_change_morale", ":party_no", ":morale_penalties"),
            
            (val_add, ":old_debts", ":unpaid_wages"),
            (party_set_slot, ":party_no", slot_party_unpaid_wages, ":old_debts"),
        ]),

    # script_party_get_wages
        # input:
        #   arg1: party_no
        # output:
        #   reg0: party_wages
    ("party_get_wages", 
        [
            (store_script_param, ":party_no", 1),
            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (party_get_slot, ":leader", ":party_no", slot_party_leader),
            (assign, ":party_wages", 0),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_id", ":party_no", ":cur_stack"),
                (party_stack_get_size, ":stack_size", ":party_no", ":cur_stack"),
                (neq, ":leader", ":troop_id"),

                (call_script, "script_troop_get_wages", ":troop_id"),
                (store_mul, ":stack_wages", reg0, ":stack_size"),
                (val_add, ":party_wages", ":stack_wages"),
            (try_end),

            (call_script, "script_party_get_wages_modifier", ":party_no"),
            (assign, ":modifier", reg0),

            (val_mul, ":party_wages", ":modifier"),
            (val_div, ":party_wages", 100),

            (party_set_slot, ":party_no", slot_party_wages_cache, ":party_wages"),

            (assign, reg0, ":party_wages"),
        ]),

    # script_party_get_wages_modifier
        # input: 
        #   arg1: party_no
        # output: 
        #   reg0: modifier
    ("party_get_wages_modifier", 
        [
            (store_script_param, ":party_no", 1),
            (assign, ":modifier", 1000),

            (try_begin),
                # Garrisoned troops pay 1/2th wages
                (is_between, ":party_no", centers_begin, centers_end),
                (val_div, ":modifier", 2),
                # ToDo: possible buildings reducing wages
            (else_try),
                (party_get_slot, ":party_leader", ":party_no", slot_party_leader),
                (try_begin), # 2% less per leadership point
                    (ge, ":party_leader", 0),
                    (store_skill_level, ":leadership", skl_leadership, ":party_leader"),
                    (val_mul, ":leadership", 20),
                    (val_sub, ":modifier", ":leadership"),
                (try_end),
            (try_end),
            (assign, reg0, ":modifier"),
        ]),

    # script_troop_get_wages_for_party
        # input:
        #   arg1: troop_no
        #   arg2: party_no
        # output: 
        #   reg0: troop_wages
    ("troop_get_wages_for_party",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":party_no", 2),

            (call_script, "script_troop_get_wages", ":troop_no"),
            (assign, ":troop_wages", reg0),

            (call_script, "script_party_get_wages_modifier", ":party_no"),
            (assign, ":modifier", reg0),
            (val_mul, ":troop_wages", ":modifier"),
            (val_div, ":troop_wages", 100),

            (assign, reg0, ":troop_wages"),
        ]),

    # script_troop_get_wages
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: troop_wages
    ("troop_get_wages",
        [
            (store_script_param, ":troop_no", 1),

            (store_character_level, ":troop_level", ":troop_no"),
            
            (store_add, ":divider", ":troop_level", 60),
            (val_add, ":troop_level", 8),
            (val_mul, ":troop_level", 2),
            (val_mul, ":troop_level", ":troop_level"),
            
            (val_div, ":troop_level", ":divider"),
            
            (try_begin), # Mercenaries are 50% more expensive to maintain
                (is_between, ":troop_no", mercenaries_begin, mercenaries_end),
                (val_mul, ":troop_level", 3),
                (val_div, ":troop_level", 2),
            (else_try), # Bandits are less expensive to maintain
                (is_between, ":troop_no", bandits_begin, bandits_end),
                (val_div, ":troop_level", 2),
            (try_end),
            (try_begin), # Mounted units are 25% more expensive to maintain
                (troop_is_mounted, ":troop_no"),
                (val_mul, ":troop_level", 5),
                (val_div, ":troop_level", 4),
            (try_end),

            (assign, reg0, ":troop_level"),
        ]),

    # script_troop_get_relation_with_troop
        # input:
        #   arg1: troop_no
        #   arg2: target_troop
        # output:
        #   reg0: relation
    ("troop_get_relation_with_troop",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":target_troop", 2),

            (assign, ":relation_slot", 0),
            (try_begin),
                (is_between, ":target_troop", npc_heroes_begin, npc_heroes_end),
                (store_sub, ":target_troop_offset", ":target_troop", npc_heroes_begin),
                (store_add, ":relation_slot", ":target_troop_offset", slot_troop_relations_begin),
            (else_try),
                (eq, ":target_troop", "$g_player_troop"),
                (assign, ":relation_slot", slot_troop_relations_begin),
            (try_end),

            (troop_get_slot, ":relation", ":troop_no", ":relation_slot"),
            (assign, reg0, ":relation"),
        ]),

    # script_troop_change_relation_with_troop
        # input:
        #   arg1: troop_no
        #   arg2: other_troop_no
        #   arg3: change
    ("troop_change_relation_with_troop",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":other_troop_no", 2),
            (store_script_param, ":change", 3),

            (store_sub, ":troop_no_offset", ":other_troop_no", npc_heroes_begin),
            (store_add, ":slot_rel_1", ":troop_no_offset", slot_troop_relations_begin),
            (val_max, ":slot_rel_1", slot_troop_relations_begin),
            (troop_get_slot, ":relation_1", ":troop_no", ":slot_rel_1"),
            (val_add, ":relation_1", ":change"),
            (val_clamp, ":relation_1", -100, 101),
            (troop_set_slot, ":troop_no", ":slot_rel_1", ":relation_1"),

            (store_sub, ":other_troop_no_offset", ":troop_no", npc_heroes_begin),
            (store_add, ":slot_rel_2", ":other_troop_no_offset", slot_troop_relations_begin),
            (val_max, ":slot_rel_2", slot_troop_relations_begin),
            (troop_get_slot, ":relation_2", ":other_troop_no", ":slot_rel_2"),
            (val_add, ":relation_2", ":change"),
            (val_clamp, ":relation_2", -100, 101),
            (troop_set_slot, ":other_troop_no", ":slot_rel_2", ":relation_2"),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple),
                (str_store_troop_name, s10, ":troop_no"),
                (str_store_troop_name, s11, ":other_troop_no"),
                (assign, reg10, ":change"),
                (assign, reg11, ":relation_1"),
                (assign, reg12, ":relation_2"),
                (display_message, "@Relation {s10} - {s11} changed ({reg10}): {reg11} / {reg12}"),
            (try_end),
        ]),

    # script_troop_change_relation_with_party_heroes
        # input:
        #   arg1: troop_no
        #   arg2: party_no
        #   arg3: change
        # output: none
    ("troop_change_relation_with_party_heroes",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":party_no", 2),
            (store_script_param, ":change", 3),

            # Iterate through other attached parties ?
            # (party_get_num_attached_parties, ":num_attached", ":party_no"),
            # (try_for_range, ":cur_attached", 0, ":num_attached"),
                # (party_get_attached_party_with_rank, ":cur_party", ":party_no", ":cur_attached"),
                (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
                (try_for_range, ":cur_stack", 0, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", ":party_no", ":cur_stack"),
                    (troop_is_hero, ":troop_id"),
                    (call_script, "script_troop_change_relation_with_troop", ":troop_no", ":troop_id", ":change"),
                (try_end),
                # (call_script, "script_change_troop_relation_with_party_group_heroes", ":troop_no", ":cur_party", ":change"),
            # (try_end),
        ]),

    # script_item_get_sell_price
        # input:
        #   arg1: item_no
        #   arg2: selling_party
        #   arg3: buying_party
        # output:
        #   reg0: sell_price
    ("item_get_sell_price",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":selling_party", 2),
            (store_script_param, ":buying_party", 3),

            (store_item_value, ":price", ":item_no"),
            (call_script, "script_item_get_sell_price_factor_from_party", ":item_no", ":selling_party", ":buying_party"),
            (assign, ":price_factor", reg0),
            (assign, ":tax_factor", reg1),

            (store_mul, ":final_price", ":price", ":price_factor"),
            (val_div, ":final_price", 100),

            (store_mul, ":tax_amount", ":price", ":tax_factor"),
            (val_div, ":tax_amount", 100),

            (assign, reg0, ":final_price"),
            (assign, reg1, ":tax_amount"),
        ]),

    # script_item_get_buy_price
        # input:
        #   arg1: item_no
        #   arg2: buying_party
        #   arg3: selling_party
        # output:
        #   reg0: buy_price
    ("item_get_buy_price",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":buying_party", 2),
            (store_script_param, ":selling_party", 3),

            (store_item_value, ":price", ":item_no"),
            (call_script, "script_item_get_buy_price_factor_from_party", ":item_no", ":buying_party", ":selling_party"),
            (assign, ":price_factor", reg0),
            (assign, ":tax_factor", reg1),

            (store_mul, ":final_price", ":price", ":price_factor"),
            (val_div, ":final_price", 100),

            (store_mul, ":tax_amount", ":price", ":tax_factor"),
            (val_div, ":tax_amount", 100),

            (assign, reg0, ":final_price"),
            (assign, reg1, ":tax_amount"),
        ]),

    # script_troop_prisoner
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: troop_freed
    ("troop_prisoner",
        [
            (store_script_param, ":troop_no", 1),

            (assign, ":freed", 0),

            (troop_get_slot, ":prisoner_of", ":troop_no", slot_troop_prisoner_of),
            (try_begin),
                (gt, ":prisoner_of", 0),
                (party_is_active, ":prisoner_of"),
                (party_count_prisoners_of_type, ":prisoner", ":prisoner_of", ":troop_no"),
                (gt, ":prisoner", 0),

                (store_faction_of_party, ":prison_faction", ":prisoner_of"),
                (store_troop_faction, ":troop_faction", ":troop_no"),
                (try_begin),
                    (eq, ":prison_faction", ":troop_faction"),
                    (assign, ":freed", 1),
                (else_try),
                    (call_script, "script_faction_get_treaties", ":prison_faction", ":troop_faction"),
                    (assign, ":treaties", reg0),

                    (store_and, ":alliance", ":treaties", sfkt_alliance),
                    (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
                    (store_and, ":vassal", ":treaties", sfkt_vassal),
                    (store_and, ":overlord", ":treaties", sfkt_overlord),

                    (this_or_next|eq, ":alliance", sfkt_alliance),
                    (this_or_next|eq, ":defensive", sfkt_defensive_alliance),
                    (this_or_next|eq, ":vassal", sfkt_vassal),
                    (eq, ":overlord", sfkt_overlord),

                    (assign, ":freed", 1),
                (else_try),
                    # Ransom chance
                    (store_random_in_range, ":rand", 0, 100),
                    (lt, ":rand", prisoner_ransom_chance),
                    (call_script, "script_cf_troop_propose_ransom", ":troop_no"),

                    (assign, ":ransom_value", reg0),
                    (assign, ":ransomer_party", reg1),

                    (call_script, "script_party_ransom_troop", ":ransomer_party", ":troop_no", ":prisoner_of", ":ransom_value"),
                (else_try),
                    # Escape chance
                    (store_troop_health, ":troop_health", ":troop_no", 0),
                    (gt, ":troop_health", 66),

                    (store_random_in_range, ":rand", 0, 100),
                    (lt, ":rand", prisoner_escape_chance),
                    (assign, ":freed", 1),
                (try_end),
            (else_try),
                # Captor no longer valid
                (assign, ":freed", 1),
            (try_end),

            (try_begin),
                (eq, ":freed", 1),
                (call_script, "script_troop_released", ":troop_no"),
            (try_end),

            (assign, reg0, ":freed"),
        ]),

    # script_cf_troop_propose_ransom
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: ransom_value
        #   reg1: ransom_party
        # fails if troop is not ransomed
    ("cf_troop_propose_ransom",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":prisoner_of", ":troop_no", slot_troop_prisoner_of),
            (ge, ":prisoner_of", 0),

            (store_faction_of_party, ":prison_party_faction", ":prisoner_of"),
            (store_troop_faction, ":troop_faction", ":troop_no"),
            (neq, ":prison_party_faction", ":troop_faction"),

            (store_relation, ":relation", ":troop_faction", ":prison_party_faction"),
            (ge, ":relation", relation_state_neutral),

            (party_get_slot, ":prison_party_type", ":prisoner_of", slot_party_type),
            (is_between, ":prison_party_type", spt_village, spt_fort + 1),

            (call_script, "script_troop_get_value", ":troop_no"),
            (assign, ":ransom_value", reg0),
            (call_script, "script_troop_get_ransomer_party", ":troop_no", ":ransom_value"),
            (assign, ":ransomer_party", reg0),
            (gt, ":ransomer_party", 0),

            (try_begin),
                (call_script, "script_cf_debug", debug_war),
                (str_store_party_name, s10, ":ransomer_party"),
                (str_store_troop_name, s11, ":troop_no"),
                (assign, reg10, ":ransom_value"),
                (display_message, "@{s10} is party for ransom of {s11} - {reg10} denars", text_color_info),
            (try_end),

            (assign, reg0, ":ransom_value"),
            (assign, reg1, ":ransomer_party"),
        ]),

    # script_troop_get_value
        # Get an estimate of the troop "worth"
        # Used in negociation and ransom
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: troop_value
    ("troop_get_value",
        [
            (store_script_param, ":troop_no", 1),
            (troop_get_slot, ":occupation", ":troop_no", slot_troop_kingdom_occupation),

            (assign, ":value", 0),

            (try_begin),
                (eq, ":occupation", tko_kingdom_hero),
                (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
                (troop_get_slot, ":num_vassals", ":troop_no", slot_troop_num_vassal),
                (troop_get_slot, ":renown", ":troop_no", slot_troop_renown),

                (assign, ":rank_value", 0),

                (try_begin),
                    (eq, ":rank", rank_king),
                    (assign, ":rank_value", base_hero_value_king),
                (else_try),
                    (eq, ":rank", rank_city),
                    (assign, ":rank_value", base_hero_value_city),
                (else_try),
                    (eq, ":rank", rank_castle),
                    (assign, ":rank_value", base_hero_value_castle),
                (else_try),
                    (eq, ":rank", rank_two_village),
                    (assign, ":rank_value", base_hero_value_two_village),
                (else_try),
                    (eq, ":rank", rank_village),
                    (assign, ":rank_value", base_hero_value_village),
                (else_try),
                    (assign, ":rank_value", base_hero_value_none),
                (try_end),

                (assign, ":vassals_percentage", ":num_vassals", base_hero_value_vassals_percentage),
                (store_mul, ":vassals_value", ":rank_value", ":vassals_percentage"),
                (val_div, ":vassals_value", 100),

                (store_mul, ":renown_value", ":renown", base_hero_value_renown_multiplier),

                (val_add, ":value", ":rank_value"),
                (val_add, ":value", ":vassals_value"),
                (val_add, ":value", ":renown_value"),
            (try_end),

            (assign, reg0, ":value"),
        ]),

    # script_troop_get_ransomer_party
        # input:
        #   arg1: troop_no
        #   arg2: ransom_value
        # output:
        #   reg0: ransomer_party
    ("troop_get_ransomer_party",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":ransom_value", 2),

            (assign, ":party", -1),

            (troop_get_slot, ":troop_home", ":troop_no", slot_troop_home),
            (try_begin),
                (is_between, ":troop_home", centers_begin, centers_end),

                (party_get_slot, ":troop_home_leader", ":troop_home", slot_party_leader),
                (eq, ":troop_home_leader", ":troop_no"),

                (call_script, "script_party_get_total_wealth", ":troop_home", 1),
                (assign, ":home_wealth", reg0),

                (gt, ":home_wealth", ":ransom_value"),

                (assign, ":party", ":troop_home"),
            (try_end),

            (assign, reg0, ":party"),
        ]),

    # script_party_ransom_troop
        # input:
        #   arg1: party_no
        #   arg2: ransom_troop
        #   arg3: ransom_from
        #   arg4: ransom_value
        # output: none
    ("party_ransom_troop",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":ransom_troop", 2),
            (store_script_param, ":ransom_from", 3),
            (store_script_param, ":ransom_value", 4),

            # TODO: send convoy party
            (call_script, "script_party_transfer_wealth", ":party_no", ":ransom_from", ":ransom_value", tax_type_leader_ransom, tax_type_leader_ransom),
            (call_script, "script_troop_released", ":ransom_troop"),
        ]),

    # script_update_troop_notes
        # input:
        #   arg1: troop_no
        # output: none
    ("update_troop_notes",
        [
            (store_script_param, ":troop_no", 1),

            (str_store_troop_name_link, s10, ":troop_no"),
            (display_message, "@Notes updated ({s10})"),
        ]),

    # script_update_faction_notes
        # input:
        #   arg1: faction_no
        # output: none
    ("update_faction_notes",
        [
            (store_script_param, ":faction_no", 1),

            (str_store_faction_name_link, s10, ":faction_no"),
            (display_message, "@Notes updated ({s10})"),
        ]),

    # script_update_party_notes
        # input:
        #   arg1: party_no
        # output: none
    ("update_party_notes",
        [
            (store_script_param, ":party_no", 1),

            (str_store_party_name_link, s10, ":party_no"),
            (display_message, "@Notes updated ({s10})"),
        ]),

    # script_troop_get_gold_rating
        # Get an estimation of the troops value in gold from the seer_troop
        # input: 
        #   arg1: troop_no
        #   arg2: seer_troop
        # output:
        #   reg0: gold_rating
    ("troop_get_gold_rating",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":seer_troop", 2),

            (assign, ":gold_rating", 0),

            (try_for_range, ":item_slot", ek_item_0, ek_head),
                (troop_get_inventory_slot, ":item_no", ":troop_no", ":item_slot"),
                (call_script, "script_item_get_estimated_price", ":item_no", ":seer_troop"),
                (val_add, ":gold_rating", reg0),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_economy),
                (assign, reg10, ":gold_rating"),
                (str_store_troop_name, s10, ":troop_no"),
                (str_store_troop_name, s11, ":seer_troop"),
                (call_script, "script_game_get_money_text", reg10),
                (display_message, "@{s11} sees {s10} as valued {s0}."),
            (try_end),

            (assign, reg0, ":gold_rating"),
        ]),

    # script_item_get_estimated_price
        # input: 
        #   arg1: item_no
        #   arg2: troop_no
        # output:
        #   output: estimated_price
    ("item_get_estimated_price",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":troop_no", 2),

            (assign, ":estimated_price", 0),

            (store_item_value, ":real_price", ":item_no"),
            # Trade skill influences the random outcome
            (store_skill_level, ":trade", skl_trade, ":troop_no"),

            # We add different static elements to have a different number for each item/price/troop/day
            (store_add, ":rand", "$g_daily_random", ":real_price"),
            (val_add, ":rand", ":item_no"),
            (val_add, ":rand", ":troop_no"),

            (store_mod, ":percentage_error", ":rand", 11),
            (val_sub, ":percentage_error", 5),
            (store_sub, ":trade_penalties", 10, ":trade"),
            (val_mul, ":percentage_error", ":trade_penalties"),

            (store_mul, ":estimated_price", ":real_price", ":percentage_error"),
            (val_div, ":estimated_price", 100),
            (val_add, ":estimated_price", ":real_price"),

            (assign, reg0, ":estimated_price"),
        ]),

    # script_troop_bargain
        # input:
        #   arg1: bargaining_troop
        #   arg2: other_troop
        #   arg3: ratio_offered
        #   arg4: bargain_type
        #       -1: aggressive bargain, uses strength and indimidation
        #       1: friendly bargain, uses intelligence and persuasion
        #   arg5: difficulty
        # output:
        #   reg0: outcome
        #       outcome_success, outcome_neutral, outcome_failure
        # this script is called when bargain between 2 troops
    ("troop_bargain",
        [
            (store_script_param, ":bargaining_troop", 1),
            (store_script_param, ":other_troop", 2),
            (store_script_param, ":ratio_offered", 3),
            (store_script_param, ":bargain_type", 4),
            (store_script_param, ":difficulty", 5),

            (assign, ":outcome", outcome_neutral),

            (assign, ":skill", 0),
            (assign, ":attribute", 0),
            (assign, ":main_attribute_weight", 3),
            (assign, ":main_skill_weight", 5),

            (try_begin),
                (eq, ":bargain_type", bargain_type_strength),
                (assign, ":skill", skl_intimidation),
                (assign, ":attribute", ca_strength),
            (else_try),
                (assign, ":skill", skl_persuasion),
                (assign, ":attribute", ca_intelligence),
            (try_end),
            (store_skill_level, ":bargaining_troop_skill", ":skill", ":bargaining_troop"),
            (val_mul, ":bargaining_troop_skill", ":main_skill_weight"),

            (store_attribute_level, ":b_attribute", ":bargaining_troop", ":attribute"),
            (store_attribute_level, ":o_attribute", ":other_troop", ":attribute"),
            (val_mul, ":b_attribute", ":main_attribute_weight"),
            (val_mul, ":o_attribute", ":main_attribute_weight"),

            # Both persuasion use charisma (less weighted)
            (store_attribute_level, ":b_charisma", ":bargaining_troop", ca_charisma),
            (store_attribute_level, ":o_charisma", ":other_troop", ca_charisma),
            (val_add, ":b_attribute", ":b_charisma"),
            (val_add, ":o_attribute", ":o_charisma"),

            (store_sub, ":difference", ":b_attribute", ":o_attribute"),
            (val_add, ":difference", ":bargaining_troop_skill"),

            (val_add, ":difference", ":ratio_offered"),

            (store_add, ":difficulty_mult", ":difficulty", 100),
            (val_mul, ":difference", ":difficulty_mult"),
            (val_div, ":difference", 100),

            (store_div, ":neutral_offset", ":difficulty", 4),

            (try_begin),
                (gt, ":difference", 100),
                # Use 1/4th difficulty to have chance at neutral outcome.
                (store_sub, ":neutral", ":difference", ":neutral_offset"),
                (try_begin),
                    (gt, ":neutral", 100),
                    (assign, ":outcome", outcome_success),
                (try_end),
            (else_try),
                (lt, ":difference", 100),
                # Use 1/4th difficulty to have chance at neutral outcome.
                (store_add, ":neutral", ":difference", ":neutral_offset"),
                (try_begin),
                    (lt, ":neutral", 100),
                    (assign, ":outcome", outcome_failure),
                (try_end),
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_war),
                (str_store_troop_name, s10, ":bargaining_troop"),
                (str_store_troop_name, s11, ":other_troop"),
                (assign, reg10, ":difference"),
                (assign, reg11, ":ratio_offered"),
                # (assign, reg12, ":outcome"),
                (store_add, ":bargain_string", ":outcome", "str_outcome_neutral"),
                (str_store_string, s12, ":bargain_string"),
                (display_message, "@{s10} bargain with {s11}: Offered ratio ({reg11}) transformed to {reg10}. Outcome is {s12}."),
            (try_end),

            (assign, reg0, ":outcome"),
        ]),

    # script_party_bargain
        # input:
        #   arg1: bargaining_party
        #   arg2: other_party
        #   arg3: ratio_offered
        #   arg4: bargain_type
        #   arg5: difficulty
        # output:
        #   reg0: outcome
        #       outcome_success, outcome_neutral, outcome_failure
        # this script is called when bargain between 2 parties
    ("party_bargain", 
        [
            (store_script_param, ":bargaining_party", 1),
            (store_script_param, ":other_party", 2),
            (store_script_param, ":ratio_offered", 3),
            (store_script_param, ":bargain_type", 4),
            (store_script_param, ":difficulty", 5),

            (assign, ":outcome", outcome_neutral),

            (try_begin),
                (eq, ":bargain_type", bargain_type_strength),
                (call_script, "script_party_group_calculate_strength", ":bargaining_party"),
                # We use sqrt to have lower influence on ratio
                (assign, ":strength", reg0),
                (assign, ":defense", reg1),
                (val_add, ":strength", ":defense"),
                (val_max, ":strength", 1),

                (call_script, "script_party_group_calculate_strength", ":other_party"),
                # We use sqrt to have lower influence on ratio
                (assign, ":other_party_strength", reg0),
                (assign, ":other_party_defense", reg1),
                (val_add, ":other_party_strength", ":other_party_defense"),
                (val_max, ":other_party_strength", 1),

                (val_mul, ":strength", 100),
                (val_div, ":strength", ":other_party_strength"),

                (val_mul, ":strength", ":ratio_offered"),
                (val_div, ":strength", 100),

                (assign, ":skill", 0),
                (try_begin),
                    (party_get_slot, ":leader", ":bargaining_party", slot_party_leader),
                    (this_or_next|gt, ":leader", 0),
                    (eq, ":bargaining_party", "$g_player_party"),

                    (store_skill_level, ":skill", ":leader", skl_intimidation),
                (try_end),

                (try_begin),
                    (party_get_slot, ":leader", ":other_party", slot_party_leader),
                    (this_or_next|gt, ":leader", 0),
                    (eq, ":bargaining_party", "$g_player_party"),

                    (store_skill_level, ":other_skill", ":leader", skl_intimidation),
                    (val_sub, ":skill", ":other_skill"),
                (try_end),

                (try_begin),
                    (neq, ":skill", 0),
                    (val_mul, ":skill", 2),
                    (val_add, ":skill", 100),
                    (val_mul, ":strength", ":skill"),
                    (val_div, ":strength", 100),
                (try_end),

                (try_begin),
                    (neq, ":difficulty", 0),
                    (store_add, ":difficulty_mult", ":difficulty", 100),
                    (val_mul, ":strength", ":difficulty_mult"),
                    (val_div, ":strength", 100),
                (try_end),

                (store_div, ":neutral_offset", ":difficulty", 4),

                (try_begin),
                    (gt, ":strength", 100),

                    (store_sub, ":neutral", ":strength", ":neutral_offset"),
                    (try_begin),
                        (gt, ":neutral", 100),
                        (assign, ":outcome", outcome_success),
                    (try_end),
                (else_try),
                    (lt, ":strength", 100),

                    (store_add, ":neutral", ":strength", ":neutral_offset"),
                    (try_begin),
                        (lt, ":neutral", 100),
                        (assign, ":outcome", outcome_failure),
                    (try_end),
                (try_end),
            # (else_try),
                # peaceful bargain type with parties ?
            (try_end),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_war),
                (str_store_party_name, s10, ":bargaining_party"),
                (str_store_party_name, s11, ":other_party"),
                (assign, reg10, ":strength"),
                (assign, reg11, ":ratio_offered"),
                # (assign, reg12, ":outcome"),
                (store_add, ":bargain_string", ":outcome", "str_outcome_neutral"),
                (str_store_string, s12, ":bargain_string"),
                (display_message, "@{s10} bargain with {s11}: Offered ratio ({reg11}) transformed to {reg10}. Outcome is {s12}."),
            (try_end),

            (assign, reg0, ":outcome"),
        ]),

    # script_get_bandit_dialog
        # input:
        #   arg1: bandit_party
        #   arg2: string_id
        # output:
        #   s0: result_string
    ("get_bandit_dialog",
        [
            (store_script_param, ":bandit_party", 1),
            (store_script_param, ":string_id", 2),

            (store_faction_of_party, ":faction", ":bandit_party"),
            (try_begin),
                (is_between, ":faction", bandit_factions_begin, bandit_factions_end),
                (store_sub, ":offset", ":faction", bandit_factions_begin),
                (val_add, ":string_id", ":offset"),
                (str_store_string, s0, ":string_id"),
            (else_try),
                (str_store_string, s0, "str_dialog_error"),
            (try_end),
        ]),

    # script_party_take_player_party_prisoner
        # input:
        #   arg1: party_no
        # output: none
    ("party_take_player_party_prisoner",
        [
            (store_script_param, ":party_no", 1),

            (assign, "$g_player_captor_party", ":party_no"),
            
            (call_script, "script_party_group_defeat_party_group", ":party_no", "$g_player_party", -1),

            (troop_set_slot, "$g_player_troop", slot_troop_prisoner_of, ":party_no"),

            (set_camera_follow_party, ":party_no"),
            (rest_for_hours, 12, 1, 0),
            (disable_party, "$g_player_party"),
        ]),

    # script_player_party_free
        # input: none
        # output: none
    ("player_party_free",
        [
            (enable_party, "$g_player_party"),
            (call_script, "script_troop_freed", "$g_player_troop", -1),
            # (party_force_add_members, "$g_player_party", "$g_player_troop", 1),
            (party_relocate_near_party, "$g_player_party", "$g_player_captor_party", 5),
            (assign, "$g_player_captor_party", -1),

            (set_camera_follow_party, "$g_player_party"),
            (rest_for_hours, 0, 0, 0),
        ]),

    # script_troop_escape_chance
        # input:
        #   arg1: troop_no
        #   arg2: holder_party
        #   arg3: escape_type
        # output:
        #   reg0: outcome (1 success, -1 failure, 0)
    ("troop_escape_chance",
        [
            (store_script_param, ":troop_no", 1),
            # (store_script_param, ":holder_party", 2),
            (store_script_param, ":escape_type", 3),

            (assign, ":needed_value", 35),
            (assign, ":skill", 0),
            (assign, ":outcome", outcome_neutral),

            (try_begin),
                (eq, ":escape_type", escape_type_wits),
                (store_skill_level, ":skill_1", skl_persuasion, ":troop_no"),
                (store_skill_level, ":skill_2", skl_trade, ":troop_no"),
                (val_mul, ":skill_1", 2),
                (store_add, ":skill", ":skill_1", ":skill_2"),
            (else_try),
                (eq, ":escape_type", escape_type_agility),

                (store_skill_level, ":skill_1", skl_pathfinding, ":troop_no"),
                (store_skill_level, ":skill_2", skl_spotting, ":troop_no"),
                (store_skill_level, ":skill_3", skl_tracking, ":troop_no"),
                (store_add, ":skill", ":skill_1", ":skill_2"),
                (val_add, ":skill", ":skill_3"),
            (else_try),
                (eq, ":escape_type", escape_type_strength),

                (store_skill_level, ":skill_1", skl_intimidation, ":troop_no"),
                (store_skill_level, ":skill_2", skl_ironflesh, ":troop_no"),
                (store_skill_level, ":skill_3", skl_power_strike, ":troop_no"),
                (store_add, ":skill", ":skill_1", ":skill_2"),
                (val_add, ":skill", ":skill_3"),
            (try_end),

            (store_random_in_range, ":rand", 0, 41),
            (val_add, ":skill", ":rand"),

            (try_begin),
                (gt, ":skill", ":needed_value"),
                (assign, ":outcome", outcome_success),
            (else_try),
                (assign, ":outcome", outcome_failure),
            (try_end),

            (assign, reg0, ":outcome"),
        ]),

    # script_prepare_troop_followers
        # input: none
        # output: none
    ("prepare_troop_followers",
        [
            (try_for_range, ":lord_no", lords_begin, lords_end),
                (troop_set_slot, ":lord_no", slot_troop_num_followers, 0),
                (troop_set_slot, ":lord_no", slot_troop_num_followers_ready, 0),
            (try_end),
            (try_for_range, ":lord_no", lords_begin, lords_end),
                (troop_get_slot, ":occupation", ":lord_no", slot_troop_kingdom_occupation),
                (neg|troop_slot_ge, ":lord_no", slot_troop_prisoner_of, 0), # Do not process prisoners
                (try_begin),
                    (eq, ":occupation", tko_kingdom_hero),
                    (troop_get_slot, ":leaded_party", ":lord_no", slot_troop_leaded_party),
                    (ge, ":leaded_party", 0),
                    (party_is_active, ":leaded_party"),
                    (troop_get_slot, ":lord_mission", ":lord_no", slot_troop_mission),
                    (eq, ":lord_mission", tm_escorting),
                    (troop_get_slot, ":lord_mission_object", ":lord_no", slot_troop_mission_object),
                    (ge, ":lord_mission_object", 0),
                    (troop_get_slot, ":num_followers", ":lord_mission_object", slot_troop_num_followers),
                    (val_add, ":num_followers", 1),
                    (troop_set_slot, ":lord_mission_object", slot_troop_num_followers, ":num_followers"),
                    (troop_get_slot, ":lord_mission_object_party", ":lord_mission_object", slot_troop_leaded_party),
                    (ge, ":lord_mission_object_party", 1),
                    (party_is_active, ":lord_mission_object_party"),
                    (store_distance_to_party_from_party, ":distance", ":lord_mission_object_party", ":leaded_party"),
                    (le, ":distance", 4),
                    (troop_get_slot, ":num_followers_ready", ":lord_mission_object", slot_troop_num_followers_ready),
                    (val_add, ":num_followers_ready", 1),
                    (troop_set_slot, ":lord_mission_object", slot_troop_num_followers_ready, ":num_followers"),
                (try_end),
            (try_end),
            (try_begin),
                (call_script, "script_cf_debug", debug_ai),
                (try_for_range, ":lord_no", lords_begin, lords_end),
                    (troop_get_slot, ":followers", ":lord_no", slot_troop_num_followers),
                    (troop_get_slot, ":followers_ready", ":lord_no", slot_troop_num_followers_ready),
                    (gt, ":followers", 0),
                    (str_store_troop_name, s10, ":lord_no"),
                    (assign, reg10, ":followers"),
                    (assign, reg11, ":followers_ready"),
                    (display_message, "@Lord {s10} has {reg10} followers ({reg11} ready)"),
                (try_end),
            (try_end),
        ]),

    # script_party_create_debt
        # input:
        #   arg1: debtor
        #   arg2: creditor
        #   arg3: amount
        # output: none
    ("party_create_debt",
        [
            (store_script_param, ":debtor", 1),
            (store_script_param, ":creditor", 2),
            (store_script_param, ":amount", 3),

            (try_begin),
                (call_script, "script_cf_debug", debug_economy),

                (str_store_party_name, s10, ":debtor"),
                (str_store_party_name, s11, ":creditor"),
                (assign, reg10, ":amount"),
                
                (display_message, "@{s10} creating debt for {s11} ({reg10})"),
            (try_end),

            # TODO: for now we transfer the gold directly
            (call_script, "script_party_transfer_wealth", ":debtor", ":creditor", ":amount", tax_type_debt_collection, tax_type_debts),
        ]),

    # script_party_process_attached_parties
        # input:
        #   arg1: party_no
        # output: none
    ("party_process_attached_parties",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (party_get_slot, ":attached_party_1", ":party_no", slot_party_attached_party_1),
            (party_get_slot, ":attached_party_2", ":party_no", slot_party_attached_party_2),

            (try_begin),
                (eq, ":party_type", spt_town),
                # patrols
                (try_begin),
                    (le, ":attached_party_1", 0),
                    (call_script, "script_cf_party_create_patrol", ":party_no", slot_party_attached_party_1),
                (else_try),
                    (neg|party_is_active, ":attached_party_1"),
                    (party_set_slot, ":party_no", slot_party_attached_party_1, -1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war),
                        (str_store_party_name, s10, ":party_no"),
                        (display_message, "@{s10} releasing inactive attached party"),
                    (try_end),
                (try_end),
                # caravans
                (try_begin),
                    (le, ":attached_party_2", 0),
                    (call_script, "script_cf_party_create_caravan", ":party_no", slot_party_attached_party_2),
                (else_try),
                    (neg|party_is_active, ":attached_party_2"),
                    (party_set_slot, ":party_no", slot_party_attached_party_2, -1),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war),
                        (str_store_party_name, s10, ":party_no"),
                        (display_message, "@{s10} releasing inactive attached party 2"),
                    (try_end),
                (try_end),
            (else_try),
                (eq, ":party_type", spt_castle),
                # patrols
            (else_try),
                (eq, ":party_type", spt_village),
                # villagers
                (try_begin),
                    (le, ":attached_party_1", 0),
                    (party_get_slot, ":cooldown", ":party_no", slot_party_attached_party_cooldown),
                    (try_begin),
                        (le, ":cooldown", 0),
                        (call_script, "script_cf_party_create_villager", ":party_no", slot_party_attached_party_1),
                    (else_try),
                        (val_sub, ":cooldown", 1),
                        (party_set_slot, ":party_no", slot_party_attached_party_cooldown, ":cooldown"),
                    (try_end),
                (else_try),
                    (neg|party_is_active, ":attached_party_1"),
                    (party_set_slot, ":party_no", slot_party_attached_party_1, -1),
                    (party_set_slot, ":party_no", slot_party_attached_party_cooldown, 6),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war),
                        (str_store_party_name, s10, ":party_no"),
                        (display_message, "@{s10} releasing inactive attached party"),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # script_cf_party_create_patrol
        # input:
        #   arg1: party_no
        #   arg2: store_slot
        # output: none
    ("cf_party_create_patrol",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":slot", 2),

            (try_begin),
                (is_between, ":slot", slot_party_attached_party_1, slot_party_attached_party_3 + 1),

                (try_begin),
                    (call_script, "script_cf_center_can_give_troops", ":party_no", -1),

                    (store_faction_of_party, ":current_faction", ":party_no"),
                    (party_get_slot, ":party_faction", ":party_no", slot_party_faction),
                    (eq, ":current_faction", ":party_faction"),
                    (party_get_slot, ":attached_party_reserved_wages", ":party_no", slot_party_budget_reserved_auxiliaries),

                    (call_script, "script_spawn_party_around_party", ":party_no", "pt_patrol"),
                    (assign, ":spawned_party", reg0),

                    (party_set_faction, ":spawned_party", ":party_faction"),
                    (party_set_slot, ":spawned_party", slot_party_budget_reserved_party, ":attached_party_reserved_wages"),
                    (party_set_slot, ":spawned_party", slot_party_wanted_party_wages, ":attached_party_reserved_wages"),
                    (party_set_slot, ":spawned_party", slot_party_type, spt_patrol),
                    (party_set_slot, ":spawned_party", slot_party_linked_party, ":party_no"),

                    (party_set_slot, ":spawned_party", slot_party_autosort_options, autosort_low_level_first|autosort_foreign_first),

                    (call_script, "script_get_current_day"),
                    (assign, ":current_day", reg0),
                    (party_set_slot, ":spawned_party", slot_party_last_rest, ":current_day"),

                    (party_attach_to_party, ":spawned_party", ":party_no"),

                    (party_set_slot, ":party_no", ":slot", ":spawned_party"),
                    (call_script, "script_party_give_troops_to_party", ":party_no", ":spawned_party", 5),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_war|debug_ai),
                        (str_store_party_name, s10, ":party_no"),
                        (display_message, "@{s10} generating attached party patrol"),
                    (try_end),
                (try_end),
            (else_try),
                (call_script, "script_cf_debug", debug_simple),
                (assign, reg10, ":slot"),
                (display_message, "@Generating incorrect slot {reg10} for patrol spawn", text_color_impossible),
            (try_end),
        ]),

    # script_cf_party_create_caravan
        # input:
        #   arg1: party_no
        #   arg2: store_slot
        # output: none
    ("cf_party_create_caravan",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":slot", 2),

            (try_begin),
                (is_between, ":slot", slot_party_attached_party_1, slot_party_attached_party_3 + 1),
            
                (try_begin),
                    (call_script, "script_cf_center_can_give_troops", ":party_no", -1),

                    (assign, ":end", goods_end),
                    (assign, ":continue", 0),
                    (try_for_range, ":good", goods_begin, ":end"),
                        (store_sub, ":offset", ":good", goods_begin),
                        (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),
                        (store_add, ":production_slot", ":offset", slot_party_item_last_produced_begin),
                        (store_add, ":consumption_slot", ":offset", slot_party_item_consumed_begin),

                        (party_get_slot, ":amount", ":party_no", ":amount_slot"),
                        (party_get_slot, ":production", ":party_no", ":production_slot"),
                        (party_get_slot, ":consumption", ":party_no", ":consumption_slot"),

                        (store_sub, ":difference", ":production", ":consumption"),
                        (lt, ":difference", 0),
                        (store_div, ":ticks_left", ":amount", ":difference"),
                        # We don't want to send a caravan if we still have >10 ticks of storage
                        (gt, ":ticks_left", -10),

                        (assign, ":continue", 1),
                        (assign, ":end", goods_begin),
                    (try_end),
                    (eq, ":continue", 1),

                    (store_faction_of_party, ":party_faction", ":party_no"),
                    (party_slot_eq, ":party_no", slot_party_faction, ":party_faction"),
                    # (party_get_slot, ":attached_party_reserved_wages", ":party_no", slot_party_budget_reserved_auxiliaries),
                    # (val_div, ":attached_party_reserved_wages", 2),

                    (call_script, "script_spawn_party_around_party", ":party_no", "pt_caravan"),
                    (assign, ":spawned_party", reg0),

                    (party_set_faction, ":spawned_party", ":party_faction"),

                    (party_get_slot, ":attached_party_reserved_wages", ":party_no", slot_party_budget_reserved_auxiliaries),
                    (party_set_slot, ":spawned_party", slot_party_budget_reserved_party, ":attached_party_reserved_wages"),
                    (party_set_slot, ":spawned_party", slot_party_wanted_party_wages, ":attached_party_reserved_wages"),
                    (party_set_slot, ":spawned_party", slot_party_type, spt_caravan),
                    (party_set_slot, ":spawned_party", slot_party_linked_party, ":party_no"),
                    (party_set_slot, ":spawned_party", slot_party_mission_object, -1),

                    (party_set_slot, ":spawned_party", slot_party_autosort_options, autosort_no_sort),

                    (party_set_aggressiveness, ":spawned_party", 0),

                    (party_set_slot, ":party_no", ":slot", ":spawned_party"),

                    (party_attach_to_party, ":spawned_party", ":party_no"),

                    (faction_get_slot, ":culture", ":party_faction", slot_faction_culture),
                    (faction_get_slot, ":caravan_master", ":culture", slot_faction_caravan_master),
                    (try_begin),
                        (gt, ":caravan_master", 0),
                        (party_force_add_members, ":spawned_party", ":caravan_master", 1),
                    (else_try),
                        (party_force_add_members, ":spawned_party", "trp_swadian_caravan_master", 1),
                    (try_end),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_trade|debug_ai),
                        (str_store_party_name, s10, ":party_no"),
                        (display_message, "@{s10} generating attached party caravan"),
                    (try_end),
                (try_end),
            (else_try),
                (call_script, "script_cf_debug", debug_simple),
                (assign, reg10, ":slot"),
                (display_message, "@Generating incorrect slot {reg10} for caravan spawn", text_color_impossible),
            (try_end),
        ]),

    # script_cf_party_create_villager
        # input:
        #   arg1: party_no
        #   arg2: store_slot
        # output: none
    ("cf_party_create_villager",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":slot", 2),

            (try_begin),
                (is_between, ":slot", slot_party_attached_party_1, slot_party_attached_party_3 + 1),

                (try_begin),
                    (store_faction_of_party, ":current_faction", ":party_no"),
                    (party_get_slot, ":party_faction", ":party_no", slot_party_faction),
                    (eq, ":current_faction", ":party_faction"),

                    (call_script, "script_spawn_party_around_party", ":party_no", "pt_peasants"),
                    (assign, ":spawned_party", reg0),

                    (party_set_faction, ":spawned_party", ":party_faction"),
                    (party_set_slot, ":spawned_party", slot_party_type, spt_civilian),
                    (party_set_slot, ":spawned_party", slot_party_linked_party, ":party_no"),

                    (party_set_slot, ":spawned_party", slot_party_autosort_options, autosort_no_sort),

                    (party_set_slot, ":spawned_party", slot_party_mission_target_1, -1),
                    (party_set_slot, ":spawned_party", slot_party_mission_target_2, -1),
                    (party_set_slot, ":spawned_party", slot_party_mission_target_3, -1),

                    # (party_attach_to_party, ":spawned_party", ":party_no"),
                    (party_set_slot, ":party_no", ":slot", ":spawned_party"),

                    (store_random_in_range, ":num_troops", civilian_party_min_size, civilian_party_max_size),

                    (faction_get_slot, ":culture", ":party_faction", slot_faction_culture),
                    (faction_get_slot, ":peasant_troop", ":culture", slot_faction_peasant_troop),

                    (party_add_members, ":spawned_party", ":peasant_troop", ":num_troops"),
                    (store_mul, ":population_change", ":num_troops", -1),
                    (call_script, "script_party_modify_population", ":party_no", ":population_change"),
                (try_end),
            (else_try),
                (call_script, "script_cf_debug", debug_simple),
                (assign, reg10, ":slot"),
                (display_message, "@Generating incorrect slot {reg10} for peasants spawn", text_color_impossible),
            (try_end),
        ]),

    # script_cf_center_can_give_troops
        # input:
        #   arg1: center_no
        #   arg2: party_to_give
        # output: none
    ("cf_center_can_give_troops",
        [
            (store_script_param, ":center_no", 1),
            (store_script_param, ":party_receiver", 2),

            (call_script, "script_party_get_wages", ":center_no"),
            (assign, ":center_wages", reg0),
            (call_script, "script_party_get_prefered_wages_limit", ":center_no"),
            (store_div, ":center_limit", reg1, 2),
            (try_begin),
                (party_slot_eq, ":center_no", slot_party_type, spt_village),
                (val_div, ":center_limit", 2), # Forces villages to give troops to their lord
            (try_end),

            (party_get_slot, ":besieger", ":center_no", slot_party_besieged_by),
            (lt, ":besieger", 0),

            (gt, ":center_wages", ":center_limit"), # Do not give troops if not enough men in the center

            (assign, ":continue", 1),
            (try_begin),
                (neq, ":party_receiver", -1),
                (call_script, "script_party_get_masked_garrison_flags", ":center_no", ":party_receiver"),
                (assign, ":flags", reg0),
                (eq, ":flags", 0),
                (assign, ":continue", 0),
            (try_end),
            (eq, ":continue", 1),
        ]),

    # script_party_get_masked_garrison_flags
        # input:
        #   arg1: party_no
        #   arg2: related_party
        # output:
        #   reg0: garrison_flag_masked
    ("party_get_masked_garrison_flags",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":related_party", 2),

            (assign, ":garrison_flags", 0),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (party_slot_eq, ":party_no", slot_party_lord, "$g_player_troop"),
                (party_get_slot, ":garrison_flags", ":party_no", slot_party_player_garrison_flags),
            (else_try),
                (try_begin),
                    (eq, ":party_type", spt_village),
                    (assign, ":garrison_flags", pgf_default_village_mask),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (assign, ":garrison_flags", pgf_default_castle_mask),
                (else_try),
                    (eq, ":party_type", spt_town),
                    (assign, ":garrison_flags", pgf_default_town_mask),
                (try_end),
            (try_end),
            (assign, ":mask", pgf_sell_unknown_mask),
            (try_begin),
                (neq, ":related_party", -1),
                (store_faction_of_party, ":related_faction", ":related_party"),
                (store_faction_of_party, ":party_faction", ":party_no"),
                (try_begin),
                    (eq, ":related_faction", ":party_faction"),
                    (assign, ":mask", pgf_sell_faction_mask),
                    (try_begin),
                        (eq, ":party_type", spt_war_party),
                        (party_get_slot, ":related_leader", ":related_party", slot_party_leader),
                        (party_get_slot, ":party_leader", ":party_no", slot_party_leader),
                        (neq, ":party_leader", -1),
                        (neq, ":related_leader", -1),
                        (call_script, "script_cf_troop_is_vassal_of", ":related_leader", ":party_leader", 1),
                        (assign, ":mask", pgf_sell_vassals_mask),
                    (else_try),
                        (eq, ":party_type", spt_convoy),
                        (assign, ":mask", pgf_send_mask),
                    (try_end),
                (try_end),
            (try_end),
            (store_and, ":active_flags", ":garrison_flags", ":mask"),
            (assign, reg0, ":active_flags"),
        ]),

    # script_party_give_prisoners_to_party
        # input:
        #   arg1: party_giver
        #   arg2: party_receiver
        # output:
        #   reg0: num_prisoners_given
    ("party_give_prisoners_to_party",
        [
            (store_script_param, ":party_giver", 1),
            (store_script_param, ":party_receiver", 2),

            (assign, ":num_prisoners_given", 0),

            (party_get_num_prisoner_stacks, ":num_prisoner_stacks", ":party_giver"),
            (try_for_range_backwards, ":cur_stack", 0, ":num_prisoner_stacks"),
                (party_prisoner_stack_get_troop_id, ":prisoner_troop_id", ":party_giver", ":cur_stack"),

                (party_prisoner_stack_get_size, ":stack_size", ":party_giver", ":cur_stack"),

                (party_remove_prisoners, ":party_giver", ":prisoner_troop_id", ":stack_size"),
                (assign, ":removed", reg0),
                (gt, ":removed", 0),
                (val_add, ":num_prisoners_given", ":stack_size"),
                (party_force_add_prisoners, ":party_receiver", ":prisoner_troop_id", ":stack_size"),
                (try_begin),
                    (troop_is_hero, ":prisoner_troop_id"),
                    (troop_set_slot, ":prisoner_troop_id", slot_troop_prisoner_of, ":party_receiver"),
                (try_end),
            (try_end),
            (assign, reg0, ":num_prisoners_given"),
        ]),

    # script_party_patrol_process
        # input:
        #   arg1: party_no
        # output: none
    ("party_patrol_process",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":last_rest", ":party_no", slot_party_last_rest),
            (party_get_slot, ":home", ":party_no", slot_party_linked_party),
            (call_script, "script_party_get_wages", ":party_no"),
            (assign, ":current_wages", reg0),

            (party_get_num_companions, ":num_troops", ":party_no"),
            (party_get_num_prisoners, ":num_prisoners", ":party_no"),
            (val_mul, ":num_prisoners", 2),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),
            (store_sub, ":rest_time", ":current_day", ":last_rest"),

            (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
            (assign, ":wanted_wages", reg0),
            (assign, ":min_wages", reg1),
            (assign, ":max_wages", reg2),


            (assign, ":go_home", 0),
            (try_begin),
                (ge, ":num_prisoners", ":num_troops"),
                (assign, ":go_home", 1),
            (else_try),
                (gt, ":rest_time", 10*24),
                (assign, ":go_home", 1),
            (else_try),
                (le, ":current_wages", ":min_wages"),
                (assign, ":go_home", 1),
            # (else_try),
            #     (ge, ":current_wages", ":max_wages"),
            #     (assign, ":go_home", 1),
            (try_end),

            (try_begin),
                # Do center business
                (party_get_cur_town, ":cur_town", ":party_no"),
                (try_begin),
                    (is_between, ":cur_town", centers_begin, centers_end),

                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),

                    (party_get_slot, ":new_budget", ":cur_town", slot_party_budget_reserved_auxiliaries),
                    (party_set_slot, ":party_no", slot_party_budget_reserved_party, ":new_budget"),
                    (party_set_slot, ":party_no", slot_party_wanted_party_wages, ":new_budget"),

                    (try_begin),
                        (ge, ":num_prisoners", 1),
                        (call_script, "script_party_give_prisoners_to_party", ":party_no", ":cur_town"),
                    (try_end),
                    (try_begin),
                        (le, ":current_wages", ":wanted_wages"),
                        (assign, ":go_home", 1),

                        (call_script, "script_cf_center_can_give_troops", ":cur_town", ":party_no"),
                        (store_random_in_range, ":num_troops", 3, 7),
                        (call_script, "script_party_give_troops_to_party", ":cur_town", ":party_no", ":num_troops"),
                    (else_try),
                        (gt, ":current_wages", ":max_wages"),
                        (call_script, "script_party_give_troops_to_party", ":party_no", ":cur_town", 3),
                    (try_end),

                    (call_script, "script_party_pay_debts", ":party_no"),
                (try_end),
            (try_end),
            (try_begin),
                (eq, ":go_home", 1),
                (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":home"),
                # Go back home
            # (else_try),
                # Assist another party ?
            (else_try),
                # Patrol center
                (party_get_slot, ":home", ":party_no", slot_party_linked_party),
                (call_script, "script_party_set_behavior", ":party_no", tai_patroling_center, ":home"),
            (try_end),
        ]),

    # script_party_caravan_process
        # input:
        #   arg1: party_no
        # output: none
    ("party_caravan_process",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":mission_object", ":party_no", slot_party_mission_object),
            (party_get_slot, ":mission", ":party_no", slot_party_mission),
            (party_get_cur_town, ":cur_town", ":party_no"),
            (party_get_slot, ":home", ":party_no", slot_party_linked_party),

            (try_begin),
                (eq, ":cur_town", ":mission_object"),
                (is_between, ":cur_town", centers_begin, centers_end),

                (call_script, "script_get_current_day"),
                (assign, ":current_day", reg0),
                (try_begin),
                    (eq, ":cur_town", ":home"),
                    (call_script, "script_party_get_wages", ":party_no"),
                    (assign, ":current_wages", reg0),
                    (call_script, "script_party_get_prefered_wages_limit", ":party_no"),
                    (assign, ":wanted_wages", reg0),

                    (party_get_num_prisoners, ":num_prisoners", ":party_no"),
                    (try_begin),
                        (ge, ":num_prisoners", 1),
                        (call_script, "script_party_give_prisoners_to_party", ":party_no", ":cur_town"),
                    (try_end),

                    (call_script, "script_party_empty_goods", ":party_no", ":home"),
                    (call_script, "script_party_caravan_select_destination", ":party_no"),
                    (assign, ":new_destination", reg0),
                    (try_begin),
                        (le, ":current_wages", ":wanted_wages"),
                        (eq, ":cur_town", ":home"),
                        (try_begin),
                            (call_script, "script_cf_center_can_give_troops", ":cur_town", ":party_no"),
                            (store_random_in_range, ":num_troops", 3, 7),
                            (call_script, "script_party_give_troops_to_party", ":cur_town", ":party_no", ":num_troops"),
                        (try_end),
                    (else_try),
                        (eq, ":new_destination", ":home"),
                        (call_script, "script_party_caravan_set_objectives", ":party_no"),
                        (try_begin),
                            (party_slot_ge, ":party_no", slot_party_mission_objective_1, goods_begin),
                            (call_script, "script_party_caravan_set_destination", ":party_no"),
                        (else_try),
                            (call_script, "script_cf_debug", debug_trade),
                            (str_store_party_name, s10, ":party_no"),
                            (str_store_party_name, s11, ":home"),
                            (display_message, "@{s10} from {s11} has no objective and stays put"),
                        (try_end),
                    (else_try),
                        (party_set_slot, ":party_no", slot_party_mission, spm_trade),
                        (party_set_slot, ":party_no", slot_party_mission_object, ":new_destination"),
                        (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":new_destination"),
                    (try_end),

                (else_try),
                    (eq, ":mission", spm_trade),
                    (party_set_slot, ":party_no", slot_party_mission, spm_waiting),
                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),
                    (call_script, "script_party_caravan_clear_destination", ":party_no", ":cur_town"),
                (else_try),
                    (party_get_slot, ":last_rest", ":party_no", slot_party_last_rest),
                    (store_sub, ":rest_time", ":current_day", ":last_rest"),
                    (gt, ":rest_time", 18),
                    (call_script, "script_party_caravan_select_destination", ":party_no"),
                    (assign, ":new_destination", reg0),
                    (call_script, "script_party_caravan_prepare_trading_run", ":party_no", ":new_destination", ":cur_town"),
                    (party_set_slot, ":party_no", slot_party_mission, spm_trade),
                    (party_set_slot, ":party_no", slot_party_mission_object, ":new_destination"),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":new_destination"),
                (try_end),
            (else_try),
                (eq, ":mission_object", -1),
                (call_script, "script_party_caravan_select_destination", ":party_no"),
                (assign, ":new_destination", reg0),

                (try_begin),
                    (is_between, ":new_destination", centers_begin, centers_end),
                    (neq, ":cur_town", ":new_destination"),
                    (party_set_slot, ":party_no", slot_party_mission, spm_trade),
                    (party_set_slot, ":party_no", slot_party_mission_object, ":new_destination"),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":new_destination"),
                (try_end),
            (try_end),
        ]),

    # script_party_caravan_set_objectives
        # input:
        #   arg1: party_no
        # output: none
    ("party_caravan_set_objectives",
        [
            (store_script_param, ":party_no", 1),
            (party_get_slot, ":home", ":party_no", slot_party_linked_party),

            (assign, ":end_loop", slot_party_mission_objective_3 + 1),
            (try_for_range, ":slot", slot_party_mission_objective_1, ":end_loop"),
                (assign, ":chosen_item", 0),
                (assign, ":chosen_item_score", 9999),
                (try_for_range, ":item", goods_begin, goods_end),

                    (assign, ":exists", 0),
                    (try_for_range, ":other_slot", slot_party_mission_objective_1, slot_party_mission_objective_3 + 1),
                        (party_get_slot, ":other_value", ":party_no", ":other_slot"),
                        (eq, ":other_value", ":item"),
                        (assign, ":exists", 1),
                    (try_end),
                    (try_begin),
                        (eq, ":exists", 0),
                        (call_script, "script_party_item_get_caravan_score", ":home", ":item"),
                        (assign, ":score", reg0),
                        (lt, ":score", ":chosen_item_score"),
                        (assign, ":chosen_item", ":item"),
                        (assign, ":chosen_item_score", ":score"),
                    (try_end),
                (try_end),

                (try_begin),
                    (lt, ":chosen_item_score", 9999),
                    (gt, ":chosen_item", goods_begin),
                    (party_set_slot, ":party_no", ":slot", ":chosen_item"),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_trade),
                        (str_store_party_name, s10, ":home"),
                        (str_store_item_name, s11, ":chosen_item"),
                        (assign, reg10, ":chosen_item_score"),
                        (display_message, "@Caravan from {s10} targets {s11} : {reg10}"),
                    (try_end),
                (else_try),
                    (assign, ":end_loop", 0),
                (try_end),
            (try_end),

        ]),

    # script_party_caravan_select_destination
        # input:
        #   arg1: party_no
        # output:
        #   reg0: destination
    ("party_caravan_select_destination",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":current_destination", ":party_no", slot_party_mission_object),
            (try_begin),
                (party_get_slot, ":option_1", ":party_no", slot_party_mission_target_1),
                (is_between, ":option_1", centers_begin, centers_end),
                (neq, ":option_1", ":current_destination"),
                (assign, reg0, ":option_1"),
            (else_try),
                (party_get_slot, ":option_2", ":party_no", slot_party_mission_target_2),
                (is_between, ":option_2", centers_begin, centers_end),
                (neq, ":option_2", ":current_destination"),
                (assign, reg0, ":option_2"),
            (else_try),
                (party_get_slot, ":option_3", ":party_no", slot_party_mission_target_3),
                (is_between, ":option_3", centers_begin, centers_end),
                (neq, ":option_3", ":current_destination"),
                (assign, reg0, ":option_3"),
            (else_try),
                (party_get_slot, ":linked_party", ":party_no", slot_party_linked_party),
                (is_between, ":linked_party", centers_begin, centers_end),
                (assign, reg0, ":linked_party"),
            (else_try),
                (assign, reg0, -1),
            (try_end),
        ]),


    # script_party_caravan_set_destination
        # input:
        #   arg1: party_no
        # output: none
    ("party_caravan_set_destination",
        [
            (store_script_param, ":party_no", 1),
            (party_get_slot, ":home", ":party_no", slot_party_linked_party),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (assign, ":end_loop", slot_party_mission_target_3 + 1),
            (try_for_range, ":slot", slot_party_mission_target_1, ":end_loop"),

                (assign, ":chosen_center", 0),
                (assign, ":chosen_center_score", 9999),
                (try_for_range, ":center", towns_begin, towns_end),

                    (try_begin),
                        (store_faction_of_party, ":center_faction", ":center"),
                        (store_relation, ":relation", ":center_faction", ":party_faction"),
                        (lt, ":relation", 0),
                    (else_try),
                        (assign, ":exists", 0),
                        (try_for_range, ":other_slot", slot_party_mission_target_1, slot_party_mission_target_3 + 1),
                            (party_get_slot, ":other_value", ":party_no", ":other_slot"),
                            (eq, ":other_value", ":center"),
                            (assign, ":exists", 1),
                        (try_end),
                        (try_begin),
                            (eq, ":exists", 0),
                            (neq, ":center", ":home"),
                            (call_script, "script_party_center_get_caravan_score", ":center", ":party_no", ":home", caravan_score_type_buying),
                            (assign, ":score", reg0),
                            (lt, ":score", ":chosen_center_score"),
                            (assign, ":chosen_center", ":center"),
                            (assign, ":chosen_center_score", ":score"),
                        (try_end),
                    (try_end),
                (try_end),

                (try_begin),
                    (lt, ":chosen_center_score", 9999),
                    (ge, ":chosen_center", towns_begin),
                    (party_set_slot, ":party_no", ":slot", ":chosen_center"),

                    (try_begin),
                        (call_script, "script_cf_debug", debug_trade),
                        (str_store_party_name, s10, ":home"),
                        (str_store_party_name, s11, ":chosen_center"),
                        (assign, reg10, ":chosen_center_score"),
                        (display_message, "@Caravan from {s10} targets {s11} : {reg10}"),
                    (try_end),
                (else_try),
                    (assign, ":end_loop", 0),
                (try_end),
            (try_end),
        ]),

    # script_party_center_get_caravan_score
        # input:
        #   arg1: center
        #   arg2: caravan
        #   arg3: caravan_home
        #   arg4: score_type: caravan_score_type_buying / caravan_score_type_selling / caravan_score_type_all
        # output:
        #   reg0: score
    ("party_center_get_caravan_score",
        [
            (store_script_param, ":center", 1),
            (store_script_param, ":caravan", 2),
            (store_script_param, ":caravan_home", 3),
            (store_script_param, ":score_type", 4),

            (store_distance_to_party_from_party, ":distance", ":center", ":caravan_home"),
            (store_mul, ":distance_score", ":distance", caravan_score_distance_ratio),
            (val_div, ":distance_score", 100),

            (assign, ":resource_score", 0),

            (assign, ":has_objective", 0),
            (store_add, ":end", slot_party_mission_objective_3, 1),
            (try_for_range, ":objective_slot", slot_party_mission_objective_1, ":end"),
                (party_get_slot, ":objective", ":caravan", ":objective_slot"),
                (is_between, ":objective", goods_begin, goods_end),
                (assign, ":has_objective", 1),
            (try_end),

            (try_for_range, ":resource", goods_begin, goods_end),
                (assign, ":continue", 0),
                (try_begin),
                    (eq, ":has_objective", 1),
                    (assign, ":is_objective", 0),
                    (store_add, ":end", slot_party_mission_objective_3, 1),
                    (try_for_range, ":objective_slot", slot_party_mission_objective_1, ":end"),
                        (party_slot_eq, ":caravan", ":objective_slot", ":resource"),
                        (assign, ":is_objective", 1),
                    (try_end),
                    (try_begin),
                        (eq, ":is_objective", 1),
                        (assign, ":continue", 1),
                    (try_end),
                (else_try),
                    (assign, ":continue", 1),
                (try_end),

                (eq, ":continue", 1),
                (call_script, "script_party_item_get_caravan_score", ":center", ":resource"),
                (assign, ":score", reg0),
                (try_begin),
                    (eq, ":score_type", caravan_score_type_buying),
                    (val_sub, ":resource_score", ":score"),
                (else_try),
                    (eq, ":score_type", caravan_score_type_selling),
                    (val_add, ":resource_score", ":score"),
                (else_try),
                    (val_abs, ":score"),
                    (val_sub, ":resource_score", ":score"),
                (try_end),
            (try_end),

            (store_add, ":total", ":distance_score", ":resource_score"),

            (party_get_slot, ":center_faction", ":center", slot_party_faction),
            (try_begin),
                (is_between, ":center_faction", kingdoms_begin, kingdoms_end),
                (faction_get_slot, ":at_war", ":center_faction", slot_faction_is_at_war),
                (gt, ":at_war", 0),
                (val_add, ":total", caravan_score_war_penatly),
            (try_end),

            # (try_begin),
            #     (call_script, "script_cf_debug", debug_trade),
            #     (str_store_party_name, s10, ":caravan_home"),
            #     (str_store_party_name, s11, ":center"),
            #     (assign, reg10, ":resource_score"),
            #     (assign, reg12, ":distance_score"),
            #     (assign, reg13, ":total"),
            #     (display_message, "@Caravan from {s10} score for {s11} : {reg10} + distance {reg12} = {reg13}"),
            # (try_end),

            (assign, reg0, ":total"),
        ]),

    # script_party_item_get_caravan_score
        # input:
        #   arg1: center
        #   arg2: item
        # output:
        #   reg0: score : <0 => center wants to buy - >0 => center wants to sell
    ("party_item_get_caravan_score",
        [
            (store_script_param, ":center", 1),
            (store_script_param, ":item", 2),

            (store_sub, ":offset", ":item", goods_begin),
            (store_add, ":production_slot", slot_party_item_last_produced_begin, ":offset"),
            (store_add, ":consumption_slot", slot_party_item_consumed_begin, ":offset"),
            (store_add, ":amount_slot", slot_party_ressources_current_amount_begin, ":offset"),
            (party_get_slot, ":center_production", ":center", ":production_slot"),
            (party_get_slot, ":center_consumption", ":center", ":consumption_slot"),
            (party_get_slot, ":center_amount", ":center", ":amount_slot"),

            # (assign, ":resource_need_score", 0),
            # (assign, ":resource_amount_score", 0),

            (store_mul, ":center_score", ":center_amount", caravan_score_resource_amount_ratio),
            (val_div, ":center_score", 100),

            (store_sub, ":center_offset", ":center_production", ":center_consumption"),
            (store_mul, ":center_offset_score", ":center_offset", caravan_score_resource_production_ratio),
            (val_div, ":center_offset_score", 100),

            (assign, ":score", 0),

            (try_begin),
                (eq, ":center_offset_score", 0),
                # We are uncertain on if we want to buy or sell

                (store_sub, ":score", ":center_score", 50),
                # (val_div, ":score", 10),
            (else_try),
                (gt, ":center_offset_score", 0),
                # We might want to sell this item -> positive score

                (store_sub, ":score", ":center_offset_score", ":center_score"),
                (val_max, ":score", 0),
            (else_try),
                # We might want to buy this item -> negative score

                (store_add, ":score", ":center_offset_score", ":center_score"),
                (val_min, ":score", 0),
            (try_end),

            # (party_get_slot, ":caravan_home", ":caravan", slot_party_linked_party),

            # (party_get_slot, ":caravan_home_production", ":caravan_home", ":production_slot"),
            # (party_get_slot, ":caravan_home_consumption", ":caravan_home", ":consumption_slot"),
            # (store_sub, ":caravan_home_offset", ":caravan_home_production", ":caravan_home_consumption"),

            # (try_begin),
            #     # (ge, ":caravan_home_offset", 0),
            #     (try_begin),
            #         (neq, ":score_type", caravan_score_type_buying),
            #         # We want to buy
            #         (store_mul, ":current_resource_amount_score", ":center_offset", 1),
            #         # (store_mul, ":current_resource_need_score", ":caravan_home_offset", -1),

            #         (val_add, ":resource_amount_score", ":current_resource_amount_score"),
            #         # (val_add, ":resource_need_score", ":current_resource_need_score"),
            #     (try_end),
            # (else_try),
            #     # (lt, ":caravan_home_offset", 0),
            #     (try_begin),
            #         (neq, ":score_type", caravan_score_type_selling),
            #         # We want to sell
            #         (store_mul, ":current_resource_amount_score", ":center_offset", -1),
            #         # (store_mul, ":current_resource_need_score", ":caravan_home_offset", 1),

            #         (val_add, ":resource_amount_score", ":current_resource_amount_score"),
            #         # (val_add, ":resource_need_score", ":current_resource_need_score"),
            #     (try_end),
            # (try_end),

            # (val_mul, ":resource_amount_score", caravan_score_resource_production_ratio),
            # (val_div, ":resource_amount_score", 100),
            # (val_mul, ":resource_need_score", caravan_score_resource_need_ratio),
            # (val_div, ":resource_need_score", 100),

            # (store_add, ":score", ":resource_amount_score", ":resource_need_score"),
            (assign, reg0, ":score"),
        ]),

    # script_party_caravan_clear_destination
        # input:
        #   arg1: party_no
        #   arg2: clear_destination
        # output: none
    ("party_caravan_clear_destination",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":clear_destination", 2),

            (try_begin),
                (party_get_slot, ":option", ":party_no", slot_party_mission_target_1),
                (eq, ":option", ":clear_destination"),
                (party_set_slot, ":party_no", slot_party_mission_target_1, -1),
            (else_try),
                (party_get_slot, ":option", ":party_no", slot_party_mission_target_2),
                (eq, ":option", ":clear_destination"),
                (party_set_slot, ":party_no", slot_party_mission_target_2, -1),
            (else_try),
                (party_get_slot, ":option", ":party_no", slot_party_mission_target_3),
                (eq, ":option", ":clear_destination"),
                (party_set_slot, ":party_no", slot_party_mission_target_3, -1),
            (try_end),
        ]),

    # script_party_caravan_prepare_trading_run
        # input:
        #   arg1: party_caravan
        #   arg2: destination
        #   arg3: origin
        # output: none
    ("party_caravan_prepare_trading_run",
        [
            (store_script_param, ":party_caravan", 1),
            (store_script_param, ":destination", 2),
            (store_script_param, ":origin", 3),

            (party_set_slot, ":party_caravan", slot_party_player_shakedown, 0),

            (assign, ":number_objectives", 0),
            (try_for_range, ":slot", slot_party_mission_objective_1, slot_party_mission_objective_3 + 1),
                (party_slot_ge, ":party_caravan", ":slot", goods_begin),
                (val_add, ":number_objectives", 1),
            (try_end),

            (assign, ":total_amount", 0),
            (try_for_range, ":item", goods_begin, goods_end),
                (store_sub, ":offset", ":item", goods_begin),
                (store_add, ":slot_amount", slot_party_ressources_current_amount_begin, ":offset"),
                (party_get_slot, ":amount", ":party_caravan", ":slot_amount"),
                (val_add, ":total_amount", ":amount"),
            (try_end),
            (store_sub, ":remaining_cargo", caravan_max_cargo_size, ":total_amount"),

            (try_begin),
                (gt, ":number_objectives", 0),
                (store_div, ":amount_goal", caravan_max_cargo_size, ":number_objectives"),
                (try_for_range, ":item", goods_begin, goods_end),
                    (assign, ":is_objective", 0),
                    (try_begin),
                        (store_sub, ":offset", ":item", goods_begin),
                        (store_add, ":slot_amount", slot_party_ressources_current_amount_begin, ":offset"),
                        (party_get_slot, ":amount", ":party_caravan", ":slot_amount"),
                        (lt, ":amount", ":amount_goal"),
                        (try_for_range, ":slot", slot_party_mission_objective_1, slot_party_mission_objective_3 + 1),
                            (party_slot_eq, ":party_caravan", ":slot", ":item"),
                            (assign, ":is_objective", 1),
                        (try_end),
                    (try_end),
                    (try_begin),
                        (eq, ":is_objective", 1),
                        (store_sub, ":offset", ":item", goods_begin),
                        (store_add, ":slot_amount", slot_party_ressources_current_amount_begin, ":offset"),
                        (party_get_slot, ":amount", ":party_caravan", ":slot_amount"),
                        (le, ":amount", ":amount_goal"),
                        (store_sub, ":amount_to_buy", ":amount_goal", ":amount"),
                        (call_script, "script_party_buy_item_from_party", ":party_caravan", ":item", ":origin", ":amount_to_buy"),
                        (val_sub, ":remaining_cargo", reg0),
                    (try_end),
                (try_end),
            (try_end),

            (call_script, "script_party_get_wages", ":party_caravan"),
            (assign, ":wages_caravan", reg0),
            (store_mul, ":needed_wages", ":wages_caravan", 4),
            (call_script, "script_party_transfer_wealth", ":origin", ":party_caravan", ":needed_wages", tax_type_caravan_wages, tax_type_caravan_wages),

            (try_begin),
                (gt, ":remaining_cargo", 0),
                # TODO: buy goods to sell to next destination
            (try_end),
            (try_begin),
                (call_script, "script_cf_debug", debug_trade),
                (assign, reg10, ":remaining_cargo"),
                (str_store_party_name, s10, ":party_caravan"),
                (str_store_party_name, s11, ":origin"),
                (str_store_party_name, s12, ":destination"),
                (display_message, "@Caravan {s10} from {s11} has {reg10} cargo space heading for {s12}"),
            (try_end),
        ]),

    # script_party_civilian_process
        # input:
        #   arg1: party_no
        # output: none
    ("party_civilian_process",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":target_1", ":party_no", slot_party_mission_target_1),
            (party_get_slot, ":target_2", ":party_no", slot_party_mission_target_2),
            (party_get_slot, ":target_3", ":party_no", slot_party_mission_target_3),

            (party_get_slot, ":home", ":party_no", slot_party_linked_party),
            (party_get_slot, ":linked_center", ":home", slot_party_linked_party),
            (party_get_cur_town, ":cur_town", ":party_no"),

            (call_script, "script_get_current_day"),
            (assign, ":current_day", reg0),

            (try_begin),
                (eq, ":target_1", -1),
                (eq, ":target_2", -1),
                (eq, ":target_3", -1),
                (try_begin),
                    (eq, ":cur_town", ":home"),
                    (assign, ":nearest_trader", -1),
                    (party_get_slot, ":linked_center_party_type", ":linked_center", slot_party_type),
                    (try_begin),
                        (neq, ":linked_center_party_type", spt_town),

                        (call_script, "script_party_get_nearest_trade_town", ":home"),
                        (assign, ":nearest_trader", reg0),
                    (try_end),

                    (assign, ":target_1", ":linked_center"),
                    (assign, ":target_2", ":home"),
                    (assign, ":target_3", ":nearest_trader"),

                    (party_set_slot, ":party_no", slot_party_mission_target_1, ":target_1"),
                    (party_set_slot, ":party_no", slot_party_mission_target_2, ":target_2"),
                    (party_set_slot, ":party_no", slot_party_mission_target_3, ":target_3"),

                    # Load cargo
                    # Heading to linked center
                    (call_script, "script_party_empty_goods", ":party_no", ":home"),
                    (call_script, "script_party_civilian_load_goods", ":party_no", ":home", ":linked_center"),
                    (call_script, "script_party_civilian_manage_party_size", ":party_no", ":home"),

                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),
                (else_try),
                    (party_set_slot, ":party_no", slot_party_mission, spm_trade),
                    (party_set_slot, ":party_no", slot_party_mission_object, ":home"),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":home"),
                (try_end),
            (else_try),
                (party_get_slot, ":last_rest", ":party_no", slot_party_last_rest),
                (store_sub, ":rest_time", ":current_day", ":last_rest"),
                (le, ":rest_time", 12),
                # We still want to rest
            (else_try),
                (is_between, ":target_1", centers_begin, centers_end),
                (try_begin),
                    (eq, ":cur_town", ":target_1"),
                    # Do trade
                    (call_script, "script_party_empty_goods", ":party_no", ":target_1"),
                    (try_begin),
                        (is_between, ":target_2", centers_begin, centers_end),
                        (call_script, "script_party_civilian_load_goods", ":party_no", ":target_1", ":target_2"),
                    (else_try),
                        (neq, ":target_1", ":home"),
                        (call_script, "script_party_civilian_load_goods", ":party_no", ":target_1", ":home"),
                    (try_end),

                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),
                    (party_set_slot, ":party_no", slot_party_mission_target_1, -1),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":target_1"),
                (try_end),
            (else_try),
                (is_between, ":target_2", centers_begin, centers_end),
                (try_begin),
                    (eq, ":cur_town", ":target_2"),
                    # Do trade
                    (call_script, "script_party_empty_goods", ":party_no", ":target_2"),
                    (try_begin),
                        (is_between, ":target_3", centers_begin, centers_end),
                        (call_script, "script_party_civilian_load_goods", ":party_no", ":target_2", ":target_3"),
                    (else_try),
                        (neq, ":target_2", ":home"),
                        (call_script, "script_party_civilian_load_goods", ":party_no", ":target_2", ":home"),
                    (try_end),

                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),
                    (party_set_slot, ":party_no", slot_party_mission_target_2, -1),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":target_2"),
                (try_end),
            (else_try),
                (is_between, ":target_3", centers_begin, centers_end),
                (try_begin),
                    (eq, ":cur_town", ":target_3"),
                    # Do trade
                    (call_script, "script_party_empty_goods", ":party_no", ":target_3"),
                    (call_script, "script_party_civilian_load_goods", ":party_no", ":target_3", ":home"),

                    (party_set_slot, ":party_no", slot_party_last_rest, ":current_day"),
                    (party_set_slot, ":party_no", slot_party_mission_target_3, -1),
                (else_try),
                    (call_script, "script_party_set_behavior", ":party_no", tai_traveling_to_party, ":target_3"),
                (try_end),
            (else_try),

            (try_end),

            # (party_get_slot, ":mission_object", ":party_no", slot_party_mission_object),
            # (party_get_slot, ":mission", ":party_no", slot_party_mission),
        ]),

    # script_party_civilian_load_goods
        # input:
        #   arg1: party_no
        #   arg2: origin
        #   arg3: destination
        # output: none
    ("party_civilian_load_goods",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":origin", 2),
            (store_script_param, ":destination", 3),

            (party_get_slot, ":origin_party_type", ":origin", slot_party_type),
            (party_get_slot, ":destination_party_type", ":destination", slot_party_type),

            (assign, ":origin_ratio", 100),
            (assign, ":destination_ratio", 100),
            (try_begin),
                (neq, ":origin_party_type", spt_town),
                (assign, ":origin_ratio", 10),
            (try_end),
            (try_begin),
                (neq, ":destination_party_type", spt_town),
                (assign, ":destination_ratio", 10),
            (try_end),

            (assign, ":max_score", 0),
            (assign, ":best_good", -1),
            (try_for_range, ":good", goods_begin, goods_end),
                (call_script, "script_party_item_get_caravan_score", ":origin", ":good"),
                (assign, ":origin_score", reg0),
                (call_script, "script_party_item_get_caravan_score", ":destination", ":good"),
                (store_mul, ":destination_score", reg0, -1),

                (val_mul, ":origin_score", ":origin_ratio"),
                (val_div, ":origin_score", 100),
                (val_mul, ":destination_score", ":destination_ratio"),
                (val_div, ":destination_score", 100),

                (store_add, ":total_score", ":origin_score", ":destination_score"),
                (gt, ":total_score", ":max_score"),
                (assign, ":max_score", ":total_score"),
                (assign, ":best_good", ":good"),
            (try_end),

            (try_begin),
                (is_between, ":best_good", goods_begin, goods_end),
                (store_sub, ":offset", ":best_good", goods_begin),
                (store_add, ":amount_slot", slot_party_ressources_current_amount_begin, ":offset"),
                (party_get_slot, ":origin_amount", ":origin", ":amount_slot"),
                (val_min, ":origin_amount", civilian_max_cargo_size),
                (call_script, "script_party_buy_item_from_party", ":party_no", ":best_good", ":origin", ":origin_amount"),
                (try_begin),
                    (call_script, "script_cf_debug", debug_trade|debug_economy),
                    (str_store_party_name, s10, ":origin"),
                    (str_store_party_name, s11, ":party_no"),
                    (str_store_item_name, s12, ":best_good"),
                    (assign, reg10, ":origin_amount"),
                    (display_message, "@{s10} loading {reg10} {s12} into {s11}"),
                (try_end),
            (try_end),
        ]),

    # script_party_civilian_manage_party_size
        # input:
        #   arg1: party_no
        # output: none
    ("party_civilian_manage_party_size",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":attached_center", 2),

            (party_get_num_prisoners, ":prisoners", ":party_no"),
            (try_begin),
                (gt, ":prisoners", 0),
                (call_script, "script_party_transfer_prisoners_to_prisoners", ":party_no", ":attached_center", 1),
            (try_end),

            (store_faction_of_party, ":party_faction", ":party_no"),
            (faction_get_slot, ":culture", ":party_faction", slot_faction_culture),
            (faction_get_slot, ":peasant_troop", ":culture", slot_faction_peasant_troop),

            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range_backwards, ":cur_stack", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_id", ":party_no", ":cur_stack"),
                (neq, ":troop_id", ":peasant_troop"),
                (party_stack_get_size, ":stack_size", ":party_no", ":cur_stack"),

                (party_add_members, ":attached_center", ":troop_id", ":stack_size"),
                (assign, ":really_added", reg0),
                (party_remove_members, ":party_no", ":troop_id", ":really_added"),
            (try_end),

            (party_get_num_companions, ":current_troops", ":party_no"),

            (store_random_in_range, ":num_troops", civilian_party_min_size, civilian_party_max_size),
            
            (try_begin),
                (lt, ":num_troops", civilian_party_min_size),
                (store_sub, ":offset", ":num_troops", ":current_troops"),
                (party_add_members, ":party_no", ":peasant_troop", ":offset"),
                (store_mul, ":population_change", ":offset", -1),
                (call_script, "script_party_modify_population", ":attached_center", ":population_change"),
            (try_end),

            # TODO: BUILDING
            # We need to gate this part behind a building
            # (try_begin),
            #     (call_script, "script_cf_center_can_give_troops", ":attached_center", -1),
            #     (call_script, "script_party_give_troops_to_party", ":attached_center", ":spawned_party", 4),
            # (try_end),
        ]),

    # script_party_get_nearest_trade_town
        # input:
        #   arg1: party_no
        # output:
        #   reg0: nearest_town
    ("party_get_nearest_trade_town",
        [
            (store_script_param, ":party_no", 1),

            (assign, ":min_distance", 9999),
            (assign, ":nearest_trader", -1),
            (store_faction_of_party, ":party_faction", ":party_no"),
            (try_for_range, ":cur_center", towns_begin, towns_end),
                (store_faction_of_party, ":cur_center_faction", ":cur_center"),
                (assign, ":ratio", 0),
                (try_begin),
                    (eq, ":cur_center_faction", ":party_faction"),
                    (assign, ":ratio", 20),
                (else_try),
                    (call_script, "script_cf_factions_are_at_war", ":cur_center_faction", ":party_faction"),
                    (assign, ":ratio", 0),
                (else_try),
                    (call_script, "script_faction_get_treaties", ":party_faction", ":cur_center_faction"),
                    (assign, ":treaties", reg0),

                    (store_and, ":trade_exclusivity", ":treaties", sfkt_trade_exclusivity),
                    (store_and, ":trade_preference", ":treaties", sfkt_trade_preference),
                    (store_and, ":open_trade", ":treaties", sfkt_open_trade),

                    (try_begin),
                        (gt, ":trade_exclusivity", 0),
                        (assign, ":ratio", 30),
                    (else_try),
                        (gt, ":trade_preference", 0),
                        (assign, ":ratio", 50),
                    (else_try),
                        (gt, ":open_trade", 0),
                        (assign, ":ratio", 100),
                    (else_try),
                        (assign, ":ratio", 200),
                    (try_end),
                (try_end),

                (gt, ":ratio", 0),

                (store_distance_to_party_from_party, ":distance", ":cur_center", ":party_no"),
                (val_mul, ":distance", ":ratio"),
                (val_div, ":distance", 100),

                (lt, ":distance", ":min_distance"),
                (assign, ":nearest_trader", ":cur_center"),
                (assign, ":min_distance", ":distance"),
            (try_end),
            (assign, reg0, ":nearest_trader"),
        ]),

    # script_item_get_buy_price_factor_from_party
        # input:
        #   arg1: item_no
        #   arg2: party_buyer
        #   arg3: party_no
        # output:
        #   reg0: price_factor
        #   reg0: tax_factor
    ("item_get_buy_price_factor_from_party",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":party_buyer", 2),
            (store_script_param, ":party_no", 3),

            (assign, ":price", 300),
            
            (try_begin),
                (is_between, ":party_no", centers_begin, centers_end),
                (is_between, ":item_no", goods_begin, goods_end),
                (party_get_slot, ":own_production", ":party_no", ":item_no"),
                (store_sub, ":production_modifier", 20, ":own_production"),
                (try_begin),
                    # We reduce the effect of own production the more we produce
                    # It is to avoid buying for ridiculous prices in highly productive places
                    (lt, ":production_modifier", 0), 
                    (store_mul, ":inv_prod", ":production_modifier", -1),
                    (val_div, ":inv_prod", 15),
                    (val_add, ":inv_prod", 1),
                    (val_div, ":production_modifier", ":inv_prod"),
                (try_end),
                (val_sub, ":price", ":production_modifier"),
            (try_end),
            
            (call_script, "script_party_get_skill_level", ":party_buyer", skl_trade),
            (assign, ":trade_skill", reg0),

            (val_mul, ":trade_skill", 5),
            (val_sub, ":price", ":trade_skill"),

            (party_get_slot, ":tax_rate", ":party_no", slot_party_taxes_buy),
            (val_add, ":price", ":tax_rate"),

            (assign, reg0, ":price"),
            (assign, reg1, ":tax_rate"),
        ]),

    # script_item_get_sell_price_factor_from_party
        # input:
        #   arg1: item_no
        #   arg2: party_seller
        #   arg3: party_no
        # output:
        #   reg0: price_factor
        #   reg0: tax_factor
    ("item_get_sell_price_factor_from_party",
        [
            (store_script_param, ":item_no", 1),
            (store_script_param, ":party_seller", 2),
            (store_script_param, ":party_no", 3),

            (assign, ":price", 25),
            
            (try_begin),
                (is_between, ":party_no", centers_begin, centers_end),
                (is_between, ":item_no", goods_begin, goods_end),
                (party_get_slot, ":own_production", ":party_no", ":item_no"),
                (store_add, ":production_modifier", -20, ":own_production"),
                (try_begin),
                    # We reduce the effect of own production the more we produce
                    # It is to avoid selling for ridiculous prices in highly productive places
                    (gt, ":production_modifier", 0),
                    (store_div, ":prod", ":production_modifier", 30),
                    (val_add, ":prod", 1),
                    (val_div, ":production_modifier", ":prod"),
                (try_end),
                (val_sub, ":price", ":production_modifier"),
            (try_end),
            
            (call_script, "script_party_get_skill_level", ":party_seller", skl_trade),
            (assign, ":trade_skill", reg0),

            (val_mul, ":trade_skill", 4),
            (val_add, ":price", ":trade_skill"),
            
            # (val_min, ":price", 95),
            (val_max, ":price", 5),

            (val_max, ":price", 105),
            
            (party_get_slot, ":tax_rate", ":party_no", slot_party_taxes_sell),
            (val_sub, ":price", ":tax_rate"),

            (assign, reg0, ":price"),
            (assign, reg1, ":tax_rate"),
        ]),

    # script_party_buy_item_from_party
        # input:
        #   arg1: party_buyer
        #   arg2: item
        #   arg3: party_seller
        #   arg4: amount_wanted
        # output:
        #   reg0: amount_bought
    ("party_buy_item_from_party",
        [
            (store_script_param, ":party_buyer", 1),
            (store_script_param, ":item", 2),
            (store_script_param, ":party_seller", 3),
            (store_script_param, ":amount_wanted", 4),

            (assign, ":amount_bought", 0),
            (try_begin),
                (is_between, ":item", goods_begin, goods_end),
                (call_script, "script_cf_party_can_sell_item", ":party_seller", ":item"),

                (store_sub, ":offset", ":item", goods_begin),
                (store_add, ":amount_slot", slot_party_ressources_current_amount_begin, ":offset"),
                (party_get_slot, ":seller_amount", ":party_seller", ":amount_slot"),

                # We don't want to buy everything
                (store_div, ":max_amount", ":seller_amount", 2),

                (val_min, ":amount_wanted", ":max_amount"),

                (call_script, "script_item_get_buy_price", ":item", ":party_buyer", ":party_seller"),
                (assign, ":price", reg0),
                (assign, ":tax", reg1),

                (store_mul, ":total_price", ":price", ":amount_wanted"),
                (store_mul, ":total_cost", ":total_price", -1),
                (store_mul, ":total_tax", ":tax", ":amount_wanted"),
                (val_add, ":total_cost", ":total_tax"),

                (store_sub, ":new_seller_amount", ":seller_amount", ":amount_wanted"),
                (party_set_slot, ":party_seller", ":amount_slot", ":new_seller_amount"),

                (party_get_slot, ":buyer_amount", ":party_buyer", ":amount_slot"),
                (val_add, ":buyer_amount", ":amount_wanted"),
                (party_set_slot, ":party_buyer", ":amount_slot", ":buyer_amount"),

                (call_script, "script_party_modify_wealth", ":party_buyer", ":total_cost"),
                (call_script, "script_party_transfer_wealth", ":party_buyer", ":party_seller", ":total_tax", tax_type_trade, tax_type_trade),

                (val_add, ":amount_bought", ":amount_wanted"),

                (try_begin),
                    (call_script, "script_cf_debug", debug_trade),
                    (str_store_party_name, s10, ":party_buyer"),
                    (str_store_item_name, s11, ":item"),
                    (str_store_party_name, s12, ":party_seller"),
                    (assign, reg10, ":amount_bought"),
                    (display_message, "@{s10} buying {reg10} {s11} from {s12}"),
                (try_end),
            (else_try),
                (call_script, "script_cf_debug", debug_simple),
                (str_store_item_name, s10, ":item"),
                (display_message, "@Trying to buy invalid item {s10} from party", text_color_impossible),
            (try_end),

            (assign, reg0, ":amount_bought"),
        ]),

    # script_cf_party_can_sell_item
        # input:
        #   arg1: party_seller
        #   arg2: item
        # output: none
    ("cf_party_can_sell_item",
        [
            # (store_script_param, ":party_seller", 1),
            # (store_script_param, ":item", 2),

            # TODO: refine, for now we always sell items

            (eq, 1, 1),
        ]),

    # script_party_enter_center
        # input:
        #   arg1: party_no
        #   arg2: center_no
        # output: none
    ("party_enter_center",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":center_no", 2),

            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (try_begin),
                (neq, ":party_type", spt_civilian),
                (party_attach_to_party, ":party_no", ":center_no"),
            (try_end),

            (try_begin),
                (is_between, ":center_no", centers_begin, centers_end),
                (party_get_slot, ":taxes", ":center_no", slot_party_taxes_visit),
                (gt, ":taxes", 0),

                # The party is not a party created by the center
                (party_get_slot, ":linked_party", ":party_no", slot_party_linked_party),
                (neq, ":linked_party", ":center_no"),

                # The party is not the leader of the center
                (assign, ":is_leader", 0),
                (try_begin),
                    (party_slot_eq, ":party_no", slot_party_type, spt_war_party),
                    
                    (party_get_slot, ":center_leader", ":center_no", slot_party_leader),
                    (party_get_slot, ":party_leader", ":party_no", slot_party_leader),
                    (eq, ":center_leader", ":party_leader"),
                    (ge, ":center_leader", 0),
                    (ge, ":party_leader", 0),

                    (assign, ":is_leader", 1),
                (try_end),

                (eq, ":is_leader", 0),

                (call_script, "script_party_transfer_wealth", ":party_no", ":center_no", ":taxes", tax_type_visitor, tax_type_visitor),
            (try_end),
        ]),

    # script_party_transfer_wealth
        # input:
        #   arg1: party_giver
        #   arg2: party_receiver
        #   arg3: amount
        #   arg4: receiver_tax_type - optional if transfer is not part of a tax
        #   arg5: giver_tax_type - optional if transfer is not part of a tax
        # output: none
    ("party_transfer_wealth",
        [
            (store_script_param, ":party_giver", 1),
            (store_script_param, ":party_receiver", 2),
            (store_script_param, ":amount", 3),
            (store_script_param, ":receiver_tax_type", 4),
            (store_script_param, ":giver_tax_type", 5),

            (try_begin),
                (is_between, ":party_receiver", centers_begin, centers_end),
                (gt, ":receiver_tax_type", tax_type_none),
                (call_script, "script_party_add_accumulated_taxes", ":party_receiver", ":amount", ":receiver_tax_type"),
            (else_try),
                (call_script, "script_party_modify_wealth", ":party_receiver", ":amount"),
            (try_end),
            (store_mul, ":payment", ":amount", -1),
            (try_begin),
                (gt, ":giver_tax_type", tax_type_none),
                (call_script, "script_party_add_accumulated_taxes", ":party_giver", ":payment", ":giver_tax_type"),
            (else_try),
                (call_script, "script_party_modify_wealth", ":party_giver", ":payment"),
            (try_end),
        ]),

    # script_party_get_skill_level
        # input:
        #   arg1: party_no
        #   arg2: skill
        # output:
        #   reg0: skill_value
    ("party_get_skill_level",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":skill", 2),

            (assign, ":total_skill", 0),

            (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":stack_no", 0, ":num_stacks"),
                (party_stack_get_troop_id, ":troop_no", ":party_no", ":stack_no"),
                (troop_is_hero, ":troop_no"),
                (store_skill_level, ":troop_skill", ":skill", ":troop_no"),
                (call_script, "script_game_get_skill_modifier_for_troop", ":troop_no", ":skill"),
                (val_add, ":troop_skill", reg0),
                (val_add, ":total_skill", ":troop_skill"),
            (try_end),

            (assign, reg0, ":total_skill"),
        ]),

    # script_party_empty_goods
        # input:
        #   arg1: party_no
        #   arg2: party_container
        # output: none
    ("party_empty_goods",
        [
            (store_script_param, ":party", 1),
            (store_script_param, ":party_container", 2),

            (try_for_range, ":item", goods_begin, goods_end),
                (store_sub, ":offset", ":item", goods_begin),
                (store_add, ":amount_slot", ":offset", slot_party_ressources_current_amount_begin),

                (party_get_slot, ":good_amount", ":party", ":amount_slot"),
                (party_set_slot, ":party", ":amount_slot", 0),

                (party_get_slot, ":container_good_amount", ":party_container", ":amount_slot"),
                (val_add, ":container_good_amount", ":good_amount"),
                (party_set_slot, ":party_container", ":amount_slot", ":container_good_amount"),

                (try_begin),
                    (gt, ":good_amount", 0),
                    (call_script, "script_item_get_sell_price", ":item", ":party", ":party_container"),
                    # (assign, ":price", reg0),
                    (assign, ":tax", reg1),

                    (store_mul, ":total_tax", ":tax", ":good_amount"),
                    (call_script, "script_party_add_accumulated_taxes", ":party_container", ":total_tax", tax_type_trade),
                (try_end),

                (try_begin),
                    (call_script, "script_cf_debug", debug_trade|debug_economy),
                    (gt, ":good_amount", 0),
                    (str_store_party_name, s10, ":party"),
                    (str_store_party_name, s11, ":party_container"),
                    (str_store_item_name, s12, ":item"),
                    (assign, reg10, ":good_amount"),
                    (display_message, "@{s10} move {reg10} {s12} to {s11}"),
                (try_end),
            (try_end),
        ]),

    # script_party_sort_troops
        # input:
        #   arg1: party_no
        # output: none
    ("party_sort_troops",
        [
            (store_script_param, ":party_no", 1),
            (store_script_param, ":num_tries", 2),

            # (assign, ":num_tries", 50),
            (try_begin),
                (call_script, "script_cf_party_can_sort_troops", ":party_no"),

                (try_for_range, ":unused", 0, ":num_tries"),
                    (call_script, "script_party_sort_troops_step", ":party_no"),
                    (assign, ":has_changed", reg0),
                    (try_begin),
                        (eq, ":has_changed", 0),
                        (assign, ":num_tries", 0),
                    (try_end),
                (try_end),
            (try_end),
        ]),

    # script_party_sort_troops_step
        # input:
        #   arg1: party_no
        # output:
        #   reg0: has_changed
    ("party_sort_troops_step",
        [
            (store_script_param, ":party_no", 1),

            (party_get_slot, ":autosort_options", ":party_no", slot_party_autosort_options),
            (try_begin),
                (neq, ":autosort_options", autosort_no_sort),

                (assign, ":has_changed", 0),

                (party_get_num_companion_stacks, ":num_stacks", ":party_no"),
                (try_for_range_backwards, ":stack", 1, ":num_stacks"),
                    (party_stack_get_troop_id, ":troop_id", ":party_no", ":stack"),

                    (store_sub, ":previous_stack", ":stack", 1),
                    (party_stack_get_troop_id, ":previous_troop_id", ":party_no", ":previous_stack"),
                    (neg|troop_is_hero, ":previous_troop_id"),

                    (call_script, "script_troop_get_party_sort_score", ":troop_id", ":party_no"),
                    (assign, ":troop_score", reg0),
                    (call_script, "script_troop_get_party_sort_score", ":previous_troop_id", ":party_no"),
                    (assign, ":previous_troop_score", reg0),

                    (this_or_next|troop_is_hero, ":troop_id"),
                    (gt, ":previous_troop_score", ":troop_score"),
                    (party_stack_get_size, ":previous_size", ":party_no", ":previous_stack"),
                    (party_stack_get_num_wounded, ":previous_wounded", ":party_no", ":previous_stack"),
                    (party_remove_members, ":party_no", ":previous_troop_id", ":previous_size"),
                    (party_add_members, ":party_no", ":previous_troop_id", ":previous_size"),
                    (party_wound_members, ":party_no", ":previous_troop_id", ":previous_wounded"),
                    (assign, ":has_changed", 1),
                (try_end),
            (try_end),

            (assign, reg0, ":has_changed"),
        ]),

    # script_troop_get_party_sort_score
        # input:
        #   arg1: troop_no
        #   arg2: party_no
        # output:
        #   reg0: score
    ("troop_get_party_sort_score",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":party_no", 2),

            (assign, ":score", 0),

            (party_get_slot, ":autosort_options", ":party_no", slot_party_autosort_options),
            (store_and, ":autosort_level", ":autosort_options", autosort_level_flag),
            (store_and, ":autosort_culture", ":autosort_options", autosort_culture_flag),
            (try_begin),
                (eq, ":autosort_level", autosort_low_level_first),
                (store_character_level, ":score", ":troop_no"),
            (else_try),
                (eq, ":autosort_level", autosort_high_level_first),
                (store_character_level, ":level", ":troop_no"),
                (store_sub, ":score", 100, ":level"),
            (try_end),

            (store_troop_faction, ":troop_faction", ":troop_no"),
            (store_faction_of_party, ":party_faction", ":party_no"),

            (assign, ":same_culture", 0),

            (try_begin),
                (eq, ":troop_faction", ":party_faction"),
                (assign, ":same_culture", 1),
            (else_try),
                (faction_get_slot, ":troop_culture", ":troop_faction", slot_faction_culture),
                (faction_get_slot, ":party_culture", ":party_faction", slot_faction_culture),
                (gt, ":troop_culture", 0),
                (eq, ":troop_culture", ":party_culture"),
                (assign, ":same_culture", 1),
            (try_end),

            (try_begin),
                (eq, ":autosort_culture", autosort_foreign_first),
                (eq, ":same_culture", 1),
                (val_add, ":score", 100),
            (else_try),
                (eq, ":autosort_culture", autosort_local_first),
                (eq, ":same_culture", 0),
                (val_add, ":score", 100),
            (try_end),

            (assign, reg0, ":score"),
        ]),

    # script_cf_party_can_sort_troops
        # input:
        #   arg1: party_no
        # output: none
        # fails if sort is not possible
    ("cf_party_can_sort_troops",
        [
            (store_script_param, ":party_no", 1),

            (party_get_battle_opponent, ":opponent", ":party_no"),
            (lt, ":opponent", 0),
        ]),

    # script_faction_get_center_interest
        # input:
        #   arg1: faction_no
        #   arg2: center_no
        # output:
        #   reg0: score
    ("faction_get_center_interest",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":center_no", 2),

            (assign, ":score", 0),
            (party_get_slot, ":original_faction", ":center_no", slot_party_original_faction),
            (try_begin),
                (eq, ":original_faction", ":faction_no"),
                (assign, ":score", -50),
            (try_end),

            (assign, ":min_distance", 9999),
            (try_for_range, ":other_center", walled_centers_begin, walled_centers_end),
                (party_get_slot, ":other_center_faction", ":other_center", slot_party_faction),
                (eq, ":other_center_faction", ":faction_no"),
                (store_distance_to_party_from_party, ":distance", ":center_no", ":other_center"),
                (lt, ":distance", ":min_distance"),
                (assign, ":min_distance", ":distance"),
            (try_end),
            (val_add, ":score", ":min_distance"),
            (assign, reg0, ":score"),
        ]),

    # script_troop_get_surplus_center
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: score
    ("troop_get_surplus_center",
        [
            (store_script_param, ":troop_no", 1),

            (assign, ":surplus_center", -1),
            (try_begin),
                (call_script, "script_troop_get_home", ":troop_no", 0),
                (assign, ":home", reg0),
                (is_between, ":home", walled_centers_begin, walled_centers_end),
                (assign, ":end", centers_end),
                (try_for_range, ":center_no", centers_begin, ":end"),
                    (party_slot_eq, ":center_no", slot_party_lord, ":troop_no"),
                    (party_slot_eq, ":center_no", slot_party_reserved, -1),
                    (neq, ":center_no", ":home"),
                    (assign, ":surplus_center", ":center_no"),
                    (assign, ":end", 0),
                (try_end),
            (try_end),
            (assign, reg0, ":surplus_center"),
        ]),

    # script_faction_disable
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_disable",
        [
            (store_script_param, ":faction_no", 1),

            (try_begin),
                (neg|faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                (faction_set_slot, ":faction_no", slot_faction_status, sfst_disabled),

                (call_script, "script_faction_remove_wars", ":faction_no", -1),
                (try_begin),
                    (call_script, "script_cf_debug", debug_faction|debug_simple),
                    (str_store_faction_name, s11, ":faction_no"),
                    (display_message, "@{s11} disabled: no fief"),
                (try_end),
            (try_end),
        ]),

    # script_faction_remove_wars
        # input:
        #   arg1: faction_no
        # output:
        #   reg0: num_wars_removed
    ("faction_remove_wars",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":from_war", 2),

            (assign, ":num_wars", 0),

            (try_for_range, ":war_storage", war_storages_begin, war_storages_end),
                (neq, ":war_storage", ":from_war"),
                (call_script, "script_cf_war_remove_participant", ":war_storage", ":faction_no"),
                (val_add, ":num_wars", 1),
            (try_end),

            (try_for_range, ":center_no", centers_begin, centers_end),
                (party_get_slot, ":center_faction", ":center_no", slot_party_faction),
                (store_faction_of_party, ":current_faction", ":center_no"),
                (neq, ":center_faction", ":current_faction"),
                (eq, ":center_faction", ":faction_no"),

                (call_script, "script_center_evacuate", ":center_no"),
            (try_end),

            (assign, reg0, ":num_wars"),
        ]),

    # script_faction_enable
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_enable",
        [
            (store_script_param, ":faction_no", 1),

            (try_begin),
                (faction_slot_eq, ":faction_no", slot_faction_status, sfst_disabled),
                (faction_set_slot, ":faction_no", slot_faction_status, sfst_default),
                (try_begin),
                    (call_script, "script_cf_debug", debug_faction|debug_simple),
                    (str_store_faction_name, s11, ":faction_no"),
                    (display_message, "@{s11} enabled"),
                (try_end),
            (try_end),
        ]),

    # script_faction_reset_relations
        # input:
        #   arg1: faction_1
        #   arg2: faction_2
        # output: none
    ("faction_reset_relations",
        [
            (store_script_param, ":faction_1", 1),
            (store_script_param, ":faction_2", 2),

            (call_script, "script_faction_get_treaties", ":faction_1", ":faction_2"),
            (assign, ":treaties", reg0),

            (store_and, ":alliance", ":treaties", sfkt_alliance),
            (store_and, ":defensive", ":treaties", sfkt_defensive_alliance),
            (store_and, ":vassal", ":treaties", sfkt_vassal),
            (store_and, ":overlord", ":treaties", sfkt_overlord),

            (try_begin),
                (this_or_next|gt, ":alliance", 0),
                (this_or_next|gt, ":defensive", 0),
                (this_or_next|gt, ":vassal", 0),
                (gt, ":overlord", 0),

                (set_relation, ":faction_1", ":faction_2", relation_state_friendly),
            (else_try),
                (call_script, "script_cf_factions_are_at_war", ":faction_1", ":faction_2"),
                (set_relation, ":faction_1", ":faction_2", relation_state_war),
            (else_try),
                (set_relation, ":faction_1", ":faction_2", relation_state_neutral),
            (try_end),
        ]),

    # script_faction_process_wealth
        # input:
        #   arg1: faction_no
        # output: none
    ("faction_process_wealth",
        [
            (store_script_param, ":faction_no", 1),

            (faction_get_slot, ":faction_wealth", ":faction_no", slot_faction_wealth),

            (assign, ":total_tribute_payment", 0),

            (try_for_range, ":other_faction", kingdoms_begin, kingdoms_end),
                (store_sub, ":offset", ":other_faction", kingdoms_begin),
                (store_add, ":treaties_slot", ":offset", slot_faction_kingdom_temporary_treaties_begin),
                (faction_get_slot, ":treaties", ":faction_no", ":treaties_slot"),
                (store_and, ":tribute", ":treaties", sfkt_tribute),
                (gt, ":tribute", 0),

                (store_add, ":treaties_duration_slot", ":offset", slot_faction_kingdom_temporary_treaties_duration_begin),
                (store_add, ":treaties_object_slot", ":offset", slot_faction_kingdom_temporary_treaties_object_begin),

                (faction_get_slot, ":duration", ":faction_no", ":treaties_duration_slot"),
                (faction_get_slot, ":object", ":faction_no", ":treaties_object_slot"),

                (call_script, "script_get_current_day"),
                (assign, ":current_day", reg0),
                (try_begin),
                    # We still have a payment to give
                    (gt, ":object", 0),

                    (assign, ":payment", 0),

                    (try_begin),
                        (lt, ":current_day", ":duration"),

                        (store_sub, ":remaining_days", ":duration", ":current_day"),
                        (store_mul, ":expected_payment", ":object", 30*5),
                        (val_div, ":expected_payment", ":remaining_days"),

                        (assign, ":payment", ":expected_payment"),

                        (store_div, ":max_payment", ":faction_wealth", 3),
                        (val_min, ":payment", ":max_payment"),
                    (else_try),
                        (store_div, ":interests", ":object", 100), # 1% interests rate on late payment
                        (val_add, ":object", ":interests"),

                        (store_mul, ":min_payment", ":interests", 2),

                        # We are late on payment
                        (store_div, ":max_payment", ":faction_wealth", 10),
                        (val_max, ":max_payment", ":min_payment"),
                        (val_min, ":max_payment", ":object"),

                        (assign, ":payment", ":max_payment"),

                    (try_end),

                    (try_begin),
                        (gt, ":payment", 0),

                        (try_begin),
                            (call_script, "script_cf_debug", debug_current),
                            (str_store_faction_name, s10, ":faction_no"),
                            (str_store_faction_name, s11, ":other_faction"),
                            (assign, reg10, ":object"),
                            (assign, reg11, ":payment"),
                            (str_store_date, s12, ":duration"),
                            (try_begin),
                                (lt, ":current_day", ":duration"),
                                (display_message, "@{s10} payment of {reg11}/{reg10} to {s11} until {s12}", text_color_gold),
                            (else_try),
                                (display_message, "@{s10} late payment of {reg11}/{reg10} to {s11} until {s12}", text_color_gold),
                            (try_end),
                        (try_end),

                        (val_add, ":total_tribute_payment", ":payment"),

                        (call_script, "script_faction_transfer_wealth", ":faction_no", ":other_faction", ":payment", tax_type_tribute),

                        (val_sub, ":object", ":payment"),

                        (faction_set_slot, ":faction_no", ":treaties_object_slot", ":object"),
                    (try_end),
                (else_try),
                    # Treaty is finished
                    (try_begin),
                        (call_script, "script_cf_debug", debug_current),
                        (str_store_faction_name, s10, ":faction_no"),
                        (str_store_faction_name, s11, ":other_faction"),
                        (assign, reg10, ":object"),
                        (str_store_date, s12, ":duration"),
                        (display_message, "@{s10} removes tribute payment to {s11}", text_color_gold),
                    (try_end),

                    (call_script, "script_faction_clear_treaty", ":faction_no", ":other_faction", sfkt_tribute_treaty_clear),
                (try_end),
            (try_end),

            (faction_get_slot, ":faction_wealth", ":faction_no", slot_faction_wealth),
            (assign, ":total_cost", 0),

            (try_begin),
                (gt, ":faction_wealth", 0),
                (assign, ":fiefless_share_multiplier", faction_wealth_fiefless_share_multiplier),
                (faction_get_slot, ":faction_share_ratio", ":faction_no", slot_faction_wealth_shared_ratio),
                (gt, ":faction_share_ratio", 0),
                (store_mul, ":wealth_shared", ":faction_wealth", ":faction_share_ratio"),
                (val_div, ":wealth_shared", 100),
                (assign, ":num_shares", 0),

                (try_for_range, ":lord_no", lords_begin, lords_end),
                    (troop_slot_eq, ":lord_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
                    (store_troop_faction, ":lord_faction", ":lord_no"),
                    (eq, ":lord_faction", ":faction_no"),
                    (troop_get_slot, ":lord_rank", ":lord_no", slot_troop_rank),
                    (try_begin),
                        (ge, ":lord_rank", rank_village),
                        (troop_get_slot, ":home", ":lord_no", slot_troop_home),
                        (try_begin),
                            (is_between, ":home", centers_begin, centers_end),
                            (store_faction_of_party, ":home_faction", ":home"),
                            (neq, ":lord_faction", ":home_faction"),
                            (store_mul, ":shares", ":fiefless_share_multiplier", ":lord_rank"),
                            (val_add, ":num_shares", ":shares"),
                        (else_try),
                            (val_add, ":num_shares", 1),
                        (try_end),
                    (else_try),
                        (val_add, ":num_shares", ":fiefless_share_multiplier"),
                    (try_end),
                (try_end),

                (gt, ":num_shares", 0),
                (gt, ":wealth_shared", 0),
                (store_div, ":wealth_shared_part", ":wealth_shared", ":num_shares"),

                (try_begin),
                    (call_script, "script_cf_debug", debug_economy),
                    (str_store_faction_name, s11, ":faction_no"),
                    (assign, reg10, ":faction_wealth"),
                    (assign, reg11, ":wealth_shared"),
                    (assign, reg12, ":num_shares"),
                    (display_message, "@{s11} has {reg10} denars in reserve, sharing {reg11} in {reg12} shares", text_color_gold),
                (try_end),

                (gt, ":wealth_shared_part", faction_wealth_shared_min),
                (try_for_range, ":lord_no", lords_begin, lords_end),
                    (troop_slot_eq, ":lord_no", slot_troop_kingdom_occupation, tko_kingdom_hero),
                    (store_troop_faction, ":lord_faction", ":lord_no"),
                    (eq, ":lord_faction", ":faction_no"),
                    (troop_get_slot, ":lord_rank", ":lord_no", slot_troop_rank),
                    (assign, ":received_wealth", 0),
                    (assign, ":received_shares", 1),
                    (try_begin),
                        (ge, ":lord_rank", rank_village),
                        (troop_get_slot, ":home", ":lord_no", slot_troop_home),
                        (try_begin),
                            (is_between, ":home", centers_begin, centers_end),
                            (store_faction_of_party, ":home_faction", ":home"),
                            (neq, ":lord_faction", ":home_faction"),
                            (store_mul, ":received_shares", ":fiefless_share_multiplier", ":lord_rank"),
                        (else_try),
                            (assign, ":received_shares", 1),
                        (try_end),
                    (else_try),
                        (assign, ":received_shares", ":fiefless_share_multiplier"),
                    (try_end),
                    (store_mul, ":received_wealth", ":received_shares", ":wealth_shared_part"),
                    (try_begin),
                        (call_script, "script_cf_debug", debug_economy),
                        (str_store_faction_name, s10, ":faction_no"),
                        (str_store_troop_name, s11, ":lord_no"),
                        (assign, reg10, ":received_wealth"),
                        (assign, reg11, ":received_shares"),
                        (display_message, "@{s10} shares {reg10} denars with {s11} ({reg11} shares)", text_color_gold),
                    (try_end),
                    (call_script, "script_troop_add_accumulated_taxes", ":lord_no", ":received_wealth", tax_type_funds, 1),
                    (val_sub, ":total_cost", ":received_wealth"),
                (try_end),
                (call_script, "script_faction_add_accumulated_taxes", ":faction_no", ":total_cost", tax_type_funds_pay),
            (try_end),
        ]),

    # script_faction_transfer_wealth
        # input:
        #   arg1: faction_giver
        #   arg2: faction_receiver
        #   arg3: amount
        #   arg4: tax_type - optional if transfer is not part of a tax
        # output: none
    ("faction_transfer_wealth",
        [
            (store_script_param, ":faction_giver", 1),
            (store_script_param, ":faction_receiver", 2),
            (store_script_param, ":amount", 3),
            (store_script_param, ":tax_type", 4),

            (try_begin),
                (gt, ":tax_type", tax_type_none),
                (call_script, "script_faction_add_accumulated_taxes", ":faction_receiver", ":amount", ":tax_type"),
            (else_try),
                (call_script, "script_faction_modify_wealth", ":faction_receiver", ":amount"),
            (try_end),
            (store_mul, ":payment", ":amount", -1),

            (call_script, "script_get_tax_inverse", ":tax_type"),
            (assign, ":inverse_tax", reg0),
            (try_begin),
                (gt, ":inverse_tax", tax_type_none),
                (call_script, "script_faction_add_accumulated_taxes", ":faction_giver", ":payment", ":inverse_tax"),
            (else_try),
                (call_script, "script_faction_modify_wealth", ":faction_giver", ":payment"),
            (try_end),
        ]),

    # script_faction_modify_wealth
        # input:
        #   arg1: faction_no
        #   arg2: amount
        # output: none
    ("faction_modify_wealth",
        [
            (store_script_param, ":faction_no", 1),
            (store_script_param, ":amount", 2),

            (faction_get_slot, ":current_wealth", ":faction_no", slot_faction_wealth),
            (val_add, ":current_wealth", ":amount"),
            (faction_set_slot, ":faction_no", slot_faction_wealth, ":current_wealth"),
        ]),

    # script_get_tax_inverse
        # input:
        #   arg1: tax_type
        # output:
        #   reg0: inverse_tax
    ("get_tax_inverse",
        [
            (store_script_param, ":tax_type", 1),

            (assign, ":inverse_tax", tax_type_none),

            (try_begin),
                (this_or_next|eq, ":tax_type", tax_type_protection),
                (this_or_next|eq, ":tax_type", tax_type_vassal),
                (this_or_next|eq, ":tax_type", tax_type_member),
                (this_or_next|eq, ":tax_type", tax_type_funds),
                (this_or_next|eq, ":tax_type", tax_type_troops_buying),
                (eq, ":tax_type", tax_type_tribute),

                (store_add, ":inverse_tax", ":tax_type", 1),
            (else_try),
                (this_or_next|eq, ":tax_type", tax_type_protection_pay),
                (this_or_next|eq, ":tax_type", tax_type_vassal_pay),
                (this_or_next|eq, ":tax_type", tax_type_member_pay),
                (this_or_next|eq, ":tax_type", tax_type_funds_pay),
                (this_or_next|eq, ":tax_type", tax_type_troops_selling),
                (eq, ":tax_type", tax_type_tribute_pay),

                (store_add, ":inverse_tax", ":tax_type", -1),
            (else_try),
                (eq, ":tax_type", tax_type_caravan_wages),

                (assign, ":inverse_tax", ":tax_type"),
            (try_end),

            (assign, reg0, ":inverse_tax"),
        ]),

    # script_init_quests
        # input: none
        # output: none
    ("init_quests",
        [
            (try_for_range, ":quest_no", quests_begin, quests_end),
                (store_sub, ":offset", ":quest_no", quests_begin),
                (store_add, ":quest_index", ":offset", quest_descriptions_begin),

                (quest_set_slot, ":quest_no", slot_quest_description, ":quest_index"),
            (try_end),
        ]),

    # script_start_quest
        # input:
        #   arg1: quest_no
        #   arg2: giver_troop_no
        # output: none
    ("start_quest",
        [
            (store_script_param, ":quest_no", 1),
            (store_script_param, ":giver_troop_no", 2),

            (try_for_range, ":slot", last_generic_quest_slot, last_quest_slot),
                (quest_set_slot, ":quest_no", ":slot", -1),
            (try_end),

            (quest_set_slot, ":quest_no", slot_quest_giver_troop, ":giver_troop_no"),
            (quest_get_slot, ":quest_description_index", ":quest_no", slot_quest_description),
            (quest_get_slot, ":quest_object", ":quest_no", slot_quest_object),

            (try_begin),
                (eq, ":giver_troop_no", -1),
                (str_store_string, s63, "@Political suggestion"),
            (else_try),
                (is_between, ":giver_troop_no", npc_heroes_begin, npc_heroes_end),
                (str_store_troop_name_link, s62, ":giver_troop_no"),
                (str_store_string, s63, "@Given by: {s62}"),
            (else_try),
                (str_store_troop_name, s62, ":giver_troop_no"),
                (str_store_string, s63, "@Given by: {s62}"),
            (try_end),
            (store_current_hours, ":cur_hours"),
            (str_store_date, s60, ":cur_hours"),
            (str_store_string, s60, "@Given on: {s60}"),
            (try_begin),
                (gt, ":quest_description_index", 0),
                (str_store_string, s61, ":quest_description_index"),
            (else_try),
                (str_clear, s61),
            (try_end),

            (add_quest_note_from_sreg, ":quest_no", 0, s60, 0),
            (add_quest_note_from_sreg, ":quest_no", 1, s63, 0),
            (add_quest_note_from_sreg, ":quest_no", 2, s61, 0),

            (try_begin),
                (quest_slot_ge, ":quest_no", slot_quest_expiration_days, 1),
                (quest_get_slot, reg0, ":quest_no", slot_quest_expiration_days),
                (add_quest_note_from_sreg, ":quest_no", 7, "@You have {reg0} days to finish this quest.", 0),
            (try_end),

            # Adding dont_give_again_for_days value
            (try_begin),
                (quest_slot_ge, ":quest_no", slot_quest_dont_give_again_period, 1),
                (quest_get_slot, ":dont_give_again_period", ":quest_no", slot_quest_dont_give_again_period),
                (quest_set_slot, ":quest_no", slot_quest_dont_give_again_remaining_days, ":dont_give_again_period"),
            (try_end),
            (assign, reg60, ":quest_object"),
            
            (setup_quest_text, ":quest_no"),
            (start_quest, ":quest_no", ":giver_troop_no"),
        ]),

    # script_conclude_quest
        # input:
        #   arg1: quest_no
    ("conclude_quest",
        [
            (store_script_param, ":quest_no", 1),
            (conclude_quest, ":quest_no"),
        ]),

    # script_succeed_quest
        # input:
        #   arg1: quest_no
    ("succeed_quest",
        [
            (store_script_param, ":quest_no", 1),
            (succeed_quest, ":quest_no"),
        ]),

    # script_fail_quest
        # input:
        #   arg1: quest_no
    ("fail_quest",
        [
            (store_script_param, ":quest_no", 1),
            (fail_quest, ":quest_no"),
        ]),

    # script_complete_quest
        # input:
        #   arg1: quest_no
    ("complete_quest",
        [
            (store_script_param, ":quest_no", 1),
            (complete_quest, ":quest_no"),
        ]),

    # script_cancel_quest
        # input:
        #   arg1: quest_no
    ("cancel_quest",
        [
            (store_script_param, ":quest_no", 1),
            (cancel_quest, ":quest_no"),
        ]),

    # script_player_add_starting_items
        # input: none
        # output: none
    ("player_add_starting_items",
        [
            (troop_get_slot, ":culture", "$g_player_troop", slot_troop_culture),
            (try_begin),
                (eq, ":culture", "fac_culture_1"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_swadian_lord_template_0"),
            (else_try),
                (eq, ":culture", "fac_culture_2"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_vaegir_lord_template_0"),
            (else_try),
                (eq, ":culture", "fac_culture_3"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_khergit_lord_template_0"),
            (else_try),
                (eq, ":culture", "fac_culture_4"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_nord_lord_template_0"),
            (else_try),
                (eq, ":culture", "fac_culture_5"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_rhodok_lord_template_0"),
            (else_try),
                (eq, ":culture", "fac_culture_6"),
                (call_script, "script_troop_use_template_troop", "$g_player_troop", "trp_sarranid_lord_template_0"),
            (try_end),
        ]),

    # script_cf_troop_can_join_faction
        # input:
        #   arg1: troop_no
        #   arg2: faction_no
        # output: none
        # fails if joining is impossible
    ("cf_troop_can_join_faction",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":faction_no", 2),

            (is_between, ":faction_no", kingdoms_begin, kingdoms_end),

            (store_troop_faction, ":troop_faction", ":troop_no"),
            (neg|is_between, ":troop_faction", kingdoms_begin, kingdoms_end),

            (faction_get_slot, ":troop_faction_status", ":troop_faction", slot_faction_status),
            (neq, ":troop_faction_status", sfst_default),

            (faction_get_slot, ":faction_status", ":faction_no", slot_faction_status),
            (eq, ":faction_status", sfst_default),
        ]),

    # script_get_player_vassal_outcome
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: become_vassal_outcome
        #   reg1: offered_center
    ("get_player_vassal_outcome",
        [
            (store_script_param, ":troop_no", 1),

            (assign, reg1, -1),

            (troop_get_slot, ":renown", "$g_player_troop", slot_troop_renown),
            (call_script, "script_troop_get_relation_with_troop", ":troop_no", "$g_player_troop"),
            (assign, ":relation", reg0),

            (assign, ":threshold", 100),

            (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
            (try_begin),
                (gt, ":rank", rank_king),
                (assign, ":threshold", 200),
            (else_try),
                (gt, ":rank", rank_city),
                (assign, ":threshold", 150),
            (try_end),

            (assign, ":score", ":renown"),
            (val_add, ":score", ":relation"),

            (try_begin),
                (lt, ":score", ":threshold"),
                (assign, reg0, vassal_outcome_unknown),
            (else_try),
                (lt, ":relation", -10),
                (assign, reg0, vassal_outcome_refused),
            (else_try),
                (assign, ":num_fiefless_vassals", 0),
                (assign, ":end", npc_heroes_end),
                (try_for_range, ":other_troop", npc_heroes_begin, ":end"),
                    (troop_slot_eq, ":other_troop", slot_troop_kingdom_occupation, tko_kingdom_hero),
                    (troop_slot_eq, ":other_troop", slot_troop_vassal_of, ":troop_no"),
                    (troop_get_slot, ":other_rank", ":other_troop", slot_troop_rank),
                    (lt, ":other_rank", rank_village),
                    (val_add, ":num_fiefless_vassals", 1),
                    (assign, ":end", 0),
                (try_end),
                (gt, ":num_fiefless_vassals", 0),
                (assign, reg0, vassal_outcome_too_many),
            (else_try),
                (troop_get_slot, ":surplus_fief", ":troop_no", slot_troop_surplus_center),
                (is_between, ":surplus_fief", centers_begin, centers_end),
                (assign, reg0, vassal_outcome_accepted),
                (assign, reg1, ":surplus_fief"),
            (else_try),
                (assign, reg0, vassal_outcome_no_fief),
            (try_end),
        ]),

    # script_clean_budgets
        # input: none
        # output: none
    ("clean_budgets",
        [
            (try_for_range, ":lord", lords_begin, lords_end),
                (troop_set_slot, ":lord", slot_troop_accumulated_taxes, 0),
                (troop_set_slot, ":lord", slot_troop_budget_vassal_taxes, 0),
                (troop_set_slot, ":lord", slot_troop_budget_faction_member_taxes, 0),
                (troop_set_slot, ":lord", slot_troop_budget_faction_funds, 0),
                (troop_set_slot, ":lord", slot_troop_budget_reserved_party, 0),
                (troop_set_slot, ":lord", slot_troop_budget_reserved_other, 0),
            (try_end),
            (try_for_range, ":center", centers_begin, centers_end),
                (party_set_slot, ":center", slot_party_accumulated_taxes, 0),
                (party_set_slot, ":center", slot_party_budget_reserved_party, 0),
                (party_set_slot, ":center", slot_party_budget_reserved_auxiliaries, 0),
                (party_set_slot, ":center", slot_party_budget_reserved_expenses, 0),
                (party_set_slot, ":center", slot_party_budget_reserved_other, 0),

                (try_for_range, ":slot", slot_party_buget_taxes_begin, slot_party_buget_taxes_end),
                    (party_set_slot, ":center", ":slot", 0),
                (try_end),

                (party_get_slot, ":wealth", ":center", slot_party_wealth),
                (party_set_slot, ":center", slot_party_budget_last_wealth, ":wealth"),
            (try_end),
            (try_for_range, ":faction_no", kingdoms_begin, kingdoms_end),
                (faction_set_slot, ":faction_no", slot_faction_accumulated_taxes, 0),
            (try_end),
        ]),

    # script_party_check_prisoners
        # input:
        #   arg1: party_no
        # output: none
    ("party_check_prisoners",
        [
            (store_script_param, ":party_no", 1),

            (party_get_num_prisoner_stacks, ":num_stacks", ":party_no"),
            (try_for_range, ":cur_stack", 0, ":num_stacks"),
                (party_prisoner_stack_get_troop_id, ":troop_id", ":party_no", ":cur_stack"),
                (troop_is_hero, ":troop_id"),

                (troop_slot_eq, ":troop_id", slot_troop_prisoner_of, -1),
                (call_script, "script_party_take_troop_prisoner", ":party_no", ":troop_id", -1, 1),
            (try_end),
        ]),

    # script_cf_troop_available_for_recruit
        # input:
        #   arg1: troop_no
        #   arg2: center_no
        #   arg3: troop_recruiter
        # output: none
        # fails if troop not available for recruitment
    ("cf_troop_available_for_recruit",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":center_no", 2),
            (store_script_param, ":troop_recruiter", 3),

            (assign, ":allowed_level", tq_peasant),
            (troop_get_slot, ":troop_quality", ":troop_no", slot_troop_quality),

            (party_get_slot, ":center_leader", ":center_no", slot_party_leader),
            (try_begin),
                (eq, ":center_leader", ":troop_recruiter"),
                (assign, ":allowed_level", tq_noble),
            (else_try),
                (party_get_slot, ":center_type", ":center_no", slot_party_type),

                (try_begin),
                    (this_or_next|eq, ":center_type", spt_town),
                    (eq, ":center_type", spt_castle),
                    (val_add, ":allowed_level", 1),
                (try_end),

                (store_troop_faction, ":recruiter_faction", ":troop_recruiter"),
                (store_faction_of_party, ":center_faction", ":center_no"),
                (try_begin),
                    (eq, ":recruiter_faction", ":center_faction"),
                    (val_add, ":allowed_level", 1),
                (try_end),

                (try_begin),
                    (ge, ":center_leader", 0),
                    (call_script, "script_troop_get_relation_with_troop", ":center_leader", ":troop_recruiter"),
                    (assign, ":relation", reg0),
                    (store_skill_level, ":recruiter_persuasion", ":troop_recruiter", skl_persuasion),
                    (val_mul, ":recruiter_persuasion", 2),
                    (val_add, ":relation", ":recruiter_persuasion"),
                    (store_div, ":bonus", ":relation", 30),
                    (val_add, ":allowed_level", ":bonus"),
                (try_end),
            (try_end),

            (ge, ":allowed_level", ":troop_quality"),
        ]),

    # script_cf_party_shakedown
        # input:
        #   arg1: party_agressor
        #   arg2: party_victim
        # output:
        #   reg0: shakedown_amount
        # fails if shakedown refused
    ("cf_party_shakedown",
        [
            (store_script_param, ":party_aggressor", 1),
            (store_script_param, ":party_victim", 2),

            (call_script, "script_party_get_total_wealth", ":party_victim", 1),
            (assign, ":victim_wealth", reg0),

            (call_script, "script_party_get_skill_level", ":party_aggressor", skl_intimidation),
            (assign, ":intimidation", reg0),
            (store_mul, ":intimidation_times", ":intimidation", 2),

            (call_script, "script_party_get_wages", ":party_aggressor"),
            (store_mul, ":aggressor_strength", reg0, 4),
            (assign, ":aggressor_wages", reg0),
            (call_script, "script_party_get_wages", ":party_victim"),
            (assign, ":victim_strength", reg0),

            (assign, ":percent", 0),

            (try_begin),
                (gt, ":victim_strength", 0),

                (store_mul, ":percent", ":aggressor_strength", 100),
                (val_div, ":percent", ":victim_strength"),
                (set_fixed_point_multiplier, 1),
                (store_sqrt, ":percent", ":percent"),
            (else_try),
                (assign, ":percent", 100),
            (try_end),

            (val_add, ":percent", ":intimidation"),

            (store_mul, ":shakedown_amount", ":victim_wealth", ":percent"),
            (val_div, ":shakedown_amount", 100),

            (store_sub, ":flat_value", ":aggressor_wages", ":victim_strength"),
            (store_add, ":intimidation_flat", 100, ":intimidation_times"),
            (val_mul, ":flat_value", ":intimidation_flat"),
            (val_div, ":flat_value", 100),

            (try_begin),
                (call_script, "script_cf_debug", debug_simple|debug_current),
                (assign, reg10, ":shakedown_amount"),
                (assign, reg11, ":percent"),
                (assign, reg12, ":flat_value"),
                (assign, reg13, ":victim_wealth"),
                (display_message, "@Shakedown for {reg10} : percent ({reg11}) - flat ({reg12}) - max ({reg13})"),
            (try_end),

            (val_max, ":shakedown_amount", ":flat_value"),

            # (store_mul, ":min_shakedown", ":victim_wealth", 2),
            # (val_div, ":min_shakedown", 3),

            # (val_min, ":shakedown_amount", ":min_shakedown"),

            (assign, reg0, ":shakedown_amount"),

            (gt, ":shakedown_amount", 0),
        ]),

    # script_get_dialog_caravan_intro
        # input:
        #   arg1: caravan_party
        # output:
        #   s0: caravan_intro_dialog
        #   reg0: dialog_outcome
    ("get_dialog_caravan_intro",
        [
            (store_script_param, ":caravan_party", 1),

            (assign, ":dialog_outcome", outcome_neutral),

            (store_faction_of_party, ":caravan_faction", ":caravan_party"),
            (store_faction_of_party, ":player_faction", "$g_player_party"),

            (call_script, "script_faction_get_relation_with_faction", ":caravan_faction", ":player_faction"),
            (assign, ":relation", reg0),

            (party_get_slot, ":caravan_origin_center", ":caravan_party", slot_party_linked_party),
            (assign, ":caravan_leader", -1),
            (try_begin),
                (is_between, ":caravan_origin_center", centers_begin, centers_end),
                (party_get_slot, ":caravan_leader", ":caravan_origin_center", slot_party_lord),
            (try_end),

            (try_begin),
                (party_slot_eq, ":caravan_party", slot_party_player_shakedown, 1),
                (str_store_string, s0, "@Oh... It's you again. What else do you need ?"),
                (assign, ":dialog_outcome", outcome_neutral),
            (else_try),
                # Caravan originates from player center
                (eq, ":caravan_leader", "$g_player_troop"),
                (str_store_string, s0, "@{my Lord/my Lady}, you grace us with your presence. How can we be of service ?"),
                (assign, ":dialog_outcome", outcome_success),
            (else_try),
                # Same faction
                (eq, ":caravan_faction", ":player_faction"),
                (str_store_string, s0, "@Greetings {my Lord/my Lady}. What brings you here ?"),
                (assign, ":dialog_outcome", outcome_success),
            (else_try),
                # Factions at war
                (call_script, "script_cf_factions_are_at_war", ":caravan_faction", ":player_faction"),
                (try_begin),
                    (ge, ":caravan_leader", 0),
                    (str_store_troop_name, s10, ":caravan_leader"),
                (try_end),
                (str_store_string, s0, "@Be mindful that this caravan is under the protection of {s10}. Now, what do you need {playername} ?"),
                (assign, ":dialog_outcome", outcome_neutral),
            (else_try),
                # Allied faction
                (ge, ":relation", relation_positive),
                (str_store_string, s0, "@Greetings {playername}. What brings you here ?"),
                (assign, ":dialog_outcome", outcome_success),
            (else_try),
                # Enemy faction
                (le, ":relation", relation_tense),
                (str_store_string, s0, "@{playername}, what do you need ?"),
                (assign, ":dialog_outcome", outcome_success),
            (else_try),
                # Neutral faction
                (str_store_string, s0, "@Hail traveller. What brings you here ?"),
                (assign, ":dialog_outcome", outcome_success),
            (try_end),
            (assign, reg0, ":dialog_outcome"),
        ]),

    # script_get_dialog_caravan_trade
        # input:
        #   arg1: caravan_party
        # output:
        #   s0: caravan_trade_dialog
        #   reg0: dialog_outcome
    ("get_dialog_caravan_trade",
        [
            (store_script_param, ":caravan_party", 1),

            (assign, ":dialog_outcome", outcome_neutral),

            (str_clear, s10),
            (assign, ":num_items", 0),
            (try_for_range, ":slot", slot_party_mission_objective_1, slot_party_mission_objective_3 + 1),
                (party_get_slot, ":objective", ":caravan_party", ":slot"),
                (is_between, ":objective", goods_begin, goods_end),
                (val_add, ":num_items", 1),
            (try_end),
            (try_for_range, ":slot", slot_party_mission_objective_1, slot_party_mission_objective_3 + 1),
                (party_get_slot, ":objective", ":caravan_party", ":slot"),
                (is_between, ":objective", goods_begin, goods_end),
                (store_sub, ":offset", ":slot", slot_party_mission_objective_1),
                (val_add, ":offset", 1),
                (str_store_item_name, s11, ":objective"),
                (try_begin),
                    (eq, ":offset", ":num_items"),
                    (neq, ":num_items", 1),
                    (str_store_string, s10, "@{s10}and {s11} "),
                (else_try),
                    (eq, ":num_items", 1),
                    (str_store_string, s10, "@{s10}{s11} "),
                (else_try),
                    (str_store_string, s10, "@{s10}{s11}, "),
                (try_end),
            (try_end),

            (str_clear, s12),
            (party_get_slot, ":linked_party", ":caravan_party", slot_party_linked_party),
            (try_begin),
                (is_between, ":linked_party", centers_begin, centers_end),
                (str_store_party_name, s11, ":linked_party"),
                (str_store_string, s12, "@for the city of {s11}"),
            (try_end),

            (str_store_string, s0, "@We are looking to purchase {s10}{s12}"),
            (assign, reg0, ":dialog_outcome"),
        ]),

    # script_get_dialog_caravan_toll
        # input:
        #   arg1: caravan_party
        # output:
        #   s0: caravan_toll_dialog
        #   reg0: dialog_outcome
        #   reg1: payment_amount
    ("get_dialog_caravan_toll",
        [
            (store_script_param, ":caravan_party", 1),

            (assign, ":dialog_outcome", outcome_neutral),
            (assign, ":payment_amount", 0),

            (try_begin),
                (call_script, "script_cf_party_shakedown", "$g_player_party", ":caravan_party"),
                (assign, ":payment_amount", reg0),
                (try_begin),
                    (call_script, "script_party_get_wages", "$g_player_party"),
                    (gt, ":payment_amount", reg0),
                    (assign, ":dialog_outcome", outcome_success),
                (else_try),
                    (assign, ":dialog_outcome", outcome_neutral),
                (try_end),
            (else_try),
                (assign, ":dialog_outcome", outcome_failure),
            (try_end),

            (call_script, "script_game_get_money_text", ":payment_amount"),
            (str_store_string, s0, "@Very well, you will be given {s0} if you can promise to let these men go unharmed."),
            (assign, reg0, ":dialog_outcome"),
            (assign, reg1, ":payment_amount"),
        ]),

    # script_party_get_picture_mesh
        # input:
        #   arg1: party_no
        # output:
        #   reg0: mesh_no
    ("party_get_picture_mesh",
        [
            (store_script_param, ":party_no", 1),

            (assign, ":mesh", "mesh_pic_village_p"),
            (party_get_slot, ":party_type", ":party_no", slot_party_type),
            (party_get_current_terrain, ":terrain", ":party_no"),
            (try_begin),
                (eq, ":party_type", spt_village),
                (try_begin),
                    (this_or_next|eq, ":terrain", rt_snow),
                    (eq, ":terrain", rt_snow_forest),
                    (assign, ":mesh", "mesh_pic_village_w"),
                (else_try),
                    (this_or_next|eq, ":terrain", rt_desert),
                    (this_or_next|eq, ":terrain", rt_desert_forest),
                    (this_or_next|eq, ":terrain", rt_steppe),
                    (eq, ":terrain", rt_steppe_forest),
                    (assign, ":mesh", "mesh_pic_village_s"),
                (else_try),
                    (assign, ":mesh", "mesh_pic_village_p"),
                (try_end),
            (else_try),
                (eq, ":party_type", spt_town),
                (try_begin),
                    (this_or_next|eq, ":terrain", rt_snow),
                    (eq, ":terrain", rt_snow_forest),
                    (assign, ":mesh", "mesh_pic_castlesnow"),
                (else_try),
                    (this_or_next|eq, ":terrain", rt_desert),
                    (this_or_next|eq, ":terrain", rt_desert_forest),
                    (this_or_next|eq, ":terrain", rt_steppe),
                    (eq, ":terrain", rt_steppe_forest),
                    (assign, ":mesh", "mesh_pic_castledes"),
                (else_try),
                    (assign, ":mesh", "mesh_pic_town1"),
                (try_end),
            (else_try),
                (eq, ":party_type", spt_castle),
                (try_begin),
                    (this_or_next|eq, ":terrain", rt_snow),
                    (eq, ":terrain", rt_snow_forest),
                    (assign, ":mesh", "mesh_pic_townsnow"),
                (else_try),
                    (this_or_next|eq, ":terrain", rt_desert),
                    (this_or_next|eq, ":terrain", rt_desert_forest),
                    (this_or_next|eq, ":terrain", rt_steppe),
                    (eq, ":terrain", rt_steppe_forest),
                    (assign, ":mesh", "mesh_pic_towndes"),
                (else_try),
                    (assign, ":mesh", "mesh_pic_castle1"),
                (try_end),
            (try_end),
            (assign, reg0, ":mesh"),
        ]),

    # script_cf_clan_management_can_display_center
        # input:
        #   arg1: center_no
        # output: none
        # fails if center should not be displayed
    ("cf_clan_management_can_display_center",
        [
            (store_script_param, ":center_no", 1),

            (assign, ":continue", 0),

            (party_get_slot, ":lord", ":center_no", slot_party_lord),
            (try_begin),
                (eq, ":lord", "$g_player_troop"),
                (assign, ":continue", 1),
            (else_try),
                (call_script, "script_cf_troop_is_vassal_of", ":lord", "$g_player_troop", 0),
                (assign, ":continue", 1),
            (try_end),

            (eq, ":continue", 1),
        ]),

    # script_cf_troop_is_vassal_of
        # input:
        #   arg1: troop_vassal
        #   arg2: troop_vassal_of
        #   arg3: direct
        # output: none
        # fails if troop is not vassal
    ("cf_troop_is_vassal_of",
        [
            (store_script_param, ":troop_vassal", 1),
            (store_script_param, ":troop_vassal_of", 2),
            (store_script_param, ":direct", 3),

            (assign, ":is_vassal", 0),
            (ge, ":troop_vassal", 0),
            (troop_get_slot, ":lord", ":troop_vassal", slot_troop_vassal_of),
            (try_begin),
                (eq, ":lord", ":troop_vassal_of"),
                (assign, ":is_vassal", 1),
            (else_try),
                (eq, ":direct", 0),
                (ge, ":lord", 0),
                (call_script, "script_cf_troop_is_vassal_of", ":lord", ":troop_vassal_of", ":direct"),
                (assign, ":is_vassal", 1),
            (try_end),

            (eq, ":is_vassal", 1),
        ]),

    # script_assign_selected_lord
        # input:
        #   arg1: troop_no
        # output: none
    ("assign_selected_lord",
        [
            (store_script_param, ":lord", 1),

            (try_begin),
                (troop_slot_eq, ":lord", slot_troop_kingdom_occupation, tko_reserved),
                (call_script, "script_activate_lord", ":lord"),
            (try_end),

            (call_script, "script_troop_give_center_to_troop", "$g_player_troop", "$temp", ":lord"),
        ]),

    # script_filter_lord_vassal_grant
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: troop_filtered (1: filtered)
    ("filter_lord_vassal_grant",
        [
            (store_script_param, ":lord", 1),

            (assign, ":filtered", 1),
            (try_begin),
                (troop_slot_eq, ":lord", slot_troop_kingdom_occupation, tko_kingdom_hero),
                
                (store_troop_faction, ":lord_faction", ":lord"),
                (store_troop_faction, ":player_faction", "$g_player_troop"),
                (eq, ":player_faction", ":lord_faction"),

                (troop_get_slot, ":vassal_of", ":lord", slot_troop_vassal_of),
                (this_or_next|eq, ":vassal_of", "$g_player_troop"),
                (lt, ":vassal_of", 0),

                (assign, ":filtered", 0),
            (try_end),

            (assign, reg0, ":filtered"),
        ]),

    # script_troop_add_event
        # input:
        #   arg1: troop_no
        #   arg2: event_type
        #   arg3: event_object
        #   arg4: event_target
        #   arg5: event_value
        #   arg6: event_date
        # output:
        #   reg0: event_offset
    ("troop_add_event",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":event_type", 2),
            (store_script_param, ":event_object", 3),
            (store_script_param, ":event_target", 4),
            (store_script_param, ":event_value", 5),
            (store_script_param, ":event_date", 6),

            (try_begin),
                (eq, ":event_date", -1),
                (call_script, "script_get_current_day"),
                (assign, ":event_date", reg0),
            (try_end),

            (assign, ":event_number", -1),
            (assign, ":end", troop_log_num_slots),
            (store_sub, ":no_resend", troop_log_num_slots, 1),
            (try_for_range, ":offset", 0, ":end"),
                (store_add, ":value_slot", ":offset", slot_troop_log_value_begin),
                (troop_get_slot, ":value", ":troop_no", ":value_slot"),
                (ge, ":event_value", ":value"),

                (store_add, ":event_slot", ":offset", slot_troop_log_event_begin),
                (store_add, ":date_slot", ":offset", slot_troop_log_date_begin),
                (store_add, ":object_slot", ":offset", slot_troop_log_object_begin),
                (store_add, ":target_slot", ":offset", slot_troop_log_target_begin),

                (troop_get_slot, ":event", ":troop_no", ":event_slot"),
                (troop_get_slot, ":date", ":troop_no", ":date_slot"),
                (troop_get_slot, ":object", ":troop_no", ":object_slot"),
                (troop_get_slot, ":target", ":troop_no", ":target_slot"),

                (call_script, "script_troop_add_event_offset", ":troop_no", ":offset", ":event_type", ":event_object", ":event_target", ":event_value", ":event_date"),

                (try_begin),
                    (neq, ":offset", ":no_resend"),
                    (call_script, "script_troop_add_event", ":troop_no", ":event", ":object", ":target", ":value", ":date"),
                (try_end),

                (assign, ":event_number", ":offset"),
                (assign, ":end", 0),
            (try_end),

            (assign, reg0, ":event_number"),
        ]),

    # script_troop_add_event_offset
        # input:
        #   arg1: troop_no
        #   arg2: offset
        #   arg3: event_type
        #   arg4: event_object
        #   arg5: event_target
        #   arg6: event_value
        #   arg7: event_date
        # output: none
    ("troop_add_event_offset",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":offset", 2),
            (store_script_param, ":event_type", 3),
            (store_script_param, ":event_object", 4),
            (store_script_param, ":event_target", 5),
            (store_script_param, ":event_value", 6),
            (store_script_param, ":event_date", 7),

            (store_add, ":value_slot", ":offset", slot_troop_log_value_begin),
            (store_add, ":event_slot", ":offset", slot_troop_log_event_begin),
            (store_add, ":date_slot", ":offset", slot_troop_log_date_begin),
            (store_add, ":object_slot", ":offset", slot_troop_log_object_begin),
            (store_add, ":target_slot", ":offset", slot_troop_log_target_begin),

            (troop_set_slot, ":troop_no", ":value_slot", ":event_value"),
            (troop_set_slot, ":troop_no", ":event_slot", ":event_type"),
            (troop_set_slot, ":troop_no", ":date_slot", ":event_date"),
            (troop_set_slot, ":troop_no", ":object_slot", ":event_object"),
            (troop_set_slot, ":troop_no", ":target_slot", ":event_target"),
        ]),

    # script_troop_remove_event
        # input:
        #   arg1: troop_no
        #   arg2: event_type
        #   arg3: event_object
        #   arg4: event_target
        #   arg5: event_value
        # output:
        #   reg0: event_offset_removed
    ("troop_remove_event",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":event_type", 2),
            (store_script_param, ":event_object", 3),
            (store_script_param, ":event_target", 4),
            (store_script_param, ":event_value", 5),

            (assign, ":removed", -1),
            (assign, ":end", troop_log_num_slots),
            (try_for_range, ":offset", 0, ":end"),
                (store_add, ":event_slot", ":offset", slot_troop_log_event_begin),
                (troop_get_slot, ":event", ":troop_no", ":event_slot"),
                (gt, ":event", 0),

                (store_add, ":value_slot", ":offset", slot_troop_log_value_begin),
                (store_add, ":object_slot", ":offset", slot_troop_log_object_begin),
                (store_add, ":target_slot", ":offset", slot_troop_log_target_begin),

                (troop_get_slot, ":value", ":troop_no", ":value_slot"),
                (troop_get_slot, ":object", ":troop_no", ":object_slot"),
                (troop_get_slot, ":target", ":troop_no", ":target_slot"),

                (eq, ":event_type", ":event"),
                (eq, ":event_object", ":object"),
                (eq, ":event_target", ":target"),
                (eq, ":event_value", ":value"),

                (assign, ":removed", ":offset"),
                (assign, ":end", ":offset"),
            (try_end),

            (try_begin),
                (ge, ":removed", ":offset"),

                (val_add, ":end", 1),
                (try_for_range, ":offset", ":end", troop_log_num_slots),
                    (store_sub, ":new_offset", ":offset", 1),

                    (store_add, ":value_slot", ":offset", slot_troop_log_value_begin),
                    (store_add, ":event_slot", ":offset", slot_troop_log_event_begin),
                    (store_add, ":date_slot", ":offset", slot_troop_log_date_begin),
                    (store_add, ":object_slot", ":offset", slot_troop_log_object_begin),
                    (store_add, ":target_slot", ":offset", slot_troop_log_target_begin),

                    (troop_get_slot, ":value", ":troop_no", ":value_slot"),
                    (troop_get_slot, ":event", ":troop_no", ":event_slot"),
                    (troop_get_slot, ":date", ":troop_no", ":date_slot"),
                    (troop_get_slot, ":object", ":troop_no", ":object_slot"),
                    (troop_get_slot, ":target", ":troop_no", ":target_slot"),

                    (call_script, "script_troop_add_event_offset", ":troop_no", ":new_offset", ":event", ":object", ":target", ":value", ":date"),
                (try_end),

                (store_sub, ":last_offset", troop_log_num_slots, 1),
                (call_script, "script_troop_add_event_offset", ":troop_no", ":last_offset", -1, -1, -1, -1, -1),
            (try_end),
            (assign, reg0, ":removed"),
        ]),

    # script_cf_troop_has_event
        # input:
        #   arg1: troop_no
        #   arg2: event_type
        # output: none
        # fails if event is not present
    ("cf_troop_has_event",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":event_type", 2),

            (assign, ":continue", 0),

            (assign, ":end", troop_log_num_slots),
            (try_for_range, ":offset", 0, ":end"),
                (store_add, ":event_slot", ":offset", slot_troop_log_event_begin),
                (troop_get_slot, ":event", ":troop_no", ":event_slot"),
                (eq, ":event", ":event_type"),
                (assign, ":continue", 1),
                (assign, ":end", 0),
            (try_end),

            (eq, ":continue", 1),
        ]),

    # script_troop_get_vassalage_dialog_availability
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: outcome
    ("troop_get_vassalage_dialog_availability",
        [
            (store_script_param, ":troop_no", 1),

            (call_script, "script_troop_get_relation_with_troop", ":troop_no", "$g_player_troop"),
            (assign, ":player_relation", reg0),
            (assign, ":lord_relation", 0),
            (troop_get_slot, ":troop_lord", ":troop_no", slot_troop_vassal_of),
            (try_begin),
                (ge, ":troop_lord", 0),
                (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":troop_lord"),
                (assign, ":lord_relation", reg0),
            (try_end),

            (assign, ":outcome", outcome_success),
            (assign, ":outcome_value", 0),

            (try_begin),
                (lt, ":player_relation", 20),
                (gt, ":lord_relation", 20),
                (assign, ":outcome", outcome_failure),
            (else_try),
                (call_script, "script_troop_get_vassalage_availability_score", ":troop_no", "$g_player_troop"),
                (assign, ":outcome_value", reg0),

                (val_max, ":outcome_value", 0),

                (troop_get_slot, ":mission", ":troop_no", slot_troop_mission),
                (try_begin),
                    (eq, ":mission", tm_escorting),
                    (val_sub, ":outcome_value", 1),
                    (troop_slot_eq, ":troop_no", slot_troop_mission_object, ":troop_lord"),
                    (val_sub, ":outcome_value", 2),
                (try_end),
                (try_begin),
                    (store_troop_faction, ":troop_faction", ":troop_no"),
                    (call_script, "script_cf_faction_is_at_war", ":troop_faction"),
                    (val_sub, ":outcome_value", 2),
                (try_end),
            (try_end),

            (try_begin),
                (lt, ":outcome_value", 0),
                (assign, ":outcome", outcome_neutral),
            (try_end),

            (assign, reg0, ":outcome"),
        ]),

    # script_troop_get_vassalage_availability_score
        # input:
        #   arg1: troop_no
        #   arg2: asking_troop
        # output:
        #   reg0: score
    ("troop_get_vassalage_availability_score",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":troop_asking", 2),

            (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":troop_asking"),
            (assign, ":asking_relation", reg0),
            (assign, ":lord_relation", 0),
            (troop_get_slot, ":troop_lord", ":troop_no", slot_troop_vassal_of),
            (try_begin),
                (ge, ":troop_lord", 0),
                (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":troop_lord"),
                (assign, ":lord_relation", reg0),
            (try_end),

            (assign, ":outcome_value", 0),

            (try_begin),
                (lt, ":troop_lord", 0),
                (val_add, ":outcome_value", 1),
            (try_end),

            (try_begin),
                (gt, ":asking_relation", ":lord_relation"),
                (val_add, ":outcome_value", 1),
            (else_try),
                (lt, ":asking_relation", ":lord_relation"),
                (val_sub, ":outcome_value", 1),
            (try_end),

            (try_begin),
                (lt, ":asking_relation", 0),
                (store_div, ":relation_malus", ":asking_relation", 30),
                (val_sub, ":relation_malus", 1),
                (val_add, ":outcome_value", ":relation_malus"),
            (else_try),
                (store_div, ":relation_bonus", ":asking_relation", 30),
                (val_add, ":outcome_value", ":relation_bonus"),
            (try_end),

            (assign, reg0, ":outcome_value"),
        ]),

    # script_get_dialog_lord_opinion
        # input:
        #   arg1: troop_no
        # output:
        #   s0: dialog_string
    ("get_dialog_lord_opinion",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":lord", ":troop_no", slot_troop_vassal_of),
            (try_begin),
                (eq, ":lord", -1),

                (try_begin),
                    (store_troop_faction, ":troop_faction", ":troop_no"),
                    (faction_slot_eq, ":troop_faction", slot_faction_leader, ":troop_no"),
                    (str_store_string, s0, "@It has not, my position affords me opportunities to do without."),
                (else_try),
                    (str_store_string, s0, "@It crossed my mind but I have not yet found someone to pledge an oath to."),
                (try_end),
            (else_try),
                (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":lord"),
                (assign, ":relation", reg0),

                (try_begin),
                    (lt, ":relation", -50),
                    (str_store_string, s0, "@Well... let's just say that we are not on the best terms."),
                (else_try),
                    (lt, ":relation", -20),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@{s10} and I try to keep at a reasonable distance and I think we are both faring better for it."),
                (else_try),
                    (lt, ":relation", 0),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@{s10} and I have had a few disputes over the years but nothing that can't be overcome."),
                (else_try),
                    (lt, ":relation", 10),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@I can't say I'm close enough to {s10} to really give a reliable impression of him."),
                (else_try),
                    (lt, ":relation", 30),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@{s10} is a good leader of men and is agreable to be with."),
                (else_try),
                    (lt, ":relation", 50),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@I am quite content with my oath to {s10}."),
                (else_try),
                    (str_store_troop_name, s10, ":lord"),
                    (str_store_string, s0, "@{s10} is a dear friend of mine and I am proud to serve him."),
                (try_end),
            (try_end),
        ]),

    # script_troop_get_become_vassal_answer
        # input:
        #   arg1: troop_no
        # output:
        #   reg0: outcome
    ("troop_get_become_vassal_answer",
        [
            (store_script_param, ":troop_no", 1),

            (quest_get_slot, ":asked_lord", "qst_persuade_lord_vassalage", slot_quest_object),

            (quest_get_slot, ":value", "qst_persuade_lord_vassalage", slot_quest_value),

            (assign, ":score", -100),

            (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":asked_lord"),
            (store_div, ":relation", reg0, 4),
            (val_add, ":score", ":relation"),

            (troop_get_slot, ":existing_lord", ":troop_no", slot_troop_vassal_of),
            (assign, ":existing_lord_relation", 0),
            (try_begin),
                (ge, ":existing_lord", 0),

                (call_script, "script_troop_get_relation_with_troop", ":troop_no", ":existing_lord"),
                (store_div, ":existing_lord_relation", reg0, 5),
                (val_sub, ":score", ":existing_lord_relation"),
            (try_end),

            (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
            (troop_get_slot, ":asked_lord_rank", ":asked_lord", slot_troop_rank),
            (store_sub, ":rank_bonus", ":asked_lord_rank", ":rank"),
            (val_mul, ":rank_bonus", 8),

            (val_add, ":score", ":rank_bonus"),

            (troop_get_slot, ":num_vassals", ":troop_no", slot_troop_num_vassal),
            (troop_get_slot, ":num_vassals_asked", ":asked_lord", slot_troop_num_vassal),

            (store_mul, ":vassals_malus", ":num_vassals", 25),
            (store_mul, ":vassals_asked_malus", ":num_vassals_asked", 5),

            (val_sub, ":score", ":vassals_malus"),
            (val_sub, ":score", ":vassals_asked_malus"),

            (store_skill_level, ":persuasion_skill", skl_persuasion, "$g_player_troop"),
            (val_mul, ":persuasion_skill", 3),
            (val_add, ":score", ":persuasion_skill"),

            (val_add, ":score", ":value"),

            (try_begin),
                (call_script, "script_cf_debug", debug_ai|debug_current),
                (assign, reg11, ":relation"),
                (display_message, "@Relation +{reg11}"),
                (assign, reg12, ":existing_lord_relation"),
                (display_message, "@Other relation -{reg12}"),
                (assign, reg13, ":rank_bonus"),
                (display_message, "@Rank +{reg13}"),
                (assign, reg14, ":vassals_malus"),
                (display_message, "@Num vassals -{reg14}"),
                (assign, reg15, ":vassals_asked_malus"),
                (display_message, "@Other num vassals -{reg15}"),
                (assign, reg16, ":persuasion_skill"),
                (display_message, "@Persuasion skill +{reg16}"),
                (assign, reg17, ":value"),
                (display_message, "@Quest value +{reg16}"),

                (assign, reg10, ":score"),
                (display_message, "@Total score: {reg10}"),
            (try_end),

            (try_begin),
                (ge, ":score", 100),
                (assign, reg0, outcome_success),
            (else_try),
                (gt, ":score", -100),
                (assign, reg0, outcome_neutral),
            (else_try),
                (assign, reg0, outcome_failure),
            (try_end),
        ]),

    # script_persuade_vassal_quest_add_proposition
        # input:
        #   arg1: proposition
        # output: none
    ("persuade_vassal_quest_add_proposition",
        [
            (store_script_param, ":proposition", 1),

            (assign, ":end", slot_quest_proposition_end),
            (try_for_range, ":slot", slot_quest_proposition_begin, ":end"),
                (quest_get_slot, ":value", "qst_persuade_lord_vassalage", ":slot"),
                (try_begin),
                    (eq, ":value", -1),

                    (quest_set_slot, "qst_persuade_lord_vassalage", ":slot", ":proposition"),

                    (assign, ":end", 0),
                (try_end),
            (try_end),
        ]),

    # script_quest_add_value
        # input:
        #   arg1: quest_no
        #   arg2: value
        # output: none
    ("quest_add_value",
        [
            (store_script_param, ":quest_no", 1),
            (store_script_param, ":value", 2),

            (quest_get_slot, ":current_value", ":quest_no", slot_quest_value),
            (val_add, ":current_value", ":value"),
            (quest_set_slot, ":quest_no", slot_quest_value, ":current_value"),

            (try_begin),
                (call_script, "script_cf_debug", debug_current|debug_simple),
                (str_store_quest_name, s10, ":quest_no"),
                (assign, reg10, ":value"),
                (assign, reg11, ":current_value"),
                (display_message, "@Adding {reg10} value to quest {s10} up to {reg11}"),
            (try_end),
        ]),

    # script_troop_become_vassal_grant_fief
        # input:
        #   arg1: troop_no
        #   arg2: fief
        # output:
        #   s0: output_string
    ("troop_become_vassal_grant_fief",
        [
            (store_script_param, ":troop_no", 1),
            (store_script_param, ":fief", 2),

            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_proposed_fief),
            (quest_set_slot, "qst_persuade_lord_vassalage", slot_quest_proposed_fief, ":fief"),

            (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
            (party_get_slot, ":party_type", ":fief", slot_party_type),

            (assign, ":change", 0),

            (try_begin),
                (ge, ":rank", rank_city),
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (str_store_string, s0, "@That would be the least that I would require"),
                    (assign, ":change", 5),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (str_store_string, s0, "@I see that as a disadvantage from my current position..."),
                    (assign, ":change", -10),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (str_store_string, s0, "@I feel insulted that you would offer this and think I would appreciate..."),
                    (assign, ":change", -30),
                (try_end),
            (else_try),
                (eq, ":rank", rank_castle),
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (str_store_string, s0, "@That's interesting"),
                    (assign, ":change", 35),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (str_store_string, s0, "@That would be the least that I would require"),
                    (assign, ":change", 10),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (str_store_string, s0, "@I see that as a disadvantage from my current position..."),
                    (assign, ":change", -5),
                (try_end),
            (else_try),
                (ge, ":rank", rank_village),
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (str_store_string, s0, "@This is a very good proposition"),
                    (assign, ":change", 65),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (str_store_string, s0, "@That's interesting"),
                    (assign, ":change", 40),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (str_store_string, s0, "@That would be the least that I would require"),
                    (assign, ":change", 15),
                (try_end),
            (else_try),
                (try_begin),
                    (eq, ":party_type", spt_town),
                    (str_store_string, s0, "@This far exceeds my expectations"),
                    (assign, ":change", 100),
                (else_try),
                    (eq, ":party_type", spt_castle),
                    (str_store_string, s0, "@This is a very good proposition"),
                    (assign, ":change", 75),
                (else_try),
                    (eq, ":party_type", spt_village),
                    (str_store_string, s0, "@That's interesting"),
                    (assign, ":change", 50),
                (try_end),
            (try_end),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
        ]),

    # script_troop_become_vassal_promise_fief
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_fief",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
            (store_sub, ":change", 3, ":rank"),
            (val_mul, ":change", 10),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_mul, ":persuasion_skill", 2),
            (val_add, ":change", ":persuasion_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),

            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_fief),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_grant_title
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_grant_title",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":rank", ":troop_no", slot_troop_rank),
            (store_sub, ":change", 7, ":rank"),
            (val_mul, ":change", 5),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_proposed_title),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_promise_safety
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_safety",
        [
            (store_script_param, ":troop_no", 1),

            (quest_get_slot, ":target_troop", "qst_persuade_lord_vassalage", slot_quest_object),
            (store_troop_faction, ":target_faction", ":target_troop"),
            (store_troop_faction, ":troop_faction", ":troop_no"),

            (faction_get_slot, ":safety", ":troop_faction", slot_faction_safety),
            (faction_get_slot, ":proposed_safety", ":target_faction", slot_faction_safety),

            (store_sub, ":change", ":proposed_safety", ":safety"),
            (val_div, ":change", 3),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (store_skill_level, ":intimidation_skill", "$g_player_troop", skl_intimidation),
            (val_add, ":change", ":intimidation_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_safety),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_promise_prosperity
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_prosperity",
        [
            # (store_script_param, ":troop_no", 1),

            (assign, ":change", -5),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (store_skill_level, ":trade_skill", "$g_player_troop", skl_trade),
            (val_add, ":change", ":trade_skill"),

            (store_skill_level, ":looting_skill", "$g_player_troop", skl_looting),
            (val_add, ":change", ":looting_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_prosperity),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_promise_standing
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_standing",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":renown", ":troop_no", slot_troop_renown),
            (quest_get_slot, ":target_troop", "qst_persuade_lord_vassalage", slot_quest_object),
            (troop_get_slot, ":target_renown", ":target_troop", slot_troop_renown),

            (store_sub, ":change", ":target_renown", ":renown"),
            (val_div, ":change", 20),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (store_skill_level, ":leadership_skill", "$g_player_troop", skl_leadership),
            (val_add, ":change", ":leadership_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_standing),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_promise_glory
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_glory",
        [
            (store_script_param, ":troop_no", 1),

            (quest_get_slot, ":target_troop", "qst_persuade_lord_vassalage", slot_quest_object),
            (store_troop_faction, ":target_faction", ":target_troop"),
            (store_troop_faction, ":troop_faction", ":troop_no"),

            (faction_get_slot, ":safety", ":troop_faction", slot_faction_safety),
            (faction_get_slot, ":proposed_safety", ":target_faction", slot_faction_safety),

            (store_sub, ":change", ":safety", ":proposed_safety"),
            (val_div, ":change", 10),

            (faction_get_slot, ":faction_size", ":troop_faction", slot_faction_size),
            (faction_get_slot, ":proposed_faction_size", ":target_faction", slot_faction_size),

            (store_sub, ":diff", ":faction_size", ":proposed_faction_size"),
            (val_div, ":diff", 10),

            (val_add, ":change", ":diff"),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_glory),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_promise_vassals
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_promise_vassals",
        [
            (store_script_param, ":troop_no", 1),

            (troop_get_slot, ":num_vassals", ":troop_no", slot_troop_num_vassal),
            (store_sub, ":change", 3, ":num_vassals"),

            (val_mul, ":change", 10),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_add, ":change", ":persuasion_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_vassals),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_right_to_rule
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_right_to_rule",
        [
            # (store_script_param, ":troop_no", 1),

            (assign, ":change", -10),

            (store_skill_level, ":persuasion_skill", "$g_player_troop", skl_persuasion),
            (val_mul, ":persuasion_skill", 3),
            (val_add, ":change", ":persuasion_skill"),

            (store_skill_level, ":leadership_skill", "$g_player_troop", skl_leadership),
            (val_mul, ":leadership_skill", 2),
            (val_add, ":change", ":leadership_skill"),

            (store_skill_level, ":intimidation_skill", "$g_player_troop", skl_intimidation),
            (val_div, ":intimidation_skill", 2),
            (val_add, ":change", ":intimidation_skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_right_to_rule),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_become_vassal_threaten
        # input:
        #   arg1: troop_no
        # output:
        #   s0: output_string
    ("troop_become_vassal_threaten",
        [
            (store_script_param, ":troop_no", 1),

            (quest_get_slot, ":target_troop", "qst_persuade_lord_vassalage", slot_quest_object),
            (store_troop_faction, ":target_faction", ":target_troop"),
            (store_troop_faction, ":troop_faction", ":troop_no"),

            (faction_get_slot, ":faction_size", ":troop_faction", slot_faction_size),
            (faction_get_slot, ":proposed_faction_size", ":target_faction", slot_faction_size),

            (store_sub, ":change", ":proposed_faction_size", ":faction_size"),
            (val_div, ":change", 6),

            (faction_get_slot, ":safety", ":troop_faction", slot_faction_safety),
            (faction_get_slot, ":proposed_safety", ":target_faction", slot_faction_safety),

            (store_sub, ":diff", ":proposed_safety", ":safety"),
            (val_div, ":diff", 6),

            (val_add, ":change", ":diff"),

            (store_skill_level, ":skill", "$g_player_troop", skl_intimidation),
            (val_mul, ":skill", 2),
            (val_add, ":change", ":skill"),

            (call_script, "script_quest_add_value", "qst_persuade_lord_vassalage", ":change"),
            
            (call_script, "script_persuade_vassal_quest_add_proposition", event_type_promised_threat),

            (str_store_string, s0, "@Interesting, keep going"),
        ]),

    # script_troop_apply_persuade_vassal_quest
        # input:
        #   arg1: troop_no
        # output: none
    ("troop_apply_persuade_vassal_quest",
        [
            (store_script_param, ":troop_no", 1),

            (assign, ":end", slot_quest_proposition_end),
            (try_for_range, ":slot", slot_quest_proposition_begin, ":end"),
                (quest_get_slot, ":value", "qst_persuade_lord_vassalage", ":slot"),
                (try_begin),
                    (neq, ":value", -1),
                    (try_begin),
                        (eq, ":value", event_type_proposed_fief),
                        (quest_get_slot, ":fief", "qst_persuade_lord_vassalage", slot_quest_proposed_fief),
                        (call_script, "script_give_center_to_troop", ":fief", ":troop_no"),
                    (else_try),
                        (eq, ":value", event_type_proposed_title),
                        # TODO: grant title
                    (else_try),
                        (call_script, "script_troop_add_event", ":troop_no", ":value", -1, "$g_player_troop", 50, -1),
                    (try_end),
                (else_try),
                    (assign, ":end", 0),
                (try_end),
            (try_end),
        ]),

    # script_presentation_generate_select_lord_card
        # input:
        #   arg1: troop_no
        #   arg2: x
        #   arg3: values_x
        #   arg4: values2_x
        #   arg5: cur_y
        # output: none
    ("presentation_generate_select_lord_card",
        [
            (store_script_param, ":lord_no", 1),

            (store_script_param, ":x", 2),
            (store_script_param, ":values_x", 3),
            (store_script_param, ":values2_x", 4),
            (store_script_param, ":cur_y", 5),

            (assign, ":line_height", 30),

            (create_mesh_overlay, reg0, "mesh_mp_ingame_menu"),
            (position_set_x, pos1, ":x"),
            (position_set_y, pos1, ":cur_y"),
            (overlay_set_position, reg0, pos1),
            (position_set_x, pos1, 800),
            (position_set_y, pos1, 225),
            (overlay_set_size, reg0, pos1),

            (store_add, ":line_text_y", ":cur_y", 10),

            (store_add, ":checkbox_y", ":line_text_y", 45),
            (store_add, ":checkbox_x", ":x", 25),
            (create_check_box_overlay, reg0, "mesh_checkbox_off", "mesh_checkbox_on"),
            (position_set_x, pos1, ":checkbox_x"),
            (position_set_y, pos1, ":checkbox_y"),
            (overlay_set_position, reg0, pos1),
            (troop_set_slot, ":lord_no", slot_troop_temp_slot, reg0),

            (store_add, ":picture_x", ":x", 35),
            (store_add, ":picture_y", ":line_text_y", 5),
            (create_mesh_overlay_with_tableau_material, reg0, -1, "tableau_troop_note_mesh", ":lord_no"),
            (position_set_x, pos1, ":picture_x"),
            (position_set_y, pos1, ":picture_y"),
            (overlay_set_position, reg0, pos1),
            (position_set_x, pos1, 380),
            (position_set_y, pos1, 380),
            (overlay_set_size, reg0, pos1),

            (troop_get_slot, ":banner_spr", ":lord_no", slot_troop_banner_scene_prop),
            (try_begin),
                (is_between, ":banner_spr", banner_scene_props_begin, banner_scene_props_end),
                (store_sub, ":banner_mesh", ":banner_spr", banner_scene_props_begin),
                (val_add, ":banner_mesh", banner_meshes_begin),

                (store_sub, ":banner_x", ":values_x", 25),
                (store_add, ":banner_y", ":line_text_y", 100),
                (create_mesh_overlay, reg0, ":banner_mesh"),
                (position_set_x, pos1, ":banner_x"),
                (position_set_y, pos1, ":banner_y"),
                (overlay_set_position, reg0, pos1),
                (position_set_x, pos1, 45),
                (position_set_y, pos1, 45),
                (overlay_set_size, reg0, pos1),
                (overlay_set_additional_render_height, reg0, 100),
            (try_end),

            (troop_get_slot, ":culture", ":lord_no", slot_troop_culture),
            (str_store_faction_name, s10, ":culture"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),

            (val_add, ":line_text_y", ":line_height"),

            (call_script, "script_troop_get_relation_with_troop", ":lord_no", "$g_player_troop"),
            (assign, reg10, reg0),
            (str_store_string, s10, "@{reg10} relation"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),

            (troop_get_slot, reg10, ":lord_no", slot_troop_renown),
            (str_store_string, s10, "@{reg10} renown"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values2_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),

            (val_add, ":line_text_y", ":line_height"),

            (troop_get_slot, reg10, ":lord_no", slot_troop_num_vassal),
            (str_store_string, s10, "@{reg10} vassals"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),

            (assign, ":num_fiefs", 0),
            (try_for_range, ":center_no", centers_begin, centers_end),
                (party_slot_eq, ":center_no", slot_party_lord, ":lord_no"),
                (val_add, ":num_fiefs", 1),
            (try_end),
            (assign, reg10, ":num_fiefs"),
            (str_store_string, s10, "@{reg10} fiefs"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values2_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),

            (val_add, ":line_text_y", ":line_height"),

            (str_store_troop_name, s10, ":lord_no"),
            (call_script, "script_presentation_create_text_overlay", 0, ":values_x", ":line_text_y", 1000, 1000),
            (overlay_set_color, reg0, text_color_white),
        ]),

    # script_presentation_create_text_overlay
        # input:
        #   s10: text_string_register
        #   arg1: text_overlay_options
        #   arg2: x_position
        #   arg3: y_position
        #   arg4: x_size
        #   arg5: y_size
        # output:
        #   reg0: overlay_id
    ("presentation_create_text_overlay",
        [
            (store_script_param, ":options", 1),
            (store_script_param, ":x_pos", 2),
            (store_script_param, ":y_pos", 3),
            (store_script_param, ":x_size", 4),
            (store_script_param, ":y_size", 5),

            (create_text_overlay, reg0, s10, ":options"),
            (position_set_x, pos1, ":x_pos"),
            (position_set_y, pos1, ":y_pos"),
            (overlay_set_position, reg0, pos1),
            (position_set_x, pos1, ":x_size"),
            (position_set_y, pos1, ":y_size"),
            (overlay_set_size, reg0, pos1),
        ]),

    # script_presentation_create_combo_button_overlay
        # input:
        #   arg1: x_position
        #   arg2: y_position
        #   arg3: x_size
        #   arg4: y_size
        # output:
        #   reg0: overlay_id
    ("presentation_create_combo_button_overlay",
        [
            (store_script_param, ":x_pos", 1),
            (store_script_param, ":y_pos", 2),
            (store_script_param, ":x_size", 3),
            (store_script_param, ":y_size", 4),

            (create_combo_button_overlay, reg0),
            (position_set_x, pos1, ":x_pos"),
            (position_set_y, pos1, ":y_pos"),
            (overlay_set_position, reg0, pos1),
            (position_set_x, pos1, ":x_size"),
            (position_set_y, pos1, ":y_size"),
            (overlay_set_size, reg0, pos1),
        ]),

    # script_presentation_create_check_box_overlay
        # input:
        #   arg1: x_position
        #   arg2: y_position
        #   arg3: value
        # output:
        #   reg0: overlay_id
    ("presentation_create_check_box_overlay",
        [
            (store_script_param, ":x_pos", 1),
            (store_script_param, ":y_pos", 2),
            (store_script_param, ":value", 3),

            (create_check_box_overlay, reg0,  "mesh_checkbox_off", "mesh_checkbox_on"),
            (position_set_x, pos1, ":x_pos"),
            (position_set_y, pos1, ":y_pos"),
            (overlay_set_position, reg0, pos1),
            (overlay_set_val, reg0, ":value"),
        ]),
]
